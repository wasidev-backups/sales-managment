<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ========================================
         HTML HEAD SECTION
         ======================================== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard - D.Watson Pharmacy</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" onerror="this.onerror=null; this.href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css';">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" onerror="this.onerror=null; this.href='https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css';">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- ========================================
         CSS STYLES SECTION
         ======================================== -->
    <style>
        /* CSS Variables */
        :root {
            --primary-color: #2c6e8a;
            --secondary-color: #4fb3d9;
            --accent-color: #0a4d68;
            --light-bg: #f8f9fa;
            --dark-text: #212529;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --sidebar-width: 240px;
        }
        
        /* Large screen CSS variables */
        @media (min-width: 1400px) {
            :root {
                --sidebar-width: 280px;
            }
        }
        
        /* Extra large screen CSS variables */
        @media (min-width: 1920px) {
            :root {
                --sidebar-width: 300px;
            }
        }
        
        /* ========================================
           PRINT STYLES SECTION
           ======================================== */
        
        /* Professional Print Styles for A4 */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body {
                font-family: 'Arial', sans-serif !important;
                font-size: 12pt !important;
                line-height: 1.4 !important;
                color: #000 !important;
                background: #fff !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            .print-container {
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 30px;
                border-bottom: 2px solid #333;
                padding-bottom: 15px;
            }
            
            .print-header h1 {
                font-size: 24pt !important;
                font-weight: bold !important;
                margin: 0 0 10px 0 !important;
                color: #333 !important;
            }
            
            .print-header .company-info {
                font-size: 10pt !important;
                color: #666 !important;
                margin: 5px 0 !important;
            }
            
            .print-header .report-info {
                font-size: 11pt !important;
                color: #333 !important;
                margin: 10px 0 0 0 !important;
            }
            
            .print-section {
                margin-bottom: 25px;
                page-break-inside: avoid;
            }
            
            .print-section h3 {
                font-size: 14pt !important;
                font-weight: bold !important;
                color: #333 !important;
                margin: 0 0 15px 0 !important;
                border-bottom: 1px solid #ccc;
                padding-bottom: 5px;
            }
            
            .print-table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin-bottom: 20px !important;
                font-size: 10pt !important;
            }
            
            .print-table th,
            .print-table td {
                border: 1px solid #333 !important;
                padding: 8px !important;
                text-align: left !important;
                vertical-align: top !important;
            }
            
            .print-table th {
                background-color: #f5f5f5 !important;
                font-weight: bold !important;
                color: #333 !important;
            }
            
            .print-table .text-right {
                text-align: right !important;
            }
            
            .print-table .text-center {
                text-align: center !important;
            }
            
            .print-summary {
                display: flex;
                justify-content: space-between;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }
            
            .print-summary-item {
                flex: 1;
                min-width: 150px;
                margin: 5px;
                padding: 10px;
                border: 1px solid #ccc;
                text-align: center;
            }
            
            .print-summary-item .label {
                font-size: 9pt;
                color: #666;
                display: block;
                margin-bottom: 5px;
            }
            
            .print-summary-item .value {
                font-size: 12pt;
                font-weight: bold;
                color: #333;
            }
            
            .print-footer {
                margin-top: 30px;
                text-align: center;
                font-size: 9pt;
                color: #666;
                border-top: 1px solid #ccc;
                padding-top: 10px;
            }
            
            @page {
                size: A4;
                margin: 1in;
            }
        }
        
        /* ========================================
           GLOBAL STYLES SECTION
           ======================================== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', 'Arial', sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Theme: Light (Default) */
        body.theme-light,
        html.theme-light {
            background-color: #f8f9fa;
            color: #212529;
        }
        
        body.theme-light .card {
            background-color: #ffffff;
            color: #212529;
        }
        
        /* Theme: Dark */
        body.theme-dark,
        html.theme-dark {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        body.theme-dark .card {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }
        
        body.theme-dark .card-header {
            background-color: #3d3d3d !important;
            color: #ffffff !important;
        }
        
        body.theme-dark .table {
            color: #e0e0e0;
        }
        
        body.theme-dark .table thead {
            background-color: #3d3d3d;
            color: #ffffff;
        }
        
        body.theme-dark .form-control,
        body.theme-dark .form-select {
            background-color: #3d3d3d;
            color: #e0e0e0;
            border-color: #555555;
        }
        
        body.theme-dark .navbar {
            background-color: #2d2d2d !important;
        }
        
        /* Theme: Blue */
        body.theme-blue,
        html.theme-blue {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        body.theme-blue .card {
            background-color: #ffffff;
            color: #1565c0;
            border-color: #90caf9;
        }
        
        body.theme-blue .card-header {
            background-color: #2196f3 !important;
            color: #ffffff !important;
        }
        
        body.theme-blue .btn-primary {
            background-color: #1976d2;
            border-color: #1976d2;
        }
        
        body.theme-blue .btn-primary:hover {
            background-color: #1565c0;
            border-color: #1565c0;
        }
        
        body.theme-blue .table thead {
            background-color: #bbdefb;
            color: #0d47a1;
        }
        
        body.theme-blue .navbar {
            background-color: #1976d2 !important;
        }
        body.theme-red,
        html.theme-red {
            background-color: #ffebee;
            color: #c62828;
        }
        body.theme-red .card {
            background-color: #ffffff;
            color: #c62828;
            border-color: #ef9a9a;
        }
        body.theme-red .card-header {
            background-color: #d32f2f !important;
            color: #ffffff !important;
        }
        body.theme-red .btn-primary {
            background-color: #c62828;
            border-color: #c62828;
        }
        body.theme-red .btn-primary:hover {
            background-color: #b71c1c;
            border-color: #b71c1c;
        }
        body.theme-red .table thead {
            background-color: #ffcdd2;
            color: #b71c1c;
        }
        body.theme-red .navbar {
            background-color: #c62828 !important;
        }
        body.theme-green,
        html.theme-green {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        body.theme-green .card {
            background-color: #ffffff;
            color: #2e7d32;
            border-color: #a5d6a7;
        }
        body.theme-green .card-header {
            background-color: #2e7d32 !important;
            color: #ffffff !important;
        }
        body.theme-green .btn-primary {
            background-color: #1b5e20;
            border-color: #1b5e20;
        }
        body.theme-green .btn-primary:hover {
            background-color: #124c16;
            border-color: #124c16;
        }
        body.theme-green .table thead {
            background-color: #c8e6c9;
            color: #1b5e20;
        }
        body.theme-green .navbar {
            background-color: #2e7d32 !important;
        }
        body.theme-purple,
        html.theme-purple {
            background-color: #f3e5f5;
            color: #6a1b9a;
        }
        body.theme-purple .card {
            background-color: #ffffff;
            color: #6a1b9a;
            border-color: #ce93d8;
        }
        body.theme-purple .card-header {
            background-color: #6a1b9a !important;
            color: #ffffff !important;
        }
        body.theme-purple .btn-primary {
            background-color: #4a148c;
            border-color: #4a148c;
        }
        body.theme-purple .btn-primary:hover {
            background-color: #3a0e70;
            border-color: #3a0e70;
        }
        body.theme-purple .table thead {
            background-color: #e1bee7;
            color: #4a148c;
        }
        body.theme-purple .navbar {
            background-color: #6a1b9a !important;
        }
        body.theme-teal,
        html.theme-teal {
            background-color: #e0f2f1;
            color: #00796b;
        }
        body.theme-teal .card {
            background-color: #ffffff;
            color: #00796b;
            border-color: #80cbc4;
        }
        body.theme-teal .card-header {
            background-color: #00796b !important;
            color: #ffffff !important;
        }
        body.theme-teal .btn-primary {
            background-color: #004d40;
            border-color: #004d40;
        }
        body.theme-teal .btn-primary:hover {
            background-color: #00332b;
            border-color: #00332b;
        }
        body.theme-teal .table thead {
            background-color: #b2dfdb;
            color: #004d40;
        }
        body.theme-teal .navbar {
            background-color: #00796b !important;
        }
        body.theme-redblue,
        html.theme-redblue {
            /* Logo-matching palette */
            --primary-color: #1155AA;
            --secondary-color: #1C6FD6;
            --accent-red: #E31B23;
            background-color: #0f172a;
            color: #ffffff;
        }
        body.theme-redblue .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)) !important;
        }
        body.theme-redblue .card {
            background-color: #13243f;
            color: #ffffff;
            border-color: #1f3b66;
        }
        body.theme-redblue .card-header {
            background-color: var(--accent-red) !important;
            color: #ffffff !important;
        }
        body.theme-redblue .card-title,
        body.theme-redblue .modal-title,
        body.theme-redblue .dashboard-title,
        body.theme-redblue .section-title {
            color: #ffffff !important;
        }
        body.theme-redblue .section-title i {
            color: var(--accent-red) !important;
        }
        body.theme-redblue .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: #ffffff;
        }
        body.theme-redblue .btn-primary:hover {
            filter: brightness(0.95);
        }
        body.theme-redblue .table thead {
            background-color: var(--accent-red);
            color: #ffffff;
        }
        body.theme-redblue .form-control,
        body.theme-redblue .form-select {
            background-color: #0f172a;
            color: #ffffff;
            border-color: #334155;
        }
        body.theme-redblue .sidebar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }
        body.theme-redblue .sidebar-title,
        body.theme-redblue .sidebar-logo,
        body.theme-redblue .sidebar-text {
            color: #ffffff !important;
        }
        body.theme-redblue .sidebar-section-header {
            background-color: var(--accent-red);
            color: #ffffff;
        }
        body.theme-redblue .sidebar .nav-link {
            color: #ffffff;
        }
        body.theme-redblue .sidebar .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }
        body.theme-redblue .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.12);
            color: #ffffff;
        }
        body.theme-redblue .login-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }
        body.theme-redblue .login-card {
            background: #ffffff;
            border-color: transparent;
        }
        body.theme-redblue .login-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: #ffffff;
        }
        body.theme-redblue .login-form .form-control {
            background: #ffffff;
            color: #212529;
            border: 1px solid #ddd;
        }
        body.theme-redblue .login-form .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(44, 110, 138, 0.25);
        }
        body.theme-redblue .login-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: #ffffff;
            border: none;
        }
        body.theme-redblue .auth-toggle {
            background: #f8f9fa;
        }
        body.theme-redblue .toggle-btn {
            color: #6c757d;
        }
        body.theme-redblue .toggle-btn.active {
            background: #ffffff;
            color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        body.theme-redblue #warehouseComparisonChart,
        body.theme-redblue #shopBranchComparisonChart {
            background-color: #ffffff;
        }
        
        /* Prevent horizontal scrolling globally */
        html {
            overflow-x: hidden !important;
            max-width: 100% !important;
        }
        
        * {
            box-sizing: border-box;
        }
        
        /* Main content responsive */
        .main-content {
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .content-section {
            max-width: 100%;
            overflow-x: hidden;
        }
        
        /* Container responsive */
        .container, .container-fluid {
            max-width: 100%;
            overflow-x: hidden;
        }
        
        /* Row responsive */
        .row {
            margin-left: 0;
            margin-right: 0;
            max-width: 100%;
        }
        
        .row > [class*="col-"] {
            padding-left: 8px;
            padding-right: 8px;
        }
        
        /* ========================================
           LOGIN SECTION STYLES
           ======================================== */
        
        /* Login Section */
        .login-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 20px;
        }
        
        .login-card {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .login-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .login-header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .login-header p {
            opacity: 0.8;
            margin: 0;
        }
        
        .login-body {
            padding: 30px;
        }
        
        .login-form .form-control {
            border-radius: 5px;
            padding: 12px 15px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .login-form .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(44, 110, 138, 0.25);
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            border-radius: 5px;
            border: none;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 110, 138, 0.3);
        }
        
        /* ========================================
           AUTHENTICATION TOGGLE STYLES
           ======================================== */
        
        /* Auth Toggle Styles */
        .auth-toggle {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
        }
        
        .toggle-btn {
            flex: 1;
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #6c757d;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .toggle-btn.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .toggle-btn:hover:not(.active) {
            color: var(--primary-color);
        }
        
        /* ========================================
           AUTHENTICATION FORM STYLES
           ======================================== */
        
        /* Auth Form Styles */
        .auth-form {
            transition: all 0.3s ease;
        }
        
        .auth-form.d-none {
            display: none !important;
        }
        
        .login-footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Main App (hidden initially) */
        .main-app {
            display: none;
        }
        
        /* Navbar Styles */
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            padding: 0.3rem 1rem; /* Reduced padding */
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 0.9rem; /* Reduced font size */
            color: white !important;
            padding: 0; /* Remove padding */
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .navbar-brand:hover {
            transform: scale(1.05);
            text-decoration: none;
        }
        
        /* Logo Styles */
        .navbar-logo {
            height: 50px;
            width: auto;
            max-width: 300px;
            object-fit: contain;
            display: block;
            transition: all 0.3s ease;
            filter: brightness(1);
        }
        
        .navbar-brand:hover .navbar-logo {
            transform: scale(1.1);
            filter: brightness(1.1);
        }
        
        /* Company name styling */
        .navbar-text {
            color: white;
            font-weight: 600;
            line-height: 1.2;
        }
        
        .company-name {
            font-size: 1rem;
            font-weight: 700;
            color: white;
            display: block;
        }
        
        /* Tooltip styling */
        .navbar-brand[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            animation: fadeInTooltip 0.3s ease forwards;
        }
        
        @keyframes fadeInTooltip {
            to {
                opacity: 1;
            }
        }
        
        /* User Dropdown Styles */
        .navbar .dropdown {
            position: relative;
        }
        
        .navbar .dropdown-menu {
            z-index: 1050;
            min-width: 150px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.15);
        }
        
        .navbar .dropdown-menu-end {
            right: 0;
            left: auto;
        }
        
        .navbar .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .navbar .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .navbar .dropdown-item i {
            width: 20px;
            text-align: center;
        }
        
        /* Ensure dropdown is clickable and visible */
        .navbar .dropdown-toggle,
        .navbar #userDropdown {
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .navbar .dropdown-toggle:focus,
        .navbar .dropdown-toggle:active,
        .navbar #userDropdown:focus,
        .navbar #userDropdown:active {
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
        }
        
        /* Remove dropdown arrow/caret completely */
        .navbar #userDropdown::after,
        .navbar #userDropdown::before {
            display: none !important;
            content: none !important;
        }
        
        .navbar #userDropdown.dropdown-toggle::after,
        .navbar #userDropdown.dropdown-toggle::before {
            display: none !important;
            content: none !important;
        }
        
        /* Remove any Bootstrap caret */
        .navbar #userDropdown .caret,
        .navbar #userDropdown .dropdown-toggle::after {
            display: none !important;
        }
        
        /* Ensure dropdown menu is always visible and clickable */
        .navbar .dropdown-menu.show {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }
        
        /* Make dropdown items more touch-friendly */
        .navbar .dropdown-item {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            touch-action: manipulation;
        }
        
        /* Prevent dropdown from being hidden */
        .navbar .dropdown-menu {
            pointer-events: auto;
            will-change: transform, opacity;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .navbar-logo {
                height: 40px;
                max-width: 200px;
            }
            
            .navbar-brand:hover .navbar-logo {
                transform: scale(1.05);
            }
            
            .navbar-brand:hover {
                transform: scale(1.02);
            }
            
            /* Mobile company name adjustments */
            .company-name {
                font-size: 0.9rem;
            }
            
            /* Mobile user menu fixes */
            .navbar #userDropdown {
                font-size: 0.85rem;
                padding: 6px 12px;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            
            .navbar #logoutBtn {
                font-size: 0.85rem;
                padding: 6px 12px;
                min-height: 44px; /* Minimum touch target size */
                -webkit-tap-highlight-color: rgba(220, 53, 69, 0.2);
                touch-action: manipulation;
            }
            
            .navbar .user-menu-container {
                flex-wrap: wrap;
                gap: 8px;
            }
        }
        
        /* Fix for small screens */
        @media (max-width: 576px) {
            .navbar .dropdown-menu {
                min-width: 160px;
                font-size: 0.9rem;
            }
            
            .navbar #userDropdown {
                font-size: 0.8rem;
                padding: 5px 10px;
            }
            
            #currentUserDisplay {
                max-width: 100px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        }
        
        .login-logo {
            max-width: 200px;
            width: 100%;
            height: auto;
            margin-bottom: 20px;
            object-fit: contain;
        }
        
        /* ========================================
           SIDEBAR STYLES
           ======================================== */
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 40px; /* Adjusted to match new navbar height */
            left: 0;
            height: calc(100vh - 40px); /* Adjusted to match new navbar height */
            width: var(--sidebar-width);
            background: #1e293b; /* Dark blue-gray to match software theme */
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
            z-index: 999;
            overflow: hidden; /* Keep hidden - only content area scrolls */
            border-radius: 0 0 0 0;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 40px);
        }
        
        /* Sidebar hidden by default on mobile */
        @media (max-width: 767px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px; /* Wider on mobile for better usability */
                top: 40px;
                height: calc(100vh - 40px);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
        }
        
        /* Tablet responsive */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }
        }
        
        /* Large screen sidebar width */
        @media (min-width: 1400px) {
            .sidebar {
                width: 280px;
            }
        }
        
        /* Extra large screen sidebar width */
        @media (min-width: 1920px) {
            .sidebar {
                width: 300px;
            }
        }
        
        /* Sidebar Header */
        .sidebar-header {
            padding: 24px 24px 18px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: none;
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        
        /* Large screen header improvements */
        @media (min-width: 1400px) {
            .sidebar-header {
                padding: 28px 28px 20px 28px;
            }
        }
        
        /* Tablet header adjustments */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar-header {
                padding: 20px 20px 15px 20px;
            }
        }
        
        /* Mobile header adjustments */
        @media (max-width: 767px) {
            .sidebar-header {
                padding: 15px 15px 12px 15px;
            }
            
            .sidebar-title {
                font-size: 16px;
            }
            
            .sidebar-logo {
                width: 28px;
                height: 28px;
                font-size: 18px;
            }
        }
        
        .sidebar-logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-logo {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 22px;
        }
        
        /* Large screen logo improvements */
        @media (min-width: 1400px) {
            .sidebar-logo {
                width: 40px;
                height: 40px;
                font-size: 24px;
            }
        }
        
        /* Tablet logo adjustments */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar-logo {
                width: 32px;
                height: 32px;
                font-size: 20px;
            }
        }
        
        .sidebar-title {
            color: #ffffff;
            font-size: 20px;
            font-weight: 700;
            margin: 0;
            letter-spacing: 0.5px;
        }
        
        /* Large screen title improvements */
        @media (min-width: 1400px) {
            .sidebar-title {
                font-size: 22px;
            }
        }
        
        /* Tablet title adjustments */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar-title {
                font-size: 18px;
            }
        }
        
        /* Sidebar Search */
        .sidebar-search {
            padding: 0 24px 18px 24px;
            margin-bottom: 12px;
            flex-shrink: 0; /* Prevent search from shrinking */
        }
        
        /* Large screen search improvements */
        @media (min-width: 1400px) {
            .sidebar-search {
                padding: 0 28px 20px 28px;
                margin-bottom: 14px;
            }
        }
        
        /* Tablet search adjustments */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar-search {
                padding: 0 20px 15px 20px;
            }
        }
        
        .sidebar-search-input {
            width: 100%;
            background: #0f172a; /* Darker background for search input */
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px 14px 12px 44px;
            color: #ffffff;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        /* Large screen search input improvements */
        @media (min-width: 1400px) {
            .sidebar-search-input {
                padding: 14px 16px 14px 48px;
                font-size: 16px;
            }
        }
        
        /* Tablet search input adjustments */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar-search-input {
                padding: 10px 12px 10px 40px;
                font-size: 14px;
            }
        }
        
        .sidebar-search-input:focus {
            outline: none;
            border-color: rgba(79, 179, 217, 0.5); /* Match secondary color */
            background: #1e293b;
        }
        
        /* Mobile search adjustments */
        @media (max-width: 767px) {
            .sidebar-search {
                padding: 0 15px 12px 15px;
            }
            
            .sidebar-search-input {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 12px 12px 12px 40px;
            }
        }
        
        .sidebar-search-input::placeholder {
            color: #888888;
        }
        
        .sidebar-search-wrapper {
            position: relative;
        }
        
        .sidebar-search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #888888;
            font-size: 14px;
        }
        
        .sidebar-toggle-icon {
            color: #b0b0b0;
            cursor: pointer;
            font-size: 16px;
            transition: color 0.3s, transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            position: relative;
            border-radius: 4px;
            padding: 4px;
        }
        
        .sidebar-toggle-icon:hover {
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-toggle-icon i {
            display: inline-block;
        }
        
        .sidebar.collapsed .sidebar-toggle-icon i.fa-chevron-left {
            transform: rotate(180deg);
            transition: transform 0.3s ease;
        }
        
        .sidebar-toggle-icon i.fa-chevron-left {
            transition: transform 0.3s ease;
        }
        
        /* Sidebar collapsed state */
        .sidebar.collapsed {
            width: 70px;
        }
        
        .sidebar.collapsed .sidebar-title,
        .sidebar.collapsed .sidebar-text,
        .sidebar.collapsed .sidebar-section-header span {
            opacity: 0;
            width: 0;
            overflow: hidden;
            white-space: nowrap;
            display: none;
        }
        
        .sidebar.collapsed .sidebar-header {
            justify-content: center;
            padding: 15px 10px;
        }
        
        .sidebar.collapsed .sidebar-section-header {
            justify-content: center;
            padding: 8px 10px;
        }
        
        .sidebar.collapsed .sidebar-section-header .section-chevron {
            display: none !important;
        }
        
        .sidebar.collapsed .nav-link {
            justify-content: center;
            padding: 8px 10px;
        }
        
        .sidebar.collapsed .sidebar-icon-container {
            margin: 0 auto;
        }
        
        .sidebar.collapsed .sidebar-separator {
            margin: 0 10px;
        }
        
        .sidebar.collapsed .sidebar-content {
            padding: 0;
        }
        
        /* Main content adjustment when sidebar collapsed */
        body:has(.sidebar.collapsed) .main-content,
        .sidebar.collapsed ~ * .main-content {
            margin-left: 70px;
        }
        
        /* Content sections don't need margin-left - main-content handles sidebar spacing */
        @media (min-width: 768px) {
            body:has(.sidebar.collapsed) .content-section.active {
                margin-left: 0 !important;
            }
        }
        
        /* Sidebar Separator */
        .sidebar-separator {
            border-top: 1px dashed rgba(255, 255, 255, 0.15);
            margin: 0 24px;
        }
        
        /* Large screen separator improvements */
        @media (min-width: 1400px) {
            .sidebar-separator {
                margin: 0 28px;
            }
        }
        
        /* Tablet separator adjustments */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar-separator {
                margin: 0 20px;
            }
        }
        
        /* Chevron icons for nav items */
        .sidebar .nav-link .item-chevron {
            margin-left: auto;
            font-size: 10px;
            color: #888888;
            transition: color 0.2s, opacity 0.2s ease;
            opacity: 0; /* Hidden by default */
        }
        
        .sidebar .nav-link:hover .item-chevron,
        .sidebar .nav-link:active .item-chevron,
        .sidebar .nav-link:focus .item-chevron {
            opacity: 1; /* Visible on hover, click, or focus */
            color: #ffffff;
        }
        
        .sidebar .nav-link.active .item-chevron {
            opacity: 1; /* Visible when active */
        }
        
        .sidebar .nav {
            padding: 10px 0;
        }
        
        /* Sidebar Section Headers */
        .sidebar-section {
            margin-top: 0;
            margin-bottom: 0;
        }
        
        .sidebar-section:first-child {
            margin-top: 0;
        }
        
        .sidebar-section-header {
            padding: 16px 24px 10px 24px;
            color: #888888;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: color 0.2s;
            user-select: none;
        }
        
        /* Large screen improvements */
        @media (min-width: 1400px) {
            .sidebar-section-header {
                padding: 18px 28px 12px 28px;
                font-size: 14px;
                letter-spacing: 1.5px;
            }
        }
        
        /* Tablet adjustments */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar-section-header {
                padding: 14px 20px 9px 20px;
                font-size: 12px;
            }
        }
        
        /* Mobile section header adjustments */
        @media (max-width: 767px) {
            .sidebar-section-header {
                padding: 14px 15px 10px 15px;
                font-size: 12px;
                min-height: 44px; /* Better touch target */
            }
            
            .sidebar-section-separator {
                margin: 10px 15px;
            }
        }
        
        .sidebar-section-header:hover {
            color: #ffffff;
        }
        
        .sidebar-section-header .section-add-icon {
            font-size: 12px;
            color: #888888;
            transition: color 0.2s;
        }
        
        .sidebar-section-header:hover .section-add-icon {
            color: #ffffff;
        }
        
        .sidebar-section-header .section-chevron {
            font-size: 10px;
            transition: transform 0.3s ease, color 0.2s ease, opacity 0.2s ease;
            color: #888888;
            opacity: 0; /* Hidden by default */
            margin-left: auto;
            cursor: pointer;
            pointer-events: auto; /* Ensure chevron can be clicked */
        }
        
        .sidebar-section-header:hover .section-chevron,
        .sidebar-section-header:active .section-chevron,
        .sidebar-section-header:focus .section-chevron {
            opacity: 1; /* Visible on hover, click, or focus */
            color: #ffffff;
        }
        
        .sidebar-section-header[aria-expanded="true"] .section-chevron,
        .sidebar-section-header[aria-expanded="false"] .section-chevron {
            opacity: 1; /* Visible when clicked (both expanded and collapsed states) */
        }
        
        .sidebar-section-header[aria-expanded="true"] .section-chevron {
            transform: rotate(180deg);
            color: #ffffff;
        }
        
        .sidebar-section-header[aria-expanded="false"] .section-chevron {
            transform: rotate(0deg);
            color: #888888;
        }
        
        .sidebar-section-header[aria-expanded="false"]:hover .section-chevron,
        .sidebar-section-header[aria-expanded="false"]:active .section-chevron {
            color: #ffffff;
        }
        
        .sidebar-section-header[aria-expanded="true"] {
            color: #ffffff;
        }
        
        /* Section separator */
        .sidebar-section-separator {
            border-top: 1px dashed rgba(255, 255, 255, 0.15);
            margin: 10px 24px;
        }
        
        /* Large screen section separator improvements */
        @media (min-width: 1400px) {
            .sidebar-section-separator {
                margin: 12px 28px;
            }
        }
        
        /* Tablet section separator adjustments */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar-section-separator {
                margin: 8px 20px;
            }
        }
        
        .sidebar-section-items {
            padding: 0;
        }
        
        .sidebar-section-items.collapse {
            display: none;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }
        
        .sidebar-section-items.collapse.show {
            display: block;
            max-height: 2000px; /* Large enough for content */
            opacity: 1;
        }
        
        .sidebar-section-items .nav-item {
            margin-bottom: 1px;
        }
        
        .sidebar-content {
            flex: 1 1 auto;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0; /* Critical for flex item scrolling */
            max-width: 100%;
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            display: flex;
            flex-direction: column;
            /* Custom scrollbar styling */
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
        }
        
        /* Webkit scrollbar styling */
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar-content::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .sidebar-content::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        
        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        /* Mobile content scroll improvements */
        @media (max-width: 767px) {
            .sidebar-content {
                padding-bottom: 15px;
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            }
        }
        
        /* Sidebar Bottom Section */
        .sidebar-bottom {
            margin-top: auto;
            padding-top: 10px;
            flex-shrink: 0; /* Prevent bottom from shrinking */
            padding-bottom: 10px;
        }
        
        .sidebar-bottom-link {
            padding: 14px 24px !important;
            font-size: 15px;
            font-weight: 500;
        }
        
        /* Large screen bottom link improvements */
        @media (min-width: 1400px) {
            .sidebar-bottom-link {
                padding: 16px 28px !important;
                font-size: 16px;
            }
        }
        
        /* Tablet bottom link adjustments */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar-bottom-link {
                padding: 12px 20px !important;
                font-size: 14px;
            }
        }
        
        .sidebar-copyright {
            padding: 18px 24px;
            text-align: center;
        }
        
        /* Large screen copyright improvements */
        @media (min-width: 1400px) {
            .sidebar-copyright {
                padding: 20px 28px;
            }
        }
        
        .sidebar-copyright p {
            color: #666666;
            font-size: 12px;
            margin: 0;
        }
        
        /* Large screen copyright text */
        @media (min-width: 1400px) {
            .sidebar-copyright p {
                font-size: 13px;
            }
        }
        
        /* Mobile bottom section adjustments */
        @media (max-width: 767px) {
            .sidebar-bottom-link {
                padding: 12px 15px !important;
                min-height: 44px;
            }
            
            .sidebar-copyright {
                padding: 12px 15px;
            }
            
            .sidebar-copyright p {
                font-size: 10px;
            }
        }
        
        .sidebar .nav-link {
            color: #ffffff;
            padding: 12px 24px;
            border-radius: 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 14px;
            background: transparent;
            border: none;
            position: relative;
            border-left: 3px solid transparent;
        }
        
        /* Large screen improvements */
        @media (min-width: 1400px) {
            .sidebar .nav-link {
                padding: 14px 28px;
                gap: 16px;
            }
        }
        
        /* Tablet adjustments */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar .nav-link {
                padding: 11px 20px;
                gap: 12px;
            }
        }
        
        /* Mobile nav link adjustments */
        @media (max-width: 767px) {
            .sidebar .nav-link {
                padding: 12px 15px;
                font-size: 15px; /* Larger touch targets */
                min-height: 44px; /* iOS recommended touch target */
            }
            
            .sidebar .nav-link i:not(.fa-chevron-down):not(.fa-chevron-right) {
                font-size: 18px;
                width: 24px;
            }
        }
        
        .sidebar .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }
        
        .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.05);
            color: #ffd700;
            border-left: 3px solid #ffd700;
        }
        
        /* Icon styling - simple white icons */
        .sidebar .nav-link i:not(.fa-chevron-down):not(.fa-chevron-right) {
            color: #ffffff;
            font-size: 18px;
            width: 22px;
            text-align: center;
            transition: all 0.2s;
        }
        
        /* Large screen icon improvements */
        @media (min-width: 1400px) {
            .sidebar .nav-link i:not(.fa-chevron-down):not(.fa-chevron-right) {
                font-size: 20px;
                width: 24px;
            }
        }
        
        .sidebar .nav-link.active i:not(.fa-chevron-down):not(.fa-chevron-right) {
            color: #ffd700;
        }
        
        /* Remove icon containers - use simple icons */
        .sidebar-icon-container {
            display: none;
        }
        
        /* Badge for notifications */
        .sidebar-badge {
            background: #dc3545;
            color: #ffffff;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            margin-left: auto;
        }
        
        /* Icon container colors matching reference */
        .sidebar .nav-link[data-section="dashboard"] .sidebar-icon-container {
            background: #4a5568; /* Dark gray for home */
        }
        
        .sidebar .nav-link[data-section="categories"] .sidebar-icon-container {
            background: #3b82f6; /* Blue */
        }
        
        .sidebar .nav-link[data-section="departments"] .sidebar-icon-container {
            background: #059669; /* Dark green */
        }
        
        .sidebar .nav-link[data-section="suppliers"] .sidebar-icon-container {
            background: #ec4899; /* Pink/Magenta */
        }
        
        .sidebar .nav-link[data-section="sales"] .sidebar-icon-container {
            background: #d97706; /* Brown/Gold */
        }
        
        .sidebar .nav-link[data-section="payment-dashboard"] .sidebar-icon-container {
            background: #84cc16; /* Light green */
        }
        
        .sidebar .nav-link[data-section="payment-vouchers"] .sidebar-icon-container {
            background: #16a34a; /* Dark green */
        }
        
        .sidebar .nav-link[data-section="payment-voucher-list"] .sidebar-icon-container {
            background: #2563eb; /* Blue */
        }
        
        .sidebar .nav-link[data-section="payment-reports"] .sidebar-icon-container {
            background: #7c3aed; /* Purple */
        }
        
        .sidebar .nav-link[data-section="branches"] .sidebar-icon-container {
            background: #3b82f6; /* Blue */
        }
        
        .sidebar .nav-link[data-section="groups"] .sidebar-icon-container {
            background: #059669; /* Dark green */
        }
        
        .sidebar .nav-link[data-section="users"] .sidebar-icon-container {
            background: #ec4899; /* Pink */
        }
        
        .sidebar .nav-link[data-section="employees"] .sidebar-icon-container {
            background: #8b5cf6; /* Purple */
        }
        
        .sidebar .nav-link[data-section="settings"] .sidebar-icon-container {
            background: #d97706; /* Brown/Gold */
        }
        
        .sidebar .nav-link[data-section="support-chat"] .sidebar-icon-container {
            background: #84cc16; /* Light green */
        }
        
        /* Reports menu icon */
        .sidebar #reportsMenuToggle .sidebar-icon-container {
            background: #ec4899; /* Pink */
        }
        
        /* Sidebar text */
        .sidebar .nav-link .sidebar-text {
            color: #ffffff;
            font-size: 15px;
            font-weight: 500;
            flex: 1;
            transition: color 0.2s;
        }
        
        /* Large screen text improvements */
        @media (min-width: 1400px) {
            .sidebar .nav-link .sidebar-text {
                font-size: 16px;
            }
        }
        
        /* Tablet text adjustments */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar .nav-link .sidebar-text {
                font-size: 14px;
            }
        }
        
        .sidebar .nav-link.active .sidebar-text {
            color: #ffd700;
            font-weight: 600;
        }
        
        /* Expandable submenu styles */
        .sidebar .nav-item .collapse {
            background-color: transparent;
        }
        
        .sidebar .nav-item .nav-link[data-bs-toggle="collapse"] {
            cursor: pointer;
        }
        
        .sidebar .nav-item .nav-link[data-bs-toggle="collapse"] .fa-chevron-down {
            transition: transform 0.3s ease, opacity 0.2s ease;
            color: #888888;
            margin-left: auto;
            opacity: 0; /* Hidden by default */
            cursor: pointer;
            pointer-events: auto; /* Ensure chevron can be clicked */
        }
        
        .sidebar .nav-item .nav-link[data-bs-toggle="collapse"]:hover .fa-chevron-down,
        .sidebar .nav-item .nav-link[data-bs-toggle="collapse"]:active .fa-chevron-down,
        .sidebar .nav-item .nav-link[data-bs-toggle="collapse"]:focus .fa-chevron-down {
            opacity: 1; /* Visible on hover, click, or focus */
        }
        
        .sidebar .nav-item .nav-link[data-bs-toggle="collapse"][aria-expanded="true"] .fa-chevron-down,
        .sidebar .nav-item .nav-link[data-bs-toggle="collapse"][aria-expanded="false"] .fa-chevron-down {
            opacity: 1; /* Visible when clicked (both expanded and collapsed states) */
        }
        
        .sidebar .nav-item .nav-link[data-bs-toggle="collapse"][aria-expanded="true"] .fa-chevron-down {
            transform: rotate(180deg);
            color: #ffffff;
        }
        
        .sidebar .nav-item .nav-link[data-bs-toggle="collapse"][aria-expanded="false"] .fa-chevron-down {
            transform: rotate(0deg);
            color: #888888;
        }
        
        .sidebar .nav-item .nav-link[data-bs-toggle="collapse"][aria-expanded="false"]:hover .fa-chevron-down,
        .sidebar .nav-item .nav-link[data-bs-toggle="collapse"][aria-expanded="false"]:active .fa-chevron-down {
            color: #ffffff;
        }
        
        .sidebar .nav-item .collapse .nav-link {
            padding-left: 56px;
            padding-top: 10px;
            padding-bottom: 10px;
            padding-right: 24px;
            font-size: 14px;
            color: #d0d0d0;
            font-weight: 400;
        }
        
        /* Large screen submenu improvements */
        @media (min-width: 1400px) {
            .sidebar .nav-item .collapse .nav-link {
                padding-left: 64px;
                padding-top: 12px;
                padding-bottom: 12px;
                padding-right: 28px;
                font-size: 15px;
            }
        }
        
        /* Tablet submenu adjustments */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar .nav-item .collapse .nav-link {
                padding-left: 50px;
                padding-right: 20px;
                font-size: 13px;
            }
        }
        
        .sidebar .nav-item .collapse .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }
        
        .sidebar .nav-item .collapse .nav-link i:not(.fa-chevron-down) {
            font-size: 16px;
            width: 20px;
        }
        
        /* Large screen submenu icons */
        @media (min-width: 1400px) {
            .sidebar .nav-item .collapse .nav-link i:not(.fa-chevron-down) {
                font-size: 17px;
                width: 22px;
            }
        }
        
        .sidebar .nav-item .collapse .nav-link .item-chevron {
            font-size: 9px;
        }
        
        /* Nested submenu styles (for warehouse/shop reports) */
        .sidebar .nav-item .collapse .nav-item .collapse {
            background-color: transparent;
        }
        
        .sidebar .nav-item .collapse .nav-link[data-bs-toggle="collapse"] {
            font-weight: 500;
            color: #d0d0d0;
        }
        
        .sidebar .nav-item .collapse .nav-link[data-bs-toggle="collapse"] .fa-chevron-down {
            transition: transform 0.3s ease, opacity 0.2s ease;
            color: #888888;
            opacity: 0; /* Hidden by default */
            cursor: pointer;
            pointer-events: auto; /* Ensure chevron can be clicked */
        }
        
        .sidebar .nav-item .collapse .nav-link[data-bs-toggle="collapse"]:hover .fa-chevron-down,
        .sidebar .nav-item .collapse .nav-link[data-bs-toggle="collapse"]:active .fa-chevron-down,
        .sidebar .nav-item .collapse .nav-link[data-bs-toggle="collapse"]:focus .fa-chevron-down {
            opacity: 1; /* Visible on hover, click, or focus */
        }
        
        .sidebar .nav-item .collapse .nav-link[data-bs-toggle="collapse"][aria-expanded="true"] .fa-chevron-down,
        .sidebar .nav-item .collapse .nav-link[data-bs-toggle="collapse"][aria-expanded="false"] .fa-chevron-down {
            opacity: 1; /* Visible when clicked (both expanded and collapsed states) */
        }
        
        .sidebar .nav-item .collapse .nav-link[data-bs-toggle="collapse"][aria-expanded="true"] .fa-chevron-down {
            transform: rotate(180deg);
            color: #ffffff;
        }
        
        .sidebar .nav-item .collapse .nav-link[data-bs-toggle="collapse"][aria-expanded="false"] .fa-chevron-down {
            transform: rotate(0deg);
            color: #888888;
        }
        
        .sidebar .nav-item .collapse .nav-link[data-bs-toggle="collapse"][aria-expanded="false"]:hover .fa-chevron-down,
        .sidebar .nav-item .collapse .nav-link[data-bs-toggle="collapse"][aria-expanded="false"]:active .fa-chevron-down {
            color: #ffffff;
        }
        
        .sidebar .nav-item .collapse .collapse .nav-link {
            padding-left: 70px;
            padding-top: 6px;
            padding-bottom: 6px;
            font-size: 12px;
            color: #b0b0b0;
        }
        
        .sidebar .nav-item .collapse .collapse .nav-link:hover {
            color: #ffffff;
        }
        
        .sidebar .nav-item .collapse .collapse .nav-link i:not(.fa-chevron-down) {
            font-size: 8px;
            width: 12px;
        }
        
        /* Custom scrollbar for sidebar */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Ensure chevron icons are properly positioned */
        .sidebar .nav-link .item-chevron {
            margin-left: auto;
            color: #888888;
            transition: color 0.2s, transform 0.3s, opacity 0.2s ease;
            opacity: 0; /* Hidden by default */
        }
        
        .sidebar .nav-link:hover .item-chevron,
        .sidebar .nav-link:active .item-chevron,
        .sidebar .nav-link:focus .item-chevron {
            opacity: 1; /* Visible on hover, click, or focus */
            color: #ffffff;
        }
        
        .sidebar .nav-link.active .item-chevron {
            opacity: 1; /* Visible when active */
            color: #ffd700;
        }
        
        /* Active state styling */
        .sidebar .nav-link.active .sidebar-icon-container {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }
        
        /* ========================================
           MAIN CONTENT STYLES
           ======================================== */
        
        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 0 !important; /* NO horizontal padding */
            padding-top: 60px !important; /* Add top padding to account for fixed navbar */
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }
        
        /* Large screen main content adjustments */
        @media (min-width: 1400px) {
            .main-content {
                margin-left: 280px;
            }
        }
        
        /* Extra large screen main content adjustments */
        @media (min-width: 1920px) {
            .main-content {
                margin-left: 300px;
            }
        }
        
        /* Adjust main content when sidebar is collapsed */
        body:has(.sidebar.collapsed) .main-content,
        .sidebar.collapsed ~ * .main-content {
            margin-left: 70px;
        }
        
        /* Content sections don't need margin-left - main-content handles sidebar spacing */
        body:has(.sidebar.collapsed) .content-section,
        .sidebar.collapsed ~ * .content-section {
            margin-left: 0 !important;
        }
        
        /* Mobile: No margin when sidebar is hidden */
        @media (max-width: 767px) {
            .main-content,
            .content-section,
            .content-section.active {
                margin-left: 0 !important;
            }
            
            /* When sidebar is active on mobile, content stays full width */
            .sidebar.active ~ * .main-content,
            .sidebar.active ~ * .content-section {
                margin-left: 0 !important;
            }
        }
        
        /* Add padding to content sections instead, not main-content */
        /* ZERO top padding to eliminate empty space at top */
        .content-section.active {
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 20px;
            padding-top: 0 !important; /* NO top padding - content starts from absolute top */
            margin-top: 0 !important;
            /* No margin-left needed - main-content container handles sidebar spacing */
            margin-left: 0 !important;
        }
        
        /* Specific sections: Remove all top spacing */
        #payment-vouchers-section.active,
        #payment-voucher-list-section.active,
        #payment-reports-section.active,
        #payment-dashboard-section.active,
        #reports-section.active,
        #branches-section.active,
        #groups-section.active,
        #users-section.active,
        #settings-section.active {
            padding-top: 0 !important;
            margin-top: 0 !important;
        }
        
        /* Ensure all sections start at top with no extra space */
        /* Note: Top padding is handled by main-content, not individual sections */
        .content-section.active > .dashboard-header:first-child {
            margin-top: 0 !important;
            padding-top: 20px !important; /* Add some top padding for spacing from navbar */
        }
        
        /* ========================================
           CARD STYLES
           ======================================== */
        
        /* Card Styles */
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: none;
            margin-bottom: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
            padding: 12px 15px;
        }
        
        /* Category Box Styles - Updated */
        .category-card {
            height: 100%;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .category-card:hover {
            transform: translateY(-5px);
        }
        
        .category-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .category-body {
            padding: 20px;
            background: white;
        }
        
        .category-metrics {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .metric-row {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            color: white;
        }
        
        .metric-row.sales {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .metric-row.cost {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
        }
        
        .metric-row.profit {
            background: linear-gradient(135deg, #17a2b8, #3498db);
        }
        
        .metric-label {
            flex: 1;
            font-weight: 500;
        }
        
        .metric-value {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .category-footer {
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .margin-badge {
            font-size: 0.9rem;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .margin-badge.positive {
            background-color: var(--success-color);
            color: white;
        }
        
        .margin-badge.negative {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Grand Total Special Styling */
        .category-card.grand-total .category-header {
            background: linear-gradient(135deg, #6f42c1, #8e44ad);
            font-size: 1.2rem;
        }
        
        /* Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 110, 138, 0.3);
        }
        
        /* Circular Button Styles */
        .circular-btn {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            max-width: 40px;
            max-height: 40px;
            border-radius: 50% !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-shadow: 0 2px 8px rgba(44, 110, 138, 0.2);
            flex-shrink: 0;
        }
        
        .circular-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 5px 15px rgba(44, 110, 138, 0.4);
        }
        
        .circular-btn i {
            font-size: 1rem;
        }
        
        /* Ensure button container maintains circular buttons in responsive */
        .d-flex.gap-2.align-items-center {
            flex-wrap: nowrap;
        }
        
        .d-flex.gap-2.align-items-center .circular-btn {
            flex-shrink: 0;
        }
        
        /* Tabbed Layout Styles */
        .report-tabs {
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .report-tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .report-tab:hover {
            background: #e9ecef;
            color: var(--primary-color);
        }
        
        .report-tab.active {
            background: var(--primary-color);
            color: #fff;
        }
        
        .report-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-color);
        }
        
        .report-tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .report-tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 768px) {
            .report-tabs {
                flex-direction: column;
                border-bottom: none;
            }
            
            .report-tab {
                border-radius: 8px;
                margin-bottom: 8px;
            }
            
            .report-tab.active::after {
                display: none;
            }
            
            /* Report Sections Mobile Responsive */
            #reports-section .card {
                margin-bottom: 20px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            #reports-section .card-header {
                padding: 15px;
                font-size: 0.95rem;
            }
            
            #reports-section .card-body {
                padding: 15px;
            }
            
            /* Report Filters Mobile */
            #reports-section .row.g-3 {
                margin-left: -8px;
                margin-right: -8px;
            }
            
            #reports-section .row.g-3 > [class*="col-"] {
                padding-left: 8px;
                padding-right: 8px;
                margin-bottom: 12px;
            }
            
            /* Summary Cards Mobile */
            #salesSummaryCards .col-md-3 {
                flex: 0 0 100%;
                max-width: 100%;
                margin-bottom: 15px;
            }
            
            #salesSummaryCards .card {
                padding: 15px !important;
            }
            
            #salesSummaryCards .card-body {
                padding: 15px !important;
            }
            
            #salesSummaryCards h3 {
                font-size: 1.5rem !important;
            }
            
            #salesSummaryCards h6 {
                font-size: 0.9rem !important;
            }
            
            /* Tables Mobile */
            #salesReportTableBody,
            #comparisonReportTableBody,
            #datewiseReportTableBody {
                font-size: 0.9rem;
            }
            
            #salesReportTableBody td,
            #comparisonReportTableBody td,
            #datewiseReportTableBody td {
                padding: 8px 6px;
                font-size: 0.85rem;
            }
            
            #salesReportTableBody th,
            #comparisonReportTableBody th,
            #datewiseReportTableBody th {
                padding: 10px 6px;
                font-size: 0.85rem;
            }
            
            /* Branch/Category Header Rows Mobile */
            .branch-header-row td,
            .category-header-row td,
            .branch-top-header-row td,
            .branch-name-row td {
                padding: 10px !important;
                font-size: 1rem !important;
            }
            
            .branch-top-header-row td,
            .branch-name-row td {
                font-size: 1.1rem !important;
                padding: 12px !important;
            }
            
            /* Branch/Category Total Rows Mobile */
            .branch-total-row td,
            .category-total-row td {
                padding: 8px 6px !important;
                font-size: 0.9rem !important;
            }
            
            /* Tooltip styling for sales report data */
            #salesReportTableBody td[title] {
                cursor: help;
                position: relative;
            }
            
            #salesReportTableBody td[title]:hover {
                background-color: #f8f9fa;
            }
            
            /* Enhanced tooltip for better visibility */
            #salesReportTableBody .badge[title] {
                cursor: help;
            }
            
            /* Print Button Mobile */
            #printSalesReportBtn,
            #printComparisonReportBtn,
            #printDatewiseReportBtn {
                width: 100%;
                margin-top: 10px;
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            /* Generate Button Mobile */
            #generateSalesReportBtn,
            #generateComparisonReportBtn,
            #generateDatewiseReportBtn {
                width: 100%;
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            /* Search Input Mobile */
            #datewiseSearch {
                font-size: 0.9rem;
                padding: 10px 12px;
            }
            
            /* Label Mobile */
            .form-label {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }
            
            /* Form Controls Mobile */
            .form-select,
            .form-control {
                font-size: 0.9rem;
                padding: 10px 12px;
            }
            
            /* Date Inputs Mobile */
            input[type="date"] {
                font-size: 0.9rem;
                padding: 10px 12px;
            }
            
            /* Table Action Buttons Mobile */
            #reports-section .d-flex.justify-content-between {
                flex-direction: column;
            }
            
            #reports-section .card-title {
                margin-bottom: 15px;
                text-align: center;
            }
        }
        
        /* New Branch Card Design - Beautiful and Professional */
        .branch-kpi-item {
            margin-bottom: 12px;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Ensure branch card containers don't overflow */
        #warehouseBranchCardsContainer,
        #shopBranchCardsContainer {
            width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        
        /* Ensure branch cards don't overflow */
        .branch-card,
        .card.h-100.shadow-sm {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        .card-body {
            overflow: hidden;
            box-sizing: border-box;
        }
        
        /* Fix branch card header text overlapping */
        .card-header {
            overflow: hidden;
            box-sizing: border-box;
            position: relative;
        }
        
        .card-header h5.card-title,
        .card-header h6.mb-0 {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
            display: block;
            box-sizing: border-box;
        }
        
        /* Branch card header - main branch name */
        .card-header.text-center h5.card-title {
            padding: 0;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
            word-break: break-word;
        }
        
        /* Department/Category header with badge - ensure text doesn't overlap badge */
        .card-header h6.mb-0.text-center {
            padding: 0 60px 0 10px !important;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: calc(100% - 70px);
            text-align: left !important;
            display: block;
            box-sizing: border-box;
        }
        
        /* Ensure badge doesn't overlap text */
        .card-header .badge.position-absolute {
            right: 10px !important;
            z-index: 1;
            flex-shrink: 0;
        }
        
        /* Responsive adjustments for headers */
        @media (max-width: 768px) {
            .card-header h5.card-title,
            .card-header h6.mb-0 {
                font-size: 0.95rem !important;
                padding: 0 5px !important;
            }
            
            .card-header h6.mb-0.text-center {
                padding: 0 50px 0 5px !important;
                max-width: calc(100% - 60px);
                font-size: 0.85rem !important;
            }
            
            .card-header .badge.position-absolute {
                font-size: 0.65rem !important;
                padding: 3px 8px !important;
                right: 5px !important;
            }
        }
        
        @media (max-width: 576px) {
            .card-header {
                padding: 10px 12px !important;
            }
            
            .card-header h5.card-title {
                font-size: 0.9rem !important;
            }
            
            .card-header h6.mb-0.text-center {
                font-size: 0.8rem !important;
                padding: 0 45px 0 5px !important;
                max-width: calc(100% - 55px);
            }
            
            .card-header .badge.position-absolute {
                font-size: 0.6rem !important;
                padding: 2px 6px !important;
            }
        }
        
        /* Reduce margin for category details */
        .card-body:not(:has(.branch-main-kpis)) .branch-kpi-item {
            margin-bottom: 8px;
        }
        
        .branch-kpi-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .branch-kpi-item:last-child {
            margin-bottom: 0;
        }
        
        /* Default Vertical Layout for category details */
        .branch-kpi-item {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            width: 100%;
            min-width: 0;
            overflow: visible;
        }
        
        /* Branch KPIs should always show label left / value right */
        .branch-main-kpis .branch-kpi-item {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            text-align: left;
            gap: 8px;
            width: 100%;
        }
        
        .branch-main-kpis .branch-kpi-label {
            justify-content: flex-start;
            text-align: left;
            border-radius: 8px 0 0 8px;
            width: auto;
            min-width: 0;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .branch-main-kpis .branch-kpi-value {
            justify-content: flex-end;
            text-align: right;
            border-radius: 0 8px 8px 0;
            width: auto;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-variant-numeric: tabular-nums;
            max-width: 100%;
        }

        .branch-main-kpis .branch-kpi-item.stacked {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 6px;
        }
        .branch-main-kpis .branch-kpi-item.stacked .branch-kpi-label {
            border-radius: 8px 8px 0 0;
            width: 100%;
            text-align: left;
        }
        .branch-main-kpis .branch-kpi-item.stacked .branch-kpi-value {
            border-radius: 0 0 8px 8px;
            width: 100%;
            text-align: right;
        }
        
        /* Ensure tighter spacing on very small screens */
        @media (max-width: 768px) {
            .branch-main-kpis .branch-kpi-item {
                gap: 6px;
                padding: 0;
            }
            
            .branch-main-kpis .branch-kpi-item .branch-kpi-label,
            .branch-main-kpis .branch-kpi-item .branch-kpi-value {
                padding: clamp(8px, 1.5vw, 14px) clamp(10px, 2vw, 16px) !important;
            }
        }
        
        /* Base styles for desktop - will be overridden by mobile */
        .branch-kpi-item .branch-kpi-label,
        .branch-kpi-item .branch-kpi-value {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: clamp(8px, 1.5vw, 16px) clamp(10px, 2vw, 20px);
            min-width: 0;
            flex: 1 1 auto;
            overflow: hidden;
            box-sizing: border-box;
            text-align: center;
            width: 100%;
        }

        /* Force left/right alignment inside branch-main-kpis */
        .branch-main-kpis .branch-kpi-item .branch-kpi-label { justify-content: flex-start !important; text-align: left !important; }
        .branch-main-kpis .branch-kpi-item .branch-kpi-value { justify-content: flex-end !important; text-align: right !important; }
        .branch-main-kpis .branch-kpi-item.stacked .branch-kpi-label { justify-content: flex-start !important; text-align: left !important; }
        .branch-main-kpis .branch-kpi-item.stacked .branch-kpi-value { justify-content: flex-end !important; text-align: right !important; }
        
        /* Branch KPI label/value widths already set for all screens */
        
        /* Reduced padding for category details (vertical layout only) */
        .card-body:not(:has(.branch-main-kpis)) .branch-kpi-label,
        .card-body:not(:has(.branch-main-kpis)) .branch-kpi-value {
            padding: clamp(6px, 1vw, 12px) clamp(8px, 1.5vw, 16px) !important;
        }
        
        /* Base styles for desktop */
        .branch-kpi-label {
            font-size: clamp(0.7rem, 1.2vw, 0.85rem);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            gap: 4px;
            justify-content: center;
            text-align: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            white-space: normal;
            line-height: 1.4;
            max-width: 100%;
        }
        
        .branch-kpi-value {
            font-size: clamp(0.85rem, 1.8vw, 1.15rem);
            font-weight: 700;
            text-align: center;
            justify-content: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
            min-height: 1.5em;
            max-width: 100%;
        }
        
        /* Branch KPI text handling */
        .branch-main-kpis .branch-kpi-label {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .branch-main-kpis .branch-kpi-value {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        @media (max-width: 1400px) {
            .branch-main-kpis .branch-kpi-label {
                font-size: clamp(0.7rem, 1.3vw, 0.85rem);
                padding: clamp(10px, 1.5vw, 16px) clamp(10px, 2vw, 20px);
            }
            .branch-main-kpis .branch-kpi-value {
                font-size: clamp(0.9rem, 2vw, 1.2rem);
                padding: clamp(8px, 1.2vw, 14px) clamp(10px, 2vw, 20px);
            }
        }
        
        @media (max-width: 1200px) {
            .branch-main-kpis .branch-kpi-label {
                font-size: clamp(0.65rem, 1.2vw, 0.8rem);
                padding: clamp(9px, 1.4vw, 15px) clamp(9px, 1.8vw, 18px);
            }
            .branch-main-kpis .branch-kpi-value {
                font-size: clamp(0.85rem, 1.8vw, 1.1rem);
                padding: clamp(8px, 1.2vw, 14px) clamp(9px, 1.8vw, 18px);
            }
        }
        
        @media (max-width: 992px) {
            .branch-main-kpis .branch-kpi-label {
                font-size: clamp(0.65rem, 1.5vw, 0.8rem);
            }
            .branch-main-kpis .branch-kpi-value {
                font-size: clamp(0.85rem, 2vw, 1.05rem);
            }
        }
        
        @media (max-width: 768px) {
            .branch-main-kpis .branch-kpi-item {
                gap: 6px;
            }
        }
        
        @media (max-width: 576px) {
            .branch-main-kpis .branch-kpi-label {
                font-size: clamp(0.6rem, 2vw, 0.75rem);
                padding: clamp(7px, 1.5vw, 12px) clamp(6px, 1.8vw, 14px);
            }
            .branch-main-kpis .branch-kpi-value {
                font-size: clamp(0.8rem, 2.5vw, 1rem);
                padding: clamp(6px, 1.3vw, 12px) clamp(6px, 1.8vw, 14px);
            }
        }
        
        @media (max-width: 400px) {
            .branch-main-kpis .branch-kpi-label {
                font-size: 0.65rem;
                padding: 8px 10px;
            }
            .branch-main-kpis .branch-kpi-value {
                font-size: 0.85rem;
                padding: 8px 10px;
            }
        }
        
        /* Ensure icons don't cause overflow and are centered */
        .branch-kpi-label i,
        .branch-kpi-value i {
            flex-shrink: 0;
            min-width: 1em;
            display: inline-flex;
            align-items: center;
        }
        
        /* Desktop - Center all content in branch KPI items (vertical layout) */
        /* This is the default, mobile will override with !important */
        
        /* Additional responsive fixes for very small screens */
        @media (max-width: 576px) {
            .branch-kpi-label {
                font-size: 0.7rem !important;
                padding: 8px 10px !important;
            }
            .branch-kpi-value {
                font-size: 0.85rem !important;
                padding: 8px 10px !important;
            }
            .card-body {
                padding: 15px !important;
            }
        }
        
        /* Prevent text from breaking layout */
        .branch-kpi-label,
        .branch-kpi-value {
            box-sizing: border-box;
        }
        
        /* Ensure long numbers wrap or truncate properly */
        .branch-kpi-value strong {
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Color coding with backgrounds */
        .kpi-sales-label,
        .kpi-sales-value {
            color: #fff;
            background: transparent;
        }
        
        .kpi-sales-label {
            border-radius: 8px 8px 0 0;
        }
        
        .kpi-sales-value {
            border-radius: 0 0 8px 8px;
        }
        
        .kpi-cost-label,
        .kpi-cost-value {
            color: #fff;
            background: transparent;
        }
        
        .kpi-cost-label {
            border-radius: 8px 8px 0 0;
        }
        
        .kpi-cost-value {
            border-radius: 0 0 8px 8px;
        }
        
        .kpi-profit-label,
        .kpi-profit-value {
            color: #fff;
            background: transparent;
        }
        
        .kpi-profit-label {
            border-radius: 8px 8px 0 0;
        }
        
        .kpi-profit-value {
            border-radius: 0 0 8px 8px;
        }
        
        .kpi-margin-label,
        .kpi-margin-value {
            color: #fff;
            background: transparent;
        }
        
        .kpi-margin-label {
            border-radius: 8px 8px 0 0;
        }
        
        .kpi-margin-value {
            border-radius: 0 0 8px 8px;
        }
        
        /* Apply backgrounds to parent items based on child classes */
        .branch-kpi-item:has(.kpi-sales-label) {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .branch-kpi-item:has(.kpi-cost-label) {
            background: linear-gradient(135deg, #136F63 0%, #17a2b8 100%);
        }
        
        .branch-kpi-item:has(.kpi-profit-label) {
            background: linear-gradient(135deg, #CF2A2A 0%, #ff6b6b 100%);
        }
        
        .branch-kpi-item:has(.kpi-margin-label) {
            background: linear-gradient(135deg, #4D4D4D 0%, #6c757d 100%);
        }
        
        /* Shop Sale Entry Field Styles */
        .kpi-gross-sale-label,
        .kpi-gross-sale-value {
            color: #fff;
            background: transparent;
        }
        
        .kpi-gross-sale-label {
            border-radius: 8px 8px 0 0;
        }
        
        .kpi-gross-sale-value {
            border-radius: 0 0 8px 8px;
        }
        
        .kpi-discount-label,
        .kpi-discount-value {
            color: #fff;
            background: transparent;
        }
        
        .kpi-discount-label {
            border-radius: 8px 8px 0 0;
        }
        
        .kpi-discount-value {
            border-radius: 0 0 8px 8px;
        }
        
        .kpi-discount-value-label,
        .kpi-discount-value-value {
            color: #fff;
            background: transparent;
        }
        
        .kpi-discount-value-label {
            border-radius: 8px 8px 0 0;
        }
        
        .kpi-discount-value-value {
            border-radius: 0 0 8px 8px;
        }
        
        .kpi-sale-value-label,
        .kpi-sale-value-value {
            color: #fff;
            background: transparent;
        }
        
        .kpi-sale-value-label {
            border-radius: 8px 8px 0 0;
        }
        
        .kpi-sale-value-value {
            border-radius: 0 0 8px 8px;
        }
        
        .kpi-return-label,
        .kpi-return-value {
            color: #fff;
            background: transparent;
        }
        
        .kpi-return-label {
            border-radius: 8px 8px 0 0;
        }
        
        .kpi-return-value {
            border-radius: 0 0 8px 8px;
        }
        
        .kpi-gst-label,
        .kpi-gst-value {
            color: #fff;
            background: transparent;
        }
        
        .kpi-gst-label {
            border-radius: 8px 8px 0 0;
        }
        
        .kpi-gst-value {
            border-radius: 0 0 8px 8px;
        }
        
        .kpi-net-sale-label,
        .kpi-net-sale-value {
            color: #fff;
            background: transparent;
        }
        
        .kpi-net-sale-label {
            border-radius: 8px 8px 0 0;
        }
        
        .kpi-net-sale-value {
            border-radius: 0 0 8px 8px;
        }
        
        /* Background colors for shop sale entry fields */
        .branch-kpi-item:has(.kpi-gross-sale-label) {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .branch-kpi-item:has(.kpi-discount-label) {
            background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%);
        }
        
        .branch-kpi-item:has(.kpi-discount-value-label) {
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
        }
        
        .branch-kpi-item:has(.kpi-sale-value-label) {
            background: linear-gradient(135deg, #136F63 0%, #17a2b8 100%);
        }
        
        .branch-kpi-item:has(.kpi-return-label) {
            background: linear-gradient(135deg, #e91e63 0%, #f06292 100%);
        }
        
        .branch-kpi-item:has(.kpi-gst-label) {
            background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%);
        }
        
        .branch-kpi-item:has(.kpi-net-sale-label) {
            background: linear-gradient(135deg, #1565c0 0%, #42a5f5 100%);
        }
        
        /* Branch Card Hover Effects */
        .card.h-100 {
            transition: all 0.3s ease;
        }
        
        .card.h-100:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(44, 110, 138, 0.15) !important;
        }
        
        /* Payment Details Section - Filters in one row */
        .dashboard-payment-filters-wrapper {
            width: 100%;
            max-width: 100%;
            margin-left: 0;
            margin-right: 0;
        }
        
        .dashboard-payment-filters {
            flex-wrap: wrap;
            gap: 0.5rem !important;
            width: 100%;
            justify-content: flex-start;
        }
        
        @media (max-width: 991px) {
            .dashboard-payment-filters-wrapper {
                width: 100%;
                margin-top: 0.5rem;
            }
        }
        
        /* Tablet and Desktop - Horizontal layout */
        @media (min-width: 769px) {
            .dashboard-payment-filters {
                flex-direction: row;
            }
            
            .dashboard-payment-filters .form-select,
            .dashboard-payment-filters .form-control {
                flex: 1 1 auto;
                min-width: 120px;
                max-width: 200px;
            }
            
            .dashboard-payment-filters #refreshPaymentDetailsBtn {
                flex-shrink: 0;
            }
        }
        
        /* Desktop: Larger min-width */
        @media (min-width: 992px) {
            .dashboard-payment-filters .form-select,
            .dashboard-payment-filters .form-control {
                min-width: 140px;
            }
        }
        
        /* Payment Details Table Alignment */
        .category-payment-container table {
            table-layout: auto;
        }
        
        .category-payment-container th,
        .category-payment-container td {
            vertical-align: middle;
        }
        
        .category-total-footer table {
            width: 100%;
            table-layout: fixed;
        }
        
        .category-total-footer td {
            padding: 12px !important;
        }
        
        /* Payment Details Summary Cards - Reduced Padding */
        #dashboardPaymentSummaryCards .card {
            margin-bottom: 0.75rem !important;
        }
        
        #dashboardPaymentSummaryCards .card-body {
            padding: 1rem 0.75rem !important;
        }
        
        #dashboardPaymentSummaryCards h3 {
            font-size: 1.3rem !important;
            margin-bottom: 0 !important;
            line-height: 1.3 !important;
        }
        
        #dashboardPaymentSummaryCards h6 {
            font-size: 0.8rem !important;
            margin-bottom: 0.4rem !important;
        }
        
        /* Payment Details Section - Mobile Responsive */
        @media (max-width: 768px) {
            #dashboardPaymentSummaryCards .col-6 {
                margin-bottom: 0.75rem;
            }
            
            #dashboardPaymentSummaryCards .card-body {
                padding: 0.85rem 0.6rem !important;
            }
            
            #dashboardPaymentSummaryCards h3 {
                font-size: 1.15rem !important;
            }
            
            #dashboardPaymentSummaryCards h6 {
                font-size: 0.75rem !important;
            }
            
            .dashboard-payment-filters-wrapper {
                width: 100%;
                padding: 0;
                margin: 0;
            }
            
            .dashboard-payment-filters {
                flex-wrap: wrap;
                flex-direction: column;
                width: 100%;
                gap: 0.5rem !important;
            }
            
            .dashboard-payment-filters .form-select,
            .dashboard-payment-filters .form-control {
                flex: 1 1 100%;
                min-width: 100% !important;
                max-width: 100% !important;
                width: 100% !important;
                margin-bottom: 0;
            }
            
            .dashboard-payment-filters #dashboardPaymentDateFilter {
                flex: 1 1 100%;
                min-width: 100% !important;
                max-width: 100% !important;
                width: 100% !important;
            }
            
            .dashboard-payment-filters #refreshPaymentDetailsBtn {
                flex: 1 1 100%;
                min-width: 100% !important;
                max-width: 100% !important;
                width: 100% !important;
                margin-bottom: 0;
            }
            
            .dashboard-payment-filters #dashboardPaymentCustomDateRange {
                flex-direction: column !important;
                width: 100% !important;
                gap: 0.5rem !important;
            }
            
            .dashboard-payment-filters #dashboardPaymentCustomDateRange input {
                width: 100% !important;
            }
            
            #dashboardPaymentTableBody td,
            #dashboardPaymentTableBody th {
                font-size: 0.85rem;
                padding: 8px 4px;
            }
            
            .category-name-row td {
                font-size: 1.1rem !important;
                padding: 8px !important;
            }
            
            .section-title {
                font-size: 1.2rem !important;
            }
        }
        
        @media (max-width: 480px) {
            #dashboardPaymentSummaryCards .col-6 {
                flex: 0 0 50%;
                max-width: 50%;
            }
            
            #dashboardPaymentTableBody td,
            #dashboardPaymentTableBody th {
                font-size: 0.75rem;
                padding: 6px 2px;
            }
            
            .category-name-row td h5 {
                font-size: 1rem !important;
            }
        }
        
        /* Zoom and Scale Responsive Fixes - Ensures numbers display properly when zoomed out */
        @media (max-width: 1920px) {
            .branch-kpi-value {
                font-size: clamp(0.9rem, 1.8vw, 1.3rem) !important;
                line-height: 1.4 !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                white-space: normal !important;
            }
            
            .branch-kpi-label {
                font-size: clamp(0.75rem, 1.5vw, 0.9rem) !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
            }
            
            .card-body {
                overflow: visible !important;
                word-wrap: break-word !important;
            }
            
            .branch-kpi-item {
                overflow: visible !important;
                min-width: 0 !important;
            }
        }
        
        /* Responsive Design for Mobile */
        @media (max-width: 768px) {
            /* Reduce card body padding for better fit on mobile */
            .card-body {
                padding: 15px !important;
            }
            
            .branch-kpi-label {
                font-size: clamp(0.7rem, 2vw, 0.85rem);
                padding: clamp(6px, 1.5vw, 12px) clamp(8px, 2vw, 16px);
                gap: 3px;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            .branch-kpi-value {
                font-size: clamp(0.85rem, 2.5vw, 1.1rem);
                padding: clamp(6px, 1.5vw, 12px) clamp(8px, 2vw, 16px);
                word-wrap: break-word;
                overflow-wrap: break-word;
                white-space: normal;
                line-height: 1.4;
            }
            
            .branch-kpi-label i {
                font-size: 0.7rem;
            }
            
            /* Keep buttons circular on mobile - maintain shape */
            .circular-btn {
                width: 40px !important;
                height: 40px !important;
                min-width: 40px !important;
                min-height: 40px !important;
                max-width: 40px !important;
                max-height: 40px !important;
                border-radius: 50% !important;
                padding: 0 !important;
                flex-shrink: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            .circular-btn i {
                font-size: 1rem !important;
            }
            
            /* Keep button container from wrapping - maintain horizontal layout */
            .d-flex.gap-2.align-items-center {
                flex-wrap: nowrap !important;
                gap: 0.5rem !important;
            }
            
            /* Ensure buttons stay together */
            .d-flex.gap-2.align-items-center .circular-btn {
                flex-shrink: 0 !important;
                margin: 0 !important;
            }
            
            /* Adjust card header text */
            .card-title {
                font-size: 0.9rem !important;
            }
            
            /* Category card responsive */
            .card-header h6 {
                font-size: 0.8rem !important;
                padding: 0 35px !important;
            }
            
            /* Smaller gap on mobile */
            .row.g-2 {
                margin-left: -8px;
                margin-right: -8px;
            }
            
            .row.g-2 > * {
                padding-left: 8px;
                padding-right: 8px;
            }
            
            /* Ensure cards don't overflow */
            .card {
                max-width: 100%;
                overflow-x: auto;
            }
            
            /* Adjust main container padding */
            .container-fluid, .container {
                padding-left: 10px;
                padding-right: 10px;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 480px) {
            /* Reports section on extra small devices */
            #reports-section .card-header h5 {
                font-size: 0.85rem !important;
            }
            
            #reports-section .card-title {
                font-size: 0.85rem !important;
            }
            
            #reports-section .table {
                font-size: 0.75rem;
            }
            
            #reports-section .table td,
            #reports-section .table th {
                padding: 6px 4px;
                font-size: 0.7rem;
            }
            
            .report-tab {
                font-size: 0.8rem;
                padding: 10px 12px;
            }
            
            .report-tab i {
                font-size: 0.9rem;
                margin-right: 4px;
            }
            
            /* Summary cards on very small screens */
            #salesSummaryCards .card-body {
                padding: 12px 8px !important;
            }
            
            #salesSummaryCards h3 {
                font-size: 1.3rem !important;
            }
            
            /* Badge responsive */
            .badge {
                font-size: 0.7rem;
                padding: 4px 8px;
            }
            
            /* Filter row spacing */
            #reports-section .row.g-3 > [class*="col-"] {
                margin-bottom: 10px;
            }
        }
        
        /* Category Filter Dropdown Styles */
        #categoryFilterDropdownMenu {
            min-width: 100% !important;
        }
        
        #categoryFilterDropdownMenu .form-check {
            transition: background-color 0.2s;
        }
        
        #categoryFilterDropdownMenu .form-check:hover {
            background-color: #f8f9fa;
        }
        
        #categoryFilterDropdownMenu .form-check-label {
            cursor: pointer;
            width: 100%;
            display: block;
        }
        
        #categoryFilterDropdownMenu .form-check-input {
            cursor: pointer;
        }
        
        /* Category Report Dropdown Styles */
        #categoryReportDropdownMenu {
            z-index: 9999 !important;
            position: relative;
            max-height: 300px;
            overflow-y: auto;
        }
        
        #categoryReportDropdownMenu .dropdown-item {
            color: #333 !important;
            background-color: #fff !important;
            transition: all 0.2s ease;
        }
        
        #categoryReportDropdownMenu .dropdown-item:hover {
            background-color: #f8f9fa !important;
            color: #333 !important;
        }
        
        #categoryReportDropdownMenu .dropdown-item.active {
            background-color: #007bff !important;
            color: #fff !important;
        }
        
        #categoryReportDropdownMenu .dropdown-item.active:hover {
            background-color: #0056b3 !important;
            color: #fff !important;
        }
        
        /* ========================================
           TABLE STYLES
           ======================================== */
        
        /* Table Styles */
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table thead th {
            background-color: var(--light-bg);
            border-bottom: 2px solid var(--primary-color);
            font-weight: 600;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* Filter Section */
        .filter-section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        /* ========================================
           FORM STYLES
           ======================================== */
        
        /* Form Styles */
        .form-control, .form-select {
            border-radius: 5px;
            border: 1px solid #ced4da;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(44, 110, 138, 0.25);
        }
        
        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
        }
        
        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 998;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }
        
        /* Mobile overlay improvements */
        @media (max-width: 767px) {
            .sidebar-overlay {
                background: rgba(0, 0, 0, 0.7);
            }
        }
        
        /* Content Sections */
        .content-section {
            display: none !important;
            /* No margin-left needed - main-content container handles sidebar spacing */
            margin-left: 0 !important;
            margin-top: 0 !important;
            padding-top: 0 !important;
            padding-left: 0;
            padding-right: 0;
        }
        
        .content-section.active {
            display: block !important;
            /* No margin-left needed - main-content container handles sidebar spacing */
            margin-left: 0 !important;
            margin-top: 0 !important;
            padding-top: 0 !important;
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 20px;
        }
        
        /* Specific sections: Absolutely no top spacing */
        #payment-vouchers-section.active,
        #payment-voucher-list-section.active,
        #payment-reports-section.active,
        #payment-dashboard-section.active,
        #reports-section.active,
        #branches-section.active,
        #groups-section.active,
        #users-section.active,
        #settings-section.active {
            padding-top: 0 !important;
            margin-top: 0 !important;
        }

        /* On small screens, content should start at the left edge (sidebar hidden) */
        @media (max-width: 768px) {
            .content-section,
            .content-section.active {
                margin-left: 0 !important;
            }
        }
        
        /* Ensure first element in content-section has proper spacing */
        .content-section > *:first-child,
        .content-section.active > *:first-child {
            margin-top: 0 !important;
            padding-top: 20px !important; /* Add spacing from navbar */
        }
        
        /* Ensure dashboard-header in content-section has proper spacing */
        .content-section .dashboard-header:first-child,
        .content-section.active .dashboard-header:first-child {
            margin-top: 0 !important;
            padding-top: 20px !important; /* Add spacing from navbar */
        }
        
        /* CRITICAL: Ensure all child elements in active content sections are visible */
        .content-section.active .card,
        .content-section.active .card-body,
        .content-section.active form,
        .content-section.active .dashboard-header {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Hide print buttons outside reports section */
        .content-section:not(#reports-section) .btn-success,
        .content-section:not(#reports-section) #printSalesReportBtn,
        .content-section:not(#reports-section) #printComparisonReportBtn,
        .content-section:not(#reports-section) #printDatewiseReportBtn,
        #users-section .btn-success,
        #groups-section .btn-success,
        #users-section #printSalesReportBtn,
        #users-section #printComparisonReportBtn,
        #users-section #printDatewiseReportBtn,
        #groups-section #printSalesReportBtn,
        #groups-section #printComparisonReportBtn,
        #groups-section #printDatewiseReportBtn {
            display: none !important;
        }
        
        /* Dashboard Tabs */
        .dashboard-tabs {
            background: white;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .dashboard-tabs .nav-tabs {
            border-bottom: none;
        }
        
        .dashboard-tabs .nav-tabs .nav-link {
            color: var(--dark-text);
            border: none;
            border-radius: 5px;
            margin-right: 5px;
            padding: 8px 15px;
        }
        
        .dashboard-tabs .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Sales Comparison Card */
        .sales-comparison-card {
            border-left: 4px solid var(--accent-color);
        }
        
        /* ========================================
           RESPONSIVE STYLES
           ======================================== */
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 0 !important; /* No horizontal padding */
                padding-top: 60px !important; /* Add top padding for navbar */
            }
            
            .sidebar-overlay.active {
                display: block;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .metric-value {
                font-size: 1.2rem;
            }
            
            .category-card {
                margin-bottom: 20px;
            }
            
            /* Responsive Tabs */
            .dashboard-tabs .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .dashboard-tabs .nav-tabs .nav-link {
                padding: 8px 10px;
                font-size: 0.875rem;
            }
            
            /* Responsive Tables */
            .table-responsive-stack {
                display: block;
            }
            
            .table-responsive-stack thead {
                display: none;
            }
            
            .table-responsive-stack, .table-responsive-stack tbody, .table-responsive-stack tr, .table-responsive-stack td {
                display: block;
                width: 100%;
            }
            
            .table-responsive-stack tr {
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: 5px;
                padding: 10px;
            }
            
            .table-responsive-stack td {
                text-align: right;
                padding-left: 50%;
                position: relative;
                border: none;
                border-bottom: 1px solid #eee;
            }
            
            .table-responsive-stack td:before {
                content: attr(data-label);
                position: absolute;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                height: 100%;
                font-weight: bold;
                text-align: left;
            }
            
            /* Responsive Cards */
            .card {
                margin-bottom: 15px;
            }
            
            /* Responsive Buttons */
            .btn-group {
                flex-direction: column;
            }
            
            .btn-group .btn {
                border-radius: 5px;
                margin-bottom: 5px;
            }
        }
        
        /* Enhanced Mobile Responsive Styles */
        @media (max-width: 576px) {
            /* Mobile Navigation */
            .navbar-brand {
                font-size: 1.1rem;
            }
            
            /* Very small screens */
            .company-name {
                font-size: 0.8rem;
            }
            
            .mobile-menu-toggle {
                padding: 8px 12px;
                font-size: 1.2rem;
            }
            
            /* Main Content */
            .main-content {
                padding: 0 !important; /* No horizontal padding */
                padding-top: 60px !important; /* Add top padding for navbar */
            }
            
            /* Dashboard Header */
            .dashboard-header {
                text-align: center;
                margin-bottom: 20px;
            }
            
            .dashboard-title {
                font-size: 1.5rem;
                margin-bottom: 5px;
            }
            
            .dashboard-subtitle {
                font-size: 0.9rem;
            }
            
            /* Filter Sections */
            .filter-section {
                padding: 15px 10px;
            }
            
            .filter-section .row {
                margin: 0;
            }
            
            .filter-section .col-md-3,
            .filter-section .col-md-4 {
                margin-bottom: 15px;
            }
            
            .filter-section .form-label {
                font-size: 0.9rem;
                margin-bottom: 5px;
            }
            
            .filter-section .form-control,
            .filter-section .form-select {
                font-size: 0.9rem;
                padding: 8px 12px;
            }
            
            .filter-section .btn {
                font-size: 0.9rem;
                padding: 8px 16px;
            }
            
            /* Enhanced horizontal scrolling for smaller screens */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table-responsive table {
                min-width: 550px;
                font-size: 0.85rem;
            }
            
            /* Ensure card containers scroll properly */
            .row.card-grid,
            #salesInvoicesContainer,
            #usersContainer {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .row.card-grid > [class*="col-"],
            #salesInvoicesContainer > [class*="col-"],
            #usersContainer > [class*="col-"] {
                min-width: 260px;
                flex-shrink: 0;
            }
            
            /* Cards */
            .card {
                margin-bottom: 15px;
                border-radius: 8px;
            }
            
            .card-header {
                padding: 12px 15px;
            }
            
            .card-body {
                padding: 15px;
            }
            
            .card-title {
                font-size: 1.1rem;
            }
            
            /* Metrics Cards */
            .metric-card {
                margin-bottom: 15px;
            }
            
            .metric-value {
                font-size: 1.1rem;
            }
            
            .metric-label {
                font-size: 0.8rem;
            }
            
            /* Chart Container - Enhanced for Mobile */
            .chart-container {
                height: 200px;
                margin: 10px 0;
                position: relative;
                overflow: hidden;
            }
            
            /* Tables */
            .table-responsive {
                border-radius: 8px;
                overflow: hidden;
            }
            
            .table {
                font-size: 0.8rem;
            }
            
            .table th,
            .table td {
                padding: 8px 6px;
                vertical-align: middle;
            }
            
            /* Buttons */
            .btn {
                font-size: 0.85rem;
                padding: 6px 12px;
                margin-bottom: 5px;
            }
            
            .btn-sm {
                font-size: 0.75rem;
                padding: 4px 8px;
            }
            
            /* Button Groups */
            .btn-group {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .btn {
                margin-bottom: 5px;
                border-radius: 4px !important;
            }
            
            /* Dropdowns */
            .dropdown-menu {
                font-size: 0.85rem;
            }
            
            /* Modals */
            .modal-dialog {
                margin: 10px;
                max-width: calc(100% - 20px);
            }
            
            .modal-header {
                padding: 12px 15px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .modal-footer {
                padding: 10px 15px;
            }
            
            /* Forms */
            .form-label {
                font-size: 0.9rem;
                margin-bottom: 5px;
            }
            
            .form-control,
            .form-select {
                font-size: 0.9rem;
                padding: 8px 12px;
            }
            
            .form-check-label {
                font-size: 0.85rem;
            }
            
            /* Alerts and Notifications */
            .alert {
                font-size: 0.85rem;
                padding: 10px 15px;
            }
            
            /* Pagination */
            .pagination {
                font-size: 0.8rem;
            }
            
            .page-link {
                padding: 6px 10px;
            }
            
            /* Category-wise Branch Comparison */
            .category-comparison-section {
                margin-bottom: 20px;
            }
            
            .category-comparison-section h4 {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }
            
            .stat-card {
                margin-bottom: 10px;
            }
            
            .stat-card .card-body {
                padding: 10px;
            }
            
            .category-value {
                font-size: 1rem;
            }
            
            .category-label {
                font-size: 0.75rem;
            }
            
            /* Print Options Dropdown */
            .dropdown-menu {
                max-height: 300px;
                overflow-y: auto;
            }
            
            /* Section Titles */
            .section-title {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }
            
            /* Dashboard Tabs */
            .dashboard-tabs .nav-tabs {
                border-bottom: 2px solid #dee2e6;
            }
            
            .dashboard-tabs .nav-tabs .nav-link {
                padding: 10px 8px;
                font-size: 0.8rem;
                white-space: nowrap;
            }
            
            /* Branch Summary Cards */
            .branch-summary-card {
                margin-bottom: 15px;
            }
            
            .branch-summary-card .card-body {
                padding: 12px;
            }
            
            /* Sales Entry Form */
            .sales-entry-form .row {
                margin: 0;
            }
            
            .sales-entry-form .col-md-6 {
                margin-bottom: 15px;
            }
            
            /* Notifications */
            .notification {
                font-size: 0.85rem;
                padding: 10px 15px;
                margin: 5px 10px;
            }
        }
        
        /* Extra Small Mobile Devices */
        @media (max-width: 375px) {
            .main-content {
                padding: 0 !important; /* No horizontal padding */
                padding-top: 60px !important; /* Add top padding for navbar */
            }
            
            .filter-section {
                padding: 10px 5px;
            }
            
            .card-body {
                padding: 10px;
            }
            
            .chart-container {
                height: 180px;
            }
            
            /* Enhanced scrolling for very small screens */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table-responsive table {
                min-width: 500px;
                font-size: 0.75rem;
            }
            
            /* Card containers for smallest screens */
            #salesInvoicesContainer > [class*="col-"],
            #usersContainer > [class*="col-"] {
                min-width: 240px !important;
            }
            
            .table {
                font-size: 0.75rem;
            }
            
            .btn {
                font-size: 0.8rem;
                padding: 5px 10px;
            }
            
            .modal-dialog {
                margin: 5px;
                max-width: calc(100% - 10px);
            }
            
            /* Extra small devices - Category-wise Performance */
            .category-header-card h2 {
                font-size: 1.1rem !important;
            }
            
            .category-header-card .p-4 {
                padding: 15px !important;
            }
            
            .summary-card .card-body {
                padding: 12px 8px !important;
            }
            
            .summary-label {
                font-size: 0.75rem !important;
            }
            
            .summary-value {
                font-size: 1.1rem !important;
            }
            
            .table {
                font-size: 0.7rem !important;
            }
            
            .table th, .table td {
                padding: 6px 3px !important;
            }
        }
        
        /* Custom Scrollbar Styling for Better UX */
        @media (max-width: 768px) {
            /* Webkit Scrollbar Styling */
            .table-responsive::-webkit-scrollbar,
            .modal-content::-webkit-scrollbar,
            .row.card-grid::-webkit-scrollbar,
            #salesInvoicesContainer::-webkit-scrollbar,
            #usersContainer::-webkit-scrollbar {
                height: 8px;
            }
            
            .table-responsive::-webkit-scrollbar-track,
            .modal-content::-webkit-scrollbar-track,
            .row.card-grid::-webkit-scrollbar-track,
            #salesInvoicesContainer::-webkit-scrollbar-track,
            #usersContainer::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }
            
            .table-responsive::-webkit-scrollbar-thumb,
            .modal-content::-webkit-scrollbar-thumb,
            .row.card-grid::-webkit-scrollbar-thumb,
            #salesInvoicesContainer::-webkit-scrollbar-thumb,
            #usersContainer::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 10px;
            }
            
            .table-responsive::-webkit-scrollbar-thumb:hover,
            .modal-content::-webkit-scrollbar-thumb:hover,
            .row.card-grid::-webkit-scrollbar-thumb:hover,
            #salesInvoicesContainer::-webkit-scrollbar-thumb:hover,
            #usersContainer::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            
            /* Firefox Scrollbar Styling */
            .table-responsive,
            .modal-content,
            .row.card-grid,
            #salesInvoicesContainer,
            #usersContainer {
                scrollbar-width: thin;
                scrollbar-color: #888 #f1f1f1;
            }
        }
        
        /* Landscape Mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .chart-container {
                height: 200px;
            }
            
            .main-content {
                padding: 0 !important; /* No horizontal padding */
                padding-top: 60px !important; /* Add top padding for navbar */
            }
        }
        
        /* ========================================
           PAYMENT MODULE RESPONSIVE STYLES
           ======================================== */
        
        /* Payment Module - Tablet and Mobile */
        @media (max-width: 768px) {
            /* Payment Dashboard Cards - Stack on mobile */
            #payment-dashboard-section .row.mb-4 > div[class*="col-md-3"] {
                margin-bottom: 15px;
            }
            
            #payment-dashboard-section .card {
                margin-bottom: 15px;
            }
            
            /* Payment Vouchers Form - Stack fields */
            #payment-vouchers-section .row > div[class*="col-md-"] {
                margin-bottom: 15px;
            }
            
            /* Payment Voucher List - Make table scrollable */
            #payment-voucher-list-section .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Payment Voucher List - Ensure tabs are visible on mobile */
            #payment-voucher-list-section {
                padding-top: 50px !important;
            }
            
            #payment-voucher-list-section .dashboard-header {
                margin-top: 0 !important;
                padding-top: 0 !important;
            }
            
            #payment-voucher-list-section #voucherListTabs {
                margin-top: 10px !important;
                position: relative !important;
                z-index: 1 !important;
                visibility: visible !important;
                display: flex !important;
            }
            
            /* Payment Reports - Stack chart and summary */
            #payment-reports-section .row > div[class*="col-md-"] {
                margin-bottom: 20px;
            }
            
            /* Filter sections - Stack on mobile */
            #payment-dashboard-section .filter-section .row > div[class*="col-md-"],
            #payment-voucher-list-section .filter-section .row > div[class*="col-md-"],
            #payment-reports-section .filter-section .row > div[class*="col-md-"] {
                margin-bottom: 15px;
            }
            
            /* Payment Dashboard Filters - Ensure proper stacking on mobile/tablet */
            #payment-dashboard-section .filter-section .row > div[class*="col-"] {
                flex: 0 0 100%;
                max-width: 100%;
                margin-bottom: 15px;
            }
            
            @media (min-width: 768px) {
                #payment-dashboard-section .filter-section .row > div.col-md-4 {
                    flex: 0 0 33.333333%;
                    max-width: 33.333333%;
                    margin-bottom: 0;
                }
            }
            
            /* Payment Voucher List - Fix date inputs on mobile */
            #payment-voucher-list-section .filter-section .col-md-3 {
                flex: 0 0 100%;
                max-width: 100%;
                margin-bottom: 15px;
            }
            
            /* Date range filter container - full width on mobile */
            #payment-voucher-list-section .filter-section .col-md-3 {
                overflow: hidden;
            }
            
            /* Date range filter - keep in row on desktop, stack on mobile */
            #payment-voucher-list-section .filter-section .d-flex.gap-1 {
                flex-wrap: wrap;
            }
            
            @media (min-width: 768px) {
                #payment-voucher-list-section .filter-section .d-flex.gap-1 {
                    flex-wrap: nowrap;
                }
            }
            
            @media (max-width: 767px) {
                #payment-voucher-list-section .filter-section .d-flex.gap-1 {
                    flex-direction: column;
                    gap: 8px !important;
                }
                
                #payment-voucher-list-section .filter-section .d-flex.gap-1 > div {
                    width: 100% !important;
                    min-width: 100% !important;
                }
            }
            
            #payment-voucher-list-section .filter-section .d-flex.gap-1 input[type="date"] {
                width: 100% !important;
                max-width: 100% !important;
                min-width: 0 !important;
                flex: 1 1 auto;
                box-sizing: border-box;
            }
            
            #payment-voucher-list-section .form-control,
            #payment-voucher-list-section .form-select {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* Fix date column in table to prevent overflow */
            /* Supplier vouchers: Date is 3rd column (after checkbox, voucher #) */
            #payment-voucher-list-section #supplier-voucher-list-content table thead th:nth-child(3),
            #payment-voucher-list-section #supplier-voucher-list-content table tbody td:nth-child(3) {
                min-width: 100px;
                white-space: nowrap;
            }
            
            #payment-voucher-list-section #supplier-voucher-list-content table tbody td:nth-child(3) {
                font-size: 0.9em;
            }
            
            /* Category vouchers: Date is 2nd column (after voucher #) */
            #payment-voucher-list-section #category-voucher-list-content table thead th:nth-child(2),
            #payment-voucher-list-section #category-voucher-list-content table tbody td:nth-child(2) {
                min-width: 100px;
                white-space: nowrap;
                font-size: 0.9em;
            }
            
            /* Payment Dashboard Charts - Full width on mobile */
            #payment-dashboard-section .row.mb-4 .col-md-8,
            #payment-dashboard-section .row.mb-4 .col-md-4 {
                width: 100%;
                margin-bottom: 20px;
            }
            
            /* Chart containers - Smaller height on mobile */
            #payment-dashboard-section .chart-container,
            #payment-reports-section .chart-container {
                height: 250px !important;
            }
        }
        
        /* Payment Module - Small Mobile */
        @media (max-width: 576px) {
            /* Payment Dashboard Stats - Single column */
            #payment-dashboard-section .row.mb-4 {
                margin-bottom: 15px !important;
            }
            
            #payment-dashboard-section .row.mb-4 > div {
                width: 100%;
                margin-bottom: 15px;
            }
            
            /* Payment Dashboard Filters - Ensure full width stacking on small mobile */
            #payment-dashboard-section .filter-section .row > div {
                flex: 0 0 100% !important;
                max-width: 100% !important;
                width: 100% !important;
                margin-bottom: 15px;
            }
            
            /* Payment Details Filters - Ensure full width stacking on small mobile */
            .dashboard-payment-filters {
                flex-direction: column !important;
            }
            
            .dashboard-payment-filters .form-select,
            .dashboard-payment-filters .form-control,
            .dashboard-payment-filters #refreshPaymentDetailsBtn {
                width: 100% !important;
                min-width: 100% !important;
                max-width: 100% !important;
                flex: 1 1 100% !important;
            }
            
            /* Payment Vouchers Form - Full width inputs */
            #payment-vouchers-section .form-control,
            #payment-vouchers-section .form-select {
                font-size: 14px;
                padding: 10px;
            }
            
            /* Payment Voucher List - Compact table */
            #payment-voucher-list-section table {
                font-size: 12px;
            }
            
            #payment-voucher-list-section table th,
            #payment-voucher-list-section table td {
                padding: 8px 5px;
            }
            
            /* Payment Voucher List - Ensure tabs are visible on small mobile */
            #payment-voucher-list-section {
                padding-top: 50px !important;
            }
            
            #payment-voucher-list-section #voucherListTabs {
                margin-top: 10px !important;
                position: relative !important;
                z-index: 1 !important;
                visibility: visible !important;
                display: flex !important;
                width: 100% !important;
            }
            
            #payment-voucher-list-section #voucherListTabs .nav-link {
                font-size: 0.9rem;
                padding: 0.5rem 0.75rem;
            }
            
            /* Payment Voucher List - Filter section fixes */
            #payment-voucher-list-section .filter-section .col-md-3 {
                flex: 0 0 100%;
                max-width: 100%;
                margin-bottom: 15px;
                overflow: hidden;
            }
            
            /* Date range filter on small mobile - stack vertically */
            #payment-voucher-list-section .filter-section .d-flex.gap-1 {
                flex-direction: column;
                gap: 8px !important;
                width: 100%;
                max-width: 100%;
            }
            
            #payment-voucher-list-section .filter-section .d-flex.gap-1 > div {
                width: 100% !important;
                min-width: 100% !important;
            }
            
            #payment-voucher-list-section .filter-section .d-flex.gap-1 input[type="date"] {
                width: 100% !important;
                max-width: 100% !important;
                min-width: 0 !important;
                flex: 1 1 auto;
                box-sizing: border-box;
            }
            
            #payment-voucher-list-section .form-control,
            #payment-voucher-list-section .form-select {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* Fix date column in table for small screens */
            /* Supplier vouchers: Date is 3rd column (after checkbox, voucher #) */
            #payment-voucher-list-section #paymentVoucherListTable th:nth-child(3),
            #payment-voucher-list-section #paymentVoucherListTable td:nth-child(3) {
                min-width: 90px;
                white-space: nowrap;
                font-size: 0.85em;
            }
            
            /* Category vouchers: Date is 2nd column (after voucher #) */
            #payment-voucher-list-section #categoryVoucherListTableBody th:nth-child(2),
            #payment-voucher-list-section #categoryVoucherListTableBody td:nth-child(2) {
                min-width: 90px;
                white-space: nowrap;
                font-size: 0.85em;
            }
            
            /* Button groups - Stack on mobile */
            #payment-voucher-list-section .d-flex.justify-content-between {
                flex-direction: column;
                gap: 10px;
            }
            
            #payment-voucher-list-section .d-flex.justify-content-between > div {
                width: 100%;
                margin-bottom: 10px;
            }
            
            #payment-voucher-list-section .d-flex.justify-content-between .btn {
                width: 100%;
                margin: 5px 0 !important;
            }
            
            /* Payment Reports - Compact layout */
            #payment-reports-section .card-body {
                padding: 15px;
            }
        }
        
        /* Additional Mobile Enhancements */
        @media (max-width: 768px) {
            /* Make all tables horizontally scrollable on mobile */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                position: relative;
            }
            
            /* Ensure tables don't get squished - maintain minimum width */
            .table-responsive table {
                min-width: 600px;
                width: 100%;
            }
            
            /* Scrollable card containers for horizontal scrolling */
            .row.card-grid,
            #salesInvoicesContainer {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                display: flex;
                flex-wrap: nowrap;
            }
            
            .row.card-grid > [class*="col-"],
            #salesInvoicesContainer > [class*="col-"] {
                flex-shrink: 0;
                min-width: 280px;
            }
            
            /* Users and Groups should stack vertically on mobile */
            #usersContainer,
            #branchesContainer,
            #categoriesContainer,
            #groupsContainer {
                overflow-x: visible;
                display: block;
                flex-wrap: wrap;
            }
            
            #usersContainer > [class*="col-"],
            #branchesContainer > [class*="col-"],
            #categoriesContainer > [class*="col-"],
            #groupsContainer > [class*="col-"] {
                flex-shrink: 1;
                min-width: auto;
            }
            
            /* Improve form layouts on mobile */
            .row.g-3 > [class*="col-"] {
                margin-bottom: 15px;
            }
            
            /* Better spacing for filter sections */
            .filter-section .row {
                margin-left: -5px;
                margin-right: -5px;
            }
            
            .filter-section .row > [class*="col-"] {
                padding-left: 5px;
                padding-right: 5px;
            }
            
            /* Improve modal responsiveness */
            .modal-dialog {
                max-height: 90vh;
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            .modal-content {
                overflow-x: auto;
            }
            
            /* Better button spacing */
            .btn-group-vertical .btn {
                margin-bottom: 5px;
            }
            
            /* Improve dropdown menus on mobile */
            .dropdown-menu {
                max-width: 100%;
                white-space: nowrap;
                overflow-x: auto;
            }
            
            /* Better card layouts */
            .card-deck {
                display: block;
            }
            
            .card-deck .card {
                margin-bottom: 15px;
            }
            
            /* Improve navigation */
            .navbar-nav .nav-link {
                padding: 10px 15px;
            }
            
            /* Better sidebar on mobile */
            .sidebar {
                width: 280px;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            
            .sidebar .nav-link {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
            
            /* Improve category-wise comparison on mobile */
            .category-comparison-section .row {
                margin: 0;
            }
            
            .category-comparison-section .col-md-3 {
                margin-bottom: 10px;
            }
            
            /* Better stat cards on mobile */
            .stat-card .card-body {
                text-align: center;
            }
            
            /* Category-wise Branch Performance Report - Mobile Responsive */
            .category-header-card h2 {
                font-size: 1.3rem !important;
            }
            
            .category-header-card .opacity-75 {
                font-size: 0.8rem;
            }
            
            .summary-card {
                margin-bottom: 15px !important;
            }
            
            .summary-card .card-body {
                padding: 15px 10px !important;
            }
            
            .summary-label {
                font-size: 0.85rem !important;
                margin-bottom: 8px !important;
            }
            
            .summary-value {
                font-size: 1.3rem !important;
            }
            
            /* Branch Performance Table - Mobile */
            .table {
                font-size: 0.8rem;
            }
            
            .table td {
                padding: 8px 4px;
            }
            
            .table th {
                padding: 8px 4px;
                font-size: 0.85rem;
            }
            
            /* Badge sizing on mobile */
            .badge {
                font-size: 0.75rem;
                padding: 4px 8px;
            }
            
            .category-value {
                font-weight: bold;
                margin-bottom: 5px;
            }
            
            .category-label {
                color: #6c757d;
                font-size: 0.8rem;
            }
        }
        
        /* Mobile print button styles */
        @media (max-width: 768px) {
            .no-print .btn-group {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 5px;
                justify-content: center;
            }
            
            .no-print .btn-group .btn {
                flex: 1;
                min-width: 80px;
                margin-bottom: 0;
                font-size: 12px;
                padding: 6px 8px;
            }
            
            /* Mobile report buttons */
            .card-title {
                font-size: 1.1rem;
                margin-bottom: 10px;
            }
            
            /* Users and Groups section button containers - responsive */
            #users-section .d-flex.justify-content-between,
            #groups-section .d-flex.justify-content-between {
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }
            
            #users-section .d-flex.justify-content-between h2,
            #groups-section .d-flex.justify-content-between h2 {
                font-size: 1.1rem;
            }
            
            #users-section .d-flex.gap-2 {
                flex-shrink: 0;
                min-width: auto;
                white-space: nowrap;
                overflow: visible;
                flex-wrap: wrap;
            }
            
            #users-section .btn {
                white-space: nowrap;
                overflow: visible;
                flex-shrink: 0;
            }
            
            #users-section #promoteUserBtn,
            #users-section #addUserBtn,
            #groups-section #addGroupBtn {
                font-size: 0.875rem;
                padding: 6px 12px;
            }
            
            #groups-section .btn {
                white-space: nowrap;
                overflow: visible;
            }
            
            /* Fix reports, users, and groups section responsiveness */
            #reports-section .d-flex.justify-content-between,
            #users-section .d-flex.justify-content-between,
            #groups-section .d-flex.justify-content-between {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            #reports-section .d-flex.justify-content-between .btn,
            #users-section .d-flex.justify-content-between .btn,
            #groups-section .d-flex.justify-content-between .btn {
                flex-shrink: 0;
            }
            
            /* Responsive print buttons in reports section */
            #reports-section .btn-success {
                font-size: 0.875rem;
                padding: 6px 12px;
                white-space: nowrap;
            }
            
            /* Mobile responsive for all sections */
            #reports-section .card-header .d-flex,
            #users-section .dashboard-header + div .d-flex,
            #groups-section .dashboard-header + div .d-flex {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            #reports-section .card-header .btn,
            #users-section .btn-primary,
            #users-section .btn-warning,
            /* Groups Section Two-Panel Layout */
        .groups-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .groups-left-panel {
            flex: 1;
            min-width: 0;
        }
        
        .groups-right-panel {
            flex: 1;
            min-width: 0;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        .group-form-container {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .group-form-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .group-form-row .form-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        
        .group-form-row .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }
        
        .group-form-row .form-group input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .groups-table {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .groups-table thead {
            background: #f8f9fa;
        }
        
        .groups-table thead th {
            padding: 12px 15px;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            font-size: 14px;
        }
        
        .groups-table tbody td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            font-size: 14px;
            color: #212529;
        }
        
        .groups-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .groups-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .group-access-title {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .permissions-checklist {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .permission-item {
            padding: 8px 0;
        }
        
        .permission-item.nested {
            padding-left: 25px;
        }
        
        .permission-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            color: #495057;
            user-select: none;
        }
        
        .permission-label:hover {
            color: #212529;
        }
        
        .permission-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #0d6efd;
        }
        
        /* Permission Categories (like sidebar sections) */
        .permission-category {
            margin-bottom: 8px;
        }
        
        .permission-category-header {
            padding: 8px 12px;
            color: #888888;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: color 0.2s;
            user-select: none;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 4px;
        }
        
        .permission-category-header:hover {
            color: #212529;
        }
        
        .permission-category-header[aria-expanded="true"] {
            color: #212529;
        }
        
        .permission-category-header[aria-expanded="true"] .permission-chevron {
            transform: rotate(180deg);
        }
        
        .permission-chevron {
            font-size: 10px;
            transition: transform 0.3s ease;
            color: #888888;
        }
        
        .permission-category-header:hover .permission-chevron,
        .permission-category-header[aria-expanded="true"] .permission-chevron {
            color: #212529;
        }
        
        .permission-category .collapse {
            padding-left: 12px;
        }
        
        /* Responsive Design */
        @media (max-width: 992px) {
            .groups-container {
                flex-direction: column;
            }
            
            .groups-right-panel {
                max-height: 400px;
            }
        }
        
        #groups-section .btn-primary {
                min-width: auto;
                flex-shrink: 1;
            }
        }
        
        /* ========================================
           DASHBOARD STYLES
           ======================================== */
        
        /* Dashboard Header */
        .dashboard-header {
            margin-top: 0; /* No top margin */
            margin-bottom: 20px;
        }
        
        .dashboard-title {
            font-weight: 700;
            font-size: 1.8rem;
            color: var(--dark-text);
            margin-top: 0; /* No top margin */
            margin-bottom: 10px;
        }
        
        .dashboard-subtitle {
            color: #6c757d;
            font-size: 1rem;
        }
        
        /* Section Title */
        .section-title {
            font-weight: 600;
            font-size: 1.3rem;
            color: var(--dark-text);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 60px;
            right: 15px;
            padding: 15px 20px;
            border-radius: 5px;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            display: none;
            animation: slideIn 0.3s ease-out;
            max-width: 90%;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification.success {
            border-left: 4px solid var(--success-color);
        }
        
        .notification.error {
            border-left: 4px solid var(--danger-color);
        }
        
        .notification.info {
            border-left: 4px solid var(--info-color);
        }
        
        /* Permission Denied Banner */
        .permission-denied {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .permission-denied i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        /* Pagination */
        .pagination {
            justify-content: center;
            margin-top: 20px;
        }
        
        .page-link {
            color: var(--primary-color);
            border-radius: 5px;
            margin: 0 2px;
        }
        
        .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        /* Category Input Group */
        .category-input-group {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .category-input-group label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: block;
        }
        
        .category-input-group .input-group {
            margin-bottom: 10px;
        }
        
        .category-input-group .input-group-text {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }
        
        /* Branch Card Styles */
        .branch-card {
            border-left: 4px solid var(--secondary-color);
            height: 100%;
        }
        
        .branch-card .branch-name {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        
        .branch-card .branch-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .branch-card .branch-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* Stat Card Styles */
        .stat-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: none;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .category-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .category-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* Sales List Styles - Updated */
        .sales-list-card {
            border-left: 4px solid var(--info-color);
        }
        
        .sales-list-actions {
            display: flex;
            gap: 5px;
        }
        
        .sales-list-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        /* Full Page List Styles */
        #salesListSection.full-page,
        #deptSalesListSection.full-page {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: #f8f9fa !important;
            z-index: 1050 !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            padding: 20px !important;
            -webkit-overflow-scrolling: touch;
            transform: translateZ(0) !important;
            -webkit-transform: translateZ(0) !important;
            will-change: scroll-position;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 100% !important;
            max-width: 100vw !important;
        }
        
        #salesListSection.full-page .card,
        #deptSalesListSection.full-page .card {
            margin-bottom: 20px;
        }
        
        /* Prevent layout shifts in full-page lists */
        #salesListSection.full-page .row,
        #deptSalesListSection.full-page .row {
            contain: layout style paint;
        }
        
        #salesListSection.full-page .col-md-6,
        #salesListSection.full-page .col-lg-4,
        #deptSalesListSection.full-page .col-md-6,
        #deptSalesListSection.full-page .col-lg-4 {
            will-change: transform;
            backface-visibility: hidden;
        }
        
        /* Hide sidebar and navbar when full-page list is active */
        #salesListSection.full-page ~ * .sidebar,
        #deptSalesListSection.full-page ~ * .sidebar,
        body:has(#salesListSection.full-page) .sidebar,
        body:has(#deptSalesListSection.full-page) .sidebar {
            display: none !important;
        }
        
        #salesListSection.full-page ~ * .navbar,
        #deptSalesListSection.full-page ~ * .navbar,
        body:has(#salesListSection.full-page) .navbar,
        body:has(#deptSalesListSection.full-page) .navbar {
            display: none !important;
        }
        
        /* Alternative approach using JavaScript classes */
        .full-page-active .sidebar,
        .full-page-active .navbar {
            display: none !important;
        }
        
        /* Hide other content sections but keep the sales-section visible when lists are active */
        .full-page-active .content-section:not(#sales-section) {
            display: none !important;
        }
        
        /* Keep sales-section visible when either list is in full-page mode */
        .full-page-active #sales-section {
            display: block !important;
        }
        
        /* Hide other children of sales-section but keep the active list visible */
        .full-page-active #sales-section > *:not(#salesListSection):not(#deptSalesListSection) {
            display: none !important;
        }
        
        /* Override parent hiding for list sections - they break out with fixed positioning */
        .full-page-active #salesListSection.full-page,
        .full-page-active #deptSalesListSection.full-page {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: fixed !important;
        }
        
        .sales-entry-hidden {
            display: none !important;
        }
        
        /* Responsive fixes for sales list */
        @media (max-width: 768px) {
            #salesListSection.full-page,
            #deptSalesListSection.full-page {
                padding: 10px !important;
            }
            
            #salesListSection.full-page .card,
            #deptSalesListSection.full-page .card {
                margin-bottom: 15px;
                border-radius: 8px;
            }
            
            #salesListSection.full-page .card-body,
            #deptSalesListSection.full-page .card-body {
                padding: 15px;
            }
            
            .invoice-card {
                margin-bottom: 15px;
            }
            
            .invoice-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .invoice-actions .btn {
                width: 100%;
            }
            
            /* Filter section mobile */
            #salesListSection .filter-section .row,
            #deptSalesListSection .filter-section .row {
                margin-left: -8px;
                margin-right: -8px;
            }
            
            #salesListSection .filter-section .row > [class*="col-"],
            #deptSalesListSection .filter-section .row > [class*="col-"] {
                padding-left: 8px;
                padding-right: 8px;
                margin-bottom: 12px;
            }
            
            /* Table responsive on mobile */
            #salesListSection .table-responsive,
            #deptSalesListSection .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                display: block;
                width: 100%;
            }
            
            #salesListSection .table-responsive table,
            #deptSalesListSection .table-responsive table {
                min-width: 600px;
            }
        }
        
        .invoice-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: none;
            margin-bottom: 15px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            will-change: transform, box-shadow;
            backface-visibility: hidden;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            max-width: 100%;
            overflow: hidden;
        }
        
        .invoice-card:hover {
            transform: translateY(-3px) translateZ(0);
            -webkit-transform: translateY(-3px) translateZ(0);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .invoice-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .invoice-body {
            padding: 15px;
        }
        
        .invoice-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .invoice-detail-label {
            font-weight: 500;
            color: #6c757d;
        }
        
        .invoice-detail-value {
            font-weight: 600;
        }
        
        .invoice-actions {
            display: flex;
            justify-content: flex-end;
            gap: 5px;
            margin-top: 10px;
        }
        
        /* ========================================
           PRINT STYLES (ADDITIONAL)
           ======================================== */
        
        /* Print Styles */
        @media print {
            .sidebar, .navbar, .mobile-menu-toggle, .btn, .pagination, .dashboard-tabs, .notification, .no-print {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0;
                padding: 0 !important;
            }
            
            .content-section {
                margin-left: 0 !important;
                padding: 0 !important;
                display: block !important;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
            
            /* Professional Print Styles for Payment Vouchers - Exact Match - Same as Sale Report */
            .professional-voucher,
            #paymentVoucherPrintPreview .professional-voucher,
            #paymentVoucherPrintPreview > div {
                max-width: 850px !important;
                margin: 0 auto !important;
                padding: 40px !important;
                background: #ffffff !important;
                border: 2px solid #000 !important;
                box-shadow: 0 0 20px rgba(0,0,0,0.1) !important;
                font-family: Arial, sans-serif !important;
                font-size: 12pt !important;
                page-break-inside: avoid;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Preserve all colors in print - matching sale report */
            #paymentVoucherPrintPreview *,
            #paymentVoucherPrintPreview div,
            #paymentVoucherPrintPreview table,
            #paymentVoucherPrintPreview td,
            #paymentVoucherPrintPreview th {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Ensure borders and backgrounds print */
            #paymentVoucherPrintPreview div[style*="background"],
            #paymentVoucherPrintPreview td[style*="background"],
            #paymentVoucherPrintPreview th[style*="background"],
            #paymentVoucherPrintPreview tr[style*="background"] {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Preserve table borders - matching sale report */
            #paymentVoucherPrintPreview table,
            #paymentVoucherPrintPreview td,
            #paymentVoucherPrintPreview th {
                border: 1px solid #333 !important;
                border-color: #333 !important;
            }
            
            /* Print table styles */
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            thead {
                display: table-header-group;
            }
            
            tfoot {
                display: table-footer-group;
            }
            
            .card-header {
                background: #f8f9fa !important;
                color: var(--dark-text) !important;
            }
        }
        
        /* Group and User Management Styles */
        .permission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .permission-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        
        .permission-item input {
            margin-right: 8px;
        }
        
        .branch-selector {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 10px;
        }
        
        .branch-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .branch-item input {
            margin-right: 8px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .user-details h5 {
            margin-bottom: 2px;
        }
        
        .user-details p {
            margin-bottom: 0;
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        /* ========================================
           COMPREHENSIVE RESPONSIVE DESIGN
           ======================================== */
        
        /* Mobile Menu Toggle Button */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 5px;
            left: 10px;
            z-index: 1000;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .mobile-menu-toggle:hover {
            background: var(--accent-color);
        }
        
        /* Large Screens (Desktops) - 1200px and above */
        @media (min-width: 1200px) {
            .voucher-container {
                max-width: 900px;
            }
            
            .dashboard-title {
                font-size: 2rem;
            }
            
            .card-body {
                padding: 25px;
            }
        }
        
        /* Medium Screens (Tablets/Laptops) - 768px to 1199px */
        @media (min-width: 768px) and (max-width: 1199px) {
            :root {
                --sidebar-width: 220px;
            }
            
            .main-content {
                margin-left: 220px;
            }
            
            .content-section.active {
                margin-left: 220px;
            }
            
            .dashboard-title {
                font-size: 1.6rem;
            }
            
            .card-body {
                padding: 20px;
            }
            
            .table-responsive {
                overflow-x: auto;
            }
            
            .voucher-container {
                max-width: 100%;
                padding: 15px;
            }
            
            /* Payment Voucher List - Fix date section on tablets */
            #payment-voucher-list-section .filter-section .row > [class*="col-md-"] {
                margin-bottom: 15px;
            }
            
            #payment-voucher-list-section .filter-section .col-md-3 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            /* Date Range - Stack on tablets if needed */
            #payment-voucher-list-section .filter-section .d-flex.gap-2 {
                flex-direction: column;
                gap: 10px !important;
            }
            
            #payment-voucher-list-section .filter-section .d-flex.gap-2 input {
                width: 100% !important;
            }
            
            /* Ensure inputs don't overflow */
            #payment-voucher-list-section .form-control,
            #payment-voucher-list-section .form-select {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* Button groups - Wrap on tablets */
            #payment-voucher-list-section .d-flex.justify-content-between {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            #payment-voucher-list-section .d-flex.justify-content-between .btn {
                flex: 1;
                min-width: 150px;
            }
        }
        
        /* Laptop Screens - 992px to 1199px - Specific fix for date inputs */
        @media (min-width: 992px) and (max-width: 1199px) {
            /* Payment Voucher List - Ensure all filter columns stack properly on laptops */
            #payment-voucher-list-section .filter-section .row > [class*="col-md-"] {
                flex: 0 0 50%;
                max-width: 50%;
                margin-bottom: 15px;
            }
            
            /* Date range column - Make it full width and stack dates vertically */
            /* Target the column that contains date inputs */
            #payment-voucher-list-section .filter-section .row > .col-md-3:last-child,
            #payment-voucher-list-section .filter-section .row > div:last-child {
                flex: 0 0 100% !important;
                max-width: 100% !important;
            }
            
            /* Date inputs - Stack vertically on laptops */
            #payment-voucher-list-section .filter-section .d-flex.gap-2 {
                flex-direction: column;
                gap: 10px !important;
            }
            
            #payment-voucher-list-section .filter-section .d-flex.gap-2 input {
                width: 100% !important;
                min-width: 100%;
                max-width: 100%;
            }
            
            /* Ensure all form controls fit properly */
            #payment-voucher-list-section .filter-section .form-control,
            #payment-voucher-list-section .filter-section .form-select {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
        }
        
        /* Small Screens (Tablets) - 576px to 767px */
        @media (min-width: 576px) and (max-width: 767px) {
            :root {
                --sidebar-width: 200px;
            }
            
            .sidebar {
                width: 200px;
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .content-section.active {
                margin-left: 0;
                padding-left: 15px;
                padding-right: 15px;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            .navbar-brand {
                margin-left: 50px;
            }
            
            .dashboard-title {
                font-size: 1.4rem;
            }
            
            .card-body {
                padding: 15px;
            }
            
            /* Stack form columns */
            .row > [class*="col-md-"] {
                margin-bottom: 15px;
            }
            
            /* Smaller table font */
            .table {
                font-size: 0.9rem;
            }
            
            .table th,
            .table td {
                padding: 8px 10px;
            }
            
            /* Payment Voucher List - Fix date section on small tablets */
            #payment-voucher-list-section .filter-section .col-md-3 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            #payment-voucher-list-section .filter-section .d-flex.gap-2 {
                flex-direction: column;
                gap: 10px !important;
            }
            
            #payment-voucher-list-section .filter-section .d-flex.gap-2 input {
                width: 100% !important;
            }
            
            #payment-voucher-list-section .form-control,
            #payment-voucher-list-section .form-select {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            #payment-voucher-list-section .d-flex.justify-content-between {
                flex-direction: column;
                gap: 10px;
            }
            
            #payment-voucher-list-section .d-flex.justify-content-between > div {
                width: 100%;
            }
            
            #payment-voucher-list-section .d-flex.justify-content-between .btn {
                width: 100%;
                margin: 5px 0 !important;
            }
        }
        
        /* Extra Small Screens (Mobile) - Below 576px */
        @media (max-width: 575px) {
            :root {
                --sidebar-width: 280px;
            }
            
            /* Mobile Menu Toggle */
            .mobile-menu-toggle {
                display: block;
            }
            
            /* Sidebar - Hidden by default on mobile */
            .sidebar {
                width: 280px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 999;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .sidebar-overlay.active {
                display: block;
            }
            
            /* Main Content - Full width on mobile */
            .main-content {
                margin-left: 0 !important;
            }
            
            .content-section,
            .content-section.active {
                margin-left: 0 !important;
                padding-left: 10px;
                padding-right: 10px;
                padding-bottom: 15px;
            }
            
            /* Navbar adjustments */
            .navbar {
                padding: 8px 15px;
            }
            
            .navbar-brand {
                margin-left: 45px;
                font-size: 0.9rem;
            }
            
            .navbar-logo {
                height: 35px;
                max-width: 150px;
            }
            
            .company-name {
                font-size: 0.8rem;
            }
            
            /* Dashboard Header */
            .dashboard-header {
                margin-bottom: 15px;
            }
            
            .dashboard-title {
                font-size: 1.3rem;
                margin-bottom: 8px;
            }
            
            .dashboard-subtitle {
                font-size: 0.9rem;
            }
            
            /* Cards */
            .card {
                margin-bottom: 15px;
            }
            
            .card-body {
                padding: 15px;
            }
            
            .card-header {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            /* Forms - Stack all columns */
            .row > [class*="col-"] {
                margin-bottom: 15px;
            }
            
            .form-control,
            .form-select {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 10px;
            }
            
            .form-label {
                font-size: 0.9rem;
                margin-bottom: 5px;
            }
            
            /* Buttons */
            .btn {
                padding: 8px 15px;
                font-size: 0.9rem;
                white-space: nowrap;
            }
            
            .btn-group {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .btn-group .btn {
                flex: 1;
                min-width: 80px;
            }
            
            /* Tables - Horizontal scroll */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border: 1px solid #dee2e6;
                border-radius: 8px;
            }
            
            .table {
                font-size: 0.85rem;
                min-width: 600px;
            }
            
            .table th,
            .table td {
                padding: 8px 6px;
                white-space: nowrap;
            }
            
            /* Table actions - Stack buttons */
            .table .btn {
                padding: 4px 8px;
                font-size: 0.8rem;
                margin: 2px;
            }
            
            /* Filter Sections */
            .filter-section {
                margin-bottom: 15px;
            }
            
            .filter-section .row {
                margin-left: -5px;
                margin-right: -5px;
            }
            
            .filter-section .row > [class*="col-"] {
                padding-left: 5px;
                padding-right: 5px;
                margin-bottom: 10px;
            }
            
            /* Stats Cards */
            .stat-card .card-body {
                padding: 15px;
            }
            
            .stat-card h3 {
                font-size: 1.5rem;
            }
            
            .stat-card h6 {
                font-size: 0.85rem;
            }
            
            /* KPI Cards */
            .branch-kpi-label,
            .branch-kpi-value {
                font-size: 0.8rem;
                padding: 6px 8px;
            }
            
            /* Payment Voucher List - Compact */
            #payment-voucher-list-section .table {
                font-size: 0.8rem;
            }
            
            #payment-voucher-list-section .table th,
            #payment-voucher-list-section .table td {
                padding: 6px 4px;
            }
            
            /* Payment Voucher List - Filter Section Responsive */
            #payment-voucher-list-section .filter-section .row > [class*="col-md-"] {
                margin-bottom: 15px;
            }
            
            /* Date Range - Stack vertically on mobile */
            #payment-voucher-list-section .filter-section .d-flex.gap-2 {
                flex-direction: column;
                gap: 10px !important;
            }
            
            #payment-voucher-list-section .filter-section .d-flex.gap-2 input {
                width: 100% !important;
            }
            
            /* Button groups in payment voucher list */
            #payment-voucher-list-section .d-flex.justify-content-between {
                flex-direction: column;
                gap: 10px;
            }
            
            #payment-voucher-list-section .d-flex.justify-content-between > div {
                width: 100%;
            }
            
            #payment-voucher-list-section .d-flex.justify-content-between .btn {
                width: 100%;
                margin: 5px 0 !important;
            }
            
            /* Ensure filter inputs don't overflow */
            #payment-voucher-list-section .form-control,
            #payment-voucher-list-section .form-select {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* Button Groups - Stack vertically */
            .d-flex.justify-content-between {
                flex-direction: column;
                gap: 10px;
            }
            
            .d-flex.justify-content-between > div {
                width: 100%;
            }
            
            .d-flex.justify-content-between .btn {
                width: 100%;
                margin: 0 !important;
            }
            
            /* Charts */
            .chart-container {
                height: 250px !important;
            }
            
            /* Modals */
            .modal-dialog {
                margin: 10px;
                max-width: calc(100% - 20px);
            }
            
            .modal-content {
                padding: 15px;
            }
            
            .modal-header {
                padding: 10px 15px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            /* Tabs */
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tabs .nav-link {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            .report-tab {
                font-size: 0.85rem;
                padding: 8px 12px;
            }
            
            /* Badges */
            .badge {
                font-size: 0.75rem;
                padding: 4px 8px;
            }
            
            /* Notifications */
            .notification {
                top: 50px;
                right: 10px;
                left: 10px;
                max-width: calc(100% - 20px);
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            /* Payment Voucher Print Preview - Responsive */
            .voucher-container {
                max-width: 100%;
                padding: 10px;
            }
            
            .header-band h1 {
                font-size: 22pt;
            }
            
            .branch-band .branch-name {
                font-size: 16pt;
            }
            
            .recipient-band .recipient-name {
                font-size: 14pt;
            }
            
            .details-table td {
                padding: 10px 12px;
                font-size: 13pt;
            }
            
            .paid-amount-value {
                font-size: 24pt;
            }
            
            /* Summary Cards - Stack */
            .row.mb-4 > [class*="col-"] {
                margin-bottom: 15px;
            }
            
            /* Dropdowns */
            .dropdown-menu {
                max-width: 100%;
                font-size: 0.9rem;
            }
            
            /* Input Groups */
            .input-group {
                flex-wrap: wrap;
            }
            
            .input-group-text {
                font-size: 0.9rem;
                padding: 8px 12px;
            }
            
            /* Pagination */
            .pagination {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .page-link {
                padding: 6px 10px;
                font-size: 0.85rem;
            }
            
            /* Permission Grid */
            .permission-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            /* User/Groups Cards */
            .user-info,
            .branch-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .user-avatar {
                margin-bottom: 10px;
                margin-right: 0;
            }
            
            /* Login Section */
            .login-card {
                padding: 20px;
                margin: 20px;
            }
            
            .login-logo {
                max-width: 150px;
            }
            
            /* Footer adjustments */
            .footer {
                padding: 15px 10px;
                font-size: 0.85rem;
            }
        }
        
        /* Landscape Mobile - 480px to 767px in landscape */
        @media (max-width: 767px) and (orientation: landscape) {
            .sidebar {
                width: 250px;
            }
            
            .chart-container {
                height: 200px !important;
            }
            
            .dashboard-header {
                margin-bottom: 10px;
            }
        }
        
        /* Very Small Screens - Below 360px */
        @media (max-width: 360px) {
            .dashboard-title {
                font-size: 1.1rem;
            }
            
            .card-body {
                padding: 10px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
            
            .table {
                font-size: 0.75rem;
            }
            
            .form-control,
            .form-select {
                font-size: 14px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- ========================================
         LOGIN SECTION
         ======================================== -->
    <div id="loginSection" class="login-section">
        <div class="login-card">
            <div class="login-header">
                <img src="logo.png" alt="D.Watson Pharmacy" class="login-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <h1 style="display:none;">D.Watson Pharmacy</h1>
                <p>Sales Dashboard</p>
            </div>
            <div class="login-body">
                <!-- Toggle Buttons -->
                <div class="auth-toggle mb-4">
                    <button type="button" class="toggle-btn active" id="loginToggle">Login</button>
                    <button type="button" class="toggle-btn d-none" id="signupToggle">Sign Up</button>
                </div>
                
                <!-- Hidden Admin Access Button (Secret) -->
                <div class="text-center mb-3">
                    <button type="button" class="btn btn-link text-muted" id="secretAccessBtn" style="font-size: 12px; opacity: 0.3;">
                        <i class="fas fa-key"></i>
                    </button>
                </div>
                
                <!-- Login Form -->
                <form id="loginForm" class="auth-form">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" placeholder="Enter username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" placeholder="Enter password" required>
                    </div>
                    <div id="loginError" class="alert alert-danger d-none"></div>
                    <button type="submit" class="login-btn">Login</button>
                </form>
                
                <!-- Signup Form -->
                <form id="signupForm" class="auth-form d-none">
                    <div class="mb-3">
                        <label for="signupUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="signupUsername" placeholder="Enter username" required>
                    </div>
                    <div class="mb-3">
                        <label for="signupFullName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="signupFullName" placeholder="Enter your full name" required>
                    </div>
                    <div class="mb-3">
                        <label for="signupEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="signupEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="mb-3">
                        <label for="signupPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="signupPassword" placeholder="Enter password" required>
                    </div>
                    <div class="mb-3">
                        <label for="signupConfirmPassword" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="signupConfirmPassword" placeholder="Confirm password" required>
                    </div>
                    <div class="mb-3">
                        <label for="adminPassword" class="form-label">Admin Access Code</label>
                        <input type="password" class="form-control" id="adminPassword" placeholder="Enter admin access code" required>
                        <small class="form-text text-muted">Required for account creation</small>
                    </div>
                    <div id="signupError" class="alert alert-danger d-none"></div>
                    <button type="submit" class="login-btn">Create Admin Account</button>
                </form>
            </div>
            <div class="login-footer">
                <p> Copyright D Watson. All Rights Reserved</p>
                <p>Designed by Bilal Shah</p>
            </div>
        </div>
    </div>
    
    <!-- ========================================
         MAIN APPLICATION SECTION
         ======================================== -->
    <div id="mainApp" class="main-app">
        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        
        <!-- Notification -->
        <div class="notification" id="notification">
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle me-2"></i>
                <span id="notification-message">Operation completed successfully!</span>
            </div>
        </div>
        
        <!-- ========================================
             NAVBAR SECTION
             ======================================== -->
        <nav class="navbar navbar-expand-lg navbar-dark no-print">
            <div class="container-fluid">
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <a class="navbar-brand" href="#dashboard" data-section="dashboard">
                    <img src="logo.png" alt="Haris Bakhtawari Warehouse" class="navbar-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <span class="navbar-text ms-2">
                        <span class="company-name">Haris Bakhtawari Warehouse</span>
                    </span>
                    <span class="d-none" style="display:none;">
                        <i class="fas fa-pills me-2"></i>Haris Bakhtawari Warehouse
                    </span>
                </a>
                <div class="ms-auto d-flex align-items-center">
                    <div class="user-menu-container">
                        <button class="btn btn-sm btn-outline-light" type="button" id="userDropdown">
                            <i class="fas fa-user-circle me-1"></i> <span id="currentUserDisplay">Admin</span>
                        </button>
                        <button class="btn btn-sm btn-danger" type="button" id="logoutBtn" style="display: none; margin-left: 8px;">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- ========================================
             SIDEBAR SECTION
             ======================================== -->
        <div class="sidebar no-print" id="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <div class="sidebar-logo-container">
                    <div class="sidebar-logo">
                        <i class="fas fa-infinity"></i>
                    </div>
                    <h3 class="sidebar-title">D.Watson Pharmacy</h3>
                </div>
                <div class="sidebar-toggle-icon" id="sidebarToggleIcon" title="Toggle Sidebar">
                    <i class="fas fa-chevron-left" style="font-size: 12px;"></i>
                </div>
            </div>
            
            <!-- Sidebar Search -->
            <div class="sidebar-search">
                <div class="sidebar-search-wrapper">
                    <i class="fas fa-search sidebar-search-icon"></i>
                    <!-- Commented out - no longer needed -->
                    <!-- <input type="text" class="sidebar-search-input" placeholder="Search item..." id="sidebarSearchInput"> -->
                </div>
            </div>
            
            <div class="sidebar-content">
                <!-- ADMINISTRATION Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-header" data-bs-toggle="collapse" data-bs-target="#administrationSectionItems" aria-expanded="false" aria-controls="administrationSectionItems">
                        <span>ADMINISTRATION</span>
                        <i class="fas fa-chevron-down section-chevron"></i>
                    </div>
                    <ul class="nav flex-column sidebar-section-items collapse" id="administrationSectionItems">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="branches">
                                <i class="fas fa-store"></i>
                                <span class="sidebar-text">Branches</span>
                                <i class="fas fa-chevron-down item-chevron"></i>
                            </a>
                        </li>
                        <li class="nav-item admin-only">
                            <a class="nav-link" href="#" data-section="groups">
                                <i class="fas fa-users"></i>
                                <span class="sidebar-text">Groups</span>
                                <i class="fas fa-chevron-down item-chevron"></i>
                            </a>
                        </li>
                        <li class="nav-item admin-only">
                            <a class="nav-link" href="#" data-section="users">
                                <i class="fas fa-user"></i>
                                <span class="sidebar-text">Users</span>
                                <i class="fas fa-chevron-down item-chevron"></i>
                            </a>
                        </li>
                        <li class="nav-item admin-only">
                            <a class="nav-link" href="#" data-section="settings">
                                <i class="fas fa-cog"></i>
                                <span class="sidebar-text">Settings</span>
                                <i class="fas fa-chevron-down item-chevron"></i>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <hr class="sidebar-section-separator">
                
                <!-- PAYROLL Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-header" data-bs-toggle="collapse" data-bs-target="#payrollSectionItems" aria-expanded="false" aria-controls="payrollSectionItems">
                        <span>PAYROLL</span>
                        <i class="fas fa-chevron-down section-chevron"></i>
                    </div>
                    <ul class="nav flex-column sidebar-section-items collapse" id="payrollSectionItems">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="employees">
                                <i class="fas fa-user-tie"></i>
                                <span class="sidebar-text">Employees</span>
                                <i class="fas fa-chevron-down item-chevron"></i>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <hr class="sidebar-section-separator">
                
                <!-- MAIN Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-header" data-bs-toggle="collapse" data-bs-target="#mainSectionItems" aria-expanded="false" aria-controls="mainSectionItems">
                        <span>OVERVIEW</span>
                        <i class="fas fa-chevron-down section-chevron"></i>
                    </div>
                    <ul class="nav flex-column sidebar-section-items collapse" id="mainSectionItems">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-section="dashboard">
                                <i class="fas fa-chart-bar"></i>
                                <span class="sidebar-text">Dashboard</span>
                                <i class="fas fa-chevron-down item-chevron"></i>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <hr class="sidebar-section-separator">
                
                <!-- INVENTORY Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-header" data-bs-toggle="collapse" data-bs-target="#inventorySectionItems" aria-expanded="false" aria-controls="inventorySectionItems">
                        <span>INVENTORY</span>
                        <i class="fas fa-chevron-down section-chevron"></i>
                    </div>
                    <ul class="nav flex-column sidebar-section-items collapse" id="inventorySectionItems">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="categories">
                                <i class="fas fa-tags"></i>
                                <span class="sidebar-text">Categories</span>
                                <i class="fas fa-chevron-down item-chevron"></i>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="departments">
                                <i class="fas fa-building"></i>
                                <span class="sidebar-text">Departments</span>
                                <i class="fas fa-chevron-down item-chevron"></i>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="suppliers">
                                <i class="fas fa-truck"></i>
                                <span class="sidebar-text">Suppliers</span>
                                <i class="fas fa-chevron-down item-chevron"></i>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <hr class="sidebar-section-separator">
                
                <!-- SALES Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-header" data-bs-toggle="collapse" data-bs-target="#salesSectionItems" aria-expanded="false" aria-controls="salesSectionItems">
                        <span>SALES</span>
                        <i class="fas fa-chevron-down section-chevron"></i>
                    </div>
                    <ul class="nav flex-column sidebar-section-items collapse" id="salesSectionItems">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="sales">
                                <i class="fas fa-shopping-cart"></i>
                                <span class="sidebar-text">Sales Entry</span>
                                <i class="fas fa-chevron-down item-chevron"></i>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <hr class="sidebar-section-separator">
                
                <!-- PAYMENTS Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-header" data-bs-toggle="collapse" data-bs-target="#paymentsSectionItems" aria-expanded="false" aria-controls="paymentsSectionItems">
                        <span>PAYMENTS</span>
                        <i class="fas fa-chevron-down section-chevron"></i>
                    </div>
                    <ul class="nav flex-column sidebar-section-items collapse" id="paymentsSectionItems">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="payment-dashboard">
                                <i class="fas fa-tachometer-alt"></i>
                                <span class="sidebar-text">Payment Dashboard</span>
                                <i class="fas fa-chevron-down item-chevron"></i>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="payment-vouchers">
                                <i class="fas fa-file-invoice"></i>
                                <span class="sidebar-text">Payment Vouchers</span>
                                <i class="fas fa-chevron-down item-chevron"></i>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="payment-voucher-list">
                                <i class="fas fa-list"></i>
                                <span class="sidebar-text">Voucher List</span>
                                <i class="fas fa-chevron-down item-chevron"></i>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="payment-reports">
                                <i class="fas fa-chart-bar"></i>
                                <span class="sidebar-text">Payment Reports</span>
                                <i class="fas fa-chevron-down item-chevron"></i>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <hr class="sidebar-section-separator">
                
                <!-- REPORTS Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-header" data-bs-toggle="collapse" data-bs-target="#reportsSectionItems" aria-expanded="false" aria-controls="reportsSectionItems">
                        <span>REPORTS</span>
                        <i class="fas fa-chevron-down section-chevron"></i>
                    </div>
                    <ul class="nav flex-column sidebar-section-items collapse" id="reportsSectionItems">
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="reportsMenuToggle" data-bs-toggle="collapse" data-bs-target="#reportsSubmenu" aria-expanded="false" aria-controls="reportsSubmenu">
                                <i class="fas fa-chart-pie"></i>
                                <span class="sidebar-text">Reports</span>
                                <i class="fas fa-chevron-down" id="reportsChevron"></i>
                            </a>
                            <ul class="collapse nav flex-column ms-3" id="reportsSubmenu" style="list-style: none; padding-left: 0;">
                                <!-- Warehouse Reports Section -->
                                <li class="nav-item">
                                    <a class="nav-link" href="#" id="warehouseReportsToggle" data-bs-toggle="collapse" data-bs-target="#warehouseReportsSubmenu" aria-expanded="false" aria-controls="warehouseReportsSubmenu">
                                        <i class="fas fa-warehouse"></i>
                                        <span class="sidebar-text">Warehouse Reports</span>
                                        <i class="fas fa-chevron-down" id="warehouseReportsChevron"></i>
                                    </a>
                                    <ul class="collapse nav flex-column ms-3" id="warehouseReportsSubmenu" style="list-style: none; padding-left: 0;">
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-section="reports" data-report="sales-report">
                                                <i class="fas fa-circle" style="font-size: 6px;"></i>
                                                <span class="sidebar-text">Sales Report</span>
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-section="reports" data-report="sales-comparison-report">
                                                <i class="fas fa-circle" style="font-size: 6px;"></i>
                                                <span class="sidebar-text">Sales Comparison</span>
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-section="reports" data-report="datewise-sales-report">
                                                <i class="fas fa-circle" style="font-size: 6px;"></i>
                                                <span class="sidebar-text">Date-Wise Sales</span>
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-section="reports" data-report="payment-reports">
                                                <i class="fas fa-circle" style="font-size: 6px;"></i>
                                                <span class="sidebar-text">Payment Reports</span>
                                            </a>
                                        </li>
                                    </ul>
                                </li>
                                <!-- Shop Reports Section -->
                                <li class="nav-item">
                                    <a class="nav-link" href="#" id="shopReportsToggle" data-bs-toggle="collapse" data-bs-target="#shopReportsSubmenu" aria-expanded="false" aria-controls="shopReportsSubmenu">
                                        <i class="fas fa-store"></i>
                                        <span class="sidebar-text">Shop Reports</span>
                                        <i class="fas fa-chevron-down" id="shopReportsChevron"></i>
                                    </a>
                                    <ul class="collapse nav flex-column ms-3" id="shopReportsSubmenu" style="list-style: none; padding-left: 0;">
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-section="reports" data-report="department-wise-report">
                                                <i class="fas fa-circle" style="font-size: 6px;"></i>
                                                <span class="sidebar-text">Department-Wise Report</span>
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-section="reports" data-report="sub-department-wise-report">
                                                <i class="fas fa-circle" style="font-size: 6px;"></i>
                                                <span class="sidebar-text">Sub-Department-Wise Report</span>
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-section="reports" data-report="department-wise-sale-comparison">
                                                <i class="fas fa-circle" style="font-size: 6px;"></i>
                                                <span class="sidebar-text">Department-Wise Sale Comparison</span>
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-section="reports" data-report="branch-wise-sale-comparison">
                                                <i class="fas fa-circle" style="font-size: 6px;"></i>
                                                <span class="sidebar-text">Branch-Wise Sale Comparison</span>
                                            </a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
                
                <hr class="sidebar-section-separator">
                
                <!-- SUPPORT Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-header" data-bs-toggle="collapse" data-bs-target="#supportSectionItems" aria-expanded="false" aria-controls="supportSectionItems">
                        <span>SUPPORT</span>
                        <i class="fas fa-chevron-down section-chevron"></i>
                    </div>
                    <ul class="nav flex-column sidebar-section-items collapse" id="supportSectionItems">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="support-chat" id="supportChatLink">
                                <i class="fab fa-whatsapp"></i>
                                <span class="sidebar-text">Support Chat</span>
                                <i class="fas fa-chevron-down item-chevron"></i>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <hr class="sidebar-section-separator">
                
                <!-- Bottom Settings -->
                <div class="sidebar-bottom">
                    <a class="nav-link sidebar-bottom-link" href="#" data-section="settings">
                        <i class="fas fa-cog"></i>
                        <span class="sidebar-text">Settings</span>
                    </a>
                    <div class="sidebar-copyright">
                        <p>2025 D.Watson Pharmacy</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <!-- ========================================
             MAIN CONTENT SECTION
             ======================================== -->
        <div class="main-content" id="mainContent">
            <!-- Content sections will be loaded dynamically from views/ folder -->
            <!-- Placeholder containers for dynamic loading -->
            <div id="dashboard-section" class="content-section"></div>
            <div id="categories-section" class="content-section"></div>
            <div id="suppliers-section" class="content-section"></div>
            <div id="sales-section" class="content-section"></div>
            <div id="departments-section" class="content-section"></div>
            <div id="payment-dashboard-section" class="content-section"></div>
            <div id="payment-vouchers-section" class="content-section"></div>
            <div id="payment-voucher-list-section" class="content-section"></div>
            <div id="category-voucher-simple-list-section" class="content-section"></div>
            <div id="category-voucher-list-section" class="content-section"></div>
            <div id="payment-reports-section" class="content-section"></div>
            <div id="reports-section" class="content-section"></div>
            <div id="branches-section" class="content-section"></div>
            <div id="groups-section" class="content-section"></div>
            <div id="users-section" class="content-section"></div>
            <div id="settings-section" class="content-section"></div>
            <div id="employees-section" class="content-section"></div>
            <div id="employee-list-section" class="content-section"></div>
            
            <!-- ========================================
                 NOTE: All section content is loaded dynamically from views/ folder
                 Content is loaded via loadView() function when sections are activated
                 ======================================== -->
          
            <!-- ========================================
                 SUPPLIERS SECTION
                 ======================================== -->
            <div id="suppliers-section" class="content-section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Supplier Management</h1>
                    <p class="dashboard-subtitle">Manage your payment suppliers</p>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="section-title mb-0">
                        <i class="fas fa-truck"></i>Suppliers
                    </h2>
                    <button class="btn btn-primary" id="addSupplierBtn">
                        <i class="fas fa-plus me-2"></i>Add Supplier
                    </button>
                </div>
                
                <!-- View Toggle -->
                <div class="btn-group mb-3" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary active" id="supplierCardViewBtn">
                        <i class="fas fa-th me-1"></i>Card View
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="supplierTableViewBtn">
                        <i class="fas fa-table me-1"></i>Table View
                    </button>
                </div>
                
                <!-- Card View (Default) -->
                <div id="supplierCardView">
                    <div class="row" id="suppliersContainer">
                        <!-- Supplier cards will be populated dynamically -->
                    </div>
                </div>
                
                <!-- Table View (Hidden by default) -->
                <div id="supplierTableView" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover" id="suppliersTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Contact</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="suppliersTableBody">
                                <!-- Table rows will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Sales Entry Section -->
            <!-- ========================================
                 SALES SECTION
                 ======================================== -->
            <div id="sales-section" class="content-section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Sales Entry</h1>
                    <p class="dashboard-subtitle">Enter daily sales data by category</p>
                </div>
                
                <!-- Sales List Section (Initially Hidden) -->
                <div id="salesListSection" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Sales List</h5>
                            <div>
                                <button class="btn btn-sm btn-primary me-2" id="backToSalesBtn">
                                    <i class="fas fa-arrow-left me-1"></i>Back to Sales Entry
                                </button>
                            <button class="btn btn-sm btn-secondary" id="hideSalesListBtn">
                                <i class="fas fa-times me-1"></i>Hide
                            </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filter Section -->
                            <div class="filter-section mb-3">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">From Date</label>
                                        <input type="date" class="form-control" id="salesListDateFrom">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">To Date</label>
                                        <input type="date" class="form-control" id="salesListDateTo">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Branch</label>
                                        <select class="form-select" id="salesListBranch">
                                            <option value="">All Branches</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Category</label>
                                        <select class="form-select" id="salesListCategory">
                                            <option value="">All Categories</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-12 d-flex justify-content-end">
                                        <button class="btn btn-primary" id="filterSalesList">
                                            <i class="fas fa-filter me-2"></i>Apply Filter
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Category-Wise Summary -->
                            <div id="categorySummarySection" class="mb-4" style="display: none;">
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Category-Wise Summary</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row" id="categorySummaryCards">
                                            <!-- Category summary cards will be populated dynamically -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- View Toggle -->
                            <div class="btn-group mb-3" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary active" id="cardViewBtn">
                                    <i class="fas fa-th me-1"></i>Card View
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="tableViewBtn">
                                    <i class="fas fa-table me-1"></i>Table View
                                </button>
                            </div>
                            
                            <!-- Card View (Default) -->
                            <div id="salesCardView">
                                <div class="row" id="salesInvoicesContainer">
                                    <!-- Invoice cards will be populated dynamically -->
                                </div>
                                <nav aria-label="Page navigation">
                                    <ul class="pagination" id="salesInvoicesPagination">
                                        <!-- Pagination will be populated dynamically -->
                                    </ul>
                                </nav>
                            </div>
                            
                            <!-- Table View (Hidden by default) -->
                            <div id="salesTableView" style="display: none;">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="salesListTable">
                                    <thead>
                                        <tr>
                                            <th style="display: none;">ID</th>
                                            <th>Date</th>
                                            <th>Category</th>
                                            <th>Branch</th>
                                            <th>Sales</th>
                                            <th>Cost</th>
                                            <th>Profit</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                        <tbody id="salesListTableBody">
                                            <!-- Table rows will be populated dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                <nav aria-label="Page navigation">
                                    <ul class="pagination" id="salesListPagination">
                                        <!-- Pagination will be populated dynamically -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Department Sales List Section (Initially Hidden) - Same level as Sales List -->
                <div id="deptSalesListSection" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Department Sales List</h5>
                            <div>
                                <button class="btn btn-sm btn-primary me-2" id="backToDeptSalesBtn">
                                    <i class="fas fa-arrow-left me-1"></i>Back to Sales Entry
                                </button>
                                <button class="btn btn-sm btn-secondary" id="hideDeptSalesListBtn">
                                    <i class="fas fa-times me-1"></i>Hide
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filter Section -->
                            <div class="filter-section mb-3">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">From Date</label>
                                        <input type="date" class="form-control" id="deptSalesListDateFrom">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">To Date</label>
                                        <input type="date" class="form-control" id="deptSalesListDateTo">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Branch</label>
                                        <select class="form-select" id="deptSalesListBranch">
                                            <option value="">All Branches</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Department</label>
                                        <select class="form-select" id="deptSalesListDepartment">
                                            <option value="">All Departments</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-12 d-flex justify-content-end">
                                        <button class="btn btn-primary" id="filterDeptSalesList">
                                            <i class="fas fa-filter me-2"></i>Apply Filter
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Grand Total Card (After Filter) -->
                            <div id="grandTotalSection" class="mb-4" style="display: none;">
                                <!-- Grand Total card will be populated dynamically -->
                            </div>
                            
                            <!-- Department-Wise Summary -->
                            <div id="departmentSummarySection" class="mb-4" style="display: none;">
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Department-Wise Summary</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row" id="departmentSummaryCards">
                                            <!-- Department summary cards will be populated dynamically -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- View Toggle -->
                            <div class="btn-group mb-3" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary active" id="deptCardViewBtn">
                                    <i class="fas fa-th me-1"></i>Card View
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="deptTableViewBtn">
                                    <i class="fas fa-table me-1"></i>Table View
                                </button>
                            </div>
                            
                            <!-- Card View (Default) -->
                            <div id="deptSalesCardView">
                                <div class="row" id="deptSalesInvoicesContainer">
                                    <!-- Department sales cards will be populated dynamically -->
                                </div>
                                <nav aria-label="Page navigation">
                                    <ul class="pagination" id="deptSalesInvoicesPagination">
                                        <!-- Pagination will be populated dynamically -->
                                    </ul>
                                </nav>
                            </div>
                            
                            <!-- Table View (Hidden by default) -->
                            <div id="deptSalesTableView" style="display: none;">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="deptSalesListTable">
                                        <thead>
                                            <tr>
                                                <th style="display: none;">ID</th>
                                                <th>Date</th>
                                                <th>Branch</th>
                                                <th>Department</th>
                                                <th>Sub-Department</th>
                                                <th>Gross Sale</th>
                                                <th>Discount</th>
                                                <th>Net Sale</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="deptSalesListTableBody">
                                            <!-- Table rows will be populated dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                <nav aria-label="Page navigation">
                                    <ul class="pagination" id="deptSalesListPagination">
                                        <!-- Pagination will be populated dynamically -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Add Daily Sales</h5>
                    </div>
                    <div class="card-body">
                        <!-- Tabs Navigation -->
                        <ul class="nav nav-tabs mb-4" id="salesEntryTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="category-tab" data-bs-toggle="tab" data-bs-target="#category-sales-content" type="button" role="tab" aria-controls="category-sales-content" aria-selected="true">
                                    <i class="fas fa-warehouse me-2"></i>Warehouse Sale
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="department-tab" data-bs-toggle="tab" data-bs-target="#department-sales-content" type="button" role="tab" aria-controls="department-sales-content" aria-selected="false">
                                    <i class="fas fa-store me-2"></i>Shop Sale
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Tab Content -->
                        <div class="tab-content" id="salesEntryTabContent">
                            <!-- Tab 1: Category Sales -->
                            <div class="tab-pane fade show active" id="category-sales-content" role="tabpanel" aria-labelledby="category-tab">
                                <div class="d-flex justify-content-end mb-3">
                                    <button class="btn btn-outline-primary" id="viewSalesListBtn">
                                        <i class="fas fa-list me-2"></i>View Sales List
                                    </button>
                                </div>
                        <form id="salesEntryForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="saleDate" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="saleDate" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="saleBranch" class="form-label">Branch</label>
                                    <select class="form-select" id="saleBranch" required>
                                        <option value="" selected disabled>Select Branch</option>
                                    </select>
                                </div>
                            </div>
                            
                            <h5 class="mt-4 mb-3">Enter Sales by Category</h5>
                            <div id="categoryInputs">
                                <!-- Category inputs will be populated dynamically -->
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-md-4 mb-3">
                                    <label for="totalSales" class="form-label">Total Sales</label>
                                    <div class="input-group">
                                        <span class="input-group-text"></span>
                                        <input type="number" class="form-control" id="totalSales" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="totalCost" class="form-label">Total Cost</label>
                                    <div class="input-group">
                                        <span class="input-group-text"></span>
                                        <input type="number" class="form-control" id="totalCost" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="totalProfit" class="form-label">Total Profit</label>
                                    <div class="input-group">
                                        <span class="input-group-text"></span>
                                        <input type="number" class="form-control" id="totalProfit" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <label for="saleNotes" class="form-label">Notes</label>
                                    <textarea class="form-control" id="saleNotes" rows="3"></textarea>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-secondary me-2" id="resetSalesForm">Reset</button>
                                <button type="button" id="saveSalesButton" class="btn btn-primary">Save Sale</button>
                            </div>
                        </form>
                            </div>
                            
                            <!-- Tab 2: Department/Sub-Department Sales -->
                            <div class="tab-pane fade" id="department-sales-content" role="tabpanel" aria-labelledby="department-tab">
                                <div class="d-flex justify-content-end mb-3">
                                    <button class="btn btn-outline-primary" id="viewDeptSalesListBtn">
                                        <i class="fas fa-list me-2"></i>View Department Sales List
                                    </button>
                                </div>
                                
                                <!-- Bulk Department Sales Entry Form -->
                                <div class="card">
                                    <div class="card-body">
                                        <form id="bulkDeptSalesEntryFormTab2">
                                            <input type="hidden" id="editDeptSaleIdTab2" value="">
                                            <div class="row g-3">
                                                <div class="col-md-4">
                                                    <label for="bulkDeptSaleDateTab2" class="form-label">Date <span class="text-danger">*</span></label>
                                                    <input type="date" class="form-control" id="bulkDeptSaleDateTab2" required>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="bulkDeptSaleBranchTab2" class="form-label">Branch <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="bulkDeptSaleBranchTab2" required>
                                                        <option value="">Select Branch</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="bulkDeptSaleDepartmentTab2" class="form-label">Department <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="bulkDeptSaleDepartmentTab2" required>
                                                        <option value="">Select Department</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row g-3 mt-2">
                                                <div class="col-12">
                                                    <label class="form-label">Sub-Department Sales <span class="text-danger">*</span></label>
                                                    <div id="bulkSubDepartmentsContainerTab2">
                                                        <div class="alert alert-info">
                                                            <i class="fas fa-info-circle me-2"></i>Please select a branch and department to load sub-departments
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-end mt-4">
                                                <button type="button" class="btn btn-secondary me-2" id="resetBulkDeptSalesFormTab2">Reset</button>
                                                <button type="submit" class="btn btn-primary" id="saveBulkDeptSalesBtnTab2">Save Bulk Department Sales</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========================================
                 PAYMENT DASHBOARD SECTION
                 ======================================== -->
            <div id="payment-dashboard-section" class="content-section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Payment Dashboard</h1>
                    <p class="dashboard-subtitle">Comprehensive overview of payment vouchers and supplier payments</p>
                </div>
                
                    <div class="filter-section">
                        <div class="row g-3">
                            <div class="col-12 col-md-4">
                                <label class="form-label">Select Branch</label>
                                <select class="form-select" id="paymentDashboardBranchFilter">
                                    <option value="">All Branches</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-4">
                                <label class="form-label">Select Supplier</label>
                                <select class="form-select" id="paymentDashboardSupplierFilter">
                                    <option value="">All Suppliers</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-4">
                                <label class="form-label">Date Range</label>
                                <select class="form-select" id="paymentDashboardDateFilter">
                                    <option value="7">Last 7 Days</option>
                                    <option value="30">Last 30 Days</option>
                                    <option value="90">Last 3 Months</option>
                                    <option value="365">Last Year</option>
                                </select>
                            </div>
                        </div>
                </div>
                
                    <div class="row mb-4">
                        <div class="col-lg-2 col-md-4 mb-3">
                            <div id="cardCashPaid" class="card text-center border-0 shadow-sm" style="cursor:pointer;background: linear-gradient(135deg, #1cc88a 0%, #20c997 100%);">
                                <div class="card-body">
                                    <h3 class="text-white mb-0" id="paymentCashAmount">0</h3>
                                    <p class="text-white mb-0">Cash Paid</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 mb-3">
                            <div id="cardBankPaid" class="card text-center border-0 shadow-sm" style="cursor:pointer;background: linear-gradient(135deg, #36b9cc 0%, #17a2b8 100%);">
                                <div class="card-body">
                                    <h3 class="text-white mb-0" id="paymentBankAmount">0</h3>
                                    <p class="text-white mb-0">Bank Transfer Paid</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 mb-3">
                            <div id="cardChequePaid" class="card text-center border-0 shadow-sm" style="cursor:pointer;background: linear-gradient(135deg, #f6c23e 0%, #f39c12 100%);">
                                <div class="card-body">
                                    <h3 class="text-white mb-0" id="paymentChequeAmount">0</h3>
                                    <p class="text-white mb-0">Cheque Paid</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 mb-3">
                            <div id="cardOnlinePaid" class="card text-center border-0 shadow-sm" style="cursor:pointer;background: linear-gradient(135deg, #e83e8c 0%, #d63384 100%);">
                                <div class="card-body">
                                    <h3 class="text-white mb-0" id="paymentOnlineAmount">0</h3>
                                    <p class="text-white mb-0">Online Paid</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-8 mb-3">
                            <div id="cardTotalPaid" class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #4e73df 0%, #667eea 100%);">
                                <div class="card-body">
                                    <h3 class="text-white mb-0" id="paymentTotalAmount">0</h3>
                                    <p class="text-white mb-0">Total Paid</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-8">
                    <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Payment Trends</h5>
                        </div>
                        <div class="card-body">
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="paymentTrendChart"></canvas>
                                </div>
                                </div>
                                </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Supplier Distribution</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="paymentSupplierChart"></canvas>
                                    </div>
                                </div>
                            </div>
                                </div>
                            </div>
                            
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Recent Vouchers</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Voucher #</th>
                                            <th>Date</th>
                                            <th>Supplier</th>
                                            <th>Branch</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentRecentVouchersTable">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">No vouchers found</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            <!-- ========================================
                 PAYMENT VOUCHERS SECTION
                 ======================================== -->
            <div id="payment-vouchers-section" class="content-section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Payment Vouchers</h1>
                    <p class="dashboard-subtitle">Create and manage payment vouchers</p>
                </div>
                
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mb-3" id="paymentVoucherTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="supplier-voucher-tab" data-bs-toggle="tab" data-bs-target="#supplier-voucher-content" type="button" role="tab">
                            <i class="fas fa-truck me-2"></i>Supplier Voucher
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="category-voucher-tab" data-bs-toggle="tab" data-bs-target="#category-voucher-content" type="button" role="tab">
                            <i class="fas fa-tags me-2"></i>Category Voucher
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="paymentVoucherTabContent">
                    <!-- Supplier Voucher Tab -->
                    <div class="tab-pane fade show active" id="supplier-voucher-content" role="tabpanel">
                    <div class="card">
                    <div class="card-header">
                                <h5 class="mb-0">Create Supplier Payment Voucher</h5>
                    </div>
                        <div class="card-body">
                            <form id="paymentVoucherForm">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Voucher Number</label>
                                            <input type="text" class="form-control" id="paymentVoucherNumber" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Date</label>
                                            <input type="date" class="form-control" id="paymentVoucherDate" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Supplier</label>
                                            <select class="form-select" id="paymentVoucherSupplier" required>
                                                <option value="">Select Supplier</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Branch</label>
                                            <select class="form-select" id="paymentVoucherBranch" required>
                                                <option value="">Select Branch</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Payment Method</label>
                                            <select class="form-select" id="paymentVoucherMethod" required>
                                                <option value="">Select Method</option>
                                                <option value="Cash">Cash</option>
                                                <option value="Bank Transfer">Bank Transfer</option>
                                                <option value="Cheque">Cheque</option>
                                                <option value="Online Payment">Online Payment</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Amount (PKR)</label>
                                            <input type="number" class="form-control" id="paymentVoucherAmount" step="0.01" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="paymentVoucherDescription" rows="3" required></textarea>
                                </div>
                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-secondary me-2" onclick="resetPaymentVoucherForm()">
                                        <i class="fas fa-redo me-2"></i>Reset
                                </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Save Voucher
                                </button>
                            </div>
                            </form>
                        </div>
                    </div>
                </div>
                    
                    <!-- Category Voucher Tab -->
                    <div class="tab-pane fade" id="category-voucher-content" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Create Category Payment Voucher</h5>
                            </div>
                            <div class="card-body">
                                <form id="categoryVoucherForm">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Voucher Number</label>
                                                <input type="text" class="form-control" id="categoryVoucherNumber" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Date</label>
                                                <input type="date" class="form-control" id="categoryVoucherDate" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Category</label>
                                                <select class="form-select" id="categoryVoucherCategory" required>
                                                    <option value="">Select Category</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Branch</label>
                                                <select class="form-select" id="categoryVoucherBranch" required>
                                                    <option value="">Select Branch</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Payment Method</label>
                                                <select class="form-select" id="categoryVoucherMethod" required>
                                                    <option value="">Select Method</option>
                                                    <option value="Cash">Cash</option>
                                                    <option value="Bank Transfer">Bank Transfer</option>
                                                    <option value="Cheque">Cheque</option>
                                                    <option value="Online Payment">Online Payment</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Amount (PKR)</label>
                                                <input type="number" class="form-control" id="categoryVoucherAmount" step="0.01" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" id="categoryVoucherDescription" rows="3" required></textarea>
                                    </div>
                                    <div class="d-flex justify-content-end">
                                        <button type="button" class="btn btn-secondary me-2" onclick="resetCategoryVoucherForm()">
                                            <i class="fas fa-redo me-2"></i>Reset
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>Save Voucher
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========================================
                 PAYMENT VOUCHER LIST SECTION
                 ======================================== -->
            <div id="payment-voucher-list-section" class="content-section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Voucher List</h1>
                    <p class="dashboard-subtitle">View and manage payment vouchers</p>
                </div>
                
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mb-3" id="voucherListTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="supplier-voucher-list-tab" data-bs-toggle="tab" data-bs-target="#supplier-voucher-list-content" type="button" role="tab">
                            <i class="fas fa-truck me-2"></i>Supplier Vouchers
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="category-voucher-list-tab" data-bs-toggle="tab" data-bs-target="#category-voucher-list-content" type="button" role="tab">
                            <i class="fas fa-tags me-2"></i>Category Vouchers
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="voucherListTabContent">
                    <!-- Supplier Voucher List Tab -->
                    <div class="tab-pane fade show active" id="supplier-voucher-list-content" role="tabpanel">
                <div class="filter-section mb-4">
                    <div class="row g-2">
                                <div class="col-6 col-md">
                            <label class="form-label small">Search</label>
                            <input type="text" class="form-control form-control-sm" id="paymentVoucherSearch" placeholder="Search...">
                        </div>
                        <div class="col-6 col-md">
                            <label class="form-label small">Branch Filter</label>
                            <select class="form-select form-select-sm" id="paymentVoucherListBranchFilter">
                                        <option value="">All Branches</option>
                                    </select>
                                </div>
                                <div class="col-6 col-md">
                            <label class="form-label small">Supplier Filter</label>
                            <select class="form-select form-select-sm" id="paymentVoucherListSupplierFilter">
                                <option value="">All Suppliers</option>
                                    </select>
                                </div>
                        <div class="col-6 col-md">
                            <label class="form-label small">From Date</label>
                            <input type="date" class="form-control form-control-sm" id="paymentVoucherListFromDate">
                        </div>
                        <div class="col-6 col-md">
                            <label class="form-label small">To Date</label>
                            <input type="date" class="form-control form-control-sm" id="paymentVoucherListToDate">
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-12 d-flex justify-content-between">
                            <div>
                                <button class="btn btn-success" onclick="downloadPaymentVouchersCSV()">
                                    <i class="fas fa-download me-2"></i>Download CSV
                                </button>
                                <button class="btn btn-info ms-2" onclick="printPaymentVoucherList()">
                                    <i class="fas fa-print me-2"></i>Print List
                                </button>
                                <button class="btn btn-primary ms-2" onclick="printSelectedVouchersList()">
                                    <i class="fas fa-print me-2"></i>Print Selected
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-primary" onclick="filterPaymentVouchers()">
                                    <i class="fas fa-filter me-2"></i>Apply Filters
                                </button>
                                </div>
                        </div>
                    </div>
                            </div>
                            
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                    <thead>
                                        <tr>
                                        <th class="no-print"><input type="checkbox" id="paymentSelectAll"></th>
                                        <th>Voucher #</th>
                                        <th>Date</th>
                                        <th>Supplier</th>
                                            <th>Branch</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>Description</th>
                                        <th class="no-print">Actions</th>
                                        </tr>
                                    </thead>
                                <tbody id="paymentVoucherListTable">
                                        <tr>
                                        <td colspan="9" class="text-center text-muted">Loading vouchers...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Category Voucher List Tab -->
                    <div class="tab-pane fade" id="category-voucher-list-content" role="tabpanel">
                        <div class="filter-section mb-4">
                            <div class="row g-2">
                                <div class="col-6 col-md">
                                    <label class="form-label small">Search</label>
                                    <input type="text" class="form-control form-control-sm" id="categoryVoucherListSearch" placeholder="Search...">
                                </div>
                                <div class="col-6 col-md">
                                    <label class="form-label small">Branch Filter</label>
                                    <select class="form-select form-select-sm" id="categoryVoucherListBranchFilter">
                                        <option value="">All Branches</option>
                                    </select>
                                </div>
                                <div class="col-6 col-md">
                                    <label class="form-label small">Category Filter</label>
                                    <select class="form-select form-select-sm" id="categoryVoucherListCategoryFilter">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                                <div class="col-6 col-md">
                                    <label class="form-label small">From Date</label>
                                    <input type="date" class="form-control form-control-sm" id="categoryVoucherListFromDate">
                                </div>
                                <div class="col-6 col-md">
                                    <label class="form-label small">To Date</label>
                                    <input type="date" class="form-control form-control-sm" id="categoryVoucherListToDate">
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-12 d-flex justify-content-between">
                                    <div>
                                        <button class="btn btn-info" onclick="printCategoryVoucherListTab()">
                                            <i class="fas fa-print me-2"></i>Print List
                                        </button>
                                    </div>
                                    <div>
                                        <button class="btn btn-primary" onclick="loadCategoryVoucherListTab()">
                                            <i class="fas fa-filter me-2"></i>Apply Filters
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Voucher #</th>
                                                <th>Date</th>
                                                <th>Category</th>
                                                <th>Branch</th>
                                                <th class="text-end">Amount</th>
                                                <th>Method</th>
                                                <th>Description</th>
                                                <th class="no-print">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="categoryVoucherListTableBody">
                                            <tr>
                                                <td colspan="8" class="text-center text-muted">Loading vouchers...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========================================
                 CATEGORY VOUCHER LIST SECTION (Simple List)
                 ======================================== -->
            <div id="category-voucher-simple-list-section" class="content-section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Category Voucher List</h1>
                    <p class="dashboard-subtitle">View and manage category payment vouchers</p>
                </div>
                
                <div class="filter-section mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Search</label>
                            <input type="text" class="form-control" id="categoryVoucherSimpleSearch" placeholder="Search...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Branch Filter</label>
                            <select class="form-select" id="categoryVoucherSimpleListBranchFilter">
                                <option value="">All Branches</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Category Filter</label>
                            <select class="form-select" id="categoryVoucherSimpleListCategoryFilter">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Date Range</label>
                            <div class="d-flex gap-2">
                                <input type="date" class="form-control" id="categoryVoucherSimpleListFromDate">
                                <input type="date" class="form-control" id="categoryVoucherSimpleListToDate">
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-12 d-flex justify-content-between">
                            <div>
                                <button class="btn btn-primary" onclick="loadCategoryVoucherSimpleList()">
                                    <i class="fas fa-filter me-2"></i>Apply Filters
                                </button>
                                <button class="btn btn-secondary ms-2" onclick="clearCategoryVoucherSimpleFilters()">
                                    <i class="fas fa-times me-2"></i>Clear Filters
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-info ms-2" onclick="printCategoryVoucherSimpleList()">
                                    <i class="fas fa-print me-2"></i>Print List
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Voucher #</th>
                                        <th>Date</th>
                                        <th>Category</th>
                                        <th>Branch</th>
                                        <th class="text-end">Amount</th>
                                        <th>Method</th>
                                        <th>Description</th>
                                        <th class="no-print">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="categoryVoucherSimpleListTable">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">Loading vouchers...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========================================
                 CATEGORY VOUCHER LIST SECTION (Summary Report)
                 ======================================== -->
            <div id="category-voucher-list-section" class="content-section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Category Voucher List</h1>
                    <p class="dashboard-subtitle">View category-wise sales, costs, payments, and balance</p>
                </div>
                
                <div class="filter-section mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="categoryVoucherListCategoryFilter">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Branch</label>
                            <select class="form-select" id="categoryVoucherListBranchFilter">
                                <option value="">All Branches</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">From Date</label>
                            <input type="date" class="form-control" id="categoryVoucherListFromDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">To Date</label>
                            <input type="date" class="form-control" id="categoryVoucherListToDate">
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-12 d-flex justify-content-between">
                            <div>
                                <button class="btn btn-primary" onclick="loadCategoryVoucherList()">
                                    <i class="fas fa-filter me-2"></i>Apply Filters
                                </button>
                                <button class="btn btn-secondary ms-2" onclick="clearCategoryVoucherFilters()">
                                    <i class="fas fa-times me-2"></i>Clear Filters
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-info" onclick="printCategoryVoucherList()">
                                    <i class="fas fa-print me-2"></i>Print Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div class="row mb-4" id="categoryVoucherSummaryCards">
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">Total Sales</h6>
                                <h3 class="mb-0 text-success" id="categoryVoucherTotalSales">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">Total Cost</h6>
                                <h3 class="mb-0 text-danger" id="categoryVoucherTotalCost">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">Total Payment</h6>
                                <h3 class="mb-0 text-info" id="categoryVoucherTotalPayment">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">Balance Payment</h6>
                                <h3 class="mb-0" id="categoryVoucherBalance">
                                    <span class="text-warning">0</span>
                                </h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Branch</th>
                                        <th>Date</th>
                                        <th class="text-end">Sales</th>
                                        <th class="text-end">Cost</th>
                                        <th class="text-end">Payment</th>
                                        <th class="text-end">Balance</th>
                                    </tr>
                                </thead>
                                <tbody id="categoryVoucherListTable">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">Click "Apply Filters" to load data</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
            <!-- ========================================
                 PAYMENT REPORTS SECTION
                 ======================================== -->
            <div id="payment-reports-section" class="content-section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Payment Reports</h1>
                    <p class="dashboard-subtitle">Generate comprehensive payment reports and analytics</p>
                    </div>
                
                <div class="filter-section mb-4">
                            <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">From Date</label>
                                <input type="date" class="form-control" id="paymentReportFromDate">
                                </div>
                            <div class="col-md-3">
                                <label class="form-label">To Date</label>
                                <input type="date" class="form-control" id="paymentReportToDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Branch</label>
                                <select class="form-select" id="paymentReportBranch">
                                    <option value="">All Branches</option>
                                    </select>
                                </div>
                            <div class="col-md-3">
                                <label class="form-label">Supplier</label>
                                <select class="form-select" id="paymentReportSupplier">
                                    <option value="">All Suppliers</option>
                                </select>
                            </div>
                        </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-12">
                                <button class="btn btn-primary" onclick="generatePaymentVoucherReport()">
                                    <i class="fas fa-chart-line me-2"></i>Generate Report
                                </button>
                                <button class="btn btn-success ms-2" onclick="printPaymentReport()">
                                    <i class="fas fa-print me-2"></i>Print Report
                                </button>
                            </div>
                                </div>
                            </div>
                            
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Payment Reports Chart</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" style="height: 350px;">
                                        <canvas id="paymentReportChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Report Summary</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <td>Total Amount:</td>
                                            <td id="paymentReportTotal">0</td>
                                        </tr>
                                        <tr>
                                            <td>Total Vouchers:</td>
                                            <td id="paymentReportCount">0</td>
                                        </tr>
                                        <tr>
                                            <td>Average Amount:</td>
                                            <td id="paymentReportAvg">0</td>
                                        </tr>
                                        <tr>
                                            <td>Top Supplier:</td>
                                            <td id="paymentTopSupplier">-</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                            </div>
                            
            <!-- Payment Voucher Print Modal -->
            <div class="modal fade" id="paymentVoucherPrintModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Voucher Print Preview</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                        <div class="modal-body">
                            <div class="print-preview" id="paymentVoucherPrintPreview"></div>
                            </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="window.print()">
                                <i class="fas fa-print me-2"></i>Print
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========================================
                 REPORTS SECTION
                 ======================================== -->
            <div id="reports-section" class="content-section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Sales Reports</h1>
                    <p class="dashboard-subtitle">Generate and view sales reports</p>
                </div>
                
                <!-- Report Tabs Navigation -->
                <div class="report-tabs no-print">
                    <button class="report-tab active" data-tab="sales-report">
                        <i class="fas fa-chart-line me-2"></i>Sales Report
                    </button>
                    <button class="report-tab" data-tab="sales-comparison-report">
                        <i class="fas fa-chart-bar me-2"></i>Sales Comparison
                    </button>
                    <button class="report-tab" data-tab="datewise-sales-report">
                        <i class="fas fa-calendar-day me-2"></i>Date-Wise Sales
                    </button>
                    <button class="report-tab" data-tab="payment-reports">
                        <i class="fas fa-file-invoice-dollar me-2"></i>Payment Reports
                    </button>
                    <button class="report-tab" data-tab="department-wise-report">
                        <i class="fas fa-building me-2"></i>Department-Wise Report
                    </button>
                    <button class="report-tab" data-tab="sub-department-wise-report">
                        <i class="fas fa-sitemap me-2"></i>Sub-Department-Wise Report
                    </button>
                    <button class="report-tab" data-tab="department-wise-sale-comparison">
                        <i class="fas fa-chart-pie me-2"></i>Department-Wise Sale Comparison
                    </button>
                    <button class="report-tab" data-tab="branch-wise-sale-comparison">
                        <i class="fas fa-chart-line me-2"></i>Branch-Wise Sale Comparison
                    </button>
                </div>
                
                <!-- Tab 1: Sales Report -->
                <div id="tab-sales-report" class="report-tab-content active">
                    <!-- Filters Section -->
                    <div class="card mb-4 no-print">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                                <i class="fas fa-filter me-2"></i>Sales Report Filters
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Branch</label>
                                    <select class="form-select" id="salesReportBranch">
                                        <option value="">All Branches</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" id="salesReportCategory">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                            <div class="col-md-2">
                                <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="salesReportDateFrom">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="salesReportDateTo">
                            </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="generateSalesReportBtn">
                                        <i class="fas fa-file-alt me-2"></i>Generate Report
                                    </button>
                                        </div>
                                </div>
                            </div>
                            </div>
                    
                    <!-- Summary Cards -->
                    <div class="row mb-4" id="salesSummaryCards">
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Total Sales</h6>
                                    <h3 class="text-white mb-0" id="summaryTotalSales">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #136F63 0%, #17a2b8 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Total Cost</h6>
                                    <h3 class="text-white mb-0" id="summaryTotalCost">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #CF2A2A 0%, #ff6b6b 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Total Profit</h6>
                                    <h3 class="text-white mb-0" id="summaryTotalProfit">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #4D4D4D 0%, #6c757d 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Profit Margin</h6>
                                    <h3 class="text-white mb-0" id="summaryProfitMargin">0%</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sales Report Table -->
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h5 class="card-title mb-0">Sales Detail Report</h5>
                                    <div id="salesReportSubtitle" class="text-muted small mt-1" style="display: none;"></div>
                                </div>
                                <button class="btn btn-success no-print" id="printSalesReportBtn">
                                    <i class="fas fa-print me-2"></i>Print Report
                                </button>
                            </div>
                            
                            <!-- Branch Name Header (between heading and table) -->
                            <div id="salesReportBranchNameHeader" style="display: none; margin-bottom: 20px;">
                                <h4 style="font-size: 1.8rem; color: #495057; font-weight: 700; text-align: center; margin: 0;">
                                    <span id="salesReportBranchName"></span>
                                </h4>
                        </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead style="display: none;">
                                        <tr>
                                            <th>Category</th>
                                            <th>Total Sales</th>
                                            <th>Total Cost</th>
                                            <th>Total Profit</th>
                                            <th>Profit Margin</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salesReportTableBody">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Click "Generate Report" to view sales data
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                    </div>
                </div>
                </div>
                </div>
                <!-- End Tab 1: Sales Report -->
                
                <!-- Tab 2: Sales Comparison Report -->
                <div id="tab-sales-comparison-report" class="report-tab-content">
                    <!-- Filters Section -->
                    <div class="card mb-4 no-print">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                                <i class="fas fa-filter me-2"></i>Comparison Filters
                        </h5>
                    </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Branch</label>
                                    <select class="form-select" id="comparisonReportBranch">
                                        <option value="">All Branches</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" id="comparisonReportCategory">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="comparisonReportDateFrom">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="comparisonReportDateTo">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="generateComparisonReportBtn">
                                        <i class="fas fa-chart-bar me-2"></i>Generate Report
                                    </button>
                                </div>
                            </div>
                    </div>
                </div>
                
                    <!-- Comparison Table -->
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h5 class="card-title mb-0">Sales Comparison Report</h5>
                                    <div id="comparisonReportSubtitle" class="text-muted small mt-1" style="display: none;"></div>
                                </div>
                                <button class="btn btn-success no-print" id="printComparisonReportBtn">
                                    <i class="fas fa-print me-2"></i>Print Report
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>Category</th>
                                            <th>Branch</th>
                                            <th>Total Sales</th>
                                            <th>Total Cost</th>
                                            <th>Total Profit</th>
                                            <th>Profit Margin</th>
                                        </tr>
                                    </thead>
                                    <tbody id="comparisonReportTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Click "Generate Report" to view comparison data
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Tab 2: Sales Comparison Report -->
                
                <!-- Tab 3: Date-Wise Sales Data -->
                <div id="tab-datewise-sales-report" class="report-tab-content">
                    <!-- Filters Section -->
                    <div class="card mb-4 no-print">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-filter me-2"></i>Search & Filters
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                        <div class="col-md-3">
                                    <label class="form-label">Search</label>
                                    <input type="text" class="form-control" id="datewiseSearch" placeholder="Search by date, branch, category...">
                                </div>
                                <div class="col-md-2">
                            <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="datewiseReportDateFrom">
                        </div>
                                <div class="col-md-2">
                            <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="datewiseReportDateTo">
                        </div>
                                <div class="col-md-2">
                            <label class="form-label">Branch</label>
                                    <select class="form-select" id="datewiseReportBranch">
                                <option value="">All Branches</option>
                            </select>
                        </div>
                                <div class="col-md-2">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" id="datewiseReportCategory">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="generateDatewiseReportBtn">
                                        <i class="fas fa-search me-2"></i>Search
                            </button>
                                </div>
                        </div>
                    </div>
                </div>
                
                    <!-- Date Wise Table -->
                <div class="card">
                    <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">Date-Wise Sales Data</h5>
                                <button class="btn btn-success no-print" id="printDatewiseReportBtn">
                                    <i class="fas fa-print me-2"></i>Print Report
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Branch</th>
                                            <th>Category</th>
                                            <th>Sales Amount</th>
                                            <th>Cost</th>
                                            <th>Profit</th>
                                        </tr>
                                    </thead>
                                    <tbody id="datewiseReportTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Use search to view date-wise sales data
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Tab 3: Date-Wise Sales Data -->
                
                <!-- Tab 4: Payment Reports -->
                <div id="tab-payment-reports" class="report-tab-content">
                    <!-- Filters Section -->
                    <div class="card mb-4 no-print">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-filter me-2"></i>Payment Report Filters
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Branch</label>
                                    <select class="form-select" id="paymentReportBranchFilter">
                                        <option value="">All Branches</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" id="paymentReportCategoryFilter">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="paymentReportFromDateFilter">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="paymentReportToDateFilter">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="generatePaymentReportBtn">
                                        <i class="fas fa-file-alt me-2"></i>Generate Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="row mb-4" id="paymentSummaryCards">
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Total Sales</h6>
                                    <h3 class="text-white mb-0" id="paymentSummaryTotalSales">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #136F63 0%, #17a2b8 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Total Cost</h6>
                                    <h3 class="text-white mb-0" id="paymentSummaryTotalCost">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Category Payments</h6>
                                    <h3 class="text-white mb-0" id="paymentSummaryCategoryPayments">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #CF2A2A 0%, #ff6b6b 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Balance Payment</h6>
                                    <h3 class="text-white mb-0" id="paymentSummaryBalancePayment">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Report Table -->
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h5 class="card-title mb-0">Payment Detail Report</h5>
                                    <div id="paymentReportSubtitle" class="text-muted small mt-1" style="display: none;"></div>
                                </div>
                                <button class="btn btn-success no-print" id="printPaymentReportBtn">
                                    <i class="fas fa-print me-2"></i>Print Report
                                </button>
                            </div>
                            
                            <!-- Branch Name Header -->
                            <div id="paymentReportBranchNameHeader" style="display: none; margin-bottom: 20px;">
                                <h4 style="font-size: 1.8rem; color: #495057; font-weight: 700; text-align: center; margin: 0;">
                                    <span id="paymentReportBranchName"></span>
                                </h4>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead style="display: none;">
                                        <tr>
                                            <th>Category</th>
                                            <th>Branch</th>
                                            <th>Sale</th>
                                            <th>Cost</th>
                                            <th>Category Payments</th>
                                            <th>Balance Payment</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentReportTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Click "Generate Report" to view payment data
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Tab 4: Payment Reports -->
                
                <!-- Tab 5: Department-Wise Report -->
                <div id="tab-department-wise-report" class="report-tab-content">
                    <!-- Filters Section -->
                    <div class="card mb-4 no-print">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-filter me-2"></i>Department-Wise Report Filters
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Branch</label>
                                    <select class="form-select" id="deptWiseReportBranch">
                                        <option value="">All Branches</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Department</label>
                                    <select class="form-select" id="deptWiseReportDepartment">
                                        <option value="">All Departments</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="deptWiseReportDateFrom">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="deptWiseReportDateTo">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="generateDeptWiseReportBtn">
                                        <i class="fas fa-file-alt me-2"></i>Generate Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="row mb-4" id="deptWiseSummaryCards">
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Gross Sale</h6>
                                    <h3 class="text-white mb-0" id="deptWiseSummaryGrossSale">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Total Discount</h6>
                                    <h3 class="text-white mb-0" id="deptWiseSummaryTotalDiscount">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #CF2A2A 0%, #ff6b6b 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Total Return</h6>
                                    <h3 class="text-white mb-0" id="deptWiseSummaryTotalReturn">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #136F63 0%, #17a2b8 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Total GST</h6>
                                    <h3 class="text-white mb-0" id="deptWiseSummaryTotalGST">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Net Sale Summary Card -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #4D4D4D 0%, #6c757d 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Net Sale</h6>
                                    <h2 class="text-white mb-0" id="deptWiseSummaryNetSale">0</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Department-Wise Report Table -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h5 class="card-title mb-0">Department-Wise Report</h5>
                                    <div id="deptWiseReportSubtitle" class="text-muted small mt-1" style="display: none;"></div>
                                </div>
                                <button class="btn btn-success no-print" id="printDeptWiseReportBtn">
                                    <i class="fas fa-print me-2"></i>Print Report
                                </button>
                            </div>
                            <h4 id="deptWiseReportBranchName" class="text-center mt-2 mb-3" style="display: none; font-weight: 600; background-color: #2c6e8a; color: white; padding: 15px; border-radius: 5px;"></h4>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead style="display: none;">
                                        <tr>
                                            <th>Department</th>
                                            <th class="text-end">Gross Sale</th>
                                            <th class="text-end">Discount Value</th>
                                            <th class="text-end">Discount %</th>
                                            <th class="text-end">Return</th>
                                            <th class="text-end">Sale Value</th>
                                            <th class="text-end">GST</th>
                                            <th class="text-end">Net Sale</th>
                                            <th class="text-end">Daily Sale Average</th>
                                        </tr>
                                    </thead>
                                    <tbody id="deptWiseReportTableBody">
                                        <tr>
                                            <td colspan="9" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Click "Generate Report" to view department sales data
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Tab 5: Department-Wise Report -->
                
                <!-- Tab 6: Sub-Department-Wise Report -->
                <div id="tab-sub-department-wise-report" class="report-tab-content">
                    <!-- Filters Section -->
                    <div class="card mb-4 no-print">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-filter me-2"></i>Sub-Department-Wise Report Filters
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Branch</label>
                                    <select class="form-select" id="subDeptWiseReportBranch">
                                        <option value="">All Branches</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Department</label>
                                    <select class="form-select" id="subDeptWiseReportDepartment">
                                        <option value="">All Departments</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Sub-Department</label>
                                    <select class="form-select" id="subDeptWiseReportSubDepartment">
                                        <option value="">All Sub-Departments</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="subDeptWiseReportDateFrom">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="subDeptWiseReportDateTo">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="generateSubDeptWiseReportBtn">
                                        <i class="fas fa-file-alt me-2"></i>Generate Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="row mb-4" id="subDeptWiseSummaryCards">
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Gross Sale</h6>
                                    <h3 class="text-white mb-0" id="subDeptWiseSummaryGrossSale">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Total Discount</h6>
                                    <h3 class="text-white mb-0" id="subDeptWiseSummaryTotalDiscount">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #CF2A2A 0%, #ff6b6b 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Total Return</h6>
                                    <h3 class="text-white mb-0" id="subDeptWiseSummaryTotalReturn">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #136F63 0%, #17a2b8 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Total GST</h6>
                                    <h3 class="text-white mb-0" id="subDeptWiseSummaryTotalGST">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Net Sale Summary Card -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #4D4D4D 0%, #6c757d 100%);">
                                <div class="card-body">
                                    <h6 class="text-white mb-2">Net Sale</h6>
                                    <h2 class="text-white mb-0" id="subDeptWiseSummaryNetSale">0</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sub-Department-Wise Report Table -->
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h5 class="card-title mb-0">Sub-Department-Wise Report</h5>
                                    <div id="subDeptWiseReportSubtitle" class="text-muted small mt-1" style="display: none;"></div>
                                </div>
                                <button class="btn btn-success no-print" id="printSubDeptWiseReportBtn">
                                    <i class="fas fa-print me-2"></i>Print Report
                                </button>
                            </div>
                            <h4 id="subDeptWiseReportBranchName" class="text-center mt-2 mb-3" style="display: none; font-weight: 600;"></h4>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead style="display: none;">
                                        <tr>
                                            <th>Sub-Department</th>
                                            <th>Department</th>
                                            <th>Branch</th>
                                            <th class="text-end">Gross Sale</th>
                                            <th class="text-end">Discount</th>
                                            <th class="text-end">Return</th>
                                            <th class="text-end">Sale Value</th>
                                            <th class="text-end">GST</th>
                                            <th class="text-end">Net Sale</th>
                                            <th class="text-end">Daily Sale Average</th>
                                        </tr>
                                    </thead>
                                    <tbody id="subDeptWiseReportTableBody">
                                        <tr>
                                            <td colspan="10" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Click "Generate Report" to view sub-department sales data
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Tab 6: Sub-Department-Wise Report -->
                
                <!-- Tab 7: Department-Wise Sale Comparison -->
                <div id="tab-department-wise-sale-comparison" class="report-tab-content">
                    <!-- Filters Section -->
                    <div class="card mb-4 no-print">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-filter me-2"></i>Department-Wise Sale Comparison Filters
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Branch</label>
                                    <select class="form-select" id="deptComparisonReportBranch">
                                        <option value="">All Branches</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Department</label>
                                    <select class="form-select" id="deptComparisonReportDepartment">
                                        <option value="">All Departments</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="deptComparisonReportDateFrom">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="deptComparisonReportDateTo">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="generateDeptComparisonReportBtn">
                                        <i class="fas fa-chart-pie me-2"></i>Generate Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Table -->
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h5 class="card-title mb-0">Department-Wise Sale Comparison</h5>
                                    <div id="deptComparisonReportSubtitle" class="text-muted small mt-1" style="display: none;"></div>
                                </div>
                                <button class="btn btn-success no-print" id="printDeptComparisonReportBtn">
                                    <i class="fas fa-print me-2"></i>Print Report
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead style="display: none;">
                                        <tr>
                                            <th>Rank</th>
                                            <th>Department</th>
                                            <th>Branch</th>
                                            <th class="text-end">Gross Sale</th>
                                            <th class="text-end">Discount</th>
                                            <th class="text-end">Return</th>
                                            <th class="text-end">Sale Value</th>
                                            <th class="text-end">GST</th>
                                            <th class="text-end">Net Sale</th>
                                            <th class="text-end">Profit Margin %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="deptComparisonReportTableBody">
                                        <tr>
                                            <td colspan="10" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Click "Generate Report" to view department comparison data
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Tab 7: Department-Wise Sale Comparison -->
                
                <!-- Tab 8: Branch-Wise Sale Comparison -->
                <div id="tab-branch-wise-sale-comparison" class="report-tab-content">
                    <!-- Filters Section -->
                    <div class="card mb-4 no-print">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-filter me-2"></i>Branch-Wise Sale Comparison Filters
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" id="branchComparisonReportCategory">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Department</label>
                                    <select class="form-select" id="branchComparisonReportDepartment">
                                        <option value="">All Departments</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="branchComparisonReportDateFrom">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="branchComparisonReportDateTo">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="generateBranchComparisonReportBtn">
                                        <i class="fas fa-chart-line me-2"></i>Generate Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Table -->
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h5 class="card-title mb-0">Branch-Wise Sale Comparison</h5>
                                    <div id="branchComparisonReportSubtitle" class="text-muted small mt-1" style="display: none;"></div>
                                </div>
                                <button class="btn btn-success no-print" id="printBranchComparisonReportBtn">
                                    <i class="fas fa-print me-2"></i>Print Report
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead style="display: none;">
                                        <tr>
                                            <th>Rank</th>
                                            <th>Branch</th>
                                            <th class="text-end">Gross Sale</th>
                                            <th class="text-end">Discount</th>
                                            <th class="text-end">Return</th>
                                            <th class="text-end">Sale Value</th>
                                            <th class="text-end">GST</th>
                                            <th class="text-end">Net Sale</th>
                                            <th class="text-end">Profit Margin %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="branchComparisonReportTableBody">
                                        <tr>
                                            <td colspan="9" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Click "Generate Report" to view branch comparison data
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Tab 8: Branch-Wise Sale Comparison -->
                
            </div>
            <!-- ========================================
                 END REPORTS SECTION
                 ======================================== -->
            
            <!-- ========================================
                 BRANCHES SECTION
                 ======================================== -->
            <div id="branches-section" class="content-section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Branch Management</h1>
                    <p class="dashboard-subtitle">Manage your pharmacy branches</p>
                </div>
                
                        <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="section-title mb-0">
                        <i class="fas fa-store"></i>Branches
                    </h2>
                    <button class="btn btn-primary" id="addBranchBtn">
                        <i class="fas fa-plus me-2"></i>Add Branch
                                </button>
                </div>
                
                <!-- View Toggle -->
                <div class="btn-group mb-3" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary active" id="branchCardViewBtn">
                        <i class="fas fa-th me-1"></i>Card View
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="branchTableViewBtn">
                        <i class="fas fa-table me-1"></i>Table View
                    </button>
                </div>
                
                <!-- Card View (Default) -->
                <div id="branchCardView">
                    <div class="row" id="branchesContainer">
                        <!-- Branch cards will be populated dynamically -->
                    </div>
                </div>
                
                <!-- Table View (Hidden by default) -->
                <div id="branchTableView" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover" id="branchesTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Address</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="branchesTableBody">
                                <!-- Table rows will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ========================================
                 BRANCHES SECTION
                 ======================================== -->
            <div id="branches-section" class="content-section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Branch Management</h1>
                    <p class="dashboard-subtitle">Manage your pharmacy branches</p>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="section-title mb-0">
                        <i class="fas fa-store"></i>Branches
                    </h2>
                    <button class="btn btn-primary" id="addBranchBtn">
                        <i class="fas fa-plus me-2"></i>Add Branch
                    </button>
                </div>
                
                <!-- View Toggle -->
                <div class="btn-group mb-3" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary active" id="branchCardViewBtn">
                        <i class="fas fa-th me-1"></i>Card View
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="branchTableViewBtn">
                        <i class="fas fa-table me-1"></i>Table View
                    </button>
                </div>
                
                <!-- Card View (Default) -->
                <div id="branchCardView">
                    <div class="row" id="branchesContainer">
                        <!-- Branch cards will be populated dynamically -->
                    </div>
                </div>
                
                <!-- Table View (Hidden by default) -->
                <div id="branchTableView" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover" id="branchesTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Address</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="branchesTableBody">
                                <!-- Table rows will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ========================================
                 GROUPS SECTION
                 ======================================== -->
            <div id="groups-section" class="content-section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">User Groups</h1>
                </div>
                
                <div id="permission-denied-banner" class="permission-denied d-none">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>You need administrator privileges to access this section.</span>
                </div>
                
                <!-- Two Panel Layout -->
                <div class="groups-container">
                    <!-- Left Panel: Group List -->
                    <div class="groups-left-panel">
                        <!-- Add New Group Button -->
                        <div class="mb-3">
                            <button type="button" class="btn btn-success" id="addNewGroupBtn">
                                <i class="fas fa-plus"></i> Add New Group
                            </button>
                        </div>
                        
                        <!-- Input Form -->
                        <div class="group-form-container">
                            <div class="group-form-row">
                                <div class="form-group">
                                    <label for="groupNameInput">Name</label>
                                    <input type="text" class="form-control" id="groupNameInput" placeholder="Enter group name">
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="groupActiveCheckbox" checked>
                                        <span>Active</span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <button type="button" class="btn btn-primary" id="saveGroupBtn">
                                        <i class="fas fa-check"></i> <span id="saveGroupBtnText">Save</span>
                                    </button>
                                    <button type="button" class="btn btn-secondary ms-2" id="cancelGroupBtn" onclick="resetGroupForm()" style="display: none;">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Groups Table -->
                        <div class="table-responsive">
                            <table class="table table-hover groups-table" id="groupsTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Active</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="groupsTableBody">
                                    <!-- Table rows will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Right Panel: Group Access Permissions -->
                    <div class="groups-right-panel">
                        <h3 class="group-access-title">Group Access</h3>
                        <div class="permissions-checklist" id="permissionsChecklist">
                            <!-- ADMINISTRATION Section -->
                            <div class="permission-category">
                                <div class="permission-category-header" data-bs-toggle="collapse" data-bs-target="#adminPermissions" aria-expanded="true">
                                    <span>ADMINISTRATION</span>
                                    <i class="fas fa-chevron-down permission-chevron"></i>
                                </div>
                                <div class="collapse show" id="adminPermissions">
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="admin">
                                            <span>Admin</span>
                                        </label>
                                    </div>
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="branches">
                                            <span>Branches</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- OVERVIEW Section -->
                            <div class="permission-category">
                                <div class="permission-category-header" data-bs-toggle="collapse" data-bs-target="#overviewPermissions" aria-expanded="true">
                                    <span>OVERVIEW</span>
                                    <i class="fas fa-chevron-down permission-chevron"></i>
                                </div>
                                <div class="collapse show" id="overviewPermissions">
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="dashboard">
                                            <span>Dashboard</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- INVENTORY Section -->
                            <div class="permission-category">
                                <div class="permission-category-header" data-bs-toggle="collapse" data-bs-target="#inventoryPermissions" aria-expanded="true">
                                    <span>INVENTORY</span>
                                    <i class="fas fa-chevron-down permission-chevron"></i>
                                </div>
                                <div class="collapse show" id="inventoryPermissions">
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="categories">
                                            <span>Categories</span>
                                        </label>
                                    </div>
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="departments">
                                            <span>Departments</span>
                                        </label>
                                    </div>
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="suppliers">
                                            <span>Suppliers</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SALES Section -->
                            <div class="permission-category">
                                <div class="permission-category-header" data-bs-toggle="collapse" data-bs-target="#salesPermissions" aria-expanded="true">
                                    <span>SALES</span>
                                    <i class="fas fa-chevron-down permission-chevron"></i>
                                </div>
                                <div class="collapse show" id="salesPermissions">
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="sales">
                                            <span>Sales Entry</span>
                                        </label>
                                    </div>
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="sales-edit">
                                            <span>Edit Sale</span>
                                        </label>
                                    </div>
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="sales-delete">
                                            <span>Delete Sale</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- PAYMENTS Section -->
                            <div class="permission-category">
                                <div class="permission-category-header" data-bs-toggle="collapse" data-bs-target="#paymentsPermissions" aria-expanded="true">
                                    <span>PAYMENTS</span>
                                    <i class="fas fa-chevron-down permission-chevron"></i>
                                </div>
                                <div class="collapse show" id="paymentsPermissions">
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="payment-dashboard">
                                            <span>Payment Dashboard</span>
                                        </label>
                                    </div>
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="payment-vouchers">
                                            <span>Payment Vouchers</span>
                                        </label>
                                    </div>
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="payment-voucher-list">
                                            <span>Voucher List</span>
                                        </label>
                                    </div>
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="category-voucher-list">
                                            <span>Category Voucher List</span>
                                        </label>
                                    </div>
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="payment-reports">
                                            <span>Payment Reports</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- PAYROLL MODULE Section -->
                            <div class="permission-category">
                                <div class="permission-category-header" data-bs-toggle="collapse" data-bs-target="#payrollPermissions" aria-expanded="true">
                                    <span>PAYROLL MODULE</span>
                                    <i class="fas fa-chevron-down permission-chevron"></i>
                                </div>
                                <div class="collapse show" id="payrollPermissions">
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="employees">
                                            <span>Employees</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SUPPORT Section -->
                            <div class="permission-category">
                                <div class="permission-category-header" data-bs-toggle="collapse" data-bs-target="#supportPermissions" aria-expanded="true">
                                    <span>SUPPORT</span>
                                    <i class="fas fa-chevron-down permission-chevron"></i>
                                </div>
                                <div class="collapse show" id="supportPermissions">
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="support-chat">
                                            <span>Support Chat</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- REPORTS Section -->
                            <div class="permission-category">
                                <div class="permission-category-header" data-bs-toggle="collapse" data-bs-target="#reportsPermissions" aria-expanded="true">
                                    <span>REPORTS</span>
                                    <i class="fas fa-chevron-down permission-chevron"></i>
                                </div>
                                <div class="collapse show" id="reportsPermissions">
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="sales-report">
                                            <span>Sales Report</span>
                                        </label>
                                    </div>
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="sales-comparison-report">
                                            <span>Sales Comparison</span>
                                        </label>
                                    </div>
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="datewise-sales-report">
                                            <span>Date-Wise Sales</span>
                                        </label>
                                    </div>
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="department-wise-report">
                                            <span>Department-Wise Report</span>
                                        </label>
                                    </div>
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="sub-department-wise-report">
                                            <span>Sub-Department-Wise Report</span>
                                        </label>
                                    </div>
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="department-wise-sale-comparison">
                                            <span>Department-Wise Sale Comparison</span>
                                        </label>
                                    </div>
                                    <div class="permission-item">
                                        <label class="permission-label">
                                            <input type="checkbox" class="permission-checkbox" data-permission="branch-wise-sale-comparison">
                                            <span>Branch-Wise Sale Comparison</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========================================
                 USERS SECTION
                 ======================================== -->
            <div id="users-section" class="content-section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">User Management</h1>
                    <p class="dashboard-subtitle">Manage system users and their permissions</p>
                </div>
                
                <div id="permission-denied-banner-users" class="permission-denied d-none">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>You need administrator privileges to access this section.</span>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                    <h2 class="section-title mb-0">
                        <i class="fas fa-user"></i>Users
                    </h2>
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-warning" id="promoteUserBtn">
                            <i class="fas fa-crown"></i>
                            <span class="d-none d-lg-inline ms-1">Promote to Admin</span>
                            <span class="d-lg-none ms-1">Promote</span>
                        </button>
                        <button class="btn btn-primary" id="addUserBtn">
                            <i class="fas fa-plus"></i>
                            <span class="ms-1">Add User</span>
                        </button>
                    </div>
                </div>
                
                <!-- View Toggle -->
                <div class="btn-group mb-3" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary active" id="userCardViewBtn">
                        <i class="fas fa-th me-1"></i>Card View
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="userTableViewBtn">
                        <i class="fas fa-table me-1"></i>Table View
                    </button>
                </div>
                
                <!-- Card View (Default) -->
                <div id="userCardView">
                    <div class="row" id="usersContainer">
                        <!-- User cards will be populated dynamically -->
                    </div>
                </div>
                
                <!-- Table View (Hidden by default) -->
                <div id="userTableView" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover" id="usersTable">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Group</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Table rows will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ========================================
                 SETTINGS SECTION
                 ======================================== -->
            <div id="settings-section" class="content-section">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Settings</h1>
                    <p class="dashboard-subtitle">Configure your dashboard preferences</p>
                </div>
                
                <div id="permission-denied-banner-settings" class="permission-denied d-none">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>You need administrator privileges to access this section.</span>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">General Settings</h5>
                        <form id="settingsForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="companyName" class="form-label">Company Name</label>
                                    <input type="text" class="form-control" id="companyName" value="D.Watson Group of Pharmacy">
                                </div>
                                <div class="col-md-6">
                                    <label for="currency" class="form-label">Currency</label>
                                    <select class="form-select" id="currency">
                                        <option value="" selected>Select Currency</option>
                                        <option value="USD">US Dollar (USD)</option>
                                        <option value="EUR">Euro (EUR)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="dateFormat" class="form-label">Date Format</label>
                                    <select class="form-select" id="dateFormat">
                                        <option value="DD/MM/YYYY" selected>DD/MM/YYYY</option>
                                        <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                        <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="itemsPerPage" class="form-label">Items Per Page</label>
                                    <select class="form-select" id="itemsPerPage">
                                        <option value="10" selected>10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Data Management</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-primary w-100" id="backupDataBtn">
                                    <i class="fas fa-download me-2"></i>Backup Data
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-secondary w-100" id="restoreDataBtn">
                                    <i class="fas fa-upload me-2"></i>Restore Data
                                </button>
                                <input type="file" id="restoreFile" accept=".json" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- API Keys Management Section (Admin Only) -->
                <div class="card mt-4 admin-only" id="apiKeysSection">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-key me-2"></i>API Keys Management
                            </h5>
                            <button class="btn btn-primary" id="createApiKeyBtn">
                                <i class="fas fa-plus me-2"></i>Create API Key
                            </button>
                        </div>
                        <p class="text-muted mb-4">
                            Generate API keys to allow external applications to access your data securely. API keys provide programmatic access without requiring user login.
                        </p>
                        <div id="apiKeysList" class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>API Key</th>
                                        <th>Status</th>
                                        <th>Usage</th>
                                        <th>Last Used</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="apiKeysTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading API keys...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCategoryModalLabel">Add New Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">Category Name</label>
                            <input type="text" class="form-control" id="categoryName" required>
                        </div>
                        <div class="mb-3">
                            <label for="categoryDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="categoryColor" class="form-label">Color</label>
                            <select class="form-select" id="categoryColor">
                                <option value="success">Green</option>
                                <option value="primary">Blue</option>
                                <option value="warning">Yellow</option>
                                <option value="info">Cyan</option>
                                <option value="danger">Red</option>
                                <option value="secondary">Gray</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="categorySequence" class="form-label">Custom Sequence</label>
                            <input type="number" class="form-control" id="categorySequence" min="0" step="1" placeholder="Auto if left empty">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveCategoryBtn">Save Category</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Branch Modal -->
    <div class="modal fade" id="addBranchModal" tabindex="-1" aria-labelledby="addBranchModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addBranchModalLabel">Add New Branch</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="branchForm">
                        <div class="mb-3">
                            <label for="branchName" class="form-label">Branch Name</label>
                            <input type="text" class="form-control" id="branchName" required>
                        </div>
                        <div class="mb-3">
                            <label for="branchAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="branchAddress" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="branchPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="branchPhone" required>
                        </div>
                        <div class="mb-3">
                            <label for="branchEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="branchEmail">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveBranchBtn">Save Branch</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Department Modal -->
    <div class="modal fade" id="addDepartmentModal" tabindex="-1" aria-labelledby="addDepartmentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addDepartmentModalLabel">Add New Department</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="departmentForm">
                        <div class="mb-3">
                            <label for="departmentBranchId" class="form-label">Branch <span class="text-danger">*</span></label>
                            <select class="form-select" id="departmentBranchId" required>
                                <option value="">-- Select Branch --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="departmentName" class="form-label">Department Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="departmentName" required>
                        </div>
                        <div class="mb-3">
                            <label for="departmentDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="departmentDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="departmentSequence" class="form-label">Sequence <span class="text-muted">(for ordering)</span></label>
                            <input type="number" class="form-control" id="departmentSequence" min="0" value="0">
                            <small class="form-text text-muted">Lower numbers appear first in dropdowns and reports</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveDepartmentBtn">Save Department</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Sub-Department Modal -->
    <div class="modal fade" id="addSubDepartmentModal" tabindex="-1" aria-labelledby="addSubDepartmentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSubDepartmentModalLabel">Add New Sub-Department</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="subDepartmentForm">
                        <div class="alert alert-info mb-3" id="subDepartmentInfoAlert" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Department:</strong> <span id="subDepartmentDisplayName"></span>
                        </div>
                        <div class="mb-3" id="subDepartmentDepartmentSelectWrapper">
                            <label for="subDepartmentDepartmentId" class="form-label">Department <span class="text-danger">*</span></label>
                            <select class="form-select" id="subDepartmentDepartmentId" required>
                                <option value="">Select Department</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="subDepartmentName" class="form-label">Sub-Department Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="subDepartmentName" required placeholder="Enter sub-department name">
                        </div>
                        <div class="mb-3">
                            <label for="subDepartmentDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="subDepartmentDescription" rows="3" placeholder="Enter description (optional)"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="subDepartmentSequence" class="form-label">Sequence <span class="text-muted">(for ordering)</span></label>
                            <input type="number" class="form-control" id="subDepartmentSequence" min="0" value="0">
                            <small class="form-text text-muted">Lower numbers appear first in dropdowns and reports</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSubDepartmentBtn">Save Sub-Department</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Sub-Departments Modal -->
    <div class="modal fade" id="viewSubDepartmentsModal" tabindex="-1" aria-labelledby="viewSubDepartmentsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewSubDepartmentsModalLabel">Sub-Departments</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="viewSubDepartmentsModalBody">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create API Key Modal -->
    <div class="modal fade" id="createApiKeyModal" tabindex="-1" aria-labelledby="createApiKeyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createApiKeyModalLabel">
                        <i class="fas fa-key me-2"></i>Create New API Key
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="apiKeyForm">
                        <div class="mb-3">
                            <label for="apiKeyName" class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="apiKeyName" placeholder="e.g., Mobile App, External Integration" required>
                            <div class="form-text">A descriptive name to identify this API key</div>
                        </div>
                        <div class="mb-3">
                            <label for="apiKeyDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="apiKeyDescription" rows="3" placeholder="Optional description for this API key"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="apiKeyExpiresAt" class="form-label">Expiration Date (Optional)</label>
                            <input type="date" class="form-control" id="apiKeyExpiresAt">
                            <div class="form-text">Leave empty for no expiration</div>
                        </div>
                    </form>
                    
                    <!-- API Key Display (shown after creation) -->
                    <div id="apiKeyResult" class="d-none mt-4">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Important:</strong> Save these credentials now! The API secret will not be shown again.
                        </div>
                        <div class="mb-3">
                            <label class="form-label">API Key</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="generatedApiKey" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('generatedApiKey')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">API Secret</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="generatedApiSecret" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('generatedApiSecret')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeApiKeyModal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveApiKeyBtn">
                        <i class="fas fa-plus me-2"></i>Create API Key
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Group Modal -->
    <div class="modal fade" id="addGroupModal" tabindex="-1" aria-labelledby="addGroupModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addGroupModalLabel">Add New Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="groupForm">
                        <div class="mb-3">
                            <label for="groupName" class="form-label">Group Name</label>
                            <input type="text" class="form-control" id="groupName" required>
                        </div>
                        <div class="mb-3">
                            <label for="groupDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="groupDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Permissions</label>
                            <div class="permission-grid" id="permissionsGrid">
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-dashboard" value="dashboard">
                                    <label for="perm-dashboard">Dashboard</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-categories" value="categories">
                                    <label for="perm-categories">Categories</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-departments" value="departments">
                                    <label for="perm-departments">Departments</label>
                                </div>
                <div class="permission-item">
                    <input type="checkbox" id="perm-suppliers" value="suppliers">
                    <label for="perm-suppliers">Suppliers</label>
                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-sales" value="sales">
                                    <label for="perm-sales">Sales Entry</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-payment-dashboard" value="payment-dashboard">
                                    <label for="perm-payment-dashboard">Payment Dashboard</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-payment-vouchers" value="payment-vouchers">
                                    <label for="perm-payment-vouchers">Payment Vouchers</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-payment-voucher-list" value="payment-voucher-list">
                                    <label for="perm-payment-voucher-list">Voucher List</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-payment-reports" value="payment-reports">
                                    <label for="perm-payment-reports">Payment Reports</label>
                                </div>
                <div class="permission-item">
                    <input type="checkbox" id="perm-payment-edit" value="payment-edit">
                    <label for="perm-payment-edit">Edit Voucher</label>
                </div>
                <div class="permission-item">
                    <input type="checkbox" id="perm-payment-delete" value="payment-delete">
                    <label for="perm-payment-delete">Delete Voucher</label>
                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-category-voucher" value="category-voucher">
                                    <label for="perm-category-voucher">Category Voucher</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-category-voucher-list" value="category-voucher-list">
                                    <label for="perm-category-voucher-list">Category Voucher List</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-category-voucher-edit" value="category-voucher-edit">
                                    <label for="perm-category-voucher-edit">Edit Category Voucher</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-category-voucher-delete" value="category-voucher-delete">
                                    <label for="perm-category-voucher-delete">Delete Category Voucher</label>
                                </div>
                                <div class="permission-item">
                                    <label style="font-weight: 600; color: var(--primary-color);">Reports</label>
                                </div>
                                <div class="permission-item" style="margin-left: 20px;">
                                    <label style="font-weight: 600; color: #2c6e8a; font-size: 0.9rem;">Warehouse Reports</label>
                                </div>
                                <div class="permission-item" style="margin-left: 40px;">
                                    <input type="checkbox" id="perm-sales-report" value="sales-report">
                                    <label for="perm-sales-report">Sales Report</label>
                                </div>
                                <div class="permission-item" style="margin-left: 40px;">
                                    <input type="checkbox" id="perm-sales-comparison-report" value="sales-comparison-report">
                                    <label for="perm-sales-comparison-report">Sales Comparison</label>
                                </div>
                                <div class="permission-item" style="margin-left: 40px;">
                                    <input type="checkbox" id="perm-datewise-sales-report" value="datewise-sales-report">
                                    <label for="perm-datewise-sales-report">Date-Wise Sales</label>
                                </div>
                                <div class="permission-item" style="margin-left: 20px;">
                                    <label style="font-weight: 600; color: #2c6e8a; font-size: 0.9rem;">Shop Reports</label>
                                </div>
                                <div class="permission-item" style="margin-left: 40px;">
                                    <input type="checkbox" id="perm-department-wise-report" value="department-wise-report">
                                    <label for="perm-department-wise-report">Department-Wise Report</label>
                                </div>
                                <div class="permission-item" style="margin-left: 40px;">
                                    <input type="checkbox" id="perm-sub-department-wise-report" value="sub-department-wise-report">
                                    <label for="perm-sub-department-wise-report">Sub-Department-Wise Report</label>
                                </div>
                                <div class="permission-item" style="margin-left: 40px;">
                                    <input type="checkbox" id="perm-department-wise-sale-comparison" value="department-wise-sale-comparison">
                                    <label for="perm-department-wise-sale-comparison">Department-Wise Sale Comparison</label>
                                </div>
                                <div class="permission-item" style="margin-left: 40px;">
                                    <input type="checkbox" id="perm-branch-wise-sale-comparison" value="branch-wise-sale-comparison">
                                    <label for="perm-branch-wise-sale-comparison">Branch-Wise Sale Comparison</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-branches" value="branches">
                                    <label for="perm-branches">Branches</label>
                                </div>
                <div class="permission-item">
                    <input type="checkbox" id="perm-sales-edit" value="sales-edit">
                    <label for="perm-sales-edit">Edit Sale</label>
                </div>
                <div class="permission-item">
                    <input type="checkbox" id="perm-sales-delete" value="sales-delete">
                    <label for="perm-sales-delete">Delete Sale</label>
                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-groups" value="groups">
                                    <label for="perm-groups">Groups</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-users" value="users">
                                    <label for="perm-users">Users</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm-settings" value="settings">
                                    <label for="perm-settings">Settings</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveGroupBtn">Save Group</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <div class="mb-3">
                            <label for="userName" class="form-label">Username</label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                        <div class="mb-3">
                            <label for="userFullName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="userFullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="userEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="userPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="userPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="userGroup" class="form-label">Group</label>
                            <select class="form-select" id="userGroup" required>
                                <option value="" selected disabled>Select Group</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Assigned Branches</label>
                            <div class="branch-selector" id="userBranchesSelector">
                                <!-- Branch checkboxes will be populated dynamically -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveUserBtn">Save User</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Promote User Modal -->
    <div class="modal fade" id="promoteUserModal" tabindex="-1" aria-labelledby="promoteUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="promoteUserModalLabel">
                        <i class="fas fa-crown me-2"></i>Promote User to Admin
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This action will give the user full administrative privileges including access to all sections and the ability to manage other users.
                    </div>
                    <form id="promoteUserForm">
                        <div class="mb-3">
                            <label for="promoteUsername" class="form-label">Username to Promote</label>
                            <input type="text" class="form-control" id="promoteUsername" placeholder="Enter username (e.g., myadmin)" required>
                            <div class="form-text">Enter the exact username of the user you want to promote to admin.</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmAdminPassword" class="form-label">Admin Password</label>
                            <input type="password" class="form-control" id="confirmAdminPassword" placeholder="Enter admin password" required>
                            <div class="form-text">Enter the admin password to confirm this action.</div>
                        </div>
                        <div id="promoteUserError" class="alert alert-danger d-none"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirmPromoteBtn">
                        <i class="fas fa-crown me-2"></i>Promote to Admin
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Supplier Modal -->
    <div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="addSupplierModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSupplierModalLabel">Add New Supplier</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="supplierForm">
                        <div class="mb-3">
                            <label for="supplierName" class="form-label">Supplier Name</label>
                            <input type="text" class="form-control" id="supplierName" required>
                        </div>
                        <div class="mb-3">
                            <label for="supplierDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="supplierDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="supplierContact" class="form-label">Contact Person</label>
                            <input type="text" class="form-control" id="supplierContact">
                        </div>
                        <div class="mb-3">
                            <label for="supplierPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="supplierPhone">
                        </div>
                        <div class="mb-3">
                            <label for="supplierEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="supplierEmail">
                        </div>
                        <div class="mb-3">
                            <label for="supplierAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="supplierAddress" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSupplierBtn">Save Supplier</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Sale Modal -->
    <div class="modal fade" id="editSaleModal" tabindex="-1" aria-labelledby="editSaleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSaleModalLabel">Edit Sale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editSaleForm">
                        <input type="hidden" id="editSaleId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editSaleDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="editSaleDate" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editSaleBranch" class="form-label">Branch</label>
                                <select class="form-select" id="editSaleBranch" required>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editSaleCategory" class="form-label">Category</label>
                                <select class="form-select" id="editSaleCategory" required>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editSaleAmount" class="form-label">Sales Amount</label>
                                <input type="number" class="form-control" id="editSaleAmount" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editSaleCost" class="form-label">Cost Amount</label>
                            <input type="number" class="form-control" id="editSaleCost" min="0" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="editSaleNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="editSaleNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateSaleBtn">Update Sale</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Department Sale Modal -->
    <div class="modal fade" id="editDeptSaleModal" tabindex="-1" aria-labelledby="editDeptSaleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editDeptSaleModalLabel">Edit Department Sale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editDeptSaleForm">
                        <input type="hidden" id="editDeptSaleId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editDeptSaleDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="editDeptSaleDate" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editDeptSaleBranch" class="form-label">Branch</label>
                                <select class="form-select" id="editDeptSaleBranch" required>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editDeptSaleDepartment" class="form-label">Department</label>
                                <select class="form-select" id="editDeptSaleDepartment" required>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editDeptSaleSubDepartment" class="form-label">Sub-Department</label>
                                <select class="form-select" id="editDeptSaleSubDepartment" required>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editDeptSaleGrossSale" class="form-label">Gross Sale</label>
                                <input type="number" class="form-control" id="editDeptSaleGrossSale" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editDeptSaleDiscount" class="form-label">Discount Amount</label>
                                <input type="number" class="form-control" id="editDeptSaleDiscount" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editDeptSaleReturn" class="form-label">Return Amount</label>
                                <input type="number" class="form-control" id="editDeptSaleReturn" min="0" step="0.01" value="0">
                            </div>
                            <div class="col-md-6">
                                <label for="editDeptSaleGST" class="form-label">GST</label>
                                <input type="number" class="form-control" id="editDeptSaleGST" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editDeptSaleNetSale" class="form-label">Net Sale</label>
                            <input type="number" class="form-control" id="editDeptSaleNetSale" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editDeptSaleNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="editDeptSaleNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateDeptSaleBtn">Update Sale</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Payment Modal -->
    <div class="modal fade" id="editPaymentModal" tabindex="-1" aria-labelledby="editPaymentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPaymentModalLabel">Edit Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editPaymentForm">
                        <div class="mb-3">
                            <label for="editPaymentDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="editPaymentDate" required>
                        </div>
                        
        </div>
    </div>
    
    <!-- ========================================
         DYNAMIC VIEW AND SECTION LOADER
         ======================================== -->
    <script>
        // Make loadView globally accessible
        window.viewFiles = {
            'dashboard': 'views/dashboard.html',
            'categories': 'views/categories.html',
            'suppliers': 'views/suppliers.html',
            'sales': 'views/sales.html',
            'departments': 'views/departments.html',
            'payment-dashboard': 'views/payment-dashboard.html',
            'payment-vouchers': 'views/payment-vouchers.html',
            'payment-voucher-list': 'views/payment-voucher-list.html',
            'category-voucher-simple-list': 'views/category-voucher-simple-list.html',
            'category-voucher-list': 'views/category-voucher-list.html',
            'payment-reports': 'views/payment-reports.html',
            'reports': 'views/reports.html',
            'branches': 'views/branches.html',
            'groups': 'views/groups.html',
            'users': 'views/users.html',
            'settings': 'views/settings.html',
            'employees': 'views/employees.html',
            'employee-list': 'views/employee-list.html'
        };
        
        // Make sectionJSFiles globally accessible
        window.sectionJSFiles = {
            'dashboard': 'sections/dashboard.js',
            'categories': 'sections/categories.js',
            'suppliers': 'sections/suppliers.js',
            'sales': 'sections/sales.js',
            'departments': 'sections/departments.js',
            'payment-dashboard': 'sections/payment-dashboard.js',
            'payment-vouchers': 'sections/payment-vouchers.js',
            'payment-voucher-list': 'sections/payment-voucher-list.js',
            'category-voucher-simple-list': 'sections/category-voucher-simple-list.js',
            'category-voucher-list': 'sections/category-voucher-list.js',
            'employees': 'sections/employees.js',
            'employee-list': 'sections/employee-list.js',
            'reports': 'sections/reports.js',
            'branches': 'sections/branches.js',
            'groups': 'sections/groups.js',
            'users': 'sections/users.js',
            'settings': 'sections/settings.js'
        };
        
        // Loaded sections cache - make globally accessible
        window.loadedSections = window.loadedSections || new Set();
        window.loadedScripts = window.loadedScripts || new Set();
        
        // Function to load a view HTML file - make globally accessible
        window.loadView = async function loadView(sectionName) {
            const sectionId = sectionName + '-section';
            const sectionElement = document.getElementById(sectionId);
            if (!sectionElement) {
                console.error('Section element not found:', sectionId);
                return Promise.reject(new Error('Section element not found'));
            }
            
            // If already loaded, clear and reload to prevent duplicates
            // But first check if content is actually there
            if (window.loadedSections.has(sectionName)) {
                // Double-check: if section is empty, reload it
                if (sectionElement.innerHTML.trim() === '') {
                    console.log(' Section marked as loaded but empty, reloading:', sectionName);
                    window.loadedSections.delete(sectionName);
                } else {
                    // Already loaded and has content, don't reload
                    return Promise.resolve();
                }
            }
            
            const viewFile = window.viewFiles[sectionName];
            if (!viewFile) {
                console.warn('No view file found for section:', sectionName);
                return Promise.reject(new Error('No view file found'));
            }
            
            try {
                const response = await fetch(viewFile);
                if (!response.ok) {
                    throw new Error(`Failed to load ${viewFile}: ${response.status}`);
                }
                const html = await response.text();
                
                // IMPORTANT: Clear the section element first to prevent duplicates
                sectionElement.innerHTML = '';
                
                // Parse the HTML and extract inner content (remove outer wrapper div if present)
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html.trim();
                
                // Check if the loaded HTML has a wrapper div with the section ID
                const wrapperDiv = tempDiv.querySelector(`#${sectionId}`);
                if (wrapperDiv) {
                    // Extract only the inner content, excluding the wrapper
                    sectionElement.innerHTML = wrapperDiv.innerHTML;
                } else {
                    // If no wrapper found, use the HTML as-is (but check if it starts with a wrapper div)
                    // Try to find any wrapper div with the section ID in the HTML string
                    const wrapperMatch = html.match(new RegExp(`<div[^>]*id=["']${sectionId.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}["'][^>]*>([\\s\\S]*?)</div>`, 'i'));
                    if (wrapperMatch && wrapperMatch[1]) {
                        sectionElement.innerHTML = wrapperMatch[1].trim();
                    } else {
                        sectionElement.innerHTML = html;
                    }
                }
                
                window.loadedSections.add(sectionName);
                
                // Load corresponding JS file after HTML is loaded
                window.loadSectionJS(sectionName);
                
                // Wait a bit for DOM to update, then trigger any initialization
                return new Promise((resolve) => {
                    // Use requestAnimationFrame to ensure DOM is updated
                    requestAnimationFrame(() => {
                        // Trigger custom event for section loaded
                        const event = new CustomEvent('sectionLoaded', { detail: { sectionName, sectionId } });
                        document.dispatchEvent(event);
                        resolve();
                    });
                });
            } catch (error) {
                console.error('Error loading view:', error);
                sectionElement.innerHTML = `<div class="alert alert-danger">Error loading ${sectionName} view: ${error.message}</div>`;
                return Promise.reject(error);
            }
        }
        
        // Function to load a section JS file - make globally accessible
        window.loadSectionJS = function loadSectionJS(sectionName) {
            if (window.loadedScripts.has(sectionName)) {
                return;
            }
            
            const jsFile = window.sectionJSFiles[sectionName];
            if (!jsFile) {
                console.warn('No JS file found for section:', sectionName);
                return;
            }
            
            const script = document.createElement('script');
            script.src = jsFile;
            script.onerror = function() {
                console.error('Failed to load script:', jsFile);
            };
            document.head.appendChild(script);
            window.loadedScripts.add(sectionName);
        };
        
        // Load dashboard on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                if (typeof window.loadView === 'function') {
                    window.loadView('dashboard');
                }
            });
        } else {
            if (typeof window.loadView === 'function') {
                window.loadView('dashboard');
            }
        }
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- ========================================
         JAVASCRIPT SECTION
         ======================================== -->
    <!-- 
         NOTE: The following JavaScript code contains some functions that may be duplicated
         in the section JS files (sections/*.js). Code that handles section-specific
         initialization (like branch view toggle, category view toggle, etc.) should be
         in the respective section JS files and can be commented out here if duplicated.
         
         Sections that have their own JS files:
         - sections/dashboard.js
         - sections/branches.js
         - sections/categories.js
         - sections/suppliers.js
         - sections/sales.js
         - sections/departments.js
         - sections/payment-dashboard.js
         - sections/payment-vouchers.js
         - sections/payment-voucher-list.js
         - sections/category-voucher-simple-list.js
         - sections/category-voucher-list.js
         - sections/reports.js
         - sections/groups.js
         - sections/users.js
         - sections/settings.js
         
         If you find duplicate code in this file that exists in section JS files,
         please comment it out to avoid conflicts.
    -->
    <script>
        // ========================================
        // API SERVICE LAYER
        // ========================================
        
            // API Service Layer with Authentication
            class APIService {
            constructor() {
                this.baseURL = '/api';
                this.token = localStorage.getItem('authToken') || null;
            }
            
            // Set authentication token
            setToken(token) {
                this.token = token;
                localStorage.setItem('authToken', token);
            }
            
            // Clear authentication token
            clearToken() {
                this.token = null;
                localStorage.removeItem('authToken');
            }
            
            // Retry mechanism for failed requests
            async requestWithRetry(endpoint, options = {}, maxRetries = 3) {
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        return await this.request(endpoint, options);
                    } catch (error) {
                        
                        // Don't retry for authentication errors
                        if (error.message.includes('Authentication failed') || 
                            error.message.includes('401')) {
                            throw error;
                        }
                        
                        // Don't retry for client errors (4xx)
                        if (error.message.includes('400') || 
                            error.message.includes('403') || 
                            error.message.includes('404')) {
                            throw error;
                        }
                        
                        // If this is the last attempt, throw the error
                        if (attempt === maxRetries) {
                            throw error;
                        }
                        
                        // Wait before retrying
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    }
                }
            }
            
            async request(endpoint, options = {}) {
                // Clean endpoint - ensure it starts with /
                let cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
                
                // Add cache-busting parameter to prevent 304 responses
                const separator = cleanEndpoint.includes('?') ? '&' : '?';
                const url = `${this.baseURL}${cleanEndpoint}${separator}_t=${Date.now()}`;
                
                // Prepare headers
                const headers = {
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache',
                    ...options.headers
                };
                
                // Add authorization header if token exists
                if (this.token) {
                    headers['Authorization'] = `Bearer ${this.token}`;
                }
                
                const config = {
                    headers,
                    ...options
                };
                
                try {
                    const response = await fetch(url, config);
                    
                    // Handle 401 Unauthorized specifically
                    if (response.status === 401) {
                        this.clearToken();
                        showLoginSection();
                        throw new Error('Authentication failed. Please login again.');
                    }
                    
                    if (!response.ok) {
                        let errorMessage = `HTTP error! status: ${response.status}`;
                        try {
                            // Try to parse as JSON first
                            const errorResponse = await response.json();
                            if (errorResponse && errorResponse.error) {
                                errorMessage = errorResponse.error;
                            }
                        } catch (e) {
                            // If JSON parsing fails, get text response
                            const text = await response.text();
                            console.error('Error response (text):', text);
                            
                            // Check if it's HTML (likely 404 page)
                            if (text.includes('<!DOCTYPE') || text.includes('<html')) {
                                errorMessage = `API endpoint not found: ${endpoint}`;
                            } else {
                                errorMessage = text || `Request failed: ${response.status}`;
                            }
                        }
                        throw new Error(errorMessage);
                    }
                    
                    // Parse success response safely
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                    const data = await response.json();
                    return data;
                    } else {
                        const text = await response.text();
                        console.error('Unexpected non-JSON success response:', text.slice(0, 200));
                        throw new Error(`API endpoint returned non-JSON response for ${endpoint}`);
                    }
                } catch (error) {
                    console.error(` API request failed for ${endpoint}:`, error);
                    throw error;
                }
            }
            
            // Authentication methods
            async login(credentials) {
                const response = await this.request('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify(credentials)
                });
                
                if (response.token) {
                    this.setToken(response.token);
                    return response;
                }
                
                throw new Error('Login failed: No token received');
            }
            
            async logout() {
                try {
                    await this.request('/auth/logout', {
                        method: 'POST'
                    });
                } catch (error) {
                    console.error('Logout API call failed:', error);
                } finally {
                    this.clearToken();
                }
            }
            
            async signup(userData) {
                try {
                    const response = await this.request('/auth/signup', {
                        method: 'POST',
                        body: JSON.stringify(userData)
                    });
                    
                    if (response.token) {
                        this.setToken(response.token);
                        return response;
                    }
                    
                    throw new Error('Signup failed: No token received');
                } catch (error) {
                    // Enhanced error handling for signup
                    console.error('Signup API error:', error);
                    
                    // Check if it's a network error or server error
                    if (error.message.includes('API endpoint not found')) {
                        throw new Error('Signup service is currently unavailable. Please try again later.');
                    } else if (error.message.includes('Failed to fetch')) {
                        throw new Error('Network error. Please check your connection and try again.');
                    }
                    
                    throw error;
                }
            }
            
            async getCurrentUser() {
                return this.request('/auth/me');
            }
            
            async promoteUser(username, adminPassword) {
                return this.request('/admin/promote-user', {
                    method: 'POST',
                    body: JSON.stringify({ username, adminPassword })
                });
            }
            
            async getUserByUsername(username) {
                return this.request(`/users/username/${username}`);
            }
            
            // Health
            async getHealth() {
                return this.request('/health');
            }
            
            // Settings
            async getSettings() {
                return this.request('/settings');
            }
            
            async updateSettings(settings) {
                return this.request('/settings', {
                    method: 'PUT',
                    body: JSON.stringify(settings)
                });
            }
            
            // Data Restore
            async restoreData(backupData) {
                return this.request('/admin/restore', {
                    method: 'POST',
                    body: JSON.stringify(backupData)
                });
            }
            
            // API Keys
            async getApiKeys() {
                return this.request('/api-keys');
            }
            
            async createApiKey(apiKeyData) {
                return this.request('/api-keys', {
                    method: 'POST',
                    body: JSON.stringify(apiKeyData)
                });
            }
            
            async updateApiKey(id, apiKeyData) {
                return this.request(`/api-keys/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(apiKeyData)
                });
            }
            
            async deleteApiKey(id) {
                return this.request(`/api-keys/${id}`, {
                    method: 'DELETE'
                });
            }
            
            async getApiKeyStats(id) {
                return this.request(`/api-keys/${id}/stats`);
            }
            
            // Branches
            async getBranches() {
                return this.request('/branches');
            }
            
            async createBranch(branch) {
                return this.request('/branches', {
                    method: 'POST',
                    body: JSON.stringify(branch)
                });
            }
            
            async updateBranch(id, branch) {
                return this.request(`/branches/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(branch)
                });
            }
            
            async deleteBranch(id) {
                return this.request(`/branches/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // Categories
            async getCategories() {
                return this.request('/categories');
            }
            async getCategory(id) {
                return this.request(`/categories/${id}`);
            }
            
            async createCategory(category) {
                return this.request('/categories', {
                    method: 'POST',
                    body: JSON.stringify(category)
                });
            }
            
            async updateCategory(id, category) {
                return this.request(`/categories/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(category)
                });
            }
            
            async deleteCategory(id) {
                return this.request(`/categories/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // Suppliers
            async getSuppliers() {
                return this.request('/suppliers');
            }
            
            async createSupplier(supplier) {
                return this.request('/suppliers', {
                    method: 'POST',
                    body: JSON.stringify(supplier)
                });
            }
            
            async updateSupplier(id, supplier) {
                return this.request(`/suppliers/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(supplier)
                });
            }
            
            async deleteSupplier(id) {
                return this.request(`/suppliers/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // Sales
            async getSales(filters = {}) {
                // Clean filters: remove undefined, null, empty or string 'undefined' values
                const cleaned = {};
                Object.keys(filters || {}).forEach(key => {
                    const val = filters[key];
                    if (val === undefined || val === null) return;
                    if (typeof val === 'string' && (val.trim() === '' || val === 'undefined')) return;
                    cleaned[key] = val;
                });

                const qp = new URLSearchParams(cleaned);
                const qs = qp.toString();
                return this.request(`/sales${qs ? '?' + qs : ''}`);
            }
            
            async createSale(sale) {
                return this.request('/sales', {
                    method: 'POST',
                    body: JSON.stringify(sale)
                });
            }
            
            async updateSale(id, sale) {
                return this.request(`/sales/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(sale)
                });
            }

            async deleteSale(id) {
                return this.request(`/sales/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // Departments
            async getDepartments(branchId = null) {
                const endpoint = branchId ? `/departments?branchId=${branchId}` : '/departments';
                return this.request(endpoint);
            }
            async getDepartmentsByBranch(branchId) {
                return this.request(`/branches/${branchId}/departments`);
            }
            
            async getDepartment(id) {
                return this.request(`/departments/${id}`);
            }
            
            async createDepartment(department) {
                return this.request('/departments', {
                    method: 'POST',
                    body: JSON.stringify(department)
                });
            }
            
            async updateDepartment(id, department) {
                return this.request(`/departments/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(department)
                });
            }
            
            async deleteDepartment(id) {
                return this.request(`/departments/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // Sub-Departments
            async getSubDepartments(filters = {}) {
                const queryParams = new URLSearchParams();
                if (filters.departmentId) queryParams.append('departmentId', filters.departmentId);
                if (filters.branchId) queryParams.append('branchId', filters.branchId);
                const queryString = queryParams.toString();
                return this.request(`/sub-departments${queryString ? '?' + queryString : ''}`);
            }
            
            async getSubDepartmentsByDepartment(departmentId) {
                return this.request(`/departments/${departmentId}/sub-departments`);
            }
            
            async getSubDepartment(id) {
                return this.request(`/sub-departments/${id}`);
            }
            
            async createSubDepartment(subDepartment) {
                return this.request('/sub-departments', {
                    method: 'POST',
                    body: JSON.stringify(subDepartment)
                });
            }
            
            async updateSubDepartment(id, subDepartment) {
                return this.request(`/sub-departments/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(subDepartment)
                });
            }
            
            async deleteSubDepartment(id) {
                return this.request(`/sub-departments/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // Department Sales
            async getDepartmentSales(filters = {}) {
                // Clean filters: remove undefined, null, empty or string 'undefined' values
                const cleaned = {};
                Object.keys(filters || {}).forEach(key => {
                    const val = filters[key];
                    if (val === undefined || val === null) return;
                    if (typeof val === 'string' && (val.trim() === '' || val === 'undefined')) return;
                    cleaned[key] = val;
                });

                const qp = new URLSearchParams(cleaned);
                const qs = qp.toString();
                return this.request(`/department-sales${qs ? '?' + qs : ''}`);
            }
            
            async createDepartmentSale(sale) {
                return this.request('/department-sales', {
                    method: 'POST',
                    body: JSON.stringify(sale)
                });
            }
            
            async updateDepartmentSale(id, sale) {
                return this.request(`/department-sales/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(sale)
                });
            }
            
            async deleteDepartmentSale(id) {
                return this.request(`/department-sales/${id}`, {
                    method: 'DELETE'
                });
            }
            
            async getDepartmentSale(id) {
                return this.request(`/department-sales/${id}`);
            }
            
            // Payments
            async getPayments(url = '/payments') {
                // If url already includes query parameters, use as-is
                // Otherwise, just use the endpoint path
                const endpoint = url.startsWith('/') ? url : `/${url}`;
                return this.request(endpoint);
            }
            
            // Category Payments API (SEPARATE)
            async getCategoryPayments(filtersOrUrl = {}) {
                // If it's a string (URL), use it directly (for backward compatibility)
                if (typeof filtersOrUrl === 'string') {
                    const url = filtersOrUrl;
                    // Remove /api prefix if present (request() will add it via baseURL)
                    let endpoint = url.startsWith('/api/') ? url.replace('/api', '') : url;
                    endpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
                    console.log(' Calling category payments API:', endpoint);
                    return this.request(endpoint);
                }
                
                // If it's an object (filters), build query string like getSales does
                const filters = filtersOrUrl || {};
                // Clean filters: remove undefined, null, empty or string 'undefined' values
                const cleaned = {};
                Object.keys(filters).forEach(key => {
                    const val = filters[key];
                    if (val === undefined || val === null) return;
                    if (typeof val === 'string' && (val.trim() === '' || val === 'undefined')) return;
                    cleaned[key] = val;
                });
                
                const qp = new URLSearchParams(cleaned);
                const queryString = qp.toString();
                const endpoint = queryString ? `/category-payments?${queryString}` : '/category-payments';
                console.log(' Calling category payments API with filters:', endpoint);
                return this.request(endpoint);
            }
            
            async getNextVoucherNumber() {
                // Use full path to avoid route matching issues
                return this.request('/payments/next-voucher-number', { method: 'GET' });
            }
            
            async getNextCategoryVoucherNumber() {
                return this.request('/category-payments/next-voucher-number', { method: 'GET' });
            }
            
            async createPayment(payment) {
                return this.request('/payments', {
                    method: 'POST',
                    body: JSON.stringify(payment)
                });
            }
            
            async createCategoryPayment(payment) {
                return this.request('/category-payments', {
                    method: 'POST',
                    body: JSON.stringify(payment)
                });
            }
            
            async getCategoryPayment(id) {
                return this.request(`/category-payments/${id}`);
            }
            
            async updateCategoryPayment(id, payment) {
                return this.request(`/category-payments/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(payment)
                });
            }
            
            async deleteCategoryPayment(id) {
                return this.request(`/category-payments/${id}`, {
                    method: 'DELETE'
                });
            }
            
            async updatePayment(id, payment) {
                return this.request(`/payments/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(payment)
                });
            }
            
            async deletePayment(id) {
                return this.request(`/payments/${id}`, {
                    method: 'DELETE'
                });
            }
            
            async getPayment(id) {
                return this.request(`/payments/${id}`);
            }
            
            // Groups
            async getGroups() {
                return this.request('/groups');
            }
            
            async createGroup(group) {
                return this.request('/groups', {
                    method: 'POST',
                    body: JSON.stringify(group)
                });
            }
            
            async updateGroup(id, group) {
                return this.request(`/groups/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(group)
                });
            }
            
            async deleteGroup(id) {
                return this.request(`/groups/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // Users
            async getUsers() {
                return this.request('/users');
            }
            
            async createUser(user) {
                return this.request('/users', {
                    method: 'POST',
                    body: JSON.stringify(user)
                });
            }
            
            async updateUser(id, user) {
                return this.request(`/users/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(user)
                });
            }
            
            async deleteUser(id) {
                return this.request(`/users/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // Employees
            async getEmployees() {
                return this.request('/employees');
            }
            
            async getEmployee(id) {
                return this.request(`/employees/${id}`);
            }
            
            async createEmployee(employee) {
                return this.request('/employees', {
                    method: 'POST',
                    body: JSON.stringify(employee)
                });
            }
            
            async updateEmployee(id, employee) {
                return this.request(`/employees/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(employee)
                });
            }
            
            async deleteEmployee(id) {
                return this.request(`/employees/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // Employee Departments
            async getEmployeeDepartments() {
                return this.request('/employee-departments');
            }
            
            async getEmployeeDepartment(id) {
                return this.request(`/employee-departments/${id}`);
            }
            
            async createEmployeeDepartment(department) {
                return this.request('/employee-departments', {
                    method: 'POST',
                    body: JSON.stringify(department)
                });
            }
            
            async updateEmployeeDepartment(id, department) {
                return this.request(`/employee-departments/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(department)
                });
            }
            
            async deleteEmployeeDepartment(id) {
                return this.request(`/employee-departments/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // Employee Designations
            async getEmployeeDesignations() {
                return this.request('/employee-designations');
            }
            
            async getEmployeeDesignation(id) {
                return this.request(`/employee-designations/${id}`);
            }
            
            async createEmployeeDesignation(designation) {
                return this.request('/employee-designations', {
                    method: 'POST',
                    body: JSON.stringify(designation)
                });
            }
            
            async updateEmployeeDesignation(id, designation) {
                return this.request(`/employee-designations/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(designation)
                });
            }
            
            async deleteEmployeeDesignation(id) {
                return this.request(`/employee-designations/${id}`, {
                    method: 'DELETE'
                });
            }
        }
        
        // Global API instance
        const api = new APIService();
        // Expose API to window for use in external scripts
        window.api = api;
        
        // Global data storage (NO localStorage)
        let appData = {
            sales: [],
            branches: [],
            categories: [],
            suppliers: [],
            groups: [],
            users: [],
            currentUser: null,
            // view preference for recent sales: 'table' or 'cards'
            salesView: 'table',
            settings: {
                companyName: 'D.Watson Group of Pharmacy',
                currency: '',
                dateFormat: 'DD/MM/YYYY',
                itemsPerPage: 10,
                defaultCostPercent: 70
            }
        };
        // Expose appData to window for use in external scripts
        window.appData = appData;
        
        // ========================================
        // INITIALIZATION FUNCTIONS
        // ========================================
        
        // Event listener cleanup map
        const eventListeners = new Map();
        
        // Add event listener with cleanup tracking
        function addEventListenerWithCleanup(element, event, handler) {
            if (!element) return;
            
            element.addEventListener(event, handler);
            
            const key = `${element.id || 'anonymous'}_${event}`;
            if (!eventListeners.has(key)) {
                eventListeners.set(key, []);
            }
            eventListeners.get(key).push({ element, event, handler });
        }
        
        // Clean up all event listeners
        function cleanupEventListeners() {
            eventListeners.forEach((listeners, key) => {
                listeners.forEach(({ element, event, handler }) => {
                    element.removeEventListener(event, handler);
                });
            });
            eventListeners.clear();
        }
        
        // Helper function to reset save button to create mode
        function resetSaveButton(buttonId, createFunction) {
            const saveBtn = document.getElementById(buttonId);
            if (saveBtn) {
                saveBtn.textContent = 'Save ' + buttonId.replace('save', '').replace('Btn', '');
                // Remove any existing onclick handlers
                saveBtn.onclick = null;
                // Set new onclick handler
                saveBtn.onclick = createFunction;
                // Also remove any event listeners that might be attached
                saveBtn.removeAttribute('onclick');
                // Force the button to call the create function
                saveBtn.setAttribute('onclick', createFunction.name + '()');
            } else {
                console.error(' Button not found:', buttonId);
            }
        }

        // ========================================
        // SECURITY: INACTIVITY AUTO-LOGOUT
        // ========================================

        let inactivityTimer = null;
        let warningTimer = null;
        const INACTIVITY_LIMIT_MS = 15 * 60 * 1000; // 15 minutes (configurable)
        const WARNING_BEFORE_MS = 60 * 1000;        // show warning 1 minute before

        function startInactivityWatch() {
            stopInactivityWatch();
            scheduleWarning();
            scheduleLogout();
            bindActivityListeners();
        }

        function stopInactivityWatch() {
            if (inactivityTimer) clearTimeout(inactivityTimer);
            if (warningTimer) clearTimeout(warningTimer);
            unbindActivityListeners();
        }

        function scheduleWarning() {
            if (warningTimer) clearTimeout(warningTimer);
            warningTimer = setTimeout(() => {
                showNotification('You will be logged out in 1 minute due to inactivity', 'warning');
            }, Math.max(0, INACTIVITY_LIMIT_MS - WARNING_BEFORE_MS));
        }

        function scheduleLogout() {
            if (inactivityTimer) clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                logout();
            }, INACTIVITY_LIMIT_MS);
        }

        const activityEvents = ['click', 'keydown', 'mousemove', 'scroll', 'touchstart', 'touchmove'];

        function onUserActivity() {
            // Reset timers on any activity
            scheduleWarning();
            scheduleLogout();
        }

        function bindActivityListeners() {
            activityEvents.forEach(evt => document.addEventListener(evt, onUserActivity, { passive: true }));
        }

        function unbindActivityListeners() {
            activityEvents.forEach(evt => document.removeEventListener(evt, onUserActivity));
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Clean up any existing listeners first
            cleanupEventListeners();
            
            // Initialize display state immediately to prevent login flash
            if (typeof initializeDisplayState === 'function') {
                initializeDisplayState();
            }
            
            // Initialize theme first (before other initialization)
            initTheme();
            
            // Check if user is already logged in
            checkAuthStatus();
            
            // Setup event listeners
            setupEventListeners();
            
            // Handle report tabs visibility on page load (for page refresh)
            setTimeout(() => {
                const lastReportFromSidebar = localStorage.getItem('lastReportFromSidebar');
                if (lastReportFromSidebar) {
                    // User came from sidebar - hide all tabs except the stored one
                    const reportTabsNav = document.querySelector('.report-tabs');
                    if (reportTabsNav && reportTabsNav.style.display !== 'none') {
                        document.querySelectorAll('.report-tab').forEach(tab => {
                            const tabName = tab.getAttribute('data-tab');
                            if (tabName === lastReportFromSidebar) {
                                tab.style.display = 'flex';
                                tab.classList.add('active');
                            } else {
                                tab.style.display = 'none';
                                tab.classList.remove('active');
                            }
                        });
                        // Ensure correct tab content is active
                        document.querySelectorAll('.report-tab-content').forEach(content => {
                            content.classList.remove('active');
                        });
                        const targetTabContent = document.getElementById(`tab-${lastReportFromSidebar}`);
                        if (targetTabContent) {
                            targetTabContent.classList.add('active');
                        }
                    }
                }
            }, 200);
            
            // Setup login form
            setupLoginForm();
            
            // Set up save settings button click handler
            setTimeout(function() {
                const saveSettingsBtn = document.getElementById('saveSettingsBtn');
                if (saveSettingsBtn) {
                    const newBtn = saveSettingsBtn.cloneNode(true);
                    saveSettingsBtn.parentNode.replaceChild(newBtn, saveSettingsBtn);
                    newBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (typeof saveSettings === 'function') {
                            saveSettings();
                        } else if (typeof window.saveSettings === 'function') {
                            window.saveSettings();
                        }
                    });
                }
            }, 500);
        });
        
        // ========================================
        // AUTHENTICATION FUNCTIONS
        // ========================================
        
        // Setup login form
        function setupLoginForm() {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const loginToggle = document.getElementById('loginToggle');
            const signupToggle = document.getElementById('signupToggle');
            const secretAccessBtn = document.getElementById('secretAccessBtn');
            
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            if (signupForm) {
                signupForm.addEventListener('submit', handleSignup);
            }
            
            if (loginToggle) {
                loginToggle.addEventListener('click', () => switchToLogin());
            }
            
            if (signupToggle) {
                signupToggle.addEventListener('click', () => switchToSignup());
            }
            
            // Secret access functionality
            if (secretAccessBtn) {
                let clickCount = 0;
                let clickTimer = null;
                
                secretAccessBtn.addEventListener('click', () => {
                    clickCount++;
                    
                    // Clear previous timer
                    if (clickTimer) {
                        clearTimeout(clickTimer);
                    }
                    
                    // Reset counter after 3 seconds
                    clickTimer = setTimeout(() => {
                        clickCount = 0;
                    }, 3000);
                    
                    // Check for secret combination (5 clicks)
                    if (clickCount >= 5) {
                        unlockSignupAccess();
                        clickCount = 0;
                    }
                });
            }
            
            // Alternative: Keyboard shortcut (Ctrl + Shift + S)
            // SECRET ACCESS METHODS FOR ADMIN:
            // 1. Click the small key icon 5 times within 3 seconds
            // 2. Press Ctrl + Shift + S keyboard shortcut
            // 3. Admin password for signup: 'admin123' (change this in the code)
            document.addEventListener('keydown', (event) => {
                if (event.ctrlKey && event.shiftKey && event.key === 'S') {
                    event.preventDefault();
                    unlockSignupAccess();
                }
            });
        }
        
        // Unlock signup access (admin only)
        function unlockSignupAccess() {
            const signupToggle = document.getElementById('signupToggle');
            const secretAccessBtn = document.getElementById('secretAccessBtn');
            
            if (signupToggle) {
                signupToggle.classList.remove('d-none');
                signupToggle.style.opacity = '1';
                signupToggle.style.transition = 'opacity 0.3s ease';
            }
            
            if (secretAccessBtn) {
                secretAccessBtn.style.opacity = '0.8';
                secretAccessBtn.innerHTML = '<i class="fas fa-unlock"></i>';
                secretAccessBtn.title = 'Signup access unlocked';
            }
            
            // Show brief notification
            showNotification('Admin access unlocked! Signup option is now available.', 'success');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (signupToggle && !signupToggle.classList.contains('active')) {
                    signupToggle.classList.add('d-none');
                    signupToggle.style.opacity = '0';
                }
                if (secretAccessBtn) {
                    secretAccessBtn.style.opacity = '0.3';
                    secretAccessBtn.innerHTML = '<i class="fas fa-key"></i>';
                    secretAccessBtn.title = '';
                }
            }, 10000);
        }
        
        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();
            
            const usernameElement = document.getElementById('username');
            const passwordElement = document.getElementById('password');
            const errorElement = document.getElementById('loginError');
            
            if (!usernameElement || !passwordElement || !errorElement) {
                console.error('Required login elements not found');
                return;
            }
            
            const username = usernameElement.value.trim();
            const password = passwordElement.value;
            
            // Input validation
            if (!username || username.length < 3) {
                errorElement.textContent = 'Username must be at least 3 characters long';
                errorElement.classList.remove('d-none');
                return;
            }
            
            if (!password || password.length < 6) {
                errorElement.textContent = 'Password must be at least 6 characters long';
                errorElement.classList.remove('d-none');
                return;
            }
            
            try {
                // Show loading state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Logging in...';
                submitBtn.disabled = true;
                
                // Attempt login
                const response = await api.login({ username, password });
                
                // Store user data with permissions properly extracted
                appData.currentUser = {
                    ...response.user,
                    permissions: response.user.permissions || response.user.groupId?.permissions || []
                };
                
                // Debug: Log user permissions
                console.log(' Login Debug - Full response.user:', response.user);
                console.log(' Login Debug - User permissions:', appData.currentUser.permissions);
                console.log(' Login Debug - User groupId:', appData.currentUser.groupId);
                console.log(' Login Debug - Is admin?', appData.currentUser.permissions.includes('admin'));
                
                // Show main app
                showMainApp();
                
                // Load initial data
                loadInitialData();
                
                // Hide error if it was shown
                errorElement.classList.add('d-none');
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Show error message
                errorElement.textContent = error.message || 'Login failed. Please check your credentials.';
                errorElement.classList.remove('d-none');
                
                // Reset button
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Login';
                submitBtn.disabled = false;
            }
        }
        
        // Handle signup form submission
        async function handleSignup(event) {
            event.preventDefault();
            
            const usernameElement = document.getElementById('signupUsername');
            const fullNameElement = document.getElementById('signupFullName');
            const emailElement = document.getElementById('signupEmail');
            const passwordElement = document.getElementById('signupPassword');
            const confirmPasswordElement = document.getElementById('signupConfirmPassword');
            const adminPasswordElement = document.getElementById('adminPassword');
            const errorElement = document.getElementById('signupError');
            
            if (!usernameElement || !fullNameElement || !emailElement || !passwordElement || 
                !confirmPasswordElement || !adminPasswordElement || !errorElement) {
                console.error('Required signup elements not found');
                return;
            }
            
            const username = usernameElement.value.trim();
            const fullName = fullNameElement.value.trim();
            const email = emailElement.value.trim();
            const password = passwordElement.value;
            const confirmPassword = confirmPasswordElement.value;
            const adminPassword = adminPasswordElement.value;
            
            // Input validation
            if (!username || username.length < 3) {
                errorElement.textContent = 'Username must be at least 3 characters long';
                errorElement.classList.remove('d-none');
                return;
            }
            
            if (!fullName || fullName.length < 2) {
                errorElement.textContent = 'Full name must be at least 2 characters long';
                errorElement.classList.remove('d-none');
                return;
            }
            
            if (!email || !email.includes('@')) {
                errorElement.textContent = 'Please enter a valid email address';
                errorElement.classList.remove('d-none');
                return;
            }
            
            if (!password || password.length < 6) {
                errorElement.textContent = 'Password must be at least 6 characters long';
                errorElement.classList.remove('d-none');
                return;
            }
            
            if (password !== confirmPassword) {
                errorElement.textContent = 'Passwords do not match';
                errorElement.classList.remove('d-none');
                return;
            }
            
            // Validate admin password first
            const expectedAdminPassword = 'admin123'; // You can change this to any password you want
            if (adminPassword !== expectedAdminPassword) {
                errorElement.textContent = 'Invalid admin access code. Access denied.';
                errorElement.classList.remove('d-none');
                return;
            }
            
            try {
                // Show loading state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Creating Account...';
                submitBtn.disabled = true;
                
                // Attempt signup
                const response = await api.signup({ 
                    username, 
                    fullName, 
                    email, 
                    password, 
                    confirmPassword 
                });
                
                // Store user data with permissions properly extracted
                appData.currentUser = {
                    ...response.user,
                    permissions: response.user.permissions || response.user.groupId?.permissions || []
                };
                
                // Debug: Log user permissions
                console.log(' Login Debug - Full response.user:', response.user);
                console.log(' Login Debug - User permissions:', appData.currentUser.permissions);
                console.log(' Login Debug - User groupId:', appData.currentUser.groupId);
                console.log(' Login Debug - Is admin?', appData.currentUser.permissions.includes('admin'));
                
                // Show main app
                showMainApp();
                
                // Load initial data
                loadInitialData();
                
                // Hide error if it was shown
                errorElement.classList.add('d-none');
                
                // Show success message
                showNotification('Account created successfully with admin privileges! Welcome to D.Watson Pharmacy Dashboard.');
                
            } catch (error) {
                console.error('Signup error:', error);
                
                // Show error message
                errorElement.textContent = error.message || 'Signup failed. Please try again.';
                errorElement.classList.remove('d-none');
                
                // Reset button
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Sign Up';
                submitBtn.disabled = false;
            }
        }
        
        // Switch to login form
        function switchToLogin() {
            document.getElementById('loginForm').classList.remove('d-none');
            document.getElementById('signupForm').classList.add('d-none');
            document.getElementById('loginToggle').classList.add('active');
            document.getElementById('signupToggle').classList.remove('active');
            
            // Clear error messages
            document.getElementById('loginError').classList.add('d-none');
            document.getElementById('signupError').classList.add('d-none');
        }
        
        // Switch to signup form
        function switchToSignup() {
            document.getElementById('loginForm').classList.add('d-none');
            document.getElementById('signupForm').classList.remove('d-none');
            document.getElementById('loginToggle').classList.remove('active');
            document.getElementById('signupToggle').classList.add('active');
            
            // Clear error messages
            document.getElementById('loginError').classList.add('d-none');
            document.getElementById('signupError').classList.add('d-none');
        }
        
        // Show login section
        function showLoginSection() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }
        
        // Show main app
        function showMainApp() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            // Start inactivity watchdog after showing app
            startInactivityWatch();
            // Set default dates when main app is shown
            setTimeout(() => {
                setDefaultDates();
            }, 100);
        }
        
        // Retry mechanism with exponential backoff
        let retryCount = 0;
        const maxRetries = 5; // Increased retries
        const baseDelay = 8000; // 8 seconds (increased to reduce rate limit issues)
        
        async function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Check authentication status
        async function checkAuthStatus(retryAttempt = 0) {
            try {
                // Check if we have a token
                const token = localStorage.getItem('authToken');
                
                if (!token) {
                    showLoginSection();
                    return;
                }
                
                // Set token in API service
                api.setToken(token);
                
                // Get current user info with retry logic
                let user;
                try {
                    user = await api.getCurrentUser();
                    // Reset retry count on success
                    retryCount = 0;
                } catch (error) {
                    // Check for rate limiting error
                    if (error.message && error.message.includes('Too many requests')) {
                        console.warn(`Rate limit hit (attempt ${retryAttempt + 1}/${maxRetries}). Will retry with delay.`);
                        
                        // Implement exponential backoff retry
                        if (retryAttempt < maxRetries) {
                            const delayTime = baseDelay * Math.pow(2, retryAttempt); // Exponential backoff
                            await delay(delayTime);
                            return checkAuthStatus(retryAttempt + 1);
                        } else {
                            console.error('Max retries reached. Keeping user logged in.');
                            // Keep user logged in even after max retries
                            showMainApp();
                            if (typeof loadDashboard === 'function') {
                                const monthFilter = document.getElementById('dashboardMonthFilter');
                                const selectedMonth = monthFilter ? monthFilter.value : null;
                                loadDashboard(selectedMonth || null);
                            }
                            return;
                        }
                    }
                    
                    // If it's a network error or server error, don't logout immediately
                    if (error.message.includes('Failed to fetch') || 
                        error.message.includes('NetworkError') ||
                        error.message.includes('500') ||
                        error.message.includes('503')) {
                        console.warn('Network error during auth check, keeping user logged in:', error.message);
                        // Keep the user logged in and show main app
                        showMainApp();
                        // Don't load dashboard on network error - wait for user to manually refresh
                        // Dashboard will load when user navigates to it or refreshes
                        return;
                    }
                    // Only logout for actual authentication errors
                    throw error;
                }
                
                // Debug: Log user permissions
                
                // Store user data with permissions properly extracted
                appData.currentUser = {
                    ...user,
                    permissions: user.groupId?.permissions || []
                };
                
                // Show main app
                showMainApp();
                
                // Load initial data
                loadInitialData();
                
                // Determine which section to show - ALWAYS prioritize URL hash first (most reliable for page refresh)
                let sectionToShow = null;
                
                // Priority 1: Check URL hash FIRST (this is what's in the browser address bar)
                // This ensures that when user refreshes, they stay on the same page
                const hash = window.location.hash.replace('#', '').trim();
                if (hash && hash !== '' && hash !== 'null' && hash !== 'undefined') {
                    sectionToShow = hash;
                    console.log(' Restoring section from URL hash:', sectionToShow);
                    // Save to localStorage for backup
                    try {
                        localStorage.setItem('lastActiveSection', sectionToShow);
                    } catch (e) {
                        console.warn('Could not save section to localStorage:', e);
                    }
                }
                
                // Priority 2: Only check localStorage if no hash exists
                if (!sectionToShow) {
                    try {
                        const lastActiveSection = localStorage.getItem('lastActiveSection');
                        if (lastActiveSection && lastActiveSection !== 'null' && lastActiveSection !== 'undefined' && lastActiveSection !== '') {
                            sectionToShow = lastActiveSection;
                            console.log(' Restoring section from localStorage:', sectionToShow);
                            // Update URL hash to match
                            if (window.location.hash !== '#' + sectionToShow) {
                                window.history.replaceState(null, null, '#' + sectionToShow);
                            }
                        }
                    } catch (e) {
                        console.warn('Could not read last active section from localStorage:', e);
                    }
                }
                
                if (sectionToShow && sectionToShow !== '') {
                    // Delay slightly to ensure DOM is ready
                    setTimeout(() => {
                        const section = sectionToShow;
                        
                        // Validate section before proceeding
                        if (!section || section === 'null' || section === 'undefined' || section === '') {
                            console.error(' Invalid section:', section);
                            // Only default to dashboard if section is truly invalid
                            if (typeof loadDashboard === 'function') {
                                const monthFilter = document.getElementById('dashboardMonthFilter');
                                const selectedMonth = monthFilter ? monthFilter.value : null;
                                loadDashboard(selectedMonth || null);
                            }
                            return;
                        }
                        
                        const permissions = user.groupId?.permissions || [];
                        
                        // Check if user has permission for this section
                        let hasPermission = false;
                        if (['groups', 'users', 'settings'].includes(section)) {
                            hasPermission = permissions.includes('admin');
                        } else {
                            hasPermission = permissions.includes(section) || permissions.includes('admin');
                        }
                        
                        if (hasPermission) {
                            // Update URL hash to match section being shown
                            if (window.location.hash !== '#' + section) {
                                window.history.replaceState(null, null, '#' + section);
                            }
                            
                            console.log(' Showing section:', section);
                            showSection(section);
                            
                            // Update active state
                            document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                            const activeLink = document.querySelector(`.sidebar .nav-link[data-section="${section}"]`);
                            if (activeLink) {
                                activeLink.classList.add('active');
                            }
                            
                            // Restore report tab if reports section
                            if (section === 'reports' && typeof window.switchReportTab === 'function') {
                                try {
                                    const lastActiveReportTab = localStorage.getItem('lastActiveReportTab');
                                    if (lastActiveReportTab && lastActiveReportTab !== 'null' && lastActiveReportTab !== 'undefined') {
                                        setTimeout(() => {
                                            window.switchReportTab(lastActiveReportTab);
                                        }, 200);
                                    } else {
                                        setTimeout(() => {
                                            window.switchReportTab('sales-report');
                                        }, 200);
                                    }
                                } catch (e) {
                                    console.warn('Could not restore report tab:', e);
                                }
                            }
                        } else {
                            // No permission for requested section - try localStorage before dashboard
                            try {
                                const lastActiveSection = localStorage.getItem('lastActiveSection');
                                if (lastActiveSection && lastActiveSection !== 'null' && lastActiveSection !== 'undefined' && lastActiveSection !== '') {
                                    const permissions = user.groupId?.permissions || [];
                                    let hasPermissionForSaved = false;
                                    if (['groups', 'users', 'settings'].includes(lastActiveSection)) {
                                        hasPermissionForSaved = permissions.includes('admin');
                                    } else {
                                        hasPermissionForSaved = permissions.includes(lastActiveSection) || permissions.includes('admin');
                                    }
                                    if (hasPermissionForSaved) {
                                        // Restore saved section instead of dashboard
                                        if (window.location.hash !== '#' + lastActiveSection) {
                                            window.history.replaceState(null, null, '#' + lastActiveSection);
                                        }
                                        setTimeout(() => {
                                            console.log(' Restoring saved section (no permission for hash):', lastActiveSection);
                                            if (typeof showSection === 'function') showSection(lastActiveSection);
                                            document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                                            const activeLink = document.querySelector(`.sidebar .nav-link[data-section="${lastActiveSection}"]`);
                                            if (activeLink) activeLink.classList.add('active');
                                        }, 100);
                                        return;
                                    }
                                }
                            } catch (e) {
                                console.warn('Could not check saved section:', e);
                            }
                            
                            // Only show dashboard if no permission AND no saved section
                            console.log(' No permission for requested section, defaulting to dashboard');
                            if (!window.location.hash || window.location.hash === '' || window.location.hash === '#') {
                                window.history.replaceState(null, null, '#dashboard');
                            }
                            if (typeof showSection === 'function') {
                                showSection('dashboard');
                            }
                            if (typeof loadDashboard === 'function') {
                                const monthFilter = document.getElementById('dashboardMonthFilter');
                                const selectedMonth = monthFilter ? monthFilter.value : null;
                                loadDashboard(selectedMonth || null);
                            }
                        }
                    }, 100);
                } else {
                    // No hash or saved section - only then default to dashboard
                    console.log(' No section to restore, defaulting to dashboard');
                    if (!window.location.hash || window.location.hash === '' || window.location.hash === '#') {
                        window.history.replaceState(null, null, '#dashboard');
                    }
                    if (typeof showSection === 'function') {
                        showSection('dashboard');
                    }
                    if (typeof loadDashboard === 'function') {
                        const monthFilter = document.getElementById('dashboardMonthFilter');
                        const selectedMonth = monthFilter ? monthFilter.value : null;
                        loadDashboard(selectedMonth || null);
                    }
                }
                
            } catch (error) {
                console.error('Authentication check failed:', error);
                
                // Only clear token for actual authentication errors (401, 403)
                if (error.message.includes('401') || error.message.includes('403') || 
                    error.message.includes('Authentication failed') || 
                    error.message.includes('Invalid token')) {
                    api.clearToken();
                    showLoginSection();
                } else {
                    // For other errors, keep user logged in
                    console.warn('Non-auth error, keeping user logged in:', error.message);
                    showMainApp();
                    
                    // Check if there's a hash in URL (for new tab support)
                    const hash = window.location.hash.replace('#', '');
                    if (hash && hash !== '' && hash !== 'null' && hash !== 'undefined') {
                        // Delay slightly to ensure DOM is ready
                        setTimeout(() => {
                            const section = hash;
                            
                            // Validate section before proceeding
                            if (!section || section === 'null' || section === 'undefined' || section === '') {
                                console.error(' Invalid section from hash:', section);
                                return;
                            }
                            
                            const permissions = appData.currentUser?.permissions || [];
                            
                            // Check if user has permission for this section
                            let hasPermission = false;
                            if (['groups', 'users', 'settings'].includes(section)) {
                                hasPermission = permissions.includes('admin');
                            } else {
                                hasPermission = permissions.includes(section) || permissions.includes('admin');
                            }
                            
                            if (hasPermission) {
                                showSection(section);
                                
                                // Update active state
                                document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                                const activeLink = document.querySelector(`.sidebar .nav-link[data-section="${section}"]`);
                                if (activeLink) {
                                    activeLink.classList.add('active');
                                }
                            } else {
                                // No permission for requested section, show dashboard instead
                                if (typeof loadDashboard === 'function') {
                                    loadDashboard();
                                }
                            }
                        }, 100);
                    } else {
                        // No hash, load dashboard as default
                        if (typeof loadDashboard === 'function') {
                            loadDashboard();
                        }
                    }
                }
            }
        }
        
        // ========================================
        // DATA LOADING FUNCTIONS
        // ========================================
        
        // Load initial data
        async function loadInitialData() {
            try {
                // Show loading spinner
                const loadingSpinner = document.getElementById('loadingSpinner');
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'flex';
                }
                
                // Load basic data that all users need (resilient to partial failures)
                const results = await Promise.allSettled([
                    api.getSales(),
                    api.getBranches(),
                    api.getCategories(),
                    api.getSuppliers(),
                    api.getSettings()
                ]);
                
                const pick = (idx, fallback) => (results[idx].status === 'fulfilled' ? results[idx].value : fallback);
                if (results[0].status !== 'fulfilled') console.warn('Error loading sales:', results[0].reason);
                if (results[1].status !== 'fulfilled') console.warn('Error loading branches:', results[1].reason);
                if (results[2].status !== 'fulfilled') console.warn('Error loading categories:', results[2].reason);
                if (results[3].status !== 'fulfilled') console.warn('Error loading suppliers:', results[3].reason);
                if (results[4].status !== 'fulfilled') console.warn('Error loading settings:', results[4].reason);
                
                appData.sales = pick(0, []);
                appData.branches = pick(1, []);
                appData.categories = pick(2, []);
                appData.suppliers = pick(3, []);
                appData.settings = pick(4, { currency: 'PKR' });
                
                // Only load groups and users if user is admin
                if (isAdmin()) {
                    try {
                        const [groups, users] = await Promise.all([
                            api.getGroups(),
                            api.getUsers()
                        ]);
                        appData.groups = groups;
                        appData.users = users;
                    } catch (error) {
                        console.error('Error loading admin data:', error);
                        // Don't show notification for this error as it's expected for non-admins
                        // Set empty arrays to prevent undefined errors
                        appData.groups = appData.groups || [];
                        appData.users = appData.users || [];
                    }
                } else {
                    // Ensure non-admin users have empty arrays
                    appData.groups = [];
                    appData.users = [];
                }
                
                // Populate selectors
                populateBranchSelectors();
                populateCategorySelectors();
                
                // Initialize payment form
                initializePaymentForm();
                
                // Only populate group selectors if user is admin
                if (isAdmin()) {
                    populateGroupSelectors();
                }
                
                // Update UI based on permissions
                updateSidebarPermissions();
                updateCurrentUserUI();
                
                // Set default dates after data is loaded
                setDefaultDates();
                
                // Check if there's a hash in URL - if so, don't force dashboard (let checkAuthStatus handle it)
                const currentHash = window.location.hash.replace('#', '').trim();
                const hasHash = currentHash && currentHash !== '' && currentHash !== 'null' && currentHash !== 'undefined';
                
                // Only show dashboard if there's NO hash (fresh login, not a page refresh)
                if (!hasHash) {
                    const permissions = appData.currentUser?.permissions || [];
                    const userIsAdmin = permissions.includes('admin');
                    
                    // Show dashboard section if user has dashboard permission or is admin
                    if (permissions.includes('dashboard') || userIsAdmin) {
                        // Ensure dashboard section is shown
                        if (typeof showSection === 'function') {
                            showSection('dashboard');
                        }
                        
                        // Update URL hash to dashboard
                        if (window.location.hash !== '#dashboard') {
                            window.history.replaceState(null, null, '#dashboard');
                        }
                        
                        // Update sidebar active state
                        setTimeout(() => {
                            document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                            const dashboardLink = document.querySelector('.sidebar .nav-link[data-section="dashboard"]');
                            if (dashboardLink) {
                                dashboardLink.classList.add('active');
                            }
                        }, 100);
                        
                        // Load dashboard data
                        loadDashboard();
                    } else {
                        // If user doesn't have dashboard permission, show the first allowed section
                        const allowedSections = permissions.filter(p => !['admin'].includes(p));
                        if (allowedSections.length > 0 && allowedSections[0]) {
                            const firstSection = allowedSections[0];
                            if (firstSection && firstSection !== 'null' && firstSection !== 'undefined') {
                                showSection(firstSection);
                            } else {
                                console.error(' Invalid first allowed section:', firstSection);
                                showNotification('You do not have permission to access any sections', 'error');
                            }
                        } else {
                            showNotification('You do not have permission to access any sections', 'error');
                        }
                    }
                }
                // If hash exists, checkAuthStatus will handle showing the correct section - don't interfere here
                
            } catch (error) {
                console.error('Error loading initial data:', error);
                showNotification('Failed to load initial data', 'error');
            } finally {
                // Hide loading spinner
                const loadingSpinner = document.getElementById('loadingSpinner');
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'none';
                }
            }
        }
        
        // Check if user is admin
        function isAdmin() {
            console.log(' isAdmin Debug - appData.currentUser:', appData.currentUser);
            console.log(' isAdmin Debug - permissions:', appData.currentUser?.permissions);
            console.log(' isAdmin Debug - includes admin?', appData.currentUser?.permissions?.includes('admin'));
            return appData.currentUser && 
                   appData.currentUser.permissions && 
                   appData.currentUser.permissions.includes('admin');
        }
        
        // Update current user UI
        function updateCurrentUserUI() {
            if (appData.currentUser) {
                document.getElementById('currentUserDisplay').textContent = 
                    appData.currentUser.fullName || appData.currentUser.username;
            }
        }
        
        // Comprehensive permission mapping
        const PERMISSION_MAP = {
            // Main sections
            'dashboard': ['dashboard'],
            'categories': ['categories'],
            'departments': ['departments'],
            'suppliers': ['suppliers'],
            'sales': ['sales'],
            'branches': ['branches'],
            'support-chat': ['support-chat'],
            
            // Admin-only sections
            'groups': ['admin'],
            'users': ['admin'],
            'settings': ['admin'],
            
            // Payroll sections
            'employees': ['employees'],
            'employee-list': ['employee-list', 'employees'],
            
            // Payment sections (no admin bypass)
            'payment-dashboard': ['payment-dashboard'],
            'payment-vouchers': ['payment-vouchers'],
            'payment-voucher-list': ['payment-voucher-list', 'category-voucher-list'],
            'payment-reports': ['payment-reports'],
            
            // Reports
            'reports': ['sales-report', 'sales-comparison-report', 'datewise-sales-report', 'payment-reports', 'department-wise-report', 'sub-department-wise-report', 'department-wise-sale-comparison', 'branch-wise-sale-comparison'],
            
            // Individual report permissions
            'sales-report': ['sales-report'],
            'sales-comparison-report': ['sales-comparison-report'],
            'datewise-sales-report': ['datewise-sales-report'],
            'payment-reports': ['payment-reports'],
            'department-wise-report': ['department-wise-report'],
            'sub-department-wise-report': ['sub-department-wise-report'],
            'department-wise-sale-comparison': ['department-wise-sale-comparison'],
            'branch-wise-sale-comparison': ['branch-wise-sale-comparison']
        };
        
        // Check if user has permission for a section
        function hasPermission(sectionId, permissions) {
            // Validate sectionId first
            if (!sectionId || sectionId === 'null' || sectionId === 'undefined' || sectionId === '') {
                console.error(' hasPermission called with invalid sectionId:', sectionId);
                return false;
            }
            
            // If permissions not provided, get from currentUser
            if (!permissions) {
                permissions = appData.currentUser?.permissions || [];
            }
            
            if (!permissions || !Array.isArray(permissions)) return false;
            
            const isAdmin = permissions.includes('admin');
            const requiredPerms = PERMISSION_MAP[sectionId];
            
            if (!requiredPerms) {
                console.warn(' No permission mapping found for sectionId:', sectionId);
                return false;
            }
            
            // Payment sections: NO admin bypass
            if (sectionId.startsWith('payment-')) {
                return requiredPerms.some(perm => permissions.includes(perm));
            }
            
            // Support sections: NO admin bypass (require explicit permission)
            if (sectionId === 'support-chat') {
                return requiredPerms.some(perm => permissions.includes(perm));
            }
            
            // Admin-only sections
            if (['groups', 'users', 'settings'].includes(sectionId)) {
                return isAdmin;
            }
            
            // Other sections: admin bypass allowed
            return isAdmin || requiredPerms.some(perm => permissions.includes(perm));
        }
        
        // Update sidebar based on user permissions
        function updateSidebarPermissions() {
            if (!appData.currentUser) return;
            
            // Get user permissions
            const permissions = appData.currentUser.permissions || [];
            const isAdmin = permissions.includes('admin');
            
            // Debug: Log permissions
            console.log(' User permissions:', permissions);
            
            // Track which sections have visible items
            const sectionVisibility = {
                'administrationSectionItems': false,
                'mainSectionItems': false,
                'inventorySectionItems': false,
                'salesSectionItems': false,
                'paymentsSectionItems': false,
                'payrollSectionItems': false,
                'supportSectionItems': false,
                'reportsSectionItems': false
            };
            
            // Show/hide sidebar items based on permissions
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                const section = link.getAttribute('data-section');
                const reportTab = link.getAttribute('data-report');
                const navItem = link.closest('.nav-item');
                const parentSection = link.closest('.sidebar-section-items')?.id;
                
                // Skip sidebar-bottom-link elements (handled separately or don't need nav-item)
                if (link.classList.contains('sidebar-bottom-link')) {
                    return;
                }
                
                // Skip if navItem is not found (only warn for non-bottom links)
                if (!navItem) {
                    console.warn('Nav item not found for link:', link);
                    return;
                }
                
                // Skip reports menu toggle and submenu toggles (handled separately)
                if (link.id === 'reportsMenuToggle' || link.id === 'warehouseReportsToggle' || link.id === 'shopReportsToggle') {
                    // Show reports menu if user has any report permission
                    const reportPermissions = ['sales-report', 'sales-comparison-report', 'datewise-sales-report', 'payment-reports', 'department-wise-report', 'sub-department-wise-report', 'department-wise-sale-comparison', 'branch-wise-sale-comparison'];
                    const hasAnyReportPermission = reportPermissions.some(perm => permissions.includes(perm)) || isAdmin;
                    
                    if (link.id === 'warehouseReportsToggle') {
                        const warehouseReportPermissions = ['sales-report', 'sales-comparison-report', 'datewise-sales-report', 'payment-reports'];
                        const hasWarehousePermission = warehouseReportPermissions.some(perm => permissions.includes(perm)) || isAdmin;
                        if (navItem) navItem.style.display = hasWarehousePermission ? 'block' : 'none';
                        if (hasWarehousePermission) sectionVisibility['reportsSectionItems'] = true;
                    } else if (link.id === 'shopReportsToggle') {
                        const shopReportPermissions = ['department-wise-report', 'sub-department-wise-report', 'department-wise-sale-comparison', 'branch-wise-sale-comparison'];
                        const hasShopPermission = shopReportPermissions.some(perm => permissions.includes(perm)) || isAdmin;
                        if (navItem) navItem.style.display = hasShopPermission ? 'block' : 'none';
                        if (hasShopPermission) sectionVisibility['reportsSectionItems'] = true;
                    } else {
                        if (navItem) navItem.style.display = hasAnyReportPermission ? 'block' : 'none';
                        if (hasAnyReportPermission) sectionVisibility['reportsSectionItems'] = true;
                    }
                    return;
                }
                
                // Handle report submenu items
                if (section === 'reports' && reportTab) {
                    // For payment-reports, check permission directly (allows admin bypass for visibility)
                    let hasReportPermission = false;
                    if (reportTab === 'payment-reports') {
                        hasReportPermission = isAdmin || permissions.includes('payment-reports');
                    } else {
                        hasReportPermission = hasPermission(reportTab, permissions);
                    }
                    if (navItem) navItem.style.display = hasReportPermission ? 'block' : 'none';
                    if (hasReportPermission && parentSection) {
                        sectionVisibility[parentSection] = true;
                    }
                    return;
                }
                
                // Check permission for regular sections
                if (section) {
                    const hasSectionPermission = hasPermission(section, permissions);
                    if (navItem) navItem.style.display = hasSectionPermission ? 'block' : 'none';
                    
                    if (hasSectionPermission && parentSection) {
                        sectionVisibility[parentSection] = true;
                    }
                } else {
                    if (navItem) navItem.style.display = 'none';
                }
            });
            
            // Hide entire sidebar sections if no items are visible
            Object.keys(sectionVisibility).forEach(sectionId => {
                const sectionElement = document.getElementById(sectionId);
                const sectionHeader = sectionElement?.closest('.sidebar-section');
                
                if (sectionElement && sectionHeader) {
                    // Check if any items are visible in this section
                    const hasVisibleItems = Array.from(sectionElement.querySelectorAll('.nav-item')).some(item => {
                        if (!item) return false;
                        return item.style.display !== 'none' && window.getComputedStyle(item).display !== 'none';
                    });
                    
                    if (!hasVisibleItems) {
                        if (sectionHeader) sectionHeader.style.display = 'none';
                        // Also hide the separator before this section
                        const separator = sectionHeader?.previousElementSibling;
                        if (separator && separator.classList && separator.classList.contains('sidebar-section-separator')) {
                            separator.style.display = 'none';
                        }
                    } else {
                        if (sectionHeader) sectionHeader.style.display = 'block';
                        const separator = sectionHeader?.previousElementSibling;
                        if (separator && separator.classList && separator.classList.contains('sidebar-section-separator')) {
                            separator.style.display = 'block';
                        }
                    }
                }
            });
            
            // Handle sidebar-bottom-link settings (admin-only)
            const bottomSettingsLink = document.querySelector('.sidebar-bottom-link[data-section="settings"]');
            if (bottomSettingsLink) {
                const hasSettingsPermission = hasPermission('settings', permissions);
                bottomSettingsLink.style.display = hasSettingsPermission ? 'block' : 'none';
            }
            
            // Explicitly check and hide support section if user doesn't have permission
            const supportSection = document.querySelector('.sidebar-section:has(#supportSectionItems)');
            const supportSectionHeader = document.getElementById('supportSectionItems')?.closest('.sidebar-section');
            if (supportSection || supportSectionHeader) {
                const hasSupportPermission = hasPermission('support-chat', permissions);
                const supportSectionElement = supportSection || supportSectionHeader;
                if (supportSectionElement) {
                    supportSectionElement.style.display = hasSupportPermission ? 'block' : 'none';
                    // Also hide separator before support section
                    const separator = supportSectionElement?.previousElementSibling;
                    if (separator && separator.classList && separator.classList.contains('sidebar-section-separator')) {
                        separator.style.display = hasSupportPermission ? 'block' : 'none';
                    }
                }
            }

            // Update report tabs visibility
            updateReportTabsVisibility(permissions);
            
            // Also hide/show internal payment tab buttons by specific permission
            document.querySelectorAll('[data-payment-tab]').forEach(btn => {
                const tab = btn.getAttribute('data-payment-tab');
                if (tab && tab.startsWith('payment-')) {
                    btn.style.display = permissions.includes(tab) ? '' : 'none';
                }
            });
            
            // Hide/show Payment Voucher section tabs based on permissions
            // Supplier Voucher Tab - requires 'payment-vouchers' permission (admin bypass allowed)
            const supplierVoucherTab = document.getElementById('supplier-voucher-tab');
            if (supplierVoucherTab && supplierVoucherTab.parentElement) {
                const hasSupplierVoucherPermission = isAdmin || permissions.includes('payment-vouchers');
                supplierVoucherTab.parentElement.style.display = hasSupplierVoucherPermission ? '' : 'none';
            }
            
            // Category Voucher Tab - requires 'category-voucher' permission (admin bypass allowed)
            const categoryVoucherTab = document.getElementById('category-voucher-tab');
            if (categoryVoucherTab && categoryVoucherTab.parentElement) {
                const hasCategoryVoucherPermission = isAdmin || permissions.includes('category-voucher');
                categoryVoucherTab.parentElement.style.display = hasCategoryVoucherPermission ? '' : 'none';
                
                // If category voucher tab is hidden but supplier voucher is visible, make supplier tab active
                if (!hasCategoryVoucherPermission && supplierVoucherTab && (isAdmin || permissions.includes('payment-vouchers'))) {
                    supplierVoucherTab.classList.add('active');
                    const supplierContent = document.getElementById('supplier-voucher-content');
                    if (supplierContent) supplierContent.classList.add('show', 'active');
                    categoryVoucherTab.classList.remove('active');
                    const categoryContent = document.getElementById('category-voucher-content');
                    if (categoryContent) categoryContent.classList.remove('show', 'active');
                }
            }
            
            // Payment voucher list tabs inside payment-voucher-list section (voucherListTabs)
            // Check for supplier voucher list tab (admin bypass allowed)
            const supplierVoucherListTab = document.querySelector('#voucherListTabs [data-bs-target="#supplier-voucher-list-content"]');
            if (supplierVoucherListTab && supplierVoucherListTab.parentElement) {
                const hasPaymentVoucherListPermission = isAdmin || permissions.includes('payment-voucher-list');
                supplierVoucherListTab.parentElement.style.display = hasPaymentVoucherListPermission ? '' : 'none';
            }
            
            // Check for category voucher list tab (inside voucher list section) (admin bypass allowed)
            const categoryVoucherListTabBtn = document.querySelector('#voucherListTabs [data-bs-target="#category-voucher-list-content"]');
            if (categoryVoucherListTabBtn && categoryVoucherListTabBtn.parentElement) {
                const hasCategoryVoucherListPermission = isAdmin || permissions.includes('category-voucher-list');
                categoryVoucherListTabBtn.parentElement.style.display = hasCategoryVoucherListPermission ? '' : 'none';
                
                // If category voucher list tab is hidden but supplier voucher list is visible, make supplier tab active
                if (!hasCategoryVoucherListPermission && supplierVoucherListTab && (isAdmin || permissions.includes('payment-voucher-list'))) {
                    supplierVoucherListTab.classList.add('active');
                    const supplierListContent = document.getElementById('supplier-voucher-list-content');
                    if (supplierListContent) supplierListContent.classList.add('show', 'active');
                    categoryVoucherListTabBtn.classList.remove('active');
                    const categoryListContent = document.getElementById('category-voucher-list-content');
                    if (categoryListContent) categoryListContent.classList.remove('show', 'active');
                }
            }
        }
        
        // Update report tabs visibility based on permissions
        function updateReportTabsVisibility(permissions) {
            const isAdmin = permissions.includes('admin');
            
            // Report tab permission mapping
            const reportTabPermissions = {
                'sales-report': ['sales-report'],
                'sales-comparison-report': ['sales-comparison-report'],
                'datewise-sales-report': ['datewise-sales-report'],
                'payment-reports': ['payment-reports'],
                'department-wise-report': ['department-wise-report'],
                'sub-department-wise-report': ['sub-department-wise-report'],
                'department-wise-sale-comparison': ['department-wise-sale-comparison'],
                'branch-wise-sale-comparison': ['branch-wise-sale-comparison']
            };
            
            // Hide/show report tabs
            document.querySelectorAll('.report-tab').forEach(tab => {
                const tabId = tab.getAttribute('data-tab');
                const requiredPerms = reportTabPermissions[tabId];
                
                if (requiredPerms) {
                    // All reports: admin bypass allowed
                    if (tabId === 'payment-reports') {
                        const hasPermission = isAdmin || permissions.includes('payment-reports');
                        tab.style.display = hasPermission ? 'flex' : 'none';
                    } else {
                        // Other reports: admin bypass allowed
                        const hasPermission = isAdmin || requiredPerms.some(perm => permissions.includes(perm));
                        tab.style.display = hasPermission ? 'flex' : 'none';
                    }
                }
            });
            
            // Hide report tabs container if no tabs are visible
            const reportTabsContainer = document.querySelector('.report-tabs');
            if (reportTabsContainer) {
                const hasVisibleTabs = Array.from(reportTabsContainer.querySelectorAll('.report-tab')).some(tab => {
                    return tab.style.display !== 'none' && window.getComputedStyle(tab).display !== 'none';
                });
                reportTabsContainer.style.display = hasVisibleTabs ? 'flex' : 'none';
            }
        }
        
        // ========================================
        // EVENT LISTENER FUNCTIONS
        // ========================================
        
        // Setup event listeners
        function setupEventListeners() {
            // Logo click handler - navigate to dashboard
            document.querySelector('.navbar-brand').addEventListener('click', function(e) {
                e.preventDefault();
                window.location.hash = 'dashboard';
                showSection('dashboard');
                
                // Update active state
                document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector('.sidebar .nav-link[data-section="dashboard"]').classList.add('active');
                
                // Close mobile sidebar after navigation
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.remove('active');
                    document.getElementById('sidebarOverlay').classList.remove('active');
                }
            });
            
            // Mobile menu toggle
            document.getElementById('mobileMenuToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('active');
                document.getElementById('sidebarOverlay').classList.toggle('active');
            });
            
            // Close sidebar when clicking overlay
            document.getElementById('sidebarOverlay').addEventListener('click', function() {
                document.getElementById('sidebar').classList.remove('active');
                this.classList.remove('active');
            });
            
            // Handle sidebar section collapse/expand
            document.querySelectorAll('.sidebar-section-header[data-bs-toggle="collapse"]').forEach(header => {
                // Remove Bootstrap's default behavior by removing the data attribute
                header.removeAttribute('data-bs-toggle');
                
                // Function to toggle collapse
                const toggleCollapse = function(element) {
                    const targetId = element.getAttribute('data-bs-target');
                    const target = document.querySelector(targetId);
                    
                    if (target) {
                        // Check current state by looking at both class and aria-expanded
                        const hasShowClass = target.classList.contains('show');
                        const ariaExpanded = element.getAttribute('aria-expanded') === 'true';
                        const isExpanded = hasShowClass || ariaExpanded;
                        
                        if (isExpanded) {
                            // Collapse - remove show class and update aria
                            target.classList.remove('show');
                            element.setAttribute('aria-expanded', 'false');
                        } else {
                            // Expand - add show class and update aria
                            target.classList.add('show');
                            element.setAttribute('aria-expanded', 'true');
                        }
                    }
                };
                
                // Handle clicks on the header (but not on the chevron)
                header.addEventListener('click', function(e) {
                    // Don't handle if clicking directly on chevron (it has its own handler)
                    if (e.target.closest('.section-chevron')) {
                        return;
                    }
                    e.preventDefault();
                    e.stopPropagation();
                    toggleCollapse(this);
                });
                
                // Handle clicks directly on the chevron icon
                const chevron = header.querySelector('.section-chevron');
                if (chevron) {
                    chevron.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation(); // Prevent any other handlers
                        toggleCollapse(header);
                    });
                }
            });
            
            // Full sidebar collapse/expand toggle
            const sidebarToggleIcon = document.getElementById('sidebarToggleIcon');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebarToggleIcon && sidebar) {
                // Function to toggle sidebar
                const toggleSidebar = function(e) {
                    if (e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    
                    // Toggle the collapsed class
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    
                    if (isCollapsed) {
                        // Expand sidebar
                        sidebar.classList.remove('collapsed');
                        document.documentElement.style.setProperty('--sidebar-width', '240px');
                        if (mainContent) {
                            mainContent.style.marginLeft = '240px';
                        }
                        document.querySelectorAll('.content-section').forEach(section => {
                            section.style.marginLeft = '240px';
                        });
                    } else {
                        // Collapse sidebar
                        sidebar.classList.add('collapsed');
                        document.documentElement.style.setProperty('--sidebar-width', '70px');
                        if (mainContent) {
                            mainContent.style.marginLeft = '70px';
                        }
                        document.querySelectorAll('.content-section').forEach(section => {
                            section.style.marginLeft = '70px';
                        });
                    }
                };
                
                // Remove any existing event listeners by cloning and replacing
                const newToggleIcon = sidebarToggleIcon.cloneNode(true);
                sidebarToggleIcon.parentNode.replaceChild(newToggleIcon, sidebarToggleIcon);
                
                // Add click handler to the toggle button
                newToggleIcon.addEventListener('click', toggleSidebar);
                
                // Also handle clicks on the chevron icon inside
                const chevronIcon = newToggleIcon.querySelector('i');
                if (chevronIcon) {
                    chevronIcon.addEventListener('click', toggleSidebar);
                }
            }
            
            // Logout button - Ensure it works on all devices
            // User dropdown button - Toggle logout button visibility
            const userDropdown = document.getElementById('userDropdown');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (userDropdown && logoutBtn) {
                // Toggle logout button when user button is clicked
                userDropdown.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Toggle logout button visibility
                    if (logoutBtn.style.display === 'none' || !logoutBtn.style.display) {
                        logoutBtn.style.display = 'inline-block';
                    } else {
                        logoutBtn.style.display = 'none';
                    }
                });
                
                // Handle touch events for mobile
                userDropdown.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (logoutBtn.style.display === 'none' || !logoutBtn.style.display) {
                        logoutBtn.style.display = 'inline-block';
                    } else {
                        logoutBtn.style.display = 'none';
                    }
                });
            }
            
            // Logout button - Log out when clicked
            if (logoutBtn) {
                // Handle click event
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    logout();
                });
                
                // Handle touch events for mobile devices
                logoutBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    logout();
                });
            }
            
            // Hide logout button when clicking outside
            document.addEventListener('click', function(e) {
                if (logoutBtn && userDropdown) {
                    const userMenuContainer = userDropdown.closest('.user-menu-container');
                    if (userMenuContainer && !userMenuContainer.contains(e.target)) {
                        logoutBtn.style.display = 'none';
                    }
                }
            });
            
            // Navigation
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                // Skip toggle/collapse links (they don't have data-section and are handled separately)
                if (link.id === 'reportsMenuToggle' || link.id === 'warehouseReportsToggle' || link.id === 'shopReportsToggle') {
                    return;
                }
                
                // Skip links that are collapse toggles (have data-bs-toggle="collapse" but no data-section)
                if (link.getAttribute('data-bs-toggle') === 'collapse' && !link.getAttribute('data-section')) {
                    return;
                }
                
                // Set href to hash for right-click "Open in new tab" support
                const section = link.getAttribute('data-section');
                if (section) {
                    link.href = '#' + section;
                }
                
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    const reportTab = this.getAttribute('data-report');
                    
                    // Skip if this is a toggle/collapse link without data-section
                    if (!section && (this.id === 'warehouseReportsToggle' || this.id === 'shopReportsToggle' || this.getAttribute('data-bs-toggle') === 'collapse')) {
                        // This is a collapse toggle, let Bootstrap handle it
                        return;
                    }
                    
                    // Validate section before proceeding
                    if (!section || section === 'null' || section === 'undefined' || section === '') {
                        console.error(' Invalid section from sidebar link:', section, this);
                        showNotification('Invalid section selected', 'error');
                        return;
                    }
                    
                    // Check if user has permission to access this section
                    const permissions = appData.currentUser?.permissions || [];
                    const isAdmin = permissions.includes('admin');
                    
                    // For reports section with specific report tab, check individual report permission
                    if (section === 'reports' && reportTab) {
                        // Validate reportTab before checking permissions
                        if (!reportTab || reportTab === 'null' || reportTab === 'undefined') {
                            console.error('Invalid reportTab from sidebar:', reportTab);
                            showNotification('Invalid report selected', 'error');
                            return;
                        }
                        
                        // Admin has access to all reports - skip permission check
                        if (!isAdmin && !hasPermission(reportTab, permissions)) {
                            showNotification(`You don't have permission to access ${reportTab}`, 'error');
                            return;
                        }
                    } else if (section) {
                        // Admin has access to all sections (except payment and support)
                        if (isAdmin && !section.startsWith('payment-') && section !== 'support-chat') {
                            // Admin can access, continue
                        } else {
                            // Check if user has permission for this section
                            if (!hasPermission(section, permissions)) {
                                showNotification(`You don't have permission to access ${section}`, 'error');
                                return;
                            }
                        }
                    }
                    
                    // Update URL hash for new tab support
                    window.location.hash = section;
                    showSection(section);
                    
                    // If it's a report submenu item, switch to the specific tab and show only that tab
                    if (section === 'reports' && reportTab) {
                        // Validate reportTab again before calling switchReportTab
                        if (reportTab && reportTab !== 'null' && reportTab !== 'undefined') {
                            // Store in localStorage that user came from sidebar
                            localStorage.setItem('lastReportFromSidebar', reportTab);
                            setTimeout(() => {
                                switchReportTab(reportTab, true); // Pass true to show only active tab
                            }, 100);
                        } else {
                            console.error('Cannot switch to report tab - invalid reportTab:', reportTab);
                        }
                    } else if (section === 'reports' && !reportTab) {
                        // User clicked on Reports main menu (not a specific report) - clear sidebar flag
                        localStorage.removeItem('lastReportFromSidebar');
                    } else if (section === 'reports' && !reportTab) {
                        // If clicking on Reports main menu (not a specific report), show all tabs
                        const reportTabsNav = document.querySelector('.report-tabs');
                        if (reportTabsNav) {
                            // Show all tabs
                            document.querySelectorAll('.report-tab').forEach(tab => {
                                tab.style.display = 'flex';
                            });
                            reportTabsNav.style.display = 'flex';
                        }
                    }
                    
                    // Update active state
                    document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Close mobile sidebar after navigation
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('active');
                        document.getElementById('sidebarOverlay').classList.remove('active');
                    }
                });
            });
            
            // Handle reports menu toggle (chevron rotation)
            const reportsMenuToggle = document.getElementById('reportsMenuToggle');
            if (reportsMenuToggle) {
                const reportsSubmenu = document.getElementById('reportsSubmenu');
                let reportsCollapse = null;
                
                // Initialize Bootstrap Collapse instance once
                if (reportsSubmenu) {
                    reportsCollapse = new bootstrap.Collapse(reportsSubmenu, { toggle: false });
                }
                
                const toggleReportsMenu = function() {
                    if (reportsCollapse && reportsSubmenu) {
                        // Check current state and toggle accordingly
                        const isExpanded = reportsMenuToggle.getAttribute('aria-expanded') === 'true';
                        if (isExpanded) {
                            reportsCollapse.hide();
                        } else {
                            reportsCollapse.show();
                        }
                    }
                };
                
                reportsMenuToggle.addEventListener('click', function(e) {
                    // Prevent default navigation
                    e.preventDefault();
                    e.stopPropagation();
                    toggleReportsMenu();
                });
                
                // Handle clicks on the chevron
                const reportsChevron = document.getElementById('reportsChevron');
                if (reportsChevron) {
                    reportsChevron.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        toggleReportsMenu();
                    });
                }
                
                // Listen for collapse events to rotate chevron
                if (reportsSubmenu) {
                    reportsSubmenu.addEventListener('show.bs.collapse', function() {
                        const chevron = document.getElementById('reportsChevron');
                        if (chevron) {
                            chevron.style.transform = 'rotate(90deg)';
                        }
                        reportsMenuToggle.setAttribute('aria-expanded', 'true');
                    });
                    
                    reportsSubmenu.addEventListener('hide.bs.collapse', function() {
                        const chevron = document.getElementById('reportsChevron');
                        if (chevron) {
                            chevron.style.transform = 'rotate(0deg)';
                        }
                        reportsMenuToggle.setAttribute('aria-expanded', 'false');
                    });
                }
            }
            
            // Handle warehouse reports submenu toggle
            const warehouseReportsToggle = document.getElementById('warehouseReportsToggle');
            if (warehouseReportsToggle) {
                const warehouseReportsSubmenu = document.getElementById('warehouseReportsSubmenu');
                let warehouseCollapse = null;
                
                // Initialize Bootstrap Collapse instance once
                if (warehouseReportsSubmenu) {
                    warehouseCollapse = new bootstrap.Collapse(warehouseReportsSubmenu, { toggle: false });
                }
                
                const toggleWarehouseReports = function() {
                    if (warehouseCollapse && warehouseReportsSubmenu) {
                        // Check current state and toggle accordingly
                        const isExpanded = warehouseReportsToggle.getAttribute('aria-expanded') === 'true';
                        if (isExpanded) {
                            warehouseCollapse.hide();
                        } else {
                            warehouseCollapse.show();
                        }
                    }
                };
                
                warehouseReportsToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleWarehouseReports();
                });
                
                // Handle clicks on the chevron
                const warehouseReportsChevron = document.getElementById('warehouseReportsChevron');
                if (warehouseReportsChevron) {
                    warehouseReportsChevron.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        toggleWarehouseReports();
                    });
                }
                
                if (warehouseReportsSubmenu) {
                    warehouseReportsSubmenu.addEventListener('show.bs.collapse', function() {
                        const chevron = document.getElementById('warehouseReportsChevron');
                        if (chevron) {
                            chevron.style.transform = 'rotate(90deg)';
                        }
                        warehouseReportsToggle.setAttribute('aria-expanded', 'true');
                    });
                    
                    warehouseReportsSubmenu.addEventListener('hide.bs.collapse', function() {
                        const chevron = document.getElementById('warehouseReportsChevron');
                        if (chevron) {
                            chevron.style.transform = 'rotate(0deg)';
                        }
                        warehouseReportsToggle.setAttribute('aria-expanded', 'false');
                    });
                }
            }
            
            // Handle shop reports submenu toggle
            const shopReportsToggle = document.getElementById('shopReportsToggle');
            if (shopReportsToggle) {
                const shopReportsSubmenu = document.getElementById('shopReportsSubmenu');
                let shopCollapse = null;
                
                // Initialize Bootstrap Collapse instance once
                if (shopReportsSubmenu) {
                    shopCollapse = new bootstrap.Collapse(shopReportsSubmenu, { toggle: false });
                }
                
                const toggleShopReports = function() {
                    if (shopCollapse && shopReportsSubmenu) {
                        // Check current state and toggle accordingly
                        const isExpanded = shopReportsToggle.getAttribute('aria-expanded') === 'true';
                        if (isExpanded) {
                            shopCollapse.hide();
                        } else {
                            shopCollapse.show();
                        }
                    }
                };
                
                shopReportsToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleShopReports();
                });
                
                // Handle clicks on the chevron
                const shopReportsChevron = document.getElementById('shopReportsChevron');
                if (shopReportsChevron) {
                    shopReportsChevron.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        toggleShopReports();
                    });
                }
                
                if (shopReportsSubmenu) {
                    shopReportsSubmenu.addEventListener('show.bs.collapse', function() {
                        const chevron = document.getElementById('shopReportsChevron');
                        if (chevron) {
                            chevron.style.transform = 'rotate(90deg)';
                        }
                        shopReportsToggle.setAttribute('aria-expanded', 'true');
                    });
                    
                    shopReportsSubmenu.addEventListener('hide.bs.collapse', function() {
                        const chevron = document.getElementById('shopReportsChevron');
                        if (chevron) {
                            chevron.style.transform = 'rotate(0deg)';
                        }
                        shopReportsToggle.setAttribute('aria-expanded', 'false');
                    });
                }
            }
            
            // Handle browser back/forward and direct hash navigation
            window.addEventListener('hashchange', function() {
                const hash = window.location.hash.replace('#', '');
                if (hash && hash !== '' && hash !== 'null' && hash !== 'undefined' && appData.currentUser) {
                    const section = hash;
                    
                    // Validate section before proceeding
                    if (!section || section === 'null' || section === 'undefined' || section === '') {
                        console.error(' Invalid section from hash change:', section);
                        return;
                    }
                    
                    const permissions = appData.currentUser?.permissions || [];
                    
                    // Check permissions before showing section
                    if (['groups', 'users', 'settings'].includes(section) && !permissions.includes('admin')) {
                        showNotification('You need admin privileges to access this section', 'error');
                        return;
                    }
                    
                    if (section && !['groups', 'users', 'settings'].includes(section) && !permissions.includes(section)) {
                        showNotification(`You don't have permission to access ${section}`, 'error');
                        return;
                    }
                    
                    showSection(section);
                    
                    // Update active state
                    document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                    const activeLink = document.querySelector(`.sidebar .nav-link[data-section="${section}"]`);
                    if (activeLink) {
                        activeLink.classList.add('active');
                    }
                }
            });
            
            // Populate month filter dropdown on initialization
            populateMonthFilter();
            
            
            // Helper function to get active dashboard tab prefix
            function getActiveDashboardTabPrefix() {
                const warehouseTab = document.getElementById('warehouse-dashboard-tab');
                const shopTab = document.getElementById('shop-dashboard-tab');
                if (warehouseTab && warehouseTab.classList.contains('active')) {
                    return 'warehouse';
                } else if (shopTab && shopTab.classList.contains('active')) {
                    return 'shop';
                }
                return 'warehouse'; // Default to warehouse
            }
            
            // Helper function to get element ID with tab prefix
            function getDashboardElementId(baseId) {
                const prefix = getActiveDashboardTabPrefix();
                return prefix + baseId.charAt(0).toUpperCase() + baseId.slice(1);
            }
            
            // Update trends button (removed - element doesn't exist in new layout)
            
            // Refresh comparison chart button - Warehouse
            const warehouseRefreshChartBtn = document.getElementById('warehouseRefreshComparisonChartBtn');
            if (warehouseRefreshChartBtn) {
                warehouseRefreshChartBtn.addEventListener('click', function() {
                    updateTrendsChart('warehouse');
                showNotification('Sales comparison chart refreshed successfully!', 'success');
            });
            }
            
            // Refresh branch comparison chart button - Shop
            const shopRefreshBranchChartBtn = document.getElementById('shopRefreshBranchChartBtn');
            if (shopRefreshBranchChartBtn) {
                shopRefreshBranchChartBtn.addEventListener('click', function() {
                    updateBranchChart('shop');
                    showNotification('Branch comparison chart refreshed successfully!', 'success');
                });
            }
            
            // Refresh comparison table button - Warehouse
            const warehouseRefreshTableBtn = document.getElementById('warehouseRefreshComparisonTableBtn');
            if (warehouseRefreshTableBtn) {
                warehouseRefreshTableBtn.addEventListener('click', function() {
                    const selectedMonth = document.getElementById('warehouseDashboardMonthFilter').value;
                    loadDashboard(selectedMonth || null, 'warehouse');
                showNotification('Comparison tables refreshed successfully!', 'success');
            });
            }
            
            // Refresh buttons removed for shop dashboard - data loads automatically
            
            // Setup date range filters for both tabs
            function setupDateRangeFilters(prefix) {
                const dateRangeDropdownItems = document.querySelectorAll(`#${prefix}DateRangeFilterDropdown [data-date-range]`);
                const dateRangeFilterInput = document.getElementById(`${prefix}DashboardDateRangeFilter`);
                const monthFilterInput = document.getElementById(`${prefix}DashboardMonthFilter`);
                const dateFromInput = document.getElementById(`${prefix}DashboardTopDateFrom`);
                const dateToInput = document.getElementById(`${prefix}DashboardTopDateTo`);
                const applyCustomDateRangeBtn = document.getElementById(`${prefix}ApplyCustomDateRangeBtn`);
                const clearCustomDateRangeBtn = document.getElementById(`${prefix}ClearCustomDateRangeBtn`);
                if (!dateRangeFilterInput || dateRangeDropdownItems.length === 0) return;
            
                // Initialize active state based on default value
                const defaultDateRange = dateRangeFilterInput?.value || 'currentMonth';
            
                // Special handling for Shop Dashboard with "yesterday" as default
                if (prefix === 'shop' && defaultDateRange === 'yesterday') {
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    yesterday.setHours(0, 0, 0, 0);
                    
                    const formatDate = (date) => {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    };
                    
                    const yesterdayStr = formatDate(yesterday);
                    
                    if (dateFromInput) dateFromInput.value = yesterdayStr;
                    if (dateToInput) dateToInput.value = yesterdayStr;
                    
                    dateRangeFilterInput.value = 'custom';
                }
            
                const finalDateRange = dateRangeFilterInput?.value || 'currentMonth';
                dateRangeDropdownItems.forEach(item => {
                    const itemRange = item.getAttribute('data-date-range');
                    if (itemRange === finalDateRange || 
                        (prefix === 'shop' && finalDateRange === 'custom' && itemRange === 'yesterday')) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            
                dateRangeDropdownItems.forEach(item => {
                    if (item.dataset.listenerAttached === 'true') return;
                    item.dataset.listenerAttached = 'true';
                    
                    item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const dateRange = this.getAttribute('data-date-range');
                    
                    // Special handling for "Yesterday Sale" button
                    if (dateRange === 'yesterday') {
                        // Calculate yesterday's date (previous day)
                        const today = new Date();
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        yesterday.setHours(0, 0, 0, 0);
                        
                        // Format date as YYYY-MM-DD
                        const formatDate = (date) => {
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            return `${year}-${month}-${day}`;
                        };
                        
                        // Both From and To date should be yesterday (single day filter)
                        const yesterdayStr = formatDate(yesterday);
                        
                        // Set date inputs to yesterday (same date for both from and to)
                        if (dateFromInput) dateFromInput.value = yesterdayStr;
                        if (dateToInput) dateToInput.value = yesterdayStr;
                        
                        // Set filter to custom so it uses the date inputs
                        dateRangeFilterInput.value = 'custom';
                        
                        // Update visual indicator - remove active class from all items
                        dateRangeDropdownItems.forEach(i => i.classList.remove('active'));
                        // Add active class to selected item
                        this.classList.add('active');
                        
                        // Reload dashboard with yesterday's date filter
                        const selectedMonth = monthFilterInput?.value || '';
                        loadDashboard(selectedMonth || null, prefix);
                        
                        const dropdownBtn = document.getElementById(`${prefix}DateRangeFilterBtn`);
                        if (window.bootstrap && dropdownBtn) {
                            const dropdown = window.bootstrap.Dropdown.getInstance(dropdownBtn);
                            if (dropdown) dropdown.hide();
                        }
                        return;
                    }
                    
                    // Standard handling for other date ranges
                    dateRangeFilterInput.value = dateRange;
                    
                    // Update visual indicator - remove active class from all items
                    dateRangeDropdownItems.forEach(i => i.classList.remove('active'));
                    // Add active class to selected item
                    this.classList.add('active');
                    
                    // Clear custom date inputs if not custom
                    if (dateRange !== 'custom') {
                            document.getElementById(`${prefix}DashboardTopDateFrom`).value = '';
                            document.getElementById(`${prefix}DashboardTopDateTo`).value = '';
                    }
                    
                    const selectedMonth = monthFilterInput?.value || '';
                    loadDashboard(selectedMonth || null, prefix);
                });
            });
            
            if (applyCustomDateRangeBtn && applyCustomDateRangeBtn.dataset.listenerAttached !== 'true') {
                applyCustomDateRangeBtn.dataset.listenerAttached = 'true';
                applyCustomDateRangeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                        const dateFrom = document.getElementById(`${prefix}DashboardTopDateFrom`).value;
                        const dateTo = document.getElementById(`${prefix}DashboardTopDateTo`).value;
                    
                    if (!dateFrom || !dateTo) {
                        showNotification('Please select both From Date and To Date', 'error');
                        return;
                    }
                    
                    if (new Date(dateFrom) > new Date(dateTo)) {
                        showNotification('From Date cannot be greater than To Date', 'error');
                        return;
                    }
                    
                        dateRangeFilterInput.value = 'custom';
                    
                    // Update visual indicator
                    dateRangeDropdownItems.forEach(i => i.classList.remove('active'));
                    
                    // Reload dashboard with custom date filter
                        const selectedMonth = monthFilterInput?.value || '';
                        loadDashboard(selectedMonth || null, prefix);
                    
                    const dropdownBtn = document.getElementById(`${prefix}DateRangeFilterBtn`);
                    if (window.bootstrap && dropdownBtn) {
                        const dropdown = window.bootstrap.Dropdown.getInstance(dropdownBtn);
                        if (dropdown) dropdown.hide();
                    }
                });
                }

                setupCustomDateInputs(prefix, dateFromInput, dateToInput, dateRangeFilterInput, applyCustomDateRangeBtn, clearCustomDateRangeBtn, dateRangeDropdownItems);
            }
            
            function setupCustomDateInputs(prefix, dateFromInput, dateToInput, dateRangeFilterInput, applyBtn, clearBtn, dropdownItems = []) {
                if (!dateFromInput || !dateToInput || !applyBtn || !dateRangeFilterInput) return;
                
                const toggleApplyState = () => {
                    const hasBothDates = Boolean(dateFromInput.value) && Boolean(dateToInput.value);
                    applyBtn.disabled = !hasBothDates;
                    if (hasBothDates) {
                        dateRangeFilterInput.value = 'custom';
                    }
                };
                
                if (dateFromInput.dataset.listenerAttached !== 'true') {
                    ['input', 'change'].forEach(evt => {
                        dateFromInput.addEventListener(evt, toggleApplyState);
                        dateToInput.addEventListener(evt, toggleApplyState);
                    });
                    
                    dateFromInput.dataset.listenerAttached = 'true';
                    dateToInput.dataset.listenerAttached = 'true';
                }
                
                if (clearBtn && clearBtn.dataset.listenerAttached !== 'true') {
                    clearBtn.dataset.listenerAttached = 'true';
                    clearBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (dateFromInput) dateFromInput.value = '';
                        if (dateToInput) dateToInput.value = '';
                        applyBtn.disabled = true;
                        dateRangeFilterInput.value = 'custom';
                        dropdownItems.forEach(i => i.classList.remove('active'));
                    });
                }
                
                toggleApplyState();
            }
            
            function initializeDashboardFilters() {
                setupDateRangeFilters('warehouse');
                setupDateRangeFilters('shop');
                setupSortBySaleFilter();
                setupBranchFilters('warehouse');
                setupBranchFilters('shop');
                setupPaymentDetailsFilters('warehouse');
                setupPaymentDetailsFilters('shop');
            }
            
            // Setup Sort by Sale filter for Shop Dashboard
            function setupSortBySaleFilter() {
                const sortDropdown = document.getElementById('shopSortBySaleDropdown');
                const sortFilterInput = document.getElementById('shopDashboardSortBySale');
                
                if (!sortDropdown || !sortFilterInput) return;
                
                const sortItems = sortDropdown.querySelectorAll('a[data-sort]');
                const defaultSort = sortFilterInput.value || 'net-sale-desc';
                
                // Initialize active state based on default value
                sortItems.forEach(item => {
                    if (item.getAttribute('data-sort') === defaultSort) {
                        item.classList.add('active');
                    }
                });
                
                sortItems.forEach(item => {
                    if (item.dataset.listenerAttached === 'true') return;
                    item.dataset.listenerAttached = 'true';
                    
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const sortOption = this.getAttribute('data-sort');
                        
                        // Update hidden input
                        sortFilterInput.value = sortOption;
                        
                        // Update visual indicator
                        sortItems.forEach(i => i.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Reload dashboard with new sort
                        const selectedMonth = document.getElementById('shopDashboardMonthFilter')?.value || '';
                        loadDashboard(selectedMonth || null, 'shop');
                        
                        const dropdownBtn = document.getElementById('shopSortBySaleBtn');
                        if (window.bootstrap && dropdownBtn) {
                            const dropdown = window.bootstrap.Dropdown.getInstance(dropdownBtn);
                            if (dropdown) dropdown.hide();
                        }
                    });
                });
            }
            
            // Initialize sort by sale filter
            setupSortBySaleFilter();
            
            // Setup branch filter dropdowns for both tabs
            function setupBranchFilters(prefix) {
                const filterBtn = document.getElementById(`${prefix}FilterDashboardBtn`);
                const filterDropdown = document.getElementById(`${prefix}FilterDashboardDropdown`);
                
                if (filterBtn && filterDropdown) {
                    if (filterBtn.dataset.listenerAttached !== 'true') {
                        filterBtn.dataset.listenerAttached = 'true';
                    }
                    // Populate branch filter dropdown
                    function populateBranchFilter() {
                        filterDropdown.innerHTML = '<li class="dropdown-item-text fw-bold">Filter by Branch:</li><li><hr class="dropdown-divider"></li>';
                        appData.branches.forEach(branch => {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.className = 'dropdown-item';
                            a.href = '#';
                            a.textContent = branch.name;
                            a.addEventListener('click', function(e) {
                                e.preventDefault();
                                const selectedMonth = document.getElementById(`${prefix}DashboardMonthFilter`)?.value || '';
                                loadDashboard(selectedMonth || null, prefix);
                            });
                            li.appendChild(a);
                            filterDropdown.appendChild(li);
                        });
                    }
                    
                    // Populate on load
                    if (appData.branches && appData.branches.length > 0) {
                        populateBranchFilter();
                    }
                }
            }
            
            setupBranchFilters('warehouse');
            setupBranchFilters('shop');
            
            // Setup payment details filters for both tabs
            function setupPaymentDetailsFilters(prefix) {
            // Dashboard Payment Details Refresh Button
                const refreshPaymentDetailsBtn = document.getElementById(`${prefix}RefreshPaymentDetailsBtn`);
            if (refreshPaymentDetailsBtn && refreshPaymentDetailsBtn.dataset.listenerAttached !== 'true') {
                refreshPaymentDetailsBtn.dataset.listenerAttached = 'true';
                refreshPaymentDetailsBtn.addEventListener('click', function() {
                        loadDashboardPaymentDetails(prefix);
                    showNotification('Payment details refreshed successfully!', 'success');
                });
            }
            
            // Dashboard Payment Branch Filter
                const dashboardPaymentBranchFilter = document.getElementById(`${prefix}DashboardPaymentBranchFilter`);
            if (dashboardPaymentBranchFilter && dashboardPaymentBranchFilter.dataset.listenerAttached !== 'true') {
                dashboardPaymentBranchFilter.dataset.listenerAttached = 'true';
                dashboardPaymentBranchFilter.addEventListener('change', function() {
                        loadDashboardPaymentDetails(prefix);
                });
            }
            
            // Dashboard Payment Category Filter
                const dashboardPaymentCategoryFilter = document.getElementById(`${prefix}DashboardPaymentCategoryFilter`);
            if (dashboardPaymentCategoryFilter && dashboardPaymentCategoryFilter.dataset.listenerAttached !== 'true') {
                dashboardPaymentCategoryFilter.dataset.listenerAttached = 'true';
                dashboardPaymentCategoryFilter.addEventListener('change', function() {
                        loadDashboardPaymentDetails(prefix);
                });
            }
            
            // Dashboard Payment Date Filter
                const dashboardPaymentDateFilter = document.getElementById(`${prefix}DashboardPaymentDateFilter`);
            if (dashboardPaymentDateFilter && dashboardPaymentDateFilter.dataset.listenerAttached !== 'true') {
                dashboardPaymentDateFilter.dataset.listenerAttached = 'true';
                dashboardPaymentDateFilter.addEventListener('change', function() {
                        const customDateRange = document.getElementById(`${prefix}DashboardPaymentCustomDateRange`);
                    if (this.value === 'custom') {
                        if (customDateRange) {
                            customDateRange.classList.remove('d-none');
                            customDateRange.style.display = 'flex';
                        }
                    } else {
                        if (customDateRange) {
                            customDateRange.classList.add('d-none');
                            customDateRange.style.display = 'none';
                        }
                    }
                        loadDashboardPaymentDetails(prefix);
                });
            }
            
            // Dashboard Payment Custom Date Range
                const dashboardPaymentDateFrom = document.getElementById(`${prefix}DashboardPaymentDateFrom`);
                const dashboardPaymentDateTo = document.getElementById(`${prefix}DashboardPaymentDateTo`);
            if (dashboardPaymentDateFrom && dashboardPaymentDateFrom.dataset.listenerAttached !== 'true') {
                dashboardPaymentDateFrom.dataset.listenerAttached = 'true';
                dashboardPaymentDateFrom.addEventListener('change', function() {
                        loadDashboardPaymentDetails(prefix);
                });
            }
            if (dashboardPaymentDateTo && dashboardPaymentDateTo.dataset.listenerAttached !== 'true') {
                dashboardPaymentDateTo.dataset.listenerAttached = 'true';
                dashboardPaymentDateTo.addEventListener('change', function() {
                        loadDashboardPaymentDetails(prefix);
                    });
                }
            }
            
            setupPaymentDetailsFilters('warehouse');
            setupPaymentDetailsFilters('shop');
            
            initializeDashboardFilters();
            
            document.addEventListener('sectionLoaded', (event) => {
                if (event?.detail?.sectionName === 'dashboard') {
                    setTimeout(() => {
                        initializeDashboardFilters();
                    }, 50);
                }
            });
            
            // Dashboard tab switch event listeners
            const warehouseDashboardTab = document.getElementById('warehouse-dashboard-tab');
            const shopDashboardTab = document.getElementById('shop-dashboard-tab');
            
            if (warehouseDashboardTab) {
                warehouseDashboardTab.addEventListener('shown.bs.tab', function() {
                    const selectedMonth = document.getElementById('warehouseDashboardMonthFilter')?.value || '';
                    loadDashboard(selectedMonth || null, 'warehouse');
                });
            }
            
            if (shopDashboardTab) {
                shopDashboardTab.addEventListener('shown.bs.tab', function() {
                    const selectedMonth = document.getElementById('shopDashboardMonthFilter')?.value || '';
                    loadDashboard(selectedMonth || null, 'shop');
                });
            }
            
            // Populate month filter and load dashboard when dashboard section becomes active
            // This ensures it's populated even if dashboard loads before DOM is ready
            const dashboardSection = document.getElementById('dashboard-section');
            if (dashboardSection) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.target.classList.contains('active')) {
                            // Determine which tab is active
                            const activeTab = getActiveDashboardTabPrefix();
                            populateMonthFilter('warehouse');
                            populateMonthFilter('shop');
                            // Load dashboard for the active tab
                            const selectedMonth = document.getElementById(`${activeTab}DashboardMonthFilter`)?.value || '';
                            loadDashboard(selectedMonth || null, activeTab);
                        }
                    });
                });
                observer.observe(dashboardSection, { attributes: true, attributeFilter: ['class'] });
            }
            
            // Load dashboard on initial page load if dashboard section is active
            if (dashboardSection && dashboardSection.classList.contains('active')) {
                const activeTab = getActiveDashboardTabPrefix();
                populateMonthFilter('warehouse');
                populateMonthFilter('shop');
                const selectedMonth = document.getElementById(`${activeTab}DashboardMonthFilter`)?.value || '';
                loadDashboard(selectedMonth || null, activeTab);
            }
            
            // Sales entry form - prevent default form submission (including Enter key)
            const salesEntryForm = document.getElementById('salesEntryForm');
            if (salesEntryForm) {
                salesEntryForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    // Don't save on form submit - only save via Alt+S or button click
                    // Form submission is now disabled for Enter key
                });
            }
            
            // Prevent Enter key from submitting the sales form
            const salesForm = document.getElementById('salesEntryForm');
            if (salesForm) {
                salesForm.addEventListener('keydown', function(e) {
                    // Prevent Enter key from submitting form
                    if (e.key === 'Enter' || e.keyCode === 13) {
                        e.preventDefault();
                        return false;
                    }
                });
            }
            
            // Global Alt+S keyboard shortcut for all save buttons across all screens
            document.addEventListener('keydown', function(e) {
                // Check if Alt+S is pressed (not when typing in input fields like search boxes)
                if (e.altKey && (e.key === 's' || e.key === 'S')) {
                    // Skip if user is typing in certain input fields (like search, date filters, etc.)
                    const activeElement = document.activeElement;
                    const isInputField = activeElement && (
                        activeElement.tagName === 'INPUT' || 
                        activeElement.tagName === 'TEXTAREA'
                    );
                    
                    // Allow Alt+S in modals and forms, but skip in search/filter inputs
                    const skipInputs = ['search', 'filter', 'month'];
                    if (isInputField) {
                        const inputId = activeElement.id ? activeElement.id.toLowerCase() : '';
                        const inputType = activeElement.type ? activeElement.type.toLowerCase() : '';
                        // Skip if it's a search or filter input
                        if (skipInputs.some(skip => inputId.includes(skip) || inputType.includes(skip))) {
                            // Don't prevent default for search/filter inputs - allow browser default
                            return;
                        }
                    }
                    
                        e.preventDefault();
                        e.stopPropagation();
                        
                    // Check which section is active and trigger the appropriate save action
                    let saveActionTriggered = false;
                    
                    // 1. Sales Entry Section
                    const salesSection = document.getElementById('sales-section');
                    if (salesSection && salesSection.classList.contains('active')) {
                        // Check which tab is active
                        const categoryTab = document.getElementById('category-tab');
                        const departmentTab = document.getElementById('department-tab');
                        
                        if (categoryTab && categoryTab.classList.contains('active')) {
                            // Category sales tab
                            const branchId = document.getElementById('saleBranch');
                            if (branchId && (!branchId.value || branchId.value === '')) {
                                showNotification('Please select a branch before saving', 'error');
                                branchId.focus();
                                return;
                            }
                            saveSalesEntry();
                            saveActionTriggered = true;
                        } else if (departmentTab && departmentTab.classList.contains('active')) {
                            // Department sales tab - check which form is being used
                            // Try bulk entry first (most common)
                            const bulkDeptBranchId = document.getElementById('bulkDeptSaleBranchTab2');
                            if (bulkDeptBranchId && bulkDeptBranchId.value) {
                                if (!bulkDeptBranchId.value || bulkDeptBranchId.value === '') {
                                    showNotification('Please select a branch before saving', 'error');
                                    bulkDeptBranchId.focus();
                                    return;
                                }
                                saveBulkDepartmentSalesEntryTab2();
                                saveActionTriggered = true;
                            } else {
                                // Try single entry form
                                const deptSaleBranch = document.getElementById('deptSaleBranch');
                                if (deptSaleBranch && deptSaleBranch.value) {
                                    if (!deptSaleBranch.value || deptSaleBranch.value === '') {
                                        showNotification('Please select a branch before saving', 'error');
                                        deptSaleBranch.focus();
                                        return;
                                    }
                                    saveDepartmentSalesEntry();
                                    saveActionTriggered = true;
                                }
                            }
                        }
                    }
                    
                    // 2. Categories Section
                    const categoriesSection = document.getElementById('categories-section');
                    if (!saveActionTriggered && categoriesSection && categoriesSection.classList.contains('active')) {
                        const saveBtn = document.getElementById('saveCategoryBtn');
                        const addCategoryModal = document.getElementById('addCategoryModal');
                        if (saveBtn && addCategoryModal && window.getComputedStyle(addCategoryModal).display !== 'none') {
                            // Check if modal is visible
                            const modal = bootstrap.Modal.getInstance(addCategoryModal);
                            if (modal && modal._isShown) {
                                saveBtn.click();
                                saveActionTriggered = true;
                            }
                        }
                    }
                    
                    // 3. Branches Section
                    const branchesSection = document.getElementById('branches-section');
                    if (!saveActionTriggered && branchesSection && branchesSection.classList.contains('active')) {
                        const saveBtn = document.getElementById('saveBranchBtn');
                        const addBranchModal = document.getElementById('addBranchModal');
                        if (saveBtn && addBranchModal && window.getComputedStyle(addBranchModal).display !== 'none') {
                            const modal = bootstrap.Modal.getInstance(addBranchModal);
                            if (modal && modal._isShown) {
                                saveBtn.click();
                                saveActionTriggered = true;
                            }
                        }
                    }
                    
                    // 4. Suppliers Section
                    const suppliersSection = document.getElementById('suppliers-section');
                    if (!saveActionTriggered && suppliersSection && suppliersSection.classList.contains('active')) {
                        const saveBtn = document.getElementById('saveSupplierBtn');
                        const addSupplierModal = document.getElementById('addSupplierModal');
                        if (saveBtn && addSupplierModal && window.getComputedStyle(addSupplierModal).display !== 'none') {
                            const modal = bootstrap.Modal.getInstance(addSupplierModal);
                            if (modal && modal._isShown) {
                                saveBtn.click();
                                saveActionTriggered = true;
                            }
                        }
                    }
                    
                    // 5. Groups Section
                    const groupsSection = document.getElementById('groups-section');
                    if (!saveActionTriggered && groupsSection && groupsSection.classList.contains('active')) {
                        const saveBtn = document.getElementById('saveGroupBtn');
                        const addGroupModal = document.getElementById('addGroupModal');
                        if (saveBtn && addGroupModal && window.getComputedStyle(addGroupModal).display !== 'none') {
                            const modal = bootstrap.Modal.getInstance(addGroupModal);
                            if (modal && modal._isShown) {
                                saveBtn.click();
                                saveActionTriggered = true;
                            }
                        }
                    }
                    
                    // 6. Users Section
                    const usersSection = document.getElementById('users-section');
                    if (!saveActionTriggered && usersSection && usersSection.classList.contains('active')) {
                        const saveBtn = document.getElementById('saveUserBtn');
                        const addUserModal = document.getElementById('addUserModal');
                        if (saveBtn && addUserModal && window.getComputedStyle(addUserModal).display !== 'none') {
                            const modal = bootstrap.Modal.getInstance(addUserModal);
                            if (modal && modal._isShown) {
                                saveBtn.click();
                                saveActionTriggered = true;
                            }
                        }
                    }
                    
                    // 7. Settings Section
                    const settingsSection = document.getElementById('settings-section');
                    if (!saveActionTriggered && settingsSection && settingsSection.classList.contains('active')) {
                        const settingsForm = document.getElementById('settingsForm');
                        const saveSettingsBtn = settingsForm ? settingsForm.querySelector('button[type="submit"]') : null;
                        if (saveSettingsBtn) {
                            saveSettingsBtn.click();
                            saveActionTriggered = true;
                        }
                    }
                    
                    // 8. Payment Vouchers Section (Supplier)
                    const paymentVouchersSection = document.getElementById('payment-vouchers-section');
                    if (!saveActionTriggered && paymentVouchersSection && paymentVouchersSection.classList.contains('active')) {
                        // Check if payment voucher form exists and is visible
                        const paymentForm = document.getElementById('paymentVoucherForm');
                        if (paymentForm && window.getComputedStyle(paymentForm).display !== 'none') {
                            // Find the save/submit button in payment voucher form
                            const savePaymentBtn = paymentForm.querySelector('button[type="submit"], button.btn-primary');
                            if (savePaymentBtn && !savePaymentBtn.disabled) {
                                savePaymentBtn.click();
                                saveActionTriggered = true;
                            }
                        }
                    }
                    
                    // Show notification if no save action was triggered
                    if (!saveActionTriggered) {
                        // Don't show notification if user was just typing in a field
                        if (!isInputField || (activeElement && activeElement.closest('form'))) {
                            // Silent - don't annoy user if they're not in a saveable context
                        }
                    }
                }
            });
            
            // Save Sale button click handler (explicit click on button still works)
            const saveSaleButton = document.querySelector('#salesEntryForm button[type="submit"]');
            if (saveSaleButton) {
                saveSaleButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    saveSalesEntry();
                });
            }
            
            // Reset sales form
            const resetSalesForm = document.getElementById('resetSalesForm');
            if (resetSalesForm) {
                resetSalesForm.addEventListener('click', function() {
                    const salesEntryForm = document.getElementById('salesEntryForm');
                    if (salesEntryForm) salesEntryForm.reset();
                    const totalSales = document.getElementById('totalSales');
                    if (totalSales) totalSales.value = '';
                    const totalCost = document.getElementById('totalCost');
                    if (totalCost) totalCost.value = '';
                    const totalProfit = document.getElementById('totalProfit');
                    if (totalProfit) totalProfit.value = '';
                });
            }
            
            // View sales list button
            const viewSalesListBtn = document.getElementById('viewSalesListBtn');
            if (viewSalesListBtn) {
                viewSalesListBtn.addEventListener('click', function() {
                const salesListSection = document.getElementById('salesListSection');
                const salesEntryCard = document.querySelector('#sales-section > .card');
                
                // Show list in full page mode
                salesListSection.style.display = 'block';
                salesListSection.classList.add('full-page');
                
                // Hide sidebar and navbar
                document.body.classList.add('full-page-active');
                
                // Hide sales entry form
                if (salesEntryCard && !salesEntryCard.closest('#salesListSection')) {
                    salesEntryCard.classList.add('sales-entry-hidden');
                }
                
                // Background refresh: Reload branches and categories data if needed
                function refreshDropdowns() {
                    // Check if branches or categories are missing/empty
                    const needsRefresh = !appData.branches || !Array.isArray(appData.branches) || appData.branches.length === 0 ||
                                       !appData.categories || !Array.isArray(appData.categories) || appData.categories.length === 0;
                    
                    if (needsRefresh && api && typeof api.getBranches === 'function' && typeof api.getCategories === 'function') {
                        console.log(' Refreshing branches and categories data in background...');
                        Promise.all([
                            api.getBranches().then(branches => {
                                if (appData) appData.branches = branches;
                                return branches;
                            }),
                            api.getCategories().then(categories => {
                                if (appData) appData.categories = categories;
                                return categories;
                            })
                        ]).then(() => {
                            console.log(' Background refresh complete, populating dropdowns...');
                            populateBranchSelectors();
                            populateCategorySelectors();
                        }).catch(error => {
                            console.error(' Error during background refresh:', error);
                            // Still try to populate with existing data
                            populateBranchSelectors();
                            populateCategorySelectors();
                        });
                    } else {
                        // Data is available, just populate dropdowns
                        populateBranchSelectors();
                        populateCategorySelectors();
                    }
                }
                
                // Refresh dropdowns after a short delay to ensure section is visible
                setTimeout(refreshDropdowns, 100);
                
                // Don't auto-load - user must select dates first
                // Clear existing data if no dates selected
                const dateFrom = document.getElementById('salesListDateFrom')?.value || '';
                const dateTo = document.getElementById('salesListDateTo')?.value || '';
                if (!dateFrom && !dateTo) {
                    const invoicesContainer = document.getElementById('salesInvoicesContainer');
                    const salesTableBody = document.getElementById('salesListTableBody');
                    const summarySection = document.getElementById('categorySummarySection');
                    if (invoicesContainer) invoicesContainer.innerHTML = '<div class="text-center text-muted p-4">Please select at least one date (From or To) to view sales list</div>';
                    if (salesTableBody) salesTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Please select at least one date (From or To) to view sales list</td></tr>';
                    if (summarySection) summarySection.style.display = 'none';
                }
            });
            }
            
            // Hide sales list button
            const hideSalesListBtn = document.getElementById('hideSalesListBtn');
            if (hideSalesListBtn) {
                hideSalesListBtn.addEventListener('click', function() {
                const salesListSection = document.getElementById('salesListSection');
                const salesEntryCard = document.querySelector('#sales-section > .card');
                
                salesListSection.style.display = 'none';
                salesListSection.classList.remove('full-page');
                
                // Show sidebar and navbar
                document.body.classList.remove('full-page-active');
                
                // Show sales entry form
                if (salesEntryCard && !salesEntryCard.closest('#salesListSection')) {
                    salesEntryCard.classList.remove('sales-entry-hidden');
                }
            });
            }
            
            // Back to sales entry button
            const backToSalesBtn = document.getElementById('backToSalesBtn');
            if (backToSalesBtn) {
                backToSalesBtn.addEventListener('click', function() {
                    const salesListSection = document.getElementById('salesListSection');
                    const salesEntryCard = document.querySelector('#sales-section > .card');
                    
                    salesListSection.style.display = 'none';
                    salesListSection.classList.remove('full-page');
                    
                    // Show sidebar and navbar
                    document.body.classList.remove('full-page-active');
                    
                    // Show sales entry form
                    if (salesEntryCard && !salesEntryCard.closest('#salesListSection')) {
                        salesEntryCard.classList.remove('sales-entry-hidden');
                    }
                    
                    // Scroll to top of sales section
                    const salesSection = document.getElementById('sales-section');
                    if (salesSection) {
                        salesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            }
            
            // ========================================
            // SALES ENTRY TABS EVENT LISTENERS
            // ========================================
            
            // Function to initialize sales entry category tab
            function initializeSalesEntryCategoryTab() {
                console.log(' Initializing sales entry section...');
                
                // Auto-set current date for Warehouse Sale Entry
                const saleDateField = document.getElementById('saleDate');
                if (saleDateField) {
                    const today = new Date().toISOString().split('T')[0];
                    saleDateField.value = today;
                    console.log(' Auto-set sale date to:', today);
                }
                
                // Show View Sales List button for Category tab
                const viewSalesListBtn = document.getElementById('viewSalesListBtn');
                const viewDeptSalesListBtn = document.getElementById('viewDeptSalesListBtn');
                if (viewSalesListBtn) viewSalesListBtn.style.display = 'block';
                if (viewDeptSalesListBtn) viewDeptSalesListBtn.style.display = 'none';
                
                // Load categories first if not loaded, then generate inputs
                if (!appData.categories || appData.categories.length === 0) {
                    console.log(' Categories not loaded, fetching...');
                    api.getCategories().then(categoriesData => {
                        console.log(' Categories loaded for sales entry:', categoriesData?.length || 0, 'items');
                        appData.categories = Array.isArray(categoriesData) ? categoriesData : [];
                        generateCategoryInputs();
                    }).catch(error => {
                        console.error(' Error loading categories for sales entry:', error);
                        showNotification('Failed to load categories', 'error');
                        // Show empty state on error
                        const container = document.getElementById('categoryInputs');
                        if (container) {
                            container.innerHTML = '<div class="alert alert-danger text-center">Error loading categories. Please try again.</div>';
                        }
                    });
                } else {
                    console.log(' Using existing categories:', appData.categories.length, 'items');
                    generateCategoryInputs();
                }
            }
            
            // Category tab - initialize when shown
            const categoryTab = document.getElementById('category-tab');
            if (categoryTab) {
                categoryTab.addEventListener('shown.bs.tab', initializeSalesEntryCategoryTab);
            }
            
            // Also listen for sectionLoaded event to re-initialize when sales section loads
            document.addEventListener('sectionLoaded', function(event) {
                if (event.detail && event.detail.sectionName === 'sales') {
                    console.log(' Sales section loaded, re-initializing...');
                    // Wait a bit for DOM to be ready
                    setTimeout(() => {
                        // Re-attach tab event listeners
                        const categoryTab = document.getElementById('category-tab');
                        if (categoryTab) {
                            // Remove old listener and add new one
                            categoryTab.removeEventListener('shown.bs.tab', initializeSalesEntryCategoryTab);
                            categoryTab.addEventListener('shown.bs.tab', initializeSalesEntryCategoryTab);
                            
                            // If category tab is already active, initialize immediately
                            if (categoryTab.classList.contains('active')) {
                                initializeSalesEntryCategoryTab();
                            }
                        }
                        
                        // Re-initialize department tab
                        const departmentTab = document.getElementById('department-tab');
                        if (departmentTab) {
                            // Load branches when Shop Sale tab is shown
                    departmentTab.addEventListener('shown.bs.tab', function() {
                        console.log(' Shop Sale tab shown, loading branches and departments...');
                        loadBranchesForBulkSalesTab2();
                        // Load departments even if no branch is selected (show all), then filter on change
                        setTimeout(() => {
                            loadDepartmentsForBulkSalesTab2();
                        }, 200);
                    });
                            
                            // If department tab is already active, initialize immediately
                            if (departmentTab.classList.contains('active')) {
                                loadBranchesForBulkSalesTab2();
                                setTimeout(() => {
                                    const branchSelect = document.getElementById('bulkDeptSaleBranchTab2');
                                    if (branchSelect && branchSelect.value) {
                                        loadDepartmentsForBulkSalesTab2();
                                    }
                                }, 300);
                            }
                        }

                        // Re-bind Save button click
                        const saveBtn = document.getElementById('saveSalesButton') || document.querySelector('#salesEntryForm button[type="submit"]');
                        if (saveBtn) {
                            const newSave = saveBtn.cloneNode(true);
                            saveBtn.parentNode.replaceChild(newSave, saveBtn);
                            newSave.addEventListener('click', function(e) {
                                e.preventDefault();
                                if (typeof saveSalesEntry === 'function') {
                                    saveSalesEntry();
                                }
                            });
                        }

                        // Re-bind View Sales List button
                        const viewSalesListBtn = document.getElementById('viewSalesListBtn');
                        if (viewSalesListBtn) {
                            const newViewBtn = viewSalesListBtn.cloneNode(true);
                            viewSalesListBtn.parentNode.replaceChild(newViewBtn, viewSalesListBtn);
                            newViewBtn.addEventListener('click', function() {
                                const salesListSection = document.getElementById('salesListSection');
                                const salesEntryCard = document.querySelector('#sales-section > .card');
                                if (salesListSection) {
                                    salesListSection.style.display = 'block';
                                    salesListSection.classList.add('full-page');
                                }
                                document.body.classList.add('full-page-active');
                                if (salesEntryCard && !salesEntryCard.closest('#salesListSection')) {
                                    salesEntryCard.classList.add('sales-entry-hidden');
                                }
                                
                                // Background refresh: Reload branches and categories data if needed
                                function refreshDropdowns() {
                                    const needsRefresh = !appData.branches || !Array.isArray(appData.branches) || appData.branches.length === 0 ||
                                                       !appData.categories || !Array.isArray(appData.categories) || appData.categories.length === 0;
                                    
                                    if (needsRefresh && api && typeof api.getBranches === 'function' && typeof api.getCategories === 'function') {
                                        console.log(' Refreshing branches and categories data in background...');
                                        Promise.all([
                                            api.getBranches().then(branches => {
                                                if (appData) appData.branches = branches;
                                                return branches;
                                            }),
                                            api.getCategories().then(categories => {
                                                if (appData) appData.categories = categories;
                                                return categories;
                                            })
                                        ]).then(() => {
                                            console.log(' Background refresh complete, populating dropdowns...');
                                            populateBranchSelectors();
                                            populateCategorySelectors();
                                        }).catch(error => {
                                            console.error(' Error during background refresh:', error);
                                            populateBranchSelectors();
                                            populateCategorySelectors();
                                        });
                                    } else {
                                        populateBranchSelectors();
                                        populateCategorySelectors();
                                    }
                                }
                                
                                setTimeout(refreshDropdowns, 100);
                                
                                const dateFrom = document.getElementById('salesListDateFrom')?.value || '';
                                const dateTo = document.getElementById('salesListDateTo')?.value || '';
                                if (typeof loadSalesList === 'function' && (dateFrom || dateTo)) {
                                    loadSalesList();
                                }
                            });
                        }

                        // Re-bind View Department Sales List button and ensure visibility on Shop tab
                        const viewDeptBtn = document.getElementById('viewDeptSalesListBtn');
                        const deptTab = document.getElementById('department-tab');
                        const catTab = document.getElementById('category-tab');
                        if (viewDeptBtn) {
                            const newDeptBtn = viewDeptBtn.cloneNode(true);
                            viewDeptBtn.parentNode.replaceChild(newDeptBtn, viewDeptBtn);
                            newDeptBtn.addEventListener('click', function() {
                                const deptSalesListSection = document.getElementById('deptSalesListSection');
                                const salesEntryCard = document.querySelector('#sales-section > .card');
                                if (deptSalesListSection) {
                                    deptSalesListSection.style.display = 'block';
                                    deptSalesListSection.classList.add('full-page');
                                }
                                document.body.classList.add('full-page-active');
                                if (salesEntryCard && !salesEntryCard.closest('#deptSalesListSection')) {
                                    salesEntryCard.classList.add('sales-entry-hidden');
                                }
                                
                                // Background refresh: Reload branches data if needed
                                function refreshDropdowns() {
                                    const needsRefresh = !appData.branches || !Array.isArray(appData.branches) || appData.branches.length === 0;
                                    
                                    if (needsRefresh && api && typeof api.getBranches === 'function') {
                                        console.log(' Refreshing branches data in background for shop sale list...');
                                        api.getBranches().then(branches => {
                                            if (appData) appData.branches = branches;
                                            console.log(' Background refresh complete, populating branch dropdown...');
                                            populateBranchSelectors();
                                            
                                            // Auto-select the branch if user has only one branch
                                            const deptSalesListBranch = document.getElementById('deptSalesListBranch');
                                            if (deptSalesListBranch && appData.currentUser && appData.currentUser.branches && appData.currentUser.branches.length === 1) {
                                                const userBranchId = appData.currentUser.branches[0]._id || appData.currentUser.branches[0];
                                                deptSalesListBranch.value = userBranchId;
                                                if (typeof loadDepartmentsForDeptSalesList === 'function') {
                                                    loadDepartmentsForDeptSalesList();
                                                }
                                            }
                                        }).catch(error => {
                                            console.error(' Error during background refresh:', error);
                                            populateBranchSelectors();
                                        });
                                    } else {
                                        populateBranchSelectors();
                                        
                                        // Auto-select the branch if user has only one branch
                                        const deptSalesListBranch = document.getElementById('deptSalesListBranch');
                                        if (deptSalesListBranch && appData.currentUser && appData.currentUser.branches && appData.currentUser.branches.length === 1) {
                                            const userBranchId = appData.currentUser.branches[0]._id || appData.currentUser.branches[0];
                                            deptSalesListBranch.value = userBranchId;
                                            if (typeof loadDepartmentsForDeptSalesList === 'function') {
                                                loadDepartmentsForDeptSalesList();
                                            }
                                        }
                                    }
                                }
                                
                                setTimeout(refreshDropdowns, 100);
                            });
                            // Ensure correct button visibility based on active tab
                            if (deptTab && deptTab.classList.contains('active')) {
                                newDeptBtn.style.display = 'block';
                                const vsBtn = document.getElementById('viewSalesListBtn');
                                if (vsBtn) vsBtn.style.display = 'none';
                            } else if (catTab && catTab.classList.contains('active')) {
                                newDeptBtn.style.display = 'none';
                            }
                        }

                        // Re-bind Back to Sales Entry button
                        const backToSalesBtn = document.getElementById('backToSalesBtn');
                        if (backToSalesBtn) {
                            const newBackBtn = backToSalesBtn.cloneNode(true);
                            backToSalesBtn.parentNode.replaceChild(newBackBtn, backToSalesBtn);
                            newBackBtn.addEventListener('click', function() {
                                const salesListSection = document.getElementById('salesListSection');
                                const salesEntryCard = document.querySelector('#sales-section > .card');
                                if (salesListSection) {
                                    salesListSection.style.display = 'none';
                                    salesListSection.classList.remove('full-page');
                                }
                                document.body.classList.remove('full-page-active');
                                if (salesEntryCard && !salesEntryCard.closest('#salesListSection')) {
                                    salesEntryCard.classList.remove('sales-entry-hidden');
                                }
                                const salesSection = document.getElementById('sales-section');
                                if (salesSection) salesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            });
                        }

                        // Re-bind Hide Sales List button
                        const hideSalesListBtn = document.getElementById('hideSalesListBtn');
                        if (hideSalesListBtn) {
                            const newHideBtn = hideSalesListBtn.cloneNode(true);
                            hideSalesListBtn.parentNode.replaceChild(newHideBtn, hideSalesListBtn);
                            newHideBtn.addEventListener('click', function() {
                                const salesSection = document.getElementById('sales-section');
                                const salesListSection = salesSection ? salesSection.querySelector('#salesListSection') : document.getElementById('salesListSection');
                                const salesEntryCard = document.querySelector('#sales-section > .card');
                                if (salesListSection) {
                                    salesListSection.style.display = 'none';
                                    salesListSection.classList.remove('full-page');
                                }
                                document.body.classList.remove('full-page-active');
                                if (salesEntryCard && !salesEntryCard.closest('#salesListSection')) {
                                    salesEntryCard.classList.remove('sales-entry-hidden');
                                }
                            });
                        }

                        // Re-bind Apply Filter button in sales list
                        const filterSalesListBtn = document.getElementById('filterSalesList');
                        if (filterSalesListBtn) {
                            const newFilterBtn = filterSalesListBtn.cloneNode(true);
                            filterSalesListBtn.parentNode.replaceChild(newFilterBtn, filterSalesListBtn);
                            newFilterBtn.addEventListener('click', function() {
                                if (typeof loadSalesList === 'function') {
                                    loadSalesList();
                                }
                            });
                        }



                        // Re-bind Bulk Department Sales form submit and save button
                        const bulkFormTab2 = document.getElementById('bulkDeptSalesEntryFormTab2');
                        if (bulkFormTab2) {
                            const newForm = bulkFormTab2.cloneNode(true);
                            bulkFormTab2.parentNode.replaceChild(newForm, bulkFormTab2);
                            newForm.addEventListener('submit', function(e) {
                                e.preventDefault();
                                if (typeof saveBulkDepartmentSalesEntryTab2 === 'function') {
                                    saveBulkDepartmentSalesEntryTab2();
                                }
                            });
                            newForm.addEventListener('keydown', function(e) {
                                if (e.key === 'Enter' || e.keyCode === 13) {
                                    e.preventDefault();
                                    return false;
                                }
                            });
                        }
                        const bulkSaveBtnTab2 = document.getElementById('saveBulkDeptSalesBtnTab2');
                        if (bulkSaveBtnTab2) {
                            const newSaveBtn = bulkSaveBtnTab2.cloneNode(true);
                            bulkSaveBtnTab2.parentNode.replaceChild(newSaveBtn, bulkSaveBtnTab2);
                            newSaveBtn.addEventListener('click', function(e) {
                                e.preventDefault();
                                if (typeof saveBulkDepartmentSalesEntryTab2 === 'function') {
                                    saveBulkDepartmentSalesEntryTab2();
                                }
                            });
                        }
                    }, 200);
                }
            });
            
            
            // Initialize dates on page load if tabs are already active
            setTimeout(function() {
                const today = new Date().toISOString().split('T')[0];
                
                // Check if Warehouse Sale tab is active
                const categoryTab = document.getElementById('category-tab');
                if (categoryTab && categoryTab.classList.contains('active')) {
                    const saleDateField = document.getElementById('saleDate');
                    if (saleDateField && !saleDateField.value) {
                        saleDateField.value = today;
                        console.log(' Initialized warehouse sale date on page load:', today);
                    }
                }
                
                // Check if Shop Sale tab is active
                const departmentTab = document.getElementById('department-tab');
                if (departmentTab && departmentTab.classList.contains('active')) {
                    const bulkDeptSaleDateField = document.getElementById('bulkDeptSaleDateTab2');
                    if (bulkDeptSaleDateField && !bulkDeptSaleDateField.value) {
                        bulkDeptSaleDateField.value = today;
                        console.log(' Initialized shop sale date on page load:', today);
                    }
                }
            }, 200);
            
            // Initialize button visibility on page load
            setTimeout(initializeSalesEntryButtons, 100);
            
            // ========================================
            // DEPARTMENT SALES ENTRY FORM EVENT LISTENERS
            // ========================================
            
            // Department Sales Entry Form
            const deptSaleEntryForm = document.getElementById('deptSaleEntryForm');
            if (deptSaleEntryForm) {
                // Prevent default form submission
                deptSaleEntryForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveDepartmentSalesEntry();
                });
                
                // Prevent Enter key from submitting form
                deptSaleEntryForm.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.keyCode === 13) {
                        e.preventDefault();
                        return false;
                    }
                });
                
                // Branch change - load departments
                const deptSaleBranch = document.getElementById('deptSaleBranch');
                if (deptSaleBranch) {
                    deptSaleBranch.addEventListener('change', loadDepartmentsForSales);
                }
                
                // Department change - load sub-departments
                const deptSaleDepartment = document.getElementById('deptSaleDepartment');
                if (deptSaleDepartment) {
                    deptSaleDepartment.addEventListener('change', loadSubDepartmentsForSales);
                }
                
                // Calculate totals when values change
                const deptSaleGrossSale = document.getElementById('deptSaleGrossSale');
                const deptSaleDiscountPercent = document.getElementById('deptSaleDiscountPercent');
                const deptSaleReturnAmount = document.getElementById('deptSaleReturnAmount');
                const deptSaleGST = document.getElementById('deptSaleGST');
                
                if (deptSaleGrossSale) {
                    deptSaleGrossSale.addEventListener('input', calculateDepartmentSalesTotals);
                }
                if (deptSaleDiscountPercent) {
                    deptSaleDiscountPercent.addEventListener('input', calculateDepartmentSalesTotals);
                }
                if (deptSaleReturnAmount) {
                    deptSaleReturnAmount.addEventListener('input', calculateDepartmentSalesTotals);
                }
                if (deptSaleGST) {
                    deptSaleGST.addEventListener('input', calculateDepartmentSalesTotals);
                }
                
                // Reset button
                const resetDeptSaleForm = document.getElementById('resetDeptSaleForm');
                if (resetDeptSaleForm) {
                    resetDeptSaleForm.addEventListener('click', function() {
                        deptSaleEntryForm.reset();
                        const today = new Date().toISOString().split('T')[0];
                        document.getElementById('deptSaleDate').value = today;
                        document.getElementById('deptSaleSubDepartment').disabled = true;
                        document.getElementById('deptSaleDiscountPercent').value = '0';
                        document.getElementById('deptSaleDiscountAmount').value = '';
                        document.getElementById('deptSaleSaleValue').value = '';
                        document.getElementById('deptSaleNetSale').value = '';
                        document.getElementById('deptSaleSubDepartmentTotal').value = '';
                    });
                }
            }
            
            // View Department Sales List Button
            const viewDeptSalesListBtn = document.getElementById('viewDeptSalesListBtn');
            if (viewDeptSalesListBtn) {
                viewDeptSalesListBtn.addEventListener('click', function() {
                    const deptSalesListSection = document.getElementById('deptSalesListSection');
                    const salesEntryCard = document.querySelector('#sales-section > .card');
                    
                    // Show list in full page mode - same as warehouse list
                    deptSalesListSection.style.display = 'block';
                    deptSalesListSection.classList.add('full-page');
                    
                    // Hide sidebar and navbar
                    document.body.classList.add('full-page-active');
                    
                    // Hide sales entry form
                    if (salesEntryCard && !salesEntryCard.closest('#deptSalesListSection')) {
                        salesEntryCard.classList.add('sales-entry-hidden');
                    }
                    
                    // Background refresh: Reload branches data if needed
                    function refreshDropdowns() {
                        // Check if branches are missing/empty
                        const needsRefresh = !appData.branches || !Array.isArray(appData.branches) || appData.branches.length === 0;
                        
                        if (needsRefresh && api && typeof api.getBranches === 'function') {
                            console.log(' Refreshing branches data in background for shop sale list...');
                            api.getBranches().then(branches => {
                                if (appData) appData.branches = branches;
                                console.log(' Background refresh complete, populating branch dropdown...');
                                populateBranchSelectors();
                                
                                // Auto-select the branch if user has only one branch
                                const deptSalesListBranch = document.getElementById('deptSalesListBranch');
                                if (deptSalesListBranch && appData.currentUser && appData.currentUser.branches && appData.currentUser.branches.length === 1) {
                                    const userBranchId = appData.currentUser.branches[0]._id || appData.currentUser.branches[0];
                                    deptSalesListBranch.value = userBranchId;
                                    // Load departments for the selected branch
                                    if (typeof loadDepartmentsForDeptSalesList === 'function') {
                                        loadDepartmentsForDeptSalesList();
                                    }
                                }
                            }).catch(error => {
                                console.error(' Error during background refresh:', error);
                                // Still try to populate with existing data
                                populateBranchSelectors();
                            });
                        } else {
                            // Data is available, just populate dropdowns
                            populateBranchSelectors();
                            
                            // Auto-select the branch if user has only one branch
                            const deptSalesListBranch = document.getElementById('deptSalesListBranch');
                            if (deptSalesListBranch && appData.currentUser && appData.currentUser.branches && appData.currentUser.branches.length === 1) {
                                const userBranchId = appData.currentUser.branches[0]._id || appData.currentUser.branches[0];
                                deptSalesListBranch.value = userBranchId;
                                // Load departments for the selected branch
                                if (typeof loadDepartmentsForDeptSalesList === 'function') {
                                    loadDepartmentsForDeptSalesList();
                                }
                            }
                        }
                    }
                    
                    // Refresh dropdowns after a short delay to ensure section is visible
                    setTimeout(refreshDropdowns, 100);
                });
            }
            
            // Hide Department Sales List Button
            const hideDeptSalesListBtn = document.getElementById('hideDeptSalesListBtn');
            if (hideDeptSalesListBtn) {
                hideDeptSalesListBtn.addEventListener('click', function() {
                    const deptSalesListSection = document.getElementById('deptSalesListSection');
                    const salesEntryCard = document.querySelector('#sales-section > .card');
                    
                    deptSalesListSection.style.display = 'none';
                    deptSalesListSection.classList.remove('full-page');
                    
                    // Show sidebar and navbar
                    document.body.classList.remove('full-page-active');
                    
                    // Show sales entry form
                    if (salesEntryCard && !salesEntryCard.closest('#deptSalesListSection')) {
                        salesEntryCard.classList.remove('sales-entry-hidden');
                    }
                });
            }
            
            // Back to department sales entry button
            const backToDeptSalesBtn = document.getElementById('backToDeptSalesBtn');
            if (backToDeptSalesBtn) {
                backToDeptSalesBtn.addEventListener('click', function() {
                    const deptSalesListSection = document.getElementById('deptSalesListSection');
                    const salesEntryCard = document.querySelector('#sales-section > .card');
                    
                    deptSalesListSection.style.display = 'none';
                    deptSalesListSection.classList.remove('full-page');
                    
                    // Show sidebar and navbar
                    document.body.classList.remove('full-page-active');
                    
                    // Show sales entry form
                    if (salesEntryCard && !salesEntryCard.closest('#deptSalesListSection')) {
                        salesEntryCard.classList.remove('sales-entry-hidden');
                    }
                    
                    // Scroll to top of sales section
                    const salesSection = document.getElementById('sales-section');
                    if (salesSection) {
                        salesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            }
            
            // Department Sales List View Toggle
            const deptCardViewBtn = document.getElementById('deptCardViewBtn');
            const deptTableViewBtn = document.getElementById('deptTableViewBtn');
            if (deptCardViewBtn && deptTableViewBtn) {
                deptCardViewBtn.addEventListener('click', function() {
                    document.getElementById('deptSalesCardView').style.display = 'block';
                    document.getElementById('deptSalesTableView').style.display = 'none';
                    deptCardViewBtn.classList.add('active');
                    deptTableViewBtn.classList.remove('active');
                });
                
                deptTableViewBtn.addEventListener('click', function() {
                    document.getElementById('deptSalesCardView').style.display = 'none';
                    document.getElementById('deptSalesTableView').style.display = 'block';
                    deptTableViewBtn.classList.add('active');
                    deptCardViewBtn.classList.remove('active');
                });
            }
            
            // ========================================
            // BULK DEPARTMENT SALES ENTRY FORM EVENT LISTENERS (TAB 2)
            // ========================================
            
            // Bulk Department Sales Entry Form Tab 2
            const bulkDeptSalesEntryFormTab2 = document.getElementById('bulkDeptSalesEntryFormTab2');
            if (bulkDeptSalesEntryFormTab2) {
                // Prevent default form submission
                bulkDeptSalesEntryFormTab2.addEventListener('submit', function(e) {
                    e.preventDefault();
                    // Immediately disable button to prevent duplicate clicks
                    const saveBtn = document.getElementById('saveBulkDeptSalesBtnTab2');
                    if (saveBtn && !saveBtn.disabled) {
                        saveBulkDepartmentSalesEntryTab2();
                    } else {
                        console.log('Save button already disabled, ignoring duplicate submission');
                    }
                });
                
                // Prevent Enter key from submitting form
                bulkDeptSalesEntryFormTab2.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.keyCode === 13) {
                        e.preventDefault();
                        return false;
                    }
                });
                
                // Branch change - load departments
                // Note: Event handler is managed in sales.js to avoid duplicate handlers
                // Only set up tab shown handler here
                const bulkDeptSaleBranchTab2 = document.getElementById('bulkDeptSaleBranchTab2');
                if (bulkDeptSaleBranchTab2) {
                    // Load branches when Shop Sale tab is shown
                    const departmentTab = document.getElementById('department-tab');
                    if (departmentTab) {
                        // Remove existing listeners by cloning
                        const newTab = departmentTab.cloneNode(true);
                        departmentTab.parentNode.replaceChild(newTab, departmentTab);
                        
                        newTab.addEventListener('shown.bs.tab', function() {
                            if (typeof window.loadBranchesForBulkSalesTab2 === 'function') {
                                window.loadBranchesForBulkSalesTab2();
                            }
                        });
                    }
                    
                    // Event handler for branch change is handled in sales.js to avoid conflicts
                    // Only add if not already handled by sales.js module
                    if (!window.__deptBranchChangeHandled) {
                        const branchClone = bulkDeptSaleBranchTab2.cloneNode(true);
                        bulkDeptSaleBranchTab2.parentNode.replaceChild(branchClone, bulkDeptSaleBranchTab2);
                        branchClone.addEventListener('change', function() {
                            if (typeof window.loadDepartmentsForBulkSalesTab2 === 'function') {
                                window.loadDepartmentsForBulkSalesTab2();
                            }
                        });
                        window.__deptBranchChangeHandled = true;
                    }
                }
                
                // Department change - load sub-departments
                const bulkDeptSaleDepartmentTab2 = document.getElementById('bulkDeptSaleDepartmentTab2');
                if (bulkDeptSaleDepartmentTab2) {
                    bulkDeptSaleDepartmentTab2.addEventListener('change', loadSubDepartmentsForBulkSalesTab2);
                }
                
                // Reset button
                const resetBulkDeptSalesFormTab2Btn = document.getElementById('resetBulkDeptSalesFormTab2');
                if (resetBulkDeptSalesFormTab2Btn) {
                    resetBulkDeptSalesFormTab2Btn.addEventListener('click', function() {
                        resetBulkDeptSalesFormTab2();
                    });
                }
            }
            
            // ========================================
            // PAYMENT VOUCHER FORM HANDLING
            // ========================================
            
            // Payment voucher form
            const paymentVoucherForm = document.getElementById('paymentVoucherForm');
            if (paymentVoucherForm) {
                paymentVoucherForm.addEventListener('submit', function(e) {
                e.preventDefault();
                    const voucherId = this.getAttribute('data-voucher-id');
                    if (voucherId) {
                        updatePaymentVoucher(voucherId);
                    } else {
                        saveNewPaymentVoucher();
                    }
                });
            }
            
            // Category voucher form
            const categoryVoucherForm = document.getElementById('categoryVoucherForm');
            if (categoryVoucherForm) {
                categoryVoucherForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const voucherId = this.getAttribute('data-voucher-id');
                    if (voucherId) {
                        updateCategoryVoucher(voucherId);
                    } else {
                        saveNewCategoryVoucher();
                    }
                });
            }
            
            // Payment voucher tabs event listeners (Bootstrap tabs)
            const categoryVoucherTab = document.getElementById('category-voucher-tab');
            if (categoryVoucherTab) {
                categoryVoucherTab.addEventListener('shown.bs.tab', function() {
                    // Initialize category voucher form when tab is shown
                    initializeCategoryVoucherForm();
                });
            }
            
            const supplierVoucherTab = document.getElementById('supplier-voucher-tab');
            if (supplierVoucherTab) {
                supplierVoucherTab.addEventListener('shown.bs.tab', function() {
                    // Initialize supplier voucher form when tab is shown
                    initializePaymentVoucherForm();
                });
            }
            
            // Payment dashboard filter changes
            const paymentDashboardBranchFilter = document.getElementById('paymentDashboardBranchFilter');
            const paymentDashboardSupplierFilter = document.getElementById('paymentDashboardSupplierFilter');
            const paymentDashboardDateFilter = document.getElementById('paymentDashboardDateFilter');
            
            if (paymentDashboardBranchFilter) {
                paymentDashboardBranchFilter.addEventListener('change', updatePaymentDashboard);
            }
            if (paymentDashboardSupplierFilter) {
                paymentDashboardSupplierFilter.addEventListener('change', updatePaymentDashboard);
            }
            if (paymentDashboardDateFilter) {
                paymentDashboardDateFilter.addEventListener('change', updatePaymentDashboard);
            }
            
            // ========================================
            // DEPARTMENT MANAGEMENT EVENT LISTENERS
            // ========================================
            const departmentBranchFilter = document.getElementById('departmentBranchFilter');
            if (departmentBranchFilter) {
                departmentBranchFilter.addEventListener('change', function() {
                    loadDepartments(this.value);
                });
            }
            
            const addDepartmentBtn = document.getElementById('addDepartmentBtn');
            if (addDepartmentBtn) {
                addDepartmentBtn.addEventListener('click', function() {
                    // Reset form
                    const form = document.getElementById('departmentForm');
                    if (form) form.reset();
                    const modalLabel = document.getElementById('addDepartmentModalLabel');
                    if (modalLabel) modalLabel.textContent = 'Add New Department';
                    const saveBtn = document.getElementById('saveDepartmentBtn');
                    if (saveBtn) {
                        saveBtn.textContent = 'Save Department';
                        saveBtn.onclick = saveDepartment;
                    }
                    // Load branches if not already loaded
                    const branchSelect = document.getElementById('departmentBranchId');
                    if (branchSelect && branchSelect.options.length <= 1) {
                        loadDepartmentBranches();
                    }
                    // Show the modal
                    const modalElement = document.getElementById('addDepartmentModal');
                    if (modalElement) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                    } else {
                        console.error('Add Department Modal not found');
                        showNotification('Department modal not found', 'error');
                    }
                });
            }
            
            const departmentForm = document.getElementById('departmentForm');
            if (departmentForm) {
                departmentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (this.checkValidity()) {
                        saveDepartment();
                    } else {
                        this.reportValidity();
                    }
                });
            }
            
            const saveDepartmentBtn = document.getElementById('saveDepartmentBtn');
            if (saveDepartmentBtn && !saveDepartmentBtn.onclick) {
                saveDepartmentBtn.onclick = saveDepartment;
            }
            
            const subDepartmentForm = document.getElementById('subDepartmentForm');
            if (subDepartmentForm) {
                subDepartmentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (this.checkValidity()) {
                        saveSubDepartment();
                    } else {
                        this.reportValidity();
                    }
                });
            }
            
            const saveSubDepartmentBtn = document.getElementById('saveSubDepartmentBtn');
            if (saveSubDepartmentBtn && !saveSubDepartmentBtn.onclick) {
                saveSubDepartmentBtn.onclick = saveSubDepartment;
            }
            
            // ========================================
            // END DEPARTMENT MANAGEMENT EVENT LISTENERS
            // ========================================
            
            // Payment voucher list search
            const paymentVoucherSearch = document.getElementById('paymentVoucherSearch');
            if (paymentVoucherSearch) {
                paymentVoucherSearch.addEventListener('input', loadPaymentVoucherList);
            }
            
            // Category voucher list tab search
            const categoryVoucherListSearch = document.getElementById('categoryVoucherListSearch');
            if (categoryVoucherListSearch) {
                categoryVoucherListSearch.addEventListener('input', loadCategoryVoucherListTab);
            }
            
            // Category voucher list tab event listeners (Bootstrap tabs) - check dates before loading
            const categoryVoucherListTabBtn = document.getElementById('category-voucher-list-tab');
            if (categoryVoucherListTabBtn) {
                categoryVoucherListTabBtn.addEventListener('shown.bs.tab', function() {
                    // Only load data when category tab is actually clicked
                    // First populate filters (no permission check), then load data (permission check)
                    initializeCategoryVoucherListTab();
                    
                    // Don't auto-load - check if dates are selected first
                    const fromDate = document.getElementById('categoryVoucherListFromDate')?.value || '';
                    const toDate = document.getElementById('categoryVoucherListToDate')?.value || '';
                    if (fromDate || toDate) {
                        loadCategoryVoucherListTab();
                    } else {
                        // Show message if no dates selected
                        const tbody = document.getElementById('categoryVoucherListTableBody');
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Please select at least one date (From or To) to view voucher list</td></tr>';
                        }
                    }
                });
            }
            
            const supplierVoucherListTabBtn = document.getElementById('supplier-voucher-list-tab');
            if (supplierVoucherListTabBtn) {
                supplierVoucherListTabBtn.addEventListener('shown.bs.tab', function() {
                    // Don't auto-load - check if dates are selected first
                    const fromDate = document.getElementById('paymentVoucherListFromDate')?.value || '';
                    const toDate = document.getElementById('paymentVoucherListToDate')?.value || '';
                    if (fromDate || toDate) {
                        loadPaymentVoucherList();
                    } else {
                        // Show message if no dates selected
                        const tbody = document.querySelector('#payment-voucher-list-section table tbody');
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">Please select at least one date (From or To) to view voucher list</td></tr>';
                        }
                    }
                });
            }
            
            // Category voucher simple list search (for separate section if exists)
            const categoryVoucherSimpleSearch = document.getElementById('categoryVoucherSimpleSearch');
            if (categoryVoucherSimpleSearch) {
                categoryVoucherSimpleSearch.addEventListener('input', loadCategoryVoucherSimpleList);
            }
            
            // Initialize payment module tabs when DOM is ready
            if (typeof initializePaymentModuleTabs === 'function') {
                setTimeout(() => {
                    initializePaymentModuleTabs();
                }, 100);
            }
            
            // ========================================
            // REPORT TABS SWITCHING FUNCTIONALITY
            // ========================================
            function switchReportTab(tabName, hideTabs = false) {
                // Validate tabName
                if (!tabName || tabName === 'null' || tabName === 'undefined') {
                    console.warn('switchReportTab called with null or undefined tabName:', tabName);
                    return;
                }
                
                // Check permissions before switching to report tab
                if (appData.currentUser) {
                    const permissions = appData.currentUser.permissions || [];
                    const isAdmin = permissions.includes('admin');
                    
                    // Debug logging for permission issues
                    if (!isAdmin && tabName) {
                        console.log(`Checking permission for report tab: ${tabName}`, {
                            permissions: permissions,
                            isAdmin: isAdmin,
                            hasPermission: hasPermission(tabName, permissions)
                        });
                    }
                    
                    // Admin has access to all reports - skip permission check
                    if (isAdmin) {
                        // Admin can access all reports, continue without checking
                        console.log('Admin user - allowing access to all reports');
                    } else {
                        // Check if user has permission for this specific report tab
                        if (!hasPermission(tabName, permissions)) {
                            console.error(`Permission denied for report tab: ${tabName}`, {
                                permissions: permissions,
                                tabName: tabName
                            });
                            showNotification(`You don't have permission to access ${tabName}`, 'error');
                            return;
                        }
                    }
                } else {
                    // If no user data, allow access (might be loading)
                    console.warn('No current user data available, allowing tab switch');
                }
                
                // Hide or show report tabs navigation based on parameter
                const reportTabsNav = document.querySelector('.report-tabs');
                if (reportTabsNav) {
                    if (hideTabs) {
                        // Hide all tabs except the active one
                        document.querySelectorAll('.report-tab').forEach(tab => {
                            tab.style.display = 'none';
                        });
                        // Show only the active tab
                        const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
                        if (activeTab) {
                            activeTab.style.display = 'flex';
                            activeTab.classList.add('active');
                        }
                        reportTabsNav.style.display = 'flex'; // Show container but only with active tab
                    } else {
                        // Show all tabs
                        document.querySelectorAll('.report-tab').forEach(tab => {
                            tab.style.display = 'flex';
                        });
                        reportTabsNav.style.display = 'flex';
                    }
                }
                
                // Hide all tab contents
                document.querySelectorAll('.report-tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Remove active class from all tabs
                document.querySelectorAll('.report-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab content
                const selectedTab = document.getElementById(`tab-${tabName}`);
                if (selectedTab) {
                    selectedTab.classList.add('active');
                }
                
                // Add active class to clicked tab
                const clickedTab = document.querySelector(`[data-tab="${tabName}"]`);
                if (clickedTab) {
                    clickedTab.classList.add('active');
                    // If hideTabs is true, ensure this tab is visible
                    if (hideTabs) {
                        clickedTab.style.display = 'flex';
                    }
                }
                
                // Save current report tab to localStorage for page refresh persistence
                try {
                    localStorage.setItem('lastActiveReportTab', tabName);
                } catch (e) {
                    console.warn('Could not save last active report tab to localStorage:', e);
                }
                
                // Populate filters for sales report tab
                if (tabName === 'sales-report') {
                    populateBranchSelectors();
                    populateCategorySelectors();
                    // Setup event listeners for generate button
                    setTimeout(() => {
                        if (typeof setupReportGenerateButtons === 'function') {
                            setupReportGenerateButtons();
                        }
                    }, 100);
                }
                
                // Populate filters for sales comparison report tab
                if (tabName === 'sales-comparison-report') {
                    populateBranchSelectors();
                    populateCategorySelectors();
                    // Setup event listeners for generate button
                    setTimeout(() => {
                        if (typeof setupReportGenerateButtons === 'function') {
                            setupReportGenerateButtons();
                        }
                    }, 100);
                }
                
                // Populate filters for datewise report tab
                if (tabName === 'datewise-sales-report') {
                    populateBranchSelectors();
                    populateCategorySelectors();
                    // Setup event listeners for generate button
                    setTimeout(() => {
                        if (typeof setupReportGenerateButtons === 'function') {
                            setupReportGenerateButtons();
                        }
                    }, 100);
                }
                
                // Populate filters for payment reports tab
                if (tabName === 'payment-reports') {
                    populateBranchSelectors();
                    populateCategorySelectors();
                    populatePaymentModuleFilters(); // Also populate payment module filters for standalone section
                    
                    // Ensure generate button event listener is attached (for dynamically loaded content)
                    setTimeout(() => {
                        const generatePaymentReportBtn = document.getElementById('generatePaymentReportBtn');
                        if (generatePaymentReportBtn && !generatePaymentReportBtn.hasAttribute('data-listener-attached')) {
                            generatePaymentReportBtn.addEventListener('click', function(e) {
                                e.preventDefault();
                                generatePaymentReport();
                            });
                            generatePaymentReportBtn.setAttribute('data-listener-attached', 'true');
                        }
                    }, 100);
                }
                
                // Populate filters for department-wise report tab
                if (tabName === 'department-wise-report') {
                    populateBranchSelectors();
                    
                    // Setup event listeners for generate button
                    setTimeout(() => {
                        if (typeof setupShopReportGenerateButtons === 'function') {
                            setupShopReportGenerateButtons();
                        }
                    }, 100);
                    
                    // Ensure event listeners are attached and load departments if branch is selected
                    setTimeout(() => {
                        const deptWiseReportBranch = document.getElementById('deptWiseReportBranch');
                        if (deptWiseReportBranch) {
                            // Remove old listeners by cloning the element
                            const newBranch = deptWiseReportBranch.cloneNode(true);
                            deptWiseReportBranch.parentNode.replaceChild(newBranch, deptWiseReportBranch);
                            
                            // Attach event listener using onchange (overwrites any existing)
                            newBranch.onchange = function() {
                                console.log(' Department-wise report branch changed:', this.value);
                                if (typeof loadDepartmentsForDeptWiseReport === 'function') {
                                    loadDepartmentsForDeptWiseReport();
                                }
                            };
                            
                            // Also use addEventListener as backup
                            newBranch.addEventListener('change', function() {
                                console.log(' Department-wise report branch changed (addEventListener):', this.value);
                                if (typeof loadDepartmentsForDeptWiseReport === 'function') {
                                    loadDepartmentsForDeptWiseReport();
                                }
                            });
                            
                            // Load departments if branch is already selected
                            if (newBranch.value) {
                                console.log(' Loading departments for pre-selected branch:', newBranch.value);
                                if (typeof loadDepartmentsForDeptWiseReport === 'function') {
                                    loadDepartmentsForDeptWiseReport();
                                }
                            }
                        }
                    }, 150);
                }
                
                // Populate filters for sub-department-wise report tab
                if (tabName === 'sub-department-wise-report') {
                    populateBranchSelectors();
                    
                    // Setup event listeners for generate button
                    setTimeout(() => {
                        if (typeof setupShopReportGenerateButtons === 'function') {
                            setupShopReportGenerateButtons();
                        }
                    }, 100);
                    
                    // Ensure event listeners are attached and load departments if branch is selected
                    setTimeout(() => {
                        const subDeptWiseReportBranch = document.getElementById('subDeptWiseReportBranch');
                        const subDeptWiseReportDepartment = document.getElementById('subDeptWiseReportDepartment');
                        
                        if (subDeptWiseReportBranch) {
                            // Remove old listeners by cloning the element
                            const newBranch = subDeptWiseReportBranch.cloneNode(true);
                            subDeptWiseReportBranch.parentNode.replaceChild(newBranch, subDeptWiseReportBranch);
                            
                            // Attach event listener using onchange (overwrites any existing)
                            newBranch.onchange = function() {
                                console.log(' Sub-department-wise report branch changed:', this.value);
                                if (typeof loadDepartmentsForSubDeptWiseReport === 'function') {
                                    loadDepartmentsForSubDeptWiseReport();
                                }
                            };
                            
                            // Also use addEventListener as backup
                            newBranch.addEventListener('change', function() {
                                console.log(' Sub-department-wise report branch changed (addEventListener):', this.value);
                                if (typeof loadDepartmentsForSubDeptWiseReport === 'function') {
                                    loadDepartmentsForSubDeptWiseReport();
                                }
                            });
                            
                            // Load departments if branch is already selected
                            if (newBranch.value) {
                                console.log(' Loading departments for pre-selected branch:', newBranch.value);
                                if (typeof loadDepartmentsForSubDeptWiseReport === 'function') {
                                    loadDepartmentsForSubDeptWiseReport();
                                }
                            }
                        }
                        
                        if (subDeptWiseReportDepartment) {
                            // Remove old listeners by cloning the element
                            const newDept = subDeptWiseReportDepartment.cloneNode(true);
                            subDeptWiseReportDepartment.parentNode.replaceChild(newDept, subDeptWiseReportDepartment);
                            
                            // Attach event listener using onchange (overwrites any existing)
                            newDept.onchange = function() {
                                console.log(' Sub-department-wise report department changed:', this.value);
                                if (typeof loadSubDepartmentsForSubDeptWiseReport === 'function') {
                                    loadSubDepartmentsForSubDeptWiseReport();
                                }
                            };
                            
                            // Also use addEventListener as backup
                            newDept.addEventListener('change', function() {
                                console.log(' Sub-department-wise report department changed (addEventListener):', this.value);
                                if (typeof loadSubDepartmentsForSubDeptWiseReport === 'function') {
                                    loadSubDepartmentsForSubDeptWiseReport();
                                }
                            });
                            
                            // Load sub-departments if department is already selected
                            if (newDept.value) {
                                console.log(' Loading sub-departments for pre-selected department:', newDept.value);
                                if (typeof loadSubDepartmentsForSubDeptWiseReport === 'function') {
                                    loadSubDepartmentsForSubDeptWiseReport();
                                }
                            }
                        }
                    }, 150);
                }
                
                // Populate filters for department-wise sale comparison tab
                if (tabName === 'department-wise-sale-comparison') {
                    populateBranchSelectors();
                    populateCategorySelectors();
                    
                    // Ensure event listeners are attached
                    const deptComparisonReportBranch = document.getElementById('deptComparisonReportBranch');
                    if (deptComparisonReportBranch) {
                        deptComparisonReportBranch.onchange = function() {
                            loadDepartmentsForDeptComparisonReport();
                        };
                        deptComparisonReportBranch.addEventListener('change', function() {
                            loadDepartmentsForDeptComparisonReport();
                        });
                        if (deptComparisonReportBranch.value) {
                            loadDepartmentsForDeptComparisonReport();
                        }
                    }
                }
                
                // Populate filters for branch-wise sale comparison tab
                if (tabName === 'branch-wise-sale-comparison') {
                    populateCategorySelectors();
                    
                    // Load departments for branch comparison
                    loadAllDepartmentsForBranchComparison();
                }
            }
            
            // Add click event listeners to all report tabs
            document.querySelectorAll('.report-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    // Validate tabName before proceeding
                    if (!tabName || tabName === 'null' || tabName === 'undefined') {
                        console.error('Report tab clicked but data-tab attribute is missing or invalid:', tabName);
                        showNotification('Invalid report tab selected', 'error');
                        return;
                    }
                    
                    // When user clicks on a tab button, clear sidebar flag (user is manually switching)
                    localStorage.removeItem('lastReportFromSidebar');
                    
                    // When clicking on tab buttons, show all tabs (user can switch between them)
                    const reportTabsNav = document.querySelector('.report-tabs');
                    if (reportTabsNav) {
                        // Show all tabs when user clicks on a tab button
                        document.querySelectorAll('.report-tab').forEach(t => {
                            t.style.display = 'flex';
                        });
                        reportTabsNav.style.display = 'flex';
                    }
                    switchReportTab(tabName, false); // false = show all tabs
                });
            });
            
            // Setup report generate buttons event listeners
            function setupReportGenerateButtons() {
                // Generate Sales Report button
                const generateSalesReportBtn = document.getElementById('generateSalesReportBtn');
                if (generateSalesReportBtn && !generateSalesReportBtn.hasAttribute('data-listener-attached')) {
                    generateSalesReportBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (typeof generateSalesReport === 'function') {
                            generateSalesReport();
                        } else {
                            console.error('generateSalesReport function not found');
                            showNotification('Error: Report generation function not found', 'error');
                        }
                    });
                    generateSalesReportBtn.setAttribute('data-listener-attached', 'true');
                }
                
                // Generate Comparison Report button
                const generateComparisonReportBtn = document.getElementById('generateComparisonReportBtn');
                if (generateComparisonReportBtn && !generateComparisonReportBtn.hasAttribute('data-listener-attached')) {
                    generateComparisonReportBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (typeof generateComparisonReport === 'function') {
                            generateComparisonReport();
                        } else {
                            console.error('generateComparisonReport function not found');
                            showNotification('Error: Report generation function not found', 'error');
                        }
                    });
                    generateComparisonReportBtn.setAttribute('data-listener-attached', 'true');
                }
                
                // Generate Datewise Report button
                const generateDatewiseReportBtn = document.getElementById('generateDatewiseReportBtn');
                if (generateDatewiseReportBtn && !generateDatewiseReportBtn.hasAttribute('data-listener-attached')) {
                    generateDatewiseReportBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (typeof generateDatewiseReport === 'function') {
                            generateDatewiseReport();
                        } else {
                            console.error('generateDatewiseReport function not found');
                            showNotification('Error: Report generation function not found', 'error');
                        }
                    });
                    generateDatewiseReportBtn.setAttribute('data-listener-attached', 'true');
                }
            }
            
            // Setup shop report generate buttons event listeners
            function setupShopReportGenerateButtons() {
                // Generate Department-Wise Report Button
                const generateDeptWiseReportBtn = document.getElementById('generateDeptWiseReportBtn');
                if (generateDeptWiseReportBtn && !generateDeptWiseReportBtn.hasAttribute('data-listener-attached')) {
                    generateDeptWiseReportBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log(' Department-wise report generate button clicked');
                        if (typeof generateDeptWiseReport === 'function') {
                            generateDeptWiseReport();
                        } else {
                            console.error(' generateDeptWiseReport function not found');
                            showNotification('Error: Report generation function not found', 'error');
                        }
                    });
                    generateDeptWiseReportBtn.setAttribute('data-listener-attached', 'true');
                }
                
                // Sub-Department-Wise Report Generate Button
                const generateSubDeptWiseReportBtn = document.getElementById('generateSubDeptWiseReportBtn');
                if (generateSubDeptWiseReportBtn && !generateSubDeptWiseReportBtn.hasAttribute('data-listener-attached')) {
                    generateSubDeptWiseReportBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log(' Sub-department-wise report generate button clicked');
                        if (typeof generateSubDeptWiseReport === 'function') {
                            generateSubDeptWiseReport();
                        } else {
                            console.error(' generateSubDeptWiseReport function not found');
                            showNotification('Error: Report generation function not found', 'error');
                        }
                    });
                    generateSubDeptWiseReportBtn.setAttribute('data-listener-attached', 'true');
                }
            }
            
            // Call setup functions immediately (buttons might already exist)
            setupReportGenerateButtons();
            setupShopReportGenerateButtons();
            
            // Listen for sectionLoaded event to setup buttons when reports section loads dynamically
            document.addEventListener('sectionLoaded', function(e) {
                if (e && e.detail && e.detail.sectionName === 'reports') {
                    setTimeout(() => {
                        if (typeof setupReportGenerateButtons === 'function') {
                            setupReportGenerateButtons();
                        }
                        if (typeof setupShopReportGenerateButtons === 'function') {
                            setupShopReportGenerateButtons();
                        }
                    }, 200);
                }
            });
            
            // Real-time search for Datewise Report
            const datewiseSearchInput = document.getElementById('datewiseSearch');
            if (datewiseSearchInput) {
                let searchTimeout;
                datewiseSearchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        generateDatewiseReport();
                    }, 300); // 300ms delay to avoid excessive calls
                });
            }
            
            // Print buttons
            const printSalesReportBtn = document.getElementById('printSalesReportBtn');
            if (printSalesReportBtn) {
                printSalesReportBtn.addEventListener('click', function() {
                    printSalesReportPreview();
                });
            }
            
            const printComparisonReportBtn = document.getElementById('printComparisonReportBtn');
            if (printComparisonReportBtn) {
                printComparisonReportBtn.addEventListener('click', function() {
                    printComparisonReportPreview();
                });
            }
            
            const printDatewiseReportBtn = document.getElementById('printDatewiseReportBtn');
            if (printDatewiseReportBtn) {
                printDatewiseReportBtn.addEventListener('click', function() {
                    printDateWiseData();
                });
            }
            
            // Payment Report Generate Button
            const generatePaymentReportBtn = document.getElementById('generatePaymentReportBtn');
            if (generatePaymentReportBtn) {
                generatePaymentReportBtn.addEventListener('click', function() {
                    generatePaymentReport();
                });
            }
            
            // Payment Report Print Button
            const printPaymentReportBtn = document.getElementById('printPaymentReportBtn');
            if (printPaymentReportBtn) {
                printPaymentReportBtn.addEventListener('click', function() {
                    printPaymentReportPreview();
                });
            }
            
            // Department-Wise Report Generate Button
            const generateDeptWiseReportBtn = document.getElementById('generateDeptWiseReportBtn');
            if (generateDeptWiseReportBtn) {
                generateDeptWiseReportBtn.addEventListener('click', function() {
                    generateDeptWiseReport();
                    showNotification('Department-wise report generated successfully!', 'success');
                });
            }
            
            // Sub-Department-Wise Report Generate Button
            const generateSubDeptWiseReportBtn = document.getElementById('generateSubDeptWiseReportBtn');
            if (generateSubDeptWiseReportBtn) {
                generateSubDeptWiseReportBtn.addEventListener('click', function() {
                    generateSubDeptWiseReport();
                    showNotification('Sub-department-wise report generated successfully!', 'success');
                });
            }
            
            // Department-Wise Report Print Button
            const printDeptWiseReportBtn = document.getElementById('printDeptWiseReportBtn');
            if (printDeptWiseReportBtn) {
                printDeptWiseReportBtn.addEventListener('click', function() {
                    printDeptWiseReport();
                });
            }
            
            // Sub-Department-Wise Report Print Button
            const printSubDeptWiseReportBtn = document.getElementById('printSubDeptWiseReportBtn');
            if (printSubDeptWiseReportBtn) {
                printSubDeptWiseReportBtn.addEventListener('click', function() {
                    printSubDeptWiseReport();
                });
            }
            
            // Department-Wise Sale Comparison Generate Button
            const generateDeptComparisonReportBtn = document.getElementById('generateDeptComparisonReportBtn');
            if (generateDeptComparisonReportBtn) {
                generateDeptComparisonReportBtn.addEventListener('click', function() {
                    generateDeptComparisonReport();
                    showNotification('Department-wise comparison report generated successfully!', 'success');
                });
            }
            
            // Branch-Wise Sale Comparison Generate Button
            const generateBranchComparisonReportBtn = document.getElementById('generateBranchComparisonReportBtn');
            if (generateBranchComparisonReportBtn) {
                generateBranchComparisonReportBtn.addEventListener('click', function() {
                    generateBranchComparisonReport();
                    showNotification('Branch-wise comparison report generated successfully!', 'success');
                });
            }
            
            // Shop Dashboard Department-Wise Report Print Button
            const printShopDashboardDeptWiseReportBtn = document.getElementById('printShopDashboardDeptWiseReportBtn');
            if (printShopDashboardDeptWiseReportBtn) {
                printShopDashboardDeptWiseReportBtn.addEventListener('click', function() {
                    printShopDashboardDeptWiseReport();
                });
            }
            
            // Department-Wise Sale Comparison Print Button
            const printDeptComparisonReportBtn = document.getElementById('printDeptComparisonReportBtn');
            if (printDeptComparisonReportBtn) {
                printDeptComparisonReportBtn.addEventListener('click', function() {
                    printDeptComparisonReport();
                });
            }
            
            // Branch-Wise Sale Comparison Print Button
            const printBranchComparisonReportBtn = document.getElementById('printBranchComparisonReportBtn');
            if (printBranchComparisonReportBtn) {
                printBranchComparisonReportBtn.addEventListener('click', function() {
                    printBranchComparisonReport();
                });
            }
            
            // Load departments when branch changes in shop report
            const shopReportBranch = document.getElementById('shopReportBranch');
            if (shopReportBranch) {
                shopReportBranch.addEventListener('change', function() {
                    loadDepartmentsForShopReport();
                });
            }
            
            // Load sub-departments when department changes in shop report
            const shopReportDepartment = document.getElementById('shopReportDepartment');
            if (shopReportDepartment) {
                shopReportDepartment.addEventListener('change', function() {
                    loadSubDepartmentsForShopReport();
                });
            }
            
            // Load departments when branch changes in department-wise report
            const deptWiseReportBranch = document.getElementById('deptWiseReportBranch');
            if (deptWiseReportBranch) {
                deptWiseReportBranch.addEventListener('change', function() {
                    loadDepartmentsForDeptWiseReport();
                });
            }
            
            // Load departments when branch changes in sub-department-wise report
            const subDeptWiseReportBranch = document.getElementById('subDeptWiseReportBranch');
            if (subDeptWiseReportBranch) {
                subDeptWiseReportBranch.addEventListener('change', function() {
                    loadDepartmentsForSubDeptWiseReport();
                });
            }
            
            // Load sub-departments when department changes in sub-department-wise report
            const subDeptWiseReportDepartment = document.getElementById('subDeptWiseReportDepartment');
            if (subDeptWiseReportDepartment) {
                subDeptWiseReportDepartment.addEventListener('change', function() {
                    loadSubDepartmentsForSubDeptWiseReport();
                });
            }
            
            // ========================================
            // NEW: Enhanced Print Options Event Listeners
            // ========================================
            
            // Detailed Report Print (Only Detailed Transaction List, NO Summary)
            const printDetailedReportBtn = document.getElementById('printDetailedReport');
            if (printDetailedReportBtn) {
                printDetailedReportBtn.addEventListener('click', function(e) {
                e.preventDefault();
                printDetailedReport();
            });
            }
            
            // Summary Report Print
            const printSummaryReportBtn = document.getElementById('printSummaryReport');
            if (printSummaryReportBtn) {
                printSummaryReportBtn.addEventListener('click', function(e) {
                e.preventDefault();
                printSummaryReport();
            });
            }
            
            // Sales Comparison Print
            const printSalesComparisonBtn = document.getElementById('printSalesComparison');
            if (printSalesComparisonBtn) {
                printSalesComparisonBtn.addEventListener('click', function(e) {
                e.preventDefault();
                printSalesComparison();
            });
            }
            
            // NEW: All Branches Summary Print
            const printAllBranchesSummaryBtn = document.getElementById('printAllBranchesSummary');
            if (printAllBranchesSummaryBtn) {
                printAllBranchesSummaryBtn.addEventListener('click', function(e) {
                e.preventDefault();
                printAllBranchesSummary();
            });
            }
            
            // NEW: Date Wise Data Print
            const printDateWiseDataBtn = document.getElementById('printDateWiseData');
            if (printDateWiseDataBtn) {
                printDateWiseDataBtn.addEventListener('click', function(e) {
                e.preventDefault();
                printDateWiseData();
            });
            }
            
            // NEW: Category-wise Branch Comparison Print
            const printCategoryWiseComparisonBtn = document.getElementById('printCategoryWiseComparison');
            if (printCategoryWiseComparisonBtn) {
                printCategoryWiseComparisonBtn.addEventListener('click', function(e) {
                e.preventDefault();
                printCategoryWiseComparison();
            });
            }
            
            // NEW: Summary + Comparison Print
            const printSummaryAndComparisonBtn = document.getElementById('printSummaryAndComparison');
            if (printSummaryAndComparisonBtn) {
                printSummaryAndComparisonBtn.addEventListener('click', function(e) {
                e.preventDefault();
                printSummaryAndComparison();
            });
            }
            
            // NEW: Print Report Dropdown Event Listeners
            const printSummaryReportNewBtn = document.getElementById('printSummaryReportNew');
            if (printSummaryReportNewBtn) {
                printSummaryReportNewBtn.addEventListener('click', function(e) {
                e.preventDefault();
                printSummaryReportNew();
            });
            }
            
            const printDetailedReportNewBtn = document.getElementById('printDetailedReportNew');
            if (printDetailedReportNewBtn) {
                printDetailedReportNewBtn.addEventListener('click', function(e) {
                e.preventDefault();
                printDetailedReportNew();
            });
            }
            
            // NEW: Preview report button (Report Summary + Sales Comparison only)
            const previewReportBtn = document.getElementById('previewReportBtn');
            if (previewReportBtn) {
                previewReportBtn.addEventListener('click', function() {
                previewSummaryReport();
            });
            }
            
            // Download PDF button
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            if (downloadPdfBtn) {
                downloadPdfBtn.addEventListener('click', function() {
                downloadPdfReport();
            });
            }
            
            // NEW: Category-wise Branch Comparison Event Listeners
            const generateCategoryComparisonBtn = document.getElementById('generateCategoryComparisonBtn');
            if (generateCategoryComparisonBtn) {
                generateCategoryComparisonBtn.addEventListener('click', function() {
                generateCategoryComparison();
            });
            }
            
            const printCategoryComparisonBtn = document.getElementById('printCategoryComparisonBtn');
            if (printCategoryComparisonBtn) {
                printCategoryComparisonBtn.addEventListener('click', function() {
                printCategoryWiseComparison();
            });
            }
            
            
            // Filter sales list
            const filterSalesList = document.getElementById('filterSalesList');
            if (filterSalesList) {
                filterSalesList.addEventListener('click', function() {
                    loadSalesList();
                });
            }
            
            // Filter department sales list
            const filterDeptSalesList = document.getElementById('filterDeptSalesList');
            if (filterDeptSalesList) {
                filterDeptSalesList.addEventListener('click', function() {
                    loadDeptSalesList();
                });
            }
            
            // Add event listener for branch dropdown change in Department Sales List
            const deptSalesListBranch = document.getElementById('deptSalesListBranch');
            if (deptSalesListBranch) {
                deptSalesListBranch.addEventListener('change', function() {
                    loadDepartmentsForDeptSalesList();
                });
            }
            
        // Add category button
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        if (addCategoryBtn) {
            addCategoryBtn.addEventListener('click', function() {
            
            // Reset form
            document.getElementById('categoryForm').reset();
            
            // Update modal title for ADD mode
            document.getElementById('addCategoryModalLabel').textContent = 'Add New Category';
            
            // FORCE RESET save button to create mode
            const saveBtn = document.getElementById('saveCategoryBtn');
            if (saveBtn) {
                saveBtn.textContent = 'Save Category';
                
                // Remove ALL existing event handlers
                saveBtn.onclick = null;
                saveBtn.removeAttribute('onclick');
                
                // Create a new function that calls saveCategory with validation
                const createCategoryHandler = function() {
                    if (document.getElementById('categoryForm').checkValidity()) {
                    saveCategory();
                    } else {
                        document.getElementById('categoryForm').reportValidity();
                    }
                };
                
                // Set the new handler
                saveBtn.onclick = createCategoryHandler;
                
            }
            
            const modal = new bootstrap.Modal(document.getElementById('addCategoryModal'));
            modal.show();
        });
        }
            
        // Note: Save button event handlers are managed dynamically in addCategoryBtn click handler and editCategory function
        // This prevents conflicts between create and update modes
            
        // Add branch button
        const addBranchBtn = document.getElementById('addBranchBtn');
        if (addBranchBtn) {
            addBranchBtn.addEventListener('click', function() {
            // Reset form
            document.getElementById('branchForm').reset();
            
            // Reset save button to create mode - FORCE RESET
            const saveBtn = document.getElementById('saveBranchBtn');
            if (saveBtn) {
                saveBtn.textContent = 'Save Branch';
                // Remove any existing onclick handlers
                saveBtn.onclick = null;
                saveBtn.removeAttribute('onclick');
                
                // Set new onclick handler with validation
                saveBtn.onclick = function() {
                    if (document.getElementById('branchForm').checkValidity()) {
                    saveBranch();
                    } else {
                        document.getElementById('branchForm').reportValidity();
                    }
                };
            }
            
            const modal = new bootstrap.Modal(document.getElementById('addBranchModal'));
            modal.show();
        });
        }
            
        // Note: Save button event handlers are managed dynamically in addBranchBtn click handler and editBranch function
        // This prevents conflicts between create and update modes
            
            // Note: Add group functionality is now handled by the inline form
            // The save button (saveGroupBtn) is set up in the showSection('groups') case
            // No need for addGroupBtn event listener as we're using inline form
            
            // Add user button
            document.getElementById('addUserBtn').addEventListener('click', function() {
                // Check if user is admin
                if (!isAdmin()) {
                    showNotification('You need admin privileges to create users', 'error');
                    return;
                }
                
                // Clear form
                document.getElementById('userForm').reset();
                
                // Reset save button to create mode - FORCE RESET
                const saveBtn = document.getElementById('saveUserBtn');
                if (saveBtn) {
                    saveBtn.textContent = 'Save User';
                    // Remove any existing onclick handlers
                    saveBtn.onclick = null;
                    saveBtn.removeAttribute('onclick');
                    
                    // Set new onclick handler with validation
                    saveBtn.onclick = function() {
                        if (document.getElementById('userForm').checkValidity()) {
                            saveUser();
                        } else {
                            document.getElementById('userForm').reportValidity();
                        }
                    };
                }
                
                // Populate group selector
                populateGroupSelectorInUserModal();
                
                // Populate branch selector
                populateBranchSelectorInUserModal();
                
                const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
                modal.show();
            });
            
            // Add supplier button
            const addSupplierBtn = document.getElementById('addSupplierBtn');
            if (addSupplierBtn) {
                addSupplierBtn.addEventListener('click', function() {
                    // Reset form
                    document.getElementById('supplierForm').reset();
                    
                    // Update modal title for ADD mode
                    document.getElementById('addSupplierModalLabel').textContent = 'Add New Supplier';
                    
                    // FORCE RESET save button to create mode
                    const saveBtn = document.getElementById('saveSupplierBtn');
                    if (saveBtn) {
                        saveBtn.textContent = 'Save Supplier';
                        
                        // Remove ALL existing event handlers
                        saveBtn.onclick = null;
                        saveBtn.removeAttribute('onclick');
                        
                        // Create a new function that calls saveSupplier with validation
                        const createSupplierHandler = function() {
                            if (document.getElementById('supplierForm').checkValidity()) {
                                saveSupplier();
                            } else {
                                document.getElementById('supplierForm').reportValidity();
                            }
                        };
                        
                        // Set the new handler
                        saveBtn.onclick = createSupplierHandler;
                    }
                    
                    const modal = new bootstrap.Modal(document.getElementById('addSupplierModal'));
                    modal.show();
                });
            }
            
            // Confirm promote user button
            const confirmPromoteBtn = document.getElementById('confirmPromoteBtn');
            if (confirmPromoteBtn) {
                confirmPromoteBtn.addEventListener('click', function() {
                    const promoteUserForm = document.getElementById('promoteUserForm');
                    if (promoteUserForm && promoteUserForm.checkValidity()) {
                        promoteUserToAdmin();
                    } else if (promoteUserForm) {
                        promoteUserForm.reportValidity();
                    }
                });
            }
            
            // Update sale button
            const updateSaleBtn = document.getElementById('updateSaleBtn');
            if (updateSaleBtn) {
                updateSaleBtn.addEventListener('click', function() {
                    const editSaleForm = document.getElementById('editSaleForm');
                    if (editSaleForm && editSaleForm.checkValidity()) {
                        updateSale();
                    } else if (editSaleForm) {
                        editSaleForm.reportValidity();
                    }
                });
            }
            
            // Edit Department Sale Modal Event Listeners
            const updateDeptSaleBtn = document.getElementById('updateDeptSaleBtn');
            if (updateDeptSaleBtn) {
                updateDeptSaleBtn.addEventListener('click', function() {
                    if (document.getElementById('editDeptSaleForm').checkValidity()) {
                        updateDeptSale();
                    } else {
                        document.getElementById('editDeptSaleForm').reportValidity();
                    }
                });
            }
            
            // Calculate net sale when fields change in edit department sale modal
            const editDeptSaleGrossSale = document.getElementById('editDeptSaleGrossSale');
            const editDeptSaleDiscount = document.getElementById('editDeptSaleDiscount');
            const editDeptSaleReturn = document.getElementById('editDeptSaleReturn');
            const editDeptSaleGST = document.getElementById('editDeptSaleGST');
            const editDeptSaleNetSale = document.getElementById('editDeptSaleNetSale');
            
            function calculateEditDeptSaleNetSale() {
                if (!editDeptSaleNetSale) return;
                const grossSale = parseFloat(editDeptSaleGrossSale?.value) || 0;
                const discount = parseFloat(editDeptSaleDiscount?.value) || 0;
                const returnAmount = parseFloat(editDeptSaleReturn?.value) || 0;
                const gst = parseFloat(editDeptSaleGST?.value) || 0;
                const saleValue = grossSale - discount;
                const netSale = saleValue - returnAmount + gst;
                editDeptSaleNetSale.value = netSale.toFixed(2);
            }
            
            if (editDeptSaleGrossSale) {
                editDeptSaleGrossSale.addEventListener('input', calculateEditDeptSaleNetSale);
            }
            if (editDeptSaleDiscount) {
                editDeptSaleDiscount.addEventListener('input', calculateEditDeptSaleNetSale);
            }
            if (editDeptSaleReturn) {
                editDeptSaleReturn.addEventListener('input', calculateEditDeptSaleNetSale);
            }
            if (editDeptSaleGST) {
                editDeptSaleGST.addEventListener('input', calculateEditDeptSaleNetSale);
            }
            
            // Branch change in edit department sale modal
            const editDeptSaleBranch = document.getElementById('editDeptSaleBranch');
            if (editDeptSaleBranch) {
                editDeptSaleBranch.addEventListener('change', function() {
                    const branchId = this.value;
                    loadDepartmentsForEditDeptSale(branchId);
                });
            }
            
            // Department change in edit department sale modal
            const editDeptSaleDepartment = document.getElementById('editDeptSaleDepartment');
            if (editDeptSaleDepartment) {
                editDeptSaleDepartment.addEventListener('change', function() {
                    const departmentId = this.value;
                    loadSubDepartmentsForEditDeptSale(departmentId);
                });
            }
            
            // Update payment button
            const updatePaymentBtn = document.getElementById('updatePaymentBtn');
            if (updatePaymentBtn) {
                updatePaymentBtn.addEventListener('click', function() {
                    const editPaymentForm = document.getElementById('editPaymentForm');
                    if (editPaymentForm && editPaymentForm.checkValidity()) {
                        updatePayment();
                    } else if (editPaymentForm) {
                        editPaymentForm.reportValidity();
                    }
                });
            }
            
            // Settings form
            const settingsForm = document.getElementById('settingsForm');
            if (settingsForm) {
                settingsForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveSettings();
                });
            }
            
            // API Key Management Event Listeners
            const createApiKeyBtn = document.getElementById('createApiKeyBtn');
            if (createApiKeyBtn) {
                createApiKeyBtn.addEventListener('click', function() {
                    resetApiKeyModal();
                    const modal = new bootstrap.Modal(document.getElementById('createApiKeyModal'));
                    modal.show();
                });
            }
            
            const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
            if (saveApiKeyBtn) {
                saveApiKeyBtn.addEventListener('click', function() {
                    createApiKey();
                });
            }
            
            // Reset modal when closed
            const createApiKeyModal = document.getElementById('createApiKeyModal');
            if (createApiKeyModal) {
                createApiKeyModal.addEventListener('hidden.bs.modal', function() {
                    resetApiKeyModal();
                });
            }
            
            // Backup and restore
            const backupDataBtn = document.getElementById('backupDataBtn');
            if (backupDataBtn) {
                backupDataBtn.addEventListener('click', backupData);
            }
            const restoreDataBtn = document.getElementById('restoreDataBtn');
            if (restoreDataBtn) {
                restoreDataBtn.addEventListener('click', function() {
                    const restoreFile = document.getElementById('restoreFile');
                    if (restoreFile) restoreFile.click();
                });
            }
            const restoreFile = document.getElementById('restoreFile');
            if (restoreFile) {
                restoreFile.addEventListener('change', restoreData);
            }
            
            // Sales list view toggle
            const cardViewBtn = document.getElementById('cardViewBtn');
            if (cardViewBtn) {
                cardViewBtn.addEventListener('click', function() {
                    const salesCardView = document.getElementById('salesCardView');
                    const salesTableView = document.getElementById('salesTableView');
                    const tableViewBtn = document.getElementById('tableViewBtn');
                    if (salesCardView) salesCardView.style.display = 'block';
                    if (salesTableView) salesTableView.style.display = 'none';
                    if (cardViewBtn) cardViewBtn.classList.add('active');
                    if (tableViewBtn) tableViewBtn.classList.remove('active');
                });
            }
            
            const tableViewBtn = document.getElementById('tableViewBtn');
            if (tableViewBtn) {
                tableViewBtn.addEventListener('click', function() {
                    const salesCardView = document.getElementById('salesCardView');
                    const salesTableView = document.getElementById('salesTableView');
                    const cardViewBtn = document.getElementById('cardViewBtn');
                    if (salesCardView) salesCardView.style.display = 'none';
                    if (salesTableView) salesTableView.style.display = 'block';
                    if (tableViewBtn) tableViewBtn.classList.add('active');
                    if (cardViewBtn) cardViewBtn.classList.remove('active');
                });
            }
            
            // Branch view toggle
            // Branch view toggle - with null check
            const branchCardViewBtn = document.getElementById('branchCardViewBtn');
            const branchTableViewBtn = document.getElementById('branchTableViewBtn');
            if (branchCardViewBtn && branchTableViewBtn) {
                branchCardViewBtn.addEventListener('click', function() {
                    const branchCardView = document.getElementById('branchCardView');
                    const branchTableView = document.getElementById('branchTableView');
                    if (branchCardView) branchCardView.style.display = 'block';
                    if (branchTableView) branchTableView.style.display = 'none';
                    branchCardViewBtn.classList.add('active');
                    branchTableViewBtn.classList.remove('active');
                });
                
                branchTableViewBtn.addEventListener('click', function() {
                    const branchTableView = document.getElementById('branchTableView');
                    const branchCardView = document.getElementById('branchCardView');
                    if (branchTableView) branchTableView.style.display = 'block';
                    if (branchCardView) branchCardView.style.display = 'none';
                    branchTableViewBtn.classList.add('active');
                    branchCardViewBtn.classList.remove('active');
                });
            }
            
            // Category view toggle - with null check
            const categoryCardViewBtn = document.getElementById('categoryCardViewBtn');
            const categoryTableViewBtn = document.getElementById('categoryTableViewBtn');
            if (categoryCardViewBtn && categoryTableViewBtn) {
                categoryCardViewBtn.addEventListener('click', function() {
                    const categoryCardView = document.getElementById('categoryCardView');
                    const categoryTableView = document.getElementById('categoryTableView');
                    if (categoryCardView) categoryCardView.style.display = 'block';
                    if (categoryTableView) categoryTableView.style.display = 'none';
                    categoryCardViewBtn.classList.add('active');
                    categoryTableViewBtn.classList.remove('active');
                });
                
                categoryTableViewBtn.addEventListener('click', function() {
                    const categoryTableView = document.getElementById('categoryTableView');
                    const categoryCardView = document.getElementById('categoryCardView');
                    if (categoryTableView) categoryTableView.style.display = 'block';
                    if (categoryCardView) categoryCardView.style.display = 'none';
                    categoryTableViewBtn.classList.add('active');
                    categoryCardViewBtn.classList.remove('active');
                });
            }
            
            // Supplier view toggle buttons
            const supplierCardViewBtn = document.getElementById('supplierCardViewBtn');
            const supplierTableViewBtn = document.getElementById('supplierTableViewBtn');
            if (supplierCardViewBtn && supplierTableViewBtn) {
                supplierCardViewBtn.addEventListener('click', function() {
                    document.getElementById('supplierCardView').style.display = 'block';
                    document.getElementById('supplierTableView').style.display = 'none';
                    supplierCardViewBtn.classList.add('active');
                    supplierTableViewBtn.classList.remove('active');
                });
                
                supplierTableViewBtn.addEventListener('click', function() {
                    document.getElementById('supplierTableView').style.display = 'block';
                    document.getElementById('supplierCardView').style.display = 'none';
                    supplierTableViewBtn.classList.add('active');
                    supplierCardViewBtn.classList.remove('active');
                });
            }
            
            // Group view toggle (removed - using inline table view only)
            // Note: groupCardViewBtn and groupTableViewBtn no longer exist in new design
            
            // User view toggle
            const userCardViewBtn = document.getElementById('userCardViewBtn');
            const userTableViewBtn = document.getElementById('userTableViewBtn');
            if (userCardViewBtn && userTableViewBtn) {
                userCardViewBtn.addEventListener('click', function() {
                    const userCardView = document.getElementById('userCardView');
                    const userTableView = document.getElementById('userTableView');
                    if (userCardView) userCardView.style.display = 'block';
                    if (userTableView) userTableView.style.display = 'none';
                    userCardViewBtn.classList.add('active');
                    userTableViewBtn.classList.remove('active');
                });
                
                userTableViewBtn.addEventListener('click', function() {
                    const userCardView = document.getElementById('userCardView');
                    const userTableView = document.getElementById('userTableView');
                    if (userCardView) userCardView.style.display = 'none';
                    if (userTableView) userTableView.style.display = 'block';
                    userTableViewBtn.classList.add('active');
                    userCardViewBtn.classList.remove('active');
                });
            }
        }
        
        // Logout function
        async function logout() {
            try {
                await api.logout();
                showNotification('Logged out successfully', 'success');
                // Stop inactivity watcher on logout
                stopInactivityWatch();
                
                // Clear user data
                appData.currentUser = null;
                
                // Show login form
                showLoginSection();
                
                // For demo purposes, we'll reload the page
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } catch (error) {
                console.error('Error logging out:', error);
                showNotification('Error logging out', 'error');
            }
        }
        
        // Initialize sales entry buttons visibility based on active tab
        function initializeSalesEntryButtons() {
            const categoryTabElement = document.getElementById('category-tab');
            const departmentTabElement = document.getElementById('department-tab');
            const viewSalesListBtn = document.getElementById('viewSalesListBtn');
            const viewDeptSalesListBtn = document.getElementById('viewDeptSalesListBtn');
            
            if (!viewSalesListBtn || !viewDeptSalesListBtn) return;
            
            // Check which tab is active
            if (categoryTabElement && categoryTabElement.classList.contains('active')) {
                viewSalesListBtn.style.display = 'block';
                viewDeptSalesListBtn.style.display = 'none';
            } else if (departmentTabElement && departmentTabElement.classList.contains('active')) {
                viewSalesListBtn.style.display = 'none';
                viewDeptSalesListBtn.style.display = 'block';
            }
        }
        
        // Show section
        function showSection(sectionId) {
            // Validate sectionId before proceeding
            if (!sectionId || sectionId === 'null' || sectionId === 'undefined' || sectionId === '') {
                console.error(' showSection called with invalid sectionId:', sectionId);
                console.trace('Call stack:');
                return;
            }
            
            console.log(' showSection called with:', sectionId);
            
            // Update URL hash (only if different to avoid unnecessary hashchange events)
            if (window.location.hash !== '#' + sectionId) {
                window.history.replaceState(null, null, '#' + sectionId);
            }
            
            // Save current section to localStorage for page refresh persistence
            try {
                localStorage.setItem('lastActiveSection', sectionId);
            } catch (e) {
                console.warn('Could not save last active section to localStorage:', e);
            }
            
            // Check permissions BEFORE showing section
            if (appData.currentUser) {
                const permissions = appData.currentUser.permissions || [];
                const isAdmin = permissions.includes('admin');
                
                // Admin has access to all sections (except payment and support sections which require explicit permission)
                if (isAdmin && !sectionId.startsWith('payment-') && sectionId !== 'support-chat') {
                    // Admin can access, continue
                } else {
                    // Use the comprehensive permission check function
                    if (!hasPermission(sectionId, permissions)) {
                        showNotification(`You don't have permission to access ${sectionId}`, 'error');
                        console.warn(' Permission denied for section:', sectionId);
                        return;
                    }
                }
            }
            
            // FIRST: Hide all sections immediately before loading view
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
                section.style.setProperty('display', 'none', 'important');
                section.style.setProperty('visibility', 'hidden', 'important');
                section.style.setProperty('opacity', '0', 'important');
            });
            
            // Load view HTML and JS dynamically if not already loaded
            if (typeof window.loadView === 'function' && window.viewFiles && window.viewFiles[sectionId]) {
                // Use async/await pattern for better error handling
                (async () => {
                    try {
                        await window.loadView(sectionId);
                        // Small delay to ensure DOM is ready
                        await new Promise(resolve => setTimeout(resolve, 50));
                        // Hide all sections again after loading (in case loadView added content to wrong section)
                        document.querySelectorAll('.content-section').forEach(section => {
                            if (section.id !== sectionId + '-section') {
                                section.classList.remove('active');
                                section.style.setProperty('display', 'none', 'important');
                                section.style.setProperty('visibility', 'hidden', 'important');
                                section.style.setProperty('opacity', '0', 'important');
                            }
                        });
                        continueShowSection(sectionId);
                    } catch (error) {
                        console.error('Error loading view:', error);
                        continueShowSection(sectionId); // Still try to show section
                    }
                })();
            } else {
                continueShowSection(sectionId);
            }
        }
        
        function continueShowSection(sectionId) {
            // FIRST: Ensure main-content container has proper height
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                const mainContentComputed = window.getComputedStyle(mainContent);
                if (mainContent.offsetHeight === 0 || mainContentComputed.display === 'none') {
                    mainContent.style.minHeight = '100vh';
                    mainContent.style.height = 'auto';
                    mainContent.style.display = 'block';
                    console.log(' Fixed main-content container');
                }
            }
            
            // Hide ALL sections - force hide with inline style to override any other styles
            // This must happen BEFORE showing the target section
            document.querySelectorAll('.content-section').forEach(section => {
                // Remove active class first
                section.classList.remove('active');
                // Force hide with inline style to ensure CSS !important rules work
                section.style.setProperty('display', 'none', 'important');
                section.style.setProperty('visibility', 'hidden', 'important');
                section.style.setProperty('opacity', '0', 'important');
                section.style.setProperty('height', 'auto', 'important');
                section.style.setProperty('min-height', '0', 'important');
                section.style.setProperty('max-height', '0', 'important');
            });
            
            // Show selected section - use multiple methods to ensure visibility
            const targetSection = document.getElementById(sectionId + '-section');
            if (!targetSection) {
                console.error(' Section not found:', sectionId + '-section');
                return;
            }
            
            console.log(' Found section:', targetSection);
            
            // IMMEDIATELY ensure section is visible before any async operations
            // First add active class, then set display to let CSS handle it properly
            targetSection.classList.add('active');
            // Remove inline display to let CSS !important rule take effect
            targetSection.style.removeProperty('display');
            targetSection.style.removeProperty('visibility');
            targetSection.style.removeProperty('opacity');
            targetSection.style.height = 'auto';
            targetSection.style.minHeight = '1px';
            
            // Force reflow before showing
            void targetSection.offsetHeight; // Trigger reflow
            
            // Force browser repaint using requestAnimationFrame
            requestAnimationFrame(() => {
                // Ensure section is truly visible by checking computed styles
                const computed = window.getComputedStyle(targetSection);
                
                // Check if section is hidden or has zero dimensions
                const isHidden = computed.display === 'none' || targetSection.offsetHeight === 0 || targetSection.offsetWidth === 0;
                
                if (isHidden) {
                    // Ensure active class is set first
                    if (!targetSection.classList.contains('active')) {
                        targetSection.classList.add('active');
                    }
                    // Remove inline display to let CSS handle it
                    targetSection.style.removeProperty('display');
                    targetSection.style.removeProperty('visibility');
                    targetSection.style.removeProperty('opacity');
                    targetSection.style.height = 'auto';
                    targetSection.style.minHeight = '1px';
                    
                    // Force another reflow
                    void targetSection.offsetHeight;
                }
                
                // Ensure active class is set (redundant but safe)
                if (!targetSection.classList.contains('active')) {
                    targetSection.classList.add('active');
                }
                
                // Double-check: ensure ALL other sections are hidden (not just those with active class)
                document.querySelectorAll('.content-section').forEach(section => {
                    if (section !== targetSection) {
                        section.classList.remove('active');
                        section.style.setProperty('display', 'none', 'important');
                        section.style.setProperty('visibility', 'hidden', 'important');
                        section.style.setProperty('opacity', '0', 'important');
                        section.style.setProperty('height', 'auto', 'important');
                        section.style.setProperty('min-height', '0', 'important');
                        section.style.setProperty('max-height', '0', 'important');
                    }
                });
                
                // Immediately check and fix parent container height
                const parent = targetSection.parentElement;
                if (parent) {
                    const parentComputed = window.getComputedStyle(parent);
                    if (parent.classList.contains('main-content')) {
                        // Ensure main-content has proper height
                        if (parent.offsetHeight === 0) {
                            parent.style.minHeight = '100vh';
                            parent.style.height = 'auto';
                            console.log(' Fixed main-content height');
                        }
                    }
                    // Fix any parent with zero height
                    if (parent.offsetHeight === 0 && parentComputed.display !== 'none') {
                        parent.style.minHeight = '1px';
                        parent.style.height = 'auto';
                        console.log(' Fixed parent container height:', parent.className || parent.id);
                    }
                }
                
                // FINAL CHECK: Ensure ONLY the target section is visible
                // This is a critical check to prevent multiple sections showing
                document.querySelectorAll('.content-section').forEach(section => {
                    if (section !== targetSection) {
                        // Force hide with !important
                        section.classList.remove('active');
                        section.style.setProperty('display', 'none', 'important');
                        section.style.setProperty('visibility', 'hidden', 'important');
                        section.style.setProperty('opacity', '0', 'important');
                        section.style.setProperty('height', '0', 'important');
                        section.style.setProperty('min-height', '0', 'important');
                        section.style.setProperty('max-height', '0', 'important');
                        section.style.setProperty('overflow', 'hidden', 'important');
                    }
                });
                
                // Force section to have height if it has content
                if (targetSection.children.length > 0) {
                    // Remove any height restrictions
                    targetSection.style.height = 'auto';
                    targetSection.style.minHeight = '1px';
                    targetSection.style.maxHeight = 'none';
                    
                    // Force reflow
                    void targetSection.offsetHeight;
                }
                
                // Check dimensions after a delay to allow content to render
                setTimeout(() => {
                    const hasContent = targetSection.children.length > 0 || targetSection.textContent.trim().length > 0;
                    const stillZeroHeight = targetSection.offsetHeight === 0;
                    const parentZeroHeight = parent && parent.offsetHeight === 0;
                    
                    // If section has content but zero height, force fix it
                    if (stillZeroHeight && hasContent) {
                        console.warn(' Section has content but zero height, forcing fix:', sectionId);
                        
                        // Ensure active class is set (let CSS handle display)
                        if (!targetSection.classList.contains('active')) {
                            targetSection.classList.add('active');
                        }
                        // Remove inline display styles to let CSS handle it
                        targetSection.style.removeProperty('display');
                        targetSection.style.removeProperty('visibility');
                        targetSection.style.removeProperty('opacity');
                        targetSection.style.height = 'auto';
                        targetSection.style.minHeight = '1px';
                        
                        // Double-check: ensure all other sections are hidden
                        document.querySelectorAll('.content-section').forEach(section => {
                            if (section !== targetSection) {
                                section.classList.remove('active');
                                section.style.display = 'none';
                                section.style.visibility = 'hidden';
                                section.style.opacity = '0';
                            }
                        });
                        
                        // Check parent container
                        if (parentZeroHeight) {
                            if (parent.classList.contains('main-content')) {
                                parent.style.minHeight = '100vh';
                                parent.style.height = 'auto';
                            } else {
                                parent.style.minHeight = '1px';
                                parent.style.height = 'auto';
                            }
                            console.log(' Fixed parent container:', parent.className || parent.id);
                            
                            // Verify after fix
                            setTimeout(() => {
                                if (parent.offsetHeight === 0) {
                                    console.warn(' Parent container still has zero height after fix:', parent.className || parent.id);
                                } else {
                                    console.log(' Parent container fixed:', parent.className || parent.id, 'height:', parent.offsetHeight);
                                }
                            }, 100);
                        }
                        
                        // Force another reflow
                        void targetSection.offsetHeight;
                        
                        // Verify section after all fixes and ensure other sections are hidden
                        setTimeout(() => {
                            // Final check: ensure ALL other sections are hidden
                            document.querySelectorAll('.content-section').forEach(section => {
                                if (section !== targetSection) {
                                    section.classList.remove('active');
                                    section.style.display = 'none';
                                    section.style.visibility = 'hidden';
                                    section.style.opacity = '0';
                                }
                            });
                            
                            if (targetSection.offsetHeight === 0) {
                                console.warn(' Section still has zero dimensions after fixes:', sectionId);
                                const computedAfter = window.getComputedStyle(targetSection);
                                console.log(' Section visibility debug:', {
                                    display: computedAfter.display,
                                    visibility: computedAfter.visibility,
                                    opacity: computedAfter.opacity,
                                    height: targetSection.offsetHeight,
                                    width: targetSection.offsetWidth,
                                    parentHeight: parent?.offsetHeight || 0,
                                    hasActive: targetSection.classList.contains('active'),
                                    hasContent: hasContent
                                });
                            } else {
                                console.log(' Section fixed and visible:', sectionId, 'height:', targetSection.offsetHeight);
                            }
                        }, 200);
                    }
                    
                    // Remove inline display if CSS should handle it (but keep if we just forced it)
                    const computedAfterCheck = window.getComputedStyle(targetSection);
                    if (computedAfterCheck.display !== 'none' && targetSection.offsetHeight > 0) {
                        // Only remove inline display if section is properly visible
                        setTimeout(() => {
                            if (targetSection.offsetHeight > 0) {
                                targetSection.style.removeProperty('display');
                            }
                        }, 50);
                    }
                }, 100); // Give content 100ms to render before checking
                
                // Force another repaint
                requestAnimationFrame(() => {
                    targetSection.style.display = 'block';
                });
            });

            // CRITICAL: Ensure viewport and main content scroll to top immediately
            // This fixes the issue where content appears after scrolling down
            try {
                // Reset window scroll position first
                window.scrollTo({ top: 0, left: 0, behavior: 'instant' });
                
                // Reset main-content scroll if it's scrollable
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    if (typeof mainContent.scrollTo === 'function') {
                        mainContent.scrollTo({ top: 0, left: 0, behavior: 'instant' });
                    }
                    mainContent.scrollTop = 0; // Direct assignment as fallback
                }
                
                // Reset document body scroll
                if (document.body) {
                    document.body.scrollTop = 0;
                    document.documentElement.scrollTop = 0;
                }
                
                // Scroll section into view with 'start' alignment to ensure it's at top
                if (typeof targetSection.scrollIntoView === 'function') {
                    targetSection.scrollIntoView({ behavior: 'instant', block: 'start', inline: 'nearest' });
                }
                
                // Force immediate scroll reset using requestAnimationFrame
                requestAnimationFrame(() => {
                    window.scrollTo(0, 0);
                    if (mainContent) mainContent.scrollTop = 0;
                    document.body.scrollTop = 0;
                    document.documentElement.scrollTop = 0;
                });
            } catch (error) {
                console.error('Error resetting scroll position:', error);
            }
            
            // Set default dates to current date when section is shown
            setDefaultDates();
            
            // Handle reports section - show only active tab when coming from sidebar
            if (sectionId === 'reports') {
                // Use setTimeout to ensure DOM is fully ready
                setTimeout(() => {
                    // Check if we're coming from sidebar (has data-report attribute in URL or event)
                    const urlParams = new URLSearchParams(window.location.search);
                    const reportFromSidebar = urlParams.get('report');
                    
                    // Check localStorage for last selected report from sidebar
                    const lastReportFromSidebar = localStorage.getItem('lastReportFromSidebar');
                    
                    // Determine which tab to show - prioritize sidebar selection
                    const tabToShow = reportFromSidebar || lastReportFromSidebar;
                    
                    // If we have a specific report from sidebar (current or stored), show only that tab
                    if (tabToShow) {
                        // Hide all tabs except the active one
                        document.querySelectorAll('.report-tab').forEach(tab => {
                            tab.style.display = 'none';
                            tab.classList.remove('active');
                        });
                        // Show only the active tab
                        const activeTab = document.querySelector(`[data-tab="${tabToShow}"]`);
                        if (activeTab) {
                            activeTab.style.display = 'flex';
                            activeTab.classList.add('active');
                        }
                        // Ensure the correct tab content is active
                        document.querySelectorAll('.report-tab-content').forEach(content => {
                            content.classList.remove('active');
                        });
                        const targetTabContent = document.getElementById(`tab-${tabToShow}`);
                        if (targetTabContent) {
                            targetTabContent.classList.add('active');
                        }
                        const reportTabsNav = document.querySelector('.report-tabs');
                        if (reportTabsNav) {
                            reportTabsNav.style.display = 'flex'; // Show container but only with active tab
                        }
                    } else {
                        // No sidebar selection - user navigated directly to reports
                        // Show all tabs (default behavior)
                        const reportTabsNav = document.querySelector('.report-tabs');
                        if (reportTabsNav) {
                            document.querySelectorAll('.report-tab').forEach(tab => {
                                tab.style.display = 'flex';
                            });
                            reportTabsNav.style.display = 'flex';
                        }
                    }
                }, 50);
            }
            
            // Initialize section-specific content
            switch(sectionId) {
                case 'dashboard':
                    // Load departments for dashboard branch-wise report
                    populateCategorySelectors();
                    loadAllDepartmentsForBranchComparison();
                    // Load dashboard with selected month filter (or current month if not set)
                    const monthFilter = document.getElementById('dashboardMonthFilter');
                    const selectedMonth = monthFilter ? monthFilter.value : null;
                    loadDashboard(selectedMonth || null);
                    break;
                case 'categories':
                    loadCategories();
                    break;
                case 'suppliers':
                    loadSuppliers();
                    break;
                case 'sales':
                    generateCategoryInputs();
                    // Initialize button visibility based on active tab
                    setTimeout(initializeSalesEntryButtons, 150);
                    break;
                case 'departments':
                    loadDepartmentBranches();
                    // Load departments if branch filter is already set
                    const deptBranchFilter = document.getElementById('departmentBranchFilter');
                    if (deptBranchFilter && deptBranchFilter.value) {
                        loadDepartments(deptBranchFilter.value);
                    }
                    break;
                case 'payment-dashboard':
                    // Scroll to top before loading
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        updatePaymentDashboard();
                        populatePaymentModuleFilters();
                    }, 0);
                    break;
                case 'payment-vouchers':
                    // Scroll to top first
                    window.scrollTo(0, 0);
                    // Use setTimeout to ensure DOM is ready and force repaint
                    setTimeout(() => {
                        window.scrollTo(0, 0); // Ensure scroll is at top
                        initializePaymentVoucherForm();
                        populatePaymentVoucherDropdowns();
                        
                        // Force UI visibility check - ensure section AND all child elements are visible
                        const formSection = document.getElementById('payment-vouchers-section');
                        if (formSection) {
                            // Ensure section is visible
                            formSection.style.display = 'block';
                            formSection.style.visibility = 'visible';
                            formSection.style.opacity = '1';
                            formSection.classList.add('active');
                            
                            // Ensure all child elements are visible (card, form, inputs, etc.)
                            const card = formSection.querySelector('.card');
                            if (card) {
                                card.style.display = 'block';
                                card.style.visibility = 'visible';
                            }
                            
                            const cardBody = formSection.querySelector('.card-body');
                            if (cardBody) {
                                cardBody.style.display = 'block';
                                cardBody.style.visibility = 'visible';
                            }
                            
                            const form = formSection.querySelector('#paymentVoucherForm');
                            if (form) {
                                form.style.display = 'block';
                                form.style.visibility = 'visible';
                            }
                            
                            // Force browser to recalculate layout
                            void formSection.offsetHeight;
                            void (card?.offsetHeight);
                            
                            // Use requestAnimationFrame for smooth repaint
                            requestAnimationFrame(() => {
                                window.scrollTo(0, 0); // Final scroll reset
                                console.log(' Payment vouchers section should now be visible');
                                console.log(' Section dimensions:', {
                                    height: formSection.offsetHeight,
                                    width: formSection.offsetWidth,
                                    cardHeight: card?.offsetHeight,
                                    formHeight: form?.offsetHeight
                                });
                                
                                // Double-check visibility after repaint
                                if (formSection.offsetHeight === 0) {
                                    console.error(' Section still has zero height after repaint!');
                                    formSection.style.height = 'auto';
                                    formSection.style.minHeight = '500px';
                                }
                            });
                        } else {
                            console.error(' payment-vouchers-section element not found in DOM!');
                        }
                    }, 0);
                    break;
                case 'payment-voucher-list':
                    // Scroll to top before loading
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        // Populate filters
                        populatePaymentModuleFilters();
                        populateCategoryVoucherListTabFilters();
                        
                        // Set default dates and auto-load if dates are set
                        setDefaultDates();
                        const fromDate = document.getElementById('paymentVoucherListFromDate')?.value || '';
                        const toDate = document.getElementById('paymentVoucherListToDate')?.value || '';
                        if (fromDate || toDate) {
                            // Auto-load vouchers with default dates
                            loadPaymentVoucherList();
                        } else {
                            const tbody = document.querySelector('#payment-voucher-list-section table tbody');
                            if (tbody) {
                                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">Please select at least one date (From or To) to view voucher list</td></tr>';
                            }
                        }
                    }, 100);
                    break;
                case 'category-voucher-simple-list':
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        initializeCategoryVoucherSimpleList();
                    }, 0);
                    break;
                case 'category-voucher-list':
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        initializeCategoryVoucherList();
                    }, 0);
                    break;
                case 'payment-reports':
                    // Scroll to top before loading
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        initPaymentReportChart();
                        populatePaymentModuleFilters();
                        // Don't set default dates or auto-generate report
                        // User must select dates and click generate button
                    }, 0);
                    break;
                case 'reports':
                    // Scroll to top before loading
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                    // Reports section initialization if needed
                    }, 0);
                    break;
                case 'branches':
                    // Scroll to top before loading
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                    loadBranches();
                    }, 0);
                    break;
                case 'groups':
                    // Setup save button event listener
                    const saveGroupBtn = document.getElementById('saveGroupBtn');
                    if (saveGroupBtn) {
                        saveGroupBtn.onclick = saveGroup;
                    }
                    // Setup "Add New Group" button event listener
                    const addNewGroupBtn = document.getElementById('addNewGroupBtn');
                    if (addNewGroupBtn) {
                        addNewGroupBtn.onclick = function() {
                            resetGroupForm();
                            // Focus on the name input for better UX
                            const groupNameInput = document.getElementById('groupNameInput');
                            if (groupNameInput) {
                                setTimeout(() => groupNameInput.focus(), 100);
                            }
                        };
                    }
                    
                    // Reset form to "add mode" when section is first shown
                    resetGroupForm();
                    
                    // Setup permission category collapse/expand
                    setupPermissionCategories();
                    
                    // Scroll to top before loading
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        loadGroups();
                    }, 0);
                    break;
                case 'users':
                    // Scroll to top before loading
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                    loadUsers();
                    }, 0);
                    break;
                case 'employees':
                    // Scroll to top before loading
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        if (typeof loadEmployees === 'function') {
                            loadEmployees();
                        }
                        // Check employee list button permission after a delay
                        setTimeout(() => {
                            if (typeof checkEmployeeListPermission === 'function') {
                                checkEmployeeListPermission();
                            }
                        }, 300);
                    }, 0);
                    break;
                case 'employee-list':
                    // Scroll to top before loading
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        if (typeof initEmployeeListSection === 'function') {
                            initEmployeeListSection();
                        } else if (typeof loadEmployeeListPage === 'function') {
                            loadEmployeeListPage();
                        }
                    }, 0);
                    break;
                case 'settings':
                    // Scroll to top before loading
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                    loadSettings();
                    }, 0);
                    break;
            }
        }
        
        // Populate branch selectors
        function populateBranchSelectors() {
            const selectors = [
                'saleBranch',
                'reportBranch',
                'salesListBranch',
                'deptSalesListBranch',
                'editSaleBranch',
                'editDeptSaleBranch',
                'categoryBreakdownBranchFilter',
                // New report tab branch selectors
                'salesReportBranch',
                'comparisonReportBranch',
                'datewiseReportBranch',
                // Shop reporting selectors
                'shopReportBranch',
                // Department-wise and Sub-department-wise report selectors
                'deptWiseReportBranch',
                'subDeptWiseReportBranch',
                // Department-Wise and Branch-Wise Sale Comparison selectors
                'deptComparisonReportBranch',
                // Payment selectors
                'paymentBranch',
                'paymentBranchFilter',
                // Edit payment modal selector
                'editPaymentBranch',
                // Payment report selectors
                'reportBranchFilter',
                'paymentReportBranchFilter',
                'paymentReportBranch', // Standalone payment reports section
                // Employee selector
                'employeeBranch'
            ];
            
            // Get current user's assigned branches and normalize to strings
            const userBranches = appData.currentUser ? appData.currentUser.branches || [] : [];
            const userBranchIds = userBranches.map(b => {
                // Handle both ObjectId objects and string IDs
                if (typeof b === 'object' && b._id) {
                    return b._id.toString();
                }
                return b.toString();
            });
            
            selectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    // Keep the first option (All Branches or placeholder)
                    const firstOption = selector.options[0];
                    selector.innerHTML = '';
                    if (firstOption) {
                        selector.appendChild(firstOption);
                    }
                    
                    // Check if branches data is available
                    if (!appData.branches || !Array.isArray(appData.branches) || appData.branches.length === 0) {
                        console.warn(' Branches data not available for selector:', selectorId);
                        return; // Skip this selector if data is not available
                    }
                    
                    // Add branch options (only assigned branches for current user)
                    appData.branches.forEach(branch => {
                        // If user has specific branches assigned, only show those
                        if (userBranchIds.length > 0) {
                            const branchIdStr = branch._id.toString();
                            if (!userBranchIds.includes(branchIdStr)) {
                                return;
                            }
                        }
                        
                        const option = document.createElement('option');
                        option.value = branch._id;
                        option.textContent = branch.name;
                        selector.appendChild(option);
                    });
                    
                    // If user has only one branch, auto-select it for department sales list
                    if (userBranchIds.length === 1 && selectorId === 'deptSalesListBranch') {
                        const selectedBranchId = appData.branches.find(b => b._id.toString() === userBranchIds[0])?._id || '';
                        selector.value = selectedBranchId;
                        // Trigger change event to load departments
                        selector.dispatchEvent(new Event('change'));
                    }
                }
            });
        }
        
        // Populate category selectors
        function populateCategorySelectors() {
            const selectors = [
                'trendCategoryFilter',
                'editSaleCategory',
                'salesListCategory',
                // New report tab category selectors
                'salesReportCategory',
                'comparisonReportCategory',
                'datewiseReportCategory',
                // Payment selectors
                'paymentCategoryFilter',
                // Edit payment modal selector
                'editPaymentCategory',
                // Payment report selectors
                'reportCategoryFilter',
                'paymentReportCategoryFilter',
                // Branch-Wise Sale Comparison selector
                'branchComparisonReportCategory',
                // Dashboard Branch-Wise Report selector
                'dashboardBranchWiseReportCategory'
            ];
            
            selectors.forEach(function(selectorId){
                const selector = document.getElementById(selectorId);
                if (selector) {
                    const firstOption = selector.options[0];
                    selector.innerHTML = '';
                    if (firstOption) selector.appendChild(firstOption);
                    if (!appData.categories || !Array.isArray(appData.categories) || appData.categories.length === 0) return;
                    const sortedCategories = [...appData.categories].sort(function(a,b){
                        const aSeq = a.sequence; const bSeq = b.sequence;
                        const aHas = aSeq !== undefined && aSeq !== null;
                        const bHas = bSeq !== undefined && bSeq !== null;
                        if (aHas && bHas) return aSeq - bSeq;
                        if (aHas && !bHas) return -1;
                        if (!aHas && bHas) return 1;
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    });
                    sortedCategories.forEach(function(category){
                        const option = document.createElement('option');
                        option.value = category._id;
                        option.textContent = category.name;
                        selector.appendChild(option);
                    });
                }
            });
            
            // Populate category report filter dropdown with options
            const categoryReportOptions = document.getElementById('categoryReportOptions');
            const categoryReportFilterBtn = document.getElementById('categoryReportFilterBtn');
            const selectedCategoryIds = []; // Track selected categories
            
            if (categoryReportOptions) {
                categoryReportOptions.innerHTML = '';
                const sortedCategories = [...(appData.categories || [])].sort(function(a,b){
                    const aSeq = a.sequence; const bSeq = b.sequence;
                    const aHas = aSeq !== undefined && aSeq !== null;
                    const bHas = bSeq !== undefined && bSeq !== null;
                    if (aHas && bHas) return aSeq - bSeq;
                    if (aHas && !bHas) return -1;
                    if (!aHas && bHas) return 1;
                    return new Date(a.createdAt) - new Date(b.createdAt);
                });
                sortedCategories.forEach(function(category){
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<a class="dropdown-item" href="#" data-value="${category._id}">${category.name}</a>`;
                    categoryReportOptions.appendChild(listItem);
                });
                
                // Add click event listeners to all dropdown items
                document.querySelectorAll('#categoryReportDropdownMenu .dropdown-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const categoryId = this.getAttribute('data-value');
                        
                        // Update button text
                        categoryReportFilterBtn.textContent = this.textContent.trim();
                        
                        // Store selected category ID for filtering
                        selectedCategoryIds.length = 0;
                        if (categoryId) {
                            selectedCategoryIds.push(categoryId);
                        }
                        
                        // Update active state
                        document.querySelectorAll('#categoryReportDropdownMenu .dropdown-item').forEach(i => i.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
            }
        }
        
        // Initialize payment form (OLD - kept for backward compatibility)
        function initializePaymentForm() {
            // Check if element exists before setting value
            const paymentDateEl = document.getElementById('paymentDate');
            if (paymentDateEl) {
            const today = new Date().toISOString().split('T')[0];
                paymentDateEl.value = today;
            }
            
            // Only generate category boxes if function exists and container exists
            if (typeof generatePaymentCategoryBoxes === 'function') {
                const container = document.getElementById('paymentCategoryBoxes');
                if (container) {
            generatePaymentCategoryBoxes();
                }
            }
        }
        
        // Generate payment category boxes
        function generatePaymentCategoryBoxes() {
            const container = document.getElementById('paymentCategoryBoxes');
            container.innerHTML = '';
            
            const sortedCategoriesForBoxes = [...(appData.categories || [])].sort(function(a,b){
                const aSeq = a.sequence; const bSeq = b.sequence;
                const aHas = aSeq !== undefined && aSeq !== null;
                const bHas = bSeq !== undefined && bSeq !== null;
                if (aHas && bHas) return aSeq - bSeq;
                if (aHas && !bHas) return -1;
                if (!aHas && bHas) return 1;
                return new Date(a.createdAt) - new Date(b.createdAt);
            });
            sortedCategoriesForBoxes.forEach(category => {
                const box = document.createElement('div');
                box.className = 'col-md-4 payment-category-box';
                box.setAttribute('data-category', category._id);
                
                box.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">${category.name}</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control payment-amount" placeholder="Enter amount" min="0" step="0.01">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <input type="text" class="form-control payment-description" placeholder="Payment description">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Payment Method</label>
                                <select class="form-select payment-method">
                                    <option value="Cash">Cash</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Credit Card">Credit Card</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(box);
            });
        }
        
        // Populate group selectors
        function populateGroupSelectors() {
            const selectors = [
                'userGroup'
            ];
            
            selectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    // Keep the first option
                    const firstOption = selector.options[0];
                    selector.innerHTML = '';
                    if (firstOption) {
                        selector.appendChild(firstOption);
                    }
                    
                    // Add group options
                    appData.groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group._id;
                        option.textContent = group.name;
                        selector.appendChild(option);
                    });
                }
            });
        }
        
        // Populate group selector in user modal
        function populateGroupSelectorInUserModal() {
            const selector = document.getElementById('userGroup');
            if (selector) {
                // Keep the first option
                const firstOption = selector.options[0];
                selector.innerHTML = '';
                if (firstOption) {
                    selector.appendChild(firstOption);
                }
                
                // Add group options
                appData.groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group._id;
                    option.textContent = group.name;
                    selector.appendChild(option);
                });
            }
        }
        
        // Populate branch selector in user modal
        function populateBranchSelectorInUserModal() {
            const container = document.getElementById('userBranchesSelector');
            if (container) {
                container.innerHTML = '';
                
                // Add branch checkboxes
                appData.branches.forEach(branch => {
                    const branchItem = document.createElement('div');
                    branchItem.className = 'branch-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `branch-${branch._id}`;
                    checkbox.value = branch._id;
                    
                    const label = document.createElement('label');
                    label.htmlFor = `branch-${branch._id}`;
                    label.textContent = branch.name;
                    
                    branchItem.appendChild(checkbox);
                    branchItem.appendChild(label);
                    container.appendChild(branchItem);
                });
            }
        }
        
        // Generate category inputs for sales entry
        function generateCategoryInputs() {
            const container = document.getElementById('categoryInputs');
            if (!container) {
                console.error('categoryInputs container not found');
                return;
            }
            container.innerHTML = '';
            
            if (!appData.categories || appData.categories.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No categories available. Please add categories first.</div>';
                return;
            }
            
            appData.categories.forEach(category => {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'category-input-group';
                inputGroup.innerHTML = `
                    <label>${category.name}</label>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <div class="input-group">
                                <span class="input-group-text">Sales</span>
                                <input type="number" class="form-control category-sales" 
                                       data-category="${category._id}" min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                        <div class="col-md-6 mb-2">
                            <div class="input-group">
                                <span class="input-group-text">Cost</span>
                                <input type="number" class="form-control category-cost" 
                                       data-category="${category._id}" min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(inputGroup);
            });
            
            // Add event listeners for real-time calculation
            // Use setTimeout to ensure DOM is ready
            setTimeout(() => {
                container.querySelectorAll('.category-sales, .category-cost').forEach(input => {
                    // Remove any existing listeners first
                    const newInput = input.cloneNode(true);
                    input.parentNode.replaceChild(newInput, input);
                    // Add event listener
                    newInput.addEventListener('input', function() {
                        if (typeof calculateSalesTotals === 'function') {
                            calculateSalesTotals();
                        } else {
                            console.error('calculateSalesTotals function not found');
                        }
                    });
                    // Also add change event for better compatibility
                    newInput.addEventListener('change', function() {
                        if (typeof calculateSalesTotals === 'function') {
                            calculateSalesTotals();
                        }
                    });
                });
                
                // Initialize totals to 0
                if (typeof calculateSalesTotals === 'function') {
                    calculateSalesTotals();
                }
            }, 100);
        }
        
        // ========================================
        // DASHBOARD FUNCTIONS
        // ========================================
        
        // Load dashboard
        async function loadDashboard(selectedMonth = null, tabPrefix = 'warehouse') {
            try {
                // Check if user is authenticated before loading dashboard
                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.warn('No authentication token found. Cannot load dashboard.');
                    showLoginSection();
                    return;
                }
                
                // Ensure token is set in API service
                if (api && typeof api.setToken === 'function') {
                    api.setToken(token);
                }
                
                // Format dates as YYYY-MM-DD for API
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                // Check for date range filter (priority over month filter)
                const dateRangeFilter = document.getElementById(`${tabPrefix}DashboardDateRangeFilter`)?.value || 'currentMonth';
                const monthHiddenInput = document.getElementById(`${tabPrefix}DashboardMonthFilter`);
                const effectiveMonth = selectedMonth || monthHiddenInput?.value || '';

                // Persist selected month back to hidden input if provided
                if (monthHiddenInput && selectedMonth) {
                    monthHiddenInput.value = selectedMonth;
                }

                let referenceDate = new Date();
                if (effectiveMonth) {
                    const [refYear, refMonth] = effectiveMonth.split('-').map(Number);
                    if (!Number.isNaN(refYear) && !Number.isNaN(refMonth)) {
                        referenceDate = new Date(refYear, refMonth - 1, 1);
                    }
                }

                const monthStart = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), 1);
                monthStart.setHours(0, 0, 0, 0);
                const monthEnd = new Date(referenceDate.getFullYear(), referenceDate.getMonth() + 1, 0);
                monthEnd.setHours(23, 59, 59, 999);

                let dateFrom = null;
                let dateTo = null;

                // Special handling for shop dashboard: default to latest date with sales if no explicit filter is set
                if (tabPrefix === 'shop' && dateRangeFilter === 'currentMonth' && !effectiveMonth) {
                    // Shop dashboard default: Find and show the latest date where sales exist
                    try {
                        // First, fetch all department sales to find the latest date
                        const allDepartmentSales = await api.getDepartmentSales({});
                        
                        if (allDepartmentSales && allDepartmentSales.length > 0) {
                            // Find the latest date from all sales
                            let latestDate = null;
                            allDepartmentSales.forEach(sale => {
                                if (sale.date) {
                                    const saleDate = new Date(sale.date);
                                    if (!latestDate || saleDate > latestDate) {
                                        latestDate = saleDate;
                                    }
                                }
                            });
                            
                            if (latestDate) {
                                // Set the latest date as both from and to (single day)
                                latestDate.setHours(0, 0, 0, 0);
                                const latestDateEnd = new Date(latestDate);
                                latestDateEnd.setHours(23, 59, 59, 999);
                                dateFrom = formatDate(latestDate);
                                dateTo = formatDate(latestDateEnd);
                                
                                // Update the date input fields to show the latest date
                                const dateFromInput = document.getElementById('shopDashboardTopDateFrom');
                                const dateToInput = document.getElementById('shopDashboardTopDateTo');
                                if (dateFromInput) dateFromInput.value = dateFrom;
                                if (dateToInput) dateToInput.value = dateTo;
                            } else {
                                // Fallback: if no valid dates found, show yesterday
                                const yesterday = new Date();
                                yesterday.setDate(yesterday.getDate() - 1);
                                yesterday.setHours(0, 0, 0, 0);
                                const yesterdayEnd = new Date(yesterday);
                                yesterdayEnd.setHours(23, 59, 59, 999);
                                dateFrom = formatDate(yesterday);
                                dateTo = formatDate(yesterdayEnd);
                            }
                        } else {
                            // No sales found, show yesterday as fallback
                            const yesterday = new Date();
                            yesterday.setDate(yesterday.getDate() - 1);
                            yesterday.setHours(0, 0, 0, 0);
                            const yesterdayEnd = new Date(yesterday);
                            yesterdayEnd.setHours(23, 59, 59, 999);
                            dateFrom = formatDate(yesterday);
                            dateTo = formatDate(yesterdayEnd);
                        }
                    } catch (error) {
                        console.error('Error fetching latest sale date:', error);
                        // Fallback: show yesterday if error occurs
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        yesterday.setHours(0, 0, 0, 0);
                        const yesterdayEnd = new Date(yesterday);
                        yesterdayEnd.setHours(23, 59, 59, 999);
                        dateFrom = formatDate(yesterday);
                        dateTo = formatDate(yesterdayEnd);
                    }
                } else {
                    // Calculate date range based on filter (existing logic)
                    if (dateRangeFilter === 'custom') {
                        dateFrom = document.getElementById(`${tabPrefix}DashboardTopDateFrom`)?.value || null;
                        dateTo = document.getElementById(`${tabPrefix}DashboardTopDateTo`)?.value || null;
                    } else if (dateRangeFilter === 'weekly') {
                        // 1st Week of selected month (Days 1-7)
                        const weekStart = new Date(monthStart);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekEnd.getDate() + 6);
                        if (weekEnd > monthEnd) {
                            weekEnd.setTime(monthEnd.getTime());
                        }
                        dateFrom = formatDate(weekStart);
                        dateTo = formatDate(weekEnd);
                    } else if (dateRangeFilter === 'first15') {
                        // First 15 days of selected month
                        const firstDay = new Date(monthStart);
                        const fifteenthDay = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), 15);
                        fifteenthDay.setHours(23, 59, 59, 999);
                        dateFrom = formatDate(firstDay);
                        dateTo = formatDate(fifteenthDay > monthEnd ? monthEnd : fifteenthDay);
                    } else if (dateRangeFilter === 'last15') {
                        // Last 15 days of selected month (from 16th to end of month)
                        const sixteenthDay = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), 16);
                        sixteenthDay.setHours(0, 0, 0, 0);
                        const lastDay = new Date(monthEnd);
                        dateFrom = formatDate(sixteenthDay < monthStart ? monthStart : sixteenthDay);
                        dateTo = formatDate(lastDay);
                    } else {
                        // Entire selected month
                        dateFrom = formatDate(monthStart);
                        dateTo = formatDate(monthEnd);
                    }
                }
                
                // Build sales API filters
                const salesFilters = {};
                if (dateFrom) salesFilters.from = dateFrom;
                if (dateTo) salesFilters.to = dateTo;
                
                // Load data with date filter - use department sales for shop dashboard
                if (tabPrefix === 'shop') {
                    // Show loading indicator
                    const branchCardsContainer = document.getElementById(`${tabPrefix}BranchCardsContainer`);
                    if (branchCardsContainer) {
                        branchCardsContainer.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2 text-muted">Loading dashboard data...</p></div>';
                    }
                    
                    // Load all data in parallel (optimized: single sub-departments call instead of N calls)
                    const [departmentSales, branches, departments, subDepartments] = await Promise.all([
                        api.getDepartmentSales(salesFilters),
                        api.getBranches(),
                        api.getDepartments(),
                        api.getSubDepartments().catch(() => []) // Single call instead of N calls per department
                    ]);
                    
                    appData.departmentSales = departmentSales;
                    appData.branches = branches;
                    appData.departments = departments;
                    appData.subDepartments = subDepartments;
                    
                    const categoryBreakdownSelector = document.getElementById(`${tabPrefix}CategoryBreakdownBranchFilter`);
                    const categoryBreakdownFilter = categoryBreakdownSelector ? categoryBreakdownSelector.value : '';
                    
                    // Populate filters (these are synchronous DOM operations, fast)
                    populateCategoryBreakdownBranchFilter(tabPrefix);
                    populateMonthFilter(tabPrefix);
                    
                    // Update UI (these are synchronous DOM operations)
                    loadBranchCards(categoryBreakdownFilter, tabPrefix);
                    loadComparisonTables(tabPrefix);
                    initializeBranchChart(tabPrefix);
                    loadBranchWiseComparisonTable(tabPrefix);
                    // Load department-wise report grouped by branch
                    loadShopDashboardDeptWiseReport(departmentSales);
                } else {
                const [sales, branches, categories] = await Promise.all([
                    api.getSales(salesFilters),
                    api.getBranches(),
                    api.getCategories()
                ]);
                
                appData.sales = sales;
                appData.branches = branches;
                appData.categories = categories;
                
                const categoryBreakdownSelector = document.getElementById(`${tabPrefix}CategoryBreakdownBranchFilter`);
                const categoryBreakdownFilter = categoryBreakdownSelector ? categoryBreakdownSelector.value : '';
                
                // Populate category selectors for trend chart
                populateCategorySelectors();
                
                // Populate category breakdown branch filter
                populateCategoryBreakdownBranchFilter(tabPrefix);
                
                // Populate month filter dropdown
                populateMonthFilter(tabPrefix);
                
                loadBranchCards(categoryBreakdownFilter, tabPrefix);
                loadComparisonTables(tabPrefix);
                initializeTrendsChart(tabPrefix);
                
                    // Load payment details (only for warehouse dashboard)
                loadDashboardPaymentDetails(tabPrefix);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                
                // Check if it's an authentication error
                if (error.message && (
                    error.message.includes('Authentication failed') ||
                    error.message.includes('401') ||
                    error.message.includes('Unauthorized') ||
                    error.message.includes('Invalid token')
                )) {
                    console.warn('Authentication error in dashboard. Redirecting to login.');
                    // Clear invalid token
                    localStorage.removeItem('authToken');
                    if (api && typeof api.setToken === 'function') {
                        api.setToken(null);
                    }
                    showLoginSection();
                    showNotification('Your session has expired. Please login again.', 'error');
                } else {
                showNotification('Failed to load dashboard data', 'error');
                }
            }
        }
        
        // Load payment details for dashboard
        async function loadDashboardPaymentDetails(tabPrefix = 'warehouse') {
            try {
                const branchId = document.getElementById(`${tabPrefix}DashboardPaymentBranchFilter`)?.value || '';
                const categoryId = document.getElementById(`${tabPrefix}DashboardPaymentCategoryFilter`)?.value || '';
                const dateFilter = document.getElementById(`${tabPrefix}DashboardPaymentDateFilter`)?.value || 'currentMonth';
                
                // Populate filters if not already populated
                populateDashboardPaymentFilters(tabPrefix);
                
                const monthHiddenInput = document.getElementById(`${tabPrefix}DashboardMonthFilter`);
                const effectiveMonth = monthHiddenInput?.value || '';
                let referenceDate = new Date();
                if (effectiveMonth) {
                    const [refYear, refMonth] = effectiveMonth.split('-').map(Number);
                    if (!Number.isNaN(refYear) && !Number.isNaN(refMonth)) {
                        referenceDate = new Date(refYear, refMonth - 1, 1);
                    }
                }
                const monthStart = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), 1);
                monthStart.setHours(0, 0, 0, 0);
                const monthEnd = new Date(referenceDate.getFullYear(), referenceDate.getMonth() + 1, 0);
                monthEnd.setHours(23, 59, 59, 999);

                // Calculate date range based on filter
                let dateFrom = null;
                let dateTo = null;
                
                if (dateFilter === 'custom') {
                    dateFrom = document.getElementById(`${tabPrefix}DashboardPaymentDateFrom`)?.value || null;
                    dateTo = document.getElementById(`${tabPrefix}DashboardPaymentDateTo`)?.value || null;
                } else if (dateFilter === 'weekly') {
                    // 1st Week of selected month (Days 1-7)
                    const weekStart = new Date(monthStart);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    if (weekEnd > monthEnd) {
                        weekEnd.setTime(monthEnd.getTime());
                    }
                    dateFrom = formatDateForAPI(weekStart);
                    dateTo = formatDateForAPI(weekEnd);
                } else if (dateFilter === 'first15') {
                    // First 15 days of selected month
                    const firstDay = new Date(monthStart);
                    const fifteenthDay = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), 15);
                    fifteenthDay.setHours(23, 59, 59, 999);
                    dateFrom = formatDateForAPI(firstDay);
                    dateTo = formatDateForAPI(fifteenthDay > monthEnd ? monthEnd : fifteenthDay);
                } else if (dateFilter === 'last15') {
                    // Last 15 days of selected month (from 16th to end of month)
                    const sixteenthDay = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), 16);
                    sixteenthDay.setHours(0, 0, 0, 0);
                    const lastDay = new Date(monthEnd);
                    dateFrom = formatDateForAPI(sixteenthDay < monthStart ? monthStart : sixteenthDay);
                    dateTo = formatDateForAPI(lastDay);
                } else {
                    // Entire selected month
                    dateFrom = formatDateForAPI(monthStart);
                    dateTo = formatDateForAPI(monthEnd);
                }
                
                // Helper function to format date for API
                function formatDateForAPI(date) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                
                // Helper function to format date for display
                function formatDateForDisplay(date) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${day}/${month}/${year}`;
                }
                
                // Update subtitle with date range
                const subtitle = document.getElementById(`${tabPrefix}DashboardPaymentSubtitle`);
                if (subtitle) {
                    const monthLabel = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(referenceDate);
                    if (dateFilter === 'currentMonth') {
                        subtitle.textContent = `Current Month (${monthLabel})`;
                        subtitle.style.display = 'block';
                    } else if (dateFrom && dateTo) {
                        const fromDate = new Date(dateFrom + 'T00:00:00');
                        const toDate = new Date(dateTo + 'T00:00:00');
                        subtitle.textContent = `Date Range: ${formatDateForDisplay(fromDate)} to ${formatDateForDisplay(toDate)}`;
                        subtitle.style.display = 'block';
                    } else {
                        subtitle.style.display = 'none';
                    }
                }
                
                // Fetch sales and category payments from database
                const salesFilters = {};
                if (branchId) salesFilters.branchId = branchId;
                if (dateFrom) salesFilters.from = dateFrom;
                if (dateTo) salesFilters.to = dateTo;
                
                const paymentFilters = {};
                if (branchId) paymentFilters.branchId = branchId;
                if (categoryId) paymentFilters.categoryId = categoryId;
                if (dateFrom) paymentFilters.from = dateFrom;
                if (dateTo) paymentFilters.to = dateTo;
                
                const [salesData, paymentsData] = await Promise.all([
                    api.getSales(salesFilters),
                    api.getCategoryPayments(paymentFilters)
                ]);
                
                // Ensure we have arrays
                const salesArray = Array.isArray(salesData) ? salesData : [];
                const paymentsArray = Array.isArray(paymentsData) ? paymentsData : [];
                
                // Filter sales by category if specified
                let filteredSales = salesArray;
                if (categoryId) {
                    filteredSales = salesArray.filter(sale => {
                        const saleCategoryId = sale.categoryId?._id || sale.categoryId;
                        return saleCategoryId === categoryId;
                    });
                }
                
                // Calculate totals by branch and category
                const reportData = {};
                
                // Process sales data
                filteredSales.forEach(sale => {
                    const saleBranchId = sale.branchId?._id || sale.branchId;
                    const saleCategoryId = sale.categoryId?._id || sale.categoryId;
                    const saleBranchName = sale.branchId?.name || appData.branches.find(b => {
                        const bId = b._id?.toString() || b._id;
                        const sId = saleBranchId?.toString() || saleBranchId;
                        return bId === sId;
                    })?.name || 'Unknown';
                    const saleCategoryName = sale.categoryId?.name || appData.categories.find(c => {
                        const cId = c._id?.toString() || c._id;
                        const sId = saleCategoryId?.toString() || saleCategoryId;
                        return cId === sId;
                    })?.name || 'Unknown';
                    const key = `${saleBranchId}-${saleCategoryId}`;
                    if (!reportData[key]) {
                        reportData[key] = {
                            branch: saleBranchName,
                            category: saleCategoryName,
                            categoryId: saleCategoryId,
                            totalSales: 0,
                            totalCost: 0,
                            categoryPayments: 0,
                            balancePayment: 0
                        };
                    }
                    reportData[key].totalSales += parseFloat(sale.total || 0);
                    reportData[key].totalCost += parseFloat(sale.costTotal || sale.cost || 0);
                });
                
                // Process category payments data
                paymentsArray.forEach(payment => {
                    const branchId = payment.branchId?._id || payment.branchId;
                    const categoryId = payment.categoryId?._id || payment.categoryId;
                    const branchName = payment.branchId?.name || appData.branches.find(b => {
                        const bId = b._id?.toString() || b._id;
                        const pId = branchId?.toString() || branchId;
                        return bId === pId;
                    })?.name || 'Unknown';
                    const categoryName = payment.categoryId?.name || appData.categories.find(c => {
                        const cId = c._id?.toString() || c._id;
                        const pId = categoryId?.toString() || categoryId;
                        return cId === pId;
                    })?.name || 'Unknown';
                    
                    const key = `${branchId}-${categoryId}`;
                    if (!reportData[key]) {
                        reportData[key] = {
                            branch: branchName,
                            category: categoryName,
                            categoryId: categoryId,
                            totalSales: 0,
                            totalCost: 0,
                            categoryPayments: 0,
                            balancePayment: 0
                        };
                    }
                    reportData[key].categoryPayments += parseFloat(payment.amount || 0);
                });
                
                // Calculate balance payment for each entry
                Object.values(reportData).forEach(item => {
                    item.balancePayment = item.totalCost - item.categoryPayments;
                });
                
                // Calculate summary totals
                let summaryTotalSales = 0, summaryTotalCost = 0, summaryCategoryPayments = 0, summaryBalancePayment = 0;
                Object.values(reportData).forEach(item => {
                    summaryTotalSales += item.totalSales;
                    summaryTotalCost += item.totalCost;
                    summaryCategoryPayments += item.categoryPayments;
                    summaryBalancePayment += item.balancePayment;
                });
                
                // Update summary cards
                const totalSalesEl = document.getElementById(`${tabPrefix}DashboardPaymentTotalSales`);
                const totalCostEl = document.getElementById(`${tabPrefix}DashboardPaymentTotalCost`);
                const categoryPaymentsEl = document.getElementById(`${tabPrefix}DashboardPaymentCategoryPayments`);
                const balancePaymentEl = document.getElementById(`${tabPrefix}DashboardPaymentBalancePayment`);
                
                if (totalSalesEl) totalSalesEl.textContent = summaryTotalSales.toLocaleString();
                if (totalCostEl) totalCostEl.textContent = summaryTotalCost.toLocaleString();
                if (categoryPaymentsEl) categoryPaymentsEl.textContent = summaryCategoryPayments.toLocaleString();
                if (balancePaymentEl) balancePaymentEl.textContent = summaryBalancePayment.toLocaleString();
                
                // Update table container
                const tableContainer = document.getElementById(`${tabPrefix}DashboardPaymentTableContainer`);
                if (!tableContainer) return;
                
                tableContainer.innerHTML = '';
                
                if (Object.keys(reportData).length === 0) {
                    tableContainer.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <tbody>
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="fas fa-info-circle me-2"></i>
                                            No payment data found for the selected filters
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                    return;
                }
                
                // Group by category when all categories selected, by branch otherwise
                const shouldGroupByCategory = (categoryId === '');
                
                if (shouldGroupByCategory) {
                    // Group by Category - Create separate card and table for each category (same structure as Category & Branch Sales Comparison)
                    const categoryGroups = {};
                    Object.values(reportData).forEach(function(item){
                        const id = item.categoryId || item.category;
                        if (!categoryGroups[id]) categoryGroups[id] = [];
                        categoryGroups[id].push(item);
                    });
                    const categoriesWithData = Object.keys(categoryGroups).map(function(catId){
                        const categoryItems = categoryGroups[catId];
                        let categoryTotalSales = 0, categoryTotalCost = 0, categoryTotalPayments = 0, categoryTotalBalance = 0;
                        categoryItems.forEach(function(item){
                            categoryTotalSales += item.totalSales;
                            categoryTotalCost += item.totalCost;
                            categoryTotalPayments += item.categoryPayments;
                            categoryTotalBalance += item.balancePayment;
                        });
                        const catDoc = (appData.categories || []).find(function(c){
                            const cId = c._id?.toString() || c._id;
                            const pId = catId?.toString() || catId;
                            return cId === pId;
                        }) || null;
                        return {
                            id: catId,
                            name: catDoc?.name || (categoryItems[0]?.category || 'Unknown'),
                            sequence: catDoc?.sequence,
                            createdAt: catDoc?.createdAt,
                            items: categoryItems,
                            totals: { sales: categoryTotalSales, cost: categoryTotalCost, payments: categoryTotalPayments, balance: categoryTotalBalance }
                        };
                    });
                    const sortedCategoriesWithData = categoriesWithData.sort(function(a,b){
                        const aSeq = a.sequence; const bSeq = b.sequence;
                        const aHas = aSeq !== undefined && aSeq !== null;
                        const bHas = bSeq !== undefined && bSeq !== null;
                        if (aHas && bHas) return aSeq - bSeq;
                        if (aHas && !bHas) return -1;
                        if (!aHas && bHas) return 1;
                        const aDate = a.createdAt ? new Date(a.createdAt) : new Date(0);
                        const bDate = b.createdAt ? new Date(b.createdAt) : new Date(0);
                        return aDate - bDate;
                    });
                    sortedCategoriesWithData.forEach(function(categoryData, index){
                        const tableId = `paymentTable${index}`;
                        const tableBodyId = `paymentTableBody${index}`;
                        
                        // Create card HTML (same structure as Category & Branch Sales Comparison)
                        const cardHtml = `
                            <div class="card mb-4">
                                <div class="card-header bg-${getCategoryColor(index)} text-white">
                                    <h5 class="mb-0"><i class="${getIconForCategory(categoryData.name)} me-2"></i>${categoryData.name}</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover" id="${tableId}">
                                            <thead>
                                                <tr>
                                                    <th>Rank</th>
                                                    <th>Branch</th>
                                                    <th class="text-end">Sale</th>
                                                    <th class="text-end">Cost</th>
                                                    <th class="text-end">Category Payments</th>
                                                    <th class="text-end">Balance Payment</th>
                                                </tr>
                                            </thead>
                                            <tbody id="${tableBodyId}">
                                                <!-- Table rows will be populated dynamically -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        tableContainer.insertAdjacentHTML('beforeend', cardHtml);
                        
                        // Populate table body for this category
                        const categoryTableBody = document.getElementById(tableBodyId);
                        
                        // Sort branches by sales (descending) for ranking
                        const sortedItems = [...categoryData.items].sort((a, b) => b.totalSales - a.totalSales);
                        
                        sortedItems.forEach((item, itemIndex) => {
                            const rank = itemIndex + 1;
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="text-center"><strong>${rank}</strong></td>
                                <td>${item.branch}</td>
                                <td class="text-end">${item.totalSales.toLocaleString()}</td>
                                <td class="text-end">${item.totalCost.toLocaleString()}</td>
                                <td class="text-end">${item.categoryPayments.toLocaleString()}</td>
                                <td class="text-end ${item.balancePayment >= 0 ? 'text-success' : 'text-danger'}">
                                    ${item.balancePayment.toLocaleString()}
                                </td>
                            `;
                            categoryTableBody.appendChild(row);
                        });
                        
                        // Add grand total row at the end (same style as comparison tables)
                        const grandTotalRow = document.createElement('tr');
                        grandTotalRow.className = 'table-warning fw-bold';
                        grandTotalRow.innerHTML = `
                            <td class="text-center" colspan="2"><strong>Grand Total</strong></td>
                            <td class="text-end"><strong>${categoryData.totals.sales.toLocaleString()}</strong></td>
                            <td class="text-end"><strong>${Math.round(categoryData.totals.cost).toLocaleString()}</strong></td>
                            <td class="text-end"><strong>${categoryData.totals.payments.toLocaleString()}</strong></td>
                            <td class="text-end ${categoryData.totals.balance >= 0 ? 'text-success' : 'text-danger'}">
                                <strong>${Math.round(categoryData.totals.balance).toLocaleString()}</strong>
                            </td>
                        `;
                        categoryTableBody.appendChild(grandTotalRow);
                    });
                } else {
                    // Display simple table (not grouped by category) - single scrollable table
                    const tableHead = document.getElementById('dashboardPaymentTableHead');
                    if (tableHead) {
                        tableHead.style.display = 'table-header-group';
                    }
                    
                    tableContainer.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead id="dashboardPaymentTableHead" style="display: table-header-group;">
                                    <tr>
                                        <th style="text-align: left;">Category</th>
                                        <th style="text-align: left;">Branch</th>
                                        <th style="text-align: right;">Sale</th>
                                        <th style="text-align: right;">Cost</th>
                                        <th style="text-align: right;">Category Payments</th>
                                        <th style="text-align: right;">Balance Payment</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboardPaymentTableBody">
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    const tableBody = tableContainer.querySelector('#dashboardPaymentTableBody');
                    const branchGroups = {};
                    Object.values(reportData).forEach(item => {
                        if (!branchGroups[item.branch]) {
                            branchGroups[item.branch] = [];
                        }
                        branchGroups[item.branch].push(item);
                    });
                    
                    Object.keys(branchGroups).forEach(branchName => {
                        branchGroups[branchName].forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td style="text-align: left;">${item.category}</td>
                                <td style="text-align: left;">${item.branch}</td>
                                <td style="text-align: right;">${item.totalSales.toLocaleString()}</td>
                                <td style="text-align: right;">${item.totalCost.toLocaleString()}</td>
                                <td style="text-align: right;">${item.categoryPayments.toLocaleString()}</td>
                                <td style="text-align: right;">${item.balancePayment.toLocaleString()}</td>
                            `;
                            tableBody.appendChild(row);
                        });
                    });
                }
                
            } catch (error) {
                console.error('Error loading dashboard payment details:', error);
                const tableContainer = document.getElementById('dashboardPaymentTableContainer');
                if (tableContainer) {
                    tableContainer.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <tbody>
                                    <tr>
                                        <td colspan="6" class="text-center text-danger py-4">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Error loading payment data. Please try again.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            }
        }
        
        // Populate dashboard payment filters
        function populateDashboardPaymentFilters(tabPrefix = 'warehouse') {
            const branchFilter = document.getElementById(`${tabPrefix}DashboardPaymentBranchFilter`);
            const categoryFilter = document.getElementById(`${tabPrefix}DashboardPaymentCategoryFilter`);
            
            if (branchFilter && appData.branches) {
                // Keep "All Branches" option
                const currentValue = branchFilter.value;
                branchFilter.innerHTML = '<option value="">All Branches</option>';
                appData.branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch._id;
                    option.textContent = branch.name;
                    branchFilter.appendChild(option);
                });
                branchFilter.value = currentValue || '';
            }
            
            if (categoryFilter && appData.categories) {
                const currentValue = categoryFilter.value;
                categoryFilter.innerHTML = '<option value="">All Categories</option>';
                const sortedCategories = [...appData.categories].sort(function(a,b){
                    const aSeq = a.sequence; const bSeq = b.sequence;
                    const aHas = aSeq !== undefined && aSeq !== null;
                    const bHas = bSeq !== undefined && bSeq !== null;
                    if (aHas && bHas) return aSeq - bSeq;
                    if (aHas && !bHas) return -1;
                    if (!aHas && bHas) return 1;
                    return new Date(a.createdAt) - new Date(b.createdAt);
                });
                sortedCategories.forEach(function(category){
                    const option = document.createElement('option');
                    option.value = category._id;
                    option.textContent = category.name;
                    categoryFilter.appendChild(option);
                });
                categoryFilter.value = currentValue || '';
            }
        }
        
        // Load branch cards with expandable category/details
        function loadBranchCards(branchFilter = '', tabPrefix = 'warehouse') {
            const container = document.getElementById(`${tabPrefix}BranchCardsContainer`);
            container.innerHTML = '';
            
            // Filter branches if a specific branch is selected
            let branchesToDisplay = appData.branches;
            if (branchFilter) {
                branchesToDisplay = branchesToDisplay.filter(branch => branch._id === branchFilter);
            }
            
            // For shop dashboard, calculate net sale for each branch and sort according to user preference
            if (tabPrefix === 'shop') {
                // Get sort preference from hidden input
                const sortBySaleInput = document.getElementById('shopDashboardSortBySale');
                const sortOption = sortBySaleInput?.value || 'net-sale-desc';
                
                const branchesWithSales = branchesToDisplay.map(branch => {
                    const branchSales = (appData.departmentSales || []).filter(sale => {
                        const saleBranchId = (sale && sale.branchId && sale.branchId._id) ? sale.branchId._id : sale.branchId;
                        return saleBranchId === branch._id;
                    });
                    
                    const totalGrossSale = branchSales.reduce((sum, sale) => sum + (sale.grossSale || 0), 0);
                    const totalDiscountAmount = branchSales.reduce((sum, sale) => sum + (sale.discountAmount || 0), 0);
                    const totalReturn = branchSales.reduce((sum, sale) => sum + (sale.returnAmount || 0), 0);
                    const totalSaleValue = totalGrossSale - totalDiscountAmount - totalReturn;
                    const totalGST = branchSales.reduce((sum, sale) => sum + (sale.gst || 0), 0);
                    const totalNetSale = totalSaleValue + totalGST;
                    
                    return { branch, totalNetSale, totalGrossSale };
                });
                
                // Sort branches based on selected option
                if (sortOption !== 'none') {
                    if (sortOption === 'net-sale-desc') {
                        // Sort by net sale (descending - highest first)
                        branchesWithSales.sort((a, b) => b.totalNetSale - a.totalNetSale);
                    } else if (sortOption === 'net-sale-asc') {
                        // Sort by net sale (ascending - lowest first)
                        branchesWithSales.sort((a, b) => a.totalNetSale - b.totalNetSale);
                    } else if (sortOption === 'gross-sale-desc') {
                        // Sort by gross sale (descending - highest first)
                        branchesWithSales.sort((a, b) => b.totalGrossSale - a.totalGrossSale);
                    } else if (sortOption === 'gross-sale-asc') {
                        // Sort by gross sale (ascending - lowest first)
                        branchesWithSales.sort((a, b) => a.totalGrossSale - b.totalGrossSale);
                    }
                    branchesToDisplay = branchesWithSales.map(item => item.branch);
                } else {
                    // No sort - keep original order
                    branchesToDisplay = branchesWithSales.map(item => item.branch);
                }
            } else if (tabPrefix === 'warehouse') {
                // For warehouse dashboard, sort branches by total sales (descending - highest first)
                const branchesWithSales = branchesToDisplay.map(branch => {
                    const branchSales = (appData.sales || []).filter(sale => {
                        const saleBranchId = (sale && sale.branchId && sale.branchId._id) ? sale.branchId._id : sale.branchId;
                        return saleBranchId === branch._id;
                    });
                    
                    const totalSales = branchSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                    
                    return { branch, totalSales };
                });
                
                // Sort branches by total sales (descending - highest first)
                branchesWithSales.sort((a, b) => b.totalSales - a.totalSales);
                branchesToDisplay = branchesWithSales.map(item => item.branch);
            }
            
            branchesToDisplay.forEach(branch => {
                if (tabPrefix === 'shop') {
                    // Shop Dashboard: Use department sales
                    const branchSales = (appData.departmentSales || []).filter(sale => {
                        const saleBranchId = (sale && sale.branchId && sale.branchId._id) ? sale.branchId._id : sale.branchId;
                        return saleBranchId === branch._id;
                    });
                    
                    // Calculate shop sale entry fields for branch totals
                    const totalGrossSale = branchSales.reduce((sum, sale) => sum + (sale.grossSale || 0), 0);
                    const totalDiscountAmount = branchSales.reduce((sum, sale) => sum + (sale.discountAmount || 0), 0);
                    // New formula: Discount % = (Discount Value / Gross Sale) * 100
                    const totalDiscountPercent = totalGrossSale > 0 ? (totalDiscountAmount / totalGrossSale * 100) : 0;
                    const totalReturn = branchSales.reduce((sum, sale) => sum + (sale.returnAmount || 0), 0);
                    // New formula: Sale Value = Gross Sale - Discount - Return
                    const totalSaleValue = totalGrossSale - totalDiscountAmount - totalReturn;
                    const totalGST = branchSales.reduce((sum, sale) => sum + (sale.gst || 0), 0);
                    // New formula: Net Sale = Sale Value + GST
                    const totalNetSale = totalSaleValue + totalGST;
                    
                    // Calculate department-wise breakdown with sub-departments
                    const departmentData = {};
                    (appData.departments || []).forEach(department => {
                        const departmentSales = branchSales.filter(sale => {
                            const saleDepartmentId = (sale && sale.departmentId && sale.departmentId._id) ? sale.departmentId._id : sale.departmentId;
                            return saleDepartmentId === department._id;
                        });
                        
                        // Calculate department totals using shop sale entry fields
                        const deptGrossSale = departmentSales.reduce((sum, sale) => sum + (sale.grossSale || 0), 0);
                        const deptDiscountAmount = departmentSales.reduce((sum, sale) => sum + (sale.discountAmount || 0), 0);
                        // New formula: Discount % = (Discount Value / Gross Sale) * 100
                        const deptDiscountPercent = deptGrossSale > 0 ? (deptDiscountAmount / deptGrossSale * 100) : 0;
                        const deptReturn = departmentSales.reduce((sum, sale) => sum + (sale.returnAmount || 0), 0);
                        // New formula: Sale Value = Gross Sale - Discount - Return
                        const deptSaleValue = deptGrossSale - deptDiscountAmount - deptReturn;
                        const deptGST = departmentSales.reduce((sum, sale) => sum + (sale.gst || 0), 0);
                        // New formula: Net Sale = Sale Value + GST
                        const deptNetSale = deptSaleValue + deptGST;
                        
                        // Calculate sub-department breakdown - only for sub-departments belonging to this department
                        const subDepartmentData = {};
                        // Filter sub-departments that belong to this department
                        const departmentSubDepts = (appData.subDepartments || []).filter(subDept => {
                            const subDeptDepartmentId = (subDept && subDept.departmentId && subDept.departmentId._id) ? subDept.departmentId._id : subDept.departmentId;
                            return subDeptDepartmentId === department._id;
                        });
                        
                        console.log(`Department: ${department.name}, Found ${departmentSubDepts.length} sub-departments for this department`);
                        
                        departmentSubDepts.forEach(subDept => {
                            const subDeptSales = departmentSales.filter(sale => {
                                const saleSubDeptId = (sale && sale.subDepartmentId && sale.subDepartmentId._id) ? sale.subDepartmentId._id : sale.subDepartmentId;
                                return saleSubDeptId === subDept._id;
                            });
                            
                            console.log(`Sub-Dept: ${subDept.name}, Sales count: ${subDeptSales.length}`);
                            
                            if (subDeptSales.length > 0) {
                                const subGrossSale = subDeptSales.reduce((sum, sale) => sum + (sale.grossSale || 0), 0);
                                const subDiscountAmount = subDeptSales.reduce((sum, sale) => sum + (sale.discountAmount || 0), 0);
                                // New formula: Discount % = (Discount Value / Gross Sale) * 100
                                const subDiscountPercent = subGrossSale > 0 ? (subDiscountAmount / subGrossSale * 100) : 0;
                                const subReturn = subDeptSales.reduce((sum, sale) => sum + (sale.returnAmount || 0), 0);
                                // New formula: Sale Value = Gross Sale - Discount - Return
                                const subSaleValue = subGrossSale - subDiscountAmount - subReturn;
                                const subGST = subDeptSales.reduce((sum, sale) => sum + (sale.gst || 0), 0);
                                // New formula: Net Sale = Sale Value + GST
                                const subNetSale = subSaleValue + subGST;
                                
                                subDepartmentData[subDept._id] = {
                                    name: subDept.name,
                                    grossSale: subGrossSale,
                                    discountPercent: subDiscountPercent,
                                    saleValue: subSaleValue,
                                    returnAmount: subReturn,
                                    gst: subGST,
                                    netSale: subNetSale
                                };
                                
                                console.log(`Added sub-dept: ${subDept.name}, Net Sale: ${subNetSale}`);
                            }
                        });
                        
                        // Include department if it has sales OR has sub-departments with sales
                        if (deptNetSale > 0 || Object.keys(subDepartmentData).length > 0) {
                            departmentData[department._id] = {
                                name: department.name,
                                grossSale: deptGrossSale,
                                discountAmount: deptDiscountAmount,
                                discountPercent: deptDiscountPercent,
                                saleValue: deptSaleValue,
                                returnAmount: deptReturn,
                                gst: deptGST,
                                netSale: deptNetSale,
                                subDepartments: subDepartmentData
                            };
                            
                            console.log(`Added department: ${department.name} with ${Object.keys(subDepartmentData).length} sub-departments`);
                        }
                    });
                    
                    // Create branch card HTML for shop dashboard
                    const departmentCount = Object.keys(departmentData).length;
                    const branchCard = `
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card h-100 shadow-sm" style="border-radius: 12px; overflow: hidden; transition: all 0.3s ease; border: 1px solid #e9ecef;">
                                <div class="card-header text-white text-center" style="background: linear-gradient(135deg, #2c6e8a 0%, #4fb3d9 100%); padding: 14px 20px; border-bottom: none; overflow: hidden;">
                                    <h5 class="card-title mb-0" style="font-weight: 700; font-size: 1.1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.1); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%;">
                                        ${branch.name}
                                    </h5>
                                </div>
                                <div class="card-body" style="padding: 20px;">
                                    <!-- Branch KPIs - Shop Sale Entry Fields -->
                                    <div class="mb-4 branch-main-kpis">
                                        <div class="branch-kpi-item">
                                            <div class="branch-kpi-label kpi-gross-sale-label">
                                                <i class="fas fa-shopping-cart me-2"></i>GROSS SALE
                                            </div>
                                            <div class="branch-kpi-value kpi-gross-sale-value">
                                                ${totalGrossSale.toLocaleString()}
                                            </div>
                                        </div>
                                        <div class="branch-kpi-item">
                                            <div class="branch-kpi-label kpi-discount-value-label">
                                                <i class="fas fa-tag me-2"></i>DISCOUNT VALUE
                                            </div>
                                            <div class="branch-kpi-value kpi-discount-value-value">
                                                ${totalDiscountAmount.toLocaleString()}
                                            </div>
                                        </div>
                                        <div class="branch-kpi-item">
                                            <div class="branch-kpi-label kpi-discount-label">
                                                <i class="fas fa-percent me-2"></i>DISCOUNT %
                                            </div>
                                            <div class="branch-kpi-value kpi-discount-value">
                                                ${totalDiscountPercent.toFixed(2)}%
                                            </div>
                                        </div>
                                        <div class="branch-kpi-item">
                                            <div class="branch-kpi-label kpi-return-label">
                                                <i class="fas fa-undo me-2"></i>RETURN
                                            </div>
                                            <div class="branch-kpi-value kpi-return-value">
                                                ${totalReturn.toLocaleString()}
                                            </div>
                                        </div>
                                        <div class="branch-kpi-item">
                                            <div class="branch-kpi-label kpi-sale-value-label">
                                                <i class="fas fa-money-bill-wave me-2"></i>SALE VALUE
                                            </div>
                                            <div class="branch-kpi-value kpi-sale-value-value">
                                                ${totalSaleValue.toLocaleString()}
                                            </div>
                                        </div>
                                        <div class="branch-kpi-item">
                                            <div class="branch-kpi-label kpi-gst-label">
                                                <i class="fas fa-receipt me-2"></i>GST
                                            </div>
                                            <div class="branch-kpi-value kpi-gst-value">
                                                ${totalGST.toLocaleString()}
                                            </div>
                                        </div>
                                        <div class="branch-kpi-item">
                                            <div class="branch-kpi-label kpi-net-sale-label">
                                                <i class="fas fa-chart-line me-2"></i>NET SALE
                                            </div>
                                            <div class="branch-kpi-value kpi-net-sale-value">
                                                <strong>${totalNetSale.toLocaleString()}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Department Breakdown (Hidden) -->
                                    <div class="mt-3" id="categoryDetails-${branch._id}" style="display: none;">
                                        <div class="row g-3">
                                            ${Object.entries(departmentData)
                                                .map(([deptId, dept]) => ({ deptId, dept }))
                                                .sort((a, b) => (b.dept.netSale || 0) - (a.dept.netSale || 0))
                                                .map(({ deptId, dept }, index) => {
                                                const txnCount = branchSales.filter(sale => {
                                                    const saleDepartmentId = (sale && sale.departmentId && sale.departmentId._id) ? sale.departmentId._id : sale.departmentId;
                                                    return saleDepartmentId === deptId;
                                                }).length;
                                                const subDeptCount = Object.keys(dept.subDepartments || {}).length;
                                                console.log(`Rendering Department: ${dept.name}, Sub-departments count: ${subDeptCount}`, dept.subDepartments);
                                                return `
                                                <div class="col-12">
                                                    <div class="card" style="border: 1px solid #dee2e6; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                                        <div class="card-header text-white" style="background: linear-gradient(135deg, #2c6e8a 0%, #4fb3d9 100%); padding: 12px 20px; position: relative;">
                                                            <h6 class="mb-0 text-center" style="font-weight: 700; font-size: 0.95rem; padding: 0 60px 0 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: calc(100% - 70px); text-align: left; display: block; box-sizing: border-box;">${dept.name}</h6>
                                                            <span class="badge position-absolute" style="background-color: rgba(255,255,255,0.2); border-radius: 15px; padding: 5px 12px; font-size: 0.75rem; top: 50%; right: 10px; transform: translateY(-50%); font-weight: 600; z-index: 1; flex-shrink: 0;">${txnCount} txns</span>
                                                        </div>
                                                        <div class="card-body" style="padding: 20px; background-color: #ffffff;">
                                                            <!-- Department Summary -->
                                                        <div class="row g-2 mb-3">
                                                                <div class="col-12 col-sm-6 col-md-3">
                                                                    <div class="branch-kpi-item">
                                                                        <div class="branch-kpi-label kpi-sales-label">
                                                                            GROSS SALE
                                                                        </div>
                                                                        <div class="branch-kpi-value kpi-sales-value">
                                                                            ${(dept.grossSale || 0).toLocaleString()}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-12 col-sm-6 col-md-3">
                                                                    <div class="branch-kpi-item">
                                                                        <div class="branch-kpi-label">
                                                                            DISCOUNT VALUE
                                                                        </div>
                                                                        <div class="branch-kpi-value">
                                                                            ${(dept.discountAmount || 0).toLocaleString()}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-12 col-sm-6 col-md-3">
                                                                    <div class="branch-kpi-item">
                                                                        <div class="branch-kpi-label kpi-cost-label">
                                                                            DISCOUNT %
                                                                        </div>
                                                                        <div class="branch-kpi-value kpi-cost-value">
                                                                            ${(dept.discountPercent || 0).toFixed(2)}%
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-12 col-sm-6 col-md-3">
                                                                    <div class="branch-kpi-item">
                                                                        <div class="branch-kpi-label kpi-margin-label">
                                                                            NET SALE
                                                                        </div>
                                                                        <div class="branch-kpi-value kpi-margin-value text-success">
                                                                            <strong>${(dept.netSale || 0).toLocaleString()}</strong>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-12 col-sm-6 col-md-3">
                                                                    <div class="branch-kpi-item">
                                                                        <div class="branch-kpi-label">
                                                                            RETURN
                                                                        </div>
                                                                        <div class="branch-kpi-value">
                                                                            ${(dept.returnAmount || 0).toLocaleString()}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-12 col-sm-6 col-md-3">
                                                                    <div class="branch-kpi-item">
                                                                        <div class="branch-kpi-label kpi-profit-label">
                                                                            SALE VALUE
                                                                        </div>
                                                                        <div class="branch-kpi-value kpi-profit-value">
                                                                            ${(dept.saleValue || 0).toLocaleString()}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-12 col-sm-6 col-md-3">
                                                                    <div class="branch-kpi-item">
                                                                        <div class="branch-kpi-label">
                                                                            GST
                                                                        </div>
                                                                        <div class="branch-kpi-value">
                                                                            ${(dept.gst || 0).toLocaleString()}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            ${subDeptCount > 0 ? `
                                                            <!-- Sub-Department Breakdown - Only Name and Net Sale -->
                                                            <div class="border-top pt-3 mt-3">
                                                                <h6 class="mb-2" style="font-size: 0.85rem; color: #6c757d;">
                                                                    <i class="fas fa-layer-group me-2"></i>Sub-Departments (${subDeptCount})
                                                                </h6>
                                                                <div class="row g-2">
                                                                    ${Object.entries(dept.subDepartments || {})
                                                                        .map(([subDeptId, subDept]) => ({ subDeptId, subDept }))
                                                                        .sort((a, b) => (b.subDept.netSale || 0) - (a.subDept.netSale || 0))
                                                                        .map(({ subDeptId, subDept }) => {
                                                                        console.log(`Rendering sub-dept: ${subDept.name}, Net Sale: ${subDept.netSale}`);
                                                                        return `
                                                                        <div class="col-12">
                                                                            <div class="card" style="border: 1px solid #e9ecef; border-radius: 8px; background-color: #f8f9fa;">
                                                                                <div class="card-body p-2">
                                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                                        <strong style="font-size: 0.85rem;">${subDept.name || 'Unknown'}</strong>
                                                                                        <span class="badge bg-success" style="font-size: 0.85rem; padding: 5px 10px;">
                                                                                            Net Sale: ${(subDept.netSale || 0).toLocaleString()}
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    `;
                                                                    }).join('')}
                                                                </div>
                                                            </div>
                                                            ` : '<div class="text-muted text-center py-2" style="font-size: 0.85rem;">No sub-departments found</div>'}
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                            }).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.insertAdjacentHTML('beforeend', branchCard);
                } else {
                    // Warehouse Dashboard: Use regular sales
                // Calculate branch totals
                    const branchSales = (appData.sales || []).filter(sale => {
                    const saleBranchId = (sale && sale.branchId && sale.branchId._id) ? sale.branchId._id : sale.branchId;
                    return saleBranchId === branch._id;
                });
                
                const totalSales = branchSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                const totalCost = branchSales.reduce((sum, sale) => sum + (sale.costTotal || 0), 0);
                const totalProfit = totalSales - totalCost;
                const profitMargin = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;
                
                // Calculate category-wise breakdown
                const categoryData = {};
                    (appData.categories || []).forEach(category => {
                    const categorySales = branchSales.filter(sale => {
                        const saleCategoryId = (sale && sale.categoryId && sale.categoryId._id) ? sale.categoryId._id : sale.categoryId;
                        return saleCategoryId === category._id;
                    });
                    const catSales = categorySales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                    const catCost = categorySales.reduce((sum, sale) => sum + (sale.costTotal || 0), 0);
                    const catProfit = catSales - catCost;
                    const catMargin = catSales > 0 ? (catProfit / catSales * 100) : 0;
                    
                    if (catSales > 0) {
                        categoryData[category._id] = {
                            name: category.name,
                            totalSales: catSales,
                            totalCost: catCost,
                            totalProfit: catProfit,
                            profitMargin: catMargin
                        };
                    }
                });
                
                // Create branch card HTML
                const categoryCount = Object.keys(categoryData).length;
                const branchCard = `
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card h-100 shadow-sm" style="border-radius: 12px; overflow: hidden; transition: all 0.3s ease; border: 1px solid #e9ecef;">
                            <div class="card-header text-white text-center" style="background: linear-gradient(135deg, #2c6e8a 0%, #4fb3d9 100%); padding: 14px 20px; border-bottom: none; overflow: hidden;">
                                <h5 class="card-title mb-0" style="font-weight: 700; font-size: 1.1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.1); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%;">
                                    ${branch.name}
                                </h5>
                            </div>
                            <div class="card-body" style="padding: 20px;">
                                <!-- Branch KPIs - Beautiful Professional Design with Colored Backgrounds -->
                                <div class="mb-4 branch-main-kpis">
                                    <div class="branch-kpi-item">
                                        <div class="branch-kpi-label kpi-sales-label">
                                            <i class="fas fa-shopping-cart me-2"></i>TOTAL SALES
                                            </div>
                                        <div class="branch-kpi-value kpi-sales-value">
                                            ${totalSales.toLocaleString()}
                                        </div>
                                    </div>
                                    <div class="branch-kpi-item">
                                        <div class="branch-kpi-label kpi-cost-label">
                                            <i class="fas fa-money-bill-wave me-2"></i>TOTAL COST
                                            </div>
                                        <div class="branch-kpi-value kpi-cost-value">
                                            ${totalCost.toLocaleString()}
                                        </div>
                                    </div>
                                    <div class="branch-kpi-item">
                                        <div class="branch-kpi-label kpi-profit-label">
                                            <i class="fas fa-chart-line me-2"></i>TOTAL PROFIT
                                            </div>
                                        <div class="branch-kpi-value kpi-profit-value">
                                            ${totalProfit.toLocaleString()}
                                        </div>
                                    </div>
                                    <div class="branch-kpi-item">
                                        <div class="branch-kpi-label kpi-margin-label">
                                            <i class="fas fa-percentage me-2"></i>MARGIN
                                            </div>
                                        <div class="branch-kpi-value kpi-margin-value">
                                            ${profitMargin.toFixed(1)}%
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Category Details Toggle Button -->
                                <button class="btn w-100 toggle-category-details" data-branch-id="${branch._id}" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; color: #495057; font-weight: 600; transition: all 0.3s ease;">
                                    <i class="fas fa-chevron-down me-2"></i>Category Details
                                </button>
                                
                                <!-- Category Breakdown (Collapsed by default) -->
                                <div class="collapse mt-3" id="categoryDetails-${branch._id}">
                                    <div class="row g-3">
                                        ${Object.entries(categoryData).map(([catId, cat], index) => {
                                            const txnCount = branchSales.filter(sale => {
                                                const saleCategoryId = (sale && sale.categoryId && sale.categoryId._id) ? sale.categoryId._id : sale.categoryId;
                                                return saleCategoryId === catId;
                                            }).length;
                                            return `
                                            <div class="col-12">
                                                <div class="card" style="border: 1px solid #dee2e6; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                                    <div class="card-header text-white" style="background: linear-gradient(135deg, #2c6e8a 0%, #4fb3d9 100%); padding: 12px 20px; position: relative;">
                                                        <h6 class="mb-0 text-center" style="font-weight: 700; font-size: 0.95rem; padding: 0 60px 0 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: calc(100% - 70px); text-align: left; display: block; box-sizing: border-box;">${cat.name}</h6>
                                                        <span class="badge position-absolute" style="background-color: rgba(255,255,255,0.2); border-radius: 15px; padding: 5px 12px; font-size: 0.75rem; top: 50%; right: 10px; transform: translateY(-50%); font-weight: 600; z-index: 1; flex-shrink: 0;">${txnCount} txns</span>
                                                    </div>
                                                    <div class="card-body" style="padding: 20px; background-color: #ffffff;">
                                                        <div class="row g-2">
                                                            <div class="col-12 col-sm-6">
                                                                <div class="branch-kpi-item">
                                                                    <div class="branch-kpi-label kpi-sales-label">
                                                                        SALES
                                                                    </div>
                                                                    <div class="branch-kpi-value kpi-sales-value">
                                                                        ${cat.totalSales.toLocaleString()}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-12 col-sm-6">
                                                                <div class="branch-kpi-item">
                                                                    <div class="branch-kpi-label kpi-cost-label">
                                                                        COST
                                                                    </div>
                                                                    <div class="branch-kpi-value kpi-cost-value">
                                                                        ${cat.totalCost.toLocaleString()}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-12 col-sm-6">
                                                                <div class="branch-kpi-item">
                                                                    <div class="branch-kpi-label kpi-profit-label">
                                                                        PROFIT
                                                                    </div>
                                                                    <div class="branch-kpi-value kpi-profit-value">
                                                                        ${cat.totalProfit.toLocaleString()}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-12 col-sm-6">
                                                                <div class="branch-kpi-item">
                                                                    <div class="branch-kpi-label kpi-margin-label">
                                                                        MARGIN
                                                                    </div>
                                                                    <div class="branch-kpi-value kpi-margin-value">
                                                                        ${cat.profitMargin.toFixed(1)}%
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', branchCard);
                }
            });
            
            // Add toggle functionality to category/details buttons AFTER HTML is inserted
            setTimeout(() => {
            const toggleButtons = container.querySelectorAll('.toggle-category-details');
                console.log(`Found ${toggleButtons.length} toggle buttons for ${tabPrefix} dashboard`);
                
            toggleButtons.forEach(button => {
                    const branchId = button.getAttribute('data-branch-id');
                    const detailsDiv = document.getElementById(`categoryDetails-${branchId}`);
                    
                    if (!detailsDiv) {
                        console.warn(`Details div not found for branch: ${branchId}`);
                        return;
                    }
                    
                    // Remove any existing event listeners
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    
                    newButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                    const icon = this.querySelector('i');
                        const targetDiv = document.getElementById(`categoryDetails-${branchId}`);
                        
                        if (!targetDiv) {
                            console.error(`Target div not found: categoryDetails-${branchId}`);
                            return;
                        }
                        
                        console.log(`Toggling department details for branch: ${branchId}`);
                        console.log(`Target div classes:`, targetDiv.className);
                        console.log(`Target div is visible:`, targetDiv.classList.contains('show'));
                        
                        // Use manual toggle for reliability
                        const isCurrentlyVisible = targetDiv.classList.contains('show') || 
                                                   targetDiv.style.display === 'block' || 
                                                   window.getComputedStyle(targetDiv).display !== 'none';
                        
                        console.log(`Current visibility state:`, isCurrentlyVisible);
                        
                        if (isCurrentlyVisible) {
                            // Collapse
                            targetDiv.classList.remove('show');
                            targetDiv.style.display = 'none';
                            targetDiv.style.overflow = 'hidden';
                            if (icon) {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                            }
                            console.log(`Collapsed department details for branch: ${branchId}`);
                    } else {
                            // Expand
                            targetDiv.classList.add('show');
                            targetDiv.style.display = 'block';
                            targetDiv.style.overflow = 'visible';
                            if (icon) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                            }
                            console.log(`Expanded department details for branch: ${branchId}`);
                    }
                });
            });
            }, 100);

            setTimeout(() => {
                if (typeof window.applyKpiLayoutForAll === 'function') {
                    window.applyKpiLayoutForAll();
                }
            }, 0);
        }
        
        // Load category breakdown - Updated
        function loadCategoryBreakdown(branchFilter = '') {
            const container = document.getElementById('categoryBreakdown');
            container.innerHTML = '';
            
            // Filter data by branch if selected
            let filteredData = appData.sales;
            if (branchFilter) {
                filteredData = appData.sales.filter(sale => {
                    const saleBranchId = (sale && sale.branchId && sale.branchId._id) ? sale.branchId._id : sale.branchId;
                    return saleBranchId == branchFilter;
                });
            }
            
            // Calculate totals by category
            const categoryData = {};
            
            appData.categories.forEach(category => {
                const categorySales = filteredData.filter(sale => {
                    const saleCategoryId = (sale && sale.categoryId && sale.categoryId._id) ? sale.categoryId._id : sale.categoryId;
                    return saleCategoryId === category._id;
                });
                const totalSales = categorySales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                const totalCost = categorySales.reduce((sum, sale) => sum + (sale.costTotal || 0), 0);
                const totalProfit = totalSales - totalCost;
                const profitMargin = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;
                
                categoryData[category._id] = {
                    name: category.name,
                    totalSales,
                    totalCost,
                    totalProfit,
                    profitMargin
                };
            });
            
            // Calculate grand totals
            const grandTotalSales = Object.values(categoryData).reduce((sum, data) => sum + data.totalSales, 0);
            const grandTotalCost = Object.values(categoryData).reduce((sum, data) => sum + data.totalCost, 0);
            const grandTotalProfit = grandTotalSales - grandTotalCost;
            const grandProfitMargin = grandTotalSales > 0 ? (grandTotalProfit / grandTotalSales * 100) : 0;
            
            // Create category cards with updated layout
            Object.values(categoryData).forEach(data => {
                const card = document.createElement('div');
                card.className = 'col-lg-3 col-md-6 mb-4'; // Changed to col-lg-3 for 4 columns
                
                const permissions = appData.currentUser?.permissions || [];
                const isAdmin = permissions.includes('admin');
                const canEditSale = isAdmin || permissions.includes('sales-edit');
                const canDeleteSale = isAdmin || permissions.includes('sales-delete');
                card.innerHTML = `
                    <div class="category-card">
                        <div class="category-header">
                            ${data.name}
                        </div>
                        <div class="category-body">
                            <div class="category-metrics">
                                <div class="metric-row sales">
                                    <span class="metric-label">Total Sales</span>
                                    <span class="metric-value">${data.totalSales.toLocaleString()}</span>
                                </div>
                                <div class="metric-row cost">
                                    <span class="metric-label">Total Cost</span>
                                    <span class="metric-value">${data.totalCost.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            
            // Add grand total card
            const totalCard = document.createElement('div');
            totalCard.className = 'col-lg-3 col-md-6 mb-4'; // Changed to col-lg-3 for 4 columns
            totalCard.innerHTML = `
                <div class="category-card grand-total">
                    <div class="category-header">
                        Grand Total
                    </div>
                    <div class="category-body">
                        <div class="category-metrics">
                            <div class="metric-row sales">
                                <span class="metric-label">Total Sales</span>
                                <span class="metric-value">${grandTotalSales.toLocaleString()}</span>
                            </div>
                            <div class="metric-row cost">
                                <span class="metric-label">Total Cost</span>
                                <span class="metric-value">${grandTotalCost.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(totalCard);
        }
        
        // Load branch summary
        function loadBranchSummary(branchFilter = '') {
            const container = document.getElementById('branchSummary');
            container.innerHTML = '';
            
            // Calculate totals by branch and category
            const branchData = {};
            
            appData.branches.forEach(branch => {
                if (branchFilter && branch._id != branchFilter) return;
                
                const branchSales = appData.sales.filter(sale => {
                    const saleBranchId = (sale && sale.branchId && sale.branchId._id) ? sale.branchId._id : sale.branchId;
                    return saleBranchId === branch._id;
                });
                const totalSales = branchSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                const totalCost = branchSales.reduce((sum, sale) => sum + (sale.costTotal || 0), 0);
                const totalProfit = totalSales - totalCost;
                const profitMargin = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;
                
                // Initialize category data for this branch
                const categoryDetails = {};
                
                appData.categories.forEach(category => {
                    const categorySales = branchSales.filter(sale => {
                        const saleCategoryId = (sale && sale.categoryId && sale.categoryId._id) ? sale.categoryId._id : sale.categoryId;
                        return saleCategoryId === category._id;
                    });
                    const catSales = categorySales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                    const catCost = categorySales.reduce((sum, sale) => sum + (sale.costTotal || 0), 0);
                    const catProfit = catSales - catCost;
                    const catMargin = catSales > 0 ? (catProfit / catSales * 100) : 0;
                    
                    categoryDetails[category._id] = {
                        name: category.name,
                        sales: catSales,
                        cost: catCost,
                        profit: catProfit,
                        margin: catMargin
                    };
                });
                
                branchData[branch._id] = {
                    name: branch.name,
                    totalSales,
                    totalCost,
                    totalProfit,
                    profitMargin,
                    categories: categoryDetails
                };
            });
            
            // Calculate grand totals
            const grandTotalSales = Object.values(branchData).reduce((sum, data) => sum + data.totalSales, 0);
            const grandTotalCost = Object.values(branchData).reduce((sum, data) => sum + data.totalCost, 0);
            const grandTotalProfit = grandTotalSales - grandTotalCost;
            
            // Update grand total display
            document.getElementById('grandTotalSales').textContent = `${grandTotalSales.toLocaleString()}`;
            document.getElementById('grandTotalCost').textContent = `${grandTotalCost.toLocaleString()}`;
            document.getElementById('grandTotalProfit').textContent = `${grandTotalProfit.toLocaleString()}`;
            
            // Create branch cards with category breakdown
          //  Object.values(branchData).forEach(data => {

           const sortedBranches = Object.values(branchData).sort((a, b) => b.totalSales - a.totalSales);

// Create branch cards with category breakdown
sortedBranches.forEach(data => { 
                const card = document.createElement('div');
                card.className = 'col-md-12 mb-3';
                
                let categoryHtml = '';
                Object.values(data.categories).forEach(cat => {
                    categoryHtml += `
                        <tr>
                            <td>${cat.name}</td>
                            <td>${cat.sales.toLocaleString()}</td>
                            <td>${cat.cost.toLocaleString()}</td>
                            <td class="${cat.profit >= 0 ? 'text-success' : 'text-danger'}">
                                ${cat.profit.toLocaleString()}
                            </td>
                            <td>
                                <span class="badge ${cat.margin >= 0 ? 'bg-success' : 'bg-danger'}">
                                    ${cat.margin.toFixed(1)}%
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                card.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">${data.name}</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="card stat-card">
                                        <div class="card-body text-center">
                                            <div class="category-value text-primary">${data.totalSales.toLocaleString()}</div>
                                            <div class="category-label">Total Sales</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card stat-card">
                                        <div class="card-body text-center">
                                            <div class="category-value text-success">${data.totalCost.toLocaleString()}</div>
                                            <div class="category-label">Total Cost</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card stat-card">
                                        <div class="card-body text-center">
                                            <div class="category-value text-info">${data.totalProfit.toLocaleString()}</div>
                                            <div class="category-label">Total Profit</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card stat-card">
                                        <div class="card-body text-center">
                                            <div class="category-value text-warning">${data.profitMargin.toFixed(1)}%</div>
                                            <div class="category-label">Profit Margin</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h6 class="mb-3">Category Breakdown</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Sales</th>
                                            <th>Cost</th>
                                            <th>Profit</th>
                                            <th>Margin</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${categoryHtml}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Populate month filter dropdown
        function populateMonthFilter(tabPrefix = 'warehouse') {
            const dropdownMenu = document.getElementById(`${tabPrefix}MonthFilterDropdown`);
            const hiddenInput = document.getElementById(`${tabPrefix}DashboardMonthFilter`);
            
            if (!dropdownMenu) return;
            
            // Clear all items
            dropdownMenu.innerHTML = '';
            
            // Re-add header
            const header = document.createElement('li');
            header.className = 'dropdown-item-text fw-bold';
            header.textContent = 'Filter by Month:';
            dropdownMenu.appendChild(header);
            
            const divider = document.createElement('li');
            divider.innerHTML = '<hr class="dropdown-divider">';
            dropdownMenu.appendChild(divider);
            
            // Helper function to format month label
            function formatMonthLabel(year, month) {
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];
                return `${monthNames[month - 1]} ${year}`;
            }
            
            // Helper function to format month value (YYYY-MM)
            function formatMonthValue(year, month) {
                return `${year}-${String(month).padStart(2, '0')}`;
            }
            
            // Add "Current Month" option
            const now = new Date();
            const currentMonthValue = formatMonthValue(now.getFullYear(), now.getMonth() + 1);
            const currentMonthItem = document.createElement('li');
            const currentMonthLink = document.createElement('a');
            currentMonthLink.className = 'dropdown-item';
            currentMonthLink.href = '#';
            currentMonthLink.textContent = `Current Month (${formatMonthLabel(now.getFullYear(), now.getMonth() + 1)})`;
            currentMonthLink.dataset.value = currentMonthValue;
            currentMonthLink.addEventListener('click', function(e) {
                e.preventDefault();
                if (hiddenInput) hiddenInput.value = currentMonthValue;
                    updateMonthFilterButtonText(formatMonthLabel(now.getFullYear(), now.getMonth() + 1), tabPrefix);
                    loadDashboard(currentMonthValue, tabPrefix);
                showNotification(`Dashboard filtered for ${formatMonthLabel(now.getFullYear(), now.getMonth() + 1)}`, 'success');
            });
            currentMonthItem.appendChild(currentMonthLink);
            dropdownMenu.appendChild(currentMonthItem);
            
            // Add divider
            const divider2 = document.createElement('li');
            divider2.innerHTML = '<hr class="dropdown-divider">';
            dropdownMenu.appendChild(divider2);
            
            // Add last 12 months (including current month)
            for (let i = 0; i < 12; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const monthValue = formatMonthValue(year, month);
                const monthLabel = formatMonthLabel(year, month);
                
                const monthItem = document.createElement('li');
                const monthLink = document.createElement('a');
                monthLink.className = 'dropdown-item';
                monthLink.href = '#';
                monthLink.textContent = monthLabel;
                monthLink.dataset.value = monthValue;
                
                // Highlight current month
                if (i === 0) {
                    monthLink.style.fontWeight = 'bold';
                    monthLink.style.color = 'var(--primary-color)';
                }
                
                monthLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (hiddenInput) hiddenInput.value = monthValue;
                    updateMonthFilterButtonText(monthLabel, tabPrefix);
                    loadDashboard(monthValue, tabPrefix);
                    showNotification(`Dashboard filtered for ${monthLabel}`, 'success');
                });
                
                monthItem.appendChild(monthLink);
                dropdownMenu.appendChild(monthItem);
            }
            
            // Set default to current month
            if (hiddenInput && !hiddenInput.value) {
                hiddenInput.value = currentMonthValue;
                updateMonthFilterButtonText(formatMonthLabel(now.getFullYear(), now.getMonth() + 1), tabPrefix);
            }
        }
        
        // Update month filter button tooltip/title
        function updateMonthFilterButtonText(monthText, tabPrefix = 'warehouse') {
            const monthFilterBtn = document.getElementById(`${tabPrefix}MonthFilterBtn`);
            if (monthFilterBtn) {
                monthFilterBtn.title = `Filter by Month: ${monthText}`;
            }
        }
        
        // Populate category breakdown branch filter
        function populateCategoryBreakdownBranchFilter(tabPrefix = 'warehouse') {
            const selector = document.getElementById(`${tabPrefix}CategoryBreakdownBranchFilter`);
            const dropdownMenu = document.getElementById(`${tabPrefix}FilterDashboardDropdown`);
            
            // Populate hidden selector for backward compatibility
            if (selector) {
                // Keep the first option (All Branches)
                const firstOption = selector.options[0];
                selector.innerHTML = '';
                if (firstOption) {
                    selector.appendChild(firstOption);
                }
                
                // Add branch options
                appData.branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch._id;
                    option.textContent = branch.name;
                    selector.appendChild(option);
                });
            }
            
            // Populate dropdown menu for circular filter button
            if (dropdownMenu) {
                // Clear all items
                dropdownMenu.innerHTML = '';
                
                // Re-add header
                const header = document.createElement('li');
                header.className = 'dropdown-item-text fw-bold';
                header.textContent = 'Filter by Branch:';
                dropdownMenu.appendChild(header);
                
                const divider = document.createElement('li');
                divider.innerHTML = '<hr class="dropdown-divider">';
                dropdownMenu.appendChild(divider);
                
                // Add "All Branches" option
                const allBranchesItem = document.createElement('li');
                const allBranchesLink = document.createElement('a');
                allBranchesLink.className = 'dropdown-item';
                allBranchesLink.href = '#';
                allBranchesLink.textContent = 'All Branches';
                allBranchesLink.dataset.value = '';
                allBranchesLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    selector.value = '';
                    updateFilterButtonText('All Branches', tabPrefix);
                    loadBranchCards('', tabPrefix);
                });
                allBranchesItem.appendChild(allBranchesLink);
                dropdownMenu.appendChild(allBranchesItem);
                
                // Add branch options
                appData.branches.forEach(branch => {
                    const branchItem = document.createElement('li');
                    const branchLink = document.createElement('a');
                    branchLink.className = 'dropdown-item';
                    branchLink.href = '#';
                    branchLink.textContent = branch.name;
                    branchLink.dataset.value = branch._id;
                    branchLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        selector.value = branch._id;
                        updateFilterButtonText(branch.name, tabPrefix);
                        loadBranchCards(branch._id, tabPrefix);
                    });
                    branchItem.appendChild(branchLink);
                    dropdownMenu.appendChild(branchItem);
                });
            }
        }
        
        // Update filter button text (show tooltip/title)
        function updateFilterButtonText(text, tabPrefix = 'warehouse') {
            const filterBtn = document.getElementById(`${tabPrefix}FilterDashboardBtn`);
            if (filterBtn) {
                filterBtn.setAttribute('title', `Filter: ${text}`);
            }
        }
        
        // Load branch KPI cards
        function loadBranchKPICards(branchFilter = '') {
            // Show KPI cards if a specific branch is selected
            const kpiCards = document.getElementById('branchKPICards');
            if (branchFilter) {
                kpiCards.style.display = 'block';
                
                // Filter data by branch
                const branchSales = appData.sales.filter(sale => {
                    const saleBranchId = (sale && sale.branchId && sale.branchId._id) ? sale.branchId._id : sale.branchId;
                    return saleBranchId == branchFilter;
                });
                
                // Calculate totals
                const totalSales = branchSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                const totalCost = branchSales.reduce((sum, sale) => sum + (sale.costTotal || 0), 0);
                const totalProfit = totalSales - totalCost;
                const profitMargin = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;
                
                // Update KPI cards
                document.getElementById('branchTotalSales').textContent = `${totalSales.toLocaleString()}`;
                document.getElementById('branchTotalCost').textContent = `${totalCost.toLocaleString()}`;
                document.getElementById('branchTotalProfit').textContent = `${totalProfit.toLocaleString()}`;
                document.getElementById('branchProfitMargin').textContent = `${profitMargin.toFixed(1)}%`;
            } else {
                kpiCards.style.display = 'none';
            }
        }
        
        // Load comparison tables
        function loadComparisonTables(tabPrefix = 'warehouse') {
            if (tabPrefix === 'shop') {
                // Shop Dashboard: Skip "Branch Wise Department Sales Comparison" section (removed)
                // Branch Wise Sale Report section is now handled separately with filters
                // No need to load old branch comparison tables
                return;
            } else {
                // Warehouse Dashboard: Group sales by category and branch
            const categoryBranchData = {};
            
                (appData.categories || []).forEach(category => {
                categoryBranchData[category._id] = {
                    name: category.name,
                    branches: {}
                };
                
                    (appData.branches || []).forEach(branch => {
                        const branchSales = (appData.sales || []).filter(sale => {
                        const saleCategoryId = (sale && sale.categoryId && sale.categoryId._id) ? sale.categoryId._id : sale.categoryId;
                        const saleBranchId = (sale && sale.branchId && sale.branchId._id) ? sale.branchId._id : sale.branchId;
                        return saleCategoryId === category._id && saleBranchId === branch._id;
                    });
                    
                    const totalSales = branchSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                    const totalCost = branchSales.reduce((sum, sale) => sum + (sale.costTotal || 0), 0);
                    const totalProfit = totalSales - totalCost;
                    const profitMargin = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;
                    
                    categoryBranchData[category._id].branches[branch._id] = {
                        name: branch.name,
                        sales: totalSales,
                        cost: totalCost,
                        profit: totalProfit,
                        margin: profitMargin
                    };
                });
            });
            
            // Log category data
            
            // Log all available categories
            const availableCategories = Object.keys(categoryBranchData).map(id => ({
                id: id,
                name: categoryBranchData[id].name
            }));
            
            // Helper function to find category by keyword
            function findCategoryByKeyword(keywords) {
                for (const [categoryId, data] of Object.entries(categoryBranchData)) {
                    const categoryUpper = data.name.toUpperCase();
                    for (const keyword of keywords) {
                        if (categoryUpper.includes(keyword.toUpperCase())) {
                            return data.name;
                        }
                    }
                }
                return null;
            }
            
            // DYNAMIC APPROACH: Use all categories from database instead of hardcoded names
            
            // Get all categories that have sales data
            const categoriesWithSales = availableCategories.filter(cat => {
                const categoryData = categoryBranchData[cat.id];
                const hasSales = Object.values(categoryData.branches).some(branch => branch.sales > 0);
                return hasSales;
            });
            
            
            // Create dynamic tables for each category with sales
            const comparisonTablesContainer = document.getElementById(`${tabPrefix}DynamicCategoryTables`);
            
            if (comparisonTablesContainer) {
                // Clear existing content
                comparisonTablesContainer.innerHTML = '';
                
                // Create dynamic tables for each category
                categoriesWithSales.forEach((category, index) => {
                    const categoryData = categoryBranchData[category.id];
                    const tableId = `dynamicTable${index}`;
                    const tableBodyId = `dynamicTableBody${index}`;
                    
                    // Create table HTML
                    const tableHtml = `
                        <div class="card mb-4">
                            <div class="card-header bg-${getCategoryColor(index)} text-white">
                                <h5 class="mb-0"><i class="${getIconForCategory(category.name)} me-2"></i>${category.name}</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="${tableId}">
                                        <thead>
                                            <tr>
                                                <th>Rank</th>
                                                <th>Branch</th>
                                                <th class="text-end">Sales</th>
                                                <th class="text-end">Cost</th>
                                                <th class="text-end">Profit</th>
                                                <th class="text-end">Margin</th>
                                            </tr>
                                        </thead>
                                        <tbody id="${tableBodyId}">
                                            <!-- Table rows will be populated dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    comparisonTablesContainer.insertAdjacentHTML('beforeend', tableHtml);
                    
                    // Populate the table
                    populateCategoryTable(tableBodyId, tableId, categoryBranchData, category.name);
                });
                }
            }
            
            // Load summary tables (only for warehouse dashboard)
            if (tabPrefix !== 'shop') {
            loadSummaryTables();
            }
        }
        
        // Load total sales summary (Branch-wise and Category-wise)
        function loadSummaryTables() {
            // Calculate total sales for each branch
            const branchSalesSummary = [];
            
            appData.branches.forEach(branch => {
                const branchSales = appData.sales.filter(sale => {
                    const saleBranchId = (sale && sale.branchId && sale.branchId._id) ? sale.branchId._id : sale.branchId;
                    return saleBranchId === branch._id;
                });
                
                const totalSales = branchSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                
                if (totalSales > 0) {
                    branchSalesSummary.push({
                        name: branch.name,
                        sales: totalSales
                    });
                }
            });
            
            // Sort by sales descending
            branchSalesSummary.sort((a, b) => b.sales - a.sales);
            
            // Populate branch sales total
            const branchGrossTotalBody = document.getElementById('branchGrossTotalBody');
            if (branchGrossTotalBody) {
                branchGrossTotalBody.innerHTML = `
                    <div class="row g-2">
                        ${branchSalesSummary.map(branch => `
                            <div class="col-12 mb-2">
                                <div class="card border-start border-3" style="border-left-color: #28a745;">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-store me-2 text-success"></i>
                                                <strong>${branch.name}</strong>
                                            </div>
                                            <span class="badge bg-success" style="font-size: 1rem; padding: 8px 15px;">
                                                ${branch.sales.toLocaleString()}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Calculate total sales for each category with branch breakdown
            const categorySalesSummary = [];
            
            appData.categories.forEach(category => {
                const categorySales = appData.sales.filter(sale => {
                    const saleCategoryId = (sale && sale.categoryId && sale.categoryId._id) ? sale.categoryId._id : sale.categoryId;
                    return saleCategoryId === category._id;
                });
                
                const totalSales = categorySales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                
                if (totalSales > 0) {
                    // Get branch breakdown for this category
                    const branchBreakdown = {};
                    categorySales.forEach(sale => {
                        const saleBranchId = (sale && sale.branchId && sale.branchId._id) ? sale.branchId._id : sale.branchId;
                        const branch = appData.branches.find(b => b._id === saleBranchId);
                        if (branch) {
                            if (!branchBreakdown[branch.name]) {
                                branchBreakdown[branch.name] = 0;
                            }
                            branchBreakdown[branch.name] += sale.total || 0;
                        }
                    });
                    
                    categorySalesSummary.push({
                        name: category.name,
                        sales: totalSales,
                        branchBreakdown: branchBreakdown
                    });
                }
            });
            
            // Sort by sales descending
            categorySalesSummary.sort((a, b) => b.sales - a.sales);
            
            // Populate category sales total with branch breakdown
            const categoryGrossTotalBody = document.getElementById('categoryGrossTotalBody');
            if (categoryGrossTotalBody) {
                categoryGrossTotalBody.innerHTML = `
                    <div class="row g-2">
                        ${categorySalesSummary.map(category => `
                            <div class="col-12 mb-3">
                                <div class="card border-start border-3" style="border-left-color: #28a745;">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="mb-0 fw-bold">${category.name}</h6>
                                            <span class="badge bg-success" style="font-size: 0.9rem;">
                                                ${category.sales.toLocaleString()}
                                            </span>
                                        </div>
                                        <div class="border-top pt-2">
                                            <small class="text-muted d-block mb-1">Branch Sales:</small>
                                            <div class="d-flex flex-wrap gap-2">
                                                ${Object.entries(category.branchBreakdown)
                                                    .sort(([,a], [,b]) => b - a)
                                                    .map(([branchName, sales]) => `
                                                        <span class="badge bg-light text-dark border" style="font-size: 0.85rem; padding: 5px 10px;">
                                                            <i class="fas fa-store me-1"></i>${branchName}: <strong>${sales.toLocaleString()}</strong>
                                                        </span>
                                                    `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }
        
        // Load branch-wise comparison tables for shop dashboard
        function loadBranchComparisonTables(tabPrefix = 'shop') {
            if (tabPrefix !== 'shop') return;
            
            // Check if data exists
            if (!appData.departmentSales || appData.departmentSales.length === 0) {
                const branchTablesContainer = document.getElementById(`${tabPrefix}DynamicBranchTables`);
                if (branchTablesContainer) {
                    branchTablesContainer.innerHTML = '<div class="alert alert-info">No department sales data available. Please add sales data first.</div>';
                }
                return;
            }
            
            console.log(`Loading branch comparison tables. Department sales: ${appData.departmentSales.length}, Branches: ${(appData.branches || []).length}, Departments: ${(appData.departments || []).length}`);
            
            // Group sales by branch and department
            const branchDepartmentData = {};
            
            (appData.branches || []).forEach(branch => {
                branchDepartmentData[branch._id] = {
                    name: branch.name,
                    departments: {}
                };
                
                (appData.departments || []).forEach(department => {
                    const branchDeptSales = (appData.departmentSales || []).filter(sale => {
                        const saleDepartmentId = (sale && sale.departmentId && sale.departmentId._id) ? sale.departmentId._id : sale.departmentId;
                        const saleBranchId = (sale && sale.branchId && sale.branchId._id) ? sale.branchId._id : sale.branchId;
                        return saleDepartmentId === department._id && saleBranchId === branch._id;
                    });
                    
                    // Calculate sub-department breakdown for this branch-department FIRST
                    const subDepartmentData = {};
                    const departmentSubDepts = (appData.subDepartments || []).filter(subDept => {
                        const subDeptDepartmentId = (subDept && subDept.departmentId && subDept.departmentId._id) ? subDept.departmentId._id : subDept.departmentId;
                        return subDeptDepartmentId === department._id;
                    });
                    
                    departmentSubDepts.forEach(subDept => {
                        const subDeptSales = branchDeptSales.filter(sale => {
                            const saleSubDeptId = (sale && sale.subDepartmentId && sale.subDepartmentId._id) ? sale.subDepartmentId._id : sale.subDepartmentId;
                            return saleSubDeptId === subDept._id;
                        });
                        
                        if (subDeptSales.length > 0) {
                            const subGrossSale = subDeptSales.reduce((sum, sale) => sum + (sale.grossSale || 0), 0);
                            const subDiscountAmount = subDeptSales.reduce((sum, sale) => sum + (sale.discountAmount || 0), 0);
                            // Discount % = (Discount Value / Gross Sale) * 100
                            const subDiscountPercent = subGrossSale > 0 ? (subDiscountAmount / subGrossSale * 100) : 0;
                            const subReturn = subDeptSales.reduce((sum, sale) => sum + (sale.returnAmount || 0), 0);
                            // Branch Wise Sales Detail formula: Sale Value = Gross Sale - Discount Value - Return
                            const subSaleValue = subGrossSale - subDiscountAmount - subReturn;
                            const subGST = subDeptSales.reduce((sum, sale) => sum + (sale.gst || 0), 0);
                            // Branch Wise Sales Detail formula: Net Sale = Sale Value + GST
                            const subNetSale = subSaleValue + subGST;
                            
                            subDepartmentData[subDept._id] = {
                                name: subDept.name,
                                grossSale: subGrossSale,
                                discountAmount: subDiscountAmount,
                                discountPercent: subDiscountPercent,
                                saleValue: subSaleValue,
                                returnAmount: subReturn,
                                gst: subGST,
                                netSale: subNetSale
                            };
                        }
                    });
                    
                    // Calculate department totals: If sub-departments exist, sum them; otherwise use direct sales
                    let grossSale, discountAmount, discountPercent, saleValue, returnAmount, gst, netSale;
                    
                    if (Object.keys(subDepartmentData).length > 0) {
                        // Department total = sum of sub-departments (to avoid double counting)
                        grossSale = Object.values(subDepartmentData).reduce((sum, sub) => sum + (sub.grossSale || 0), 0);
                        discountAmount = Object.values(subDepartmentData).reduce((sum, sub) => sum + (sub.discountAmount || 0), 0);
                        // Discount % = (Discount Value / Gross Sale) * 100
                        discountPercent = grossSale > 0 ? (discountAmount / grossSale * 100) : 0;
                        returnAmount = Object.values(subDepartmentData).reduce((sum, sub) => sum + (sub.returnAmount || 0), 0);
                        // Branch Wise Sales Detail formula: Sale Value = Gross Sale - Discount Value - Return
                        saleValue = grossSale - discountAmount - returnAmount;
                        gst = Object.values(subDepartmentData).reduce((sum, sub) => sum + (sub.gst || 0), 0);
                        // Branch Wise Sales Detail formula: Net Sale = Sale Value + GST
                        netSale = saleValue + gst;
                    } else {
                        // No sub-departments: use direct department sales
                        grossSale = branchDeptSales.reduce((sum, sale) => sum + (sale.grossSale || 0), 0);
                        discountAmount = branchDeptSales.reduce((sum, sale) => sum + (sale.discountAmount || 0), 0);
                        // Discount % = (Discount Value / Gross Sale) * 100
                        discountPercent = grossSale > 0 ? (discountAmount / grossSale * 100) : 0;
                        returnAmount = branchDeptSales.reduce((sum, sale) => sum + (sale.returnAmount || 0), 0);
                        // Branch Wise Sales Detail formula: Sale Value = Gross Sale - Discount Value - Return
                        saleValue = grossSale - discountAmount - returnAmount;
                        gst = branchDeptSales.reduce((sum, sale) => sum + (sale.gst || 0), 0);
                        // Branch Wise Sales Detail formula: Net Sale = Sale Value + GST
                        netSale = saleValue + gst;
                    }
                    
                    // Always add department data, even if values are 0
                    branchDepartmentData[branch._id].departments[department._id] = {
                        name: department.name,
                        grossSale: grossSale,
                        discountAmount: discountAmount,
                        discountPercent: discountPercent,
                        saleValue: saleValue,
                        returnAmount: returnAmount,
                        gst: gst,
                        netSale: netSale,
                        subDepartments: subDepartmentData
                    };
                });
            });
            
            // Debug: Log branch data structure
            console.log('Branch Department Data:', Object.keys(branchDepartmentData).map(branchId => ({
                branch: branchDepartmentData[branchId].name,
                departments: Object.keys(branchDepartmentData[branchId].departments).length,
                hasSales: Object.values(branchDepartmentData[branchId].departments).some(dept => (dept.netSale || 0) > 0 || (dept.grossSale || 0) > 0)
            })));
            
            // Get all branches that have sales data and calculate their total net sale
            const branchesWithSalesData = Object.keys(branchDepartmentData).map(branchId => {
                const branchData = branchDepartmentData[branchId];
                const totalNetSale = Object.values(branchData.departments).reduce((sum, dept) => sum + (dept.netSale || 0), 0);
                const hasSales = Object.values(branchData.departments).some(dept => {
                    const netSale = dept.netSale || 0;
                    const grossSale = dept.grossSale || 0;
                    return netSale > 0 || grossSale > 0;
                });
                return { branchId, branchData, totalNetSale, hasSales };
            }).filter(item => item.hasSales);
            
            // Sort branches by total net sale (descending) - ranking according to net sale
            branchesWithSalesData.sort((a, b) => b.totalNetSale - a.totalNetSale);
            
            console.log(`Branches with sales: ${branchesWithSalesData.length} out of ${Object.keys(branchDepartmentData).length}`);
            
            // Create dynamic tables for each branch with sales
            const branchTablesContainer = document.getElementById(`${tabPrefix}DynamicBranchTables`);
            
            if (branchTablesContainer) {
                // Clear existing content
                branchTablesContainer.innerHTML = '';
                
                if (branchesWithSalesData.length === 0) {
                    branchTablesContainer.innerHTML = '<div class="alert alert-info">No branch sales data found. Please add sales data first.</div>';
                    return;
                }
                
                // Create dynamic tables for each branch (sorted by net sale)
                branchesWithSalesData.forEach((item, index) => {
                    const branchData = item.branchData;
                    const tableId = `branchDynamicTable${index}`;
                    const tableBodyId = `branchDynamicTableBody${index}`;
                    
                    // Create table HTML
                    const tableHtml = `
                        <div class="card mb-4">
                            <div class="card-header bg-${getCategoryColor(index)} text-white">
                                <h5 class="mb-0"><i class="${getIconForCategory(branchData.name)} me-2"></i>${branchData.name}</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="${tableId}">
                                        <thead>
                                            <tr>
                                                <th>Rank</th>
                                                <th>Department</th>
                                                <th class="text-end">Gross Sale</th>
                                                <th class="text-end">Discount Value</th>
                                                <th class="text-end">Discount %</th>
                                                <th class="text-end">Return</th>
                                                <th class="text-end">Sale Value</th>
                                                <th class="text-end">GST</th>
                                                <th class="text-end">Net Sale</th>
                                                <th class="text-end">Daily Sale Average</th>
                                            </tr>
                                        </thead>
                                        <tbody id="${tableBodyId}">
                                            <!-- Table rows will be populated dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    branchTablesContainer.insertAdjacentHTML('beforeend', tableHtml);
                    
                    // Populate the table
                    populateBranchTable(tableBodyId, tableId, branchDepartmentData, branchData.name);
                });
            }
        }
        
        // Populate branch table with department data
        function populateBranchTable(tableBodyId, tableId, branchDepartmentData, branchName) {
            const tableBody = document.getElementById(tableBodyId);
            if (!tableBody) {
                console.error(`Table body not found: ${tableBodyId}`);
                return;
            }
            
            tableBody.innerHTML = '';
            
            // Find the branch data first
            let branchData = null;
            let branchId = null;
            for (const [id, data] of Object.entries(branchDepartmentData)) {
                if (data.name === branchName) {
                    branchData = data;
                    branchId = id;
                    break;
                }
                // Fuzzy match
                const normalize = (str) => str.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (normalize(data.name) === normalize(branchName)) {
                    branchData = data;
                    branchId = id;
                    break;
                }
            }
            
            if (!branchData) {
                console.warn(`Branch not found: ${branchName}. Available branches:`, Object.keys(branchDepartmentData).map(id => branchDepartmentData[id].name));
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="9" class="text-center text-muted">No sales data available for branch: ${branchName}</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            console.log(`Populating table for branch: ${branchName}, Departments: ${Object.keys(branchData.departments).length}`);
            
            // Calculate number of days with actual sales (count unique sale dates for this branch)
            // Get all sales for this branch
            const branchSales = (appData.departmentSales || []).filter(sale => {
                const saleBranchId = (sale && sale.branchId && sale.branchId._id) ? sale.branchId._id : sale.branchId;
                return saleBranchId === branchId;
            });
            
            // Get unique sale dates for this branch (count actual days with sales)
            const uniqueSaleDates = new Set();
            branchSales.forEach(sale => {
                if (sale.date) {
                    // Extract date part only (YYYY-MM-DD) to count unique days
                    const saleDate = new Date(sale.date);
                    const dateString = saleDate.toISOString().split('T')[0];
                    uniqueSaleDates.add(dateString);
                }
            });
            
            // Use actual number of days with sales (not total days in date range)
            // Example: If sales on days 16, 17, 18 (3 days), numberOfDays = 3
            const numberOfDays = uniqueSaleDates.size > 0 ? uniqueSaleDates.size : 1;
            
            // Update the table header with the actual branch name
            if (tableId) {
                const card = document.getElementById(tableId).closest('.card');
                if (card) {
                    const cardHeader = card.querySelector('.card-header h5');
                    if (cardHeader) {
                        cardHeader.innerHTML = `<i class="${getIconForCategory(branchName)} me-2"></i>${branchData.name}`;
                    }
                }
            }
            
            // Sort departments by net sale (descending) - ranking according to net sale
            const sortedDepartments = Object.values(branchData.departments)
                .filter(dept => {
                    const netSale = dept.netSale || 0;
                    const grossSale = dept.grossSale || 0;
                    return netSale > 0 || grossSale > 0;
                })
                .sort((a, b) => {
                    // Primary sort: by net sale (descending)
                    const aNetSale = a.netSale || 0;
                    const bNetSale = b.netSale || 0;
                    if (aNetSale !== bNetSale) {
                        return bNetSale - aNetSale;
                    }
                    // Secondary sort: if net sale is equal, sort by gross sale
                    const aGrossSale = a.grossSale || 0;
                    const bGrossSale = b.grossSale || 0;
                    return bGrossSale - aGrossSale;
                });
            
            // If no departments with sales, show message
            if (sortedDepartments.length === 0) {
                console.warn(`No departments with sales for branch: ${branchName}. Total departments: ${Object.keys(branchData.departments).length}`);
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="10" class="text-center text-muted">No sales data available for this branch</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            console.log(`Found ${sortedDepartments.length} departments with sales for branch: ${branchName}`);
            
            // Collect all items for grand total calculation
            const allItemsForGrandTotal = [];
            let rankCounter = 1;
            
            sortedDepartments.forEach((dept) => {
                if (dept.subDepartments && Object.keys(dept.subDepartments).length > 0) {
                    // Add department name as heading row
                    const headingRow = document.createElement('tr');
                    headingRow.className = 'table-secondary';
                    headingRow.style.backgroundColor = '#e9ecef';
                    headingRow.innerHTML = `
                        <td colspan="10" style="padding: 12px 15px; font-weight: 700; font-size: 1rem; color: #495057;">
                            <i class="fas fa-building me-2"></i>${dept.name}
                        </td>
                    `;
                    tableBody.appendChild(headingRow);
                    
                    // Sort sub-departments by net sale (descending)
                    const subDepts = Object.values(dept.subDepartments).sort((a, b) => {
                        const aNetSale = a.netSale || 0;
                        const bNetSale = b.netSale || 0;
                        if (aNetSale !== bNetSale) {
                            return bNetSale - aNetSale;
                        }
                        return (b.grossSale || 0) - (a.grossSale || 0);
                    });
                    
                    // Add sub-department rows
                    subDepts.forEach((subDept) => {
                        const rank = rankCounter++;
                        const dailyAverage = numberOfDays > 0 ? (subDept.netSale || 0) / numberOfDays : 0;
                        const row = document.createElement('tr');
                        row.className = 'sub-dept-row';
                        row.style.backgroundColor = '#f8f9fa';
                        row.innerHTML = `
                            <td class="text-center"><strong>${rank}</strong></td>
                            <td style="padding-left: 30px;">
                                <i class="fas fa-arrow-right me-2 text-muted" style="font-size: 0.75rem;"></i>
                                <small>${subDept.name}</small>
                            </td>
                            <td class="text-end"><small>${(subDept.grossSale || 0).toLocaleString()}</small></td>
                            <td class="text-end"><small>${((subDept.grossSale || 0) * (subDept.discountPercent || 0) / 100).toLocaleString()}</small></td>
                            <td class="text-end"><small>${(subDept.discountPercent || 0).toFixed(2)}%</small></td>
                            <td class="text-end"><small>${(subDept.returnAmount || 0).toLocaleString()}</small></td>
                            <td class="text-end"><small>${(subDept.saleValue || 0).toLocaleString()}</small></td>
                            <td class="text-end"><small>${(subDept.gst || 0).toLocaleString()}</small></td>
                            <td class="text-end text-success"><small><strong>${(subDept.netSale || 0).toLocaleString()}</strong></small></td>
                            <td class="text-end"><small><strong>${Math.round(dailyAverage).toLocaleString()}</strong></small></td>
                        `;
                        tableBody.appendChild(row);
                        
                        // Add to grand total calculation
                        allItemsForGrandTotal.push({
                            grossSale: subDept.grossSale || 0,
                            discountAmount: subDept.discountAmount || 0,
                            discountPercent: subDept.discountPercent || 0,
                            saleValue: subDept.saleValue || 0,
                            returnAmount: subDept.returnAmount || 0,
                            gst: subDept.gst || 0,
                            netSale: subDept.netSale || 0
                        });
                    });
                } else {
                    // If department has no sub-departments, show department as a regular row
                    const rank = rankCounter++;
                    const dailyAverage = numberOfDays > 0 ? (dept.netSale || 0) / numberOfDays : 0;
                    const row = document.createElement('tr');
                    row.className = 'dept-row';
                    row.innerHTML = `
                        <td class="text-center"><strong>${rank}</strong></td>
                        <td><strong>${dept.name}</strong></td>
                        <td class="text-end"><strong>${(dept.grossSale || 0).toLocaleString()}</strong></td>
                        <td class="text-end"><strong>${(dept.discountAmount || 0).toLocaleString()}</strong></td>
                        <td class="text-end"><strong>${(dept.discountPercent || 0).toFixed(2)}%</strong></td>
                        <td class="text-end"><strong>${(dept.returnAmount || 0).toLocaleString()}</strong></td>
                        <td class="text-end"><strong>${(dept.saleValue || 0).toLocaleString()}</strong></td>
                        <td class="text-end"><strong>${(dept.gst || 0).toLocaleString()}</strong></td>
                        <td class="text-end text-success"><strong>${(dept.netSale || 0).toLocaleString()}</strong></td>
                        <td class="text-end"><strong>${Math.round(dailyAverage).toLocaleString()}</strong></td>
                    `;
                    tableBody.appendChild(row);
                    
                    // Add to grand total calculation
                    allItemsForGrandTotal.push({
                        grossSale: dept.grossSale || 0,
                        discountAmount: dept.discountAmount || 0,
                        discountPercent: dept.discountPercent || 0,
                        saleValue: dept.saleValue || 0,
                        returnAmount: dept.returnAmount || 0,
                        gst: dept.gst || 0,
                        netSale: dept.netSale || 0
                    });
                }
            });
            
            // Calculate grand totals from all items
            const grandTotalGrossSale = allItemsForGrandTotal.reduce((sum, item) => sum + (item.grossSale || 0), 0);
            const grandTotalDiscountAmount = allItemsForGrandTotal.reduce((sum, item) => {
                return sum + (item.discountAmount || ((item.grossSale || 0) * (item.discountPercent || 0) / 100));
            }, 0);
            // Discount % = (Discount Value / Gross Sale) * 100
            const grandTotalDiscountPercent = grandTotalGrossSale > 0 ? (grandTotalDiscountAmount / grandTotalGrossSale * 100) : 0;
            const grandTotalReturn = allItemsForGrandTotal.reduce((sum, item) => sum + (item.returnAmount || 0), 0);
            // Branch Wise Sales Detail formula: Sale Value = Gross Sale - Discount Value - Return
            const grandTotalSaleValue = grandTotalGrossSale - grandTotalDiscountAmount - grandTotalReturn;
            const grandTotalGST = allItemsForGrandTotal.reduce((sum, item) => sum + (item.gst || 0), 0);
            // Branch Wise Sales Detail formula: Net Sale = Sale Value + GST
            const grandTotalNetSale = grandTotalSaleValue + grandTotalGST;
            const grandTotalDailyAverage = numberOfDays > 0 ? grandTotalNetSale / numberOfDays : 0;
            
            // Add grand total row at the end
            const grandTotalRow = document.createElement('tr');
            grandTotalRow.className = 'table-warning fw-bold';
            grandTotalRow.innerHTML = `
                <td class="text-center" colspan="2"><strong>Grand Total</strong></td>
                <td class="text-end"><strong>${grandTotalGrossSale.toLocaleString()}</strong></td>
                <td class="text-end"><strong>${grandTotalDiscountAmount.toLocaleString()}</strong></td>
                <td class="text-end"><strong>${grandTotalDiscountPercent.toFixed(2)}%</strong></td>
                <td class="text-end"><strong>${grandTotalReturn.toLocaleString()}</strong></td>
                <td class="text-end"><strong>${grandTotalSaleValue.toLocaleString()}</strong></td>
                <td class="text-end"><strong>${grandTotalGST.toLocaleString()}</strong></td>
                <td class="text-end text-success"><strong>${grandTotalNetSale.toLocaleString()}</strong></td>
                <td class="text-end"><strong>${Math.round(grandTotalDailyAverage).toLocaleString()}</strong></td>
            `;
            tableBody.appendChild(grandTotalRow);
        }
        
        // Populate category table
        function populateCategoryTable(tableBodyId, tableId, categoryBranchData, categoryName) {
            const tableBody = document.getElementById(tableBodyId);
            tableBody.innerHTML = '';
            
            // Find the category data - try exact match first, then fuzzy match
            let categoryData = null;
            for (const [categoryId, data] of Object.entries(categoryBranchData)) {
                // Exact match
                if (data.name === categoryName) {
                    categoryData = data;
                    break;
                }
                // Fuzzy match - case insensitive, ignore spaces/punctuation
                const normalize = (str) => str.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (normalize(data.name) === normalize(categoryName)) {
                    categoryData = data;
                    break;
                }
            }
            
            if (!categoryData) {
                console.warn(`Category not found: ${categoryName}`);
                // Insert "No data" message
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" class="text-center text-muted">No sales data available</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            // Update the table header with the actual category name from database
            if (tableId) {
                const card = document.getElementById(tableId).closest('.card');
                if (card) {
                    const cardHeader = card.querySelector('.card-header h5');
                    if (cardHeader) {
                        cardHeader.innerHTML = `<i class="${getIconForCategory(categoryName)} me-2"></i>${categoryData.name}`;
                    }
                }
            }
            
            // Sort branches by sales (descending)
            const sortedBranches = Object.values(categoryData.branches)
                .filter(branch => branch.sales > 0) // Only show branches with sales
                .sort((a, b) => b.sales - a.sales);
            
            // If no branches with sales, show message
            if (sortedBranches.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" class="text-center text-muted">No sales data available for this category</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            sortedBranches.forEach((branch, index) => {
                const row = document.createElement('tr');
                const rank = index + 1;
                row.innerHTML = `
                    <td class="text-center"><strong>${rank}</strong></td>
                    <td>${branch.name}</td>
                    <td class="text-end">${branch.sales.toLocaleString()}</td>
                    <td class="text-end">${branch.cost.toLocaleString()}</td>
                    <td class="text-end ${branch.profit >= 0 ? 'text-success' : 'text-danger'}">
                        ${branch.profit.toLocaleString()}
                    </td>
                    <td class="text-end">
                        <span class="badge ${branch.margin >= 0 ? 'bg-success' : 'bg-danger'}">
                            ${branch.margin.toFixed(1)}%
                        </span>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Calculate grand totals for the category
            const grandTotalSales = sortedBranches.reduce((sum, branch) => sum + branch.sales, 0);
            const grandTotalCost = sortedBranches.reduce((sum, branch) => sum + branch.cost, 0);
            const grandTotalProfit = grandTotalSales - grandTotalCost;
            const grandTotalMargin = grandTotalSales > 0 ? (grandTotalProfit / grandTotalSales * 100) : 0;
            
            // Add grand total row at the end
            const grandTotalRow = document.createElement('tr');
            grandTotalRow.className = 'table-warning fw-bold'; // Using Bootstrap's warning color for grand total
            grandTotalRow.innerHTML = `
                <td class="text-center" colspan="2"><strong>Grand Total</strong></td>
                <td class="text-end"><strong>${grandTotalSales.toLocaleString()}</strong></td>
                <td class="text-end"><strong>${grandTotalCost.toLocaleString()}</strong></td>
                <td class="text-end ${grandTotalProfit >= 0 ? 'text-success' : 'text-danger'}">
                    <strong>${grandTotalProfit.toLocaleString()}</strong>
                </td>
                <td class="text-end">
                    <span class="badge ${grandTotalMargin >= 0 ? 'bg-success' : 'bg-danger'}">
                        <strong>${grandTotalMargin.toFixed(1)}%</strong>
                    </span>
                </td>
            `;
            tableBody.appendChild(grandTotalRow);
        }
        
        // Populate department table (for shop dashboard)
        function populateDepartmentTable(tableBodyId, tableId, departmentBranchData, departmentName) {
            const tableBody = document.getElementById(tableBodyId);
            if (!tableBody) {
                console.error(`Table body not found: ${tableBodyId}`);
                return;
            }
            
            tableBody.innerHTML = '';
            
            // Find the department data - try exact match first, then fuzzy match
            let departmentData = null;
            for (const [departmentId, data] of Object.entries(departmentBranchData)) {
                // Exact match
                if (data.name === departmentName) {
                    departmentData = data;
                    break;
                }
                // Fuzzy match - case insensitive, ignore spaces/punctuation
                const normalize = (str) => str.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (normalize(data.name) === normalize(departmentName)) {
                    departmentData = data;
                    break;
                }
            }
            
            if (!departmentData) {
                console.warn(`Department not found: ${departmentName}. Available departments:`, Object.keys(departmentBranchData).map(id => departmentBranchData[id].name));
                // Insert "No data" message
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="9" class="text-center text-muted">No sales data available for this department</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            console.log(`Found department data for: ${departmentName}, Branches: ${Object.keys(departmentData.branches).length}`);
            
            // Note: Department name is now shown as a heading above the table, not in card header
            
            // Sort branches by net sale (descending) - ranking according to net sale
            const sortedBranches = Object.values(departmentData.branches)
                .filter(branch => {
                    const netSale = branch.netSale || 0;
                    const grossSale = branch.grossSale || 0;
                    return netSale > 0 || grossSale > 0; // Show if either has value
                })
                .sort((a, b) => {
                    // Primary sort: by net sale (descending)
                    const aNetSale = a.netSale || 0;
                    const bNetSale = b.netSale || 0;
                    if (aNetSale !== bNetSale) {
                        return bNetSale - aNetSale;
                    }
                    // Secondary sort: if net sale is equal, sort by gross sale
                    const aGrossSale = a.grossSale || 0;
                    const bGrossSale = b.grossSale || 0;
                    return bGrossSale - aGrossSale;
                });
            
            // If no branches with sales, show message
            if (sortedBranches.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="9" class="text-center text-muted">No sales data available for this department</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            // Display all branches sorted by net sale (descending)
            sortedBranches.forEach((branch, index) => {
                const rank = index + 1;
                // Calculate discount amount if not available
                const discountAmount = branch.discountAmount || ((branch.grossSale || 0) * (branch.discountPercent || 0) / 100);
                // Branch row - showing department total (sum of all sub-departments for this branch)
                // Sub-departments are NOT shown, only the department total
                const row = document.createElement('tr');
                row.className = 'branch-row';
                row.innerHTML = `
                    <td class="text-center"><strong>${rank}</strong></td>
                    <td><strong>${branch.name}</strong></td>
                    <td class="text-end"><strong>${(branch.grossSale || 0).toLocaleString()}</strong></td>
                    <td class="text-end"><strong>${discountAmount.toLocaleString()}</strong></td>
                    <td class="text-end"><strong>${(branch.discountPercent || 0).toFixed(2)}%</strong></td>
                    <td class="text-end"><strong>${(branch.returnAmount || 0).toLocaleString()}</strong></td>
                    <td class="text-end"><strong>${(branch.saleValue || 0).toLocaleString()}</strong></td>
                    <td class="text-end"><strong>${(branch.gst || 0).toLocaleString()}</strong></td>
                    <td class="text-end text-success"><strong>${(branch.netSale || 0).toLocaleString()}</strong></td>
                `;
                tableBody.appendChild(row);
            });
            
            // Calculate grand totals for the department (sum of all branches)
            // Only ONE grand total per department table
            const grandTotalGrossSale = sortedBranches.reduce((sum, branch) => sum + (branch.grossSale || 0), 0);
            // Calculate discount amount from branch data (should have discountAmount property)
            const grandTotalDiscountAmount = sortedBranches.reduce((sum, branch) => {
                // Try to get discountAmount directly, or calculate from discountPercent if not available
                if (branch.discountAmount !== undefined) {
                    return sum + (branch.discountAmount || 0);
                } else {
                    const discount = (branch.grossSale || 0) * (branch.discountPercent || 0) / 100;
                    return sum + discount;
                }
            }, 0);
            // New formula: Discount % = (Discount Value / Gross Sale) * 100
            const grandTotalDiscountPercent = grandTotalGrossSale > 0 ? (grandTotalDiscountAmount / grandTotalGrossSale * 100) : 0;
            const grandTotalSaleValue = sortedBranches.reduce((sum, branch) => sum + (branch.saleValue || 0), 0);
            const grandTotalReturn = sortedBranches.reduce((sum, branch) => sum + (branch.returnAmount || 0), 0);
            const grandTotalGST = sortedBranches.reduce((sum, branch) => sum + (branch.gst || 0), 0);
            // New formula: Net Sale = Sale Value + GST
            const grandTotalNetSale = grandTotalSaleValue + grandTotalGST;
            
            // Add ONE grand total row at the end of the table (not repeated)
            const grandTotalRow = document.createElement('tr');
            grandTotalRow.className = 'table-warning fw-bold';
            grandTotalRow.style.backgroundColor = '#fff3cd';
            grandTotalRow.innerHTML = `
                <td class="text-center" colspan="2"><strong>Grand Total</strong></td>
                <td class="text-end"><strong>${grandTotalGrossSale.toLocaleString()}</strong></td>
                <td class="text-end"><strong>${grandTotalDiscountAmount.toLocaleString()}</strong></td>
                <td class="text-end"><strong>${grandTotalDiscountPercent.toFixed(2)}%</strong></td>
                <td class="text-end"><strong>${grandTotalReturn.toLocaleString()}</strong></td>
                <td class="text-end"><strong>${grandTotalSaleValue.toLocaleString()}</strong></td>
                <td class="text-end"><strong>${grandTotalGST.toLocaleString()}</strong></td>
                <td class="text-end text-success"><strong>${grandTotalNetSale.toLocaleString()}</strong></td>
            `;
            tableBody.appendChild(grandTotalRow);
        }
        
        // Helper function to get icon for category
        function getIconForCategory(categoryName) {
            const upperName = categoryName.toUpperCase();
            if (upperName.includes('COSMETICS') || upperName.includes('COSTMAIES')) {
                return 'fas fa-shopping-cart';
            } else if (upperName.includes('AIMS')) {
                return 'fas fa-pills';
            } else if (upperName.includes('NUTRA') || upperName.includes('NEUTRA')) {
                return 'fas fa-capsules';
            }
            return 'fas fa-tags'; // default icon
        }
        
        // Helper function to get color for category
        function getCategoryColor(index) {
            const colors = ['primary', 'success', 'info', 'warning', 'danger', 'secondary'];
            return colors[index % colors.length];
        }
        
        // ========================================
        // SALES FUNCTIONS
        // ========================================
        
        // Load sales list - Updated
        function loadSalesList(page = 1, perPage = 10) {
            // Get filter values
            const dateFrom = document.getElementById('salesListDateFrom').value;
            const dateTo = document.getElementById('salesListDateTo').value;
            const branchId = document.getElementById('salesListBranch').value;
            const categoryId = document.getElementById('salesListCategory').value;
            
            // Require at least one date to be selected before loading data
            if (!dateFrom && !dateTo) {
                // Clear/hide existing data
                const invoicesContainer = document.getElementById('salesInvoicesContainer');
                const salesTableBody = document.getElementById('salesListTableBody');
                const summarySection = document.getElementById('categorySummarySection');
                
                if (invoicesContainer) invoicesContainer.innerHTML = '<div class="text-center text-muted p-4">Please select at least one date (From or To) to view sales list</div>';
                if (salesTableBody) salesTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Please select at least one date (From or To) to view sales list</td></tr>';
                if (summarySection) summarySection.style.display = 'none';
                
                // Reset pagination
                const invoicesPagination = document.getElementById('salesInvoicesPagination');
                const listPagination = document.getElementById('salesListPagination');
                if (invoicesPagination) invoicesPagination.innerHTML = '';
                if (listPagination) listPagination.innerHTML = '';
                
                showNotification('Please select at least one date (From or To) to view sales list', 'info');
                return;
            }
            
            // Build filters object
            const filters = {};
            if (dateFrom) filters.from = dateFrom;
            if (dateTo) filters.to = dateTo;
            if (branchId) filters.branchId = branchId;
            if (categoryId) filters.categoryId = categoryId;
            
            // Fetch filtered sales data (only includes sales matching the date range and other filters)
            api.getSales(filters).then(salesData => {
                // Sort sales by date (newest first)
                const sortedSales = [...salesData].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Calculate pagination
                const startIndex = (page - 1) * perPage;
                const endIndex = startIndex + perPage;
                const paginatedSales = sortedSales.slice(startIndex, endIndex);
                
                // Load sales invoices (card view)
                loadSalesInvoices(paginatedSales);
                
                // Load sales table (table view)
                loadSalesTable(paginatedSales);
                
                // Load category-wise summary with filtered sales data (respects date range and filters)
                loadCategorySummary(salesData);
                
                // Update pagination
                updatePagination(sortedSales.length, page, perPage, 'salesInvoicesPagination', loadSalesList);
                updatePagination(sortedSales.length, page, perPage, 'salesListPagination', loadSalesList);
            }).catch(error => {
                console.error('Error loading sales list:', error);
                showNotification('Failed to load sales list', 'error');
            });
        }
        
        // Load sales invoices (card view) - New function
        function loadSalesInvoices(sales) {
            const container = document.getElementById('salesInvoicesContainer');
            container.innerHTML = '';
            
            const permissions = appData.currentUser?.permissions || [];
            const isAdmin = permissions.includes('admin');
            const canEditSale = isAdmin || permissions.includes('sales-edit');
            const canDeleteSale = isAdmin || permissions.includes('sales-delete');
            sales.forEach(sale => {
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4 mb-3';
                
                card.innerHTML = `
                    <div class="invoice-card">
                        <div class="invoice-header">
                            <span style="display: none;">Invoice #${sale._id}</span>
                            <span>${formatDate(sale.date)}</span>
                        </div>
                        <div class="invoice-body">
                            <div class="invoice-details">
                                <span class="invoice-detail-label">Branch:</span>
                                <span class="invoice-detail-value">${sale.branchId?.name || 'Unknown'}</span>
                            </div>
                            <div class="invoice-details">
                                <span class="invoice-detail-label">Category:</span>
                                <span class="invoice-detail-value">${sale.categoryId?.name || 'Unknown'}</span>
                            </div>
                            <div class="invoice-details">
                                <span class="invoice-detail-label">Sales:</span>
                                <span class="invoice-detail-value">${(sale.total || 0).toLocaleString()}</span>
                            </div>
                            <div class="invoice-details">
                                <span class="invoice-detail-label">Cost:</span>
                                <span class="invoice-detail-value">${(sale.costTotal || 0).toLocaleString()}</span>
                            </div>
                            <div class="invoice-details">
                                <span class="invoice-detail-label">Profit:</span>
                                <span class="invoice-detail-value ${sale.profit >= 0 ? 'text-success' : 'text-danger'}">
                                    ${(sale.profit || 0).toLocaleString()}
                                </span>
                            </div>
                            <div class="invoice-actions">
                                ${canEditSale ? `<button class="btn btn-sm btn-primary" onclick="editSale('${sale._id}')"><i class=\"fas fa-edit\"></i> Edit</button>` : ''}
                                ${canDeleteSale ? `<button class="btn btn-sm btn-danger" onclick="deleteSale('${sale._id}')"><i class=\"fas fa-trash\"></i> Delete</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Load category-wise summary with transaction details
        // IMPORTANT: This function uses the filtered sales data passed to it
        // The sales data is already filtered by date range (from/to), branch, and category
        function loadCategorySummary(sales) {
            const summarySection = document.getElementById('categorySummarySection');
            const summaryCards = document.getElementById('categorySummaryCards');
            
            // Don't show if no sales data
            if (!sales || sales.length === 0) {
                summarySection.style.display = 'none';
                return;
            }
            
            // Group sales by category with transaction details
            // Using ONLY the filtered sales data (already filtered by date range and other filters)
            const categoryData = {};
            
            appData.categories.forEach(category => {
                categoryData[category._id] = {
                    name: category.name,
                    sales: 0,
                    cost: 0,
                    profit: 0,
                    transactions: []
                };
            });
            
            // Sort sales by date (newest first) - using filtered data only
            const sortedSales = [...sales].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Calculate totals and collect transaction details for each category
            // Only processes sales within the selected date range and filters
            sortedSales.forEach(sale => {
                const categoryId = sale.categoryId?._id || sale.categoryId;
                if (categoryData[categoryId]) {
                    categoryData[categoryId].sales += sale.total || 0;
                    categoryData[categoryId].cost += sale.costTotal || 0;
                    categoryData[categoryId].profit += sale.profit || 0;
                    
                    // Add transaction details
                    categoryData[categoryId].transactions.push({
                        date: sale.date,
                        amount: sale.total || 0,
                        branch: sale.branchId?.name || 'Unknown',
                        profit: sale.profit || 0,
                        cost: sale.costTotal || 0
                    });
                }
            });
            
            // Show section if there's data
            const hasData = Object.values(categoryData).some(cat => cat.sales > 0);
            summarySection.style.display = hasData ? 'block' : 'none';
            
            if (!hasData) return;
            
            // Clear and populate summary cards
            summaryCards.innerHTML = '';
            
            Object.values(categoryData)
                .filter(cat => cat.sales > 0)
                .sort((a, b) => b.sales - a.sales)
                .forEach(category => {
                    const card = document.createElement('div');
                    card.className = 'col-12 mb-4';
                    card.innerHTML = `
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-primary text-white">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h6 class="mb-0"><i class="fas fa-folder me-2"></i>${category.name}</h6>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="badge bg-light text-dark">${category.transactions.length} Transactions</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Summary Stats -->
                                <div class="row mb-3 border-bottom pb-3">
                                    <div class="col-md-6 text-center">
                                        <small class="text-muted d-block">Total Sales</small>
                                        <strong class="text-success fs-5">${category.sales.toLocaleString()}</strong>
                                    </div>
                                    <div class="col-md-6 text-center">
                                        <small class="text-muted d-block">Total Cost</small>
                                        <strong class="text-danger fs-5">${category.cost.toLocaleString()}</strong>
                                    </div>
                                </div>
                                
                                <!-- Transaction Details -->
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Date</th>
                                                <th>Branch</th>
                                                <th class="text-end">Amount</th>
                                                <th class="text-end">Cost</th>
                                                <th class="text-end">Profit</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${category.transactions.map(trans => `
                                                <tr>
                                                    <td>${formatDate(trans.date)}</td>
                                                    <td>${trans.branch}</td>
                                                    <td class="text-end text-success">${trans.amount.toLocaleString()}</td>
                                                    <td class="text-end text-danger">${trans.cost.toLocaleString()}</td>
                                                    <td class="text-end ${trans.profit >= 0 ? 'text-success' : 'text-danger'}">
                                                        <strong>${trans.profit.toLocaleString()}</strong>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    summaryCards.appendChild(card);
                });
        }
        
        // Load sales table (table view) - New function
        function loadSalesTable(sales) {
            const tableBody = document.getElementById('salesListTableBody');
            tableBody.innerHTML = '';
            
            const permissions = appData.currentUser?.permissions || [];
            const isAdmin = permissions.includes('admin');
            const canEditSale = isAdmin || permissions.includes('sales-edit');
            const canDeleteSale = isAdmin || permissions.includes('sales-delete');
            
            sales.forEach(sale => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="display: none;">${sale._id}</td>
                    <td>${formatDate(sale.date)}</td>
                    <td>${sale.categoryId?.name || 'Unknown'}</td>
                    <td>${sale.branchId?.name || 'Unknown'}</td>
                    <td>${(sale.total || 0).toLocaleString()}</td>
                    <td>${(sale.costTotal || 0).toLocaleString()}</td>
                    <td class="${sale.profit >= 0 ? 'text-success' : 'text-danger'}">
                        ${(sale.profit || 0).toLocaleString()}
                    </td>
                    <td>
                        <div class="sales-list-actions">
                            ${canEditSale ? `<button class="btn btn-sm btn-primary" onclick="editSale('${sale._id}')"><i class=\"fas fa-edit\"></i></button>` : ''}
                            ${canDeleteSale ? `<button class="btn btn-sm btn-danger" onclick="deleteSale('${sale._id}')"><i class=\"fas fa-trash\"></i></button>` : ''}
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Update pagination
        function updatePagination(totalItems, currentPage, perPage, paginationId, callback, ...args) {
            const pagination = document.getElementById(paginationId);
            pagination.innerHTML = '';
            
            const totalPages = Math.ceil(totalItems / perPage);
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
            pagination.appendChild(prevLi);
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                    pagination.appendChild(li);
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(li);
                }
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
            pagination.appendChild(nextLi);
            
            // Add click event listeners
            pagination.querySelectorAll('.page-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    if (page > 0 && page <= totalPages) {
                        callback(...args, page, perPage);
                    }
                });
            });
        }
        
        // Initialize category-wise branch comparison chart
        let trendsChart = {};
        let branchChart = {};
        
        function initializeTrendsChart(tabPrefix = 'warehouse') {
            // Skip initialization for shop dashboard (chart removed)
            if (tabPrefix === 'shop') {
                return;
            }
            
            const chartElement = document.getElementById(`${tabPrefix}ComparisonChart`);
            if (!chartElement) {
                console.warn(`Chart container not found for ${tabPrefix}, skipping chart initialization`);
                return;
            }
            
            const ctx = chartElement.getContext('2d');
            const existingChart = Chart.getChart(`${tabPrefix}ComparisonChart`);
            if (existingChart) existingChart.destroy();
            
            trendsChart[tabPrefix] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: tabPrefix === 'shop' ? 'Branches' : 'Categories',
                                font: {
                                    size: window.innerWidth <= 576 ? 12 : 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                font: {
                                    size: window.innerWidth <= 576 ? 10 : 12
                                },
                                maxRotation: window.innerWidth <= 576 ? 45 : 0
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: tabPrefix === 'shop' ? 'Net Sale' : 'Sales',
                                font: {
                                    size: window.innerWidth <= 576 ? 12 : 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                font: {
                                    size: window.innerWidth <= 576 ? 10 : 12
                                },
                                callback: function(value) {
                                    if (window.innerWidth <= 576) {
                                        return value >= 1000000 ? (value/1000000).toFixed(1) + 'M' :
                                               value >= 1000 ? (value/1000).toFixed(1) + 'K' : value;
                                    }
                                    return value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: window.innerWidth <= 576 ? 11 : 13,
                                    weight: 'bold'
                                },
                                boxWidth: window.innerWidth <= 576 ? 14 : 18,
                                padding: window.innerWidth <= 576 ? 10 : 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: {
                                size: window.innerWidth <= 576 ? 12 : 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: window.innerWidth <= 576 ? 11 : 13
                            },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString();
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#000',
                            font: {
                                weight: 'bold',
                                size: window.innerWidth <= 576 ? 9 : 11
                            },
                            formatter: function(value) {
                                if (value === 0) return '';
                                return window.innerWidth <= 576 ? 
                                    (value >= 1000000 ? (value/1000000).toFixed(1) + 'M' :
                                     value >= 1000 ? (value/1000).toFixed(0) + 'K' : value) :
                                    value.toLocaleString();
                            }
                        }
                    },
                    layout: {
                        padding: window.innerWidth <= 576 ? 10 : 20
                    }
                }
            });
            
            // Auto-load chart data on initialization
            updateTrendsChart();
            
            // Add window resize listener for better mobile responsiveness
            window.addEventListener('resize', function() {
                // Update all chart instances
                Object.keys(trendsChart).forEach(tabPrefix => {
                    if (trendsChart[tabPrefix]) {
                    // Update chart options based on new screen size
                    const isMobile = window.innerWidth <= 576;
                        trendsChart[tabPrefix].options.scales.x.ticks.font.size = isMobile ? 10 : 12;
                        trendsChart[tabPrefix].options.scales.x.title.font.size = isMobile ? 12 : 14;
                        trendsChart[tabPrefix].options.scales.y.ticks.font.size = isMobile ? 10 : 12;
                        trendsChart[tabPrefix].options.scales.y.title.font.size = isMobile ? 12 : 14;
                        trendsChart[tabPrefix].options.scales.x.ticks.maxRotation = isMobile ? 45 : 0;
                        trendsChart[tabPrefix].options.plugins.legend.labels.font.size = isMobile ? 10 : 12;
                        trendsChart[tabPrefix].options.plugins.legend.labels.boxWidth = isMobile ? 12 : 15;
                        trendsChart[tabPrefix].options.plugins.legend.labels.padding = isMobile ? 8 : 12;
                        trendsChart[tabPrefix].options.plugins.tooltip.titleFont.size = isMobile ? 11 : 13;
                        trendsChart[tabPrefix].options.plugins.tooltip.bodyFont.size = isMobile ? 10 : 12;
                        trendsChart[tabPrefix].options.layout.padding = isMobile ? 10 : 20;
                    
                    // Update Y-axis tick callback for mobile
                        trendsChart[tabPrefix].options.scales.y.ticks.callback = function(value) {
                        if (isMobile) {
                            return value >= 1000000 ? (value/1000000).toFixed(1) + 'M' :
                                   value >= 1000 ? (value/1000).toFixed(1) + 'K' : value;
                        }
                        return value.toLocaleString();
                    };
                    
                        trendsChart[tabPrefix].update('resize');
                }
                });
                
                // Update branch chart instances
                Object.keys(branchChart).forEach(tabPrefix => {
                    if (branchChart[tabPrefix]) {
                        const isMobile = window.innerWidth <= 576;
                        branchChart[tabPrefix].options.scales.x.ticks.font.size = isMobile ? 10 : 12;
                        branchChart[tabPrefix].options.scales.x.title.font.size = isMobile ? 12 : 14;
                        branchChart[tabPrefix].options.scales.y.ticks.font.size = isMobile ? 10 : 12;
                        branchChart[tabPrefix].options.scales.y.title.font.size = isMobile ? 12 : 14;
                        branchChart[tabPrefix].options.scales.x.ticks.maxRotation = 0;
                        branchChart[tabPrefix].options.scales.x.ticks.minRotation = 0;
                        branchChart[tabPrefix].options.scales.x.ticks.autoSkip = false;
                        branchChart[tabPrefix].options.scales.x.ticks.stepSize = 1;
                        branchChart[tabPrefix].options.plugins.legend.labels.font.size = isMobile ? 10 : 12;
                        branchChart[tabPrefix].options.plugins.legend.labels.boxWidth = isMobile ? 12 : 15;
                        branchChart[tabPrefix].options.plugins.legend.labels.padding = isMobile ? 8 : 12;
                        branchChart[tabPrefix].options.plugins.tooltip.titleFont.size = isMobile ? 11 : 13;
                        branchChart[tabPrefix].options.plugins.tooltip.bodyFont.size = isMobile ? 10 : 12;
                        branchChart[tabPrefix].options.layout.padding = isMobile ? 10 : 20;
                        branchChart[tabPrefix].options.scales.y.ticks.callback = function(value) {
                            if (isMobile) {
                                return value >= 1000000 ? (value/1000000).toFixed(1) + 'M' :
                                       value >= 1000 ? (value/1000).toFixed(1) + 'K' : value;
                            }
                            return value.toLocaleString();
                        };
                        branchChart[tabPrefix].update('resize');
                    }
                });
            });
        }
        
        // Initialize branch-wise net sales comparison chart
        function initializeBranchChart(tabPrefix = 'shop') {
            const chartElement = document.getElementById(`${tabPrefix}BranchComparisonChart`);
            if (!chartElement) {
                console.warn(`Branch chart container not found for ${tabPrefix}, skipping chart initialization`);
                return;
            }
            
            const ctx = chartElement.getContext('2d');
            const existingChart = Chart.getChart(`${tabPrefix}BranchComparisonChart`);
            if (existingChart) existingChart.destroy();
            
            branchChart[tabPrefix] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Net Sale',
                        data: [],
                        backgroundColor: 'rgba(40, 167, 69, 0.8)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Branches',
                                font: {
                                    size: window.innerWidth <= 576 ? 12 : 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                font: {
                                    size: window.innerWidth <= 576 ? 9 : 10
                                },
                                maxRotation: 0, // Horizontal labels (no rotation)
                                minRotation: 0, // Keep labels horizontal
                                autoSkip: false, // Don't skip any labels - show all branch names
                                maxTicksLimit: undefined, // Show all labels without limit
                                stepSize: 1 // Show every label
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Net Sale',
                                font: {
                                    size: window.innerWidth <= 576 ? 12 : 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                font: {
                                    size: window.innerWidth <= 576 ? 10 : 12
                                },
                                callback: function(value) {
                                    if (window.innerWidth <= 576) {
                                        return value >= 1000000 ? (value/1000000).toFixed(1) + 'M' :
                                               value >= 1000 ? (value/1000).toFixed(1) + 'K' : value;
                                    }
                                    return value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: window.innerWidth <= 576 ? 11 : 13,
                                    weight: 'bold'
                                },
                                boxWidth: window.innerWidth <= 576 ? 14 : 18,
                                padding: window.innerWidth <= 576 ? 10 : 15
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.85)',
                            titleFont: {
                                size: window.innerWidth <= 576 ? 13 : 15,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: window.innerWidth <= 576 ? 11 : 13
                            },
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    return 'Branch Wise Net Sales Comparison';
                                },
                                label: function(context) {
                                    // Show all branches for comparison (sorted by ranking, but without rank number in display)
                                    const chart = context.chart;
                                    const labels = chart.data.labels;
                                    const data = chart.data.datasets[0].data;
                                    
                                    // Build comparison list of all branches
                                    const comparisonList = [];
                                    labels.forEach((label, index) => {
                                        const netSale = data[index];
                                        const isHovered = index === context.dataIndex;
                                        const prefix = isHovered ? ' ' : '  ';
                                        // Show only branch name and net sale (no ranking number)
                                        comparisonList.push(`${prefix}${label} : ${netSale.toLocaleString()}`);
                                    });
                                    
                                    return comparisonList;
                                },
                                filter: function() {
                                    // Show tooltip for all data points
                                    return true;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#000',
                            font: {
                                weight: 'bold',
                                size: window.innerWidth <= 576 ? 9 : 11
                            },
                            formatter: function(value) {
                                if (value === 0) return '';
                                return window.innerWidth <= 576 ? 
                                    (value >= 1000000 ? (value/1000000).toFixed(1) + 'M' :
                                     value >= 1000 ? (value/1000).toFixed(0) + 'K' : value) :
                                    value.toLocaleString();
                            }
                        }
                    },
                    layout: {
                        padding: window.innerWidth <= 576 ? 10 : 20
                    }
                }
            });
            
            // Auto-load chart data on initialization
            updateBranchChart(tabPrefix);
        }
        
        // Update branch-wise net sales comparison chart
        function updateBranchChart(tabPrefix = 'shop') {
            const branchSelector = document.getElementById(`${tabPrefix}CategoryBreakdownBranchFilter`);
            const branchFilter = branchSelector ? branchSelector.value : '';
            
            // Build filters object
            const filters = {};
            if (branchFilter) filters.branchId = branchFilter;
            
            // Get date range from dashboard filters (same as loadDashboard)
            const dateFilters = getDashboardDateFilters(tabPrefix);
            if (dateFilters.from) filters.from = dateFilters.from;
            if (dateFilters.to) filters.to = dateFilters.to;
            
            // Show loading state
            if (branchChart[tabPrefix]) {
                branchChart[tabPrefix].data.labels = ['Loading...'];
                branchChart[tabPrefix].data.datasets = [{
                    label: 'Loading...',
                    data: [0],
                    backgroundColor: 'rgba(128, 128, 128, 0.5)'
                }];
                branchChart[tabPrefix].update();
            }
            
            // Fetch department sales data
            api.getDepartmentSales(filters).then(filteredData => {
                // Group sales by branch and calculate net sale totals
                const branchData = {};
                
                // Initialize branches
                (appData.branches || []).forEach(branch => {
                    branchData[branch._id] = {
                        name: branch.name,
                        netSale: 0
                    };
                });
                
                // Process each sale
                filteredData.forEach(sale => {
                    const branchId = sale.branchId?._id || sale.branchId;
                    if (branchData[branchId]) {
                        branchData[branchId].netSale += sale.netSale || 0;
                    }
                });
                
                // Prepare chart data - branches as labels, net sales as values
                const branches = Object.values(branchData)
                    .filter(branch => branch.netSale > 0)
                    .sort((a, b) => b.netSale - a.netSale); // Sort by net sale descending (ranking sequence)
                
                const labels = branches.map(branch => branch.name);
                const netSales = branches.map(branch => branch.netSale);
                
                // Define different colors for each branch (rainbow/gradient colors)
                const branchColors = [
                    'rgba(40, 167, 69, 0.8)',   // Green
                    'rgba(23, 162, 184, 0.8)',  // Blue
                    'rgba(255, 193, 7, 0.8)',   // Yellow
                    'rgba(111, 66, 193, 0.8)',  // Purple
                    'rgba(253, 126, 20, 0.8)',  // Orange
                    'rgba(220, 53, 69, 0.8)',   // Red
                    'rgba(20, 162, 184, 0.8)',  // Teal
                    'rgba(108, 117, 125, 0.8)', // Gray
                    'rgba(0, 123, 255, 0.8)',   // Primary Blue
                    'rgba(40, 167, 69, 0.8)',   // Success Green
                    'rgba(255, 193, 7, 0.8)',  // Warning Yellow
                    'rgba(220, 53, 69, 0.8)'   // Danger Red
                ];
                
                const borderColors = [
                    'rgba(40, 167, 69, 1)',
                    'rgba(23, 162, 184, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(111, 66, 193, 1)',
                    'rgba(253, 126, 20, 1)',
                    'rgba(220, 53, 69, 1)',
                    'rgba(20, 162, 184, 1)',
                    'rgba(108, 117, 125, 1)',
                    'rgba(0, 123, 255, 1)',
                    'rgba(40, 167, 69, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(220, 53, 69, 1)'
                ];
                
                // Create array of colors for each bar
                const backgroundColors = branches.map((branch, index) => branchColors[index % branchColors.length]);
                const borderColorsArray = branches.map((branch, index) => borderColors[index % borderColors.length]);
                
                // Update chart
                if (branchChart[tabPrefix]) {
                    branchChart[tabPrefix].data.labels = labels;
                    branchChart[tabPrefix].data.datasets = [{
                        label: 'Net Sale',
                        data: netSales,
                        backgroundColor: backgroundColors,
                        borderColor: borderColorsArray,
                        borderWidth: 2
                    }];
                    branchChart[tabPrefix].update('active');
                }
            }).catch(error => {
                console.error(' Error updating branch chart:', error);
                showNotification('Failed to update branch chart: ' + error.message, 'error');
                
                // Show error state in chart
                if (branchChart[tabPrefix]) {
                    branchChart[tabPrefix].data.labels = ['Error loading data'];
                    branchChart[tabPrefix].data.datasets = [{
                        label: 'Error',
                        data: [0],
                        backgroundColor: 'rgba(220, 53, 69, 0.5)'
                    }];
                    branchChart[tabPrefix].update();
                }
            });
        }
        
        // Helper function to get date filters from dashboard (same logic as loadDashboard)
        function getDashboardDateFilters(tabPrefix = 'warehouse') {
            // Format dates as YYYY-MM-DD for API
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            // Check for date range filter (priority over month filter)
            const dateRangeFilter = document.getElementById(`${tabPrefix}DashboardDateRangeFilter`)?.value || 'currentMonth';
            const monthHiddenInput = document.getElementById(`${tabPrefix}DashboardMonthFilter`);
            const effectiveMonth = monthHiddenInput?.value || '';

            let referenceDate = new Date();
            if (effectiveMonth) {
                const [refYear, refMonth] = effectiveMonth.split('-').map(Number);
                if (!Number.isNaN(refYear) && !Number.isNaN(refMonth)) {
                    referenceDate = new Date(refYear, refMonth - 1, 1);
                }
            }

            const monthStart = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), 1);
            monthStart.setHours(0, 0, 0, 0);
            const monthEnd = new Date(referenceDate.getFullYear(), referenceDate.getMonth() + 1, 0);
            monthEnd.setHours(23, 59, 59, 999);

            let dateFrom = null;
            let dateTo = null;

            // Calculate date range based on filter
            if (dateRangeFilter === 'custom') {
                dateFrom = document.getElementById(`${tabPrefix}DashboardTopDateFrom`)?.value || null;
                dateTo = document.getElementById(`${tabPrefix}DashboardTopDateTo`)?.value || null;
            } else if (dateRangeFilter === 'weekly') {
                // 1st Week of selected month (Days 1-7)
                const weekStart = new Date(monthStart);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                if (weekEnd > monthEnd) {
                    weekEnd.setTime(monthEnd.getTime());
                }
                dateFrom = formatDate(weekStart);
                dateTo = formatDate(weekEnd);
            } else if (dateRangeFilter === 'first15') {
                // First 15 days of selected month
                const firstDay = new Date(monthStart);
                const fifteenthDay = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), 15);
                fifteenthDay.setHours(23, 59, 59, 999);
                dateFrom = formatDate(firstDay);
                dateTo = formatDate(fifteenthDay > monthEnd ? monthEnd : fifteenthDay);
            } else if (dateRangeFilter === 'last15') {
                // Last 15 days of selected month (from 16th to end of month)
                const sixteenthDay = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), 16);
                sixteenthDay.setHours(0, 0, 0, 0);
                const lastDay = new Date(monthEnd);
                dateFrom = formatDate(sixteenthDay < monthStart ? monthStart : sixteenthDay);
                dateTo = formatDate(lastDay);
            } else {
                // Entire selected month
                dateFrom = formatDate(monthStart);
                dateTo = formatDate(monthEnd);
            }
            
            return { from: dateFrom, to: dateTo };
        }
        
        // Update category/department-wise branch comparison chart
        function updateTrendsChart(tabPrefix = 'warehouse') {
            // Skip update for shop dashboard (chart removed)
            if (tabPrefix === 'shop') {
                return;
            }
            
            const branchSelector = document.getElementById(`${tabPrefix}CategoryBreakdownBranchFilter`);
            const branchFilter = branchSelector ? branchSelector.value : '';
            
            // Build filters object
            const filters = {};
            if (branchFilter) filters.branchId = branchFilter;
            
            // Get date range from dashboard filters (same as loadDashboard)
            const dateFilters = getDashboardDateFilters(tabPrefix);
            if (dateFilters.from) filters.from = dateFilters.from;
            if (dateFilters.to) filters.to = dateFilters.to;
            
            
            // Show loading state
            if (trendsChart[tabPrefix]) {
                trendsChart[tabPrefix].data.labels = ['Loading...'];
                trendsChart[tabPrefix].data.datasets = [{
                    label: 'Loading...',
                    data: [0],
                    backgroundColor: 'rgba(128, 128, 128, 0.5)'
                }];
                trendsChart[tabPrefix].update();
            }
            
            // Warehouse Dashboard: Use regular sales
            // Fetch filtered sales data
            api.getSales(filters).then(filteredData => {
                
                // Group sales by category and branch
                const categoryBranchData = {};
                
                // Initialize categories
                    (appData.categories || []).forEach(category => {
                    categoryBranchData[category._id] = {
                        name: category.name,
                        branches: {}
                    };
                    
                    // Initialize branches for this category
                        (appData.branches || []).forEach(branch => {
                        categoryBranchData[category._id].branches[branch._id] = {
                            name: branch.name,
                            totalSales: 0
                        };
                    });
                });
                
                // Process each sale
                filteredData.forEach(sale => {
                    const categoryId = sale.categoryId?._id || sale.categoryId;
                    const branchId = sale.branchId?._id || sale.branchId;
                    
                    if (categoryBranchData[categoryId] && categoryBranchData[categoryId].branches[branchId]) {
                        categoryBranchData[categoryId].branches[branchId].totalSales += sale.total || 0;
                    }
                });
                
                // Prepare chart data - categories as labels, showing total sales per branch
                const categories = Object.values(categoryBranchData).filter(cat => 
                    Object.values(cat.branches).some(branch => branch.totalSales > 0)
                );
                
                const labels = categories.map(cat => cat.name);
                
                // Create datasets for each branch (showing total sales per category)
                const branchColors = [
                    'rgba(40, 167, 69, 0.8)',   // Green
                    'rgba(23, 162, 184, 0.8)',  // Blue
                    'rgba(255, 193, 7, 0.8)',   // Yellow
                    'rgba(111, 66, 193, 0.8)',  // Purple
                    'rgba(253, 126, 20, 0.8)',  // Orange
                    'rgba(20, 162, 184, 0.8)',  // Teal
                ];
                
                const datasets = [];
                let colorIndex = 0;
                
                // Create a dataset for each branch showing only total sales
                    (appData.branches || []).forEach(branch => {
                    // Calculate total sales for this branch across all categories
                    const branchTotalData = categories.map(cat => {
                        return cat.branches[branch._id]?.totalSales || 0;
                    });
                    
                    // Only include branch if it has sales in any category
                    if (branchTotalData.some(sales => sales > 0)) {
                        datasets.push({
                            label: branch.name,
                            data: branchTotalData,
                            backgroundColor: branchColors[colorIndex % branchColors.length],
                            borderColor: branchColors[colorIndex % branchColors.length].replace('0.8', '1'),
                            borderWidth: 2,
                            maxBarThickness: 50
                        });
                        colorIndex++;
                    }
                });
                
                // Update chart
                    if (trendsChart && trendsChart[tabPrefix]) {
                    trendsChart[tabPrefix].data.labels = labels;
                    trendsChart[tabPrefix].data.datasets = datasets;
                        trendsChart[tabPrefix].update('active');
                }
            }).catch(error => {
                console.error(' Error updating trends chart:', error);
                showNotification('Failed to update trends chart: ' + error.message, 'error');
                
                // Show error state in chart
                    if (trendsChart && trendsChart[tabPrefix]) {
                    trendsChart[tabPrefix].data.labels = ['Error loading data'];
                    trendsChart[tabPrefix].data.datasets = [{
                        label: 'Error',
                        data: [0],
                        backgroundColor: 'rgba(220, 53, 69, 0.5)'
                    }];
                    trendsChart[tabPrefix].update();
                }
            });
        }
        
        // Load branch-wise comparison table for shop dashboard
        // Load Shop Dashboard Department-Wise Report (grouped by branch)
        function loadShopDashboardDeptWiseReport(departmentSales = null) {
            const tablesContainer = document.getElementById('shopDashboardDeptWiseReportTablesContainer');
            if (!tablesContainer) {
                return;
            }
            
            // Use provided data or get from appData
            const data = departmentSales || appData.departmentSales || [];
            
            if (!data || data.length === 0) {
                tablesContainer.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-info-circle me-2"></i>No sales data available</div>';
                return;
            }
            
            // Get date filters from main dashboard
            const dateFrom = document.getElementById('shopDashboardTopDateFrom')?.value || '';
            const dateTo = document.getElementById('shopDashboardTopDateTo')?.value || '';
            
            // Filter data by date range if dates are provided
            let filteredData = data;
            if (dateFrom || dateTo) {
                filteredData = data.filter(sale => {
                    if (!sale.date) return false;
                    const saleDate = new Date(sale.date);
                    const saleDateStr = saleDate.toISOString().split('T')[0];
                    
                    if (dateFrom && dateTo) {
                        return saleDateStr >= dateFrom && saleDateStr <= dateTo;
                    } else if (dateFrom) {
                        return saleDateStr >= dateFrom;
                    } else if (dateTo) {
                        return saleDateStr <= dateTo;
                    }
                    return true;
                });
            }
            
            // Calculate unique dates for daily average
            const uniqueDates = new Set();
            filteredData.forEach(sale => {
                if (sale.date) {
                    const saleDate = new Date(sale.date);
                    const dateString = saleDate.toISOString().split('T')[0];
                    uniqueDates.add(dateString);
                }
            });
            const numberOfDays = uniqueDates.size > 0 ? uniqueDates.size : 1;
            
            // Group by branch, then by department
            const branchDeptData = {};
            
            filteredData.forEach(sale => {
                const branchId = sale.branchId?._id || sale.branchId;
                const branchName = sale.branchId?.name || 'Unknown';
                const deptId = sale.departmentId?._id || sale.departmentId;
                const deptName = sale.departmentId?.name || 'Unknown';
                
                if (!branchDeptData[branchId]) {
                    branchDeptData[branchId] = {
                        name: branchName,
                        departments: {}
                    };
                }
                
                if (!branchDeptData[branchId].departments[deptId]) {
                    branchDeptData[branchId].departments[deptId] = {
                        name: deptName,
                        grossSale: 0,
                        discountAmount: 0,
                        returnAmount: 0,
                        gst: 0,
                        netSale: 0
                    };
                }
                
                branchDeptData[branchId].departments[deptId].grossSale += sale.grossSale || 0;
                branchDeptData[branchId].departments[deptId].discountAmount += sale.discountAmount || 0;
                branchDeptData[branchId].departments[deptId].returnAmount += sale.returnAmount || 0;
                branchDeptData[branchId].departments[deptId].gst += sale.gst || 0;
                branchDeptData[branchId].departments[deptId].netSale += sale.netSale || 0;
            });
            
            // Clear container
            tablesContainer.innerHTML = '';
            
            // Calculate branch totals for sorting
            const branchesWithTotals = Object.values(branchDeptData).map(branch => {
                // Calculate total net sale for this branch
                const branchNetSale = Object.values(branch.departments).reduce((total, dept) => {
                    return total + (dept.netSale || 0);
                }, 0);
                
                return {
                    ...branch,
                    totalNetSale: branchNetSale
                };
            });
            
            // Sort branches by net sale (highest to lowest), then by name if equal
            const sortedBranches = branchesWithTotals.sort((a, b) => {
                if (b.totalNetSale !== a.totalNetSale) {
                    return b.totalNetSale - a.totalNetSale; // Descending order (highest first)
                }
                return a.name.localeCompare(b.name); // If net sale is equal, sort by name
            });
            
            // Calculate grand totals across all branches and departments
            let grandTotalGrossSale = 0;
            let grandTotalDiscount = 0;
            let grandTotalReturn = 0;
            let grandTotalGST = 0;
            let grandTotalNetSale = 0;
            
            // Create separate scrollable table for each branch
            sortedBranches.forEach((branch, branchIndex) => {
                const departments = Object.values(branch.departments);
                
                if (departments.length === 0) return;
                
                // Create branch container with branch name heading
                const branchContainer = document.createElement('div');
                branchContainer.className = 'mb-4';
                
                // Branch name heading
                const branchHeading = document.createElement('h4');
                branchHeading.className = 'text-center mb-3';
                branchHeading.style.cssText = 'font-weight: 600; background-color: #2c6e8a; color: white; padding: 10px; border-radius: 5px;';
                branchHeading.textContent = branch.name;
                branchContainer.appendChild(branchHeading);
                
                // Create scrollable table wrapper for this branch
                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'table-responsive';
                tableWrapper.style.cssText = 'overflow-x: auto; -webkit-overflow-scrolling: touch;';
                
                // Create table for this branch
                const branchTable = document.createElement('table');
                branchTable.className = 'table table-hover';
                branchTable.style.cssText = 'min-width: 100%; white-space: nowrap;';
                
                // Create table header
                const tableHeader = document.createElement('thead');
                const headerRow = document.createElement('tr');
                headerRow.style.backgroundColor = '#f8f9fa';
                headerRow.innerHTML = `
                    <th style="background-color: #f8f9fa; font-weight: 600; padding: 10px; white-space: nowrap;">Department</th>
                    <th class="text-end" style="background-color: #f8f9fa; font-weight: 600; padding: 10px; white-space: nowrap;">Gross Sale</th>
                    <th class="text-end" style="background-color: #f8f9fa; font-weight: 600; padding: 10px; white-space: nowrap;">Discount Value</th>
                    <th class="text-end" style="background-color: #f8f9fa; font-weight: 600; padding: 10px; white-space: nowrap;">Discount %</th>
                    <th class="text-end" style="background-color: #f8f9fa; font-weight: 600; padding: 10px; white-space: nowrap;">Return</th>
                    <th class="text-end" style="background-color: #f8f9fa; font-weight: 600; padding: 10px; white-space: nowrap;">Sale Value</th>
                    <th class="text-end" style="background-color: #f8f9fa; font-weight: 600; padding: 10px; white-space: nowrap;">GST</th>
                    <th class="text-end" style="background-color: #f8f9fa; font-weight: 600; padding: 10px; white-space: nowrap;">Net Sale</th>
                    <th class="text-end" style="background-color: #f8f9fa; font-weight: 600; padding: 10px; white-space: nowrap;">Daily Sale Average</th>
                `;
                tableHeader.appendChild(headerRow);
                branchTable.appendChild(tableHeader);
                
                // Create table body
                const branchTableBody = document.createElement('tbody');
                
                // Sort departments by name
                const sortedDepartments = departments.sort((a, b) => a.name.localeCompare(b.name));
                
                // Calculate branch totals
                let branchTotalGrossSale = 0;
                let branchTotalDiscount = 0;
                let branchTotalReturn = 0;
                let branchTotalGST = 0;
                let branchTotalNetSale = 0;
                
                // Add department rows
                sortedDepartments.forEach(dept => {
                    const discountPercent = dept.grossSale > 0 ? (dept.discountAmount / dept.grossSale * 100) : 0;
                    const saleValue = dept.grossSale - dept.discountAmount - dept.returnAmount;
                    const dailyAverage = numberOfDays > 0 ? dept.netSale / numberOfDays : 0;
                    
                    // Accumulate branch totals
                    branchTotalGrossSale += dept.grossSale;
                    branchTotalDiscount += dept.discountAmount;
                    branchTotalReturn += dept.returnAmount;
                    branchTotalGST += dept.gst;
                    branchTotalNetSale += dept.netSale;
                    
                    // Accumulate overall totals
                    grandTotalGrossSale += dept.grossSale;
                    grandTotalDiscount += dept.discountAmount;
                    grandTotalReturn += dept.returnAmount;
                    grandTotalGST += dept.gst;
                    grandTotalNetSale += dept.netSale;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="white-space: nowrap;">${dept.name}</td>
                        <td class="text-end" style="white-space: nowrap;">${dept.grossSale.toLocaleString()}</td>
                        <td class="text-end" style="white-space: nowrap;">${dept.discountAmount.toLocaleString()}</td>
                        <td class="text-end" style="white-space: nowrap;">${discountPercent.toFixed(2)}%</td>
                        <td class="text-end" style="white-space: nowrap;">${dept.returnAmount.toLocaleString()}</td>
                        <td class="text-end" style="white-space: nowrap;">${saleValue.toLocaleString()}</td>
                        <td class="text-end" style="white-space: nowrap;">${dept.gst.toLocaleString()}</td>
                        <td class="text-end" style="font-weight: 700; white-space: nowrap;">${dept.netSale.toLocaleString()}</td>
                        <td class="text-end" style="white-space: nowrap;">${Math.round(dailyAverage).toLocaleString()}</td>
                    `;
                    branchTableBody.appendChild(row);
                });
                
                // Add branch grand total row
                const branchDiscountPercent = branchTotalGrossSale > 0 ? (branchTotalDiscount / branchTotalGrossSale * 100) : 0;
                const branchSaleValue = branchTotalGrossSale - branchTotalDiscount - branchTotalReturn;
                const branchDailyAverage = numberOfDays > 0 ? branchTotalNetSale / numberOfDays : 0;
                
                const branchGrandTotalRow = document.createElement('tr');
                branchGrandTotalRow.className = 'branch-total-row';
                branchGrandTotalRow.style.backgroundColor = '#2c6e8a';
                branchGrandTotalRow.style.fontWeight = '700';
                branchGrandTotalRow.innerHTML = `
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; font-size: 1.05em; white-space: nowrap;">${branch.name} - Grand Total</td>
                    <td class="text-end" style="background-color: #2c6e8a; color: white; font-weight: 700; font-size: 1.05em; white-space: nowrap;">${branchTotalGrossSale.toLocaleString()}</td>
                    <td class="text-end" style="background-color: #2c6e8a; color: white; font-weight: 700; font-size: 1.05em; white-space: nowrap;">${branchTotalDiscount.toLocaleString()}</td>
                    <td class="text-end" style="background-color: #2c6e8a; color: white; font-weight: 700; font-size: 1.05em; white-space: nowrap;">${branchDiscountPercent.toFixed(2)}%</td>
                    <td class="text-end" style="background-color: #2c6e8a; color: white; font-weight: 700; font-size: 1.05em; white-space: nowrap;">${branchTotalReturn.toLocaleString()}</td>
                    <td class="text-end" style="background-color: #2c6e8a; color: white; font-weight: 700; font-size: 1.05em; white-space: nowrap;">${branchSaleValue.toLocaleString()}</td>
                    <td class="text-end" style="background-color: #2c6e8a; color: white; font-weight: 700; font-size: 1.05em; white-space: nowrap;">${branchTotalGST.toLocaleString()}</td>
                    <td class="text-end" style="background-color: #2c6e8a; color: white; font-weight: 700; font-size: 1.05em; white-space: nowrap;">${branchTotalNetSale.toLocaleString()}</td>
                    <td class="text-end" style="background-color: #2c6e8a; color: white; font-weight: 700; font-size: 1.05em; white-space: nowrap;">${Math.round(branchDailyAverage).toLocaleString()}</td>
                `;
                branchTableBody.appendChild(branchGrandTotalRow);
                
                // Append table body to table
                branchTable.appendChild(branchTableBody);
                
                // Append table to wrapper
                tableWrapper.appendChild(branchTable);
                
                // Append wrapper to branch container
                branchContainer.appendChild(tableWrapper);
                
                // Append branch container to main container
                tablesContainer.appendChild(branchContainer);
            });
            
            // Add overall grand total table if there's data (hidden on mobile)
            if (sortedBranches.length > 0 && grandTotalGrossSale > 0) {
                const grandTotalDiscountPercent = grandTotalGrossSale > 0 ? (grandTotalDiscount / grandTotalGrossSale * 100) : 0;
                const grandTotalSaleValue = grandTotalGrossSale - grandTotalDiscount - grandTotalReturn;
                const grandTotalDailyAverage = numberOfDays > 0 ? grandTotalNetSale / numberOfDays : 0;
                
                // Create grand total container (hidden on mobile)
                const grandTotalContainer = document.createElement('div');
                grandTotalContainer.className = 'mb-4 d-none d-md-block';
                
                // Create scrollable table wrapper for grand total
                const grandTotalTableWrapper = document.createElement('div');
                grandTotalTableWrapper.className = 'table-responsive';
                grandTotalTableWrapper.style.cssText = 'overflow-x: auto; -webkit-overflow-scrolling: touch;';
                
                // Create grand total table
                const grandTotalTable = document.createElement('table');
                grandTotalTable.className = 'table table-hover';
                grandTotalTable.style.cssText = 'min-width: 100%; white-space: nowrap;';
                
                const grandTotalTableBody = document.createElement('tbody');
                const grandTotalRow = document.createElement('tr');
                grandTotalRow.className = 'table-warning fw-bold';
                grandTotalRow.style.backgroundColor = '#fff3cd';
                grandTotalRow.innerHTML = `
                    <td class="text-center" colspan="1" style="white-space: nowrap;"><strong><i class="fas fa-calculator me-2"></i>Grand Total</strong></td>
                    <td class="text-end" style="white-space: nowrap;"><strong>${grandTotalGrossSale.toLocaleString()}</strong></td>
                    <td class="text-end" style="white-space: nowrap;"><strong>${grandTotalDiscount.toLocaleString()}</strong></td>
                    <td class="text-end" style="white-space: nowrap;"><strong>${grandTotalDiscountPercent.toFixed(2)}%</strong></td>
                    <td class="text-end" style="white-space: nowrap;"><strong>${grandTotalReturn.toLocaleString()}</strong></td>
                    <td class="text-end" style="white-space: nowrap;"><strong>${grandTotalSaleValue.toLocaleString()}</strong></td>
                    <td class="text-end" style="white-space: nowrap;"><strong>${grandTotalGST.toLocaleString()}</strong></td>
                    <td class="text-end text-success" style="white-space: nowrap;"><strong>${grandTotalNetSale.toLocaleString()}</strong></td>
                    <td class="text-end" style="white-space: nowrap;"><strong>${Math.round(grandTotalDailyAverage).toLocaleString()}</strong></td>
                `;
                grandTotalTableBody.appendChild(grandTotalRow);
                grandTotalTable.appendChild(grandTotalTableBody);
                grandTotalTableWrapper.appendChild(grandTotalTable);
                grandTotalContainer.appendChild(grandTotalTableWrapper);
                tablesContainer.appendChild(grandTotalContainer);
            }
            
            if (sortedBranches.length === 0) {
                tablesContainer.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-info-circle me-2"></i>No data available for the selected filters</div>';
            }
        }
        
        function loadBranchWiseComparisonTable(tabPrefix = 'shop') {
            const tableBody = document.getElementById(`${tabPrefix}BranchWiseComparisonTableBody`);
            if (!tableBody) {
                console.warn(`Branch comparison table body not found for ${tabPrefix}`);
                return;
            }
            
            // Check if data exists
            if (!appData.departmentSales || appData.departmentSales.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">No sales data available. Please add sales data first.</td></tr>';
                return;
            }
            
            // Calculate number of days with actual sales (count unique sale dates across all branches)
            // Get all unique dates from sales data
            const uniqueSaleDates = new Set();
            appData.departmentSales.forEach(sale => {
                if (sale.date) {
                    // Extract date part only (YYYY-MM-DD) to count unique days
                    const saleDate = new Date(sale.date);
                    const dateString = saleDate.toISOString().split('T')[0];
                    uniqueSaleDates.add(dateString);
                }
            });
            
            const numberOfDays = uniqueSaleDates.size > 0 ? uniqueSaleDates.size : 1; // Use actual days with sales
            
            // Group sales by branch and calculate totals (same logic as branch cards)
            const branchData = {};
            
            // Initialize branches
            (appData.branches || []).forEach(branch => {
                branchData[branch._id] = {
                    name: branch.name,
                    grossSale: 0,
                    discountAmount: 0,
                    saleValue: 0,
                    returnAmount: 0,
                    gst: 0,
                    netSale: 0
                };
            });
            
            // Process each sale - sum all sales for each branch
            appData.departmentSales.forEach(sale => {
                const branchId = sale.branchId?._id || sale.branchId;
                if (branchData[branchId]) {
                    branchData[branchId].grossSale += sale.grossSale || 0;
                    branchData[branchId].discountAmount += sale.discountAmount || 0;
                    branchData[branchId].returnAmount += sale.returnAmount || 0;
                    branchData[branchId].gst += sale.gst || 0;
                }
            });
            
            // Calculate Sale Value and Net Sale for each branch using totals
            Object.keys(branchData).forEach(branchId => {
                const branch = branchData[branchId];
                // Branch Wise Sale Comparison formula: Sale Value = Gross Sale - Discount Value - Return
                branch.saleValue = branch.grossSale - branch.discountAmount - branch.returnAmount;
                // Branch Wise Sale Comparison formula: Net Sale = Sale Value + GST
                branch.netSale = branch.saleValue + branch.gst;
            });
            
            // Convert to array and filter branches with sales, then sort by net sale descending
            const branchesWithSales = Object.values(branchData)
                .filter(branch => branch.netSale > 0 || branch.grossSale > 0)
                .sort((a, b) => b.netSale - a.netSale);
            
            // Clear table body
            tableBody.innerHTML = '';
            
            if (branchesWithSales.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">No sales data available for any branch.</td></tr>';
                return;
            }
            
            // Calculate grand totals
            const grandTotalGrossSale = branchesWithSales.reduce((sum, branch) => sum + branch.grossSale, 0);
            const grandTotalDiscountAmount = branchesWithSales.reduce((sum, branch) => sum + branch.discountAmount, 0);
            // Discount % = (Discount Value / Gross Sale) * 100
            const grandTotalDiscountPercent = grandTotalGrossSale > 0 ? (grandTotalDiscountAmount / grandTotalGrossSale * 100) : 0;
            const grandTotalReturn = branchesWithSales.reduce((sum, branch) => sum + branch.returnAmount, 0);
            // Branch Wise Sale Comparison formula: Sale Value = Gross Sale - Discount Value - Return
            const grandTotalSaleValue = grandTotalGrossSale - grandTotalDiscountAmount - grandTotalReturn;
            const grandTotalGST = branchesWithSales.reduce((sum, branch) => sum + branch.gst, 0);
            // Branch Wise Sale Comparison formula: Net Sale = Sale Value + GST
            const grandTotalNetSale = grandTotalSaleValue + grandTotalGST;
            const grandTotalDailyAverage = numberOfDays > 0 ? grandTotalNetSale / numberOfDays : 0;
            
            // Populate table rows
            branchesWithSales.forEach((branch, index) => {
                const rank = index + 1;
                const discountPercent = branch.grossSale > 0 ? (branch.discountAmount / branch.grossSale * 100) : 0;
                const dailyAverage = numberOfDays > 0 ? branch.netSale / numberOfDays : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-center"><strong>${rank}</strong></td>
                    <td><strong>${branch.name}</strong></td>
                    <td class="text-end">${branch.grossSale.toLocaleString()}</td>
                    <td class="text-end">${branch.discountAmount.toLocaleString()}</td>
                    <td class="text-end">${discountPercent.toFixed(2)}%</td>
                    <td class="text-end">${branch.returnAmount.toLocaleString()}</td>
                    <td class="text-end">${branch.saleValue.toLocaleString()}</td>
                    <td class="text-end">${branch.gst.toLocaleString()}</td>
                    <td class="text-end text-success"><strong>${branch.netSale.toLocaleString()}</strong></td>
                    <td class="text-end"><strong>${Math.round(dailyAverage).toLocaleString()}</strong></td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add grand total row
            const grandTotalRow = document.createElement('tr');
            grandTotalRow.className = 'table-warning fw-bold';
            grandTotalRow.style.backgroundColor = '#fff3cd';
            grandTotalRow.innerHTML = `
                <td class="text-center" colspan="2"><strong><i class="fas fa-calculator me-2"></i>Grand Total</strong></td>
                <td class="text-end"><strong>${grandTotalGrossSale.toLocaleString()}</strong></td>
                <td class="text-end"><strong>${grandTotalDiscountAmount.toLocaleString()}</strong></td>
                <td class="text-end"><strong>${grandTotalDiscountPercent.toFixed(2)}%</strong></td>
                <td class="text-end"><strong>${grandTotalReturn.toLocaleString()}</strong></td>
                <td class="text-end"><strong>${grandTotalSaleValue.toLocaleString()}</strong></td>
                <td class="text-end"><strong>${grandTotalGST.toLocaleString()}</strong></td>
                <td class="text-end text-success"><strong>${grandTotalNetSale.toLocaleString()}</strong></td>
                <td class="text-end"><strong>${Math.round(grandTotalDailyAverage).toLocaleString()}</strong></td>
            `;
            tableBody.appendChild(grandTotalRow);
        }
        
        // Calculate sales totals - Make globally accessible
        window.calculateSalesTotals = function calculateSalesTotals() {
            let totalSales = 0;
            let totalCost = 0;
            
            // Find all category sales and cost inputs
            const salesInputs = document.querySelectorAll('.category-sales');
            const costInputs = document.querySelectorAll('.category-cost');
            
            salesInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                totalSales += value;
            });
            
            costInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                totalCost += value;
            });
            
            const totalProfit = totalSales - totalCost;
            
            // Update total fields
            const totalSalesEl = document.getElementById('totalSales');
            const totalCostEl = document.getElementById('totalCost');
            const totalProfitEl = document.getElementById('totalProfit');
            
            if (totalSalesEl) {
                totalSalesEl.value = totalSales.toFixed(2);
            }
            if (totalCostEl) {
                totalCostEl.value = totalCost.toFixed(2);
            }
            if (totalProfitEl) {
                totalProfitEl.value = totalProfit.toFixed(2);
            }
            
            console.log(' Calculated totals - Sales:', totalSales, 'Cost:', totalCost, 'Profit:', totalProfit);
        };
        
        // Save sales entry
        function saveSalesEntry() {
            const date = document.getElementById('saleDate').value;
            const branchId = document.getElementById('saleBranch').value;
            const notes = document.getElementById('saleNotes').value;
            if (typeof showNotification === 'function') {
                showNotification('Saving sales...', 'info');
            }
            
            // Check branch first (most important validation)
            if (!branchId || branchId === '') {
                showNotification('Please select a branch before saving', 'error');
                document.getElementById('saleBranch').focus();
                return;
            }
            
            if (!date) {
                showNotification('Please select a date before saving', 'error');
                document.getElementById('saleDate').focus();
                return;
            }
            
            // Create sales entries for each category
            const salesPromises = [];
            
            document.querySelectorAll('.category-sales').forEach(input => {
                const categoryId = input.getAttribute('data-category');
                const sales = parseFloat(input.value) || 0;
                const costInput = document.querySelector(`.category-cost[data-category="${categoryId}"]`);
                const cost = parseFloat(costInput.value) || 0;
                
                if (sales > 0) {
                    const saleData = {
                        date: date,
                        branchId: branchId,
                        categoryId: categoryId,
                        total: sales,
                        costTotal: cost,
                        profit: sales - cost,
                        notes: notes
                    };
                    
                    salesPromises.push(api.createSale(saleData));
                }
            });
            
            // Wait for all sales to be created
            Promise.all(salesPromises).then(() => {
                document.getElementById('salesEntryForm').reset();
                document.getElementById('totalSales').value = '';
                document.getElementById('totalCost').value = '';
                document.getElementById('totalProfit').value = '';
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('saleDate').value = today;
                showNotification('Sales entry saved successfully!', 'success');
                if (document.getElementById('dashboard-section').classList.contains('active')) {
                    loadDashboard();
                }
                // Keep user on sales entry; do not auto-open list after save
            }).catch(error => {
                console.error('Error saving sales entry:', error);
                showNotification('Failed to save sales entry', 'error');
            });
        }
        
        // Edit sale
        function editSale(id) {
            const permissions = appData.currentUser?.permissions || [];
            const isAdmin = permissions.includes('admin');
            if (!isAdmin && !permissions.includes('sales-edit')) {
                showNotification("You don't have permission to edit sales", 'error');
                return;
            }
            api.getSales().then(salesData => {
                const sale = salesData.find(s => s._id === id);
                if (sale) {
                    // Populate form with sale data
                    document.getElementById('editSaleId').value = sale._id;
                    document.getElementById('editSaleDate').value = formatDateForInput(sale.date);
                    document.getElementById('editSaleBranch').value = sale.branchId._id;
                    document.getElementById('editSaleCategory').value = sale.categoryId._id;
                    document.getElementById('editSaleAmount').value = sale.total || 0;
                    document.getElementById('editSaleCost').value = sale.costTotal || 0;
                    document.getElementById('editSaleNotes').value = sale.notes || '';
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('editSaleModal'));
                    modal.show();
                }
            }).catch(error => {
                console.error('Error fetching sale data:', error);
                showNotification('Failed to load sale data', 'error');
            });
        }
        
        // Update sale
        function updateSale() {
            const id = document.getElementById('editSaleId').value;
            const saleData = {
                date: document.getElementById('editSaleDate').value,
                branchId: document.getElementById('editSaleBranch').value,
                categoryId: document.getElementById('editSaleCategory').value,
                total: parseFloat(document.getElementById('editSaleAmount').value) || 0,
                costTotal: parseFloat(document.getElementById('editSaleCost').value) || 0,
                profit: parseFloat(document.getElementById('editSaleAmount').value) - parseFloat(document.getElementById('editSaleCost').value),
                notes: document.getElementById('editSaleNotes').value
            };
            
            api.updateSale(id, saleData).then(() => {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('editSaleModal')).hide();
                
                // Show notification
                showNotification('Sale updated successfully!', 'success');
                
                // Refresh sales list if it's visible
                if (document.getElementById('salesInvoicesContainer').children.length > 0) {
                    loadSalesList();
                }
                
                // Update dashboard if we're on dashboard
                if (document.getElementById('dashboard-section').classList.contains('active')) {
                    loadDashboard();
                }
            }).catch(error => {
                console.error('Error updating sale:', error);
                showNotification('Failed to update sale', 'error');
            });
        }
        
        // Delete sale
        function deleteSale(id) {
            const permissions = appData.currentUser?.permissions || [];
            const isAdmin = permissions.includes('admin');
            if (!isAdmin && !permissions.includes('sales-delete')) {
                showNotification("You don't have permission to delete sales", 'error');
                return;
            }
            if (confirm('Are you sure you want to delete this sale?')) {
                api.deleteSale(id).then(() => {
                    showNotification('Sale deleted successfully!', 'success');
                    
                    // Refresh sales list if it's visible
                    if (document.getElementById('salesInvoicesContainer').children.length > 0) {
                        loadSalesList();
                    }
                    
                    // Update dashboard if we're on dashboard
                    if (document.getElementById('dashboard-section').classList.contains('active')) {
                        loadDashboard();
                    }
                }).catch(error => {
                    console.error('Error deleting sale:', error);
                    showNotification('Failed to delete sale', 'error');
                });
            }
        }
        
        // ========================================
        // DEPARTMENT SALES FUNCTIONS
        // ========================================
        
        // Load departments for sales when branch is selected
        function loadDepartmentsForSales() {
            const branchId = document.getElementById('deptSaleBranch').value;
            const departmentSelect = document.getElementById('deptSaleDepartment');
            const subDeptSelect = document.getElementById('deptSaleSubDepartment');
            
            if (!branchId) {
                departmentSelect.innerHTML = '<option value="" selected disabled>Select Department</option>';
                subDeptSelect.innerHTML = '<option value="" selected disabled>Select Sub-Department</option>';
                subDeptSelect.disabled = true;
                return;
            }
            
            const deptPromise = branchId ? api.getDepartments(branchId) : api.getDepartments();
            deptPromise.then(departments => {
                departmentSelect.innerHTML = '<option value="" selected disabled>Select Department</option>';
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept._id;
                    option.textContent = dept.name;
                    departmentSelect.appendChild(option);
                });
            }).catch(error => {
                console.error('Error loading departments:', error);
                showNotification('Failed to load departments', 'error');
            });
        }
        
        // Load sub-departments when department is selected
        function loadSubDepartmentsForSales() {
            const departmentId = document.getElementById('deptSaleDepartment').value;
            const subDeptSelect = document.getElementById('deptSaleSubDepartment');
            
            if (!departmentId) {
                subDeptSelect.innerHTML = '<option value="" selected disabled>Select Sub-Department</option>';
                subDeptSelect.disabled = true;
                return;
            }
            
            subDeptSelect.disabled = false;
            subDeptSelect.innerHTML = '<option value="" selected disabled>Loading...</option>';
            
            api.getSubDepartmentsByDepartment(departmentId).then(subDepts => {
                subDeptSelect.innerHTML = '<option value="" selected disabled>Select Sub-Department</option>';
                subDepts.forEach(subDept => {
                    const option = document.createElement('option');
                    option.value = subDept._id;
                    option.textContent = subDept.name;
                    subDeptSelect.appendChild(option);
                });
            }).catch(error => {
                console.error('Error loading sub-departments:', error);
                showNotification('Failed to load sub-departments', 'error');
                subDeptSelect.innerHTML = '<option value="" selected disabled>Select Sub-Department</option>';
            });
        }
        
        // Load departments for Department Sales List filter when branch is selected
        function loadDepartmentsForDeptSalesList() {
            const branchId = document.getElementById('deptSalesListBranch')?.value || '';
            const departmentSelect = document.getElementById('deptSalesListDepartment');
            
            if (!departmentSelect) return;
            
            if (!branchId || branchId === '') {
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                return;
            }
            
            // Show loading state
            departmentSelect.innerHTML = '<option value="">Loading departments...</option>';
            departmentSelect.disabled = true;
            
            api.getDepartments(branchId).then(departments => {
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept._id;
                    option.textContent = dept.name;
                    departmentSelect.appendChild(option);
                });
                departmentSelect.disabled = false;
            }).catch(error => {
                console.error('Error loading departments for filter:', error);
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                departmentSelect.disabled = false;
                showNotification('Failed to load departments', 'error');
            });
        }
        
        // ========================================
        // DEPARTMENT MANAGEMENT FUNCTIONS
        // ========================================
        
        function loadDepartmentBranches() {
            const hasToken = !!localStorage.getItem('authToken');
            if (!hasToken) { return; }
            console.log(' Loading department branches...');
            api.getBranches().then(allBranches => {
                console.log(' All branches loaded:', allBranches?.length || 0, 'items');
                // Ensure array
                if (!Array.isArray(allBranches)) {
                    allBranches = [];
                }
                // Filter branches based on user's allowed branches
                let userBranches = allBranches;
                if (appData.currentUser && appData.currentUser.branches && appData.currentUser.branches.length > 0) {
                    const userBranchIds = appData.currentUser.branches.map(b => b._id || b);
                    userBranches = allBranches.filter(branch => userBranchIds.includes(branch._id));
                    console.log(' Filtered user branches:', userBranches.length, 'items');
                }
                
                const branchFilter = document.getElementById('departmentBranchFilter');
                const departmentBranchId = document.getElementById('departmentBranchId');
                
                // Clear existing options except the first one
                if (branchFilter) {
                    branchFilter.innerHTML = '<option value="">-- Select Branch --</option>';
                    userBranches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch._id;
                        option.textContent = branch.name;
                        branchFilter.appendChild(option);
                    });
                }
                
                // Populate branch dropdown in modal (only user's allowed branches)
                if (departmentBranchId) {
                    departmentBranchId.innerHTML = '<option value="">-- Select Branch --</option>';
                    userBranches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch._id;
                        option.textContent = branch.name;
                        departmentBranchId.appendChild(option);
                    });
                }
            }).catch(error => {
                console.error('Error loading branches:', error);
                showNotification('Failed to load branches', 'error');
            });
        }
        
        function loadDepartments(branchId = null) {
            if (!branchId) {
                branchId = document.getElementById('departmentBranchFilter')?.value;
            }
            
            if (!branchId) {
                // Clear departments if no branch selected
                const container = document.getElementById('departmentsContainer');
                const tableBody = document.getElementById('departmentsTableBody');
                if (container) {
                    container.innerHTML = '<div class="col-12"><p class="text-muted text-center">Please select a branch to view departments</p></div>';
                }
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Please select a branch to view departments</td></tr>';
                }
                return;
            }
            
            console.log(' Loading departments for branch:', branchId);
            api.getDepartments(branchId).then(async departmentsData => {
                console.log(' Departments loaded:', departmentsData?.length || 0, 'items');
                // Ensure array
                if (!Array.isArray(departmentsData)) {
                    departmentsData = [];
                }
                // Load sub-departments for each department
                for (let dept of departmentsData) {
                    try {
                        const subDepts = await api.getSubDepartmentsByDepartment(dept._id);
                        dept.subDepartments = subDepts || [];
                    } catch (error) {
                        console.error(`Error loading sub-departments for ${dept.name}:`, error);
                        dept.subDepartments = [];
                    }
                }
                appData.departments = departmentsData;
                renderDepartments(departmentsData);
            }).catch(error => {
                console.error('Error loading departments:', error);
                showNotification('Failed to load departments', 'error');
            });
        }
        
        function renderDepartments(departmentsData) {
            // Ensure we have an array
            if (!Array.isArray(departmentsData)) {
                departmentsData = [];
            }
            
            const sortedDepartments = [...departmentsData].sort((a, b) => {
                const seqA = a.sequence !== undefined ? a.sequence : 0;
                const seqB = b.sequence !== undefined ? b.sequence : 0;
                if (seqA !== seqB) return seqA - seqB;
                return new Date(a.createdAt) - new Date(b.createdAt);
            });
            
            // Render card view
            const cardContainer = document.getElementById('departmentsContainer');
            if (!cardContainer) return;
            
            cardContainer.innerHTML = '';
            
            // Show empty state if no departments
            if (sortedDepartments.length === 0) {
                cardContainer.innerHTML = '<div class="col-12"><div class="alert alert-info text-center">No departments found for this branch. Click "Add Department" to create one.</div></div>';
                const tableBody = document.getElementById('departmentsTableBody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No departments found</td></tr>';
                }
                return;
            }
            
            sortedDepartments.forEach((department, index) => {
                const card = document.createElement('div');
                card.className = 'col-md-4 mb-3';
                const departmentNumber = index + 1;
                const subDeptCount = department.subDepartments ? department.subDepartments.length : 0;
                
                card.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${department.name}</h5>
                                <span class="badge bg-primary">#${departmentNumber}</span>
                            </div>
                            <div class="mb-2">
                                <p class="card-text text-muted mb-2">${department.description || 'No description'}</p>
                                <small class="text-muted">
                                    <i class="fas fa-layer-group me-1"></i>${subDeptCount} Sub-Department${subDeptCount !== 1 ? 's' : ''}
                                </small>
                            </div>
                            <div class="mb-3">
                                <button class="btn btn-sm btn-info w-100 mb-2" onclick="viewSubDepartments('${department._id}', '${department.name}')">
                                    <i class="fas fa-list"></i> View Sub-Departments
                                </button>
                                <button class="btn btn-sm btn-success w-100 mb-2" onclick="addSubDepartment('${department._id}', '${department.name}')">
                                    <i class="fas fa-plus"></i> Add Sub-Department
                                </button>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-primary" onclick="editDepartment('${department._id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteDepartment('${department._id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                cardContainer.appendChild(card);
            });
            
            // Render table view
            const tableBody = document.getElementById('departmentsTableBody');
            if (tableBody) {
                tableBody.innerHTML = '';
                
                sortedDepartments.forEach((department, index) => {
                    const row = document.createElement('tr');
                    const createdDate = new Date(department.createdAt).toLocaleDateString();
                    const departmentNumber = index + 1;
                    const subDeptCount = department.subDepartments ? department.subDepartments.length : 0;
                    
                    row.innerHTML = `
                        <td>
                            <span class="badge bg-secondary">${department.sequence !== undefined ? department.sequence : 0}</span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-primary me-2">#${departmentNumber}</span>
                                <strong>${department.name}</strong>
                            </div>
                        </td>
                        <td>${department.description || 'No description'}</td>
                        <td>
                            <span class="badge bg-info">${subDeptCount} Sub-Department${subDeptCount !== 1 ? 's' : ''}</span>
                            <button class="btn btn-sm btn-link p-0 ms-2" onclick="viewSubDepartments('${department._id}', '${department.name}')" title="View Sub-Departments">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                        <td>${createdDate}</td>
                        <td>
                            <button class="btn btn-sm btn-success me-2" onclick="addSubDepartment('${department._id}', '${department.name}')" title="Add Sub-Department">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="editDepartment('${department._id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDepartment('${department._id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }
        
        function saveDepartment() {
            const branchId = document.getElementById('departmentBranchId').value;
            if (!branchId) {
                showNotification('Please select a branch', 'error');
                return;
            }
            
            const departmentData = {
                name: document.getElementById('departmentName').value,
                branchId: branchId,
                description: document.getElementById('departmentDescription').value
            };
            
            api.createDepartment(departmentData).then(() => {
                const modalElement = document.getElementById('addDepartmentModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
                
                // Clean up any modal backdrops that might remain
                setTimeout(() => {
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                    // Also remove modal-open class from body if it exists
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }, 100);
                
                document.getElementById('departmentForm').reset();
                const branchSelect = document.getElementById('departmentBranchId');
                if (branchSelect) branchSelect.disabled = false;
                document.getElementById('addDepartmentModalLabel').textContent = 'Add New Department';
                showNotification('Department saved successfully!', 'success');
                
                // Reload departments for the selected branch
                const selectedBranchId = document.getElementById('departmentBranchFilter').value;
                loadDepartments(selectedBranchId);
            }).catch(error => {
                console.error('Error saving department:', error);
                const errorMsg = error.message || 'Failed to save department';
                showNotification(errorMsg.includes('already exists') ? errorMsg : 'Failed to save department', 'error');
            });
        }
        
        function editDepartment(id) {
            api.getDepartment(id).then(async department => {
                if (department) {
                    // Get all branches and filter by user's allowed branches
                    const allBranches = await api.getBranches();
                    let userBranches = allBranches;
                    if (appData.currentUser && appData.currentUser.branches && appData.currentUser.branches.length > 0) {
                        const userBranchIds = appData.currentUser.branches.map(b => b._id || b);
                        userBranches = allBranches.filter(branch => userBranchIds.includes(branch._id));
                    }
                    
                    // Populate branch dropdown (only user's allowed branches)
                    const branchSelect = document.getElementById('departmentBranchId');
                    if (!branchSelect) {
                        console.error('departmentBranchId element not found');
                        showNotification('Department modal form not found', 'error');
                        return;
                    }
                    branchSelect.innerHTML = '<option value="">-- Select Branch --</option>';
                    userBranches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch._id;
                        option.textContent = branch.name;
                        if (branch._id === department.branchId._id || branch._id === department.branchId) {
                            option.selected = true;
                        }
                        branchSelect.appendChild(option);
                    });
                    branchSelect.disabled = false; // Allow changing branch when editing
                    
                    const deptNameInput = document.getElementById('departmentName');
                    const deptDescInput = document.getElementById('departmentDescription');
                    const modalLabel = document.getElementById('addDepartmentModalLabel');
                    
                    if (deptNameInput) deptNameInput.value = department.name;
                    if (deptDescInput) deptDescInput.value = department.description || '';
                    const deptSeqInput = document.getElementById('departmentSequence');
                    if (deptSeqInput) deptSeqInput.value = department.sequence !== undefined ? department.sequence : 0;
                    if (modalLabel) modalLabel.textContent = 'Edit Department';
                    
                    const saveBtn = document.getElementById('saveDepartmentBtn');
                    if (saveBtn) {
                        saveBtn.textContent = 'Update Department';
                        saveBtn.onclick = null;
                        saveBtn.onclick = function() {
                            const form = document.getElementById('departmentForm');
                            if (form && form.checkValidity()) {
                                updateDepartment(id);
                            } else if (form) {
                                form.reportValidity();
                            }
                        };
                    }
                    
                    const modalElement = document.getElementById('addDepartmentModal');
                    if (modalElement) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                    } else {
                        showNotification('Department modal not found', 'error');
                    }
                }
            }).catch(error => {
                console.error('Error fetching department:', error);
                showNotification('Failed to load department data', 'error');
            });
        }
        
        function updateDepartment(id) {
            const branchId = document.getElementById('departmentBranchId').value;
            if (!branchId) {
                showNotification('Please select a branch', 'error');
                return;
            }
            
            const departmentData = {
                name: document.getElementById('departmentName').value,
                branchId: branchId,
                description: document.getElementById('departmentDescription').value,
                sequence: parseInt(document.getElementById('departmentSequence').value) || 0
            };
            
            api.updateDepartment(id, departmentData).then(() => {
                const modalElement = document.getElementById('addDepartmentModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
                
                // Clean up any modal backdrops that might remain
                setTimeout(() => {
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                    // Also remove modal-open class from body if it exists
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }, 100);
                
                document.getElementById('departmentForm').reset();
                const branchSelect = document.getElementById('departmentBranchId');
                if (branchSelect) branchSelect.disabled = false;
                document.getElementById('addDepartmentModalLabel').textContent = 'Add New Department';
                
                const saveBtn = document.getElementById('saveDepartmentBtn');
                saveBtn.textContent = 'Save Department';
                saveBtn.onclick = saveDepartment;
                
                showNotification('Department updated successfully!', 'success');
                
                // Reload departments for the selected branch
                const selectedBranchId = document.getElementById('departmentBranchFilter').value;
                loadDepartments(selectedBranchId);
            }).catch(error => {
                console.error('Error updating department:', error);
                const errorMsg = error.message || 'Failed to update department';
                showNotification(errorMsg.includes('already exists') ? errorMsg : 'Failed to update department', 'error');
            });
        }
        
        function deleteDepartment(id) {
            api.getDepartment(id).then(async dept => {
                const subDeptCount = dept.subDepartments ? dept.subDepartments.length : 0;
                if (subDeptCount > 0) {
                    showNotification(`Cannot delete department. It has ${subDeptCount} sub-department(s). Please delete sub-departments first.`, 'error');
                    return;
                }
                
                if (confirm('Are you sure you want to delete this department?')) {
                    api.deleteDepartment(id).then(() => {
                        showNotification('Department deleted successfully!', 'success');
                        loadDepartments();
                    }).catch(error => {
                        console.error('Error deleting department:', error);
                        showNotification(error.message || 'Failed to delete department', 'error');
                    });
                }
            }).catch(error => {
                console.error('Error fetching department:', error);
                if (confirm('Are you sure you want to delete this department?')) {
                    api.deleteDepartment(id).then(() => {
                        showNotification('Department deleted successfully!', 'success');
                        loadDepartments();
                    }).catch(err => {
                        console.error('Error deleting department:', err);
                        showNotification(err.message || 'Failed to delete department', 'error');
                    });
                }
            });
        }
        
        function addSubDepartment(departmentId, departmentName) {
            // Get department details to get branchId
            api.getDepartment(departmentId).then(department => {
                const branchId = department.branchId._id || department.branchId;
                
                // Show department name prominently
                const infoAlert = document.getElementById('subDepartmentInfoAlert');
                const displayName = document.getElementById('subDepartmentDisplayName');
                const departmentSelectWrapper = document.getElementById('subDepartmentDepartmentSelectWrapper');
                
                if (infoAlert && displayName) {
                    displayName.textContent = departmentName;
                    infoAlert.style.display = 'block';
                    if (departmentSelectWrapper) {
                        departmentSelectWrapper.style.display = 'none'; // Hide dropdown since department is pre-selected
                    }
                }
                
                // Populate department dropdown (only departments from same branch) - hidden but needed for form
                const selectedBranchId = document.getElementById('departmentBranchFilter').value;
                api.getDepartments(selectedBranchId || branchId).then(departments => {
                    const select = document.getElementById('subDepartmentDepartmentId');
                    select.innerHTML = '<option value="">Select Department</option>';
                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept._id;
                        option.textContent = dept.name;
                        if (dept._id === departmentId) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    
                    // Store branchId in a hidden field or data attribute
                    select.setAttribute('data-branch-id', branchId);
                    
                    // Reset form
                    document.getElementById('subDepartmentName').value = '';
                    document.getElementById('subDepartmentDescription').value = '';
                    document.getElementById('addSubDepartmentModalLabel').textContent = `Add Sub-Department`;
                    
                    const saveBtn = document.getElementById('saveSubDepartmentBtn');
                    saveBtn.textContent = 'Save Sub-Department';
                    saveBtn.onclick = null;
                    saveBtn.onclick = saveSubDepartment;
                    
                    // Check if viewSubDepartmentsModal is open and handle modal stacking
                    const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewSubDepartmentsModal'));
                    const viewModalElement = document.getElementById('viewSubDepartmentsModal');
                    let shouldReopenViewModal = false;
                    
                    if (viewModal && viewModalElement) {
                        // Store that we need to reopen the view modal
                        shouldReopenViewModal = true;
                        // Hide the view modal temporarily to allow the add modal to show on top
                        viewModal.hide();
                    }
                    
                    // Wait a bit for the first modal to hide, then show the add modal
                    setTimeout(() => {
                        const modal = new bootstrap.Modal(document.getElementById('addSubDepartmentModal'), {
                            backdrop: true,
                            keyboard: true
                        });
                        modal.show();
                        
                        // When add modal is closed, reopen the view modal if it was open
                        if (shouldReopenViewModal && viewModalElement) {
                            const addModalElement = document.getElementById('addSubDepartmentModal');
                            addModalElement.addEventListener('hidden.bs.modal', function reopenViewModal() {
                                setTimeout(() => {
                                    if (viewModalElement && !bootstrap.Modal.getInstance(viewModalElement)) {
                                        const newViewModal = new bootstrap.Modal(viewModalElement);
                                        newViewModal.show();
                                    }
                                }, 100);
                                // Remove listener after use
                                addModalElement.removeEventListener('hidden.bs.modal', reopenViewModal);
                            }, { once: true });
                        }
                    }, 150);
                }).catch(error => {
                    console.error('Error loading departments:', error);
                    showNotification('Failed to load departments', 'error');
                });
            }).catch(error => {
                console.error('Error loading department:', error);
                showNotification('Failed to load department data', 'error');
            });
        }
        
        function saveSubDepartment() {
            const departmentId = document.getElementById('subDepartmentDepartmentId').value;
            if (!departmentId) {
                showNotification('Please select a department', 'error');
                return;
            }
            
            // Get branchId from the department
            const branchId = document.getElementById('subDepartmentDepartmentId').getAttribute('data-branch-id');
            if (!branchId) {
                // Fallback: get from department
                api.getDepartment(departmentId).then(dept => {
                    const branchIdFromDept = dept.branchId._id || dept.branchId;
                    createSubDepartmentWithBranch(departmentId, branchIdFromDept);
                }).catch(error => {
                    console.error('Error getting department:', error);
                    showNotification('Failed to get department information', 'error');
                });
                return;
            }
            
            createSubDepartmentWithBranch(departmentId, branchId);
        }
        
        function createSubDepartmentWithBranch(departmentId, branchId) {
            const subDepartmentData = {
                name: document.getElementById('subDepartmentName').value,
                departmentId: departmentId,
                branchId: branchId,
                description: document.getElementById('subDepartmentDescription').value,
                sequence: parseInt(document.getElementById('subDepartmentSequence').value) || 0
            };
            
            api.createSubDepartment(subDepartmentData).then(() => {
                const modalElement = document.getElementById('addSubDepartmentModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
                
                // Clean up any modal backdrops that might remain
                setTimeout(() => {
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                    // Also remove modal-open class from body if it exists
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }, 100);
                
                document.getElementById('subDepartmentForm').reset();
                const departmentSelect = document.getElementById('subDepartmentDepartmentId');
                if (departmentSelect) {
                    departmentSelect.disabled = false;
                    departmentSelect.removeAttribute('data-branch-id');
                }
                const infoAlert = document.getElementById('subDepartmentInfoAlert');
                const departmentSelectWrapper = document.getElementById('subDepartmentDepartmentSelectWrapper');
                if (infoAlert) infoAlert.style.display = 'none';
                if (departmentSelectWrapper) departmentSelectWrapper.style.display = 'block';
                document.getElementById('addSubDepartmentModalLabel').textContent = 'Add New Sub-Department';
                showNotification('Sub-department saved successfully!', 'success');
                
                // Reload departments for the selected branch
                const selectedBranchId = document.getElementById('departmentBranchFilter').value;
                loadDepartments(selectedBranchId);
            }).catch(error => {
                console.error('Error saving sub-department:', error);
                const errorMsg = error.message || 'Failed to save sub-department';
                showNotification(errorMsg.includes('already exists') ? errorMsg : 'Failed to save sub-department', 'error');
            });
        }
        
        function viewSubDepartments(departmentId, departmentName) {
            api.getSubDepartmentsByDepartment(departmentId).then(subDepts => {
                let content = `<h5>Sub-Departments in ${departmentName}</h5>`;
                if (subDepts.length === 0) {
                    content += '<p class="text-muted">No sub-departments found. Click "Add Sub-Department" to create one.</p>';
                } else {
                    // Sort sub-departments by sequence
                    const sortedSubDepts = [...subDepts].sort((a, b) => {
                        const seqA = a.sequence !== undefined ? a.sequence : 0;
                        const seqB = b.sequence !== undefined ? b.sequence : 0;
                        if (seqA !== seqB) return seqA - seqB;
                        return a.name.localeCompare(b.name);
                    });
                    content += '<ul class="list-group">';
                    sortedSubDepts.forEach((subDept, index) => {
                        content += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${subDept.name}</strong>
                                    ${subDept.description ? `<br><small class="text-muted">${subDept.description}</small>` : ''}
                                    <br><small class="text-muted"><i class="fas fa-sort-numeric-up me-1"></i>Sequence: ${subDept.sequence !== undefined ? subDept.sequence : 0}</small>
                                </div>
                                <div>
                                    <span class="badge bg-secondary rounded-pill me-2">Seq: ${subDept.sequence !== undefined ? subDept.sequence : 0}</span>
                                    <span class="badge bg-primary rounded-pill me-2">#${index + 1}</span>
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="editSubDepartment('${subDept._id}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSubDepartment('${subDept._id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </li>
                        `;
                    });
                    content += '</ul>';
                }
                content += `<div class="mt-3">
                    <button class="btn btn-success" onclick="addSubDepartment('${departmentId}', '${departmentName}')">
                        <i class="fas fa-plus"></i> Add Sub-Department
                    </button>
                </div>`;
                
                const modalBody = document.getElementById('viewSubDepartmentsModalBody');
                const modalElement = document.getElementById('viewSubDepartmentsModal');
                if (modalBody && modalElement) {
                    // Check if modal is already open
                    const existingModal = bootstrap.Modal.getInstance(modalElement);
                    const isModalOpen = existingModal && modalElement.classList.contains('show');
                    
                    // Update content
                    modalBody.innerHTML = content;
                    // Store department info in data attributes for easy access
                    modalElement.setAttribute('data-department-id', departmentId);
                    modalElement.setAttribute('data-department-name', departmentName);
                    
                    if (isModalOpen) {
                        // Modal is already open, just update content - don't create new instance
                        // Content is already updated above
                    } else {
                        // Modal is not open, create new instance and show
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                    }
                } else {
                    console.error('View sub-departments modal elements not found');
                    showNotification('Modal elements not found', 'error');
                }
            }).catch(error => {
                console.error('Error loading sub-departments:', error);
                showNotification('Failed to load sub-departments', 'error');
            });
        }
        
        function editSubDepartment(id) {
            api.getSubDepartment(id).then(async subDept => {
                if (!subDept) {
                    showNotification('Sub-department not found', 'error');
                    return;
                }
                
                const branchId = subDept.branchId._id || subDept.branchId;
                const departmentId = subDept.departmentId._id || subDept.departmentId;
                
                // Get department name
                let departmentName = 'Unknown Department';
                try {
                    const department = await api.getDepartment(departmentId);
                    departmentName = department.name;
                } catch (error) {
                    console.error('Error fetching department:', error);
                }
                
                // Show department name prominently
                const infoAlert = document.getElementById('subDepartmentInfoAlert');
                const displayName = document.getElementById('subDepartmentDisplayName');
                const departmentSelectWrapper = document.getElementById('subDepartmentDepartmentSelectWrapper');
                
                if (infoAlert && displayName) {
                    displayName.textContent = departmentName;
                    infoAlert.style.display = 'block';
                    if (departmentSelectWrapper) {
                        departmentSelectWrapper.style.display = 'none';
                    }
                }
                
                // Populate department dropdown
                const departments = await api.getDepartments(branchId);
                const select = document.getElementById('subDepartmentDepartmentId');
                if (select) {
                    select.innerHTML = '<option value="">Select Department</option>';
                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept._id;
                        option.textContent = dept.name;
                        if (dept._id === departmentId) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    select.setAttribute('data-branch-id', branchId);
                }
                
                // Populate form fields
                const nameInput = document.getElementById('subDepartmentName');
                const descInput = document.getElementById('subDepartmentDescription');
                const seqInput = document.getElementById('subDepartmentSequence');
                if (nameInput) nameInput.value = subDept.name || '';
                if (descInput) descInput.value = subDept.description || '';
                if (seqInput) seqInput.value = subDept.sequence !== undefined ? subDept.sequence : 0;
                
                document.getElementById('addSubDepartmentModalLabel').textContent = 'Edit Sub-Department';
                
                const saveBtn = document.getElementById('saveSubDepartmentBtn');
                if (saveBtn) {
                    saveBtn.textContent = 'Update Sub-Department';
                    saveBtn.onclick = null;
                    saveBtn.onclick = function() {
                        if (document.getElementById('subDepartmentForm').checkValidity()) {
                            updateSubDepartment(id);
                        } else {
                            document.getElementById('subDepartmentForm').reportValidity();
                        }
                    };
                }
                
                // Hide view modal if open
                const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewSubDepartmentsModal'));
                if (viewModal) {
                    viewModal.hide();
                }
                
                // Show edit modal
                setTimeout(() => {
                    const modalElement = document.getElementById('addSubDepartmentModal');
                    if (modalElement) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                    }
                }, 150);
            }).catch(error => {
                console.error('Error fetching sub-department:', error);
                showNotification('Failed to load sub-department data', 'error');
            });
        }
        
        function updateSubDepartment(id) {
            const departmentId = document.getElementById('subDepartmentDepartmentId').value;
            if (!departmentId) {
                showNotification('Please select a department', 'error');
                return;
            }
            
            const branchId = document.getElementById('subDepartmentDepartmentId').getAttribute('data-branch-id');
            if (!branchId) {
                api.getDepartment(departmentId).then(dept => {
                    const branchIdFromDept = dept.branchId._id || dept.branchId;
                    updateSubDepartmentWithBranch(id, departmentId, branchIdFromDept);
                }).catch(error => {
                    console.error('Error getting department:', error);
                    showNotification('Failed to get department information', 'error');
                });
                return;
            }
            
            updateSubDepartmentWithBranch(id, departmentId, branchId);
        }
        
        function updateSubDepartmentWithBranch(id, departmentId, branchId) {
            const subDepartmentData = {
                name: document.getElementById('subDepartmentName').value,
                departmentId: departmentId,
                branchId: branchId,
                description: document.getElementById('subDepartmentDescription').value,
                sequence: parseInt(document.getElementById('subDepartmentSequence').value) || 0
            };
            
            api.updateSubDepartment(id, subDepartmentData).then(() => {
                const modalElement = document.getElementById('addSubDepartmentModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
                
                // Clean up any modal backdrops that might remain
                setTimeout(() => {
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                    // Also remove modal-open class from body if it exists
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }, 100);
                
                document.getElementById('subDepartmentForm').reset();
                const departmentSelect = document.getElementById('subDepartmentDepartmentId');
                if (departmentSelect) {
                    departmentSelect.disabled = false;
                    departmentSelect.removeAttribute('data-branch-id');
                }
                const infoAlert = document.getElementById('subDepartmentInfoAlert');
                const departmentSelectWrapper = document.getElementById('subDepartmentDepartmentSelectWrapper');
                if (infoAlert) infoAlert.style.display = 'none';
                if (departmentSelectWrapper) departmentSelectWrapper.style.display = 'block';
                document.getElementById('addSubDepartmentModalLabel').textContent = 'Add New Sub-Department';
                
                const saveBtn = document.getElementById('saveSubDepartmentBtn');
                if (saveBtn) {
                    saveBtn.textContent = 'Save Sub-Department';
                    saveBtn.onclick = saveSubDepartment;
                }
                
                showNotification('Sub-department updated successfully!', 'success');
                
                // Reload departments for the selected branch
                const selectedBranchId = document.getElementById('departmentBranchFilter').value;
                loadDepartments(selectedBranchId);
            }).catch(error => {
                console.error('Error updating sub-department:', error);
                const errorMsg = error.message || 'Failed to update sub-department';
                showNotification(errorMsg.includes('already exists') ? errorMsg : 'Failed to update sub-department', 'error');
            });
        }
        
        function deleteSubDepartment(id) {
            if (confirm('Are you sure you want to delete this sub-department?')) {
                // Get department info from modal data attributes for refreshing the list
                const modalElement = document.getElementById('viewSubDepartmentsModal');
                const existingModal = modalElement ? bootstrap.Modal.getInstance(modalElement) : null;
                const isModalOpen = existingModal && modalElement.classList.contains('show');
                const departmentId = modalElement ? modalElement.getAttribute('data-department-id') : null;
                const departmentName = modalElement ? modalElement.getAttribute('data-department-name') : null;
                
                api.deleteSubDepartment(id).then(() => {
                    showNotification('Sub-department deleted successfully!', 'success');
                    
                    // Clean up any extra modal backdrops that might exist
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    if (backdrops.length > 1) {
                        // Remove extra backdrops, keep only the first one
                        for (let i = 1; i < backdrops.length; i++) {
                            backdrops[i].remove();
                        }
                    }
                    
                    // If modal is open, refresh the sub-departments list
                    if (isModalOpen && departmentId && departmentName) {
                        viewSubDepartments(departmentId, departmentName);
                    }
                    
                    // Reload departments for the selected branch to update sub-department count
                    const selectedBranchId = document.getElementById('departmentBranchFilter').value;
                    if (selectedBranchId) {
                        loadDepartments(selectedBranchId);
                    }
                }).catch(error => {
                    console.error('Error deleting sub-department:', error);
                    showNotification(error.message || 'Failed to delete sub-department', 'error');
                });
            }
        }
        
        // ========================================
        // DEPARTMENT SALES FUNCTIONS
        // ========================================
        
        // Calculate Department Sales totals
        function calculateDepartmentSalesTotals() {
            const grossSale = parseFloat(document.getElementById('deptSaleGrossSale').value) || 0;
            const discountPercent = parseFloat(document.getElementById('deptSaleDiscountPercent').value) || 0;
            const returnAmount = parseFloat(document.getElementById('deptSaleReturnAmount').value) || 0;
            const gst = parseFloat(document.getElementById('deptSaleGST').value) || 0;
            
            // Calculate Discount Amount: (Gross Sale * Discount %) / 100
            const discountAmount = (grossSale * discountPercent) / 100;
            document.getElementById('deptSaleDiscountAmount').value = discountAmount.toFixed(2);
            
            // Calculate Sale Value: Gross Sale - Discount Amount
            const saleValue = grossSale - discountAmount;
            const formattedSaleValue = saleValue % 1 === 0 ? saleValue.toString() : saleValue.toFixed(2);
            document.getElementById('deptSaleSaleValue').value = formattedSaleValue;
            
            // Calculate Net Sale: Sale Value - Return + GST
            const netSale = saleValue - returnAmount + gst;
            const formattedNetSale = netSale % 1 === 0 ? netSale.toString() : netSale.toFixed(2);
            document.getElementById('deptSaleNetSale').value = formattedNetSale;
            
            // Sub-Department Total Sale (same as Net Sale)
            document.getElementById('deptSaleSubDepartmentTotal').value = formattedNetSale;
        }
        
        // Save Department Sales Entry
        function saveDepartmentSalesEntry() {
            const date = document.getElementById('deptSaleDate').value;
            const branchId = document.getElementById('deptSaleBranch').value;
            const departmentId = document.getElementById('deptSaleDepartment').value;
            const subDepartmentId = document.getElementById('deptSaleSubDepartment').value;
            const grossSale = parseFloat(document.getElementById('deptSaleGrossSale').value) || 0;
            const discountAmount = parseFloat(document.getElementById('deptSaleDiscountAmount').value) || 0;
            const discountPercent = parseFloat(document.getElementById('deptSaleDiscountPercent').value) || 0;
            const saleValue = parseFloat(document.getElementById('deptSaleSaleValue').value) || 0;
            const returnAmount = parseFloat(document.getElementById('deptSaleReturnAmount').value) || 0;
            const gst = parseFloat(document.getElementById('deptSaleGST').value) || 0;
            const netSale = parseFloat(document.getElementById('deptSaleNetSale').value) || 0;
            const subDeptTotal = parseFloat(document.getElementById('deptSaleSubDepartmentTotal').value) || 0;
            const notes = document.getElementById('deptSaleNotes').value;
            
            // Validation
            if (!branchId || branchId === '') {
                showNotification('Please select a branch before saving', 'error');
                document.getElementById('deptSaleBranch').focus();
                return;
            }
            
            if (!date) {
                showNotification('Please select a date before saving', 'error');
                document.getElementById('deptSaleDate').focus();
                return;
            }
            
            if (!departmentId || departmentId === '') {
                showNotification('Please select a department before saving', 'error');
                document.getElementById('deptSaleDepartment').focus();
                return;
            }
            
            if (!subDepartmentId || subDepartmentId === '') {
                showNotification('Please select a sub-department before saving', 'error');
                document.getElementById('deptSaleSubDepartment').focus();
                return;
            }
            
            if (grossSale <= 0) {
                showNotification('Gross Sale must be greater than 0', 'error');
                document.getElementById('deptSaleGrossSale').focus();
                return;
            }
            
            // Create department sales entry
            const saleData = {
                date: date,
                branchId: branchId,
                departmentId: departmentId,
                subDepartmentId: subDepartmentId,
                grossSale: grossSale,
                discountAmount: discountAmount,
                discountPercent: discountPercent,
                saleValue: saleValue,
                returnAmount: returnAmount,
                gst: gst,
                netSale: netSale,
                subDepartmentTotal: subDeptTotal,
                notes: notes || ''
            };
            
            api.createDepartmentSale(saleData).then(() => {
                showNotification('Department sales entry saved successfully!', 'success');
                
                // Form reset not needed - only bulk entry is used
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('deptSaleDate').value = today;
                document.getElementById('deptSaleSubDepartment').disabled = true;
                
                // Clear calculated fields
                document.getElementById('deptSaleDiscountPercent').value = '0';
                document.getElementById('deptSaleDiscountAmount').value = '';
                document.getElementById('deptSaleSaleValue').value = '';
                document.getElementById('deptSaleNetSale').value = '';
                document.getElementById('deptSaleSubDepartmentTotal').value = '';
                
                // Refresh shop dashboard if it's active (to show latest date automatically)
                const dashboardSection = document.getElementById('dashboard-section');
                const shopDashboardTab = document.getElementById('shop-dashboard-tab');
                if (dashboardSection && dashboardSection.classList.contains('active') && 
                    shopDashboardTab && shopDashboardTab.classList.contains('active')) {
                    // Reset date range filter to default so it shows latest date
                    const dateRangeFilter = document.getElementById('shopDashboardDateRangeFilter');
                    const monthFilter = document.getElementById('shopDashboardMonthFilter');
                    if (dateRangeFilter) dateRangeFilter.value = 'currentMonth';
                    if (monthFilter) monthFilter.value = '';
                    // Reload dashboard to show latest date
                    loadDashboard(null, 'shop');
                }
                
                // Auto-show and load department sales list with today's date in full page mode
                const deptSalesListSection = document.getElementById('deptSalesListSection');
                const salesEntryCard = document.querySelector('#sales-section > .card');
                
                if (deptSalesListSection) {
                    deptSalesListSection.style.display = 'block';
                    deptSalesListSection.classList.add('full-page');
                    
                    // Hide sidebar and navbar
                    document.body.classList.add('full-page-active');
                    
                    // Hide sales entry form
                    if (salesEntryCard && !salesEntryCard.closest('#deptSalesListSection')) {
                        salesEntryCard.classList.add('sales-entry-hidden');
                    }
                    
                    // Set today's date in filters
                    document.getElementById('deptSalesListDateFrom').value = today;
                    document.getElementById('deptSalesListDateTo').value = today;
                    // Load the list
                    loadDeptSalesList();
                }
            }).catch(error => {
                console.error('Error saving department sales entry:', error);
                showNotification('Failed to save department sales entry: ' + (error.message || 'Unknown error'), 'error');
            });
        }
        
        // Load branches for bulk sales Tab 2 - Make globally accessible
        window.loadBranchesForBulkSalesTab2 = function loadBranchesForBulkSalesTab2() {
            const branchSelect = document.getElementById('bulkDeptSaleBranchTab2');
            if (!branchSelect) return;
            
            api.getBranches().then(allBranches => {
                // Ensure array
                if (!Array.isArray(allBranches)) {
                    allBranches = [];
                }
                // Filter branches based on user's allowed branches
                let userBranches = allBranches;
                if (appData.currentUser && appData.currentUser.branches && appData.currentUser.branches.length > 0) {
                    const userBranchIds = appData.currentUser.branches.map(b => b._id || b);
                    userBranches = allBranches.filter(branch => userBranchIds.includes(branch._id));
                }
                
                branchSelect.innerHTML = '<option value="">Select Branch</option>';
                userBranches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch._id;
                    option.textContent = branch.name;
                    branchSelect.appendChild(option);
                });
            }).catch(error => {
                console.error('Error loading branches:', error);
                showNotification('Failed to load branches', 'error');
            });
        }
        
        // Load departments for bulk entry Tab 2 - Make globally accessible
        window.loadDepartmentsForBulkSalesTab2 = function loadDepartmentsForBulkSalesTab2() {
            const branchSelect = document.getElementById('bulkDeptSaleBranchTab2');
            const departmentSelect = document.getElementById('bulkDeptSaleDepartmentTab2');
            const container = document.getElementById('bulkSubDepartmentsContainerTab2');
            
            if (!branchSelect || !departmentSelect) {
                console.error('Department or branch select element not found');
                return;
            }
            
            const branchId = (branchSelect.value || '').trim();
            
            if (!branchId) {
                if (departmentSelect) {
                    departmentSelect.innerHTML = '<option value="" selected disabled>Select Department</option>';
                }
                if (container) {
                    container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Please select a branch and department to load sub-departments</div>';
                }
                return;
            }
            
            console.log(' Loading departments for branch:', branchId);
            
            // Show loading state
            if (departmentSelect) {
                departmentSelect.innerHTML = '<option value="">Loading departments...</option>';
                departmentSelect.disabled = true;
            }
            
            api.getDepartments(branchId).then(departments => {
                console.log(' Departments loaded:', departments?.length || 0, 'items');
                
                if (departmentSelect) {
                    departmentSelect.innerHTML = '<option value="" selected disabled>Select Department</option>';
                    
                    if (departments && Array.isArray(departments) && departments.length > 0) {
                        departments.forEach(dept => {
                            const option = document.createElement('option');
                            option.value = dept._id;
                            option.textContent = dept.name;
                            departmentSelect.appendChild(option);
                        });
                        departmentSelect.disabled = false;
                    } else {
                        departmentSelect.innerHTML = '<option value="" selected disabled>No departments found</option>';
                        departmentSelect.disabled = false;
                        if (container) {
                            container.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>No departments found for this branch. Please add departments first.</div>';
                        }
                    }
                }
            }).catch(async error => {
                try {
                    const departments = await api.getDepartmentsByBranch(branchId);
                    if (departmentSelect) {
                        departmentSelect.innerHTML = '<option value="" selected disabled>Select Department</option>';
                        if (departments && Array.isArray(departments) && departments.length > 0) {
                            departments.forEach(dept => {
                                const option = document.createElement('option');
                                option.value = dept._id;
                                option.textContent = dept.name;
                                departmentSelect.appendChild(option);
                            });
                            departmentSelect.disabled = false;
                        } else {
                            departmentSelect.innerHTML = '<option value="" selected disabled>No departments found</option>';
                            departmentSelect.disabled = false;
                            if (container) {
                                container.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>No departments found for this branch. Please add departments first.</div>';
                            }
                        }
                    }
                } catch (err) {
                    if (departmentSelect) {
                        departmentSelect.innerHTML = '<option value="" selected disabled>Error loading departments</option>';
                        departmentSelect.disabled = false;
                    }
                    showNotification('Failed to load departments: ' + (err.message || 'Unknown error'), 'error');
                }
            });
        };
        
        // Load sub-departments and create input fields for bulk entry Tab 2
        function loadSubDepartmentsForBulkSalesTab2() {
            const departmentId = (document.getElementById('bulkDeptSaleDepartmentTab2').value || '').trim();
            const container = document.getElementById('bulkSubDepartmentsContainerTab2');
            
            if (!departmentId) {
                container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Please select a department to load sub-departments</div>';
                return;
            }
            
            container.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin me-2"></i>Loading sub-departments...</div>';
            
            api.getSubDepartmentsByDepartment(departmentId).then(subDepts => {
                if (!subDepts || subDepts.length === 0) {
                    container.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>No sub-departments found for this department</div>';
                    return;
                }
                
                container.innerHTML = '';
                
                // Create a table layout for all sub-departments with totals
                const table = document.createElement('table');
                table.className = 'table table-bordered table-hover';
                table.innerHTML = `
                    <thead class="table-light">
                        <tr>
                            <th>Sub-Department</th>
                            <th class="text-end">Gross Sale</th>
                            <th class="text-end">Discount Amount</th>
                            <th class="text-end">Discount %</th>
                            <th class="text-end">Sale Value</th>
                            <th class="text-end">Return</th>
                            <th class="text-end">GST</th>
                            <th class="text-end">Net Sale</th>
                        </tr>
                    </thead>
                    <tbody id="bulkSubDeptTableBodyTab2">
                    </tbody>
                    <tfoot class="table-info fw-bold">
                        <tr id="bulkSubDeptTotalsRowTab2">
                            <td><strong>Total</strong></td>
                            <td class="text-end" id="totalGrossSaleTab2">0.00</td>
                            <td class="text-end" id="totalDiscountTab2">0.00</td>
                            <td class="text-end" id="avgDiscountPercentTab2">0.00%</td>
                            <td class="text-end" id="totalSaleValueTab2">0.00</td>
                            <td class="text-end" id="totalReturnTab2">0.00</td>
                            <td class="text-end" id="totalGSTTab2">0.00</td>
                            <td class="text-end" id="totalNetSaleTab2">0.00</td>
                        </tr>
                    </tfoot>
                `;
                
                const tbody = table.querySelector('#bulkSubDeptTableBodyTab2');
                
                subDepts.forEach((subDept) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <strong>${subDept.name}</strong>
                            <input type="hidden" class="bulk-subdept-id-tab2" value="${subDept._id}">
                        </td>
                        <td>
                            <input type="number" class="form-control text-end bulk-gross-sale-tab2" 
                                   data-subdept="${subDept._id}" min="0" step="0.01" 
                                   placeholder="0.00" value="0">
                        </td>
                        <td>
                            <input type="number" class="form-control text-end bulk-discount-tab2" 
                                   data-subdept="${subDept._id}" min="0" step="0.01" 
                                   placeholder="0.00" value="0">
                        </td>
                        <td>
                            <input type="number" class="form-control text-end bulk-discount-percent-tab2" 
                                   data-subdept="${subDept._id}" readonly placeholder="0.00%" 
                                   style="background-color: #e7f3ff;" value="0">
                        </td>
                        <td>
                            <input type="number" class="form-control text-end bulk-sale-value-tab2" 
                                   data-subdept="${subDept._id}" readonly placeholder="0.00" 
                                   style="background-color: #e7f3ff;">
                        </td>
                        <td>
                            <input type="number" class="form-control text-end bulk-return-tab2" 
                                   data-subdept="${subDept._id}" min="0" step="0.01" 
                                   placeholder="0.00" value="0">
                        </td>
                        <td>
                            <input type="number" class="form-control text-end bulk-gst-tab2" 
                                   data-subdept="${subDept._id}" min="0" step="0.01" 
                                   placeholder="0.00" value="0">
                        </td>
                        <td>
                            <input type="number" class="form-control text-end bulk-net-sale-tab2" 
                                   data-subdept="${subDept._id}" readonly placeholder="0.00" 
                                   style="background-color: #e7f3ff;">
                        </td>
                    `;
                    tbody.appendChild(row);
                    
                    // Add event listeners for calculations
                    const grossSaleInput = row.querySelector('.bulk-gross-sale-tab2');
                    const discountAmountInput = row.querySelector('.bulk-discount-tab2');
                    const returnInput = row.querySelector('.bulk-return-tab2');
                    const gstInput = row.querySelector('.bulk-gst-tab2');
                    
                    // Calculate immediately when values are entered
                    const calculateRow = () => {
                        calculateBulkSubDeptTotalsTab2(subDept._id);
                        calculateBulkTotalsTab2();
                    };
                    
                    [grossSaleInput, discountAmountInput, returnInput, gstInput].forEach(input => {
                        if (input) {
                            input.addEventListener('input', calculateRow);
                            input.addEventListener('change', calculateRow);
                        }
                    });
                });
                
                container.appendChild(table);
                
                // Initialize totals after table is appended
                setTimeout(() => {
                    calculateBulkTotalsTab2();
                }, 100);
            }).catch(() => {
                api.getSubDepartments({ departmentId }).then(subDepts => {
                    if (!subDepts || subDepts.length === 0) {
                        container.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>No sub-departments found for this department</div>';
                        return;
                    }
                    container.innerHTML = '';
                    const table = document.createElement('table');
                    table.className = 'table table-bordered table-hover';
                    table.innerHTML = document.querySelector('#bulkDeptSalesEntryFormTab2') ? container.nextElementSibling?.innerHTML : '';
                }).catch(err => {
                    showNotification('Failed to load sub-departments: ' + (err.message || 'Unknown error'), 'error');
                    container.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Failed to load sub-departments</div>';
                });
            });
        }
        
        // Calculate totals for a single sub-department in bulk entry Tab 2
        function calculateBulkSubDeptTotalsTab2(subDeptId) {
            const grossSale = parseFloat(document.querySelector(`.bulk-gross-sale-tab2[data-subdept="${subDeptId}"]`)?.value) || 0;
            const discountAmount = parseFloat(document.querySelector(`.bulk-discount-tab2[data-subdept="${subDeptId}"]`)?.value) || 0;
            const returnAmount = parseFloat(document.querySelector(`.bulk-return-tab2[data-subdept="${subDeptId}"]`)?.value) || 0;
            const gst = parseFloat(document.querySelector(`.bulk-gst-tab2[data-subdept="${subDeptId}"]`)?.value) || 0;
            
            // Calculate Discount %: (Discount Amount / Gross Sale) * 100
            let discountPercent = 0;
            if (grossSale > 0) {
                discountPercent = (discountAmount / grossSale) * 100;
            }
            const discountPercentInput = document.querySelector(`.bulk-discount-percent-tab2[data-subdept="${subDeptId}"]`);
            if (discountPercentInput) {
                discountPercentInput.value = discountPercent.toFixed(2);
            }
            
            // Calculate Sale Value: Gross Sale - Discount Amount
            const saleValue = grossSale - discountAmount;
            const saleValueInput = document.querySelector(`.bulk-sale-value-tab2[data-subdept="${subDeptId}"]`);
            if (saleValueInput) {
                const formattedSaleValue = saleValue % 1 === 0 ? saleValue.toString() : saleValue.toFixed(2);
                saleValueInput.value = formattedSaleValue;
            }
            
            // Calculate Net Sale: Sale Value - Return + GST
            const netSale = saleValue - returnAmount + gst;
            const netSaleInput = document.querySelector(`.bulk-net-sale-tab2[data-subdept="${subDeptId}"]`);
            if (netSaleInput) {
                const formattedNetSale = netSale % 1 === 0 ? netSale.toString() : netSale.toFixed(2);
                netSaleInput.value = formattedNetSale;
            }
        }
        
        // Calculate totals and averages for all sub-departments Tab 2
        function calculateBulkTotalsTab2() {
            const allRows = document.querySelectorAll('#bulkSubDeptTableBodyTab2 tr');
            
            // Check if totals row elements exist
            const totalGrossSaleEl = document.getElementById('totalGrossSaleTab2');
            const totalDiscountEl = document.getElementById('totalDiscountTab2');
            const totalSaleValueEl = document.getElementById('totalSaleValueTab2');
            const totalReturnEl = document.getElementById('totalReturnTab2');
            const totalGSTEl = document.getElementById('totalGSTTab2');
            const totalNetSaleEl = document.getElementById('totalNetSaleTab2');
            const avgDiscountPercentEl = document.getElementById('avgDiscountPercentTab2');
            
            if (!totalGrossSaleEl || !totalDiscountEl || !totalSaleValueEl || !totalReturnEl || !totalGSTEl || !totalNetSaleEl || !avgDiscountPercentEl) {
                return;
            }
            
            let totalGrossSale = 0;
            let totalDiscount = 0;
            let totalSaleValue = 0;
            let totalReturn = 0;
            let totalGST = 0;
            let totalNetSale = 0;
            let discountPercentSum = 0;
            let validRows = 0;
            
            allRows.forEach(row => {
                const grossSale = parseFloat(row.querySelector('.bulk-gross-sale-tab2')?.value) || 0;
                const discount = parseFloat(row.querySelector('.bulk-discount-tab2')?.value) || 0;
                const returnAmount = parseFloat(row.querySelector('.bulk-return-tab2')?.value) || 0;
                const gst = parseFloat(row.querySelector('.bulk-gst-tab2')?.value) || 0;
                const saleValue = grossSale - discount;
                const netSale = saleValue - returnAmount + gst;
                
                totalGrossSale += grossSale;
                totalDiscount += discount;
                totalSaleValue += saleValue;
                totalReturn += returnAmount;
                totalGST += gst;
                totalNetSale += netSale;
                
                // Calculate discount percent for average (from discount amount)
                if (grossSale > 0) {
                    const discountPercent = (discount / grossSale) * 100;
                    discountPercentSum += discountPercent;
                    validRows++;
                }
            });
            
            // Update totals row
            totalGrossSaleEl.textContent = totalGrossSale.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            totalDiscountEl.textContent = totalDiscount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            totalSaleValueEl.textContent = totalSaleValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            totalReturnEl.textContent = totalReturn.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            totalGSTEl.textContent = totalGST.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            totalNetSaleEl.textContent = totalNetSale.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            // Calculate average discount percent
            const avgDiscountPercent = validRows > 0 ? (discountPercentSum / validRows) : 0;
            avgDiscountPercentEl.textContent = avgDiscountPercent.toFixed(2) + '%';
        }
        
        // Save Bulk Department Sales Entry Tab 2
        // Flag to prevent multiple simultaneous saves
        let isSavingBulkDeptSalesTab2 = false;
        
        async function saveBulkDepartmentSalesEntryTab2() {
            // Prevent multiple clicks/saves
            if (isSavingBulkDeptSalesTab2) {
                console.log('Save already in progress, ignoring duplicate click');
                return;
            }
            
            // Get save button
            const saveBtn = document.getElementById('saveBulkDeptSalesBtnTab2');
            
            // Disable button and set saving state
            isSavingBulkDeptSalesTab2 = true;
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            }
            
            const date = document.getElementById('bulkDeptSaleDateTab2').value;
            const branchId = document.getElementById('bulkDeptSaleBranchTab2').value;
            const departmentId = document.getElementById('bulkDeptSaleDepartmentTab2').value;
            const editSaleId = document.getElementById('editDeptSaleIdTab2')?.value || '';
            
            // Validation
            if (!branchId || branchId === '') {
                showNotification('Please select a branch before saving', 'error');
                document.getElementById('bulkDeptSaleBranchTab2').focus();
                // Re-enable button on validation error
                isSavingBulkDeptSalesTab2 = false;
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Bulk Department Sales';
                }
                return;
            }
            
            if (!date) {
                showNotification('Please select a date before saving', 'error');
                document.getElementById('bulkDeptSaleDateTab2').focus();
                // Re-enable button on validation error
                isSavingBulkDeptSalesTab2 = false;
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Bulk Department Sales';
                }
                return;
            }
            
            if (!departmentId || departmentId === '') {
                showNotification('Please select a department before saving', 'error');
                document.getElementById('bulkDeptSaleDepartmentTab2').focus();
                // Re-enable button on validation error
                isSavingBulkDeptSalesTab2 = false;
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Bulk Department Sales';
                }
                return;
            }
            
            // Collect all sub-department sales data
            const salesData = [];
            const subDeptRows = document.querySelectorAll('#bulkSubDeptTableBodyTab2 tr');
            
            if (subDeptRows.length === 0) {
                showNotification('No sub-departments found. Please select a department with sub-departments.', 'error');
                return;
            }
            
            let hasValidData = false;
            
            subDeptRows.forEach(row => {
                const subDeptId = row.querySelector('.bulk-subdept-id-tab2')?.value;
                const grossSale = parseFloat(row.querySelector('.bulk-gross-sale-tab2')?.value) || 0;
                const discountPercent = parseFloat(row.querySelector('.bulk-discount-percent-tab2')?.value) || 0;
                const discount = parseFloat(row.querySelector('.bulk-discount-tab2')?.value) || 0;
                const returnAmount = parseFloat(row.querySelector('.bulk-return-tab2')?.value) || 0;
                const gst = parseFloat(row.querySelector('.bulk-gst-tab2')?.value) || 0;
                const saleValue = parseFloat(row.querySelector('.bulk-sale-value-tab2')?.value) || 0;
                const netSale = parseFloat(row.querySelector('.bulk-net-sale-tab2')?.value) || 0;
                
                // Only include entries with gross sale > 0
                if (grossSale > 0 && subDeptId) {
                    hasValidData = true;
                    
                    salesData.push({
                        date: date,
                        branchId: branchId,
                        departmentId: departmentId,
                        subDepartmentId: subDeptId,
                        grossSale: grossSale,
                        discountAmount: discount,
                        discountPercent: discountPercent,
                        saleValue: saleValue,
                        returnAmount: returnAmount,
                        gst: gst,
                        netSale: netSale,
                        subDepartmentTotal: netSale,
                        notes: ''
                    });
                }
            });
            
            if (!hasValidData) {
                showNotification('Please enter at least one sub-department with Gross Sale greater than 0', 'error');
                // Re-enable button on validation error
                isSavingBulkDeptSalesTab2 = false;
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Bulk Department Sales';
                }
                return;
            }
            
            try {
                // If editing a single sale, update it instead of creating new ones
                if (editSaleId && salesData.length === 1) {
                    await api.updateDepartmentSale(editSaleId, salesData[0]);
                    showNotification('Department sale updated successfully!', 'success');
                    
                    // Clear form immediately after successful save
                    resetBulkDeptSalesFormTab2();
                    
                    // Refresh department sales list if visible
                    if (document.getElementById('deptSalesListSection') && document.getElementById('deptSalesListSection').style.display !== 'none') {
                        loadDeptSalesList();
                    }
                    
                    // Update dashboard if we're on dashboard
                    if (document.getElementById('dashboard-section').classList.contains('active')) {
                        loadDashboard();
                    }
                } else {
                    // Save all sales entries one by one to handle errors better (for bulk creation)
                    let successCount = 0;
                    let errorCount = 0;
                    const errors = [];
                    
                    for (let i = 0; i < salesData.length; i++) {
                        try {
                            await api.createDepartmentSale(salesData[i]);
                            successCount++;
                        } catch (error) {
                            errorCount++;
                            errors.push(`Entry ${i + 1}: ${error.message || 'Unknown error'}`);
                            console.error(`Error saving entry ${i + 1}:`, error);
                        }
                    }
                    
                    if (errorCount === 0) {
                        showNotification(`Successfully saved ${successCount} sub-department sales entry(ies)!`, 'success');
                        
                        // Clear form immediately after successful save
                        resetBulkDeptSalesFormTab2();
                        
                        // Refresh department sales list if visible
                        if (document.getElementById('deptSalesListSection') && document.getElementById('deptSalesListSection').style.display !== 'none') {
                            loadDeptSalesList();
                        }
                    } else if (successCount > 0) {
                        showNotification(`Saved ${successCount} entries, but ${errorCount} failed. Check console for details.`, 'warning');
                        console.error('Failed entries:', errors);
                        
                        // Clear form even if some failed (partial success)
                        resetBulkDeptSalesFormTab2();
                    } else {
                        showNotification(`Failed to save all entries. First error: ${errors[0] || 'Unknown error'}`, 'error');
                        console.error('All entries failed:', errors);
                    }
                }
            } catch (error) {
                console.error('Error saving bulk department sales:', error);
                showNotification('Failed to save: ' + (error.message || 'Unknown error'), 'error');
            } finally {
                // Always re-enable button and reset state after save completes
                isSavingBulkDeptSalesTab2 = false;
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Bulk Department Sales';
                }
            }
        }
        
        // Reset Bulk Department Sales Form Tab 2
        function resetBulkDeptSalesFormTab2() {
            // Clear form data
            document.getElementById('bulkDeptSalesEntryFormTab2').reset();
            document.getElementById('editDeptSaleIdTab2').value = '';
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('bulkDeptSaleDateTab2').value = today;
            
            // Clear branch and department selections
            const branchSelect = document.getElementById('bulkDeptSaleBranchTab2');
            const deptSelect = document.getElementById('bulkDeptSaleDepartmentTab2');
            if (branchSelect) branchSelect.value = '';
            if (deptSelect) deptSelect.value = '';
            
            // Clear sub-departments container and table
            const subDeptContainer = document.getElementById('bulkSubDepartmentsContainerTab2');
            const subDeptTableBody = document.getElementById('bulkSubDeptTableBodyTab2');
            if (subDeptContainer) {
                subDeptContainer.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Please select a branch and department to load sub-departments</div>';
            }
            if (subDeptTableBody) {
                subDeptTableBody.innerHTML = '';
            }
            
            // Reset button text, style, and state
            const saveBtn = document.getElementById('saveBulkDeptSalesBtnTab2');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Bulk Department Sales';
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Bulk Department Sales';
                saveBtn.classList.remove('btn-warning');
                saveBtn.classList.add('btn-primary');
            }
            
            // Reset saving flag
            isSavingBulkDeptSalesTab2 = false;
        }
        
        // Load Department Sales List
        function loadDeptSalesList(page = 1, perPage = 10) {
            const hasToken = !!localStorage.getItem('authToken');
            if (!hasToken) {
                return;
            }
            // Get filter values
            const dateFrom = document.getElementById('deptSalesListDateFrom')?.value || '';
            const dateTo = document.getElementById('deptSalesListDateTo')?.value || '';
            const branchId = document.getElementById('deptSalesListBranch')?.value || '';
            const departmentId = document.getElementById('deptSalesListDepartment')?.value || '';
            
            // Require at least one date to be selected before loading data
            if (!dateFrom && !dateTo) {
                const invoicesContainer = document.getElementById('deptSalesInvoicesContainer');
                const salesTableBody = document.getElementById('deptSalesListTableBody');
                
                if (invoicesContainer) invoicesContainer.innerHTML = '<div class="text-center text-muted p-4">Please select at least one date (From or To) to view department sales list</div>';
                if (salesTableBody) salesTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Please select at least one date (From or To) to view department sales list</td></tr>';
                
                // Reset pagination
                const invoicesPagination = document.getElementById('deptSalesInvoicesPagination');
                const listPagination = document.getElementById('deptSalesListPagination');
                if (invoicesPagination) invoicesPagination.innerHTML = '';
                if (listPagination) listPagination.innerHTML = '';
                
                showNotification('Please select at least one date (From or To) to view department sales list', 'info');
                return;
            }
            
            // Build filters object
            const filters = {};
            if (dateFrom) filters.from = dateFrom;
            if (dateTo) filters.to = dateTo;
            if (branchId) filters.branchId = branchId;
            if (departmentId) filters.departmentId = departmentId;
            
            // Fetch filtered department sales data
            api.getDepartmentSales(filters).then(salesData => {
                // Sort sales by date (newest first)
                const sortedSales = [...salesData].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Calculate grand totals from all sales data (not paginated)
                const grandTotals = {
                    grossSale: 0,
                    discountAmount: 0,
                    netSale: 0
                };
                salesData.forEach(sale => {
                    grandTotals.grossSale += sale.grossSale || 0;
                    grandTotals.discountAmount += sale.discountAmount || 0;
                    grandTotals.netSale += sale.netSale || 0;
                });
                
                // Load department-wise summary (using all filtered data, not paginated)
                loadDepartmentSummary(salesData);
                
                // Calculate pagination
                const startIndex = (page - 1) * perPage;
                const endIndex = startIndex + perPage;
                const paginatedSales = sortedSales.slice(startIndex, endIndex);
                
                // Load department sales invoices (card view)
                loadDeptSalesInvoices(paginatedSales);
                
                // Load department sales table (table view) with grand totals
                loadDeptSalesTable(paginatedSales, grandTotals);
                
                // Update pagination
                updatePagination(sortedSales.length, page, perPage, 'deptSalesInvoicesPagination', loadDeptSalesList);
                updatePagination(sortedSales.length, page, perPage, 'deptSalesListPagination', loadDeptSalesList);
            }).catch(error => {
                console.error('Error loading department sales list:', error);
                showNotification('Failed to load department sales list', 'error');
            });
        }
        
        // Load Department Sales Invoices (card view)
        function loadDeptSalesInvoices(sales) {
            const container = document.getElementById('deptSalesInvoicesContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!sales || sales.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted p-4">No department sales found</div>';
                return;
            }
            
            const permissions = appData.currentUser?.permissions || [];
            const isAdmin = permissions.includes('admin');
            const canEditSale = isAdmin || permissions.includes('sales-edit');
            const canDeleteSale = isAdmin || permissions.includes('sales-delete');
            
            sales.forEach(sale => {
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4 mb-3';
                
                card.innerHTML = `
                    <div class="invoice-card">
                        <div class="invoice-header">
                            <span>${formatDate(sale.date)}</span>
                        </div>
                        <div class="invoice-body">
                            <div class="invoice-details">
                                <span class="invoice-detail-label">Branch:</span>
                                <span class="invoice-detail-value">${sale.branchId?.name || 'Unknown'}</span>
                            </div>
                            <div class="invoice-details">
                                <span class="invoice-detail-label">Department:</span>
                                <span class="invoice-detail-value">${sale.departmentId?.name || 'Unknown'}</span>
                            </div>
                            <div class="invoice-details">
                                <span class="invoice-detail-label">Sub-Department:</span>
                                <span class="invoice-detail-value">${sale.subDepartmentId?.name || 'Unknown'}</span>
                            </div>
                            <div class="invoice-details">
                                <span class="invoice-detail-label">Gross Sale:</span>
                                <span class="invoice-detail-value">${(sale.grossSale || 0).toLocaleString()}</span>
                            </div>
                            <div class="invoice-details">
                                <span class="invoice-detail-label">Discount:</span>
                                <span class="invoice-detail-value">${(sale.discountAmount || 0).toLocaleString()}</span>
                            </div>
                            <div class="invoice-details">
                                <span class="invoice-detail-label">Return:</span>
                                <span class="invoice-detail-value">${(sale.returnAmount || 0).toLocaleString()}</span>
                            </div>
                            <div class="invoice-details">
                                <span class="invoice-detail-label">GST:</span>
                                <span class="invoice-detail-value">${(sale.gst || 0).toLocaleString()}</span>
                            </div>
                            <div class="invoice-details">
                                <span class="invoice-detail-label">Net Sale:</span>
                                <span class="invoice-detail-value text-success">
                                    <strong>${(sale.netSale || 0).toLocaleString()}</strong>
                                </span>
                            </div>
                            <div class="invoice-actions">
                                ${canEditSale ? `<button class="btn btn-sm btn-primary" onclick="editDeptSale('${sale._id}')"><i class="fas fa-edit"></i> Edit</button>` : ''}
                                ${canDeleteSale ? `<button class="btn btn-sm btn-danger" onclick="deleteDeptSale('${sale._id}')"><i class="fas fa-trash"></i> Delete</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Load Department-Wise Summary
        function loadDepartmentSummary(sales) {
            const summarySection = document.getElementById('departmentSummarySection');
            const summaryCards = document.getElementById('departmentSummaryCards');
            
            // Don't show if no sales data
            if (!sales || sales.length === 0) {
                if (summarySection) summarySection.style.display = 'none';
                return;
            }
            
            // Group sales by department with transaction details
            // Using ONLY the filtered sales data (already filtered by date range and other filters)
            const departmentData = {};
            
            // Initialize department data from appData.departments
            if (appData.departments && appData.departments.length > 0) {
                appData.departments.forEach(department => {
                    departmentData[department._id] = {
                        name: department.name,
                        grossSale: 0,
                        discount: 0,
                        returnAmount: 0,
                        gst: 0,
                        netSale: 0,
                        transactions: []
                    };
                });
            }
            
            // Sort sales by date (newest first) - using filtered data only
            const sortedSales = [...sales].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Calculate totals and collect transaction details for each department
            // Only processes sales within the selected date range and filters
            sortedSales.forEach(sale => {
                const departmentId = sale.departmentId?._id || sale.departmentId;
                if (departmentId) {
                    // Initialize department if not already in departmentData
                    if (!departmentData[departmentId]) {
                        const deptName = sale.departmentId?.name || 'Unknown Department';
                        departmentData[departmentId] = {
                            name: deptName,
                            grossSale: 0,
                            discount: 0,
                            returnAmount: 0,
                            gst: 0,
                            netSale: 0,
                            transactions: []
                        };
                    }
                    
                    departmentData[departmentId].grossSale += sale.grossSale || 0;
                    departmentData[departmentId].discount += sale.discountAmount || 0;
                    departmentData[departmentId].returnAmount += sale.returnAmount || 0;
                    departmentData[departmentId].gst += sale.gst || 0;
                    departmentData[departmentId].netSale += sale.netSale || 0;
                    
                    // Add transaction details
                    departmentData[departmentId].transactions.push({
                        date: sale.date,
                        grossSale: sale.grossSale || 0,
                        discount: sale.discountAmount || 0,
                        returnAmount: sale.returnAmount || 0,
                        gst: sale.gst || 0,
                        netSale: sale.netSale || 0,
                        branch: sale.branchId?.name || 'Unknown',
                        subDepartment: sale.subDepartmentId?.name || 'Unknown'
                    });
                }
            });
            
            // Show section if there's data
            const hasData = Object.values(departmentData).some(dept => dept.netSale > 0);
            if (summarySection) {
                summarySection.style.display = hasData ? 'block' : 'none';
            }
            
            if (!hasData || !summaryCards) return;
            
            // Clear and populate summary cards
            summaryCards.innerHTML = '';
            
            // Calculate grand totals across all departments
            let grandTotalGrossSale = 0;
            let grandTotalDiscount = 0;
            let grandTotalReturn = 0;
            let grandTotalGST = 0;
            let grandTotalNetSale = 0;
            let grandTotalTransactions = 0;
            
            const departmentsWithSales = Object.values(departmentData)
                .filter(dept => dept.netSale > 0)
                .sort((a, b) => b.netSale - a.netSale);
            
            // Calculate grand totals
            departmentsWithSales.forEach(department => {
                grandTotalGrossSale += department.grossSale;
                grandTotalDiscount += department.discount;
                grandTotalReturn += department.returnAmount;
                grandTotalGST += department.gst;
                grandTotalNetSale += department.netSale;
                grandTotalTransactions += department.transactions.length;
            });
            
            // Render department cards
            departmentsWithSales.forEach(department => {
                const card = document.createElement('div');
                card.className = 'col-12 mb-4';
                card.innerHTML = `
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-primary text-white">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="mb-0"><i class="fas fa-building me-2"></i>${department.name}</h6>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge bg-light text-dark">${department.transactions.length} Transactions</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Summary Stats -->
                            <div class="row mb-3 border-bottom pb-3">
                                <div class="col-md-3 text-center">
                                    <small class="text-muted d-block">Gross Sale</small>
                                    <strong class="text-primary fs-5">${department.grossSale.toLocaleString()}</strong>
                                </div>
                                <div class="col-md-3 text-center">
                                    <small class="text-muted d-block">Discount</small>
                                    <strong class="text-warning fs-5">${department.discount.toLocaleString()}</strong>
                                </div>
                                <div class="col-md-3 text-center">
                                    <small class="text-muted d-block">Return</small>
                                    <strong class="text-danger fs-5">${department.returnAmount.toLocaleString()}</strong>
                                </div>
                                <div class="col-md-3 text-center">
                                    <small class="text-muted d-block">Net Sale</small>
                                    <strong class="text-success fs-5">${department.netSale.toLocaleString()}</strong>
                                </div>
                            </div>
                            
                            <!-- Transaction Details -->
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Branch</th>
                                            <th>Sub-Department</th>
                                            <th class="text-end">Gross Sale</th>
                                            <th class="text-end">Discount</th>
                                            <th class="text-end">Return</th>
                                            <th class="text-end">GST</th>
                                            <th class="text-end">Net Sale</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${department.transactions.map(trans => `
                                            <tr>
                                                <td>${formatDate(trans.date)}</td>
                                                <td>${trans.branch}</td>
                                                <td>${trans.subDepartment}</td>
                                                <td class="text-end">${trans.grossSale.toLocaleString()}</td>
                                                <td class="text-end text-warning">${trans.discount.toLocaleString()}</td>
                                                <td class="text-end text-danger">${trans.returnAmount.toLocaleString()}</td>
                                                <td class="text-end">${trans.gst.toLocaleString()}</td>
                                                <td class="text-end text-success">
                                                    <strong>${trans.netSale.toLocaleString()}</strong>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                summaryCards.appendChild(card);
            });
            
            // Render Grand Total Card in separate section (after filter button)
            const grandTotalSection = document.getElementById('grandTotalSection');
            if (grandTotalSection) {
                if (grandTotalNetSale > 0) {
                    grandTotalSection.style.display = 'block';
                    grandTotalSection.innerHTML = `
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-info text-white">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Grand Total (All Departments)</h5>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="badge bg-light text-dark fs-6">${grandTotalTransactions} Total Transactions</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 text-center mb-3">
                                        <small class="d-block text-muted mb-1">Gross Sale</small>
                                        <strong class="fs-4 text-dark">${grandTotalGrossSale.toLocaleString()}</strong>
                                    </div>
                                    <div class="col-md-3 text-center mb-3">
                                        <small class="d-block text-muted mb-1">Discount</small>
                                        <strong class="fs-4 text-dark">${grandTotalDiscount.toLocaleString()}</strong>
                                    </div>
                                    <div class="col-md-3 text-center mb-3">
                                        <small class="d-block text-muted mb-1">Return</small>
                                        <strong class="fs-4 text-dark">${grandTotalReturn.toLocaleString()}</strong>
                                    </div>
                                    <div class="col-md-3 text-center mb-3">
                                        <small class="d-block text-muted mb-1">Net Sale</small>
                                        <strong class="fs-3 text-primary">${grandTotalNetSale.toLocaleString()}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    grandTotalSection.style.display = 'none';
                    grandTotalSection.innerHTML = '';
                }
            }
        }
        
        // Load Department Sales Table
        function loadDeptSalesTable(sales, grandTotals = null) {
            const tableBody = document.getElementById('deptSalesListTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (!sales || sales.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No department sales found</td></tr>';
                return;
            }
            
            const permissions = appData.currentUser?.permissions || [];
            const isAdmin = permissions.includes('admin');
            const canEditSale = isAdmin || permissions.includes('sales-edit');
            const canDeleteSale = isAdmin || permissions.includes('sales-delete');
            
            sales.forEach(sale => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="display: none;">${sale._id}</td>
                    <td>${formatDate(sale.date)}</td>
                    <td>${sale.branchId?.name || 'Unknown'}</td>
                    <td>${sale.departmentId?.name || 'Unknown'}</td>
                    <td>${sale.subDepartmentId?.name || 'Unknown'}</td>
                    <td class="text-end">${(sale.grossSale || 0).toLocaleString()}</td>
                    <td class="text-end">${(sale.discountAmount || 0).toLocaleString()}</td>
                    <td class="text-end text-success"><strong>${(sale.netSale || 0).toLocaleString()}</strong></td>
                    <td>
                        <div class="d-flex gap-1">
                            ${canEditSale ? `<button class="btn btn-sm btn-primary" onclick="editDeptSale('${sale._id}')"><i class="fas fa-edit"></i></button>` : ''}
                            ${canDeleteSale ? `<button class="btn btn-sm btn-danger" onclick="deleteDeptSale('${sale._id}')"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add grand total row if grandTotals are provided
            if (grandTotals) {
                const grandTotalRow = document.createElement('tr');
                grandTotalRow.className = 'table-info';
                grandTotalRow.style.fontWeight = 'bold';
                grandTotalRow.style.backgroundColor = '#d1ecf1';
                grandTotalRow.innerHTML = `
                    <td style="display: none;"></td>
                    <td colspan="4" class="text-end"><strong>Grand Total (All Departments):</strong></td>
                    <td class="text-end"><strong>${grandTotals.grossSale.toLocaleString()}</strong></td>
                    <td class="text-end"><strong>${grandTotals.discountAmount.toLocaleString()}</strong></td>
                    <td class="text-end text-success"><strong>${grandTotals.netSale.toLocaleString()}</strong></td>
                    <td></td>
                `;
                tableBody.appendChild(grandTotalRow);
            }
        }
        
        // Edit Department Sale - Make globally accessible
        window.editDeptSale = function(id) {
            const permissions = appData.currentUser?.permissions || [];
            const isAdmin = permissions.includes('admin');
            if (!isAdmin && !permissions.includes('sales-edit')) {
                showNotification("You don't have permission to edit department sales", 'error');
                return;
            }
            api.getDepartmentSale(id).then(sale => {
                if (sale) {
                    // Populate form with sale data
                    document.getElementById('editDeptSaleId').value = sale._id;
                    document.getElementById('editDeptSaleDate').value = formatDateForInput(sale.date);
                    document.getElementById('editDeptSaleBranch').value = sale.branchId._id || sale.branchId;
                    
                    // Load departments for the selected branch
                    loadDepartmentsForEditDeptSale(sale.branchId._id || sale.branchId).then(() => {
                        document.getElementById('editDeptSaleDepartment').value = sale.departmentId._id || sale.departmentId;
                        
                        // Load sub-departments for the selected department
                        loadSubDepartmentsForEditDeptSale(sale.departmentId._id || sale.departmentId).then(() => {
                            document.getElementById('editDeptSaleSubDepartment').value = sale.subDepartmentId._id || sale.subDepartmentId;
                            
                            // Populate other fields
                            document.getElementById('editDeptSaleGrossSale').value = sale.grossSale || 0;
                            document.getElementById('editDeptSaleDiscount').value = sale.discountAmount || 0;
                            document.getElementById('editDeptSaleReturn').value = sale.returnAmount || 0;
                            document.getElementById('editDeptSaleGST').value = sale.gst || 0;
                            document.getElementById('editDeptSaleNetSale').value = sale.netSale || 0;
                            document.getElementById('editDeptSaleNotes').value = sale.notes || '';
                            
                            // Calculate net sale to ensure it's correct
                            const grossSale = parseFloat(sale.grossSale) || 0;
                            const discount = parseFloat(sale.discountAmount) || 0;
                            const returnAmount = parseFloat(sale.returnAmount) || 0;
                            const gst = parseFloat(sale.gst) || 0;
                            const saleValue = grossSale - discount;
                            const netSale = saleValue - returnAmount + gst;
                            document.getElementById('editDeptSaleNetSale').value = netSale.toFixed(2);
                            
                            // Show modal
                            const modal = new bootstrap.Modal(document.getElementById('editDeptSaleModal'));
                            modal.show();
                        });
                    });
                }
            }).catch(error => {
                console.error('Error fetching department sale:', error);
                showNotification('Failed to load department sale data', 'error');
            });
        };
        
        // Load departments for edit department sale modal
        function loadDepartmentsForEditDeptSale(branchId) {
            return new Promise((resolve, reject) => {
                if (!branchId) {
                    document.getElementById('editDeptSaleDepartment').innerHTML = '<option value="">Select Department</option>';
                    document.getElementById('editDeptSaleSubDepartment').innerHTML = '<option value="">Select Sub-Department</option>';
                    document.getElementById('editDeptSaleSubDepartment').disabled = true;
                    resolve();
                    return;
                }
                
                api.getDepartments(branchId).then(departments => {
                    const departmentSelect = document.getElementById('editDeptSaleDepartment');
                    departmentSelect.innerHTML = '<option value="">Select Department</option>';
                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept._id;
                        option.textContent = dept.name;
                        departmentSelect.appendChild(option);
                    });
                    resolve();
                }).catch(error => {
                    console.error('Error loading departments:', error);
                    reject(error);
                });
            });
        }
        
        // Load sub-departments for edit department sale modal
        function loadSubDepartmentsForEditDeptSale(departmentId) {
            return new Promise((resolve, reject) => {
                if (!departmentId) {
                    document.getElementById('editDeptSaleSubDepartment').innerHTML = '<option value="">Select Sub-Department</option>';
                    document.getElementById('editDeptSaleSubDepartment').disabled = true;
                    resolve();
                    return;
                }
                
                document.getElementById('editDeptSaleSubDepartment').disabled = false;
                document.getElementById('editDeptSaleSubDepartment').innerHTML = '<option value="">Loading...</option>';
                
                api.getSubDepartmentsByDepartment(departmentId).then(subDepts => {
                    const subDeptSelect = document.getElementById('editDeptSaleSubDepartment');
                    subDeptSelect.innerHTML = '<option value="">Select Sub-Department</option>';
                    subDepts.forEach(subDept => {
                        const option = document.createElement('option');
                        option.value = subDept._id;
                        option.textContent = subDept.name;
                        subDeptSelect.appendChild(option);
                    });
                    resolve();
                }).catch(error => {
                    console.error('Error loading sub-departments:', error);
                    document.getElementById('editDeptSaleSubDepartment').innerHTML = '<option value="">Select Sub-Department</option>';
                    reject(error);
                });
            });
        }
        
        // Update Department Sale
        function updateDeptSale() {
            const id = document.getElementById('editDeptSaleId').value;
            const grossSale = parseFloat(document.getElementById('editDeptSaleGrossSale').value) || 0;
            const discountAmount = parseFloat(document.getElementById('editDeptSaleDiscount').value) || 0;
            const returnAmount = parseFloat(document.getElementById('editDeptSaleReturn').value) || 0;
            const gst = parseFloat(document.getElementById('editDeptSaleGST').value) || 0;
            const saleValue = grossSale - discountAmount;
            const netSale = saleValue - returnAmount + gst;
            
            const saleData = {
                date: document.getElementById('editDeptSaleDate').value,
                branchId: document.getElementById('editDeptSaleBranch').value,
                departmentId: document.getElementById('editDeptSaleDepartment').value,
                subDepartmentId: document.getElementById('editDeptSaleSubDepartment').value,
                grossSale: grossSale,
                discountAmount: discountAmount,
                discountPercent: grossSale > 0 ? (discountAmount / grossSale * 100) : 0,
                saleValue: saleValue,
                returnAmount: returnAmount,
                gst: gst,
                netSale: netSale,
                subDepartmentTotal: netSale,
                notes: document.getElementById('editDeptSaleNotes').value
            };
            
            api.updateDepartmentSale(id, saleData).then(() => {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('editDeptSaleModal')).hide();
                
                // Show notification
                showNotification('Department sale updated successfully!', 'success');
                
                // Refresh department sales list if it's visible
                const deptSalesListSection = document.getElementById('deptSalesListSection');
                if (deptSalesListSection && deptSalesListSection.style.display !== 'none') {
                    loadDeptSalesList();
                }
                
                // Update dashboard if we're on dashboard
                const dashboardSection = document.getElementById('dashboard-section');
                const shopDashboardTab = document.getElementById('shop-dashboard-tab');
                if (dashboardSection && dashboardSection.classList.contains('active')) {
                    // If shop dashboard is active, reload with latest date logic
                    if (shopDashboardTab && shopDashboardTab.classList.contains('active')) {
                        const dateRangeFilter = document.getElementById('shopDashboardDateRangeFilter');
                        const monthFilter = document.getElementById('shopDashboardMonthFilter');
                        // Only reset if no explicit filter is set
                        if (dateRangeFilter && dateRangeFilter.value === 'currentMonth' && 
                            monthFilter && !monthFilter.value) {
                            loadDashboard(null, 'shop');
                        } else {
                            loadDashboard();
                        }
                    } else {
                        loadDashboard();
                    }
                }
            }).catch(error => {
                console.error('Error updating department sale:', error);
                showNotification('Failed to update department sale', 'error');
            });
        }
        
        // Delete Department Sale - Make globally accessible
        window.deleteDeptSale = function(id) {
            const permissions = appData.currentUser?.permissions || [];
            const isAdmin = permissions.includes('admin');
            if (!isAdmin && !permissions.includes('sales-delete')) {
                showNotification("You don't have permission to delete department sales", 'error');
                return;
            }
            if (confirm('Are you sure you want to delete this department sale?')) {
                api.deleteDepartmentSale(id).then(() => {
                    showNotification('Department sale deleted successfully!', 'success');
                    
                    // Refresh the list if it's visible
                    const deptSalesListSection = document.getElementById('deptSalesListSection');
                    if (deptSalesListSection && deptSalesListSection.style.display !== 'none') {
                        loadDeptSalesList();
                    }
                    
                    // Update dashboard if we're on dashboard
                    const dashboardSection = document.getElementById('dashboard-section');
                    const shopDashboardTab = document.getElementById('shop-dashboard-tab');
                    if (dashboardSection && dashboardSection.classList.contains('active')) {
                        // If shop dashboard is active, reload with latest date logic
                        if (shopDashboardTab && shopDashboardTab.classList.contains('active')) {
                            const dateRangeFilter = document.getElementById('shopDashboardDateRangeFilter');
                            const monthFilter = document.getElementById('shopDashboardMonthFilter');
                            // Only reset if no explicit filter is set
                            if (dateRangeFilter && dateRangeFilter.value === 'currentMonth' && 
                                monthFilter && !monthFilter.value) {
                                loadDashboard(null, 'shop');
                            } else {
                                loadDashboard();
                            }
                        } else {
                            loadDashboard();
                        }
                    }
                }).catch(error => {
                    console.error('Error deleting department sale:', error);
                    showNotification('Failed to delete department sale', 'error');
                });
            }
        };
        
        // ========================================
        // PAYMENT VOUCHER FUNCTIONS (NEW SYSTEM)
        // ========================================
        
        // Initialize Payment Module Tabs
        function initializePaymentModuleTabs() {
            document.querySelectorAll('[data-payment-tab]').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-payment-tab');
                    showPaymentTab(tabName);
                });
            });
        }
        
        // Show Payment Tab
        function showPaymentTab(tabName) {
            try {
                // Permission guard: require exact permission for the tab
                const permissions = appData.currentUser?.permissions || [];
                if (tabName && tabName.startsWith('payment-') && !permissions.includes(tabName)) {
                    showNotification(`You don't have permission to access ${tabName}`, 'error');
                    return;
                }
                
                // Update active tab - add null check
                const allTabs = document.querySelectorAll('[data-payment-tab]');
                if (allTabs.length > 0) {
                    allTabs.forEach(t => {
                        if (t) t.classList.remove('active');
                    });
                    
                    const tabElement = document.querySelector(`[data-payment-tab="${tabName}"]`);
                    if (tabElement) {
                        tabElement.classList.add('active');
                    } else {
                        console.warn(`Tab element with data-payment-tab="${tabName}" not found`);
                    }
                }
                
                // Show/hide tab content - add null check
                const allTabContents = document.querySelectorAll('.report-tab-content');
                if (allTabContents.length > 0) {
                    allTabContents.forEach(content => {
                        if (content && content.id && content.id.startsWith('tab-payment-')) {
                            content.classList.remove('active');
                        }
                    });
                    
                    const tabContentElement = document.getElementById(`tab-${tabName}`);
                    if (tabContentElement) {
                        tabContentElement.classList.add('active');
                    }
                }
                
                // Map tab names to section IDs for navigation
                const tabToSectionMap = {
                    'payment-dashboard': 'payment-dashboard-section',
                    'payment-voucher-list': 'payment-voucher-list-section',
                    'payment-vouchers': 'payment-vouchers-section',
                    'payment-reports': 'payment-reports-section'
                };
                
                // If tab system doesn't exist, use section navigation instead
                const sectionId = tabToSectionMap[tabName];
                if (sectionId && document.getElementById(sectionId)) {
                    const sectionElement = document.getElementById(sectionId);
                    if (sectionElement) {
                        // Hide all sections first
                        document.querySelectorAll('.content-section').forEach(s => {
                            s.classList.remove('active');
                            s.style.display = 'none';
                        });
                        
                        // Show target section
                        sectionElement.classList.add('active');
                        sectionElement.style.display = 'block';
                        
                        // Update sidebar navigation
                        const sidebarLink = document.querySelector(`[data-section="${tabName}"]`);
                        if (sidebarLink) {
                            document.querySelectorAll('[data-section]').forEach(link => {
                                link.classList.remove('active');
                            });
                            sidebarLink.classList.add('active');
                        }
                    }
                }
                
                // Initialize tab-specific content
                if (tabName === 'payment-dashboard') {
                    updatePaymentDashboard();
                } else if (tabName === 'payment-voucher-list') {
                    loadPaymentVoucherList();
                } else if (tabName === 'payment-vouchers') {
                    initializePaymentVoucherForm();
                    // Also initialize category voucher form when payment vouchers section is shown
                    setTimeout(() => {
                        initializeCategoryVoucherForm();
                    }, 100);
                } else if (tabName === 'payment-reports') {
                    initPaymentReportChart();
                }
            } catch (error) {
                console.error('Error in showPaymentTab:', error);
                // Fallback: try to navigate to section directly
                const sectionId = `${tabName}-section`;
                if (document.getElementById(sectionId)) {
                    showSection(tabName);
                }
            }
        }
        
        // Utility function to detect and fix invisible elements
        function ensureElementVisible(elementId, debug = false) {
            const element = document.getElementById(elementId);
            if (!element) {
                if (debug) console.warn(' Element not found:', elementId);
                return false;
            }
            
            const computed = window.getComputedStyle(element);
            const isVisible = computed.display !== 'none' && 
                            computed.visibility !== 'hidden' && 
                            computed.opacity !== '0' &&
                            element.offsetHeight > 0 &&
                            element.offsetWidth > 0;
            
            if (!isVisible) {
                if (debug) {
                    console.warn(' Element is invisible:', {
                        id: elementId,
                        display: computed.display,
                        visibility: computed.visibility,
                        opacity: computed.opacity,
                        height: element.offsetHeight,
                        width: element.offsetWidth,
                        hasActiveClass: element.classList.contains('active')
                    });
                }
                
                // Force visibility
                element.style.display = 'block';
                element.style.visibility = 'visible';
                element.style.opacity = '1';
                element.classList.add('active');
                
                // Force reflow
                void element.offsetHeight;
                
                if (debug) {
                    console.log(' Forced visibility for:', elementId);
                }
                
                return true;
            }
            
            return true;
        }
        
        // Initialize Payment Voucher Form
        function initializePaymentVoucherForm() {
            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializePaymentVoucherForm);
                return;
            }
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            const voucherDateEl = document.getElementById('paymentVoucherDate');
            if (voucherDateEl) {
                voucherDateEl.value = today;
            }
            
            // Generate voucher number
            generatePaymentVoucherNumber();
            
            // Populate dropdowns
            populatePaymentVoucherDropdowns();
            
            // Ensure section AND all child elements are visible using our utility
            requestAnimationFrame(() => {
                const visible = ensureElementVisible('payment-vouchers-section', true);
                if (!visible) {
                    console.error(' Failed to make payment-vouchers-section visible');
                }
                
                // Also ensure child elements are visible
                const section = document.getElementById('payment-vouchers-section');
                if (section) {
                    // Make sure card is visible
                    const card = section.querySelector('.card');
                    if (card) {
                        card.style.display = 'block';
                        card.style.visibility = 'visible';
                        card.style.opacity = '1';
                    }
                    
                    // Make sure form is visible
                    const form = section.querySelector('#paymentVoucherForm');
                    if (form) {
                        form.style.display = 'block';
                        form.style.visibility = 'visible';
                    }
                    
                    // Make sure card-body is visible
                    const cardBody = section.querySelector('.card-body');
                    if (cardBody) {
                        cardBody.style.display = 'block';
                        cardBody.style.visibility = 'visible';
                    }
                    
                    // Make sure dashboard-header is visible
                    const header = section.querySelector('.dashboard-header');
                    if (header) {
                        header.style.display = 'block';
                        header.style.visibility = 'visible';
                    }
                    
                    // Log final visibility status for debugging
                    console.log(' Payment vouchers visibility check:', {
                        sectionHeight: section.offsetHeight,
                        cardHeight: card?.offsetHeight || 0,
                        formHeight: form?.offsetHeight || 0,
                        cardBodyHeight: cardBody?.offsetHeight || 0,
                        headerHeight: header?.offsetHeight || 0,
                        sectionDisplay: window.getComputedStyle(section).display,
                        cardDisplay: card ? window.getComputedStyle(card).display : 'N/A'
                    });
                }
            });
        }
        
        // Generate Payment Voucher Number
        function generatePaymentVoucherNumber() {
            const voucherNumberEl = document.getElementById('paymentVoucherNumber');
            if (!voucherNumberEl) return;
            
            // Try to fetch from server, with fallback
            api.getNextVoucherNumber()
                .then(response => {
                    if (voucherNumberEl && response && response.voucherNumber) {
                        voucherNumberEl.value = response.voucherNumber;
                    } else {
                        // Fallback if response format is unexpected
                        if (!voucherNumberEl.value) {
                            voucherNumberEl.value = 'PV1001';
                        }
                    }
                })
                .catch(error => {
                    console.warn('Error fetching voucher number from server, using fallback:', error.message);
                    // Fallback: generate client-side or use default
                    if (voucherNumberEl && !voucherNumberEl.value) {
                        voucherNumberEl.value = 'PV1001';
                    }
                });
        }
        
        // Save New Payment Voucher
        function saveNewPaymentVoucher() {
            const voucherNumber = document.getElementById('paymentVoucherNumber').value;
            const date = document.getElementById('paymentVoucherDate').value;
            const supplierId = document.getElementById('paymentVoucherSupplier').value;
            const branchId = document.getElementById('paymentVoucherBranch').value;
            const paymentMethod = document.getElementById('paymentVoucherMethod').value;
            const amount = parseFloat(document.getElementById('paymentVoucherAmount').value);
            const description = document.getElementById('paymentVoucherDescription').value;
            
            if (!date || !supplierId || !branchId || !paymentMethod || !amount) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            const voucherData = {
                voucherNumber: voucherNumber,
                voucherType: 'supplier',
                date: date,
                supplierId: supplierId,
                branchId: branchId,
                paymentMethod: paymentMethod,
                amount: amount,
                description: description,
                status: 'Pending'
            };
            
            api.createPayment(voucherData)
                .then(() => {
                    showNotification('Voucher saved successfully!', 'success');
                    resetPaymentVoucherForm();
                    loadPaymentVoucherList();
                    updatePaymentDashboard();
                    // Stay on the form - don't switch to list
                    // showPaymentTab('payment-voucher-list'); // Removed - stay on form after save
                })
                .catch(error => {
                    console.error('Error saving voucher:', error);
                    showNotification('Failed to save voucher: ' + (error.message || 'Unknown error'), 'error');
                });
        }
        
        // Update Payment Voucher
        function updatePaymentVoucher(id) {
            const date = document.getElementById('paymentVoucherDate').value;
            const supplierId = document.getElementById('paymentVoucherSupplier').value;
            const branchId = document.getElementById('paymentVoucherBranch').value;
            const paymentMethod = document.getElementById('paymentVoucherMethod').value;
            const amount = parseFloat(document.getElementById('paymentVoucherAmount').value);
            const description = document.getElementById('paymentVoucherDescription').value;
            
            if (!date || !supplierId || !branchId || !paymentMethod || !amount) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            const voucherData = {
                voucherType: 'supplier',
                date: date,
                supplierId: supplierId,
                branchId: branchId,
                paymentMethod: paymentMethod,
                amount: amount,
                description: description
            };
            
            api.updatePayment(id, voucherData)
                .then(() => {
                    showNotification('Voucher updated successfully!', 'success');
                    document.getElementById('paymentVoucherForm').removeAttribute('data-voucher-id');
                    resetPaymentVoucherForm();
                    loadPaymentVoucherList();
                    updatePaymentDashboard();
                    // Stay on the form - don't switch to list
                    // showPaymentTab('payment-voucher-list');
                })
                .catch(error => {
                    console.error('Error updating voucher:', error);
                    showNotification('Failed to update voucher', 'error');
                });
        }
        
        // Populate Payment Voucher Dropdowns
        function populatePaymentVoucherDropdowns() {
            // Check if suppliers data exists
            if (!appData.suppliers || !Array.isArray(appData.suppliers)) {
                console.warn('Suppliers data not available');
                return;
            }
            
            // Populate supplier dropdown in voucher form
            const supplierSelect = document.getElementById('paymentVoucherSupplier');
            if (supplierSelect) {
                const firstOption = supplierSelect.options[0];
                supplierSelect.innerHTML = '';
                if (firstOption) supplierSelect.appendChild(firstOption);
                appData.suppliers.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s._id;
                    option.textContent = s.name;
                    supplierSelect.appendChild(option);
                });
            }
            
            // Check if branches data exists
            if (!appData.branches || !Array.isArray(appData.branches)) {
                console.warn('Branches data not available');
                return;
            }
            
            // Populate branch dropdown in voucher form
            const branchSelect = document.getElementById('paymentVoucherBranch');
            if (branchSelect) {
                const firstOption = branchSelect.options[0];
                branchSelect.innerHTML = '';
                if (firstOption) branchSelect.appendChild(firstOption);
                appData.branches.forEach(b => {
                    const option = document.createElement('option');
                    option.value = b._id;
                    option.textContent = b.name;
                    branchSelect.appendChild(option);
                });
            }
            
            // Populate all payment module filters
            populatePaymentModuleFilters();
        }
        
        // Populate Payment Module Filters
        function populatePaymentModuleFilters() {
            // Check if data exists
            if (!appData.branches || !Array.isArray(appData.branches)) {
                console.warn('Branches data not available');
            }
            if (!appData.suppliers || !Array.isArray(appData.suppliers)) {
                console.warn('Suppliers data not available');
            }
            
            const selectors = [
                'paymentDashboardBranchFilter',
                'paymentDashboardSupplierFilter',
                'paymentVoucherListBranchFilter',
                'paymentVoucherListSupplierFilter',
                'paymentReportBranch',
                'paymentReportSupplier',
                'paymentReportBranchFilter' // Payment reports tab in reports section
            ];
            
            selectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    const firstOption = selector.options[0];
                    selector.innerHTML = '';
                    if (firstOption) selector.appendChild(firstOption);
                    
                    if (selectorId.includes('Branch') && appData.branches && Array.isArray(appData.branches)) {
                        appData.branches.forEach(b => {
                            const option = document.createElement('option');
                            option.value = b._id;
                            option.textContent = b.name;
                            selector.appendChild(option);
                        });
                    } else if (selectorId.includes('Supplier') && appData.suppliers && Array.isArray(appData.suppliers)) {
                        appData.suppliers.forEach(s => {
                            const option = document.createElement('option');
                            option.value = s._id;
                            option.textContent = s.name;
                            selector.appendChild(option);
                        });
                    }
                }
            });
        }
        
        // Save Payment Voucher
        function savePaymentVoucher(voucherData) {
            return api.createPayment(voucherData);
        }
        
        // Reset Payment Voucher Form
        function resetPaymentVoucherForm() {
            const form = document.getElementById('paymentVoucherForm');
            if (form) {
                form.reset();
                generatePaymentVoucherNumber();
                const today = new Date().toISOString().split('T')[0];
                const voucherDateEl = document.getElementById('paymentVoucherDate');
                if (voucherDateEl) voucherDateEl.value = today;
            }
        }
        
        // ========================================
        // CATEGORY VOUCHER FUNCTIONS
        // ========================================
        
        // Initialize Category Voucher Form
        function initializeCategoryVoucherForm() {
            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeCategoryVoucherForm);
                return;
            }
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            const voucherDateEl = document.getElementById('categoryVoucherDate');
            if (voucherDateEl) {
                voucherDateEl.value = today;
            }
            
            // Generate voucher number
            generateCategoryVoucherNumber();
            
            // Populate dropdowns
            populateCategoryVoucherDropdowns();
        }
        
        // Generate Category Voucher Number
        function generateCategoryVoucherNumber() {
            const voucherNumberEl = document.getElementById('categoryVoucherNumber');
            if (!voucherNumberEl) return;
            
            // Try to fetch from server using category payments API, with fallback
            api.getNextCategoryVoucherNumber()
                .then(response => {
                    if (voucherNumberEl && response && response.voucherNumber) {
                        voucherNumberEl.value = response.voucherNumber;
                    } else {
                        // Fallback if response format is unexpected
                        if (!voucherNumberEl.value) {
                            voucherNumberEl.value = 'PV1001';
                        }
                    }
                })
                .catch(error => {
                    console.warn('Error fetching voucher number from server, using fallback:', error.message);
                    // Fallback: generate client-side or use default
                    if (voucherNumberEl && !voucherNumberEl.value) {
                        voucherNumberEl.value = 'PV1001';
                    }
                });
        }
        
        // Save New Category Voucher
        function saveNewCategoryVoucher() {
            const voucherNumber = document.getElementById('categoryVoucherNumber').value;
            const date = document.getElementById('categoryVoucherDate').value;
            const categoryId = document.getElementById('categoryVoucherCategory').value;
            const branchId = document.getElementById('categoryVoucherBranch').value;
            const paymentMethod = document.getElementById('categoryVoucherMethod').value;
            const amount = parseFloat(document.getElementById('categoryVoucherAmount').value);
            const description = document.getElementById('categoryVoucherDescription').value;
            
            if (!date || !categoryId || !branchId || !paymentMethod || !amount) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            // Get category name
            const categoryName = appData.categories.find(c => c._id === categoryId)?.name || 'Category Payment';
            
            // Use SEPARATE category payments API
            const voucherData = {
                voucherNumber: voucherNumber,
                date: date,
                categoryId: categoryId,
                category: categoryName,
                branchId: branchId,
                paymentMethod: paymentMethod,
                amount: amount,
                description: description,
                status: 'Pending'
            };
            
            api.createCategoryPayment(voucherData)
                .then(() => {
                    showNotification('Category voucher saved successfully!', 'success');
                    resetCategoryVoucherForm();
                    loadCategoryVoucherListTab();
                    updatePaymentDashboard();
                    // Stay on the form - don't switch to list
                    // showSection('payment-voucher-list'); // Removed - stay on form after save
                    // setTimeout(() => {
                    //     const categoryTab = document.getElementById('category-voucher-list-tab');
                    //     if (categoryTab) {
                    //         const bsTab = new bootstrap.Tab(categoryTab);
                    //         bsTab.show();
                    //     }
                    // }, 300);
                })
                .catch(error => {
                    console.error('Error saving category voucher:', error);
                    showNotification('Failed to save voucher: ' + (error.message || 'Unknown error'), 'error');
                });
        }
        
        // Update Category Voucher
        function updateCategoryVoucher(id) {
            const date = document.getElementById('categoryVoucherDate').value;
            const categoryId = document.getElementById('categoryVoucherCategory').value;
            const branchId = document.getElementById('categoryVoucherBranch').value;
            const paymentMethod = document.getElementById('categoryVoucherMethod').value;
            const amount = parseFloat(document.getElementById('categoryVoucherAmount').value);
            const description = document.getElementById('categoryVoucherDescription').value;
            
            if (!date || !categoryId || !branchId || !paymentMethod || !amount) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            // Get category name
            const categoryName = appData.categories.find(c => c._id === categoryId)?.name || 'Category Payment';
            
            // Use SEPARATE category payments API
            const voucherData = {
                date: date,
                categoryId: categoryId,
                category: categoryName,
                branchId: branchId,
                paymentMethod: paymentMethod,
                amount: amount,
                description: description
            };
            
            api.updateCategoryPayment(id, voucherData)
                .then(() => {
                    showNotification('Category voucher updated successfully!', 'success');
                    document.getElementById('categoryVoucherForm').removeAttribute('data-voucher-id');
                    resetCategoryVoucherForm();
                    loadCategoryVoucherListTab();
                    updatePaymentDashboard();
                    // Stay on the form - don't switch to list
                    // showSection('payment-voucher-list'); // Removed - stay on form after save
                    // setTimeout(() => {
                    //     const categoryTab = document.getElementById('category-voucher-list-tab');
                    //     if (categoryTab) {
                    //         const bsTab = new bootstrap.Tab(categoryTab);
                    //         bsTab.show();
                    //     }
                    // }, 300);
                })
                .catch(error => {
                    console.error('Error updating category voucher:', error);
                    showNotification('Failed to update voucher', 'error');
                });
        }
        
        // Populate Category Voucher Dropdowns
        function populateCategoryVoucherDropdowns() {
            // Check if categories data exists
            if (!appData.categories || !Array.isArray(appData.categories)) {
                console.warn('Categories data not available');
                // Try to load categories if not available
                if (api && api.getCategories) {
                    api.getCategories().then(categories => {
                        if (categories && Array.isArray(categories)) {
                            appData.categories = categories;
                            populateCategoryVoucherDropdowns();
                        }
                    }).catch(err => {
                        console.error('Error loading categories:', err);
                    });
                }
                return;
            }
            
            // Populate category dropdown in voucher form
            const categorySelect = document.getElementById('categoryVoucherCategory');
            if (categorySelect) {
                const firstOption = categorySelect.options[0];
                categorySelect.innerHTML = '';
                if (firstOption) categorySelect.appendChild(firstOption);
                appData.categories.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c._id;
                    option.textContent = c.name;
                    categorySelect.appendChild(option);
                });
            }
            
            // Check if branches data exists
            if (!appData.branches || !Array.isArray(appData.branches)) {
                console.warn('Branches data not available');
                return;
            }
            
            // Populate branch dropdown in voucher form
            const branchSelect = document.getElementById('categoryVoucherBranch');
            if (branchSelect) {
                const firstOption = branchSelect.options[0];
                branchSelect.innerHTML = '';
                if (firstOption) branchSelect.appendChild(firstOption);
                appData.branches.forEach(b => {
                    const option = document.createElement('option');
                    option.value = b._id;
                    option.textContent = b.name;
                    branchSelect.appendChild(option);
                });
            }
        }
        
        // Reset Category Voucher Form
        function resetCategoryVoucherForm() {
            const form = document.getElementById('categoryVoucherForm');
            if (form) {
                form.reset();
                generateCategoryVoucherNumber();
                const today = new Date().toISOString().split('T')[0];
                const voucherDateEl = document.getElementById('categoryVoucherDate');
                if (voucherDateEl) voucherDateEl.value = today;
            }
        }
        
        // Load Payment Voucher List
        function loadPaymentVoucherList(methodFilter) {
            const listSection = document.getElementById('payment-voucher-list-section');
            if (!listSection || listSection.style.display === 'none') {
                return; // Don't load if section is not visible
            }
            
            // Check permissions before making API call
            const permissions = appData.currentUser?.permissions || [];
            if (!permissions.includes('admin') && !permissions.includes('payment-voucher-list')) {
                showNotification('Access denied. You do not have permission to view supplier voucher list.', 'error');
                // Clear the table to show empty state
                const tbody = document.querySelector('#payment-voucher-list-section table tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">Access denied. You do not have permission to view supplier voucher list.</td></tr>';
                }
                return;
            }
            
            // Save current checkbox selections before refresh
            const checkedBoxes = Array.from(document.querySelectorAll('.payment-select:checked'));
            const selectedIds = checkedBoxes.map(cb => cb.value);
            window.appData = window.appData || {};
            appData.paymentVoucherSelectedIds = selectedIds;
            
            const branchFilter = document.getElementById('paymentVoucherListBranchFilter')?.value || '';
            const supplierFilter = document.getElementById('paymentVoucherListSupplierFilter')?.value || '';
            const fromDate = document.getElementById('paymentVoucherListFromDate')?.value || '';
            const toDate = document.getElementById('paymentVoucherListToDate')?.value || '';
            const search = document.getElementById('paymentVoucherSearch')?.value || '';
            
            // Require at least one date to be selected before loading data
            if (!fromDate && !toDate) {
                // Clear/hide existing data
                const tbody = document.querySelector('#payment-voucher-list-section table tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">Please select at least one date (From or To) to view voucher list</td></tr>';
                }
                showNotification('Please select at least one date (From or To) to view voucher list', 'info');
                return;
            }
            
            let url = '/payments?';
            const params = [];
            
            if (branchFilter) params.push(`branchId=${branchFilter}`);
            if (supplierFilter) params.push(`supplierId=${supplierFilter}`);
            if (fromDate) params.push(`from=${fromDate}`);
            if (toDate) params.push(`to=${toDate}`);
            
            url += params.join('&');
            
            // Supplier payments API - NO FILTERING NEEDED, backend only returns supplier payments
            api.getPayments(url).then(paymentsData => {
                // Backend /api/payments only returns supplier payments now
                let filteredPayments = paymentsData;
                
                // Apply method filter if provided
                if (methodFilter) {
                    const norm = (m) => String(m || 'Cash').toLowerCase();
                    const target = norm(methodFilter);
                    filteredPayments = filteredPayments.filter(p => norm(p.paymentMethod) === target);
                }
                // Apply search filter if provided
                if (search) {
                    const searchLower = search.toLowerCase();
                    filteredPayments = filteredPayments.filter(p => {
                        return (p.voucherNumber && String(p.voucherNumber).toLowerCase().includes(searchLower)) ||
                               (p.supplierId?.name && String(p.supplierId.name).toLowerCase().includes(searchLower)) ||
                               (p.supplier && String(p.supplier).toLowerCase().includes(searchLower)) ||
                               (p.description && String(p.description).toLowerCase().includes(searchLower)) ||
                               (p.branchId?.name && String(p.branchId.name).toLowerCase().includes(searchLower)) ||
                               (p.paymentMethod && String(p.paymentMethod).toLowerCase().includes(searchLower));
                    });
                }
                
                // Store latest for printing selected
                window.appData = window.appData || {};
                appData.latestPaymentVouchers = filteredPayments;
                renderPaymentVoucherList(filteredPayments);
                
                // Hook select-all checkbox
                const selectAll = document.getElementById('paymentSelectAll');
                if (selectAll) {
                    selectAll.onclick = () => {
                        document.querySelectorAll('.payment-select').forEach(cb => { cb.checked = selectAll.checked; });
                    };
                }

                // Don't force UI update - only update if section is already visible
                // Removed auto-switch to list view
                // setTimeout(() => {
                //     const listSection = document.getElementById('payment-voucher-list-section');
                //     if (listSection) {
                //         listSection.style.display = 'block';
                //         listSection.classList.add('active');
                //     }
                // }, 50);
            }).catch(error => {
                console.error('Error loading supplier voucher list:', error);
                // Check if it's a permission error
                if (error.response && error.response.status === 403) {
                    showNotification('Access denied. You do not have permission to view supplier voucher list.', 'error');
                    const tbody = document.querySelector('#payment-voucher-list-section table tbody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">Access denied. You do not have permission to view supplier voucher list.</td></tr>';
                    }
                } else {
                    showNotification('Failed to load supplier voucher list: ' + (error.message || 'Unknown error'), 'error');
                }
            });
        }
        
        // Render Payment Voucher List
        function renderPaymentVoucherList(vouchers) {
            const tbody = document.getElementById('paymentVoucherListTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (vouchers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No vouchers found</td></tr>';
                return;
            }
            
            // Get previously selected IDs from appData
            const selectedIds = appData.paymentVoucherSelectedIds || [];
            
            // Separate permissions for supplier and category vouchers
            const canEditSupplierVoucher = (appData.currentUser?.permissions || []).includes('payment-edit') || (appData.currentUser?.permissions || []).includes('admin');
            const canDeleteSupplierVoucher = (appData.currentUser?.permissions || []).includes('payment-delete') || (appData.currentUser?.permissions || []).includes('admin');
            const canEditCategoryVoucher = (appData.currentUser?.permissions || []).includes('category-voucher-edit') || (appData.currentUser?.permissions || []).includes('admin');
            const canDeleteCategoryVoucher = (appData.currentUser?.permissions || []).includes('category-voucher-delete') || (appData.currentUser?.permissions || []).includes('admin');
            
            // This list is for SUPPLIER vouchers only (from /api/payments endpoint)
            vouchers.forEach(voucher => {
                const row = document.createElement('tr');
                const branchName = voucher.branchId?.name || 'Unknown';
                // Supplier vouchers only - no need to check type
                const entityName = voucher.supplierId?.name || voucher.supplier || 'Unknown';
                const voucherNum = voucher.voucherNumber || 'N/A';
                
                // Check if this voucher was previously selected
                const isChecked = selectedIds.includes(String(voucher._id));
                
                // Use supplier voucher permissions only (this is supplier voucher list)
                const canEdit = canEditSupplierVoucher;
                const canDelete = canDeleteSupplierVoucher;
                const editFunction = 'editPaymentVoucher';
                const deleteFunction = 'deletePaymentVoucher';
                
                row.innerHTML = `
                    <td class="no-print"><input type="checkbox" class="payment-select" value="${voucher._id}" ${isChecked ? 'checked' : ''}></td>
                    <td>${voucherNum}</td>
                    <td>${formatDate(voucher.date)}</td>
                    <td><span class="badge bg-primary me-1">Supplier</span>${entityName}</td>
                    <td>${branchName}</td>
                    <td>PKR ${voucher.amount.toLocaleString()}</td>
                    <td>${voucher.paymentMethod || 'Cash'}</td>
                    <td>${voucher.description || '-'}</td>
                    <td class="no-print">
                        <button class="btn btn-sm btn-info me-1" onclick="viewPaymentVoucher('${voucher._id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${canEdit ? `<button class="btn btn-sm btn-warning me-1" onclick="${editFunction}('${voucher._id}')"><i class=\"fas fa-edit\"></i></button>` : ''}
                        ${canDelete ? `<button class="btn btn-sm btn-danger" onclick="${deleteFunction}('${voucher._id}')"><i class=\"fas fa-trash\"></i></button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Print only the vouchers selected via checkboxes in the list (professional layout)
        window.printSelectedVouchersList = function() {
            const checked = Array.from(document.querySelectorAll('.payment-select:checked'));
            if (checked.length === 0) {
                showNotification('Please select at least one voucher to print', 'error');
                return;
            }
            const ids = checked.map(c => c.value);
            const all = (window.appData && appData.latestPaymentVouchers) ? appData.latestPaymentVouchers : [];
            const vouchers = all.filter(v => ids.includes(String(v._id)));
            if (vouchers.length === 0) {
                showNotification('Selected vouchers not found in current list', 'error');
                return;
            }
            const companyName = appData.settings?.companyName || 'D.Watson Group of Pharmacy';
            const uniqueBranches = [...new Set(vouchers.map(v => v.branchId?.name || 'Unknown'))];
            const uniqueSuppliers = [...new Set(vouchers.map(v => v.supplierId?.name || v.supplier || 'Unknown'))];
            const branchDisplayName = uniqueBranches.length === 1 ? uniqueBranches[0] : 'Multiple Branches';
            const supplierDisplayName = uniqueSuppliers.length === 1 ? uniqueSuppliers[0] : 'Multiple Suppliers';
            const includeSupplierCol = (uniqueSuppliers.length > 1);

            let printContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Selected Payment Vouchers</title>
    <style>
        * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        @page { size: A4; margin: 0.5in; }
        body { font-family: Arial, sans-serif; font-size: 12pt; line-height: 1.4; color: #000; background: #fff; margin: 0; padding: 20px; }
        .print-header { text-align: center; margin-bottom: 30px; padding: 30px 25px; background: #00685c; color: #ffffff; border-bottom: 3px solid #000; }
        .print-header h2 { margin: 0; font-size: 24pt; font-weight: bold; letter-spacing: 1px; color: #ffffff; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; border: 1px solid #333; background: white; table-layout: fixed; }
        th { padding: 10px 8px; border: 1px solid #333; font-weight: bold; color: #ffffff; font-size: 10pt; text-transform: uppercase; white-space: normal; word-wrap: break-word; line-height: 1.3; }
        td { padding: 10px 8px; border: 1px solid #333; font-size: 11pt; word-wrap: break-word; overflow: hidden; }
        .summary-section { border: 2px solid #000; padding: 25px; margin-top: 35px; background: #ffffff; }
    </style>
</head>
<body>
    <div class="print-header">
        <h2>${companyName}</h2>
        <p style="margin: 10px 0 0 0; font-size: 16pt; font-weight: bold; color: #ffffff; letter-spacing: 2px; text-transform: uppercase;">SELECTED PAYMENT VOUCHERS</p>
        <p style="margin: 8px 0 0 0; font-size: 10pt; color: #ffffff;">Generated: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
    </div>
    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #333;">
        <div style="display: flex; justify-content: space-between; font-size: 13pt; font-weight: bold; color: #000;">
            <div><span style="color: #00685c;">Branch:</span> <span>${branchDisplayName}</span></div>
            <div><span style="color: #00685c;">Supplier:</span> <span>${supplierDisplayName}</span></div>
        </div>
    </div>
    <table>
        <thead>
            <tr style="background: #00685c;">
                <th style="text-align: center; width: 4%; padding: 10px 6px;">#</th>
                <th style="text-align: left; width: 12%; padding: 10px 6px;">V.No</th>
                <th style="text-align: left; width: 10%; padding: 10px 6px;">Date</th>
                ${includeSupplierCol ? '<th style="text-align: left; width: 18%; padding: 10px 6px;">Supplier</th>' : ''}
                <th style="text-align: center; width: 10%; padding: 10px 6px;">PM</th>
                <th style="text-align: left; width: ${includeSupplierCol ? '28%' : '38%'}; padding: 10px 6px;">Description</th>
                <th style="text-align: right; width: 16%; padding: 10px 6px;">Amount</th>
            </tr>
        </thead>
        <tbody>`;

            vouchers.forEach((voucher, index) => {
                const voucherNum = voucher.voucherNumber || 'N/A';
                const voucherDate = formatDate(voucher.date);
                const amount = voucher.amount || 0;
                const paymentMethod = voucher.paymentMethod || 'Cash';
                const supplierName = voucher.supplierId?.name || voucher.supplier || 'Unknown';
                const description = voucher.description || '-';
                const rowBg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';

                printContent += `
            <tr style="background-color: ${rowBg}; vertical-align: top;">
                <td style="padding: 10px 6px; border: 1px solid #333; font-weight: bold; color: #000; text-align: center; font-size: 11pt; width: 4%; vertical-align: top;">${index + 1}</td>
                <td style="padding: 10px 6px; border: 1px solid #333; font-weight: bold; color: #000; font-size: 11pt; width: 12%; vertical-align: top;">${voucherNum}</td>
                <td style="padding: 10px 6px; border: 1px solid #333; color: #000; font-size: 11pt; width: 10%; vertical-align: top;">${voucherDate}</td>
                ${includeSupplierCol ? `<td style=\"padding: 10px 6px; border: 1px solid #333; color: #000; font-size: 11pt; width: 18%; vertical-align: top;\">${supplierName}</td>` : ''}
                <td style="padding: 10px 6px; border: 1px solid #333; text-align: center; color: #000; font-size: 11pt; width: 10%; vertical-align: top;">${paymentMethod}</td>
                <td style="padding: 10px 6px; border: 1px solid #333; color: #000; font-size: 11pt; width: ${includeSupplierCol ? '28%' : '38%'}; white-space: normal; word-wrap: break-word; overflow-wrap: break-word; vertical-align: top; line-height: 1.4;">${description}</td>
                <td style="padding: 10px 6px; border: 1px solid #333; text-align: right; font-weight: bold; color: #000; font-size: 11pt; width: 16%; white-space: nowrap; vertical-align: top;">${amount.toLocaleString()}</td>
            </tr>`;
            });

            const totalAmount = vouchers.reduce((sum, v) => sum + (v.amount || 0), 0);
            printContent += `
        </tbody>
    </table>
    <div class="summary-section">
        <h3 style="text-align:center; margin-bottom:25px; text-transform:uppercase; font-size:16pt; font-weight:bold; color:#000; letter-spacing:2px; padding-bottom:15px; border-bottom:2px solid #333;">SUMMARY</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <tr style="background-color: #f0f0f0;">
                <td style="padding: 12px; border: 1px solid #333; font-weight: bold; width: 30%; background: #f8f9fa; color: #000; font-size: 12pt;">Total Vouchers:</td>
                <td style="padding: 12px; border: 1px solid #333; width: 20%; color: #000; font-weight: bold; font-size: 12pt;">${vouchers.length}</td>
                <td style="padding: 12px; border: 1px solid #333; font-weight: bold; width: 30%; background: #f8f9fa; color: #000; font-size: 12pt;">Total Amount:</td>
                <td style="padding: 12px; border: 1px solid #333; font-weight: bold; width: 20%; text-align: right; color: #000; font-size: 12pt;">${totalAmount.toLocaleString()}</td>
            </tr>
        </table>
    </div>
    <div style="display: flex; justify-content: space-between; margin-top: 60px; padding-top: 35px; border-top: 2px solid #333;">
        <div style="width: 45%; text-align: center;">
            <p style="margin: 0 0 12px 0; font-weight: bold; color: #000; font-size: 12pt; letter-spacing: 0.5px;">PREPARED BY</p>
            <div style="border-top: 2px solid #000; margin-top: 60px; padding-top: 8px;">
                <p style="margin: 0; color: #000; font-size: 10pt; letter-spacing: 0.5px;">Signature & Date</p>
            </div>
        </div>
        <div style="width: 45%; text-align: center;">
            <p style="margin: 0 0 12px 0; font-weight: bold; color: #000; font-size: 12pt; letter-spacing: 0.5px;">CASH RECEIVED BY</p>
            <div style="border-top: 2px solid #000; margin-top: 60px; padding-top: 8px;">
                <p style="margin: 0; color: #000; font-size: 10pt; letter-spacing: 0.5px;">Signature & Date</p>
            </div>
        </div>
    </div>
    </body>
</html>`;

            const w = window.open('', '_blank');
            if (!w) { showNotification('Popup blocked. Please allow popups.', 'error'); return; }
            w.document.write(printContent);
            w.document.close();
            w.focus();
            w.print();
            
            // Uncheck all checkboxes after printing
            setTimeout(() => {
                document.querySelectorAll('.payment-select:checked').forEach(checkbox => {
                    checkbox.checked = false;
                });
                // Also uncheck the "select all" checkbox
                const selectAllCheckbox = document.getElementById('paymentSelectAll');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }
            }, 500);
        };
        
        // View Payment Voucher - Opens in new window like sale report
        // View Category Payment Voucher
        function viewCategoryPaymentVoucher(id) {
            api.getCategoryPayment(id).then(voucher => {
                // Use the same view logic but for category vouchers
                const branchName = voucher.branchId?.name || 'Unknown';
                const entityName = voucher.categoryId?.name || voucher.category || 'Unknown';
                const entityLabel = 'Category';
                const voucherNum = voucher.voucherNumber || 'N/A';
                
                const companyName = appData.settings?.companyName || 'D.Watson Group Of Pharmacies';
                const statusColor = '#155724';
                const statusBg = '#f0f9f4';
                const displayStatus = 'PAID';
                
                // Create complete HTML document for print
                const printContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Category Payment Voucher - ${voucherNum}</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        @page {
            size: A4 portrait;
            margin: 0.5in;
        }
        
        @media screen {
            body {
                background: #f5f5f5;
                padding: 20px;
            }
            .print-container {
                background: white;
                max-width: 800px;
                margin: 0 auto;
                padding: 30px;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
            }
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            .print-container {
                box-shadow: none;
                padding: 0;
            }
            .no-print {
                display: none !important;
            }
        }
        
        .header {
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24pt;
            color: #333;
        }
        
        .header .company-info {
            font-size: 10pt;
            color: #666;
            margin-top: 5px;
        }
        
        .voucher-info {
            margin-bottom: 20px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .info-label {
            font-weight: bold;
            color: #555;
        }
        
        .info-value {
            color: #333;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 11pt;
        }
        
        .footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            text-align: center;
            font-size: 9pt;
            color: #666;
        }
        
        .amount-highlight {
            font-size: 18pt;
            font-weight: bold;
            color: #155724;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="print-container">
        <div class="header">
            <h1>PAYMENT VOUCHER</h1>
            <div class="company-info">${companyName}</div>
        </div>
        
        <div class="voucher-info">
            <div class="info-row">
                <span class="info-label">Voucher Number:</span>
                <span class="info-value">${voucherNum}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Date:</span>
                <span class="info-value">${formatDate(voucher.date)}</span>
            </div>
            <div class="info-row">
                <span class="info-label">${entityLabel}:</span>
                <span class="info-value">${entityName}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Branch:</span>
                <span class="info-value">${branchName}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Payment Method:</span>
                <span class="info-value">${voucher.paymentMethod || 'Cash'}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Status:</span>
                <span class="status-badge" style="color: ${statusColor}; background: ${statusBg};">${displayStatus}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Amount:</span>
                <span class="amount-highlight">PKR ${(voucher.amount || 0).toLocaleString()}</span>
            </div>
            ${voucher.description ? `
            <div class="info-row">
                <span class="info-label">Description:</span>
                <span class="info-value">${voucher.description}</span>
            </div>
            ` : ''}
        </div>
        
        <div class="footer">
            <p>Generated on ${new Date().toLocaleString()}</p>
        </div>
    </div>
</body>
</html>`;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                
                setTimeout(() => {
                    printWindow.print();
                }, 250);
            }).catch(error => {
                console.error('Error fetching category voucher:', error);
                showNotification('Failed to load voucher', 'error');
            });
        }
        
        function viewPaymentVoucher(id) {
            // Try to determine if it's a category or supplier voucher by checking active tab
            const categoryTab = document.getElementById('category-voucher-list-tab');
            const isCategoryTab = categoryTab && categoryTab.classList.contains('active');
            
            const voucherPromise = isCategoryTab ? api.getCategoryPayment(id) : api.getPayment(id);
            
            voucherPromise.then(voucher => {
                const branchName = voucher.branchId?.name || 'Unknown';
                const voucherType = voucher.voucherType || 'supplier';
                let entityName = 'Unknown';
                let entityLabel = 'Category';
                
                // For category vouchers, always show Category; for supplier vouchers, show Supplier
                if (voucherType === 'category' || isCategoryTab) {
                    entityName = voucher.categoryId?.name || voucher.category || 'Unknown';
                    entityLabel = 'Category';
                } else {
                    entityName = voucher.supplierId?.name || voucher.supplier || 'Unknown';
                    entityLabel = 'Supplier';
                }
                
                const voucherNum = voucher.voucherNumber || 'N/A';
                
                const companyName = appData.settings?.companyName || 'D.Watson Group Of Pharmacies';
                // Always show PAID status for vouchers
                const statusColor = '#155724';
                const statusBg = '#f0f9f4';
                const displayStatus = 'PAID';
                
                // Format date as DD-MMM-YYYY (e.g., 02-Nov-2025)
                const voucherDate = new Date(voucher.date);
                const day = String(voucherDate.getDate()).padStart(2, '0');
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const month = monthNames[voucherDate.getMonth()];
                const year = voucherDate.getFullYear();
                const formattedDate = `${day}-${month}-${year}`;
                
                // Get payment method details
                const paymentMethod = voucher.paymentMethod || 'Cash';
                const remarks = voucher.description || voucher.remarks || '';
                const chequeNumber = voucher.chequeNumber || '';
                
                // Format recipient name (uppercase with spaces)
                const recipientName = entityName.toUpperCase().replace(/[^A-Z0-9\s]/g, '');
                
                // Format branch name (uppercase)
                const formattedBranchName = branchName.toUpperCase();
                
                // Create complete HTML document for print (matching the image design exactly)
                const printContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Payment Voucher - ${voucherNum}</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        @page {
            size: A4 portrait;
            margin: 0.3in;
        }
        
        body {
            font-family: Calibri, Arial, sans-serif;
            font-size: 12pt;
            line-height: 1.4;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 10px;
        }
        
        .voucher-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            position: relative;
        }
        
        .header-band {
            background: #000;
            color: #fff;
            padding: 8px 20px;
            text-align: center;
            vertical-align: middle;
        }
        
        .header-band h1 {
            margin: 0;
            font-size: 28pt;
            font-weight: bold;
            letter-spacing: 2px;
            color: #fff;
            text-transform: uppercase;
            font-family: Calibri, Arial, sans-serif;
            line-height: 1.2;
        }
        
        .header-band .divider-line {
            width: 100%;
            height: 1px;
            background: #fff;
            margin-top: 5px;
        }
        
        .branch-band {
            background: #000;
            color: #fff;
            padding: 8px 20px;
            text-align: center;
            vertical-align: middle;
        }
        
        .branch-band .branch-name {
            margin: 0;
            font-size: 20pt;
            font-weight: bold;
            letter-spacing: 1px;
            color: #fff;
            text-transform: uppercase;
            font-family: Calibri, Arial, sans-serif;
            line-height: 1.2;
        }
        
        .branch-band .divider-line {
            width: 100%;
            height: 1px;
            background: #fff;
            margin-top: 5px;
        }
        
        .recipient-band {
            background: #000;
            color: #fff;
            padding: 8px 20px;
            text-align: center;
            vertical-align: middle;
        }
        
        .recipient-band .recipient-name {
            margin: 0;
            font-size: 18pt;
            font-weight: bold;
            letter-spacing: 1px;
            color: #fff;
            text-transform: uppercase;
            font-family: Calibri, Arial, sans-serif;
            line-height: 1.2;
        }
        
        .details-wrapper {
            position: relative;
            width: 100%;
        }
        
        .main-body-wrapper {
            position: relative;
            width: 100%;
        }
        
        .vertical-divider {
            position: absolute;
            left: 50%;
            top: 0;
            width: 2px;
            background: #fff;
            height: 100%;
            transform: translateX(-50%);
            z-index: 10;
            pointer-events: none;
        }
        
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            position: relative;
        }
        
        .details-table td {
            padding: 8px 15px;
            border: 1px solid #000;
            font-size: 15pt;
            text-align: center;
            vertical-align: middle;
            font-family: Calibri, Arial, sans-serif;
        }
        
        .details-table td.label {
            background: #fff;
            color: #000;
            font-weight: normal;
            width: 50%;
        }
        
        .details-table td.value {
            background: #fff;
            color: #000;
            width: 50%;
        }
        
        .details-table td.header {
            background: #000;
            color: #fff;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 13pt;
            padding: 8px 15px;
        }
        
        .details-table td.paid-amount-cell {
            background: #000;
            color: #fff;
            padding: 6px 20px;
            text-align: center;
            vertical-align: middle;
            font-family: Calibri, Arial, sans-serif;
            width: 50%;
            border: 1px solid #000;
            border-bottom: none;
            position: relative;
        }
        
        .paid-amount-cell-wrapper {
            position: relative;
            padding-bottom: 3px;
        }
        
        .paid-amount-cell-wrapper::after {
            display: none;
        }
        
        .paid-amount-label {
            font-size: 16pt;
            font-weight: bold;
            color: #fff;
            text-transform: uppercase;
            text-align: center;
        }
        
        .paid-amount-value {
            font-size: 32pt;
            font-weight: bold;
            color: #fff;
            text-align: center;
        }
        
        
        .signature-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
        }
        
        .signature-table td {
            padding: 20px 15px 10px 15px;
            border: 1px solid #000;
            text-align: center;
            vertical-align: middle;
            width: 50%;
            height: 100px;
            background: #fff;
        }
        
        .signature-cell {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            height: 100%;
            padding-bottom: 5px;
        }
        
        .signature-line {
            width: 60%;
            height: 1px;
            background: #000;
            margin: 0 auto 18px;
        }
        
        .signature-label {
            margin: 0;
            font-size: 11pt;
            font-weight: normal;
            color: #000;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: Calibri, Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div class="voucher-container">
        <!-- Main Title: PAYMENT VOUCHER -->
        <div class="header-band">
            <h1>PAYMENT VOUCHER</h1>
            <div class="divider-line"></div>
        </div>
        
        <!-- Branch Name Row -->
        <div class="branch-band">
            <div class="branch-name">${formattedBranchName}</div>
            <div class="divider-line"></div>
        </div>
        
        <!-- Recipient/Payee Information -->
        <div class="recipient-band">
            <div class="recipient-name">${recipientName}</div>
        </div>
        
        <!-- Details and Paid Amount Section with Vertical Divider -->
        <div class="main-body-wrapper">
            <div class="vertical-divider"></div>
            <div class="details-wrapper">
                <table class="details-table">
                    <tr>
                        <td class="label">Date:</td>
                        <td class="value">${formattedDate}</td>
                    </tr>
                    <tr>
                        <td class="header">Method of Payment</td>
                        <td class="header">Remarks</td>
                    </tr>
                    <tr>
                        <td class="value">${paymentMethod === 'Cheque' ? 'Cheque Payment' : paymentMethod}</td>
                        <td class="value">${paymentMethod === 'Cheque' && chequeNumber ? chequeNumber : (remarks ? remarks.toUpperCase() : '-')}</td>
                    </tr>
                </table>
            </div>
            
            <!-- Paid Amount Section -->
            <table class="details-table">
                <tr>
                    <td class="paid-amount-cell">
                        <div class="paid-amount-cell-wrapper">
                            <div class="paid-amount-label">Paid Amount</div>
                        </div>
                    </td>
                    <td class="paid-amount-cell">
                        <div class="paid-amount-cell-wrapper">
                            <div class="paid-amount-value">${voucher.amount.toLocaleString()}</div>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        
        <!-- Signature Section -->
        <table class="signature-table">
            <tr>
                <td>
                    <div class="signature-cell">
                        <div class="signature-line"></div>
                        <p class="signature-label">PREPARED BY</p>
                    </div>
                </td>
                <td>
                    <div class="signature-cell">
                        <div class="signature-line"></div>
                        <p class="signature-label">RECEIVED BY</p>
                    </div>
                </td>
            </tr>
        </table>
    </div>
</body>
</html>
                `;
                
                // Open preview window and trigger print dialog (same as sale report)
                try {
                    // Size window for A4 portrait (same as sale report)
                    const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                    if (!previewWindow) {
                        throw new Error('Popup blocked. Please allow popups for this site.');
                    }
                    previewWindow.document.write(printContent);
                    previewWindow.document.close();
                    
                    // Wait for content to load, then trigger print dialog
                    previewWindow.onload = function() {
                        setTimeout(() => {
                            previewWindow.print();
                        }, 250);
                    };
                    
                    // Fallback if onload doesn't fire
                    setTimeout(() => {
                        if (previewWindow.document.readyState === 'complete') {
                            previewWindow.print();
                        }
                    }, 500);
                } catch (error) {
                    console.error('Preview error:', error);
                    showNotification('Failed to open print preview. Please allow popups for this site.', 'error');
                }
            }).catch(error => {
                console.error('Error fetching voucher:', error);
                showNotification('Failed to load voucher', 'error');
            });
        }
        
        // Edit Payment Voucher
        // Edit Category Payment Voucher
        function editCategoryPaymentVoucher(id) {
            if (!(appData.currentUser?.permissions || []).includes('category-voucher-edit') && !(appData.currentUser?.permissions || []).includes('admin')) {
                showNotification("You don't have permission to edit category vouchers", 'error');
                return;
            }
            
            // Load from category payments API
            api.getCategoryPayment(id).then(voucher => {
                // First, ensure dropdowns are populated
                populateCategoryVoucherDropdowns();
                
                // Wait a moment for dropdowns to be populated, then set values
                setTimeout(() => {
                    // Edit category voucher
                    const numberField = document.getElementById('categoryVoucherNumber');
                    const dateField = document.getElementById('categoryVoucherDate');
                    const categoryField = document.getElementById('categoryVoucherCategory');
                    const branchField = document.getElementById('categoryVoucherBranch');
                    const methodField = document.getElementById('categoryVoucherMethod');
                    const amountField = document.getElementById('categoryVoucherAmount');
                    const descriptionField = document.getElementById('categoryVoucherDescription');
                    
                    if (numberField) numberField.value = voucher.voucherNumber || '';
                    if (dateField) dateField.value = new Date(voucher.date).toISOString().split('T')[0];
                    
                    // Set category value (handle both populated and ID formats)
                    if (categoryField) {
                        const categoryId = voucher.categoryId?._id || voucher.categoryId;
                        categoryField.value = categoryId || '';
                    }
                    
                    // Set branch value (handle both populated and ID formats)
                    if (branchField) {
                        const branchId = voucher.branchId?._id || voucher.branchId;
                        branchField.value = branchId || '';
                    }
                    
                    if (methodField) methodField.value = voucher.paymentMethod || 'Cash';
                    if (amountField) amountField.value = voucher.amount || 0;
                    if (descriptionField) descriptionField.value = voucher.description || '';
                    
                    // Store voucher ID for update
                    const form = document.getElementById('categoryVoucherForm');
                    if (form) form.setAttribute('data-voucher-id', id);
                    
                    showNotification('Category voucher loaded for editing', 'info');
                }, 500);
                
                // Switch to payment vouchers section and activate category tab
                showPaymentTab('payment-vouchers');
                setTimeout(() => {
                    const categoryTab = document.getElementById('category-voucher-tab');
                    if (categoryTab) {
                        const bsTab = new bootstrap.Tab(categoryTab);
                        bsTab.show();
                    }
                }, 300);
            }).catch(error => {
                console.error('Error fetching category voucher:', error);
                showNotification('Failed to load voucher', 'error');
            });
        }
        
        // Delete Category Payment Voucher
        function deleteCategoryPaymentVoucher(id) {
            if (!(appData.currentUser?.permissions || []).includes('category-voucher-delete') && !(appData.currentUser?.permissions || []).includes('admin')) {
                showNotification("You don't have permission to delete category vouchers", 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this category voucher?')) {
                // Delete from category payments API
                api.deleteCategoryPayment(id).then(() => {
                    showNotification('Category voucher deleted successfully!', 'success');
                    loadCategoryVoucherListTab();
                    updatePaymentDashboard();
                }).catch(error => {
                    console.error('Error deleting category voucher:', error);
                    if (error.response && error.response.status === 403) {
                        showNotification('Access denied. You do not have permission to delete category vouchers.', 'error');
                    } else {
                        showNotification('Failed to delete voucher: ' + (error.message || 'Unknown error'), 'error');
                    }
                });
            }
        }
        
        function editPaymentVoucher(id) {
            // Check permission for supplier vouchers ONLY
            if (!(appData.currentUser?.permissions || []).includes('payment-edit') && !(appData.currentUser?.permissions || []).includes('admin')) {
                showNotification("You don't have permission to edit supplier vouchers", 'error');
                return;
            }
            
            // This function is ONLY for supplier vouchers - category vouchers should use editCategoryPaymentVoucher
            // No need to check tab, just edit as supplier voucher
                // Edit supplier voucher - load from supplier payments API
                api.getPayment(id).then(voucher => {
                    // First, ensure dropdowns are populated
                    populatePaymentVoucherDropdowns();
                    
                    // Wait a moment for dropdowns to be populated, then set values
                    setTimeout(() => {
                        const numberField = document.getElementById('paymentVoucherNumber');
                        const dateField = document.getElementById('paymentVoucherDate');
                        const supplierField = document.getElementById('paymentVoucherSupplier');
                        const branchField = document.getElementById('paymentVoucherBranch');
                        const methodField = document.getElementById('paymentVoucherMethod');
                        const amountField = document.getElementById('paymentVoucherAmount');
                        const descriptionField = document.getElementById('paymentVoucherDescription');
                        
                        if (numberField) numberField.value = voucher.voucherNumber || '';
                        if (dateField) dateField.value = new Date(voucher.date).toISOString().split('T')[0];
                        
                        // Set supplier value (handle both populated and ID formats)
                        if (supplierField) {
                            const supplierId = voucher.supplierId?._id || voucher.supplierId;
                            supplierField.value = supplierId || '';
                        }
                        
                        // Set branch value (handle both populated and ID formats)
                        if (branchField) {
                            const branchId = voucher.branchId?._id || voucher.branchId;
                            branchField.value = branchId || '';
                        }
                        
                        if (methodField) methodField.value = voucher.paymentMethod || 'Cash';
                        if (amountField) amountField.value = voucher.amount || 0;
                        if (descriptionField) descriptionField.value = voucher.description || '';
                        
                        // Store voucher ID for update
                        const form = document.getElementById('paymentVoucherForm');
                        if (form) form.setAttribute('data-voucher-id', id);
                        
                        showNotification('Voucher loaded for editing', 'info');
                    }, 500);
                    
                    // Switch to voucher tab
                    showPaymentTab('payment-vouchers');
                    setTimeout(() => {
                        const supplierTab = document.getElementById('supplier-voucher-tab');
                        if (supplierTab) {
                            const bsTab = new bootstrap.Tab(supplierTab);
                            bsTab.show();
                        }
                    }, 300);
                }).catch(error => {
                    console.error('Error fetching voucher:', error);
                    showNotification('Failed to load voucher', 'error');
                });
        }
        
        // Delete Payment Voucher (Supplier Vouchers Only)
        function deletePaymentVoucher(id) {
            if (!(appData.currentUser?.permissions || []).includes('payment-delete') && !(appData.currentUser?.permissions || []).includes('admin')) {
                showNotification("You don't have permission to delete supplier vouchers", 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this supplier voucher?')) {
                // Delete from supplier payments API
                api.deletePayment(id).then(() => {
                    showNotification('Voucher deleted successfully!', 'success');
                    loadPaymentVoucherList();
                    updatePaymentDashboard();
                }).catch(error => {
                    console.error('Error deleting voucher:', error);
                    if (error.response && error.response.status === 403) {
                        showNotification('Access denied. You do not have permission to delete supplier vouchers.', 'error');
                    } else {
                        showNotification('Failed to delete voucher: ' + (error.message || 'Unknown error'), 'error');
                    }
                });
            }
        }
        
        // ========================================
        // CATEGORY VOUCHER LIST TAB FUNCTIONS (Inside Payment Voucher List)
        // ========================================
        
        // Initialize Category Voucher List Tab
        function initializeCategoryVoucherListTab() {
            // Only populate filters, don't load data automatically
            // Data will be loaded only when the category tab is clicked
            populateCategoryVoucherListTabFilters();
            // Removed automatic loadCategoryVoucherListTab() call to prevent permission check
            // The category voucher list will load only when user clicks the category tab
        }
        
        // Populate Category Voucher List Tab Filters
        function populateCategoryVoucherListTabFilters() {
            // Populate categories
            const categoryFilter = document.getElementById('categoryVoucherListCategoryFilter');
            if (categoryFilter && appData.categories) {
                const firstOption = categoryFilter.options[0];
                categoryFilter.innerHTML = '';
                if (firstOption) categoryFilter.appendChild(firstOption);
                appData.categories.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c._id;
                    option.textContent = c.name;
                    categoryFilter.appendChild(option);
                });
            }
            
            // Populate branches
            const branchFilter = document.getElementById('categoryVoucherListBranchFilter');
            if (branchFilter && appData.branches) {
                const firstOption = branchFilter.options[0];
                branchFilter.innerHTML = '';
                if (firstOption) branchFilter.appendChild(firstOption);
                appData.branches.forEach(b => {
                    const option = document.createElement('option');
                    option.value = b._id;
                    option.textContent = b.name;
                    branchFilter.appendChild(option);
                });
            }
        }
        
        // Load Category Voucher List Tab
        function loadCategoryVoucherListTab() {
            // Check permissions before making API call
            const permissions = appData.currentUser?.permissions || [];
            if (!permissions.includes('admin') && !permissions.includes('category-voucher-list')) {
                showNotification('Access denied. You do not have permission to view category voucher list.', 'error');
                // Clear the table to show empty state
                const tbody = document.getElementById('categoryVoucherListTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Access denied. You do not have permission to view category voucher list.</td></tr>';
                }
                return;
            }
            
            const branchFilter = document.getElementById('categoryVoucherListBranchFilter')?.value || '';
            const categoryFilter = document.getElementById('categoryVoucherListCategoryFilter')?.value || '';
            const fromDate = document.getElementById('categoryVoucherListFromDate')?.value || '';
            const toDate = document.getElementById('categoryVoucherListToDate')?.value || '';
            const search = document.getElementById('categoryVoucherListSearch')?.value || '';
            
            // Require at least one date to be selected before loading data
            if (!fromDate && !toDate) {
                // Clear/hide existing data
                const tbody = document.getElementById('categoryVoucherListTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Please select at least one date (From or To) to view voucher list</td></tr>';
                }
                showNotification('Please select at least one date (From or To) to view voucher list', 'info');
                return;
            }
            
            let url = '/category-payments';
            const params = [];
            
            if (branchFilter) params.push(`branchId=${branchFilter}`);
            if (categoryFilter) params.push(`categoryId=${categoryFilter}`);
            if (fromDate) params.push(`from=${fromDate}`);
            if (toDate) params.push(`to=${toDate}`);
            
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            // Use SEPARATE category payments API
            api.getCategoryPayments(url).then(paymentsData => {
                // No filtering needed - backend only returns category payments
                let filteredPayments = paymentsData;
                
                // Apply search filter
                if (search) {
                    const searchLower = search.toLowerCase();
                    filteredPayments = filteredPayments.filter(p => {
                        return (p.voucherNumber && p.voucherNumber.toLowerCase().includes(searchLower)) ||
                               (p.category && p.category.toLowerCase().includes(searchLower)) ||
                               (p.categoryId && p.categoryId.name && p.categoryId.name.toLowerCase().includes(searchLower)) ||
                               (p.description && p.description.toLowerCase().includes(searchLower)) ||
                               (p.branchId && p.branchId.name && p.branchId.name.toLowerCase().includes(searchLower));
                    });
                }
                
                // Store latest vouchers for print selected functionality
                window.appData = window.appData || {};
                appData.latestCategoryVouchers = filteredPayments;
                
                renderCategoryVoucherListTab(filteredPayments);
            }).catch(error => {
                console.error('Error loading category voucher list:', error);
                // Check if it's a permission error
                if (error.response && error.response.status === 403) {
                    showNotification('Access denied. You do not have permission to view category voucher list.', 'error');
                    const tbody = document.getElementById('categoryVoucherListTableBody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Access denied. You do not have permission to view category voucher list.</td></tr>';
                    }
                } else {
                    showNotification('Failed to load category voucher list: ' + (error.message || 'Unknown error'), 'error');
                }
            });
        }
        
        // Render Category Voucher List Tab
        function renderCategoryVoucherListTab(vouchers) {
            const tbody = document.getElementById('categoryVoucherListTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (vouchers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No category vouchers found</td></tr>';
                return;
            }
            
            // Get selected IDs from appData
            const checkedBoxes = Array.from(document.querySelectorAll('.category-voucher-select:checked'));
            const selectedIds = checkedBoxes.map(cb => cb.value);
            window.appData = window.appData || {};
            appData.categoryVoucherSelectedIds = selectedIds;
            
            // Use category-voucher-edit and category-voucher-delete permissions for category vouchers
            const canEditVoucher = (appData.currentUser?.permissions || []).includes('category-voucher-edit') || (appData.currentUser?.permissions || []).includes('admin');
            const canDeleteVoucher = (appData.currentUser?.permissions || []).includes('category-voucher-delete') || (appData.currentUser?.permissions || []).includes('admin');
            
            vouchers.forEach(voucher => {
                const branchName = voucher.branchId?.name || 'Unknown';
                const categoryName = voucher.categoryId?.name || voucher.category || 'Unknown';
                const voucherNum = voucher.voucherNumber || 'N/A';
                const isChecked = selectedIds.includes(String(voucher._id));
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="no-print"><input type="checkbox" class="category-voucher-select" value="${voucher._id}" ${isChecked ? 'checked' : ''}></td>
                    <td>${voucherNum}</td>
                    <td>${formatDate(voucher.date)}</td>
                    <td><span class="badge bg-info">${categoryName}</span></td>
                    <td>${branchName}</td>
                    <td class="text-end">PKR ${voucher.amount.toLocaleString()}</td>
                    <td>${voucher.paymentMethod || 'Cash'}</td>
                    <td>${voucher.description || '-'}</td>
                    <td class="no-print">
                        <button class="btn btn-sm btn-info me-1" onclick="viewCategoryPaymentVoucher('${voucher._id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${canEditVoucher ? `<button class="btn btn-sm btn-warning me-1" onclick="editCategoryPaymentVoucher('${voucher._id}')"><i class="fas fa-edit"></i></button>` : ''}
                        ${canDeleteVoucher ? `<button class="btn btn-sm btn-danger" onclick="deleteCategoryPaymentVoucher('${voucher._id}')"><i class="fas fa-trash"></i></button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Setup select all checkbox
            const selectAll = document.getElementById('categoryVoucherSelectAll');
            if (selectAll) {
                selectAll.onclick = () => {
                    document.querySelectorAll('.category-voucher-select').forEach(cb => {
                        cb.checked = selectAll.checked;
                    });
                };
            }
        }
        
        // Clear Category Voucher List Tab Filters
        function clearCategoryVoucherListFilters() {
            document.getElementById('categoryVoucherListSearch').value = '';
            document.getElementById('categoryVoucherListBranchFilter').value = '';
            document.getElementById('categoryVoucherListCategoryFilter').value = '';
            document.getElementById('categoryVoucherListFromDate').value = '';
            document.getElementById('categoryVoucherListToDate').value = '';
            loadCategoryVoucherListTab();
        }
        
        // Print Category Voucher List Tab
        function printCategoryVoucherListTab() {
            const tbody = document.getElementById('categoryVoucherListTableBody');
            if (!tbody) {
                showNotification('No vouchers to print', 'error');
                return;
            }
            const rows = tbody.querySelectorAll('tr');
            if (rows.length === 0 || (rows.length === 1 && rows[0].textContent.includes('No vouchers'))) {
                showNotification('No vouchers to print', 'error');
                return;
            }
            const fromDate = document.getElementById('categoryVoucherListFromDate')?.value || '';
            const toDate = document.getElementById('categoryVoucherListToDate')?.value || '';
            const branchFilter = document.getElementById('categoryVoucherListBranchFilter')?.value || '';
            const categoryFilter = document.getElementById('categoryVoucherListCategoryFilter')?.value || '';
            let url = '/category-payments?'; const params = []; if (branchFilter) params.push(`branchId=${branchFilter}`); if (categoryFilter) params.push(`categoryId=${categoryFilter}`); if (fromDate) params.push(`from=${fromDate}`); if (toDate) params.push(`to=${toDate}`); url += params.join('&');
            api.getCategoryPayments(url).then(vouchers => {
                if (!vouchers || vouchers.length === 0) {
                    showNotification('No vouchers to print', 'error');
                    return;
                }
                const companyName = appData.settings?.companyName || 'D.Watson Group of Pharmacy';
                let branchDisplayName = 'All Branches'; let categoryDisplayName = 'All Categories';
                if (branchFilter) {
                    const branch = appData.branches.find(b => b._id === branchFilter);
                    branchDisplayName = branch ? branch.name : 'Selected Branch';
                } else if (vouchers.length > 0) {
                    const uniqueBranches = [...new Set(vouchers.map(v => v.branchId?.name || 'Unknown'))];
                    branchDisplayName = uniqueBranches.length === 1 ? uniqueBranches[0] : 'All Branches';
                }
                if (categoryFilter) {
                    const category = appData.categories.find(c => c._id === categoryFilter);
                    categoryDisplayName = category ? category.name : 'Selected Category';
                } else if (vouchers.length > 0) {
                    const uniqueCategories = [...new Set(vouchers.map(v => v.categoryId?.name || v.category || 'Unknown'))];
                    categoryDisplayName = uniqueCategories.length === 1 ? uniqueCategories[0] : 'All Categories';
                }
                const uniqueBranches = [...new Set(vouchers.map(v => v.branchId?.name || 'Unknown'))];
                const uniqueCategories = [...new Set(vouchers.map(v => v.categoryId?.name || v.category || 'Unknown'))];
                const includeCategoryCol = (uniqueCategories.length > 1);
                const vouchersByMethod = {};
                vouchers.forEach(voucher => {
                    const method = voucher.paymentMethod || 'Cash';
                    if (!vouchersByMethod[method]) vouchersByMethod[method] = [];
                    vouchersByMethod[method].push(voucher);
                });
                const sortedMethods = Object.keys(vouchersByMethod).sort();
                let printContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Category Payment Vouchers List</title><style>*{-webkit-print-color-adjust:exact !important;print-color-adjust:exact !important;}@page{size:A4;margin:0.5in;}body{font-family:Arial,sans-serif;font-size:12pt;line-height:1.4;color:#000;background:#fff;margin:0;padding:20px;} .print-header{text-align:center;margin-bottom:30px;padding:30px 25px;background:#00685c;color:#ffffff;border-bottom:3px solid #000;} .print-header h2{margin:0;font-size:24pt;font-weight:bold;letter-spacing:1px;color:#ffffff;} table{width:100%;border-collapse:collapse;margin-bottom:30px;border:1px solid #333;background:white;table-layout:fixed;} th{padding:10px 8px;border:1px solid #333;font-weight:bold;color:#ffffff;font-size:10pt;text-transform:uppercase;white-space:normal;word-wrap:break-word;line-height:1.3;} td{padding:10px 8px;border:1px solid #333;font-size:11pt;word-wrap:break-word;overflow:hidden;} tr{height:auto;} .summary-section{border:2px solid #000;padding:25px;margin-top:35px;background:#ffffff;} .summary-section h3{text-align:center;margin-bottom:25px;text-transform:uppercase;font-size:16pt;font-weight:bold;color:#000;letter-spacing:2px;padding-bottom:15px;border-bottom:2px solid #333;}</style></head><body><div class="print-header"><h2>${companyName}</h2><p style="margin:10px 0 0 0;font-size:16pt;font-weight:bold;color:#ffffff;letter-spacing:2px;text-transform:uppercase;">CATEGORY PAYMENT VOUCHERS LIST</p>${fromDate || toDate ? `<p style=\"margin:8px 0 0 0;font-size:11pt;color:#ffffff;\">Period: ${fromDate ? formatDate(fromDate) : 'All'} - ${toDate ? formatDate(toDate) : 'All'}</p>` : ''}<p style="margin:8px 0 0 0;font-size:10pt;color:#ffffff;">Generated: ${new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}</p></div><div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border:1px solid #333;"><div style="display:flex;justify-content:space-between;font-size:13pt;font-weight:bold;color:#000;"><div><span style="color:#00685c;">Branch:</span> <span>${branchDisplayName}</span></div><div><span style="color:#00685c;">Category:</span> <span>${categoryDisplayName}</span></div></div></div><table><thead><tr style="background:#00685c;"><th style="text-align:center;width:4%;padding:10px 6px;">#</th><th style="text-align:left;width:12%;padding:10px 6px;">V.No</th><th style="text-align:left;width:10%;padding:10px 6px;">Date</th>${includeCategoryCol ? '<th style="text-align:left;width:18%;padding:10px 6px;">Category</th>' : ''}<th style="text-align:center;width:10%;padding:10px 6px;">PM</th><th style="text-align:left;width:${includeCategoryCol ? '28%' : '38%'};padding:10px 6px;">Description</th><th style="text-align:right;width:16%;padding:10px 6px;">Amount</th></tr></thead><tbody>`;
                let globalRowIndex = 0;
                sortedMethods.forEach(method => {
                    const methodVouchers = vouchersByMethod[method];
                    const methodTotal = methodVouchers.reduce((sum, v) => sum + (v.amount || 0), 0);
                    methodVouchers.forEach((voucher, voucherIndex) => {
                        globalRowIndex++;
                        const voucherNum = voucher.voucherNumber || 'N/A';
                        const voucherDate = formatDate(voucher.date);
                        const amount = voucher.amount || 0;
                        const description = voucher.description || '-';
                        const categoryName = voucher.categoryId?.name || voucher.category || 'Unknown';
                        const rowBg = voucherIndex % 2 === 0 ? '#ffffff' : '#f8f9fa';
                        printContent += `<tr style=\"background-color:${rowBg};vertical-align:top;\"><td style=\"padding:10px 6px;border:1px solid #333;font-weight:bold;color:#000;text-align:center;font-size:11pt;width:4%;vertical-align:top;\">${globalRowIndex}</td><td style=\"padding:10px 6px;border:1px solid #333;font-weight:bold;color:#000;font-size:11pt;width:12%;vertical-align:top;\">${voucherNum}</td><td style=\"padding:10px 6px;border:1px solid #333;color:#000;font-size:11pt;width:10%;vertical-align:top;\">${voucherDate}</td>${includeCategoryCol ? `<td style=\"padding:10px 6px;border:1px solid #333;color:#000;font-size:11pt;width:18%;vertical-align:top;\">${categoryName}</td>` : ''}<td style=\"padding:10px 6px;border:1px solid #333;text-align:center;color:#000;font-size:11pt;width:10%;vertical-align:top;\">${method}</td><td style=\"padding:10px 6px;border:1px solid #333;color:#000;font-size:11pt;width:${includeCategoryCol ? '28%' : '38%'};white-space:normal;word-wrap:break-word;overflow-wrap:break-word;vertical-align:top;line-height:1.4;\">${description || '-'}</td><td style=\"padding:10px 6px;border:1px solid #333;text-align:right;font-weight:bold;color:#000;font-size:11pt;width:16%;white-space:nowrap;vertical-align:top;\">${amount.toLocaleString()}</td></tr>`;
                    });
                    printContent += `<tr style=\"background-color:#000000;color:#ffffff;\"><td colspan=\"${includeCategoryCol ? '6' : '5'}\" style=\"padding:12px 8px;border:2px solid #000000;font-weight:bold;font-size:13pt;text-align:center;text-transform:uppercase;\">Subtotal ${method} Paid</td><td style=\"padding:12px 8px;border:2px solid #000000;font-weight:bold;font-size:13pt;text-align:right;color:#ffffff;white-space:nowrap;\">${methodTotal.toLocaleString()}</td></tr>`;
                });
                printContent += `</tbody></table>`;
                const totalAmount = vouchers.reduce((sum, v) => sum + (v.amount || 0), 0);
                printContent += `<div class=\"summary-section\"><h3>SUMMARY</h3><table style=\"width:100%;border-collapse:collapse;\"><tr style=\"background-color:#f0f0f0;\"><td style=\"padding:12px;border:1px solid #333;font-weight:bold;width:30%;background:#f8f9fa;color:#000;font-size:12pt;\">Total Vouchers:</td><td style=\"padding:12px;border:1px solid #333;width:20%;color:#000;font-weight:bold;font-size:12pt;\">${vouchers.length}</td><td style=\"padding:12px;border:1px solid #333;font-weight:bold;width:30%;background:#f8f9fa;color:#000;font-size:12pt;\">Total Amount:</td><td style=\"padding:12px;border:1px solid #333;font-weight:bold;width:20%;text-align:right;color:#000;font-size:12pt;\">${totalAmount.toLocaleString()}</td></tr><tr><td style=\"padding:12px;border:1px solid #333;font-weight:bold;background:#f8f9fa;color:#000;font-size:12pt;\">Status:</td><td style=\"padding:12px;border:1px solid #333;color:#000;font-weight:bold;font-size:12pt;\">All PAID</td><td style=\"padding:12px;border:1px solid #333;background:#f8f9fa;\" colspan=\"2\"></td></tr></table></div><div style=\"display:flex;justify-content:space-between;margin-top:60px;padding-top:35px;border-top:2px solid #333;\"><div style=\"width:45%;text-align:center;\"><p style=\"margin:0 0 12px 0;font-weight:bold;color:#000;font-size:12pt;letter-spacing:0.5px;\">PREPARED BY</p><div style=\"border-top:2px solid #000;margin-top:60px;padding-top:8px;\"><p style=\"margin:0;color:#000;font-size:10pt;letter-spacing:0.5px;\">Signature & Date</p></div></div><div style=\"width:45%;text-align:center;\"><p style=\"margin:0 0 12px 0;font-weight:bold;color:#000;font-size:12pt;letter-spacing:0.5px;\">CASH RECEIVED BY</p><div style=\"border-top:2px solid #000;margin-top:60px;padding-top:8px;\"><p style=\"margin:0;color:#000;font-size:10pt;letter-spacing:0.5px;\">Signature & Date</p></div></div></div></body></html>`;
                try {
                    const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                    if (!previewWindow) {
                        throw new Error('Popup blocked. Please allow popups for this site.');
                    }
                    previewWindow.document.write(printContent);
                    previewWindow.document.close();
                    previewWindow.onload = function(){
                        setTimeout(() => {
                            previewWindow.print();
                        }, 250);
                    };
                    setTimeout(() => {
                        if (previewWindow.document.readyState === 'complete') {
                            previewWindow.print();
                        }
                    }, 500);
                } catch(e) {
                    showNotification('Failed to open print preview. Please allow popups for this site.', 'error');
                }
            }).catch(() => {
                showNotification('Failed to load vouchers for printing', 'error');
            });
        }
        
        // Print Selected Category Vouchers List
        function printSelectedCategoryVouchersList() {
            const checked = Array.from(document.querySelectorAll('.category-voucher-select:checked'));
            if (checked.length === 0) {
                showNotification('Please select at least one voucher to print', 'error');
                return;
            }
            const ids = checked.map(c => c.value);
            const all = (window.appData && appData.latestCategoryVouchers) ? appData.latestCategoryVouchers : [];
            const vouchers = all.filter(v => ids.includes(String(v._id)));
            if (vouchers.length === 0) {
                showNotification('Selected vouchers not found in current list', 'error');
                return;
            }
            const companyName = appData.settings?.companyName || 'D.Watson Group of Pharmacy';
            const uniqueBranches = [...new Set(vouchers.map(v => v.branchId?.name || 'Unknown'))];
            const uniqueCategories = [...new Set(vouchers.map(v => v.categoryId?.name || v.category || 'Unknown'))];
            const branchDisplayName = uniqueBranches.length === 1 ? uniqueBranches[0] : 'Multiple Branches';
            const categoryDisplayName = uniqueCategories.length === 1 ? uniqueCategories[0] : 'Multiple Categories';
            const includeCategoryCol = (uniqueCategories.length > 1);
            let printContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Selected Category Payment Vouchers</title><style>*{-webkit-print-color-adjust:exact !important;print-color-adjust:exact !important;}@page{size:A4;margin:0.5in;}body{font-family:Arial,sans-serif;font-size:12pt;line-height:1.4;color:#000;background:#fff;margin:0;padding:20px;} .print-header{text-align:center;margin-bottom:30px;padding:30px 25px;background:#00685c;color:#ffffff;border-bottom:3px solid #000;} .print-header h2{margin:0;font-size:24pt;font-weight:bold;letter-spacing:1px;color:#ffffff;} table{width:100%;border-collapse:collapse;margin-bottom:30px;border:1px solid #333;background:white;table-layout:fixed;} th{padding:10px 8px;border:1px solid #333;font-weight:bold;color:#ffffff;font-size:10pt;text-transform:uppercase;white-space:normal;word-wrap:break-word;line-height:1.3;} td{padding:10px 8px;border:1px solid #333;font-size:11pt;word-wrap:break-word;overflow:hidden;} .summary-section{border:2px solid #000;padding:25px;margin-top:35px;background:#ffffff;}</style></head><body><div class="print-header"><h2>${companyName}</h2><p style="margin:10px 0 0 0;font-size:16pt;font-weight:bold;color:#ffffff;letter-spacing:2px;text-transform:uppercase;">SELECTED CATEGORY PAYMENT VOUCHERS</p><p style="margin:8px 0 0 0;font-size:10pt;color:#ffffff;">Generated: ${new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}</p></div><div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border:1px solid #333;"><div style="display:flex;justify-content:space-between;font-size:13pt;font-weight:bold;color:#000;"><div><span style="color:#00685c;">Branch:</span> <span>${branchDisplayName}</span></div><div><span style="color:#00685c;">Category:</span> <span>${categoryDisplayName}</span></div></div></div><table><thead><tr style="background:#00685c;"><th style="text-align:center;width:4%;padding:10px 6px;">#</th><th style="text-align:left;width:12%;padding:10px 6px;">V.No</th><th style="text-align:left;width:10%;padding:10px 6px;">Date</th>${includeCategoryCol ? '<th style="text-align:left;width:18%;padding:10px 6px;">Category</th>' : ''}<th style="text-align:center;width:10%;padding:10px 6px;">PM</th><th style="text-align:left;width:${includeCategoryCol ? '28%' : '38%'};padding:10px 6px;">Description</th><th style="text-align:right;width:16%;padding:10px 6px;">Amount</th></tr></thead><tbody>`;
            vouchers.forEach((voucher, index) => {
                const voucherNum = voucher.voucherNumber || 'N/A';
                const voucherDate = formatDate(voucher.date);
                const amount = voucher.amount || 0;
                const paymentMethod = voucher.paymentMethod || 'Cash';
                const categoryName = voucher.categoryId?.name || voucher.category || 'Unknown';
                const description = voucher.description || '-';
                const rowBg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                printContent += `<tr style="background-color:${rowBg};vertical-align:top;"><td style="padding:10px 6px;border:1px solid #333;font-weight:bold;color:#000;text-align:center;font-size:11pt;width:4%;vertical-align:top;">${index+1}</td><td style="padding:10px 6px;border:1px solid #333;font-weight:bold;color:#000;font-size:11pt;width:12%;vertical-align:top;">${voucherNum}</td><td style="padding:10px 6px;border:1px solid #333;color:#000;font-size:11pt;width:10%;vertical-align:top;">${voucherDate}</td>${includeCategoryCol ? `<td style="padding:10px 6px;border:1px solid #333;color:#000;font-size:11pt;width:18%;vertical-align:top;">${categoryName}</td>` : ''}<td style="padding:10px 6px;border:1px solid #333;text-align:center;color:#000;font-size:11pt;width:10%;vertical-align:top;">${paymentMethod}</td><td style="padding:10px 6px;border:1px solid #333;color:#000;font-size:11pt;width:${includeCategoryCol ? '28%' : '38%'};white-space:normal;word-wrap:break-word;overflow-wrap:break-word;vertical-align:top;line-height:1.4;">${description}</td><td style="padding:10px 6px;border:1px solid #333;text-align:right;font-weight:bold;color:#000;font-size:11pt;width:16%;white-space:nowrap;vertical-align:top;">${amount.toLocaleString()}</td></tr>`;
            });
            const totalAmount = vouchers.reduce((sum, v) => sum + (v.amount || 0), 0);
            printContent += `</tbody></table><div class="summary-section"><h3 style="text-align:center;margin-bottom:25px;text-transform:uppercase;font-size:16pt;font-weight:bold;color:#000;letter-spacing:2px;padding-bottom:15px;border-bottom:2px solid #333;">SUMMARY</h3><table style="width: 100%; border-collapse: collapse;"><tr style="background-color: #f0f0f0;"><td style="padding: 12px; border: 1px solid #333; font-weight: bold; width: 30%; background: #f8f9fa; color: #000; font-size: 12pt;">Total Vouchers:</td><td style="padding: 12px; border: 1px solid #333; width: 20%; color: #000; font-weight: bold; font-size: 12pt;">${vouchers.length}</td><td style="padding: 12px; border: 1px solid #333; font-weight: bold; width: 30%; background: #f8f9fa; color: #000; font-size: 12pt;">Total Amount:</td><td style="padding: 12px; border: 1px solid #333; font-weight: bold; width: 20%; text-align: right; color: #000; font-size: 12pt;">${totalAmount.toLocaleString()}</td></tr></table></div><div style="display: flex; justify-content: space-between; margin-top: 60px; padding-top: 35px; border-top: 2px solid #333;"><div style="width: 45%; text-align: center;"><p style="margin: 0 0 12px 0; font-weight: bold; color: #000; font-size: 12pt; letter-spacing: 0.5px;">PREPARED BY</p><div style="border-top: 2px solid #000; margin-top: 60px; padding-top: 8px;"><p style="margin: 0; color: #000; font-size: 10pt; letter-spacing: 0.5px;">Signature & Date</p></div></div><div style="width: 45%; text-align: center;"><p style="margin: 0 0 12px 0; font-weight: bold; color: #000; font-size: 12pt; letter-spacing: 0.5px;">CASH RECEIVED BY</p><div style="border-top: 2px solid #000; margin-top: 60px; padding-top: 8px;"><p style="margin: 0; color: #000; font-size: 10pt; letter-spacing: 0.5px;">Signature & Date</p></div></div></div></body></html>`;
            const w = window.open('', '_blank');
            if (!w) {
                showNotification('Popup blocked. Please allow popups.', 'error');
                return;
            }
            w.document.write(printContent);
            w.document.close();
            w.focus();
            setTimeout(() => w.print(), 250);
            setTimeout(() => {
                document.querySelectorAll('.category-voucher-select:checked').forEach(checkbox => {
                    checkbox.checked = false;
                });
                const selectAllCheckbox = document.getElementById('categoryVoucherSelectAll');
                if (selectAllCheckbox) selectAllCheckbox.checked = false;
            }, 500);
        }
        
        // ========================================
        // CATEGORY VOUCHER SIMPLE LIST FUNCTIONS (Old - Keep for backward compatibility)
        // ========================================
        
        // Initialize Category Voucher Simple List
        function initializeCategoryVoucherSimpleList() {
            populateCategoryVoucherSimpleFilters();
            loadCategoryVoucherSimpleList();
        }
        
        // Populate Category Voucher Simple Filters
        function populateCategoryVoucherSimpleFilters() {
            // Populate categories
            const categoryFilter = document.getElementById('categoryVoucherSimpleListCategoryFilter');
            if (categoryFilter && appData.categories) {
                const firstOption = categoryFilter.options[0];
                categoryFilter.innerHTML = '';
                if (firstOption) categoryFilter.appendChild(firstOption);
                appData.categories.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c._id;
                    option.textContent = c.name;
                    categoryFilter.appendChild(option);
                });
            }
            
            // Populate branches
            const branchFilter = document.getElementById('categoryVoucherSimpleListBranchFilter');
            if (branchFilter && appData.branches) {
                const firstOption = branchFilter.options[0];
                branchFilter.innerHTML = '';
                if (firstOption) branchFilter.appendChild(firstOption);
                appData.branches.forEach(b => {
                    const option = document.createElement('option');
                    option.value = b._id;
                    option.textContent = b.name;
                    branchFilter.appendChild(option);
                });
            }
        }
        
        // Load Category Voucher Simple List
        function loadCategoryVoucherSimpleList() {
            const listSection = document.getElementById('category-voucher-simple-list-section');
            if (!listSection || listSection.style.display === 'none') {
                return;
            }
            
            // Check permissions before making API call
            const permissions = appData.currentUser?.permissions || [];
            if (!permissions.includes('admin') && !permissions.includes('category-voucher-list')) {
                showNotification('Access denied. You do not have permission to view category voucher list.', 'error');
                // Clear the table to show empty state
                const tbody = document.getElementById('categoryVoucherSimpleListTable');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Access denied. You do not have permission to view category voucher list.</td></tr>';
                }
                return;
            }
            
            const branchFilter = document.getElementById('categoryVoucherSimpleListBranchFilter')?.value || '';
            const categoryFilter = document.getElementById('categoryVoucherSimpleListCategoryFilter')?.value || '';
            const fromDate = document.getElementById('categoryVoucherSimpleListFromDate')?.value || '';
            const toDate = document.getElementById('categoryVoucherSimpleListToDate')?.value || '';
            const search = document.getElementById('categoryVoucherSimpleSearch')?.value || '';
            
            let url = '/category-payments';
            const params = [];
            
            if (branchFilter) params.push(`branchId=${branchFilter}`);
            if (categoryFilter) params.push(`categoryId=${categoryFilter}`);
            if (fromDate) params.push(`from=${fromDate}`);
            if (toDate) params.push(`to=${toDate}`);
            
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            // Use SEPARATE category payments API
            api.getCategoryPayments(url).then(paymentsData => {
                // No filtering needed - backend only returns category payments
                let filteredPayments = paymentsData;
                
                // Apply search filter
                if (search) {
                    const searchLower = search.toLowerCase();
                    filteredPayments = filteredPayments.filter(p => {
                        return (p.voucherNumber && p.voucherNumber.toLowerCase().includes(searchLower)) ||
                               (p.category && p.category.toLowerCase().includes(searchLower)) ||
                               (p.categoryId && p.categoryId.name && p.categoryId.name.toLowerCase().includes(searchLower)) ||
                               (p.description && p.description.toLowerCase().includes(searchLower)) ||
                               (p.branchId && p.branchId.name && p.branchId.name.toLowerCase().includes(searchLower));
                    });
                }
                
                renderCategoryVoucherSimpleList(filteredPayments);
            }).catch(error => {
                console.error('Error loading category voucher simple list:', error);
                // Check if it's a permission error
                if (error.response && error.response.status === 403) {
                    showNotification('Access denied. You do not have permission to view category voucher list.', 'error');
                    const tbody = document.getElementById('categoryVoucherSimpleListTable');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Access denied. You do not have permission to view category voucher list.</td></tr>';
                    }
                } else {
                    showNotification('Failed to load category voucher list: ' + (error.message || 'Unknown error'), 'error');
                }
            });
        }
        
        // Render Category Voucher Simple List
        function renderCategoryVoucherSimpleList(vouchers) {
            const tbody = document.getElementById('categoryVoucherSimpleListTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (vouchers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No category vouchers found</td></tr>';
                return;
            }
            
            // Use category-voucher-edit and category-voucher-delete permissions for category vouchers
            const canEditVoucher = (appData.currentUser?.permissions || []).includes('category-voucher-edit') || (appData.currentUser?.permissions || []).includes('admin');
            const canDeleteVoucher = (appData.currentUser?.permissions || []).includes('category-voucher-delete') || (appData.currentUser?.permissions || []).includes('admin');
            
            vouchers.forEach(voucher => {
                const branchName = voucher.branchId?.name || 'Unknown';
                const categoryName = voucher.categoryId?.name || voucher.category || 'Unknown';
                const voucherNum = voucher.voucherNumber || 'N/A';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${voucherNum}</td>
                    <td>${formatDate(voucher.date)}</td>
                    <td><span class="badge bg-info">${categoryName}</span></td>
                    <td>${branchName}</td>
                    <td class="text-end">PKR ${voucher.amount.toLocaleString()}</td>
                    <td>${voucher.paymentMethod || 'Cash'}</td>
                    <td>${voucher.description || '-'}</td>
                    <td class="no-print">
                        <button class="btn btn-sm btn-info me-1" onclick="viewCategoryPaymentVoucher('${voucher._id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${canEditVoucher ? `<button class="btn btn-sm btn-warning me-1" onclick="editCategoryPaymentVoucher('${voucher._id}')"><i class="fas fa-edit"></i></button>` : ''}
                        ${canDeleteVoucher ? `<button class="btn btn-sm btn-danger" onclick="deleteCategoryPaymentVoucher('${voucher._id}')"><i class="fas fa-trash"></i></button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Clear Category Voucher Simple Filters
        function clearCategoryVoucherSimpleFilters() {
            document.getElementById('categoryVoucherSimpleSearch').value = '';
            document.getElementById('categoryVoucherSimpleListBranchFilter').value = '';
            document.getElementById('categoryVoucherSimpleListCategoryFilter').value = '';
            document.getElementById('categoryVoucherSimpleListFromDate').value = '';
            document.getElementById('categoryVoucherSimpleListToDate').value = '';
            loadCategoryVoucherSimpleList();
        }
        
        // Print Category Voucher Simple List
        function printCategoryVoucherSimpleList() {
            const tbody = document.getElementById('categoryVoucherSimpleListTable');
            if (!tbody) {
                showNotification('No vouchers to print', 'error');
                return;
            }
            
            // Get filter information
            const branchFilter = document.getElementById('categoryVoucherSimpleListBranchFilter')?.value || '';
            const categoryFilter = document.getElementById('categoryVoucherSimpleListCategoryFilter')?.value || '';
            const fromDate = document.getElementById('categoryVoucherSimpleListFromDate')?.value || '';
            const toDate = document.getElementById('categoryVoucherSimpleListToDate')?.value || '';
            const search = document.getElementById('categoryVoucherSimpleSearch')?.value || '';
            
            // Get display names
            const branchName = branchFilter ? appData.branches.find(b => b._id === branchFilter)?.name || 'All Branches' : 'All Branches';
            const categoryName = categoryFilter ? appData.categories.find(c => c._id === categoryFilter)?.name || 'All Categories' : 'All Categories';
            
            const companyName = appData.settings?.companyName || 'D.Watson Group Of Pharmacies';
            
            // Extract rows from visible table (excluding empty/no data rows)
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => {
                const cells = row.querySelectorAll('td');
                // Skip empty rows or "no data" rows
                if (cells.length === 1 && (cells[0].textContent.includes('No vouchers') || cells[0].textContent.includes('Loading'))) {
                    return false;
                }
                // Skip rows with less than 7 cells (action buttons column excluded)
                return cells.length >= 7;
            });
            
            if (rows.length === 0) {
                showNotification('No vouchers to print', 'error');
                return;
            }
            
            const printContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Category Voucher List - ${new Date().toLocaleDateString('en-GB')}</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #2c6e8a;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 28pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #2c6e8a;
        }
        
        .print-header .company-info {
            font-size: 11pt;
            color: #555;
            margin: 5px 0;
        }
        
        .filter-info {
            margin-bottom: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #2c6e8a;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .filter-info p {
            margin: 8px 0;
            font-size: 10pt;
            font-weight: 500;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        th {
            background-color: #2c6e8a;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #1a4d63;
        }
        
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .text-end {
            text-align: right;
        }
        
        @page {
            size: A4 portrait;
            margin: 0.5in;
        }
        
        @media print {
            body {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>${companyName}</h1>
        <div class="company-info">Category Voucher List</div>
        <div class="company-info">Generated: ${new Date().toLocaleDateString('en-GB')}</div>
    </div>
    
    <div class="filter-info">
        <p><strong>Branch:</strong> ${branchName}</p>
        <p><strong>Category:</strong> ${categoryName}</p>
        <p><strong>From Date:</strong> ${fromDate || 'All Dates'}</p>
        <p><strong>To Date:</strong> ${toDate || 'All Dates'}</p>
        ${search ? `<p><strong>Search:</strong> ${search}</p>` : ''}
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Voucher #</th>
                <th>Date</th>
                <th>Category</th>
                <th>Branch</th>
                <th class="text-end">Amount</th>
                <th>Method</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            ${rows.map(row => {
                const cells = row.querySelectorAll('td');
                // Extract text content, removing badge/span HTML
                const categoryText = cells[2].textContent.replace(/badge.*?>/g, '').replace(/span.*?>/g, '').trim();
                return `
                    <tr>
                        <td>${cells[0].textContent.trim()}</td>
                        <td>${cells[1].textContent.trim()}</td>
                        <td>${categoryText}</td>
                        <td>${cells[3].textContent.trim()}</td>
                        <td class="text-end">${cells[4].textContent.trim()}</td>
                        <td>${cells[5].textContent.trim()}</td>
                        <td>${cells[6].textContent.trim()}</td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    </table>
</body>
</html>
            `;
            
            const w = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            if (!w) {
                showNotification('Popup blocked. Please allow popups.', 'error');
                return;
            }
            w.document.write(printContent);
            w.document.close();
            w.focus();
            setTimeout(() => w.print(), 250);
        }
        
        // ========================================
        // CATEGORY VOUCHER LIST FUNCTIONS (Summary Report)
        // ========================================
        
        // Initialize Category Voucher List
        function initializeCategoryVoucherList() {
            populateCategoryVoucherListFilters();
            // Set default dates (current month)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            const fromDateEl = document.getElementById('categoryVoucherListFromDate');
            const toDateEl = document.getElementById('categoryVoucherListToDate');
            if (fromDateEl && !fromDateEl.value) {
                fromDateEl.value = firstDay.toISOString().split('T')[0];
            }
            if (toDateEl && !toDateEl.value) {
                toDateEl.value = lastDay.toISOString().split('T')[0];
            }
        }
        
        // Populate Category Voucher List Filters
        function populateCategoryVoucherListFilters() {
            // Populate categories
            const categoryFilter = document.getElementById('categoryVoucherListCategoryFilter');
            if (categoryFilter && appData.categories) {
                const firstOption = categoryFilter.options[0];
                categoryFilter.innerHTML = '';
                if (firstOption) categoryFilter.appendChild(firstOption);
                appData.categories.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c._id;
                    option.textContent = c.name;
                    categoryFilter.appendChild(option);
                });
            }
            
            // Populate branches
            const branchFilter = document.getElementById('categoryVoucherListBranchFilter');
            if (branchFilter && appData.branches) {
                const firstOption = branchFilter.options[0];
                branchFilter.innerHTML = '';
                if (firstOption) branchFilter.appendChild(firstOption);
                appData.branches.forEach(b => {
                    const option = document.createElement('option');
                    option.value = b._id;
                    option.textContent = b.name;
                    branchFilter.appendChild(option);
                });
            }
        }
        
        // Load Category Voucher List
        function loadCategoryVoucherList() {
            // Check permissions before making API call
            const permissions = appData.currentUser?.permissions || [];
            if (!permissions.includes('admin') && !permissions.includes('category-voucher-list')) {
                showNotification('Access denied. You do not have permission to view category voucher list.', 'error');
                // Clear the table to show empty state
                const tbody = document.getElementById('categoryVoucherListTable');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Access denied. You do not have permission to view category voucher list.</td></tr>';
                }
                return;
            }
            
            const categoryId = document.getElementById('categoryVoucherListCategoryFilter')?.value || '';
            const branchId = document.getElementById('categoryVoucherListBranchFilter')?.value || '';
            const fromDate = document.getElementById('categoryVoucherListFromDate')?.value || '';
            const toDate = document.getElementById('categoryVoucherListToDate')?.value || '';
            
            if (!fromDate || !toDate) {
                showNotification('Please select date range', 'error');
                return;
            }
            
            // Build filters for sales
            const salesFilters = {};
            if (categoryId) salesFilters.categoryId = categoryId;
            if (branchId) salesFilters.branchId = branchId;
            if (fromDate) salesFilters.from = fromDate;
            if (toDate) salesFilters.to = toDate;
            
            // Build filters for category payments (use separate API)
            let categoryPaymentUrl = '/category-payments';
            const paymentParams = [];
            if (branchId) paymentParams.push(`branchId=${branchId}`);
            if (categoryId) paymentParams.push(`categoryId=${categoryId}`);
            if (fromDate) paymentParams.push(`from=${fromDate}`);
            if (toDate) paymentParams.push(`to=${toDate}`);
            if (paymentParams.length > 0) {
                categoryPaymentUrl += '?' + paymentParams.join('&');
            }
            
            // Fetch sales and category payments in parallel
            Promise.all([
                api.getSales(salesFilters),
                api.getCategoryPayments(categoryPaymentUrl)
            ]).then(([sales, payments]) => {
                // No filtering needed - backend only returns category payments
                renderCategoryVoucherList(sales, payments);
            }).catch(error => {
                console.error('Error loading category voucher list:', error);
                // Check if it's a permission error
                if (error.response && error.response.status === 403) {
                    showNotification('Access denied. You do not have permission to view category voucher list.', 'error');
                    const tbody = document.getElementById('categoryVoucherListTable');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Access denied. You do not have permission to view category voucher list.</td></tr>';
                    }
                } else {
                    showNotification('Failed to load category voucher list: ' + (error.message || 'Unknown error'), 'error');
                }
            });
        }
        
        // Render Category Voucher List
        function renderCategoryVoucherList(sales, payments) {
            const tbody = document.getElementById('categoryVoucherListTable');
            if (!tbody) return;
            
            const fromDate = document.getElementById('categoryVoucherListFromDate')?.value || '';
            const toDate = document.getElementById('categoryVoucherListToDate')?.value || '';
            
            tbody.innerHTML = '';
            
            // Group sales by category and branch
            const salesByCategoryBranch = {};
            let totalSales = 0;
            let totalCost = 0;
            
            sales.forEach(sale => {
                const categoryId = sale.categoryId?._id || sale.categoryId || 'unknown';
                const categoryName = sale.categoryId?.name || sale.category || 'Unknown';
                const branchId = sale.branchId?._id || sale.branchId || 'unknown';
                const branchName = sale.branchId?.name || 'Unknown';
                
                const key = `${categoryId}_${branchId}`;
                if (!salesByCategoryBranch[key]) {
                    salesByCategoryBranch[key] = {
                        categoryId,
                        categoryName,
                        branchId,
                        branchName,
                        sales: 0,
                        cost: 0
                    };
                }
                
                salesByCategoryBranch[key].sales += sale.total || 0;
                salesByCategoryBranch[key].cost += sale.costTotal || 0;
                totalSales += sale.total || 0;
                totalCost += sale.costTotal || 0;
            });
            
            // Group payments by category and branch
            const paymentsByCategoryBranch = {};
            let totalPayment = 0;
            
            payments.forEach(payment => {
                // Skip if not a category voucher
                if (payment.voucherType && payment.voucherType !== 'category') return;
                if (!payment.categoryId) return;
                
                const categoryId = payment.categoryId?._id || payment.categoryId || 'unknown';
                const categoryName = payment.categoryId?.name || payment.category || 'Unknown';
                const branchId = payment.branchId?._id || payment.branchId || 'unknown';
                const branchName = payment.branchId?.name || 'Unknown';
                
                const key = `${categoryId}_${branchId}`;
                if (!paymentsByCategoryBranch[key]) {
                    paymentsByCategoryBranch[key] = {
                        categoryId,
                        categoryName,
                        branchId,
                        branchName,
                        payment: 0
                    };
                }
                
                paymentsByCategoryBranch[key].payment += payment.amount || 0;
                totalPayment += payment.amount || 0;
            });
            
            // Combine and render
            const allKeys = new Set([
                ...Object.keys(salesByCategoryBranch),
                ...Object.keys(paymentsByCategoryBranch)
            ]);
            
            allKeys.forEach(key => {
                const saleData = salesByCategoryBranch[key] || {};
                const paymentData = paymentsByCategoryBranch[key] || {};
                
                const categoryName = saleData.categoryName || paymentData.categoryName || 'Unknown';
                const branchName = saleData.branchName || paymentData.branchName || 'Unknown';
                const salesAmount = saleData.sales || 0;
                const costAmount = saleData.cost || 0;
                const paymentAmount = paymentData.payment || 0;
                const balance = paymentAmount - costAmount;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${categoryName}</td>
                    <td>${branchName}</td>
                    <td>${fromDate && toDate ? `${fromDate} to ${toDate}` : formatDate(new Date())}</td>
                    <td class="text-end">PKR ${salesAmount.toLocaleString()}</td>
                    <td class="text-end">PKR ${costAmount.toLocaleString()}</td>
                    <td class="text-end">PKR ${paymentAmount.toLocaleString()}</td>
                    <td class="text-end ${balance < 0 ? 'text-danger' : balance > 0 ? 'text-success' : ''}">
                        PKR ${balance.toLocaleString()}
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update summary cards
            const balance = totalPayment - totalCost;
            document.getElementById('categoryVoucherTotalSales').textContent = `PKR ${totalSales.toLocaleString()}`;
            document.getElementById('categoryVoucherTotalCost').textContent = `PKR ${totalCost.toLocaleString()}`;
            document.getElementById('categoryVoucherTotalPayment').textContent = `PKR ${totalPayment.toLocaleString()}`;
            const balanceEl = document.getElementById('categoryVoucherBalance');
            if (balanceEl) {
                const span = balanceEl.querySelector('span');
                if (span) {
                    span.textContent = `PKR ${balance.toLocaleString()}`;
                    span.className = balance < 0 ? 'text-danger' : balance > 0 ? 'text-success' : 'text-warning';
                }
            }
            
            if (tbody.children.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No data found for selected filters</td></tr>';
            }
        }
        
        // Clear Category Voucher Filters
        function clearCategoryVoucherFilters() {
            document.getElementById('categoryVoucherListCategoryFilter').value = '';
            document.getElementById('categoryVoucherListBranchFilter').value = '';
            document.getElementById('categoryVoucherListFromDate').value = '';
            document.getElementById('categoryVoucherListToDate').value = '';
            document.getElementById('categoryVoucherListTable').innerHTML = '<tr><td colspan="7" class="text-center text-muted">Click "Apply Filters" to load data</td></tr>';
            document.getElementById('categoryVoucherTotalSales').textContent = '0';
            document.getElementById('categoryVoucherTotalCost').textContent = '0';
            document.getElementById('categoryVoucherTotalPayment').textContent = '0';
            const balanceEl = document.getElementById('categoryVoucherBalance');
            if (balanceEl) {
                const span = balanceEl.querySelector('span');
                if (span) {
                    span.textContent = '0';
                    span.className = 'text-warning';
                }
            }
        }
        
        // Print Category Voucher List
        function printCategoryVoucherList() {
            const tbody = document.getElementById('categoryVoucherListTable');
            if (!tbody) {
                showNotification('No data to print', 'error');
                return;
            }
            
            const categoryId = document.getElementById('categoryVoucherListCategoryFilter')?.value || '';
            const branchId = document.getElementById('categoryVoucherListBranchFilter')?.value || '';
            const fromDate = document.getElementById('categoryVoucherListFromDate')?.value || '';
            const toDate = document.getElementById('categoryVoucherListToDate')?.value || '';
            
            const categoryName = categoryId ? appData.categories.find(c => c._id === categoryId)?.name || 'All Categories' : 'All Categories';
            const branchName = branchId ? appData.branches.find(b => b._id === branchId)?.name || 'All Branches' : 'All Branches';
            
            // Get totals from screen
            const totalSales = document.getElementById('categoryVoucherTotalSales')?.textContent || '0';
            const totalCost = document.getElementById('categoryVoucherTotalCost')?.textContent || '0';
            const totalPayment = document.getElementById('categoryVoucherTotalPayment')?.textContent || '0';
            const balanceEl = document.getElementById('categoryVoucherBalance');
            const balanceText = balanceEl ? (balanceEl.querySelector('span')?.textContent || balanceEl.textContent || '0') : '0';
            
            const companyName = appData.settings?.companyName || 'D.Watson Group Of Pharmacies';
            
            // Extract rows from visible table (excluding empty/no data rows)
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => {
                const cells = row.querySelectorAll('td');
                // Skip empty rows or "no data" rows
                if (cells.length === 1 && (cells[0].textContent.includes('No data') || cells[0].textContent.includes('Click "Apply Filters"') || cells[0].textContent.includes('Loading'))) {
                    return false;
                }
                // Valid rows should have at least 6 cells (Category, Branch, Sales, Cost, Payment, Balance)
                return cells.length >= 6;
            });
            
            if (rows.length === 0) {
                showNotification('No data to print', 'error');
                return;
            }
            
            const printContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Category Voucher Report - ${new Date().toLocaleDateString('en-GB')}</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #2c6e8a;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 28pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #2c6e8a;
        }
        
        .print-header .company-info {
            font-size: 11pt;
            color: #555;
            margin: 5px 0;
        }
        
        .filter-info {
            margin-bottom: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #2c6e8a;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .filter-info p {
            margin: 8px 0;
            font-size: 10pt;
            font-weight: 500;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        th {
            background-color: #2c6e8a;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #1a4d63;
        }
        
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .text-end {
            text-align: right;
        }
        
        .summary {
            margin-top: 30px;
            padding: 20px;
            border: 2px solid #2c6e8a;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 4px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            font-size: 11pt;
        }
        
        .summary-label {
            font-weight: bold;
            color: #2c6e8a;
        }
        
        @page {
            size: A4 portrait;
            margin: 0.5in;
        }
        
        @media print {
            body {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>${companyName}</h1>
        <div class="company-info">Category Voucher Report</div>
        <div class="company-info">Generated: ${new Date().toLocaleDateString('en-GB')}</div>
    </div>
    
    <div class="filter-info">
        <p><strong>Category:</strong> ${categoryName}</p>
        <p><strong>Branch:</strong> ${branchName}</p>
        <p><strong>From Date:</strong> ${fromDate || 'N/A'}</p>
        <p><strong>To Date:</strong> ${toDate || 'N/A'}</p>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Category</th>
                <th>Branch</th>
                <th class="text-end">Sales</th>
                <th class="text-end">Cost</th>
                <th class="text-end">Payment</th>
                <th class="text-end">Balance</th>
            </tr>
        </thead>
        <tbody>
            ${rows.map(row => {
                const cells = row.querySelectorAll('td');
                // Extract values - removing any HTML tags and trimming
                return `
                    <tr>
                        <td>${cells[0].textContent.trim()}</td>
                        <td>${cells[1].textContent.trim()}</td>
                        <td class="text-end">${cells[2] ? cells[2].textContent.trim() : ''}</td>
                        <td class="text-end">${cells[3] ? cells[3].textContent.trim() : ''}</td>
                        <td class="text-end">${cells[4] ? cells[4].textContent.trim() : ''}</td>
                        <td class="text-end">${cells[5] ? cells[5].textContent.trim() : ''}</td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    </table>
    
    <div class="summary">
        <div class="summary-row">
            <span class="summary-label">Total Sales:</span>
            <span>${totalSales}</span>
        </div>
        <div class="summary-row">
            <span class="summary-label">Total Cost:</span>
            <span>${totalCost}</span>
        </div>
        <div class="summary-row">
            <span class="summary-label">Total Payment:</span>
            <span>${totalPayment}</span>
        </div>
        <div class="summary-row" style="border-top: 2px solid #2c6e8a; margin-top: 15px; padding-top: 15px; font-size: 13pt; font-weight: bold;">
            <span style="color: #2c6e8a;">Balance Payment:</span>
            <span>${balanceText}</span>
        </div>
    </div>
</body>
</html>
            `;
            
            const w = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            if (!w) {
                showNotification('Popup blocked. Please allow popups.', 'error');
                return;
            }
            w.document.write(printContent);
            w.document.close();
            w.focus();
            setTimeout(() => w.print(), 250);
        }
        
        // Filter Payment Vouchers
        function filterPaymentVouchers() {
            loadPaymentVoucherList();
        }
        
        // Clear Payment Voucher Filters
        function clearPaymentVoucherFilters() {
            document.getElementById('paymentVoucherSearch').value = '';
            document.getElementById('paymentVoucherListBranchFilter').value = '';
            document.getElementById('paymentVoucherListSupplierFilter').value = '';
            document.getElementById('paymentVoucherListFromDate').value = '';
            document.getElementById('paymentVoucherListToDate').value = '';
            loadPaymentVoucherList();
        }
        
        // Download Payment Vouchers CSV
        function downloadPaymentVouchersCSV() {
            let url = '/payments';
            api.getPayments(url).then(vouchers => {
                let csv = 'Voucher Number,Date,Supplier,Branch,Amount,Payment Method,Description\n';
                vouchers.forEach(v => {
                    const branchName = v.branchId?.name || 'Unknown';
                    const supplierName = v.supplierId?.name || v.supplier || 'Unknown';
                    csv += `${v.voucherNumber || ''},${v.date},${supplierName},${branchName},${v.amount},${v.paymentMethod || 'Cash'},"${v.description || ''}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url2 = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url2;
                a.download = `vouchers_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url2);
                
                showNotification('Vouchers downloaded successfully!', 'success');
            }).catch(error => {
                console.error('Error downloading vouchers:', error);
                showNotification('Failed to download vouchers', 'error');
            });
        }
        
        // Print Payment Voucher List
        function printPaymentVoucherList() {
            // Get current filtered vouchers from the table
            const tbody = document.getElementById('paymentVoucherListTable');
            if (!tbody) {
                showNotification('No vouchers to print', 'error');
                return;
            }
            
            const rows = tbody.querySelectorAll('tr');
            if (rows.length === 0 || (rows.length === 1 && rows[0].textContent.includes('No vouchers'))) {
                showNotification('No vouchers to print', 'error');
                return;
            }
            
            // Get filter values to show in preview
            const fromDate = document.getElementById('paymentVoucherListFromDate')?.value || '';
            const toDate = document.getElementById('paymentVoucherListToDate')?.value || '';
            const branchFilter = document.getElementById('paymentVoucherListBranchFilter')?.value || '';
            const supplierFilter = document.getElementById('paymentVoucherListSupplierFilter')?.value || '';
            
            // Build URL to fetch all vouchers with current filters
            let url = '/payments?';
            const params = [];
            if (branchFilter) params.push(`branchId=${branchFilter}`);
            if (supplierFilter) params.push(`supplierId=${supplierFilter}`);
            if (fromDate) params.push(`from=${fromDate}`);
            if (toDate) params.push(`to=${toDate}`);
            url += params.join('&');
            
            // Fetch vouchers with populated data
            api.getPayments(url).then(vouchers => {
                if (!vouchers || vouchers.length === 0) {
                    showNotification('No vouchers to print', 'error');
                    return;
                }
                
                // Get company name from settings
                const companyName = appData.settings?.companyName || 'D.Watson Group of Pharmacy';
                
                // Get branch and supplier names from filters or vouchers
                let branchDisplayName = 'All Branches';
                let supplierDisplayName = 'All Suppliers';
                
                if (branchFilter) {
                    const branch = appData.branches.find(b => b._id === branchFilter);
                    branchDisplayName = branch ? branch.name : 'Selected Branch';
                } else if (vouchers.length > 0) {
                    // If no filter, show first branch or multiple branches
                    const uniqueBranches = [...new Set(vouchers.map(v => v.branchId?.name || 'Unknown'))];
                    branchDisplayName = uniqueBranches.length === 1 ? uniqueBranches[0] : 'All Branches';
                }
                
                if (supplierFilter) {
                    const supplier = appData.suppliers.find(s => s._id === supplierFilter);
                    supplierDisplayName = supplier ? supplier.name : 'Selected Supplier';
                } else if (vouchers.length > 0) {
                    // If no filter, show first supplier or multiple suppliers
                    const uniqueSuppliers = [...new Set(vouchers.map(v => v.supplierId?.name || v.supplier || 'Unknown'))];
                    supplierDisplayName = uniqueSuppliers.length === 1 ? uniqueSuppliers[0] : 'All Suppliers';
                }
                
                // Determine if Supplier column should be shown (single branch, multiple suppliers)
                const uniqueBranches = [...new Set(vouchers.map(v => v.branchId?.name || 'Unknown'))];
                const uniqueSuppliers = [...new Set(vouchers.map(v => v.supplierId?.name || v.supplier || 'Unknown'))];
                const includeSupplierCol = (uniqueSuppliers.length > 1);
                
                // Group vouchers by payment method
                const vouchersByMethod = {};
                vouchers.forEach(voucher => {
                    const method = voucher.paymentMethod || 'Cash';
                    if (!vouchersByMethod[method]) {
                        vouchersByMethod[method] = [];
                    }
                    vouchersByMethod[method].push(voucher);
                });
                
                // Sort payment methods alphabetically
                const sortedMethods = Object.keys(vouchersByMethod).sort();

                // Build combined voucher list preview - complete HTML document (same as sale report)
                let printContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Payment Vouchers List</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        @page {
            size: A4;
            margin: 0.5in;
        }
        
        body {
            font-family: Arial, sans-serif;
            font-size: 12pt;
            line-height: 1.4;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 25px;
            background: #00685c;
            color: #ffffff;
            border-bottom: 3px solid #000;
        }
        
        .print-header h2 {
            margin: 0;
            font-size: 24pt;
            font-weight: bold;
            letter-spacing: 1px;
            color: #ffffff;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            border: 1px solid #333;
            background: white;
            table-layout: fixed;
        }
        
        th {
            padding: 10px 8px;
            border: 1px solid #333;
            font-weight: bold;
            color: #ffffff;
            font-size: 10pt;
            text-transform: uppercase;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.3;
        }
        
        td {
            padding: 10px 8px;
            border: 1px solid #333;
            font-size: 11pt;
            word-wrap: break-word;
            overflow: hidden;
        }
        
        tr {
            height: auto;
        }
        
        .summary-section {
            border: 2px solid #000;
            padding: 25px;
            margin-top: 35px;
            background: #ffffff;
        }
        
        .summary-section h3 {
            text-align: center;
            margin-bottom: 25px;
            text-transform: uppercase;
            font-size: 16pt;
            font-weight: bold;
            color: #000;
            letter-spacing: 2px;
            padding-bottom: 15px;
            border-bottom: 2px solid #333;
        }
    </style>
</head>
<body>
    <!-- Professional Header -->
    <div class="print-header">
        <h2>${companyName}</h2>
        <p style="margin: 10px 0 0 0; font-size: 16pt; font-weight: bold; color: #ffffff; letter-spacing: 2px; text-transform: uppercase;">PAYMENT VOUCHERS LIST</p>
        ${fromDate || toDate ? `<p style="margin: 8px 0 0 0; font-size: 11pt; color: #ffffff;">Period: ${fromDate ? formatDate(fromDate) : 'All'} - ${toDate ? formatDate(toDate) : 'All'}</p>` : ''}
        <p style="margin: 8px 0 0 0; font-size: 10pt; color: #ffffff;">Generated: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
    </div>
    
    <!-- Branch and Supplier Info -->
    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #333;">
        <div style="display: flex; justify-content: space-between; font-size: 13pt; font-weight: bold; color: #000;">
            <div>
                <span style="color: #00685c;">Branch:</span> <span>${branchDisplayName}</span>
            </div>
            <div>
                <span style="color: #00685c;">Supplier:</span> <span>${supplierDisplayName}</span>
            </div>
        </div>
    </div>
    
    <!-- Professional Table -->
    <table>
        <thead>
            <tr style="background: #00685c;">
                <th style="text-align: center; width: 4%; padding: 10px 6px;">#</th>
                <th style="text-align: left; width: 12%; padding: 10px 6px;">V.No</th>
                <th style="text-align: left; width: 10%; padding: 10px 6px;">Date</th>
                ${includeSupplierCol ? '<th style="text-align: left; width: 18%; padding: 10px 6px;">Supplier</th>' : ''}
                <th style="text-align: center; width: 10%; padding: 10px 6px;">PM</th>
                <th style="text-align: left; width: ${includeSupplierCol ? '28%' : '38%'}; padding: 10px 6px;">Description</th>
                <th style="text-align: right; width: 16%; padding: 10px 6px;">Amount</th>
            </tr>
        </thead>
        <tbody>
                `;
                
                // Track overall row index for numbering
                let globalRowIndex = 0;
                
                // Loop through payment methods and group vouchers
                sortedMethods.forEach((method, methodIndex) => {
                    const methodVouchers = vouchersByMethod[method];
                    const methodTotal = methodVouchers.reduce((sum, v) => sum + (v.amount || 0), 0);
                    
                    // Add each voucher in this payment method group FIRST
                    methodVouchers.forEach((voucher, voucherIndex) => {
                        globalRowIndex++;
                        const voucherNum = voucher.voucherNumber || 'N/A';
                        const voucherDate = formatDate(voucher.date);
                        const amount = voucher.amount || 0;
                        const description = voucher.description || '-';
                        const supplierName = voucher.supplierId?.name || voucher.supplier || 'Unknown';
                        
                        // Professional alternate row colors - matching sale report
                        const rowBg = voucherIndex % 2 === 0 ? '#ffffff' : '#f8f9fa';
                        
                        printContent += `
                                <tr style="background-color: ${rowBg}; vertical-align: top;">
                                    <td style="padding: 10px 6px; border: 1px solid #333; font-weight: bold; color: #000; text-align: center; font-size: 11pt; width: 4%; vertical-align: top;">${globalRowIndex}</td>
                                    <td style="padding: 10px 6px; border: 1px solid #333; font-weight: bold; color: #000; font-size: 11pt; width: 12%; vertical-align: top;">${voucherNum}</td>
                                    <td style="padding: 10px 6px; border: 1px solid #333; color: #000; font-size: 11pt; width: 10%; vertical-align: top;">${voucherDate}</td>
                                    ${includeSupplierCol ? `<td style=\"padding: 10px 6px; border: 1px solid #333; color: #000; font-size: 11pt; width: 18%; vertical-align: top;\">${supplierName}</td>` : ''}
                                    <td style="padding: 10px 6px; border: 1px solid #333; text-align: center; color: #000; font-size: 11pt; width: 10%; vertical-align: top;">${method}</td>
                                    <td style="padding: 10px 6px; border: 1px solid #333; color: #000; font-size: 11pt; width: ${includeSupplierCol ? '28%' : '38%'}; white-space: normal; word-wrap: break-word; overflow-wrap: break-word; vertical-align: top; line-height: 1.4;">${description || '-'}</td>
                                    <td style="padding: 10px 6px; border: 1px solid #333; text-align: right; font-weight: bold; color: #000; font-size: 11pt; width: 16%; white-space: nowrap; vertical-align: top;">${amount.toLocaleString()}</td>
                                </tr>
                        `;
                    });
                    
                    // Add payment method subtotal row AFTER all vouchers for this method
                    printContent += `
                                <tr style="background-color: #000000; color: #ffffff;">
                                    <td colspan="${includeSupplierCol ? '6' : '5'}" style="padding: 12px 8px; border: 2px solid #000000; font-weight: bold; font-size: 13pt; text-align: center; text-transform: uppercase;">
                                        Subtotal ${method} Paid
                                    </td>
                                    <td style="padding: 12px 8px; border: 2px solid #000000; font-weight: bold; font-size: 13pt; text-align: right; color: #ffffff; white-space: nowrap;">${methodTotal.toLocaleString()}</td>
                                </tr>
                    `;
                });
                
                printContent += `
        </tbody>
    </table>
                `;
                
                // Professional summary footer - matching sale report style
                const totalAmount = vouchers.reduce((sum, v) => sum + (v.amount || 0), 0);
                const paidCount = vouchers.length; // All vouchers are PAID
                
                printContent += `
    <!-- Summary Section -->
    <div class="summary-section">
        <h3>SUMMARY</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <tr style="background-color: #f0f0f0;">
                <td style="padding: 12px; border: 1px solid #333; font-weight: bold; width: 30%; background: #f8f9fa; color: #000; font-size: 12pt;">Total Vouchers:</td>
                <td style="padding: 12px; border: 1px solid #333; width: 20%; color: #000; font-weight: bold; font-size: 12pt;">${vouchers.length}</td>
                <td style="padding: 12px; border: 1px solid #333; font-weight: bold; width: 30%; background: #f8f9fa; color: #000; font-size: 12pt;">Total Amount:</td>
                <td style="padding: 12px; border: 1px solid #333; font-weight: bold; width: 20%; text-align: right; color: #000; font-size: 12pt;">${totalAmount.toLocaleString()}</td>
            </tr>
            <tr>
                <td style="padding: 12px; border: 1px solid #333; font-weight: bold; background: #f8f9fa; color: #000; font-size: 12pt;">Status:</td>
                <td style="padding: 12px; border: 1px solid #333; color: #000; font-weight: bold; font-size: 12pt;">All PAID</td>
                <td style="padding: 12px; border: 1px solid #333; background: #f8f9fa;" colspan="2"></td>
            </tr>
        </table>
    </div>
    
    <!-- Signature Section -->
    <div style="display: flex; justify-content: space-between; margin-top: 60px; padding-top: 35px; border-top: 2px solid #333;">
        <div style="width: 45%; text-align: center;">
            <p style="margin: 0 0 12px 0; font-weight: bold; color: #000; font-size: 12pt; letter-spacing: 0.5px;">PREPARED BY</p>
            <div style="border-top: 2px solid #000; margin-top: 60px; padding-top: 8px;">
                <p style="margin: 0; color: #000; font-size: 10pt; letter-spacing: 0.5px;">Signature & Date</p>
            </div>
        </div>
        <div style="width: 45%; text-align: center;">
            <p style="margin: 0 0 12px 0; font-weight: bold; color: #000; font-size: 12pt; letter-spacing: 0.5px;">CASH RECEIVED BY</p>
            <div style="border-top: 2px solid #000; margin-top: 60px; padding-top: 8px;">
                <p style="margin: 0; color: #000; font-size: 10pt; letter-spacing: 0.5px;">Signature & Date</p>
            </div>
        </div>
    </div>
</body>
</html>
                `;
                
                // Open preview window and trigger print dialog (same as sale report)
                try {
                    const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                    if (!previewWindow) {
                        throw new Error('Popup blocked. Please allow popups for this site.');
                    }
                    previewWindow.document.write(printContent);
                    previewWindow.document.close();
                    
                    // Wait for content to load, then trigger print dialog
                    previewWindow.onload = function() {
                        setTimeout(() => {
                            previewWindow.print();
                        }, 250);
                    };
                    
                    // Fallback if onload doesn't fire
                    setTimeout(() => {
                        if (previewWindow.document.readyState === 'complete') {
                            previewWindow.print();
                        }
                    }, 500);
                } catch (error) {
                    console.error('Preview error:', error);
                    showNotification('Failed to open print preview. Please allow popups for this site.', 'error');
                }
            }).catch(error => {
                console.error('Error loading vouchers for print:', error);
                showNotification('Failed to load vouchers for printing', 'error');
            });
        }
        
        // Update Payment Dashboard
        function updatePaymentDashboard() {
            const dashboardSection = document.getElementById('payment-dashboard-section');
            if (!dashboardSection || dashboardSection.style.display === 'none') {
                return; // Don't load if section is not visible
            }
            
            const branchFilter = document.getElementById('paymentDashboardBranchFilter')?.value || '';
            const supplierFilter = document.getElementById('paymentDashboardSupplierFilter')?.value || '';
            const dateFilter = parseInt(document.getElementById('paymentDashboardDateFilter')?.value || '30');
            
            let url = '/payments';
            const params = [];
            if (branchFilter) params.push(`branchId=${branchFilter}`);
            if (supplierFilter) params.push(`supplierId=${supplierFilter}`);
            url += params.length > 0 ? '?' + params.join('&') : '';
            
            api.getPayments(url).then(paymentsData => {
                // Filter by date range
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - dateFilter);
                const filteredPayments = paymentsData.filter(p => {
                    const paymentDate = new Date(p.date);
                    return paymentDate >= cutoffDate;
                });
                
                // Calculate statistics
                const normalize = (m) => (m || 'Cash').toLowerCase();
                const totalAmount = filteredPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
                const cashAmount = filteredPayments
                    .filter(p => ['cash'].includes(normalize(p.paymentMethod)))
                    .reduce((sum, p) => sum + (p.amount || 0), 0);
                const bankAmount = filteredPayments
                    .filter(p => ['bank transfer','bank','bank_transfer'].includes(normalize(p.paymentMethod)))
                    .reduce((sum, p) => sum + (p.amount || 0), 0);
                const chequeAmount = filteredPayments
                    .filter(p => ['check','cheque'].includes(normalize(p.paymentMethod)))
                    .reduce((sum, p) => sum + (p.amount || 0), 0);
                const onlineAmount = filteredPayments
                    .filter(p => ['online payment','online','card','credit card','debit card'].includes(normalize(p.paymentMethod)))
                    .reduce((sum, p) => sum + (p.amount || 0), 0);
                
                // Update display
                document.getElementById('paymentCashAmount').textContent = cashAmount.toLocaleString();
                document.getElementById('paymentBankAmount').textContent = bankAmount.toLocaleString();
                const chequeEl = document.getElementById('paymentChequeAmount'); if (chequeEl) chequeEl.textContent = chequeAmount.toLocaleString();
                const onlineEl = document.getElementById('paymentOnlineAmount'); if (onlineEl) onlineEl.textContent = onlineAmount.toLocaleString();
                document.getElementById('paymentTotalAmount').textContent = totalAmount.toLocaleString();
                
                // Update recent vouchers
                const recentVouchers = filteredPayments.slice(-5).reverse();
                const tbody = document.getElementById('paymentRecentVouchersTable');
                if (tbody) {
                    if (recentVouchers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No vouchers found</td></tr>';
                    } else {
                        tbody.innerHTML = recentVouchers.map(v => {
                            const branchName = v.branchId?.name || 'Unknown';
                            const supplierName = v.supplierId?.name || v.supplier || 'Unknown';
                            const statusBadge = v.status === 'Approved' ? 'success' : v.status === 'Pending' ? 'warning' : 'danger';
                            return `
                                <tr>
                                    <td>${v.voucherNumber || 'N/A'}</td>
                                    <td>${formatDate(v.date)}</td>
                                    <td>${supplierName}</td>
                                    <td><span class="badge bg-secondary">${branchName}</span></td>
                                    <td>${v.amount.toLocaleString()}</td>
                                    <td><span class="badge bg-${statusBadge}">${v.status || 'Pending'}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-info" onclick="viewPaymentVoucher('${v._id}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
                
                // Update charts
                updatePaymentCharts(filteredPayments);
                
                // Force UI update after data loads
                setTimeout(() => {
                    const dashboardSection = document.getElementById('payment-dashboard-section');
                    if (dashboardSection) {
                        dashboardSection.style.display = 'block';
                        dashboardSection.classList.add('active');
                    }
                }, 50);

                // Link KPI cards to voucher list filtered by method
                const goToMethod = (method) => {
                    showPaymentTab('payment-voucher-list');
                    setTimeout(() => { try { loadPaymentVoucherList(method); } catch(e) {} }, 100);
                };
                const cashCard = document.getElementById('cardCashPaid'); if (cashCard) cashCard.onclick = () => goToMethod('Cash');
                const bankCard = document.getElementById('cardBankPaid'); if (bankCard) bankCard.onclick = () => goToMethod('Bank Transfer');
                const chequeCard = document.getElementById('cardChequePaid'); if (chequeCard) chequeCard.onclick = () => goToMethod('Cheque');
                const onlineCard = document.getElementById('cardOnlinePaid'); if (onlineCard) onlineCard.onclick = () => goToMethod('Online Payment');
            }).catch(error => {
                console.error('Error updating dashboard:', error);
            });
        }
        
        // Update Payment Charts
        function updatePaymentCharts(payments) {
            // Payment Trends Chart - Grouped by Branch and Supplier
            const ctx1 = document.getElementById('paymentTrendChart');
            if (ctx1 && typeof Chart !== 'undefined') {
                if (window.paymentTrendChart && typeof window.paymentTrendChart.destroy === 'function') {
                    window.paymentTrendChart.destroy();
                }
                
                // Get current filters
                const branchFilter = document.getElementById('paymentDashboardBranchFilter')?.value || '';
                const supplierFilter = document.getElementById('paymentDashboardSupplierFilter')?.value || '';
                
                // Generate last 7 days labels
                const last7Days = [];
                const dateStrs = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    dateStrs.push(dateStr);
                    last7Days.push(date.toLocaleDateString('en', { weekday: 'short' }));
                }
                
                // Determine grouping strategy based on filters
                let datasets = [];
                const colors = [
                    { border: 'rgb(78, 115, 223)', bg: 'rgba(78, 115, 223, 0.1)' },
                    { border: 'rgb(28, 200, 154)', bg: 'rgba(28, 200, 154, 0.1)' },
                    { border: 'rgb(54, 185, 204)', bg: 'rgba(54, 185, 204, 0.1)' },
                    { border: 'rgb(246, 194, 62)', bg: 'rgba(246, 194, 62, 0.1)' },
                    { border: 'rgb(231, 74, 59)', bg: 'rgba(231, 74, 59, 0.1)' },
                    { border: 'rgb(133, 135, 150)', bg: 'rgba(133, 135, 150, 0.1)' }
                ];
                
                if (branchFilter && supplierFilter) {
                    // Both filters: Single line for that branch-supplier
                    const amounts = dateStrs.map(dateStr => {
                        return payments
                            .filter(p => {
                                const pDate = p.date === dateStr || new Date(p.date).toISOString().split('T')[0] === dateStr;
                                return pDate;
                            })
                            .reduce((sum, p) => sum + (p.amount || 0), 0);
                    });
                    
                    const branchName = appData.branches.find(b => b._id === branchFilter)?.name || 'Selected Branch';
                    const supplierName = appData.suppliers.find(s => s._id === supplierFilter)?.name || 'Selected Supplier';
                    
                    datasets.push({
                        label: `${branchName} - ${supplierName}`,
                        data: amounts,
                        borderColor: colors[0].border,
                        backgroundColor: colors[0].bg,
                        tension: 0.4,
                        fill: false
                    });
                } else if (branchFilter) {
                    // Branch filter only: Show by supplier in that branch
                    const supplierSet = new Set();
                    payments.forEach(p => {
                        const supplierName = p.supplierId?.name || p.supplier || 'Unknown Supplier';
                        supplierSet.add(supplierName);
                    });
                    
                    Array.from(supplierSet).forEach((supplierName, index) => {
                        const amounts = dateStrs.map(dateStr => {
                            return payments
                                .filter(p => {
                                    const pDate = p.date === dateStr || new Date(p.date).toISOString().split('T')[0] === dateStr;
                                    const pSupplier = p.supplierId?.name || p.supplier || 'Unknown Supplier';
                                    return pDate && pSupplier === supplierName;
                                })
                                .reduce((sum, p) => sum + (p.amount || 0), 0);
                        });
                        
                        const color = colors[index % colors.length];
                        datasets.push({
                            label: supplierName,
                            data: amounts,
                            borderColor: color.border,
                            backgroundColor: color.bg,
                            tension: 0.4,
                            fill: false
                        });
                    });
                } else if (supplierFilter) {
                    // Supplier filter only: Show by branch
                    const branchSet = new Set();
                    payments.forEach(p => {
                        const branchName = p.branchId?.name || 'Unknown Branch';
                        branchSet.add(branchName);
                    });
                    
                    Array.from(branchSet).forEach((branchName, index) => {
                        const amounts = dateStrs.map(dateStr => {
                            return payments
                                .filter(p => {
                                    const pDate = p.date === dateStr || new Date(p.date).toISOString().split('T')[0] === dateStr;
                                    const pBranch = p.branchId?.name || 'Unknown Branch';
                                    return pDate && pBranch === branchName;
                                })
                                .reduce((sum, p) => sum + (p.amount || 0), 0);
                        });
                        
                        const color = colors[index % colors.length];
                        datasets.push({
                            label: branchName,
                            data: amounts,
                            borderColor: color.border,
                            backgroundColor: color.bg,
                            tension: 0.4,
                            fill: false
                        });
                    });
                } else {
                    // No filters: Show by branch (group all suppliers per branch)
                    const branchSet = new Set();
                    payments.forEach(p => {
                        const branchName = p.branchId?.name || 'Unknown Branch';
                        branchSet.add(branchName);
                    });
                    
                    Array.from(branchSet).forEach((branchName, index) => {
                        const amounts = dateStrs.map(dateStr => {
                            return payments
                                .filter(p => {
                                    const pDate = p.date === dateStr || new Date(p.date).toISOString().split('T')[0] === dateStr;
                                    const pBranch = p.branchId?.name || 'Unknown Branch';
                                    return pDate && pBranch === branchName;
                                })
                                .reduce((sum, p) => sum + (p.amount || 0), 0);
                        });
                        
                        const color = colors[index % colors.length];
                        datasets.push({
                            label: branchName,
                            data: amounts,
                            borderColor: color.border,
                            backgroundColor: color.bg,
                            tension: 0.4,
                            fill: false
                        });
                    });
                }
                
                // If no data, show total line
                if (datasets.length === 0) {
                    const amounts = dateStrs.map(dateStr => {
                        return payments
                            .filter(p => p.date === dateStr || new Date(p.date).toISOString().split('T')[0] === dateStr)
                            .reduce((sum, p) => sum + (p.amount || 0), 0);
                    });
                    datasets = [{
                            label: 'Daily Payments',
                        data: amounts,
                        borderColor: 'rgb(78, 115, 223)',
                        backgroundColor: 'rgba(78, 115, 223, 0.1)',
                        tension: 0.4
                    }];
                }
                
                window.paymentTrendChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: last7Days,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Supplier Distribution Chart
            const ctx2 = document.getElementById('paymentSupplierChart');
            if (ctx2 && typeof Chart !== 'undefined') {
                if (window.paymentSupplierChart && typeof window.paymentSupplierChart.destroy === 'function') {
                    window.paymentSupplierChart.destroy();
                }
                
                const supplierData = {};
                payments.forEach(p => {
                    const supplierName = p.supplierId?.name || p.supplier || 'Unknown';
                    supplierData[supplierName] = (supplierData[supplierName] || 0) + (p.amount || 0);
                });
                
                window.paymentSupplierChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(supplierData),
                        datasets: [{
                            data: Object.values(supplierData),
                            backgroundColor: [
                                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }
        
        // Initialize Payment Report Chart
        function initPaymentReportChart() {
            // Chart will be updated when report is generated
        }
        
        // Generate Payment Voucher Report
        function generatePaymentVoucherReport() {
            const reportSection = document.getElementById('payment-reports-section');
            if (!reportSection || reportSection.style.display === 'none') {
                return; // Don't load if section is not visible
            }
            
            const fromDate = document.getElementById('paymentReportFromDate')?.value || '';
            const toDate = document.getElementById('paymentReportToDate')?.value || '';
            const branch = document.getElementById('paymentReportBranch')?.value || '';
            const supplier = document.getElementById('paymentReportSupplier')?.value || '';
            
            // Require at least one date to be selected
            if (!fromDate && !toDate) {
                showNotification('Please select at least one date (From or To) to generate the report', 'error');
                return;
            }
            
            let url = '/payments?';
            const params = [];
            if (branch) params.push(`branchId=${branch}`);
            if (supplier) params.push(`supplierId=${supplier}`);
            if (fromDate) params.push(`from=${fromDate}`);
            if (toDate) params.push(`to=${toDate}`);
            url += params.join('&');
            
            api.getPayments(url).then(payments => {
                const total = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
                const count = payments.length;
                const average = count > 0 ? total / count : 0;
                
                // Find top supplier
                const supplierTotals = {};
                payments.forEach(p => {
                    const supplierName = p.supplierId?.name || p.supplier || 'Unknown';
                    supplierTotals[supplierName] = (supplierTotals[supplierName] || 0) + (p.amount || 0);
                });
                const topSupplier = Object.keys(supplierTotals).reduce((a, b) => 
                    supplierTotals[a] > supplierTotals[b] ? a : b, '');
                
                document.getElementById('paymentReportTotal').textContent = total.toLocaleString();
                document.getElementById('paymentReportCount').textContent = count;
                document.getElementById('paymentReportAvg').textContent = average.toLocaleString();
                document.getElementById('paymentTopSupplier').textContent = topSupplier || '-';
                
                // Update chart
                const ctx = document.getElementById('paymentReportChart');
                if (ctx && typeof Chart !== 'undefined') {
                    if (window.paymentReportChart && typeof window.paymentReportChart.destroy === 'function') {
                        window.paymentReportChart.destroy();
                    }
                    
                    const monthlyData = {};
                    payments.forEach(p => {
                        const month = new Date(p.date).toISOString().substring(0, 7);
                        monthlyData[month] = (monthlyData[month] || 0) + (p.amount || 0);
                    });
                    
                    const sortedMonths = Object.keys(monthlyData).sort();
                    const amounts = sortedMonths.map(m => monthlyData[m]);
                    
                    window.paymentReportChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: sortedMonths,
                            datasets: [{
                                label: 'Monthly Payments',
                                data: amounts,
                                backgroundColor: 'rgba(78, 115, 223, 0.8)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return 'PKR ' + value.toLocaleString();
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                showNotification('Report generated successfully!', 'success');
                
                // Force UI update after data loads
                setTimeout(() => {
                    const reportSection = document.getElementById('payment-reports-section');
                    if (reportSection) {
                        reportSection.style.display = 'block';
                        reportSection.classList.add('active');
                    }
                }, 50);
            }).catch(error => {
                console.error('Error generating report:', error);
                showNotification('Failed to generate report', 'error');
            });
        }
        
        // Print Payment Report
        function printPaymentReport() {
            window.print();
        }
        
        // OLD PAYMENT FUNCTIONS (TO BE REMOVED - KEPT FOR REFERENCE)
        function savePaymentEntry_OLD() {
            const date = document.getElementById('paymentDate').value;
            const branchId = document.getElementById('paymentBranch').value;
            
            if (!date || !branchId) {
                showNotification('Please fill in date and branch', 'error');
                return;
            }
            
            // Create payment entries for each category
            const paymentPromises = [];
            
            document.querySelectorAll('.payment-category-box').forEach(box => {
                const categoryId = box.getAttribute('data-category');
                const amountInput = box.querySelector('.payment-amount');
                const descriptionInput = box.querySelector('.payment-description');
                const methodInput = box.querySelector('.payment-method');
                
                const amount = parseFloat(amountInput.value) || 0;
                const description = descriptionInput.value.trim();
                const paymentMethod = methodInput.value || 'Cash';
                
                if (amount > 0) {
                    const paymentData = {
                        date: date,
                        branchId: branchId,
                        categoryId: categoryId,
                        amount: amount,
                        description: description,
                        paymentMethod: paymentMethod
                    };
                    
                    paymentPromises.push(api.createPayment(paymentData));
                }
            });
            
            if (paymentPromises.length === 0) {
                showNotification('Please enter at least one payment amount', 'error');
                return;
            }
            
            // Wait for all payments to be created
            Promise.all(paymentPromises).then(() => {
                // Reset form
                document.getElementById('paymentForm').reset();
                clearPaymentCategoryBoxes();
                
                // Set today's date again
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('paymentDate').value = today;
                
                showNotification('Payments saved successfully!', 'success');
                
                // Refresh payments list if it's visible
                if (document.getElementById('paymentsListSection').style.display !== 'none') {
                    loadPaymentsList();
                }
                
            }).catch(error => {
                console.error('Error saving payment:', error);
                showNotification('Failed to save payment', 'error');
            });
        }
        
        // Load payments list
        function loadPaymentsList() {
            const branchFilter = document.getElementById('paymentBranchFilter').value;
            const categoryFilter = document.getElementById('paymentCategoryFilter').value;
            const fromDate = document.getElementById('paymentFromDate').value;
            const toDate = document.getElementById('paymentToDate').value;
            
            let url = '/payments?';
            const params = [];
            
            if (branchFilter) params.push(`branchId=${branchFilter}`);
            if (categoryFilter) params.push(`categoryId=${categoryFilter}`);
            if (fromDate) params.push(`from=${fromDate}`);
            if (toDate) params.push(`to=${toDate}`);
            
            url += params.join('&');
            
            api.getPayments(url).then(paymentsData => {
                renderPaymentsList(paymentsData);
            }).catch(error => {
                console.error('Error loading payments list:', error);
                showNotification('Failed to load payments list', 'error');
            });
        }
        
        // Render payments list
        function renderPaymentsList(paymentsData) {
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '';
            
            if (paymentsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No payments found</td></tr>';
                return;
            }
            
            paymentsData.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(payment.date)}</td>
                    <td>${payment.branchId.name}</td>
                    <td>${payment.categoryId.name}</td>
                    <td>${payment.amount.toLocaleString()}</td>
                    <td>${payment.description || '-'}</td>
                    <td>${payment.paymentMethod}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editPayment('${payment._id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePayment('${payment._id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Clear payment category boxes
        function clearPaymentCategoryBoxes() {
            document.querySelectorAll('.payment-category-box').forEach(box => {
                const amountInput = box.querySelector('.payment-amount');
                const descriptionInput = box.querySelector('.payment-description');
                const methodInput = box.querySelector('.payment-method');
                
                amountInput.value = '';
                descriptionInput.value = '';
                methodInput.value = 'Cash';
            });
        }
        
        // Generate payment report
        function generatePaymentReport() {
            const branchFilter = document.getElementById('paymentReportBranchFilter')?.value || '';
            const categoryFilter = document.getElementById('paymentReportCategoryFilter')?.value || '';
            const fromDate = document.getElementById('paymentReportFromDateFilter')?.value || '';
            const toDate = document.getElementById('paymentReportToDateFilter')?.value || '';
            
            // Require at least one date to be selected
            if (!fromDate && !toDate) {
                showNotification('Please select at least one date (From or To) to generate the report', 'error');
                const tbody = document.getElementById('paymentReportTableBody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Please select at least one date (From or To) to generate the report</td></tr>';
                return;
            }
            
            let url = '/category-payments';
            const params = [];
            
            if (branchFilter) params.push(`branchId=${branchFilter}`);
            if (categoryFilter) params.push(`categoryId=${categoryFilter}`);
            if (fromDate) params.push(`from=${fromDate}`);
            if (toDate) params.push(`to=${toDate}`);
            
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            // Show loading state
            const tbody = document.getElementById('paymentReportTableBody');
            if (!tbody) {
                console.error('paymentReportTableBody element not found');
                showNotification('Error: Report table element not found', 'error');
                return;
            }
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Loading report...</td></tr>';
            
            // Use category payments API for payment reports
            api.getCategoryPayments(url).then(paymentsData => {
                if (!paymentsData || paymentsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No payments found for the selected filters</td></tr>';
                    const summaryEl = document.getElementById('paymentReportSummary');
                    if (summaryEl) summaryEl.innerHTML = '';
                    return;
                }
                
                // Process data for report
                const reportData = processPaymentReportData(paymentsData);
                
                // Render summary cards
                renderPaymentReportSummary(reportData);
                
                // Render detailed table
                renderPaymentReportTable(reportData);
                
                showNotification('Payment report generated successfully!', 'success');
                
            }).catch(error => {
                console.error('Error generating payment report:', error);
                showNotification('Failed to generate payment report: ' + (error.message || 'Unknown error'), 'error');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading report</td></tr>';
                }
            });
        }
        
        // Process payment data for report
        function processPaymentReportData(paymentsData) {
            const branchCategoryMap = {};
            let totalAmount = 0;
            let totalCount = 0;
            
            paymentsData.forEach(payment => {
                const branchName = payment.branchId?.name || payment.branchId || 'Unknown';
                const categoryName = payment.categoryId?.name || payment.category || 'Unknown';
                const key = `${branchName}|${categoryName}`;
                
                if (!branchCategoryMap[key]) {
                    branchCategoryMap[key] = {
                        branch: branchName,
                        category: categoryName,
                        totalAmount: 0,
                        count: 0
                    };
                }
                
                branchCategoryMap[key].totalAmount += payment.amount;
                branchCategoryMap[key].count += 1;
                totalAmount += payment.amount;
                totalCount += 1;
            });
            
            // Convert to array and sort by branch and category
            const reportArray = Object.values(branchCategoryMap).sort((a, b) => {
                if (a.branch !== b.branch) {
                    return a.branch.localeCompare(b.branch);
                }
                return a.category.localeCompare(b.category);
            });
            
            return {
                branchCategoryData: reportArray,
                summary: {
                    totalAmount: totalAmount,
                    totalCount: totalCount,
                    averageAmount: totalCount > 0 ? totalAmount / totalCount : 0
                }
            };
        }
        
        // Render payment report summary cards
        function renderPaymentReportSummary(reportData) {
            const summaryContainer = document.getElementById('paymentReportSummary');
            if (!summaryContainer) {
                console.error('paymentReportSummary element not found');
                return;
            }
            const { totalAmount, totalCount, averageAmount } = reportData.summary;
            
            summaryContainer.innerHTML = `
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h6 class="card-title">Total Payments</h6>
                            <h3 class="mb-0">${totalAmount.toLocaleString()}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h6 class="card-title">Payment Count</h6>
                            <h3 class="mb-0">${totalCount.toLocaleString()}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <h6 class="card-title">Average Amount</h6>
                            <h3 class="mb-0">${averageAmount.toLocaleString(undefined, {maximumFractionDigits: 2})}</h3>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Render payment report table
        function renderPaymentReportTable(reportData) {
            const tbody = document.getElementById('paymentReportTableBody');
            if (!tbody) {
                console.error('paymentReportTableBody element not found');
                return;
            }
            tbody.innerHTML = '';
            
            reportData.branchCategoryData.forEach(item => {
                const row = document.createElement('tr');
                const average = item.count > 0 ? item.totalAmount / item.count : 0;
                
                row.innerHTML = `
                    <td><strong>${item.branch}</strong></td>
                    <td>${item.category}</td>
                    <td><strong>${item.totalAmount.toLocaleString()}</strong></td>
                    <td>${item.count}</td>
                    <td>${average.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'table-info';
            totalRow.innerHTML = `
                <td><strong>TOTAL</strong></td>
                <td>-</td>
                <td><strong>${reportData.summary.totalAmount.toLocaleString()}</strong></td>
                <td><strong>${reportData.summary.totalCount}</strong></td>
                <td><strong>${reportData.summary.averageAmount.toLocaleString(undefined, {maximumFractionDigits: 2})}</strong></td>
            `;
            tbody.appendChild(totalRow);
        }
        
        // Print payment report
        function printPaymentReport() {
            // Get filter values for print header
            const branchFilter = document.getElementById('reportBranchFilter');
            const categoryFilter = document.getElementById('reportCategoryFilter');
            const fromDate = document.getElementById('reportFromDate');
            const toDate = document.getElementById('reportToDate');
            
            const branchText = branchFilter.options[branchFilter.selectedIndex].text;
            const categoryText = categoryFilter.options[categoryFilter.selectedIndex].text;
            const fromDateText = fromDate.value ? fromDate.value : 'All Time';
            const toDateText = toDate.value ? toDate.value : 'All Time';
            
            // Get report elements
            const reportTable = document.getElementById('paymentReportTableSection');
            const reportSummary = document.getElementById('paymentReportSummary');
            
            if (!reportTable || reportTable.querySelector('tbody').innerHTML.includes('Select filters')) {
                showNotification('Please generate a report first before printing', 'error');
                return;
            }
            
            // Extract summary values from current DOM
            const totalPaymentEl = reportSummary.querySelector('.bg-primary h3');
            const totalCountEl = reportSummary.querySelector('.bg-success h3');
            const averageAmountEl = reportSummary.querySelector('.bg-info h3');
            
            const totalPayment = totalPaymentEl ? totalPaymentEl.textContent.trim() : '0';
            const totalCount = totalCountEl ? totalCountEl.textContent.trim() : '0';
            const averageAmount = averageAmountEl ? averageAmountEl.textContent.trim() : '0';
            
            // Get current date and time
            const now = new Date();
            const printDate = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            
            // Create print window content
            const printWindow = window.open('', '_blank');
            
            // Build print content without script tag in template literal
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Payment Report - Print</title>
                    <style>
                        @media print {
                            @page {
                                size: A4 portrait;
                                margin: 1cm;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            margin: 20px;
                            color: #000;
                        }
                        .print-header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 3px solid #000;
                            padding-bottom: 15px;
                        }
                        .print-header h1 {
                            margin: 0 0 10px 0;
                            font-size: 24px;
                            color: #000;
                        }
                        .print-header .filters {
                            font-size: 12px;
                            margin-top: 10px;
                            color: #333;
                        }
                        .print-header .filters div {
                            margin: 5px 0;
                        }
                        .print-summary {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 15px;
                            margin-bottom: 30px;
                        }
                        .summary-card {
                            border: 2px solid #000;
                            padding: 15px;
                            text-align: center;
                            background: #f5f5f5;
                        }
                        .summary-card h6 {
                            margin: 0 0 10px 0;
                            font-size: 14px;
                            font-weight: bold;
                            color: #000;
                        }
                        .summary-card h3 {
                            margin: 0;
                            font-size: 24px;
                            color: #000;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                            page-break-inside: auto;
                        }
                        thead {
                            background-color: #000;
                            color: #fff;
                        }
                        thead th {
                            padding: 12px;
                            text-align: left;
                            border: 1px solid #000;
                            font-weight: bold;
                        }
                        tbody tr {
                            page-break-inside: avoid;
                        }
                        tbody td {
                            padding: 10px;
                            border: 1px solid #000;
                        }
                        tbody tr.table-info {
                            background-color: #e0e0e0;
                            font-weight: bold;
                        }
                        .print-footer {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 10px;
                            color: #666;
                            border-top: 1px solid #000;
                            padding-top: 10px;
                        }
                        @media print {
                            .no-print {
                                display: none;
                            }
                            button, .btn {
                                display: none;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>Payment Report</h1>
                        <div class="filters">
                            <div><strong>Generated On:</strong> ${printDate}</div>
                            <div><strong>Branch:</strong> ${branchText} | <strong>Category:</strong> ${categoryText}</div>
                            <div><strong>Date Range:</strong> ${fromDateText} to ${toDateText}</div>
                        </div>
                    </div>
                    
                    <div class="print-summary">
                        <div class="summary-card">
                            <h6>Total Payments</h6>
                            <h3>${totalPayment}</h3>
                        </div>
                        <div class="summary-card">
                            <h6>Payment Count</h6>
                            <h3>${totalCount}</h3>
                        </div>
                        <div class="summary-card">
                            <h6>Average Amount</h6>
                            <h3>${averageAmount}</h3>
                        </div>
                    </div>
                    
                    ${reportTable.outerHTML}
                    
                    <div class="print-footer">
                        <p>D.Watson Pharmacy Management System - Payment Report</p>
                        <p>Printed on ${printDate}</p>
                    </div>
                </body>
                </html>
            `;
            
            // Write HTML content
            printWindow.document.write(printContent);
            
            // Add print script separately to avoid parser conflicts
            printWindow.document.write('<scr' + 'ipt>window.onload = function() { window.print(); window.onafterprint = function() { window.close(); }; };</scr' + 'ipt>');
            
            printWindow.document.close();
        }
        
        // Edit payment
        function editPayment(id) {
            if (!(appData.currentUser?.permissions || []).includes('payment-edit')) {
                showNotification("You don't have permission to edit vouchers", 'error');
                return;
            }
            api.getPayment(id).then(payment => {
                // Populate the edit modal with payment data
                document.getElementById('editPaymentDate').value = new Date(payment.date).toISOString().split('T')[0];
                document.getElementById('editPaymentBranch').value = payment.branchId._id;
                document.getElementById('editPaymentCategory').value = payment.categoryId._id;
                document.getElementById('editPaymentAmount').value = payment.amount;
                document.getElementById('editPaymentDescription').value = payment.description || '';
                document.getElementById('editPaymentMethod').value = payment.paymentMethod || 'Cash';
                document.getElementById('editPaymentNotes').value = payment.notes || '';
                
                // Store the payment ID for the update
                document.getElementById('updatePaymentBtn').setAttribute('data-payment-id', id);
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editPaymentModal'));
                modal.show();
                
            }).catch(error => {
                console.error('Error fetching payment data:', error);
                showNotification('Failed to load payment data', 'error');
            });
        }
        
        // Update payment
        function updatePayment() {
            if (!(appData.currentUser?.permissions || []).includes('payment-edit')) {
                showNotification("You don't have permission to edit vouchers", 'error');
                return;
            }
            const paymentId = document.getElementById('updatePaymentBtn').getAttribute('data-payment-id');
            
            const updatedData = {
                date: document.getElementById('editPaymentDate').value,
                branchId: document.getElementById('editPaymentBranch').value,
                categoryId: document.getElementById('editPaymentCategory').value,
                amount: parseFloat(document.getElementById('editPaymentAmount').value),
                description: document.getElementById('editPaymentDescription').value,
                paymentMethod: document.getElementById('editPaymentMethod').value,
                notes: document.getElementById('editPaymentNotes').value
            };
            
            api.updatePayment(paymentId, updatedData).then(() => {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('editPaymentModal')).hide();
                
                // Reset form
                document.getElementById('editPaymentForm').reset();
                
                // Show notification
                showNotification('Payment updated successfully!', 'success');
                
                // Reload payments list
                loadPaymentsList();
                
            }).catch(error => {
                console.error('Error updating payment:', error);
                showNotification('Failed to update payment', 'error');
            });
        }
        
        // Delete payment
        function deletePayment(id) {
            if (!(appData.currentUser?.permissions || []).includes('payment-delete')) {
                showNotification("You don't have permission to delete vouchers", 'error');
                return;
            }
            if (confirm('Are you sure you want to delete this payment?')) {
                api.deletePayment(id).then(() => {
                    showNotification('Payment deleted successfully!', 'success');
                    loadPaymentsList();
                }).catch(error => {
                    console.error('Error deleting payment:', error);
                    showNotification('Failed to delete payment', 'error');
                });
            }
        }
        
        // Load categories
        function loadCategories() {
            // Check if user has permission to access categories
            if (appData.currentUser) {
                const permissions = appData.currentUser.permissions || [];
                if (!hasPermission('categories', permissions)) {
                    // Show permission denied banner
                    const permissionBanner = document.getElementById('permission-denied-banner-categories');
                    if (permissionBanner) {
                        permissionBanner.classList.remove('d-none');
                    }
                    showNotification('You don\'t have permission to access categories', 'error');
                    return;
                }
            }
            
            // Hide permission denied banner if user has permission
            const permissionBanner = document.getElementById('permission-denied-banner-categories');
            if (permissionBanner) {
                permissionBanner.classList.add('d-none');
            }
            
            api.getCategories().then(categoriesData => {
                appData.categories = categoriesData;
                renderCategories(categoriesData);
            }).catch(error => {
                console.error('Error loading categories:', error);
                showNotification('Failed to load categories', 'error');
            });
        }
        
        // Render categories in both card and table views
        function renderCategories(categoriesData) {
            const sortedCategories = [...categoriesData].sort((a, b) => {
                const aSeq = a.sequence;
                const bSeq = b.sequence;
                const aHas = aSeq !== undefined && aSeq !== null;
                const bHas = bSeq !== undefined && bSeq !== null;
                if (aHas && bHas) return aSeq - bSeq;
                if (aHas && !bHas) return -1;
                if (!aHas && bHas) return 1;
                return new Date(a.createdAt) - new Date(b.createdAt);
            });
            
            // Render card view
            const cardContainer = document.getElementById('categoriesContainer');
            cardContainer.innerHTML = '';
            
            sortedCategories.forEach((category, index) => {
                const card = document.createElement('div');
                card.className = 'col-md-4 mb-3';
                const categoryNumber = (category.sequence !== undefined && category.sequence !== null) ? category.sequence : (index + 1);
                const fullId = category._id; // Show full MongoDB ObjectId
                
                card.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${category.name}</h5>
                                <span class="badge bg-primary">#${categoryNumber}</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">ID: ${fullId}</small>
                            </div>
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <p class="card-text text-muted">${category.description || 'No description'}</p>
                                </div>
                                <span class="badge bg-${category.color || 'primary'}">${category.color || 'primary'}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-primary" onclick="editCategory('${category._id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${category._id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                cardContainer.appendChild(card);
            });
            
            // Render table view
            const tableBody = document.getElementById('categoriesTableBody');
            tableBody.innerHTML = '';
            
            sortedCategories.forEach((category, index) => {
                const row = document.createElement('tr');
                const createdDate = new Date(category.createdAt).toLocaleDateString();
                const tableSeq = (category.sequence !== undefined && category.sequence !== null) ? category.sequence : (index + 1);
                const fullId = category._id;
                
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-primary me-2">#${tableSeq}</span>
                            <strong>${category.name}</strong>
                        </div>
                        <small class="text-muted">ID: ${fullId}</small>
                    </td>
                    <td>${category.description || 'No description'}</td>
                    <td><span class="badge bg-${category.color || 'primary'}">${category.color || 'primary'}</span></td>
                    <td>${createdDate}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editCategory('${category._id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${category._id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // ========================================
        // CATEGORY FUNCTIONS
        // ========================================
        
        // Save category
        function saveCategory() {
            const categoryData = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value,
                color: document.getElementById('categoryColor').value,
                sequence: (function(){ const v = document.getElementById('categorySequence').value; return v === '' ? undefined : parseInt(v, 10); })()
            };
            console.log(' Saving category payload', categoryData);
            
            api.createCategory(categoryData).then(category => {
                console.log(' Saved category response', { id: category?._id, sequence: category?.sequence });
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
                
                // Reset form and modal title
                document.getElementById('categoryForm').reset();
                document.getElementById('addCategoryModalLabel').textContent = 'Add New Category';
                
                // Show notification
                showNotification('Category saved successfully!', 'success');
                
                // Update selectors and inputs
                populateCategorySelectors();
                generateCategoryInputs();
                
                // Reload categories and dashboard
                loadCategories();
                loadDashboard();
            }).catch(error => {
                console.error('Error saving category:', error);
                // Check if it's a duplicate name error
                if (error.message.includes('duplicate key') || error.message.includes('already exists')) {
                    showNotification('Category name already exists. Please use a different name.', 'error');
                } else {
                    showNotification('Failed to save category', 'error');
                }
            });
        }
        
        // Edit category
        function editCategory(id) {
            api.getCategory(id).then(category => {
                console.log(' Editing category data', { id: category?._id, sequence: category?.sequence });
                // Fill form with existing data
                document.getElementById('categoryName').value = category.name;
                document.getElementById('categoryDescription').value = category.description || '';
                document.getElementById('categoryColor').value = category.color || 'primary';
                const seqEl = document.getElementById('categorySequence');
                if (seqEl) { seqEl.value = (category.sequence !== undefined && category.sequence !== null) ? String(category.sequence) : ''; }
                
                // Update modal title for EDIT mode
                document.getElementById('addCategoryModalLabel').textContent = 'Edit Category';
                
                // FORCE SET save button to update mode
                const saveBtn = document.getElementById('saveCategoryBtn');
                saveBtn.textContent = 'Update Category';
                
                // Remove ALL existing event handlers
                saveBtn.onclick = null;
                saveBtn.removeAttribute('onclick');
                
                // Create update handler with the specific ID
                const updateCategoryHandler = function() {
                    if (document.getElementById('categoryForm').checkValidity()) {
                        updateCategory(id);
                    } else {
                        document.getElementById('categoryForm').reportValidity();
                    }
                };
                
                // Set the new handler
                saveBtn.onclick = updateCategoryHandler;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('addCategoryModal'));
                modal.show();
            }).catch(error => {
                console.error('Error fetching category data:', error);
                showNotification('Failed to load category data', 'error');
            });
        }
        
        // Update category
        function updateCategory(id) {
            const categoryData = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value,
                color: document.getElementById('categoryColor').value,
                sequence: (function(){ const v = document.getElementById('categorySequence').value; return v === '' ? undefined : parseInt(v, 10); })()
            };
            console.log(' Updating category payload', { id, sequence: categoryData.sequence });
            
            api.updateCategory(id, categoryData).then(() => {
                console.log(' Category update successful');
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
                
                // Reset form and modal title
                document.getElementById('categoryForm').reset();
                document.getElementById('addCategoryModalLabel').textContent = 'Add New Category';
                
                // Reset save button
                const saveBtn = document.getElementById('saveCategoryBtn');
                saveBtn.textContent = 'Save Category';
                saveBtn.onclick = saveCategory;
                
                // Show notification
                showNotification('Category updated successfully!', 'success');
                
                // Update selectors and inputs
                populateCategorySelectors();
                generateCategoryInputs();
                
                // Reload categories and dashboard
                loadCategories();
                loadDashboard();
            }).catch(error => {
                console.error('Error updating category:', error);
                // Check if it's a duplicate name error
                if (error.message.includes('duplicate key') || error.message.includes('already exists')) {
                    showNotification('Category name already exists. Please use a different name.', 'error');
                } else {
                    showNotification('Failed to update category', 'error');
                }
            });
        }
        
        // Delete category
        function deleteCategory(id) {
            if (confirm('Are you sure you want to delete this category? This will also delete all sales data for this category.')) {
                api.deleteCategory(id).then(() => {
                    showNotification('Category deleted successfully!', 'success');
                    
                    // Update selectors and inputs
                    populateCategorySelectors();
                    generateCategoryInputs();
                    
                    // Reload categories and dashboard
                    loadCategories();
                    loadDashboard();
                }).catch(error => {
                    console.error('Error deleting category:', error);
                    showNotification('Failed to delete category', 'error');
                });
            }
        }
        
        // Generate report
        function generateReport() {
            const dateFrom = document.getElementById('reportDateFrom').value;
            const dateTo = document.getElementById('reportDateTo').value;
            const branchId = document.getElementById('reportBranch').value;
            
            // Require at least one date to be selected
            if (!dateFrom && !dateTo) {
                showNotification('Please select at least one date (From or To) to generate the report', 'error');
                return;
            }
            
            // Build filters object
            const filters = {};
            if (dateFrom) filters.from = dateFrom;
            if (dateTo) filters.to = dateTo;
            if (branchId) filters.branchId = branchId;
            
            // Fetch filtered sales data
            api.getSales(filters).then(filteredData => {
                // Calculate totals by category
                const categoryData = {};
                
                appData.categories.forEach(category => {
                    const categorySales = filteredData.filter(sale => sale.categoryId._id === category._id);
                    const totalSales = categorySales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                    const totalCost = categorySales.reduce((sum, sale) => sum + (sale.costTotal || 0), 0);
                    const totalProfit = totalSales - totalCost;
                    const profitMargin = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;
                    
                    categoryData[category._id] = {
                        name: category.name,
                        totalSales,
                        totalCost,
                        totalProfit,
                        profitMargin
                    };
                });
                
                // Calculate grand totals
                const grandTotalSales = Object.values(categoryData).reduce((sum, data) => sum + data.totalSales, 0);
                const grandTotalCost = Object.values(categoryData).reduce((sum, data) => sum + data.totalCost, 0);
                const grandTotalProfit = grandTotalSales - grandTotalCost;
                const grandProfitMargin = grandTotalSales > 0 ? (grandTotalProfit / grandTotalSales * 100) : 0;
                
                // Update report summary
                const summaryContainer = document.getElementById('reportSummary');
                summaryContainer.innerHTML = `
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <div class="category-value text-primary">${grandTotalSales.toLocaleString()}</div>
                                <div class="category-label">Total Sales</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <div class="category-value text-success">${grandTotalCost.toLocaleString()}</div>
                                <div class="category-label">Total Cost</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <div class="category-value text-info">${grandTotalProfit.toLocaleString()}</div>
                                <div class="category-label">Total Profit</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <div class="category-value text-warning">${grandProfitMargin.toFixed(1)}%</div>
                                <div class="category-label">Profit Margin</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Update report table
                const tableBody = document.getElementById('reportTableBody');
                tableBody.innerHTML = '';
                
                Object.values(categoryData).forEach(data => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${data.name}</td>
                        <td>${data.totalSales.toLocaleString()}</td>
                        <td>${data.totalCost.toLocaleString()}</td>
                        <td class="${data.totalProfit >= 0 ? 'text-success' : 'text-danger'}">
                            ${data.totalProfit.toLocaleString()}
                        </td>
                        <td>
                            <span class="badge ${data.profitMargin >= 0 ? 'bg-success' : 'bg-danger'}">
                                ${data.profitMargin.toFixed(1)}%
                            </span>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Add grand total row
                const totalRow = document.createElement('tr');
                totalRow.className = 'table-active';
                totalRow.innerHTML = `
                    <td><strong>Grand Total</strong></td>
                    <td><strong>${grandTotalSales.toLocaleString()}</strong></td>
                    <td><strong>${grandTotalCost.toLocaleString()}</strong></td>
                    <td class="${grandTotalProfit >= 0 ? 'text-success' : 'text-danger'}">
                        <strong>${grandTotalProfit.toLocaleString()}</strong>
                    </td>
                    <td>
                        <span class="badge ${grandProfitMargin >= 0 ? 'bg-success' : 'bg-danger'}">
                            ${grandProfitMargin.toFixed(1)}%
                        </span>
                    </td>
                `;
                tableBody.appendChild(totalRow);
                
                // Generate sales comparison table
                generateSalesComparisonTable(filteredData);
                
                // Generate date wise data table
                generateDateWiseTable(filteredData);
            }).catch(error => {
                console.error('Error generating report:', error);
                showNotification('Failed to generate report', 'error');
            });
        }
        
        // ========================================
        // NEW: Tab-Specific Report Generation Functions
        // ========================================
        
        // Generate Sales Report (Tab 1)
        function generateSalesReport() {
            console.log(' generateSalesReport called');
            
            const dateFrom = document.getElementById('salesReportDateFrom')?.value || '';
            const dateTo = document.getElementById('salesReportDateTo')?.value || '';
            const branchId = document.getElementById('salesReportBranch')?.value || '';
            const categoryId = document.getElementById('salesReportCategory')?.value || '';
            
            console.log(' Sales Report Filters:', { dateFrom, dateTo, branchId, categoryId });
            
            // Require at least one date to be selected
            if (!dateFrom && !dateTo) {
                showNotification('Please select at least one date (From or To) to generate the report', 'error');
                return;
            }
            
            // Update subtitle based on filters
            const subtitle = document.getElementById('salesReportSubtitle');
            let subtitleText = '';
            if (branchId) {
                const branch = appData.branches.find(b => b._id === branchId);
                if (branch) subtitleText += ` ${branch.name}`;
            }
            if (categoryId) {
                const category = appData.categories.find(c => c._id === categoryId);
                if (category) subtitleText += (subtitleText ? ' | ' : '') + ` ${category.name}`;
            }
            if (subtitleText) {
                subtitle.style.display = 'block';
                subtitle.textContent = subtitleText;
            } else {
                subtitle.style.display = 'none';
            }
            
            const filters = {};
            if (dateFrom) filters.from = dateFrom;
            if (dateTo) filters.to = dateTo;
            if (branchId) filters.branchId = branchId;
            
            api.getSales(filters).then(filteredData => {
                console.log(' Sales Report - API Response:', {
                    totalSales: filteredData?.length || 0,
                    filters: filters,
                    categoryId: categoryId,
                    branchId: branchId
                });
                
                // Additional category filtering if specified
                let data = filteredData || [];
                if (categoryId && data.length > 0) {
                    data = filteredData.filter(sale => {
                        const saleCategoryId = sale.categoryId?._id || sale.categoryId;
                        return String(saleCategoryId) === String(categoryId);
                    });
                    console.log(' Sales Report - After category filter:', data.length);
                }
                
                // Check if we have data
                if (!data || data.length === 0) {
                    console.warn(' No sales data available for sales report');
                    showNotification('No sales data found for the selected criteria', 'info');
                    // Clear the table
                    const tableBody = document.getElementById('salesReportTableBody');
                    if (tableBody) {
                        tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No data found</td></tr>';
                    }
                    // Reset summary cards
                    const summaryTotalSalesEl = document.getElementById('summaryTotalSales');
                    const summaryTotalCostEl = document.getElementById('summaryTotalCost');
                    const summaryTotalProfitEl = document.getElementById('summaryTotalProfit');
                    const summaryProfitMarginEl = document.getElementById('summaryProfitMargin');
                    if (summaryTotalSalesEl) summaryTotalSalesEl.textContent = '0';
                    if (summaryTotalCostEl) summaryTotalCostEl.textContent = '0';
                    if (summaryTotalProfitEl) summaryTotalProfitEl.textContent = '0';
                    if (summaryProfitMarginEl) summaryProfitMarginEl.textContent = '0%';
                    return;
                }
                
                // Calculate totals by branch and category
                const reportData = {};
                data.forEach(sale => {
                    const branchId = sale.branchId?._id || sale.branchId;
                    const categoryId = sale.categoryId?._id || sale.categoryId;
                    const branchName = sale.branchId?.name || 'Unknown';
                    const categoryName = sale.categoryId?.name || 'Unknown';
                    const key = `${branchId}-${categoryId}`;
                    if (!reportData[key]) {
                        reportData[key] = {
                            branch: branchName,
                            category: categoryName,
                            totalSales: 0,
                            totalCost: 0
                        };
                    }
                    reportData[key].totalSales += sale.total || 0;
                    reportData[key].totalCost += sale.costTotal || 0;
                });
                
                // Calculate summary totals
                let summaryTotalSales = 0, summaryTotalCost = 0, summaryTotalProfit = 0;
                Object.values(reportData).forEach(item => {
                    summaryTotalSales += item.totalSales;
                    summaryTotalCost += item.totalCost;
                    summaryTotalProfit += (item.totalSales - item.totalCost);
                });
                const summaryProfitMargin = summaryTotalSales > 0 ? (summaryTotalProfit / summaryTotalSales * 100) : 0;
                
                console.log(' Sales Report - Summary:', {
                    totalSales: summaryTotalSales,
                    totalCost: summaryTotalCost,
                    totalProfit: summaryTotalProfit,
                    profitMargin: summaryProfitMargin
                });
                
                // Update summary cards
                const summaryTotalSalesEl = document.getElementById('summaryTotalSales');
                const summaryTotalCostEl = document.getElementById('summaryTotalCost');
                const summaryTotalProfitEl = document.getElementById('summaryTotalProfit');
                const summaryProfitMarginEl = document.getElementById('summaryProfitMargin');
                if (summaryTotalSalesEl) summaryTotalSalesEl.textContent = `${summaryTotalSales.toLocaleString()}`;
                if (summaryTotalCostEl) summaryTotalCostEl.textContent = `${summaryTotalCost.toLocaleString()}`;
                if (summaryTotalProfitEl) summaryTotalProfitEl.textContent = `${summaryTotalProfit.toLocaleString()}`;
                if (summaryProfitMarginEl) summaryProfitMarginEl.textContent = `${summaryProfitMargin.toFixed(1)}%`;
                
                // Update table - Group by branch for better visibility
                const tableBody = document.getElementById('salesReportTableBody');
                tableBody.innerHTML = '';
                
                // Group data by branch
                const branchGroups = {};
                Object.values(reportData).forEach(item => {
                    if (!branchGroups[item.branch]) {
                        branchGroups[item.branch] = [];
                    }
                    branchGroups[item.branch].push(item);
                });
                
                // Determine if we should show branch grouping (when BOTH all branches AND all categories are selected)
                const shouldGroupByBranch = (branchId === '' && categoryId === '');
                
                // Hide external header since we're showing branch names inside the table
                const branchNameHeader = document.getElementById('salesReportBranchNameHeader');
                if (branchNameHeader) {
                    branchNameHeader.style.display = 'none';
                }
                
                // Display grouped by branch
                const isMultipleBranches = Object.keys(branchGroups).length > 1;
                Object.keys(branchGroups).forEach(branchName => {
                    const branchItems = branchGroups[branchName];
                    
                    // Calculate branch totals
                    let branchTotalSales = 0, branchTotalCost = 0, branchTotalProfit = 0;
                    branchItems.forEach(item => {
                        branchTotalSales += item.totalSales;
                        branchTotalCost += item.totalCost;
                        branchTotalProfit += (item.totalSales - item.totalCost);
                    });
                    const branchProfitMargin = branchTotalSales > 0 ? (branchTotalProfit / branchTotalSales * 100) : 0;
                    
                    // ALWAYS show branch name and headers (for BOTH single and multiple branches) - Dark teal
                    const branchNameRow = document.createElement('tr');
                    branchNameRow.className = 'branch-name-row';
                    branchNameRow.innerHTML = `
                        <td colspan="5" style="text-align: center; padding: 10px; background-color: #00685c; color: white; border-bottom: 5px solid white;">
                            <h5 style="font-size: 1.8rem; color: white; font-weight: 700; margin: 0;"> ${branchName}</h5>
                        </td>
                    `;
                    tableBody.appendChild(branchNameRow);
                    
                    // Add table headers for this branch - Full black with white vertical borders
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'branch-header-row';
                    headerRow.innerHTML = `
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-left: 1px solid #333; border-top: 1px solid #333; border-bottom: 1px solid #333;">Category</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Total Sales</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Total Cost</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Total Profit</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: center; border-top: 1px solid #333; border-bottom: 1px solid #333;">Profit Margin</th>
                    `;
                    tableBody.appendChild(headerRow);
                    
                    // Add category rows for this branch
                    branchItems.forEach(item => {
                        const profit = item.totalSales - item.totalCost;
                        const margin = item.totalSales > 0 ? (profit / item.totalSales * 100) : 0;
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 10px;">${item.category}</td>
                            <td style="text-align: right; padding: 10px;" title="Total sales made in this category">${item.totalSales.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;" title="Total cost incurred for this category">${item.totalCost.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;" class="${profit >= 0 ? 'text-success' : 'text-danger'}" title="Profit earned (or loss if negative)">${profit.toLocaleString()}</td>
                            <td style="text-align: center; padding: 10px;"><span class="badge ${margin >= 0 ? 'bg-success' : 'bg-danger'}" title="Percentage margin based on sales vs cost">${margin.toFixed(1)}%</span></td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Add branch total row (when grouping by branch)
                    if (shouldGroupByBranch) {
                        const branchTotalRow = document.createElement('tr');
                        branchTotalRow.className = 'branch-total-row';
                        branchTotalRow.innerHTML = `
                            <td style="background-color: #f8f9fa; font-weight: 700; padding: 12px 15px;">
                                <i class="fas fa-calculator me-2"></i>Branch Total:
                            </td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalSales.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalCost.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;" class="${branchTotalProfit >= 0 ? 'text-success' : 'text-danger'}">${branchTotalProfit.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; text-align: center; padding: 12px 15px;"><span class="badge ${branchProfitMargin >= 0 ? 'bg-success' : 'bg-danger'}">${branchProfitMargin.toFixed(1)}%</span></td>
                        `;
                        tableBody.appendChild(branchTotalRow);
                        
                        // Add spacing row
                        const spacingRow = document.createElement('tr');
                        spacingRow.innerHTML = '<td colspan="5" style="height: 20px; border: none;"></td>';
                        tableBody.appendChild(spacingRow);
                    }
                });
            }).catch(error => {
                console.error('Error generating sales report:', error);
                showNotification('Failed to generate report', 'error');
            });
        }
        
        // Generate Payment Report (Tab 4)
        function generatePaymentReport() {
            const dateFrom = document.getElementById('paymentReportFromDateFilter').value;
            const dateTo = document.getElementById('paymentReportToDateFilter').value;
            const branchId = document.getElementById('paymentReportBranchFilter').value;
            const categoryId = document.getElementById('paymentReportCategoryFilter').value;
            
            // Require at least one date to be selected
            if (!dateFrom && !dateTo) {
                showNotification('Please select at least one date (From or To) to generate the report', 'error');
                return;
            }
            
            // Update subtitle based on filters
            const subtitle = document.getElementById('paymentReportSubtitle');
            let subtitleText = '';
            if (branchId) {
                const branch = appData.branches.find(b => b._id === branchId);
                if (branch) subtitleText += ` ${branch.name}`;
            }
            if (categoryId) {
                const category = appData.categories.find(c => c._id === categoryId);
                if (category) subtitleText += (subtitleText ? ' | ' : '') + ` ${category.name}`;
            }
            if (subtitleText) {
                subtitle.style.display = 'block';
                subtitle.textContent = subtitleText;
            } else {
                subtitle.style.display = 'none';
            }
            
            const salesFilters = {};
            if (dateFrom) salesFilters.from = dateFrom;
            if (dateTo) salesFilters.to = dateTo;
            if (branchId) salesFilters.branchId = branchId;
            
            const paymentFilters = {};
            if (dateFrom) paymentFilters.from = dateFrom;
            if (dateTo) paymentFilters.to = dateTo;
            if (branchId) paymentFilters.branchId = branchId;
            if (categoryId) paymentFilters.categoryId = categoryId;
            
            // Fetch sales and category payments from database in parallel
            console.log(' Fetching payment report data from database...');
            console.log(' Sales filters:', salesFilters);
            console.log(' Payment filters:', paymentFilters);
            
            Promise.all([
                api.getSales(salesFilters),
                api.getCategoryPayments(paymentFilters)
            ]).then(([salesData, paymentsData]) => {
                console.log(' Sales data loaded from database:', salesData.length, 'records');
                console.log(' Category payments data loaded from database:', paymentsData.length, 'records');
                
                // Ensure we have arrays
                const salesArray = Array.isArray(salesData) ? salesData : [];
                const paymentsArray = Array.isArray(paymentsData) ? paymentsData : [];
                
                // Filter sales by category if specified
                let filteredSales = salesArray;
                if (categoryId) {
                    filteredSales = salesArray.filter(sale => {
                        const saleCategoryId = sale.categoryId?._id || sale.categoryId;
                        return saleCategoryId === categoryId;
                    });
                }
                
                console.log(' Filtered sales:', filteredSales.length, 'records');
                
                // Calculate totals by branch and category
                const reportData = {};
                
                // Process sales data from database
                filteredSales.forEach(sale => {
                    // Handle populated or unpopulated branch/category references
                    const saleBranchId = sale.branchId?._id || sale.branchId;
                    const saleCategoryId = sale.categoryId?._id || sale.categoryId;
                    const saleBranchName = sale.branchId?.name || appData.branches.find(b => b._id === saleBranchId || b._id.toString() === saleBranchId?.toString())?.name || 'Unknown';
                    const saleCategoryName = sale.categoryId?.name || appData.categories.find(c => c._id === saleCategoryId || c._id.toString() === saleCategoryId?.toString())?.name || 'Unknown';
                    
                    const key = `${saleBranchId}-${saleCategoryId}`;
                    if (!reportData[key]) {
                        reportData[key] = {
                            branch: saleBranchName,
                            category: saleCategoryName,
                            totalSales: 0,
                            totalCost: 0,
                            categoryPayments: 0,
                            balancePayment: 0
                        };
                    }
                    // Sum sales (total) and cost (costTotal) from database
                    reportData[key].totalSales += parseFloat(sale.total || 0);
                    reportData[key].totalCost += parseFloat(sale.costTotal || 0);
                });
                
                // Process category payments data from database
                paymentsArray.forEach(payment => {
                    // Handle populated or unpopulated references
                    const branchId = payment.branchId?._id || payment.branchId;
                    const categoryId = payment.categoryId?._id || payment.categoryId;
                    const branchName = payment.branchId?.name || appData.branches.find(b => {
                        const bId = b._id?.toString() || b._id;
                        const pId = branchId?.toString() || branchId;
                        return bId === pId;
                    })?.name || 'Unknown';
                    const categoryName = payment.categoryId?.name || appData.categories.find(c => {
                        const cId = c._id?.toString() || c._id;
                        const pId = categoryId?.toString() || categoryId;
                        return cId === pId;
                    })?.name || 'Unknown';
                    
                    const key = `${branchId}-${categoryId}`;
                    if (!reportData[key]) {
                        // If no sales for this branch-category combo, still show payments
                        reportData[key] = {
                            branch: branchName,
                            category: categoryName,
                            totalSales: 0,
                            totalCost: 0,
                            categoryPayments: 0,
                            balancePayment: 0
                        };
                    }
                    // Sum category payments (amount) from database
                    reportData[key].categoryPayments += parseFloat(payment.amount || 0);
                });
                
                console.log(' Report data aggregated:', Object.keys(reportData).length, 'entries');
                
                // Calculate balance payment (Cost - Payment) for each entry
                Object.values(reportData).forEach(item => {
                    item.balancePayment = item.totalCost - item.categoryPayments;
                });
                
                // Calculate summary totals
                let summaryTotalSales = 0, summaryTotalCost = 0, summaryCategoryPayments = 0, summaryBalancePayment = 0;
                Object.values(reportData).forEach(item => {
                    summaryTotalSales += item.totalSales;
                    summaryTotalCost += item.totalCost;
                    summaryCategoryPayments += item.categoryPayments;
                    summaryBalancePayment += item.balancePayment;
                });
                
                // Update summary cards
                document.getElementById('paymentSummaryTotalSales').textContent = `${summaryTotalSales.toLocaleString()}`;
                document.getElementById('paymentSummaryTotalCost').textContent = `${summaryTotalCost.toLocaleString()}`;
                document.getElementById('paymentSummaryCategoryPayments').textContent = `${summaryCategoryPayments.toLocaleString()}`;
                document.getElementById('paymentSummaryBalancePayment').textContent = `${summaryBalancePayment.toLocaleString()}`;
                
                // Update table - Group by category when all categories selected, by branch otherwise
                const tableBody = document.getElementById('paymentReportTableBody');
                tableBody.innerHTML = '';
                
                // Determine grouping: if categoryId is empty (all categories), group by category; otherwise group by branch
                const shouldGroupByCategory = (categoryId === '');
                
                // Hide external header since we're showing group names inside the table
                const branchNameHeader = document.getElementById('paymentReportBranchNameHeader');
                if (branchNameHeader) {
                    branchNameHeader.style.display = 'none';
                }
                
                if (shouldGroupByCategory) {
                    // Group by Category when all categories are selected
                    const categoryGroups = {};
                    Object.values(reportData).forEach(item => {
                        if (!categoryGroups[item.category]) {
                            categoryGroups[item.category] = [];
                        }
                        categoryGroups[item.category].push(item);
                    });
                    
                    // Display grouped by category
                    Object.keys(categoryGroups).forEach(categoryName => {
                        const categoryItems = categoryGroups[categoryName];
                        
                        // Calculate category totals
                        let categoryTotalSales = 0, categoryTotalCost = 0, categoryTotalPayments = 0, categoryTotalBalance = 0;
                        categoryItems.forEach(item => {
                            categoryTotalSales += item.totalSales;
                            categoryTotalCost += item.totalCost;
                            categoryTotalPayments += item.categoryPayments;
                            categoryTotalBalance += item.balancePayment;
                        });
                        
                        // Show category name header - Dark teal
                        const categoryNameRow = document.createElement('tr');
                        categoryNameRow.className = 'category-name-row';
                        categoryNameRow.innerHTML = `
                            <td colspan="6" style="text-align: center; padding: 10px; background-color: #00685c; color: white; border-bottom: 5px solid white;">
                                <h5 style="font-size: 1.8rem; color: white; font-weight: 700; margin: 0;"> ${categoryName}</h5>
                            </td>
                        `;
                        tableBody.appendChild(categoryNameRow);
                        
                        // Add table headers for this category - Full black with white vertical borders
                        const headerRow = document.createElement('tr');
                        headerRow.className = 'category-header-row';
                        headerRow.innerHTML = `
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-left: 1px solid #333; border-top: 1px solid #333; border-bottom: 1px solid #333;">Category Name</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Branch</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Sale</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Cost</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Category Payments</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-top: 1px solid #333; border-bottom: 1px solid #333;">Balance Payment</th>
                        `;
                        tableBody.appendChild(headerRow);
                        
                        // Add branch rows for this category
                        categoryItems.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td style="padding: 10px;">${item.category}</td>
                                <td style="padding: 10px;">${item.branch}</td>
                                <td style="text-align: right; padding: 10px;">${item.totalSales.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${item.totalCost.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${item.categoryPayments.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;" class="${item.balancePayment >= 0 ? 'text-success' : 'text-danger'}">${item.balancePayment.toLocaleString()}</td>
                            `;
                            tableBody.appendChild(row);
                        });
                        
                        // Add category total row
                        const categoryTotalRow = document.createElement('tr');
                        categoryTotalRow.className = 'category-total-row';
                        categoryTotalRow.innerHTML = `
                            <td colspan="2" style="background-color: #f8f9fa; font-weight: 700; padding: 12px 15px;">
                                <i class="fas fa-calculator me-2"></i>Category Total:
                            </td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${categoryTotalSales.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${categoryTotalCost.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${categoryTotalPayments.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;" class="${categoryTotalBalance >= 0 ? 'text-success' : 'text-danger'}">${categoryTotalBalance.toLocaleString()}</td>
                        `;
                        tableBody.appendChild(categoryTotalRow);
                        
                        // Add spacing row
                        const spacingRow = document.createElement('tr');
                        spacingRow.innerHTML = '<td colspan="6" style="height: 20px; border: none;"></td>';
                        tableBody.appendChild(spacingRow);
                    });
                } else {
                    // When a single category is selected, show all branches in ONE table (not separate branch tables)
                    const categoryItems = Object.values(reportData);
                    
                    // Get category name from first item (all items have same category when single category selected)
                    const categoryName = categoryItems.length > 0 ? categoryItems[0].category : '';
                    
                    // Calculate category totals
                    let categoryTotalSales = 0, categoryTotalCost = 0, categoryTotalPayments = 0, categoryTotalBalance = 0;
                    categoryItems.forEach(item => {
                        categoryTotalSales += item.totalSales;
                        categoryTotalCost += item.totalCost;
                        categoryTotalPayments += item.categoryPayments;
                        categoryTotalBalance += item.balancePayment;
                    });
                    
                    // Show category name header - Dark teal (only once)
                    const categoryNameRow = document.createElement('tr');
                    categoryNameRow.className = 'category-name-row';
                    categoryNameRow.innerHTML = `
                        <td colspan="6" style="text-align: center; padding: 10px; background-color: #00685c; color: white; border-bottom: 5px solid white;">
                            <h5 style="font-size: 1.8rem; color: white; font-weight: 700; margin: 0;"> ${categoryName}</h5>
                        </td>
                    `;
                    tableBody.appendChild(categoryNameRow);
                    
                    // Add table headers - Full black with white vertical borders (only once)
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'category-header-row';
                    headerRow.innerHTML = `
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-left: 1px solid #333; border-top: 1px solid #333; border-bottom: 1px solid #333;">Category Name</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Branch</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Sale</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Cost</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Category Payments</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-top: 1px solid #333; border-bottom: 1px solid #333;">Balance Payment</th>
                    `;
                    tableBody.appendChild(headerRow);
                    
                    // Add all branch rows in one table (sorted by branch name)
                    categoryItems.sort((a, b) => a.branch.localeCompare(b.branch)).forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 10px;">${item.category}</td>
                            <td style="padding: 10px;">${item.branch}</td>
                            <td style="text-align: right; padding: 10px;">${item.totalSales.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${item.totalCost.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${item.categoryPayments.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;" class="${item.balancePayment >= 0 ? 'text-success' : 'text-danger'}">${item.balancePayment.toLocaleString()}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Add category total row (only one total row at the end)
                    const categoryTotalRow = document.createElement('tr');
                    categoryTotalRow.className = 'category-total-row';
                    categoryTotalRow.innerHTML = `
                        <td colspan="2" style="background-color: #f8f9fa; font-weight: 700; padding: 12px 15px;">
                            <i class="fas fa-calculator me-2"></i>Category Total:
                        </td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${categoryTotalSales.toLocaleString()}</td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${categoryTotalCost.toLocaleString()}</td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${categoryTotalPayments.toLocaleString()}</td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;" class="${categoryTotalBalance >= 0 ? 'text-success' : 'text-danger'}">${categoryTotalBalance.toLocaleString()}</td>
                    `;
                    tableBody.appendChild(categoryTotalRow);
                }
            }).catch(error => {
                console.error('Error generating payment report:', error);
                showNotification('Failed to generate report', 'error');
            });
        }
        
        // Generate Comparison Report (Tab 2)
        function generateComparisonReport() {
            console.log(' generateComparisonReport called');
            
            const dateFrom = document.getElementById('comparisonReportDateFrom')?.value || '';
            const dateTo = document.getElementById('comparisonReportDateTo')?.value || '';
            const branchId = document.getElementById('comparisonReportBranch')?.value || '';
            const categoryId = document.getElementById('comparisonReportCategory')?.value || '';
            
            console.log(' Comparison Report Filters:', { dateFrom, dateTo, branchId, categoryId });
            
            // Require at least one date to be selected
            if (!dateFrom && !dateTo) {
                showNotification('Please select at least one date (From or To) to generate the report', 'error');
                return;
            }
            
            // Update subtitle based on filters
            const subtitle = document.getElementById('comparisonReportSubtitle');
            let subtitleText = '';
            if (branchId) {
                const branch = appData.branches.find(b => b._id === branchId);
                if (branch) subtitleText += ` ${branch.name}`;
            }
            if (categoryId) {
                const category = appData.categories.find(c => c._id === categoryId);
                if (category) subtitleText += (subtitleText ? ' | ' : '') + ` ${category.name}`;
            }
            if (subtitleText) {
                subtitle.style.display = 'block';
                subtitle.textContent = subtitleText;
            } else {
                subtitle.style.display = 'none';
            }
            
            const filters = {};
            if (dateFrom) filters.from = dateFrom;
            if (dateTo) filters.to = dateTo;
            if (branchId) filters.branchId = branchId;
            
            api.getSales(filters).then(filteredData => {
                let data = filteredData;
                if (categoryId) {
                    data = filteredData.filter(sale => sale.categoryId._id === categoryId);
                }
                
                // Calculate by branch and category
                const reportData = {};
                data.forEach(sale => {
                    const key = `${sale.branchId._id}-${sale.categoryId._id}`;
                    if (!reportData[key]) {
                        reportData[key] = {
                            branch: sale.branchId.name,
                            category: sale.categoryId.name,
                            totalSales: 0,
                            totalCost: 0
                        };
                    }
                    reportData[key].totalSales += sale.total || 0;
                    reportData[key].totalCost += sale.costTotal || 0;
                });
                
                // Calculate profits and sort
                const rankedData = Object.values(reportData).map(item => ({
                    ...item,
                    totalProfit: item.totalSales - item.totalCost,
                    profitMargin: item.totalSales > 0 ? ((item.totalSales - item.totalCost) / item.totalSales * 100) : 0
                })).sort((a, b) => b.totalSales - a.totalSales);
                
                // Group data by CATEGORY for better comparison (compare branches within each category)
                const categoryGroups = {};
                rankedData.forEach(item => {
                    if (!categoryGroups[item.category]) {
                        categoryGroups[item.category] = [];
                    }
                    categoryGroups[item.category].push(item);
                });
                
                // Update table
                const tableBody = document.getElementById('comparisonReportTableBody');
                const tableHead = document.querySelector('#comparisonReportTableBody').closest('table').querySelector('thead');
                tableBody.innerHTML = '';
                
                let rankCounter = 1;
                
                // Determine if we should show category grouping (when BOTH all branches AND all categories are selected)
                const shouldGroupByCategory = (branchId === '' && categoryId === '');
                
                // Hide main table header when grouping by category (since we add headers for each category)
                if (shouldGroupByCategory) {
                    tableHead.style.display = 'none';
                } else {
                    tableHead.style.display = '';
                }
                
                // Display grouped by category
                Object.keys(categoryGroups).forEach(categoryName => {
                    const categoryItems = categoryGroups[categoryName];
                    
                    // Sort items within category by sales (highest first)
                    categoryItems.sort((a, b) => b.totalSales - a.totalSales);
                    
                    // Reset rank counter for each category
                    let categoryRank = 1;
                    
                    // Calculate category totals
                    let categoryTotalSales = 0, categoryTotalCost = 0, categoryTotalProfit = 0;
                    categoryItems.forEach(item => {
                        categoryTotalSales += item.totalSales;
                        categoryTotalCost += item.totalCost;
                        categoryTotalProfit += item.totalProfit;
                    });
                    const categoryProfitMargin = categoryTotalSales > 0 ? (categoryTotalProfit / categoryTotalSales * 100) : 0;
                    
                    // Add category header row with column headers
                    if (shouldGroupByCategory) {
                        // Add category name as a prominent header with column headers below
                        const categoryHeaderRow = document.createElement('tr');
                        categoryHeaderRow.className = 'category-header-row';
                        categoryHeaderRow.innerHTML = `
                            <td colspan="7" style="background-color: #00685c; color: white; font-weight: 700; font-size: 1.3rem; padding: 10px; text-align: center; border-bottom: 5px solid white;">
                                <i class="fas fa-tags me-2"></i>${categoryName}
                            </td>
                        `;
                        tableBody.appendChild(categoryHeaderRow);
                        
                        // Add column headers row for this category - Full black with white borders
                        const columnHeadersRow = document.createElement('tr');
                        columnHeadersRow.className = 'column-headers-row';
                        columnHeadersRow.innerHTML = `
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-left: 1px solid #333; border-top: 1px solid #333; border-bottom: 1px solid #333;">Rank</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Category</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Branch</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Total Sales</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Total Cost</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Total Profit</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-top: 1px solid #333; border-bottom: 1px solid #333;">Profit Margin</th>
                        `;
                        tableBody.appendChild(columnHeadersRow);
                    }
                    
                    // Add branch rows for this category
                    categoryItems.forEach(item => {
                        const row = document.createElement('tr');
                        const rank = shouldGroupByCategory ? categoryRank++ : rankCounter++;
                        row.innerHTML = `
                            <td>${rank}</td>
                            <td>${item.category}</td>
                            <td>${item.branch}</td>
                            <td>${item.totalSales.toLocaleString()}</td>
                            <td>${item.totalCost.toLocaleString()}</td>
                            <td class="${item.totalProfit >= 0 ? 'text-success' : 'text-danger'}">${item.totalProfit.toLocaleString()}</td>
                            <td><span class="badge ${item.profitMargin >= 0 ? 'bg-success' : 'bg-danger'}">${item.profitMargin.toFixed(1)}%</span></td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Add category total row (when grouping by category)
                    if (shouldGroupByCategory) {
                        const categoryTotalRow = document.createElement('tr');
                        categoryTotalRow.className = 'category-total-row';
                        categoryTotalRow.innerHTML = `
                            <td colspan="2" style="background-color: #f8f9fa; font-weight: 700; padding: 12px 15px; text-align: right;">
                                <i class="fas fa-calculator me-2"></i>Category Total:
                            </td>
                            <td style="background-color: #f8f9fa;"></td>
                            <td style="background-color: #f8f9fa; font-weight: 700;">${categoryTotalSales.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700;">${categoryTotalCost.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700;" class="${categoryTotalProfit >= 0 ? 'text-success' : 'text-danger'}">${categoryTotalProfit.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa;"><span class="badge ${categoryProfitMargin >= 0 ? 'bg-success' : 'bg-danger'}">${categoryProfitMargin.toFixed(1)}%</span></td>
                        `;
                        tableBody.appendChild(categoryTotalRow);
                        
                        // Add spacing row
                        const spacingRow = document.createElement('tr');
                        spacingRow.innerHTML = '<td colspan="7" style="height: 20px; border: none;"></td>';
                        tableBody.appendChild(spacingRow);
                    }
                });
            }).catch(error => {
                console.error('Error generating comparison report:', error);
                showNotification('Failed to generate report', 'error');
            });
        }
        
        // Generate Datewise Report (Tab 3)
        function generateDatewiseReport() {
            const dateFrom = document.getElementById('datewiseReportDateFrom').value;
            const dateTo = document.getElementById('datewiseReportDateTo').value;
            const branchId = document.getElementById('datewiseReportBranch').value;
            const categoryId = document.getElementById('datewiseReportCategory').value;
            const searchText = document.getElementById('datewiseSearch').value.toLowerCase();
            
            // Require at least one date to be selected
            if (!dateFrom && !dateTo) {
                showNotification('Please select at least one date (From or To) to generate the report', 'error');
                return;
            }
            
            const filters = {};
            if (dateFrom) filters.from = dateFrom;
            if (dateTo) filters.to = dateTo;
            if (branchId) filters.branchId = branchId;
            
            api.getSales(filters).then(filteredData => {
                let data = filteredData;
                
                // Apply category filter
                if (categoryId) {
                    data = filteredData.filter(sale => sale.categoryId._id === categoryId);
                }
                
                // Apply search filter
                if (searchText) {
                    data = data.filter(sale => {
                        // Format date for search (DD/MM/YYYY)
                        const formattedDate = sale.date ? new Date(sale.date).toLocaleDateString('en-GB') : '';
                        
                        // Format numeric values for search
                        const salesAmount = (sale.total || 0).toLocaleString();
                        const costAmount = (sale.costTotal || 0).toLocaleString();
                        const profitAmount = ((sale.total || 0) - (sale.costTotal || 0)).toLocaleString();
                        
                        return (
                            formattedDate.toLowerCase().includes(searchText) ||
                        sale.branchId.name.toLowerCase().includes(searchText) ||
                            sale.categoryId.name.toLowerCase().includes(searchText) ||
                            salesAmount.includes(searchText) ||
                            costAmount.includes(searchText) ||
                            profitAmount.includes(searchText)
                    );
                    });
                }
                
                // Group by branch
                const branchGroups = {};
                data.forEach(sale => {
                    const branchName = sale.branchId.name;
                    if (!branchGroups[branchName]) {
                        branchGroups[branchName] = [];
                    }
                    branchGroups[branchName].push({
                        date: sale.date ? new Date(sale.date).toLocaleDateString() : 'N/A',
                        branch: branchName,
                        category: sale.categoryId.name,
                        sales: sale.total || 0,
                        cost: sale.costTotal || 0,
                        profit: (sale.total || 0) - (sale.costTotal || 0)
                    });
                });
                
                // Update table
                const tableBody = document.getElementById('datewiseReportTableBody');
                tableBody.innerHTML = '';
                
                // Sort branches and data
                const sortedBranches = Object.keys(branchGroups).sort();
                sortedBranches.forEach(branchName => {
                    const branchItems = branchGroups[branchName];
                    
                    // Calculate branch totals
                    let branchTotalSales = 0, branchTotalCost = 0, branchTotalProfit = 0;
                    branchItems.forEach(item => {
                        branchTotalSales += item.sales;
                        branchTotalCost += item.cost;
                        branchTotalProfit += item.profit;
                    });
                    const branchProfitMargin = branchTotalSales > 0 ? (branchTotalProfit / branchTotalSales * 100) : 0;
                    
                    // Add branch header with dark teal background
                    const branchHeaderRow = document.createElement('tr');
                    branchHeaderRow.className = 'branch-header-row';
                    branchHeaderRow.innerHTML = `
                        <td colspan="6" style="background-color: #00685c; color: white; font-weight: 700; font-size: 1.3rem; padding: 10px; text-align: center; border-bottom: 5px solid white;">
                             ${branchName}
                        </td>
                    `;
                    tableBody.appendChild(branchHeaderRow);
                    
                    // Add column headers for this branch - Full black with white vertical borders
                    const columnHeadersRow = document.createElement('tr');
                    columnHeadersRow.className = 'column-headers-row';
                    columnHeadersRow.innerHTML = `
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-left: 1px solid #333; border-top: 1px solid #333; border-bottom: 1px solid #333;">Date</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Branch</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Category</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Sales Amount</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Cost</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-top: 1px solid #333; border-bottom: 1px solid #333;">Profit</th>
                    `;
                    tableBody.appendChild(columnHeadersRow);
                    
                    // Add data rows for this branch
                    branchItems.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 10px;">${item.date}</td>
                            <td style="padding: 10px;">${item.branch}</td>
                            <td style="padding: 10px;">${item.category}</td>
                            <td style="text-align: right; padding: 10px;">${item.sales.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${item.cost.toLocaleString()}</td>
                            <td class="${item.profit >= 0 ? 'text-success' : 'text-danger'}" style="text-align: right; padding: 10px;">${item.profit.toLocaleString()}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Add branch total row
                    const branchTotalRow = document.createElement('tr');
                    branchTotalRow.className = 'branch-total-row';
                    branchTotalRow.innerHTML = `
                        <td colspan="3" style="background-color: #f8f9fa; font-weight: 700; padding: 12px; text-align: right;">
                             Branch Total:
                        </td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px;">${branchTotalSales.toLocaleString()}</td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px;">${branchTotalCost.toLocaleString()}</td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px;" class="${branchTotalProfit >= 0 ? 'text-success' : 'text-danger'}">${branchTotalProfit.toLocaleString()}</td>
                    `;
                    tableBody.appendChild(branchTotalRow);
                    
                    // Add spacing row
                    const spacingRow = document.createElement('tr');
                    spacingRow.innerHTML = '<td colspan="6" style="height: 20px; border: none;"></td>';
                    tableBody.appendChild(spacingRow);
                });
            }).catch(error => {
                console.error('Error generating datewise report:', error);
                showNotification('Failed to generate report', 'error');
            });
        }
        
        // Load departments for shop report filter
        function loadDepartmentsForShopReport() {
            const branchId = document.getElementById('shopReportBranch')?.value || '';
            const departmentSelect = document.getElementById('shopReportDepartment');
            const subDeptSelect = document.getElementById('shopReportSubDepartment');
            
            if (!departmentSelect) return;
            
            if (!branchId || branchId === '') {
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                if (subDeptSelect) {
                    subDeptSelect.innerHTML = '<option value="">All Sub-Departments</option>';
                }
                return;
            }
            
            // Show loading state
            departmentSelect.innerHTML = '<option value="">Loading departments...</option>';
            departmentSelect.disabled = true;
            
            api.getDepartments(branchId).then(departments => {
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept._id;
                    option.textContent = dept.name;
                    departmentSelect.appendChild(option);
                });
                departmentSelect.disabled = false;
                
                // Reset sub-department dropdown
                if (subDeptSelect) {
                    subDeptSelect.innerHTML = '<option value="">All Sub-Departments</option>';
                }
            }).catch(error => {
                console.error('Error loading departments for shop report:', error);
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                departmentSelect.disabled = false;
                showNotification('Failed to load departments', 'error');
            });
        }
        
        // Load sub-departments for shop report filter
        function loadSubDepartmentsForShopReport() {
            const branchId = document.getElementById('shopReportBranch')?.value || '';
            const departmentId = document.getElementById('shopReportDepartment')?.value || '';
            const subDeptSelect = document.getElementById('shopReportSubDepartment');
            
            if (!subDeptSelect) return;
            
            if (!branchId || branchId === '' || !departmentId || departmentId === '') {
                subDeptSelect.innerHTML = '<option value="">All Sub-Departments</option>';
                return;
            }
            
            // Show loading state
            subDeptSelect.innerHTML = '<option value="">Loading sub-departments...</option>';
            subDeptSelect.disabled = true;
            
            api.getSubDepartmentsByDepartment(departmentId).then(subDepts => {
                subDeptSelect.innerHTML = '<option value="">All Sub-Departments</option>';
                subDepts.forEach(subDept => {
                    const option = document.createElement('option');
                    option.value = subDept._id;
                    option.textContent = subDept.name;
                    subDeptSelect.appendChild(option);
                });
                subDeptSelect.disabled = false;
            }).catch(error => {
                console.error('Error loading sub-departments for shop report:', error);
                subDeptSelect.innerHTML = '<option value="">All Sub-Departments</option>';
                subDeptSelect.disabled = false;
                showNotification('Failed to load sub-departments', 'error');
            });
        }
        
        // Load departments for department-wise report filter
        function loadDepartmentsForDeptWiseReport() {
            console.log(' loadDepartmentsForDeptWiseReport called');
            const branchId = document.getElementById('deptWiseReportBranch')?.value || '';
            const departmentSelect = document.getElementById('deptWiseReportDepartment');
            
            if (!departmentSelect) {
                console.error(' deptWiseReportDepartment select element not found');
                return;
            }
            
            console.log(' Department-wise report branch ID:', branchId);
            
            if (!branchId || branchId === '') {
                console.log(' No branch selected, clearing departments');
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                return;
            }
            
            // Show loading state
            departmentSelect.innerHTML = '<option value="">Loading departments...</option>';
            departmentSelect.disabled = true;
            
            if (typeof api === 'undefined' || typeof api.getDepartments !== 'function') {
                console.error(' api or api.getDepartments not available');
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                departmentSelect.disabled = false;
                showNotification('API not available. Please refresh the page.', 'error');
                return;
            }
            
            api.getDepartments(branchId).then(departments => {
                console.log(' Loaded departments for department-wise report:', departments.length);
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                if (departments && departments.length > 0) {
                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept._id;
                        option.textContent = dept.name;
                        departmentSelect.appendChild(option);
                    });
                } else {
                    console.warn(' No departments found for branch:', branchId);
                }
                departmentSelect.disabled = false;
            }).catch(error => {
                console.error(' Error loading departments for department-wise report:', error);
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                departmentSelect.disabled = false;
                showNotification('Failed to load departments: ' + (error.message || 'Unknown error'), 'error');
            });
        }
        
        // Load departments for sub-department-wise report filter
        function loadDepartmentsForSubDeptWiseReport() {
            console.log(' loadDepartmentsForSubDeptWiseReport called');
            const branchId = document.getElementById('subDeptWiseReportBranch')?.value || '';
            const departmentSelect = document.getElementById('subDeptWiseReportDepartment');
            const subDeptSelect = document.getElementById('subDeptWiseReportSubDepartment');
            
            if (!departmentSelect) {
                console.error(' subDeptWiseReportDepartment select element not found');
                return;
            }
            
            console.log(' Sub-department-wise report branch ID:', branchId);
            
            if (!branchId || branchId === '') {
                console.log(' No branch selected, clearing departments and sub-departments');
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                if (subDeptSelect) {
                    subDeptSelect.innerHTML = '<option value="">All Sub-Departments</option>';
                }
                return;
            }
            
            // Show loading state
            departmentSelect.innerHTML = '<option value="">Loading departments...</option>';
            departmentSelect.disabled = true;
            
            if (typeof api === 'undefined' || typeof api.getDepartments !== 'function') {
                console.error(' api or api.getDepartments not available');
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                departmentSelect.disabled = false;
                showNotification('API not available. Please refresh the page.', 'error');
                return;
            }
            
            api.getDepartments(branchId).then(departments => {
                console.log(' Loaded departments for sub-department-wise report:', departments.length);
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                if (departments && departments.length > 0) {
                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept._id;
                        option.textContent = dept.name;
                        departmentSelect.appendChild(option);
                    });
                } else {
                    console.warn(' No departments found for branch:', branchId);
                }
                departmentSelect.disabled = false;
                
                // Reset sub-department dropdown
                if (subDeptSelect) {
                    subDeptSelect.innerHTML = '<option value="">All Sub-Departments</option>';
                }
            }).catch(error => {
                console.error(' Error loading departments for sub-department-wise report:', error);
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                departmentSelect.disabled = false;
                showNotification('Failed to load departments: ' + (error.message || 'Unknown error'), 'error');
            });
        }
        
        // Load departments for department-wise comparison report filter
        function loadDepartmentsForDeptComparisonReport() {
            const branchId = document.getElementById('deptComparisonReportBranch')?.value || '';
            const departmentSelect = document.getElementById('deptComparisonReportDepartment');
            
            if (!departmentSelect) return;
            
            if (!branchId || branchId === '') {
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                return;
            }
            
            // Show loading state
            departmentSelect.innerHTML = '<option value="">Loading departments...</option>';
            departmentSelect.disabled = true;
            
            api.getDepartments(branchId).then(departments => {
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept._id;
                    option.textContent = dept.name;
                    departmentSelect.appendChild(option);
                });
                departmentSelect.disabled = false;
            }).catch(error => {
                console.error('Error loading departments for department comparison report:', error);
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                departmentSelect.disabled = false;
                showNotification('Failed to load departments', 'error');
            });
        }
        
        // Load all departments for branch-wise comparison report
        function loadAllDepartmentsForBranchComparison() {
            const departmentSelect = document.getElementById('branchComparisonReportDepartment');
            if (!departmentSelect) return;
            
            // If departments are already in appData, use them
            if (appData.departments && appData.departments.length > 0) {
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
                appData.departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept._id;
                    option.textContent = dept.name;
                    departmentSelect.appendChild(option);
                });
            } else {
                // Try to load from first branch if available
                if (appData.branches && appData.branches.length > 0) {
                    const firstBranchId = appData.branches[0]._id;
                    api.getDepartments(firstBranchId).then(departments => {
                        departmentSelect.innerHTML = '<option value="">All Departments</option>';
                        departments.forEach(dept => {
                            const option = document.createElement('option');
                            option.value = dept._id;
                            option.textContent = dept.name;
                            departmentSelect.appendChild(option);
                        });
                    }).catch(error => {
                        console.error('Error loading departments for branch comparison:', error);
                        departmentSelect.innerHTML = '<option value="">All Departments</option>';
                    });
                }
            }
        }
        
        // Load sub-departments for sub-department-wise report filter
        function loadSubDepartmentsForSubDeptWiseReport() {
            console.log(' loadSubDepartmentsForSubDeptWiseReport called');
            const branchId = document.getElementById('subDeptWiseReportBranch')?.value || '';
            const departmentId = document.getElementById('subDeptWiseReportDepartment')?.value || '';
            const subDeptSelect = document.getElementById('subDeptWiseReportSubDepartment');
            
            if (!subDeptSelect) {
                console.error(' subDeptWiseReportSubDepartment select element not found');
                return;
            }
            
            console.log(' Sub-department-wise report filters:', { branchId, departmentId });
            
            if (!branchId || branchId === '' || !departmentId || departmentId === '') {
                console.log(' Missing branch or department, clearing sub-departments');
                subDeptSelect.innerHTML = '<option value="">All Sub-Departments</option>';
                return;
            }
            
            // Show loading state
            subDeptSelect.innerHTML = '<option value="">Loading sub-departments...</option>';
            subDeptSelect.disabled = true;
            
            if (typeof api === 'undefined' || typeof api.getSubDepartmentsByDepartment !== 'function') {
                console.error(' api or api.getSubDepartmentsByDepartment not available');
                subDeptSelect.innerHTML = '<option value="">All Sub-Departments</option>';
                subDeptSelect.disabled = false;
                showNotification('API not available. Please refresh the page.', 'error');
                return;
            }
            
            api.getSubDepartmentsByDepartment(departmentId).then(subDepts => {
                console.log(' Loaded sub-departments for sub-department-wise report:', subDepts?.length || 0);
                subDeptSelect.innerHTML = '<option value="">All Sub-Departments</option>';
                if (subDepts && subDepts.length > 0) {
                    subDepts.forEach(subDept => {
                        const option = document.createElement('option');
                        option.value = subDept._id;
                        option.textContent = subDept.name;
                        subDeptSelect.appendChild(option);
                    });
                } else {
                    console.warn(' No sub-departments found for department:', departmentId);
                }
                subDeptSelect.disabled = false;
            }).catch(error => {
                console.error(' Error loading sub-departments for sub-department-wise report:', error);
                subDeptSelect.innerHTML = '<option value="">All Sub-Departments</option>';
                subDeptSelect.disabled = false;
                showNotification('Failed to load sub-departments: ' + (error.message || 'Unknown error'), 'error');
            });
        }
        
        // Generate Shop Report
        function generateShopReport() {
            const dateFrom = document.getElementById('shopReportDateFrom').value;
            const dateTo = document.getElementById('shopReportDateTo').value;
            const branchId = document.getElementById('shopReportBranch').value;
            const departmentId = document.getElementById('shopReportDepartment').value;
            const subDepartmentId = document.getElementById('shopReportSubDepartment').value;
            
            // Require at least one date to be selected
            if (!dateFrom && !dateTo) {
                showNotification('Please select at least one date (From or To) to generate the report', 'error');
                return;
            }
            
            // Update branch name heading and subtitle based on filters
            const branchNameHeading = document.getElementById('shopReportBranchName');
            const subDeptBranchNameHeading = document.getElementById('shopSubDeptReportBranchName');
            const subtitle = document.getElementById('shopReportSubtitle');
            const subDeptSubtitle = document.getElementById('shopSubDeptReportSubtitle');
            
            // Set branch name as centered heading
            let branchNameText = '';
            if (branchId) {
                const branch = appData.branches.find(b => b._id === branchId);
                if (branch) {
                    branchNameText = branch.name;
                }
            }
            
            if (branchNameText) {
                branchNameHeading.style.display = 'block';
                branchNameHeading.textContent = branchNameText;
                subDeptBranchNameHeading.style.display = 'block';
                subDeptBranchNameHeading.textContent = branchNameText;
            } else {
                branchNameHeading.style.display = 'none';
                subDeptBranchNameHeading.style.display = 'none';
            }
            
            // Update subtitle for other filters
            let subtitleText = '';
            if (departmentId) {
                const dept = appData.departments?.find(d => d._id === departmentId);
                if (dept) subtitleText += ` ${dept.name}`;
            }
            if (subDepartmentId) {
                const subDept = appData.subDepartments?.find(sd => sd._id === subDepartmentId);
                if (subDept) subtitleText += (subtitleText ? ' | ' : '') + ` ${subDept.name}`;
            }
            if (subtitleText) {
                subtitle.style.display = 'block';
                subtitle.textContent = subtitleText;
                subDeptSubtitle.style.display = 'block';
                subDeptSubtitle.textContent = subtitleText;
            } else {
                subtitle.style.display = 'none';
                subDeptSubtitle.style.display = 'none';
            }
            
            const filters = {};
            if (dateFrom) filters.from = dateFrom;
            if (dateTo) filters.to = dateTo;
            if (branchId) filters.branchId = branchId;
            if (departmentId) filters.departmentId = departmentId;
            if (subDepartmentId) filters.subDepartmentId = subDepartmentId;
            
            api.getDepartmentSales(filters).then(data => {
                // Extract branch name from data if not already set from filter
                if (!branchNameText && data.length > 0) {
                    // Get unique branches from data
                    const uniqueBranches = new Set();
                    data.forEach(sale => {
                        if (sale.branchId) {
                            const branchId = sale.branchId._id || sale.branchId;
                            const branchName = sale.branchId?.name || null;
                            if (branchName) {
                                uniqueBranches.add(branchName);
                            }
                        }
                    });
                    
                    // If only one unique branch, use it
                    if (uniqueBranches.size === 1) {
                        branchNameText = Array.from(uniqueBranches)[0];
                        branchNameHeading.style.display = 'block';
                        branchNameHeading.textContent = branchNameText;
                        subDeptBranchNameHeading.style.display = 'block';
                        subDeptBranchNameHeading.textContent = branchNameText;
                    }
                }
                
                // Department-wise report - Group by branch  department  sub-department
                const branchReportData = {};
                const uniqueDates = new Set();
                
                data.forEach(sale => {
                    // Track unique dates for daily average calculation
                    if (sale.date) {
                        const saleDate = new Date(sale.date);
                        const dateString = saleDate.toISOString().split('T')[0];
                        uniqueDates.add(dateString);
                    }
                    
                    const branchId = sale.branchId?._id || sale.branchId;
                    const branchName = sale.branchId?.name || 'Unknown';
                    const deptId = sale.departmentId?._id || sale.departmentId;
                    const deptName = sale.departmentId?.name || 'Unknown';
                    const subDeptId = sale.subDepartmentId?._id || sale.subDepartmentId;
                    const subDeptName = sale.subDepartmentId?.name || 'No Sub-Department';
                    
                    // Initialize branch if not exists
                    if (!branchReportData[branchId]) {
                        branchReportData[branchId] = {
                            branchName: branchName,
                            departments: {}
                        };
                    }
                    
                    // Initialize department if not exists
                    if (!branchReportData[branchId].departments[deptId]) {
                        branchReportData[branchId].departments[deptId] = {
                            department: deptName,
                            grossSale: 0,
                            discountAmount: 0,
                            returnAmount: 0,
                            gst: 0,
                            netSale: 0,
                            subDepartments: {}
                        };
                    }
                    
                    // Initialize sub-department if not exists
                    if (!branchReportData[branchId].departments[deptId].subDepartments[subDeptId]) {
                        branchReportData[branchId].departments[deptId].subDepartments[subDeptId] = {
                            subDepartment: subDeptName,
                            grossSale: 0,
                            discountAmount: 0,
                            returnAmount: 0,
                            gst: 0,
                            netSale: 0
                        };
                    }
                    
                    // Add sale data to sub-department
                    const subDept = branchReportData[branchId].departments[deptId].subDepartments[subDeptId];
                    subDept.grossSale += sale.grossSale || 0;
                    subDept.discountAmount += sale.discountAmount || 0;
                    subDept.returnAmount += sale.returnAmount || 0;
                    subDept.gst += sale.gst || 0;
                    subDept.netSale += sale.netSale || 0;
                    
                    // Also add to department totals
                    const dept = branchReportData[branchId].departments[deptId];
                    dept.grossSale += sale.grossSale || 0;
                    dept.discountAmount += sale.discountAmount || 0;
                    dept.returnAmount += sale.returnAmount || 0;
                    dept.gst += sale.gst || 0;
                    dept.netSale += sale.netSale || 0;
                });
                
                // Update department-wise table
                const deptTableBody = document.getElementById('shopReportTableBody');
                deptTableBody.innerHTML = '';
                
                const numberOfDays = uniqueDates.size > 0 ? uniqueDates.size : 1;
                
                // Calculate grand totals across all branches
                let grandTotalGrossSale = 0;
                let grandTotalDiscount = 0;
                let grandTotalReturn = 0;
                let grandTotalGST = 0;
                let grandTotalNetSale = 0;
                
                // Sort branches by name
                const sortedBranchIds = Object.keys(branchReportData).sort((a, b) => {
                    return branchReportData[a].branchName.localeCompare(branchReportData[b].branchName);
                });
                
                sortedBranchIds.forEach(branchId => {
                    const branchData = branchReportData[branchId];
                    
                    // Calculate branch totals
                    let branchTotalGrossSale = 0;
                    let branchTotalDiscount = 0;
                    let branchTotalReturn = 0;
                    let branchTotalGST = 0;
                    let branchTotalNetSale = 0;
                    
                    // Sort departments by name
                    const sortedDeptIds = Object.keys(branchData.departments).sort((a, b) => {
                        return branchData.departments[a].department.localeCompare(branchData.departments[b].department);
                    });
                    
                    // Branch name header row (Dark teal like warehouse report)
                    const branchNameRow = document.createElement('tr');
                    branchNameRow.className = 'branch-name-row';
                    branchNameRow.innerHTML = `
                        <td colspan="9" style="text-align: center; padding: 15px; background-color: #00685c; color: white; border-bottom: 5px solid white;">
                            <h5 style="font-size: 1.8rem; color: white; font-weight: 700; margin: 0;"> ${branchData.branchName}</h5>
                        </td>
                    `;
                    deptTableBody.appendChild(branchNameRow);
                    
                    // Table headers for this branch (Black with white borders)
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'branch-header-row';
                    headerRow.innerHTML = `
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-left: 1px solid #333; border-top: 1px solid #333; border-bottom: 1px solid #333;">Department / Sub-Department</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Gross Sale</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Discount Value</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Discount %</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Return</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Sale Value</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">GST</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Net Sale</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-top: 1px solid #333; border-bottom: 1px solid #333;">Daily Average</th>
                    `;
                    deptTableBody.appendChild(headerRow);
                    
                    sortedDeptIds.forEach(deptId => {
                        const dept = branchData.departments[deptId];
                        
                        // Add to branch totals
                        branchTotalGrossSale += dept.grossSale;
                        branchTotalDiscount += dept.discountAmount;
                        branchTotalReturn += dept.returnAmount;
                        branchTotalGST += dept.gst;
                        branchTotalNetSale += dept.netSale;
                        
                        // Sort sub-departments by name
                        const sortedSubDeptIds = Object.keys(dept.subDepartments).sort((a, b) => {
                            return dept.subDepartments[a].subDepartment.localeCompare(dept.subDepartments[b].subDepartment);
                        });
                        
                        // Department row (with sub-departments indented)
                        sortedSubDeptIds.forEach(subDeptId => {
                            const subDept = dept.subDepartments[subDeptId];
                            
                            const discountPercent = subDept.grossSale > 0 ? (subDept.discountAmount / subDept.grossSale * 100) : 0;
                            const saleValue = subDept.grossSale - subDept.discountAmount - subDept.returnAmount;
                            const dailyAverage = numberOfDays > 0 ? subDept.netSale / numberOfDays : 0;
                            
                            const subDeptRow = document.createElement('tr');
                            subDeptRow.innerHTML = `
                                <td style="padding: 10px; padding-left: 30px;">${subDept.subDepartment}</td>
                                <td style="text-align: right; padding: 10px;">${subDept.grossSale.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${subDept.discountAmount.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${discountPercent.toFixed(2)}%</td>
                                <td style="text-align: right; padding: 10px;">${subDept.returnAmount.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${saleValue.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${subDept.gst.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${subDept.netSale.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${Math.round(dailyAverage).toLocaleString()}</td>
                            `;
                            deptTableBody.appendChild(subDeptRow);
                        });
                        
                        // Department total row
                        const deptDiscountPercent = dept.grossSale > 0 ? (dept.discountAmount / dept.grossSale * 100) : 0;
                        const deptSaleValue = dept.grossSale - dept.discountAmount - dept.returnAmount;
                        const deptDailyAverage = numberOfDays > 0 ? dept.netSale / numberOfDays : 0;
                        
                        const deptTotalRow = document.createElement('tr');
                        deptTotalRow.className = 'department-total-row';
                        deptTotalRow.innerHTML = `
                            <td style="background-color: #e9ecef; font-weight: 700; padding: 12px 15px; padding-left: 15px;">
                                <i class="fas fa-folder me-2"></i>${dept.department} Total:
                            </td>
                            <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${dept.grossSale.toLocaleString()}</td>
                            <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${dept.discountAmount.toLocaleString()}</td>
                            <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${deptDiscountPercent.toFixed(2)}%</td>
                            <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${dept.returnAmount.toLocaleString()}</td>
                            <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${deptSaleValue.toLocaleString()}</td>
                            <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${dept.gst.toLocaleString()}</td>
                            <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${dept.netSale.toLocaleString()}</td>
                            <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${Math.round(deptDailyAverage).toLocaleString()}</td>
                        `;
                        deptTableBody.appendChild(deptTotalRow);
                    });
                    
                    // Branch total row
                    const branchDiscountPercent = branchTotalGrossSale > 0 ? (branchTotalDiscount / branchTotalGrossSale * 100) : 0;
                    const branchSaleValue = branchTotalGrossSale - branchTotalDiscount - branchTotalReturn;
                    const branchDailyAverage = numberOfDays > 0 ? branchTotalNetSale / numberOfDays : 0;
                    
                    const branchTotalRow = document.createElement('tr');
                    branchTotalRow.className = 'branch-total-row';
                    branchTotalRow.innerHTML = `
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; padding: 12px 15px;">
                            <i class="fas fa-calculator me-2"></i>Branch Total: ${branchData.branchName}
                        </td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalGrossSale.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalDiscount.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 12px 15px;">${branchDiscountPercent.toFixed(2)}%</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalReturn.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 12px 15px;">${branchSaleValue.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalGST.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalNetSale.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 12px 15px;">${Math.round(branchDailyAverage).toLocaleString()}</td>
                    `;
                    deptTableBody.appendChild(branchTotalRow);
                    
                    // Add spacing row between branches
                    const spacingRow = document.createElement('tr');
                    spacingRow.innerHTML = '<td colspan="9" style="height: 20px; border: none;"></td>';
                    deptTableBody.appendChild(spacingRow);
                    
                    // Add to grand totals
                    grandTotalGrossSale += branchTotalGrossSale;
                    grandTotalDiscount += branchTotalDiscount;
                    grandTotalReturn += branchTotalReturn;
                    grandTotalGST += branchTotalGST;
                    grandTotalNetSale += branchTotalNetSale;
                });
                
                // Grand total row at the end (hidden on mobile screens)
                const grandDiscountPercent = grandTotalGrossSale > 0 ? (grandTotalDiscount / grandTotalGrossSale * 100) : 0;
                const grandSaleValue = grandTotalGrossSale - grandTotalDiscount - grandTotalReturn;
                const grandDailyAverage = numberOfDays > 0 ? grandTotalNetSale / numberOfDays : 0;
                
                const grandTotalRow = document.createElement('tr');
                grandTotalRow.className = 'grand-total-row d-none d-md-table-row';
                grandTotalRow.innerHTML = `
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; padding: 15px; font-size: 1.1rem;">
                        <i class="fas fa-calculator me-2"></i>Grand Total (All Branches):
                    </td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalGrossSale.toLocaleString()}</td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalDiscount.toLocaleString()}</td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandDiscountPercent.toFixed(2)}%</td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalReturn.toLocaleString()}</td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandSaleValue.toLocaleString()}</td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalGST.toLocaleString()}</td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalNetSale.toLocaleString()}</td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${Math.round(grandDailyAverage).toLocaleString()}</td>
                `;
                deptTableBody.appendChild(grandTotalRow);
                
                // Sub-department-wise report
                const subDeptReportData = {};
                const subDeptUniqueDates = new Set();
                
                data.forEach(sale => {
                    if (!sale.subDepartmentId) return;
                    
                    // Track unique dates for daily average calculation
                    if (sale.date) {
                        const saleDate = new Date(sale.date);
                        const dateString = saleDate.toISOString().split('T')[0];
                        subDeptUniqueDates.add(dateString);
                    }
                    
                    const subDeptId = sale.subDepartmentId._id || sale.subDepartmentId;
                    const subDeptName = sale.subDepartmentId?.name || 'Unknown';
                    const deptName = sale.departmentId?.name || 'Unknown';
                    const branchName = sale.branchId?.name || 'Unknown';
                    const key = `${subDeptId}-${sale.branchId?._id || sale.branchId}`;
                    
                    if (!subDeptReportData[key]) {
                        subDeptReportData[key] = {
                            subDepartment: subDeptName,
                            department: deptName,
                            branch: branchName,
                            grossSale: 0,
                            discount: 0,
                            return: 0,
                            gst: 0,
                            netSale: 0
                        };
                    }
                    
                    subDeptReportData[key].grossSale += sale.grossSale || 0;
                    subDeptReportData[key].discount += sale.discount || 0;
                    subDeptReportData[key].return += sale.return || 0;
                    subDeptReportData[key].gst += sale.gst || 0;
                    subDeptReportData[key].netSale += sale.netSale || 0;
                });
                
                // Update sub-department-wise table
                const subDeptTableBody = document.getElementById('shopSubDeptReportTableBody');
                subDeptTableBody.innerHTML = '';
                
                const subDeptNumberOfDays = subDeptUniqueDates.size > 0 ? subDeptUniqueDates.size : 1;
                
                if (Object.keys(subDeptReportData).length === 0) {
                    subDeptTableBody.innerHTML = `
                        <tr>
                            <td colspan="10" class="text-center text-muted py-4">
                                <i class="fas fa-info-circle me-2"></i>
                                No sub-department data available for the selected filters
                            </td>
                        </tr>
                    `;
                } else {
                    const sortedSubDeptData = Object.values(subDeptReportData).sort((a, b) => {
                        if (a.branch !== b.branch) return a.branch.localeCompare(b.branch);
                        if (a.department !== b.department) return a.department.localeCompare(b.department);
                        return a.subDepartment.localeCompare(b.subDepartment);
                    });
                    
                    sortedSubDeptData.forEach(item => {
                        // Calculate values
                        // Sale Value = Gross Sale - Discount - Return
                        const saleValue = item.grossSale - item.discount - item.return;
                        const dailyAverage = subDeptNumberOfDays > 0 ? item.netSale / subDeptNumberOfDays : 0;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.subDepartment}</td>
                            <td>${item.department}</td>
                            <td>${item.branch}</td>
                            <td class="text-end">${item.grossSale.toLocaleString()}</td>
                            <td class="text-end">${item.discount.toLocaleString()}</td>
                            <td class="text-end">${item.return.toLocaleString()}</td>
                            <td class="text-end">${saleValue.toLocaleString()}</td>
                            <td class="text-end">${item.gst.toLocaleString()}</td>
                            <td class="text-end" style="font-weight: 700;">${item.netSale.toLocaleString()}</td>
                            <td class="text-end">${Math.round(dailyAverage).toLocaleString()}</td>
                        `;
                        subDeptTableBody.appendChild(row);
                    });
                }
            }).catch(error => {
                console.error('Error generating shop report:', error);
                showNotification('Failed to generate shop report', 'error');
            });
        }
        
        // Generate Department-Wise Report
        function generateDeptWiseReport() {
            const dateFrom = document.getElementById('deptWiseReportDateFrom').value;
            const dateTo = document.getElementById('deptWiseReportDateTo').value;
            const branchId = document.getElementById('deptWiseReportBranch').value;
            const departmentId = document.getElementById('deptWiseReportDepartment').value;
            
            // Require at least one date to be selected
            if (!dateFrom && !dateTo) {
                showNotification('Please select at least one date (From or To) to generate the report', 'error');
                return;
            }
            
            // Update branch name heading and subtitle based on filters
            const branchNameHeading = document.getElementById('deptWiseReportBranchName');
            const subtitle = document.getElementById('deptWiseReportSubtitle');
            
            // Set branch name as centered heading
            let branchNameText = '';
            if (branchId) {
                const branch = appData.branches.find(b => b._id === branchId);
                if (branch) {
                    branchNameText = branch.name;
                }
            }
            
            if (branchNameText) {
                branchNameHeading.style.display = 'block';
                branchNameHeading.textContent = branchNameText;
            } else {
                branchNameHeading.style.display = 'none';
            }
            
            // Update subtitle for other filters
            let subtitleText = '';
            if (departmentId) {
                const dept = appData.departments?.find(d => d._id === departmentId);
                if (dept) subtitleText += ` ${dept.name}`;
            }
            if (subtitleText) {
                subtitle.style.display = 'block';
                subtitle.textContent = subtitleText;
            } else {
                subtitle.style.display = 'none';
            }
            
            const filters = {};
            if (dateFrom) filters.from = dateFrom;
            if (dateTo) filters.to = dateTo;
            if (branchId) filters.branchId = branchId;
            if (departmentId) filters.departmentId = departmentId;
            
            api.getDepartmentSales(filters).then(data => {
                // Extract branch name from data if not already set from filter
                if (!branchNameText && data.length > 0) {
                    // Get unique branches from data
                    const uniqueBranches = new Set();
                    data.forEach(sale => {
                        if (sale.branchId) {
                            const branchName = sale.branchId?.name || null;
                            if (branchName) {
                                uniqueBranches.add(branchName);
                            }
                        }
                    });
                    
                    // If only one unique branch, use it
                    if (uniqueBranches.size === 1) {
                        branchNameText = Array.from(uniqueBranches)[0];
                        branchNameHeading.style.display = 'block';
                        branchNameHeading.textContent = branchNameText;
                    }
                }
                
                // Department-wise report - Group by branch  department  sub-department
                const branchReportData = {};
                const uniqueDates = new Set();
                
                data.forEach(sale => {
                    // Track unique dates for daily average calculation
                    if (sale.date) {
                        const saleDate = new Date(sale.date);
                        const dateString = saleDate.toISOString().split('T')[0];
                        uniqueDates.add(dateString);
                    }
                    
                    const branchId = sale.branchId?._id || sale.branchId;
                    const branchName = sale.branchId?.name || 'Unknown';
                    const deptId = sale.departmentId?._id || sale.departmentId;
                    const deptName = sale.departmentId?.name || 'Unknown';
                    const subDeptId = sale.subDepartmentId?._id || sale.subDepartmentId;
                    const subDeptName = sale.subDepartmentId?.name || 'No Sub-Department';
                    
                    // Initialize branch if not exists
                    if (!branchReportData[branchId]) {
                        branchReportData[branchId] = {
                            branchName: branchName,
                            departments: {}
                        };
                    }
                    
                    // Initialize department if not exists
                    if (!branchReportData[branchId].departments[deptId]) {
                        branchReportData[branchId].departments[deptId] = {
                            department: deptName,
                            grossSale: 0,
                            discountAmount: 0,
                            returnAmount: 0,
                            gst: 0,
                            netSale: 0,
                            subDepartments: {}
                        };
                    }
                    
                    // Initialize sub-department if not exists
                    if (!branchReportData[branchId].departments[deptId].subDepartments[subDeptId]) {
                        branchReportData[branchId].departments[deptId].subDepartments[subDeptId] = {
                            subDepartment: subDeptName,
                            grossSale: 0,
                            discountAmount: 0,
                            returnAmount: 0,
                            gst: 0,
                            netSale: 0
                        };
                    }
                    
                    // Add sale data to sub-department
                    const subDept = branchReportData[branchId].departments[deptId].subDepartments[subDeptId];
                    subDept.grossSale += sale.grossSale || 0;
                    subDept.discountAmount += sale.discountAmount || 0;
                    subDept.returnAmount += sale.returnAmount || 0;
                    subDept.gst += sale.gst || 0;
                    subDept.netSale += sale.netSale || 0;
                    
                    // Also add to department totals
                    const dept = branchReportData[branchId].departments[deptId];
                    dept.grossSale += sale.grossSale || 0;
                    dept.discountAmount += sale.discountAmount || 0;
                    dept.returnAmount += sale.returnAmount || 0;
                    dept.gst += sale.gst || 0;
                    dept.netSale += sale.netSale || 0;
                });
                
                // Update department-wise table
                const deptTableBody = document.getElementById('deptWiseReportTableBody');
                deptTableBody.innerHTML = '';
                
                const numberOfDays = uniqueDates.size > 0 ? uniqueDates.size : 1;
                
                // Calculate grand totals across all branches
                let grandTotalGrossSale = 0;
                let grandTotalDiscount = 0;
                let grandTotalReturn = 0;
                let grandTotalGST = 0;
                let grandTotalNetSale = 0;
                
                // Hide branch name heading since we show it in table
                if (branchNameHeading) {
                    branchNameHeading.style.display = 'none';
                }
                
                // Calculate branch totals first for sorting
                Object.keys(branchReportData).forEach(branchId => {
                    const branchData = branchReportData[branchId];
                    let branchTotalNetSale = 0;
                    
                    Object.keys(branchData.departments).forEach(deptId => {
                        const dept = branchData.departments[deptId];
                        branchTotalNetSale += dept.netSale || 0;
                    });
                    
                    // Store total net sale for sorting
                    branchReportData[branchId].totalNetSale = branchTotalNetSale;
                });
                
                // Sort branches by total net sale (descending - highest first)
                const sortedBranchIds = Object.keys(branchReportData).sort((a, b) => {
                    return branchReportData[b].totalNetSale - branchReportData[a].totalNetSale;
                });
                
                sortedBranchIds.forEach(branchId => {
                    const branchData = branchReportData[branchId];
                    
                    // Calculate branch totals
                    let branchTotalGrossSale = 0;
                    let branchTotalDiscount = 0;
                    let branchTotalReturn = 0;
                    let branchTotalGST = 0;
                    let branchTotalNetSale = 0;
                    
                    // Sort departments by name
                    const sortedDeptIds = Object.keys(branchData.departments).sort((a, b) => {
                        return branchData.departments[a].department.localeCompare(branchData.departments[b].department);
                    });
                    
                    // Branch name header row (Dark teal like warehouse report)
                    const branchNameRow = document.createElement('tr');
                    branchNameRow.className = 'branch-name-row';
                    branchNameRow.innerHTML = `
                        <td colspan="9" style="text-align: center; padding: 15px; background-color: #00685c; color: white; border-bottom: 5px solid white;">
                            <h5 style="font-size: 1.8rem; color: white; font-weight: 700; margin: 0;"> ${branchData.branchName}</h5>
                        </td>
                    `;
                    deptTableBody.appendChild(branchNameRow);
                    
                    // Table headers for this branch (Black with white borders)
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'branch-header-row';
                    headerRow.innerHTML = `
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-left: 1px solid #333; border-top: 1px solid #333; border-bottom: 1px solid #333;">Department</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Gross Sale</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Discount Value</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Discount %</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Return</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Sale Value</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">GST</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Net Sale</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-top: 1px solid #333; border-bottom: 1px solid #333;">Daily Average</th>
                    `;
                    deptTableBody.appendChild(headerRow);
                    
                    sortedDeptIds.forEach(deptId => {
                        const dept = branchData.departments[deptId];
                        
                        // Add to branch totals
                        branchTotalGrossSale += dept.grossSale;
                        branchTotalDiscount += dept.discountAmount;
                        branchTotalReturn += dept.returnAmount;
                        branchTotalGST += dept.gst;
                        branchTotalNetSale += dept.netSale;
                        
                        // Department row (show only department, no sub-departments)
                        const deptDiscountPercent = dept.grossSale > 0 ? (dept.discountAmount / dept.grossSale * 100) : 0;
                        const deptSaleValue = dept.grossSale - dept.discountAmount - dept.returnAmount;
                        const deptDailyAverage = numberOfDays > 0 ? dept.netSale / numberOfDays : 0;
                        
                        const deptRow = document.createElement('tr');
                        deptRow.innerHTML = `
                            <td style="padding: 10px; padding-left: 15px;">${dept.department}</td>
                            <td style="text-align: right; padding: 10px;">${dept.grossSale.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${dept.discountAmount.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${deptDiscountPercent.toFixed(2)}%</td>
                            <td style="text-align: right; padding: 10px;">${dept.returnAmount.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${deptSaleValue.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${dept.gst.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${dept.netSale.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${Math.round(deptDailyAverage).toLocaleString()}</td>
                        `;
                        deptTableBody.appendChild(deptRow);
                    });
                    
                    // Branch total row
                    const branchDiscountPercent = branchTotalGrossSale > 0 ? (branchTotalDiscount / branchTotalGrossSale * 100) : 0;
                    const branchSaleValue = branchTotalGrossSale - branchTotalDiscount - branchTotalReturn;
                    const branchDailyAverage = numberOfDays > 0 ? branchTotalNetSale / numberOfDays : 0;
                    
                    const branchTotalRow = document.createElement('tr');
                    branchTotalRow.className = 'branch-total-row';
                    branchTotalRow.innerHTML = `
                        <td style="background-color: #f8f9fa; font-weight: 700; padding: 12px 15px;">
                            <i class="fas fa-calculator me-2"></i>Branch Total: ${branchData.branchName}
                        </td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalGrossSale.toLocaleString()}</td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalDiscount.toLocaleString()}</td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchDiscountPercent.toFixed(2)}%</td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalReturn.toLocaleString()}</td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchSaleValue.toLocaleString()}</td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalGST.toLocaleString()}</td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalNetSale.toLocaleString()}</td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${Math.round(branchDailyAverage).toLocaleString()}</td>
                    `;
                    deptTableBody.appendChild(branchTotalRow);
                    
                    // Add spacing row between branches
                    const spacingRow = document.createElement('tr');
                    spacingRow.innerHTML = '<td colspan="9" style="height: 20px; border: none;"></td>';
                    deptTableBody.appendChild(spacingRow);
                    
                    // Add to grand totals
                    grandTotalGrossSale += branchTotalGrossSale;
                    grandTotalDiscount += branchTotalDiscount;
                    grandTotalReturn += branchTotalReturn;
                    grandTotalGST += branchTotalGST;
                    grandTotalNetSale += branchTotalNetSale;
                });
                
                // Grand total row at the end
                const grandDiscountPercent = grandTotalGrossSale > 0 ? (grandTotalDiscount / grandTotalGrossSale * 100) : 0;
                const grandSaleValue = grandTotalGrossSale - grandTotalDiscount - grandTotalReturn;
                const grandDailyAverage = numberOfDays > 0 ? grandTotalNetSale / numberOfDays : 0;
                
                const grandTotalRow = document.createElement('tr');
                grandTotalRow.className = 'grand-total-row';
                grandTotalRow.innerHTML = `
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; padding: 15px; font-size: 1.1rem;">
                        <i class="fas fa-calculator me-2"></i>Grand Total (All Branches):
                    </td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalGrossSale.toLocaleString()}</td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalDiscount.toLocaleString()}</td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandDiscountPercent.toFixed(2)}%</td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalReturn.toLocaleString()}</td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandSaleValue.toLocaleString()}</td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalGST.toLocaleString()}</td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalNetSale.toLocaleString()}</td>
                    <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${Math.round(grandDailyAverage).toLocaleString()}</td>
                `;
                deptTableBody.appendChild(grandTotalRow);
                
                // Update summary cards with grand totals
                document.getElementById('deptWiseSummaryGrossSale').textContent = grandTotalGrossSale.toLocaleString();
                document.getElementById('deptWiseSummaryTotalDiscount').textContent = grandTotalDiscount.toLocaleString();
                document.getElementById('deptWiseSummaryTotalReturn').textContent = grandTotalReturn.toLocaleString();
                document.getElementById('deptWiseSummaryTotalGST').textContent = grandTotalGST.toLocaleString();
                document.getElementById('deptWiseSummaryNetSale').textContent = grandTotalNetSale.toLocaleString();
            }).catch(error => {
                console.error('Error generating department-wise report:', error);
                showNotification('Failed to generate department-wise report', 'error');
            });
        }
        
        // Generate Sub-Department-Wise Report
        function generateSubDeptWiseReport() {
            const dateFrom = document.getElementById('subDeptWiseReportDateFrom').value;
            const dateTo = document.getElementById('subDeptWiseReportDateTo').value;
            const branchId = document.getElementById('subDeptWiseReportBranch').value;
            const departmentId = document.getElementById('subDeptWiseReportDepartment').value;
            const subDepartmentId = document.getElementById('subDeptWiseReportSubDepartment').value;
            
            // Require at least one date to be selected
            if (!dateFrom && !dateTo) {
                showNotification('Please select at least one date (From or To) to generate the report', 'error');
                return;
            }
            
            // Update branch name heading and subtitle based on filters
            const branchNameHeading = document.getElementById('subDeptWiseReportBranchName');
            const subtitle = document.getElementById('subDeptWiseReportSubtitle');
            
            // Set branch name as centered heading
            let branchNameText = '';
            if (branchId) {
                const branch = appData.branches.find(b => b._id === branchId);
                if (branch) {
                    branchNameText = branch.name;
                }
            }
            
            if (branchNameText) {
                branchNameHeading.style.display = 'block';
                branchNameHeading.textContent = branchNameText;
            } else {
                branchNameHeading.style.display = 'none';
            }
            
            // Update subtitle for other filters
            let subtitleText = '';
            if (departmentId) {
                const dept = appData.departments?.find(d => d._id === departmentId);
                if (dept) subtitleText += ` ${dept.name}`;
            }
            if (subDepartmentId) {
                const subDept = appData.subDepartments?.find(sd => sd._id === subDepartmentId);
                if (subDept) subtitleText += (subtitleText ? ' | ' : '') + ` ${subDept.name}`;
            }
            if (subtitleText) {
                subtitle.style.display = 'block';
                subtitle.textContent = subtitleText;
            } else {
                subtitle.style.display = 'none';
            }
            
            const filters = {};
            if (dateFrom) filters.from = dateFrom;
            if (dateTo) filters.to = dateTo;
            if (branchId) filters.branchId = branchId;
            if (departmentId) filters.departmentId = departmentId;
            if (subDepartmentId) filters.subDepartmentId = subDepartmentId;
            
            api.getDepartmentSales(filters).then(data => {
                // Extract branch name from data if not already set from filter
                if (!branchNameText && data.length > 0) {
                    // Get unique branches from data
                    const uniqueBranches = new Set();
                    data.forEach(sale => {
                        if (sale.branchId) {
                            const branchName = sale.branchId?.name || null;
                            if (branchName) {
                                uniqueBranches.add(branchName);
                            }
                        }
                    });
                    
                    // If only one unique branch, use it
                    if (uniqueBranches.size === 1) {
                        branchNameText = Array.from(uniqueBranches)[0];
                        branchNameHeading.style.display = 'block';
                        branchNameHeading.textContent = branchNameText;
                    }
                }
                
                // Summary totals will be calculated and updated after grouping
                
                // Sub-department-wise report - Group by branch  department  sub-department
                const branchSubDeptReportData = {};
                const subDeptUniqueDates = new Set();
                
                data.forEach(sale => {
                    if (!sale.subDepartmentId) return;
                    
                    // Track unique dates for daily average calculation
                    if (sale.date) {
                        const saleDate = new Date(sale.date);
                        const dateString = saleDate.toISOString().split('T')[0];
                        subDeptUniqueDates.add(dateString);
                    }
                    
                    const branchId = sale.branchId?._id || sale.branchId;
                    const branchName = sale.branchId?.name || 'Unknown';
                    const deptId = sale.departmentId?._id || sale.departmentId;
                    const deptName = sale.departmentId?.name || 'Unknown';
                    const subDeptId = sale.subDepartmentId._id || sale.subDepartmentId;
                    const subDeptName = sale.subDepartmentId?.name || 'Unknown';
                    
                    // Initialize branch if not exists
                    if (!branchSubDeptReportData[branchId]) {
                        branchSubDeptReportData[branchId] = {
                            branchName: branchName,
                            departments: {}
                        };
                    }
                    
                    // Initialize department if not exists
                    if (!branchSubDeptReportData[branchId].departments[deptId]) {
                        branchSubDeptReportData[branchId].departments[deptId] = {
                            department: deptName,
                            grossSale: 0,
                            discountAmount: 0,
                            returnAmount: 0,
                            gst: 0,
                            netSale: 0,
                            subDepartments: {}
                        };
                    }
                    
                    // Initialize sub-department if not exists
                    if (!branchSubDeptReportData[branchId].departments[deptId].subDepartments[subDeptId]) {
                        branchSubDeptReportData[branchId].departments[deptId].subDepartments[subDeptId] = {
                            subDepartment: subDeptName,
                            grossSale: 0,
                            discountAmount: 0,
                            returnAmount: 0,
                            gst: 0,
                            netSale: 0
                        };
                    }
                    
                    // Add sale data to sub-department
                    const subDept = branchSubDeptReportData[branchId].departments[deptId].subDepartments[subDeptId];
                    subDept.grossSale += sale.grossSale || 0;
                    subDept.discountAmount += sale.discountAmount || 0;
                    subDept.returnAmount += sale.returnAmount || 0;
                    subDept.gst += sale.gst || 0;
                    subDept.netSale += sale.netSale || 0;
                    
                    // Also add to department totals
                    const dept = branchSubDeptReportData[branchId].departments[deptId];
                    dept.grossSale += sale.grossSale || 0;
                    dept.discountAmount += sale.discountAmount || 0;
                    dept.returnAmount += sale.returnAmount || 0;
                    dept.gst += sale.gst || 0;
                    dept.netSale += sale.netSale || 0;
                });
                
                // Update sub-department-wise table
                const subDeptTableBody = document.getElementById('subDeptWiseReportTableBody');
                subDeptTableBody.innerHTML = '';
                
                const subDeptNumberOfDays = subDeptUniqueDates.size > 0 ? subDeptUniqueDates.size : 1;
                
                // Hide branch name heading since we show it in table
                if (branchNameHeading) {
                    branchNameHeading.style.display = 'none';
                }
                
                // Calculate grand totals across all branches
                let grandTotalGrossSale = 0;
                let grandTotalDiscount = 0;
                let grandTotalReturn = 0;
                let grandTotalGST = 0;
                let grandTotalNetSale = 0;
                
                if (Object.keys(branchSubDeptReportData).length === 0) {
                    subDeptTableBody.innerHTML = `
                        <tr>
                            <td colspan="10" class="text-center text-muted py-4">
                                <i class="fas fa-info-circle me-2"></i>
                                No sub-department data available for the selected filters
                            </td>
                        </tr>
                    `;
                } else {
                    // Calculate branch totals first for sorting
                    Object.keys(branchSubDeptReportData).forEach(branchId => {
                        const branchData = branchSubDeptReportData[branchId];
                        let branchTotalNetSale = 0;
                        
                        Object.keys(branchData.departments).forEach(deptId => {
                            const dept = branchData.departments[deptId];
                            branchTotalNetSale += dept.netSale || 0;
                        });
                        
                        // Store total net sale for sorting
                        branchSubDeptReportData[branchId].totalNetSale = branchTotalNetSale;
                    });
                    
                    // Sort branches by total net sale (descending - highest first)
                    const sortedBranchIds = Object.keys(branchSubDeptReportData).sort((a, b) => {
                        return branchSubDeptReportData[b].totalNetSale - branchSubDeptReportData[a].totalNetSale;
                    });
                    
                    sortedBranchIds.forEach(branchId => {
                        const branchData = branchSubDeptReportData[branchId];
                        
                        // Calculate branch totals
                        let branchTotalGrossSale = 0;
                        let branchTotalDiscount = 0;
                        let branchTotalReturn = 0;
                        let branchTotalGST = 0;
                        let branchTotalNetSale = 0;
                        
                        // Sort departments by name
                        const sortedDeptIds = Object.keys(branchData.departments).sort((a, b) => {
                            return branchData.departments[a].department.localeCompare(branchData.departments[b].department);
                        });
                        
                        // Branch name header row (Dark teal like warehouse report)
                        const branchNameRow = document.createElement('tr');
                        branchNameRow.className = 'branch-name-row';
                        branchNameRow.innerHTML = `
                            <td colspan="10" style="text-align: center; padding: 15px; background-color: #00685c; color: white; border-bottom: 5px solid white;">
                                <h5 style="font-size: 1.8rem; color: white; font-weight: 700; margin: 0;"> ${branchData.branchName}</h5>
                            </td>
                        `;
                        subDeptTableBody.appendChild(branchNameRow);
                        
                        // Table headers for this branch (Black with white borders)
                        const headerRow = document.createElement('tr');
                        headerRow.className = 'branch-header-row';
                        headerRow.innerHTML = `
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-left: 1px solid #333; border-top: 1px solid #333; border-bottom: 1px solid #333;">Sub-Department</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Department</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Gross Sale</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Discount Value</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Discount %</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Return</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Sale Value</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">GST</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Net Sale</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-top: 1px solid #333; border-bottom: 1px solid #333;">Daily Average</th>
                        `;
                        subDeptTableBody.appendChild(headerRow);
                        
                        sortedDeptIds.forEach(deptId => {
                            const dept = branchData.departments[deptId];
                            
                            // Add to branch totals
                            branchTotalGrossSale += dept.grossSale;
                            branchTotalDiscount += dept.discountAmount;
                            branchTotalReturn += dept.returnAmount;
                            branchTotalGST += dept.gst;
                            branchTotalNetSale += dept.netSale;
                            
                            // Sort sub-departments by name
                            const sortedSubDeptIds = Object.keys(dept.subDepartments).sort((a, b) => {
                                return dept.subDepartments[a].subDepartment.localeCompare(dept.subDepartments[b].subDepartment);
                            });
                            
                            // Sub-department rows
                            sortedSubDeptIds.forEach(subDeptId => {
                                const subDept = dept.subDepartments[subDeptId];
                                
                                const discountPercent = subDept.grossSale > 0 ? (subDept.discountAmount / subDept.grossSale * 100) : 0;
                                const saleValue = subDept.grossSale - subDept.discountAmount - subDept.returnAmount;
                                const dailyAverage = subDeptNumberOfDays > 0 ? subDept.netSale / subDeptNumberOfDays : 0;
                                
                                const subDeptRow = document.createElement('tr');
                                subDeptRow.innerHTML = `
                                    <td style="padding: 10px; padding-left: 30px;">${subDept.subDepartment}</td>
                                    <td style="padding: 10px;">${dept.department}</td>
                                    <td style="text-align: right; padding: 10px;">${subDept.grossSale.toLocaleString()}</td>
                                    <td style="text-align: right; padding: 10px;">${subDept.discountAmount.toLocaleString()}</td>
                                    <td style="text-align: right; padding: 10px;">${discountPercent.toFixed(2)}%</td>
                                    <td style="text-align: right; padding: 10px;">${subDept.returnAmount.toLocaleString()}</td>
                                    <td style="text-align: right; padding: 10px;">${saleValue.toLocaleString()}</td>
                                    <td style="text-align: right; padding: 10px;">${subDept.gst.toLocaleString()}</td>
                                    <td style="text-align: right; padding: 10px;">${subDept.netSale.toLocaleString()}</td>
                                    <td style="text-align: right; padding: 10px;">${Math.round(dailyAverage).toLocaleString()}</td>
                                `;
                                subDeptTableBody.appendChild(subDeptRow);
                            });
                            
                            // Department total row
                            const deptDiscountPercent = dept.grossSale > 0 ? (dept.discountAmount / dept.grossSale * 100) : 0;
                            const deptSaleValue = dept.grossSale - dept.discountAmount - dept.returnAmount;
                            const deptDailyAverage = subDeptNumberOfDays > 0 ? dept.netSale / subDeptNumberOfDays : 0;
                            
                            const deptTotalRow = document.createElement('tr');
                            deptTotalRow.className = 'department-total-row';
                            deptTotalRow.innerHTML = `
                                <td style="background-color: #e9ecef; font-weight: 700; padding: 12px 15px; padding-left: 15px;" colspan="2">
                                    <i class="fas fa-folder me-2"></i>${dept.department} Total:
                                </td>
                                <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${dept.grossSale.toLocaleString()}</td>
                                <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${dept.discountAmount.toLocaleString()}</td>
                                <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${deptDiscountPercent.toFixed(2)}%</td>
                                <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${dept.returnAmount.toLocaleString()}</td>
                                <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${deptSaleValue.toLocaleString()}</td>
                                <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${dept.gst.toLocaleString()}</td>
                                <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${dept.netSale.toLocaleString()}</td>
                                <td style="background-color: #e9ecef; font-weight: 700; text-align: right; padding: 12px 15px;">${Math.round(deptDailyAverage).toLocaleString()}</td>
                            `;
                            subDeptTableBody.appendChild(deptTotalRow);
                        });
                        
                        // Branch total row
                        const branchDiscountPercent = branchTotalGrossSale > 0 ? (branchTotalDiscount / branchTotalGrossSale * 100) : 0;
                        const branchSaleValue = branchTotalGrossSale - branchTotalDiscount - branchTotalReturn;
                        const branchDailyAverage = subDeptNumberOfDays > 0 ? branchTotalNetSale / subDeptNumberOfDays : 0;
                        
                        const branchTotalRow = document.createElement('tr');
                        branchTotalRow.className = 'branch-total-row';
                        branchTotalRow.innerHTML = `
                            <td style="background-color: #f8f9fa; font-weight: 700; padding: 12px 15px;" colspan="2">
                                <i class="fas fa-calculator me-2"></i>Branch Total: ${branchData.branchName}
                            </td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalGrossSale.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalDiscount.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchDiscountPercent.toFixed(2)}%</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalReturn.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchSaleValue.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalGST.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalNetSale.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${Math.round(branchDailyAverage).toLocaleString()}</td>
                        `;
                        subDeptTableBody.appendChild(branchTotalRow);
                        
                        // Add spacing row between branches
                        const spacingRow = document.createElement('tr');
                        spacingRow.innerHTML = '<td colspan="10" style="height: 20px; border: none;"></td>';
                        subDeptTableBody.appendChild(spacingRow);
                        
                        // Add to grand totals
                        grandTotalGrossSale += branchTotalGrossSale;
                        grandTotalDiscount += branchTotalDiscount;
                        grandTotalReturn += branchTotalReturn;
                        grandTotalGST += branchTotalGST;
                        grandTotalNetSale += branchTotalNetSale;
                    });
                    
                    // Grand total row at the end
                    const grandDiscountPercent = grandTotalGrossSale > 0 ? (grandTotalDiscount / grandTotalGrossSale * 100) : 0;
                    const grandSaleValue = grandTotalGrossSale - grandTotalDiscount - grandTotalReturn;
                    const grandDailyAverage = subDeptNumberOfDays > 0 ? grandTotalNetSale / subDeptNumberOfDays : 0;
                    
                    const grandTotalRow = document.createElement('tr');
                    grandTotalRow.className = 'grand-total-row';
                    grandTotalRow.innerHTML = `
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; padding: 15px; font-size: 1.1rem;" colspan="2">
                            <i class="fas fa-calculator me-2"></i>Grand Total (All Branches):
                        </td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalGrossSale.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalDiscount.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandDiscountPercent.toFixed(2)}%</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalReturn.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandSaleValue.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalGST.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalNetSale.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${Math.round(grandDailyAverage).toLocaleString()}</td>
                    `;
                    subDeptTableBody.appendChild(grandTotalRow);
                    
                    // Update summary cards with grand totals
                    document.getElementById('subDeptWiseSummaryGrossSale').textContent = grandTotalGrossSale.toLocaleString();
                    document.getElementById('subDeptWiseSummaryTotalDiscount').textContent = grandTotalDiscount.toLocaleString();
                    document.getElementById('subDeptWiseSummaryTotalReturn').textContent = grandTotalReturn.toLocaleString();
                    document.getElementById('subDeptWiseSummaryTotalGST').textContent = grandTotalGST.toLocaleString();
                    document.getElementById('subDeptWiseSummaryNetSale').textContent = grandTotalNetSale.toLocaleString();
                }
            }).catch(error => {
                console.error('Error generating sub-department-wise report:', error);
                showNotification('Failed to generate sub-department-wise report', 'error');
            });
        }
        
        // Generate Department-Wise Sale Comparison Report
        function generateDeptComparisonReport() {
            const dateFrom = document.getElementById('deptComparisonReportDateFrom').value;
            const dateTo = document.getElementById('deptComparisonReportDateTo').value;
            const branchId = document.getElementById('deptComparisonReportBranch').value;
            const departmentId = document.getElementById('deptComparisonReportDepartment').value;
            
            // Require at least one date to be selected
            if (!dateFrom && !dateTo) {
                showNotification('Please select at least one date (From or To) to generate the report', 'error');
                return;
            }
            
            // Update subtitle based on filters
            const subtitle = document.getElementById('deptComparisonReportSubtitle');
            let subtitleText = '';
            if (branchId) {
                const branch = appData.branches.find(b => b._id === branchId);
                if (branch) subtitleText += ` ${branch.name}`;
            }
            if (departmentId) {
                const dept = appData.departments?.find(d => d._id === departmentId);
                if (dept) subtitleText += (subtitleText ? ' | ' : '') + ` ${dept.name}`;
            }
            if (subtitleText) {
                subtitle.style.display = 'block';
                subtitle.textContent = subtitleText;
            } else {
                subtitle.style.display = 'none';
            }
            
            const filters = {};
            if (dateFrom) filters.from = dateFrom;
            if (dateTo) filters.to = dateTo;
            if (branchId) filters.branchId = branchId;
            if (departmentId) filters.departmentId = departmentId;
            
            api.getDepartmentSales(filters).then(data => {
                // Group by branch  department
                const branchReportData = {};
                data.forEach(sale => {
                    const branchId = sale.branchId?._id || sale.branchId;
                    const branchName = sale.branchId?.name || 'Unknown';
                    const deptId = sale.departmentId?._id || sale.departmentId;
                    const deptName = sale.departmentId?.name || 'Unknown';
                    
                    // Initialize branch if not exists
                    if (!branchReportData[branchId]) {
                        branchReportData[branchId] = {
                            branchName: branchName,
                            departments: {}
                        };
                    }
                    
                    // Initialize department if not exists
                    if (!branchReportData[branchId].departments[deptId]) {
                        branchReportData[branchId].departments[deptId] = {
                            department: deptName,
                            grossSale: 0,
                            discountAmount: 0,
                            returnAmount: 0,
                            gst: 0,
                            netSale: 0
                        };
                    }
                    
                    // Add sale data
                    const dept = branchReportData[branchId].departments[deptId];
                    dept.grossSale += sale.grossSale || 0;
                    dept.discountAmount += sale.discountAmount || 0;
                    dept.returnAmount += sale.returnAmount || 0;
                    dept.gst += sale.gst || 0;
                    dept.netSale += sale.netSale || 0;
                });
                
                // Calculate profit margin for each department
                Object.keys(branchReportData).forEach(branchId => {
                    Object.keys(branchReportData[branchId].departments).forEach(deptId => {
                        const dept = branchReportData[branchId].departments[deptId];
                        const cost = dept.grossSale - dept.netSale;
                        dept.profitMargin = dept.netSale > 0 ? ((dept.netSale - cost) / dept.netSale * 100) : 0;
                    });
                });
                
                // Update table
                const tableBody = document.getElementById('deptComparisonReportTableBody');
                tableBody.innerHTML = '';
                
                // Calculate grand totals
                let grandTotalGrossSale = 0;
                let grandTotalDiscount = 0;
                let grandTotalReturn = 0;
                let grandTotalGST = 0;
                let grandTotalNetSale = 0;
                
                if (Object.keys(branchReportData).length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="10" class="text-center text-muted py-4">
                                <i class="fas fa-info-circle me-2"></i>
                                No data available for the selected filters
                            </td>
                        </tr>
                    `;
                } else {
                    // Calculate branch totals first for sorting
                    Object.keys(branchReportData).forEach(branchId => {
                        const branchData = branchReportData[branchId];
                        let branchTotalNetSale = 0;
                        
                        Object.keys(branchData.departments).forEach(deptId => {
                            const dept = branchData.departments[deptId];
                            branchTotalNetSale += dept.netSale || 0;
                        });
                        
                        // Store total net sale for sorting
                        branchReportData[branchId].totalNetSale = branchTotalNetSale;
                    });
                    
                    // Sort branches by total net sale (descending - highest first)
                    const sortedBranchIds = Object.keys(branchReportData).sort((a, b) => {
                        return branchReportData[b].totalNetSale - branchReportData[a].totalNetSale;
                    });
                    
                    let globalRank = 1;
                    
                    sortedBranchIds.forEach(branchId => {
                        const branchData = branchReportData[branchId];
                        
                        // Calculate branch totals
                        let branchTotalGrossSale = 0;
                        let branchTotalDiscount = 0;
                        let branchTotalReturn = 0;
                        let branchTotalGST = 0;
                        let branchTotalNetSale = 0;
                        
                        // Sort departments by net sale (descending) for ranking
                        const sortedDeptIds = Object.keys(branchData.departments).sort((a, b) => {
                            return branchData.departments[b].netSale - branchData.departments[a].netSale;
                        });
                        
                        // Branch name header row (Dark teal like warehouse report)
                        const branchNameRow = document.createElement('tr');
                        branchNameRow.className = 'branch-name-row';
                        branchNameRow.innerHTML = `
                            <td colspan="10" style="text-align: center; padding: 15px; background-color: #00685c; color: white; border-bottom: 5px solid white;">
                                <h5 style="font-size: 1.8rem; color: white; font-weight: 700; margin: 0;"> ${branchData.branchName}</h5>
                            </td>
                        `;
                        tableBody.appendChild(branchNameRow);
                        
                        // Table headers for this branch (Black with white borders)
                        const headerRow = document.createElement('tr');
                        headerRow.className = 'branch-header-row';
                        headerRow.innerHTML = `
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-left: 1px solid #333; border-top: 1px solid #333; border-bottom: 1px solid #333;">Rank</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Department</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Gross Sale</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Discount</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Return</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Sale Value</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">GST</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Net Sale</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Profit Margin %</th>
                            <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-top: 1px solid #333; border-bottom: 1px solid #333;">Daily Average</th>
                        `;
                        tableBody.appendChild(headerRow);
                        
                        sortedDeptIds.forEach(deptId => {
                            const dept = branchData.departments[deptId];
                            
                            // Add to branch totals
                            branchTotalGrossSale += dept.grossSale;
                            branchTotalDiscount += dept.discountAmount;
                            branchTotalReturn += dept.returnAmount;
                            branchTotalGST += dept.gst;
                            branchTotalNetSale += dept.netSale;
                            
                            const saleValue = dept.grossSale - dept.discountAmount - dept.returnAmount;
                            const dailyAverage = 1; // Can be calculated if date range is available
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td style="padding: 10px; text-align: center;">${globalRank++}</td>
                                <td style="padding: 10px;">${dept.department}</td>
                                <td style="text-align: right; padding: 10px;">${dept.grossSale.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${dept.discountAmount.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${dept.returnAmount.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${saleValue.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${dept.gst.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${dept.netSale.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${dept.profitMargin.toFixed(2)}%</td>
                                <td style="text-align: right; padding: 10px;">-</td>
                            `;
                            tableBody.appendChild(row);
                        });
                        
                        // Branch total row
                        const branchSaleValue = branchTotalGrossSale - branchTotalDiscount - branchTotalReturn;
                        const branchCost = branchTotalGrossSale - branchTotalNetSale;
                        const branchProfitMargin = branchTotalNetSale > 0 ? ((branchTotalNetSale - branchCost) / branchTotalNetSale * 100) : 0;
                        
                        const branchTotalRow = document.createElement('tr');
                        branchTotalRow.className = 'branch-total-row';
                        branchTotalRow.innerHTML = `
                            <td style="background-color: #f8f9fa; font-weight: 700; padding: 12px 15px; text-align: center;">-</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; padding: 12px 15px;">
                                <i class="fas fa-calculator me-2"></i>Branch Total: ${branchData.branchName}
                            </td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalGrossSale.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalDiscount.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalReturn.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchSaleValue.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalGST.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchTotalNetSale.toLocaleString()}</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">${branchProfitMargin.toFixed(2)}%</td>
                            <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 12px 15px;">-</td>
                        `;
                        tableBody.appendChild(branchTotalRow);
                        
                        // Add spacing row between branches
                        const spacingRow = document.createElement('tr');
                        spacingRow.innerHTML = '<td colspan="10" style="height: 20px; border: none;"></td>';
                        tableBody.appendChild(spacingRow);
                        
                        // Add to grand totals
                        grandTotalGrossSale += branchTotalGrossSale;
                        grandTotalDiscount += branchTotalDiscount;
                        grandTotalReturn += branchTotalReturn;
                        grandTotalGST += branchTotalGST;
                        grandTotalNetSale += branchTotalNetSale;
                    });
                    
                    // Grand total row at the end
                    const grandSaleValue = grandTotalGrossSale - grandTotalDiscount - grandTotalReturn;
                    const grandCost = grandTotalGrossSale - grandTotalNetSale;
                    const grandProfitMargin = grandTotalNetSale > 0 ? ((grandTotalNetSale - grandCost) / grandTotalNetSale * 100) : 0;
                    
                    const grandTotalRow = document.createElement('tr');
                    grandTotalRow.className = 'grand-total-row';
                    grandTotalRow.innerHTML = `
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; padding: 15px; font-size: 1.1rem; text-align: center;">-</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; padding: 15px; font-size: 1.1rem;">
                            <i class="fas fa-calculator me-2"></i>Grand Total (All Branches):
                        </td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalGrossSale.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalDiscount.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalReturn.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandSaleValue.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalGST.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalNetSale.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandProfitMargin.toFixed(2)}%</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">-</td>
                    `;
                    tableBody.appendChild(grandTotalRow);
                }
            }).catch(error => {
                console.error('Error generating department comparison report:', error);
                showNotification('Failed to generate department comparison report', 'error');
            });
        }
        
        // Generate Branch-Wise Sale Comparison Report
        function generateBranchComparisonReport() {
            const dateFrom = document.getElementById('branchComparisonReportDateFrom').value;
            const dateTo = document.getElementById('branchComparisonReportDateTo').value;
            const categoryId = document.getElementById('branchComparisonReportCategory').value;
            const departmentId = document.getElementById('branchComparisonReportDepartment').value;
            
            // Require at least one date to be selected
            if (!dateFrom && !dateTo) {
                showNotification('Please select at least one date (From or To) to generate the report', 'error');
                return;
            }
            
            // Update subtitle based on filters
            const subtitle = document.getElementById('branchComparisonReportSubtitle');
            let subtitleText = '';
            if (categoryId) {
                const category = appData.categories?.find(c => c._id === categoryId);
                if (category) subtitleText += ` ${category.name}`;
            }
            if (departmentId) {
                const dept = appData.departments?.find(d => d._id === departmentId);
                if (dept) subtitleText += (subtitleText ? ' | ' : '') + ` ${dept.name}`;
            }
            if (subtitleText) {
                subtitle.style.display = 'block';
                subtitle.textContent = subtitleText;
            } else {
                subtitle.style.display = 'none';
            }
            
            // Use getDepartmentSales for department-based filtering, or getSales for category-based
            let apiCall;
            const filters = {};
            if (dateFrom) filters.from = dateFrom;
            if (dateTo) filters.to = dateTo;
            
            if (departmentId) {
                filters.departmentId = departmentId;
                apiCall = api.getDepartmentSales(filters);
            } else {
                if (categoryId) filters.categoryId = categoryId;
                apiCall = api.getSales(filters);
            }
            
            apiCall.then(data => {
                // Group by branch
                const reportData = {};
                
                data.forEach(sale => {
                    let branchId, branchName;
                    
                    if (sale.branchId) {
                        branchId = sale.branchId._id || sale.branchId;
                        branchName = sale.branchId.name || 'Unknown';
                    } else {
                        return; // Skip if no branch
                    }
                    
                    if (!reportData[branchId]) {
                        reportData[branchId] = {
                            branch: branchName,
                            grossSale: 0,
                            discount: 0,
                            return: 0,
                            gst: 0,
                            netSale: 0
                        };
                    }
                    
                    // Handle both department sales format and regular sales format
                    if (sale.grossSale !== undefined) {
                        // Department sales format
                        reportData[branchId].grossSale += sale.grossSale || 0;
                        reportData[branchId].discount += sale.discountAmount || 0;
                        reportData[branchId].return += sale.returnAmount || 0;
                        reportData[branchId].gst += sale.gst || 0;
                        // Net Sale = Sale Value + GST, where Sale Value = Gross Sale - Discount - Return
                        const saleValue = (sale.grossSale || 0) - (sale.discountAmount || 0) - (sale.returnAmount || 0);
                        reportData[branchId].netSale += saleValue + (sale.gst || 0);
                    } else if (sale.total !== undefined) {
                        // Regular sales format - convert to department sales format
                        const grossSale = sale.total || 0;
                        const cost = sale.costTotal || 0;
                        const netSale = grossSale - cost;
                        reportData[branchId].grossSale += grossSale;
                        reportData[branchId].netSale += netSale;
                        // Estimate discount and return (not available in regular sales)
                        reportData[branchId].discount += 0;
                        reportData[branchId].return += 0;
                        reportData[branchId].gst += 0;
                    }
                });
                
                // Filter by category if specified (for regular sales)
                if (categoryId && !departmentId) {
                    // This would need additional filtering if using getSales
                    // For now, we'll use the data as is
                }
                
                // Calculate profit margin
                Object.values(reportData).forEach(item => {
                    const cost = item.grossSale - item.netSale;
                    item.profitMargin = item.netSale > 0 ? ((item.netSale - cost) / item.netSale * 100) : 0;
                });
                
                // Sort by net sale descending
                const sortedData = Object.values(reportData).sort((a, b) => b.netSale - a.netSale);
                
                // Update table with warehouse design
                const tableBody = document.getElementById('branchComparisonReportTableBody');
                tableBody.innerHTML = '';
                
                // Calculate grand totals
                let grandTotalGrossSale = 0;
                let grandTotalDiscount = 0;
                let grandTotalReturn = 0;
                let grandTotalGST = 0;
                let grandTotalNetSale = 0;
                
                if (sortedData.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="fas fa-info-circle me-2"></i>
                                No data available for the selected filters
                            </td>
                        </tr>
                    `;
                } else {
                    
                    // Table headers (Black with white borders - warehouse design)
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'branch-header-row';
                    headerRow.innerHTML = `
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-left: 1px solid #333; border-top: 1px solid #333; border-bottom: 1px solid #333;">Rank</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Branch</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Gross Sale</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Discount</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Return</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Sale Value</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">GST</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Net Sale</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 12px; text-align: right; border-top: 1px solid #333; border-bottom: 1px solid #333;">Profit Margin %</th>
                    `;
                    tableBody.appendChild(headerRow);
                    
                    sortedData.forEach((item, index) => {
                        const saleValue = item.grossSale - item.discount - item.return;
                        
                        // Add to grand totals
                        grandTotalGrossSale += item.grossSale;
                        grandTotalDiscount += item.discount;
                        grandTotalReturn += item.return;
                        grandTotalGST += item.gst;
                        grandTotalNetSale += item.netSale;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 10px; text-align: center;">${index + 1}</td>
                            <td style="padding: 10px;">${item.branch}</td>
                            <td style="text-align: right; padding: 10px;">${item.grossSale.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${item.discount.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${item.return.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${saleValue.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${item.gst.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${item.netSale.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${item.profitMargin.toFixed(2)}%</td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Grand total row at the end
                    const grandSaleValue = grandTotalGrossSale - grandTotalDiscount - grandTotalReturn;
                    const grandCost = grandTotalGrossSale - grandTotalNetSale;
                    const grandProfitMargin = grandTotalNetSale > 0 ? ((grandTotalNetSale - grandCost) / grandTotalNetSale * 100) : 0;
                    
                    const grandTotalRow = document.createElement('tr');
                    grandTotalRow.className = 'grand-total-row';
                    grandTotalRow.innerHTML = `
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; padding: 15px; font-size: 1.1rem; text-align: center;">-</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; padding: 15px; font-size: 1.1rem;">
                            <i class="fas fa-calculator me-2"></i>Grand Total (All Branches):
                        </td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalGrossSale.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalDiscount.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalReturn.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandSaleValue.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalGST.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandTotalNetSale.toLocaleString()}</td>
                        <td style="background-color: #2c6e8a; color: white; font-weight: 700; text-align: right; padding: 15px; font-size: 1.1rem;">${grandProfitMargin.toFixed(2)}%</td>
                    `;
                    tableBody.appendChild(grandTotalRow);
                }
            }).catch(error => {
                console.error('Error generating branch comparison report:', error);
                showNotification('Failed to generate branch comparison report', 'error');
            });
        }
        
        // Generate Dashboard Branch-Wise Sale Report
        function generateDashboardBranchWiseReport() {
            const dateFrom = document.getElementById('dashboardBranchWiseReportDateFrom').value;
            const dateTo = document.getElementById('dashboardBranchWiseReportDateTo').value;
            const categoryId = document.getElementById('dashboardBranchWiseReportCategory').value;
            const departmentId = document.getElementById('dashboardBranchWiseReportDepartment').value;
            
            // Require at least one date to be selected
            if (!dateFrom && !dateTo) {
                showNotification('Please select at least one date (From or To) to generate the report', 'error');
                return;
            }
            
            // Update subtitle based on filters
            const subtitle = document.getElementById('dashboardBranchWiseReportSubtitle');
            let subtitleText = '';
            if (categoryId) {
                const category = appData.categories?.find(c => c._id === categoryId);
                if (category) subtitleText += ` ${category.name}`;
            }
            if (departmentId) {
                const dept = appData.departments?.find(d => d._id === departmentId);
                if (dept) subtitleText += (subtitleText ? ' | ' : '') + ` ${dept.name}`;
            }
            if (subtitleText) {
                subtitle.style.display = 'block';
                subtitle.textContent = subtitleText;
            } else {
                subtitle.style.display = 'none';
            }
            
            // Use getDepartmentSales for department-based filtering, or getSales for category-based
            let apiCall;
            const filters = {};
            if (dateFrom) filters.from = dateFrom;
            if (dateTo) filters.to = dateTo;
            
            if (departmentId) {
                filters.departmentId = departmentId;
                apiCall = api.getDepartmentSales(filters);
            } else {
                if (categoryId) filters.categoryId = categoryId;
                apiCall = api.getSales(filters);
            }
            
            apiCall.then(data => {
                // Group by branch
                const reportData = {};
                const uniqueDates = new Set();
                
                data.forEach(sale => {
                    let branchId, branchName;
                    
                    if (sale.branchId) {
                        branchId = sale.branchId._id || sale.branchId;
                        branchName = sale.branchId.name || 'Unknown';
                    } else {
                        return; // Skip if no branch
                    }
                    
                    // Track unique dates for daily average calculation
                    if (sale.date) {
                        const saleDate = new Date(sale.date);
                        const dateString = saleDate.toISOString().split('T')[0];
                        uniqueDates.add(dateString);
                    }
                    
                    if (!reportData[branchId]) {
                        reportData[branchId] = {
                            branch: branchName,
                            grossSale: 0,
                            discount: 0,
                            return: 0,
                            gst: 0,
                            netSale: 0
                        };
                    }
                    
                    // Handle both department sales format and regular sales format
                    if (sale.grossSale !== undefined) {
                        // Department sales format
                        reportData[branchId].grossSale += sale.grossSale || 0;
                        reportData[branchId].discount += sale.discount || 0;
                        reportData[branchId].return += sale.return || 0;
                        reportData[branchId].gst += sale.gst || 0;
                        reportData[branchId].netSale += sale.netSale || 0;
                    } else if (sale.total !== undefined) {
                        // Regular sales format - convert to department sales format
                        const grossSale = sale.total || 0;
                        const cost = sale.costTotal || 0;
                        const netSale = grossSale - cost;
                        reportData[branchId].grossSale += grossSale;
                        reportData[branchId].netSale += netSale;
                        // Estimate discount and return (not available in regular sales)
                        reportData[branchId].discount += 0;
                        reportData[branchId].return += 0;
                        reportData[branchId].gst += 0;
                    }
                });
                
                // Filter by category if specified (for regular sales)
                if (categoryId && !departmentId) {
                    // This would need additional filtering if using getSales
                    // For now, we'll use the data as is
                }
                
                // Calculate summary totals
                let summaryGrossSale = 0;
                let summaryDiscount = 0;
                let summaryReturn = 0;
                let summaryGST = 0;
                let summaryNetSale = 0;
                
                Object.values(reportData).forEach(item => {
                    summaryGrossSale += item.grossSale;
                    summaryDiscount += item.discount;
                    summaryReturn += item.return;
                    summaryGST += item.gst;
                    summaryNetSale += item.netSale;
                });
                
                // Update summary cards
                document.getElementById('dashboardBranchWiseSummaryGrossSale').textContent = summaryGrossSale.toLocaleString();
                document.getElementById('dashboardBranchWiseSummaryTotalDiscount').textContent = summaryDiscount.toLocaleString();
                document.getElementById('dashboardBranchWiseSummaryTotalReturn').textContent = summaryReturn.toLocaleString();
                document.getElementById('dashboardBranchWiseSummaryTotalGST').textContent = summaryGST.toLocaleString();
                document.getElementById('dashboardBranchWiseSummaryNetSale').textContent = summaryNetSale.toLocaleString();
                
                // Sort by net sale descending
                const sortedData = Object.values(reportData).sort((a, b) => b.netSale - a.netSale);
                
                // Update table
                const tableBody = document.getElementById('dashboardBranchWiseReportTableBody');
                tableBody.innerHTML = '';
                
                const numberOfDays = uniqueDates.size > 0 ? uniqueDates.size : 1;
                
                // Calculate grand totals
                let grandTotalGrossSale = 0;
                let grandTotalDiscount = 0;
                let grandTotalReturn = 0;
                let grandTotalGST = 0;
                let grandTotalNetSale = 0;
                
                if (sortedData.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="fas fa-info-circle me-2"></i>
                                No data available for the selected filters
                            </td>
                        </tr>
                    `;
                } else {
                    sortedData.forEach((item) => {
                        const discountPercent = item.grossSale > 0 ? (item.discount / item.grossSale * 100) : 0;
                        const saleValue = item.grossSale - item.discount - item.return;
                        const dailyAverage = numberOfDays > 0 ? item.netSale / numberOfDays : 0;
                        
                        // Accumulate totals
                        grandTotalGrossSale += item.grossSale;
                        grandTotalDiscount += item.discount;
                        grandTotalReturn += item.return;
                        grandTotalGST += item.gst;
                        grandTotalNetSale += item.netSale;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.branch}</td>
                            <td class="text-end">${item.grossSale.toLocaleString()}</td>
                            <td class="text-end">${item.discount.toLocaleString()}</td>
                            <td class="text-end">${discountPercent.toFixed(2)}%</td>
                            <td class="text-end">${item.return.toLocaleString()}</td>
                            <td class="text-end">${saleValue.toLocaleString()}</td>
                            <td class="text-end">${item.gst.toLocaleString()}</td>
                            <td class="text-end" style="font-weight: 700;">${item.netSale.toLocaleString()}</td>
                            <td class="text-end">${Math.round(dailyAverage).toLocaleString()}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Add grand total row
                    const grandTotalDiscountPercent = grandTotalGrossSale > 0 ? (grandTotalDiscount / grandTotalGrossSale * 100) : 0;
                    const grandTotalSaleValue = grandTotalGrossSale - grandTotalDiscount - grandTotalReturn;
                    const grandTotalDailyAverage = numberOfDays > 0 ? grandTotalNetSale / numberOfDays : 0;
                    
                    const grandTotalRow = document.createElement('tr');
                    grandTotalRow.style.backgroundColor = '#f8f9fa';
                    grandTotalRow.style.fontWeight = '700';
                    grandTotalRow.innerHTML = `
                        <td style="font-weight: 700; font-size: 1.1em;">Grand Total</td>
                        <td class="text-end" style="font-weight: 700; font-size: 1.1em;">${grandTotalGrossSale.toLocaleString()}</td>
                        <td class="text-end" style="font-weight: 700; font-size: 1.1em;">${grandTotalDiscount.toLocaleString()}</td>
                        <td class="text-end" style="font-weight: 700; font-size: 1.1em;">${grandTotalDiscountPercent.toFixed(2)}%</td>
                        <td class="text-end" style="font-weight: 700; font-size: 1.1em;">${grandTotalReturn.toLocaleString()}</td>
                        <td class="text-end" style="font-weight: 700; font-size: 1.1em;">${grandTotalSaleValue.toLocaleString()}</td>
                        <td class="text-end" style="font-weight: 700; font-size: 1.1em;">${grandTotalGST.toLocaleString()}</td>
                        <td class="text-end" style="font-weight: 700; font-size: 1.1em; color: #2c6e8a;">${grandTotalNetSale.toLocaleString()}</td>
                        <td class="text-end" style="font-weight: 700; font-size: 1.1em;">${Math.round(grandTotalDailyAverage).toLocaleString()}</td>
                    `;
                    tableBody.appendChild(grandTotalRow);
                }
            }).catch(error => {
                console.error('Error generating dashboard branch-wise report:', error);
                showNotification('Failed to generate branch-wise report', 'error');
            });
        }
        
        // Print Shop Report (Department-wise)
        function printShopReport() {
            const dateFrom = document.getElementById('shopReportDateFrom').value;
            const dateTo = document.getElementById('shopReportDateTo').value;
            const branchId = document.getElementById('shopReportBranch').value;
            const departmentId = document.getElementById('shopReportDepartment').value;
            
            const branch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = branch ? branch.name : 'All Branches';
            const branchAddress = branch ? branch.address : '';
            
            const dept = departmentId ? appData.departments?.find(d => d._id === departmentId) : null;
            const deptName = dept ? dept.name : 'All Departments';
            
            // Get summary values
            const summaryGrossSale = document.getElementById('summaryGrossSale')?.textContent || '0';
            const summaryDiscount = document.getElementById('summaryTotalDiscount')?.textContent || '0';
            const summaryReturn = document.getElementById('summaryTotalReturn')?.textContent || '0';
            const summaryGST = document.getElementById('summaryTotalGST')?.textContent || '0';
            const summaryNetSale = document.getElementById('summaryNetSale')?.textContent || '0';
            
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = dateFrom && dateTo ? 
                `${new Date(dateFrom).toLocaleDateString('en-GB')} - ${new Date(dateTo).toLocaleDateString('en-GB')}` : 
                (dateFrom ? `From ${new Date(dateFrom).toLocaleDateString('en-GB')}` : 
                (dateTo ? `Until ${new Date(dateTo).toLocaleDateString('en-GB')}` : 'All Time'));
            
            const tableBody = document.getElementById('shopReportTableBody');
            const tableRows = tableBody ? tableBody.innerHTML : '<tr><td colspan="7" class="text-center">No data available</td></tr>';
            
            const printContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Shop Report - Department Wise</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        @page {
            size: A4;
            margin: 1in;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #2c6e8a;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 28pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #2c6e8a;
        }
        
        .print-header .company-info {
            font-size: 11pt;
            color: #555;
            margin: 5px 0;
        }
        
        .print-header .report-info {
            font-size: 10pt;
            color: #555;
            margin: 10px 0 0 0;
            text-align: left;
            display: inline-block;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #2c6e8a 0%, #4fb3d9 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-card h4 {
            margin: 0 0 10px 0;
            font-size: 11pt;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .summary-card .value {
            font-size: 22pt;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .net-sale-card {
            background: linear-gradient(135deg, #4D4D4D 0%, #6c757d 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .net-sale-card h4 {
            margin: 0 0 15px 0;
            font-size: 14pt;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .net-sale-card .value {
            font-size: 32pt;
            font-weight: bold;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        th {
            background-color: #2c6e8a;
            color: white;
            padding: 12px;
            text-align: left;
            border: 1px solid #1a4d63;
            font-weight: bold;
        }
        
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Warehouse Design Styles */
        .branch-name-row td {
            background-color: #00685c !important;
            color: white !important;
            text-align: center;
            padding: 15px;
            font-weight: 700;
            font-size: 1.8rem;
            border-bottom: 5px solid white !important;
        }
        
        .branch-header-row th {
            background-color: #000000 !important;
            color: white !important;
            border-right: 2px solid white !important;
            border-left: 1px solid #333 !important;
            border-top: 1px solid #333 !important;
            border-bottom: 1px solid #333 !important;
            font-weight: 700;
            padding: 12px;
        }
        
        .department-total-row td {
            background-color: #e9ecef !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .branch-total-row td {
            background-color: #f8f9fa !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .grand-total-row td {
            background-color: #2c6e8a !important;
            color: white !important;
            font-weight: 700;
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .print-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 9pt;
            color: #666;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        
        @media print {
            body {
                padding: 0;
            }
            
            .summary-cards {
                page-break-inside: avoid;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Department-Wise Report</div>
        ${branchName && branchName !== 'All Branches' ? `<h2 style="text-align: center; margin: 15px 0; font-size: 20pt; font-weight: 600; background-color: #2c6e8a; color: white; padding: 15px; border-radius: 5px;">${branchName}</h2>` : ''}
        <div class="report-info">
            ${branchAddress ? `<strong>Address:</strong> ${branchAddress}<br>` : ''}
            <strong>Department:</strong> ${deptName}<br>
            <strong>Period:</strong> ${dateRange}<br>
            <strong>Generated:</strong> ${currentDate}
        </div>
    </div>
    
    <div class="summary-cards">
        <div class="summary-card">
            <h4>Gross Sale</h4>
            <div class="value">${summaryGrossSale}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
            <h4>Total Discount</h4>
            <div class="value">${summaryDiscount}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #CF2A2A 0%, #ff6b6b 100%);">
            <h4>Total Return</h4>
            <div class="value">${summaryReturn}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #136F63 0%, #17a2b8 100%);">
            <h4>Total GST</h4>
            <div class="value">${summaryGST}</div>
        </div>
    </div>
    
    <div class="net-sale-card">
        <h4>Net Sale</h4>
        <div class="value">${summaryNetSale}</div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Department</th>
                <th class="text-right">Gross Sale</th>
                <th class="text-right">Discount Value</th>
                <th class="text-right">Discount %</th>
                <th class="text-right">Return</th>
                <th class="text-right">Sale Value</th>
                <th class="text-right">GST</th>
                <th class="text-right">Net Sale</th>
                <th class="text-right">Daily Sale Average</th>
            </tr>
        </thead>
        <tbody>
            ${tableRows}
        </tbody>
    </table>
    
    <div class="print-footer">
        <p>This report was generated on ${currentDate} by D.Watson Pharmacy Management System</p>
        <p>For any queries, please contact the management</p>
    </div>
</body>
</html>
            `;
            
            try {
                const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
                
                previewWindow.onload = function() {
                    setTimeout(() => {
                        previewWindow.print();
                    }, 250);
                };
            } catch (error) {
                console.error('Print error:', error);
                showNotification('Print failed: ' + error.message, 'error');
            }
        }
        
        // Print Department-Wise Report
        function printDeptWiseReport() {
            const dateFrom = document.getElementById('deptWiseReportDateFrom').value;
            const dateTo = document.getElementById('deptWiseReportDateTo').value;
            const branchId = document.getElementById('deptWiseReportBranch').value;
            const departmentId = document.getElementById('deptWiseReportDepartment').value;
            
            const branch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = branch ? branch.name : 'All Branches';
            const branchAddress = branch ? branch.address : '';
            
            // Get branch name from heading if available
            const branchNameHeading = document.getElementById('deptWiseReportBranchName');
            const displayedBranchName = branchNameHeading && branchNameHeading.style.display !== 'none' 
                ? branchNameHeading.textContent 
                : (branchName !== 'All Branches' ? branchName : '');
            
            const dept = departmentId ? appData.departments?.find(d => d._id === departmentId) : null;
            const deptName = dept ? dept.name : 'All Departments';
            
            // Get summary values
            const summaryGrossSale = document.getElementById('deptWiseSummaryGrossSale')?.textContent || '0';
            const summaryDiscount = document.getElementById('deptWiseSummaryTotalDiscount')?.textContent || '0';
            const summaryReturn = document.getElementById('deptWiseSummaryTotalReturn')?.textContent || '0';
            const summaryGST = document.getElementById('deptWiseSummaryTotalGST')?.textContent || '0';
            const summaryNetSale = document.getElementById('deptWiseSummaryNetSale')?.textContent || '0';
            
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = dateFrom && dateTo ? 
                `${new Date(dateFrom).toLocaleDateString('en-GB')} - ${new Date(dateTo).toLocaleDateString('en-GB')}` : 
                (dateFrom ? `From ${new Date(dateFrom).toLocaleDateString('en-GB')}` : 
                (dateTo ? `Until ${new Date(dateTo).toLocaleDateString('en-GB')}` : 'All Time'));
            
            const tableBody = document.getElementById('deptWiseReportTableBody');
            const tableRows = tableBody ? tableBody.innerHTML : '<tr><td colspan="9" class="text-center">No data available</td></tr>';
            
            const printContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Department-Wise Report</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        @page {
            size: A4;
            margin: 1in;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #2c6e8a;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 28pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #2c6e8a;
        }
        
        .print-header .company-info {
            font-size: 11pt;
            color: #555;
            margin: 5px 0;
        }
        
        .print-header .report-info {
            font-size: 10pt;
            color: #555;
            margin: 10px 0 0 0;
            text-align: left;
            display: inline-block;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #2c6e8a 0%, #4fb3d9 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-card h4 {
            margin: 0 0 10px 0;
            font-size: 12pt;
            font-weight: 600;
        }
        
        .summary-card .value {
            font-size: 20pt;
            font-weight: bold;
        }
        
        .net-sale-card {
            background: linear-gradient(135deg, #4D4D4D 0%, #6c757d 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .net-sale-card h4 {
            margin: 0 0 15px 0;
            font-size: 14pt;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .net-sale-card .value {
            font-size: 32pt;
            font-weight: bold;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        th {
            background-color: #2c6e8a;
            color: white;
            padding: 12px;
            text-align: left;
            border: 1px solid #1a4d63;
            font-weight: bold;
        }
        
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Warehouse Design Styles */
        .branch-name-row td {
            background-color: #00685c !important;
            color: white !important;
            text-align: center;
            padding: 15px;
            font-weight: 700;
            font-size: 1.8rem;
            border-bottom: 5px solid white !important;
        }
        
        .branch-header-row th {
            background-color: #000000 !important;
            color: white !important;
            border-right: 2px solid white !important;
            border-left: 1px solid #333 !important;
            border-top: 1px solid #333 !important;
            border-bottom: 1px solid #333 !important;
            font-weight: 700;
            padding: 12px;
        }
        
        .department-total-row td {
            background-color: #e9ecef !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .branch-total-row td {
            background-color: #f8f9fa !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .grand-total-row td {
            background-color: #2c6e8a !important;
            color: white !important;
            font-weight: 700;
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .print-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 9pt;
            color: #666;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        
        @media print {
            body {
                padding: 0;
            }
            
            .summary-cards {
                page-break-inside: avoid;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Department-Wise Report</div>
        ${displayedBranchName ? `<h2 style="text-align: center; margin: 15px 0; font-size: 20pt; font-weight: 600;">${displayedBranchName}</h2>` : ''}
        <div class="report-info">
            ${branchAddress ? `<strong>Address:</strong> ${branchAddress}<br>` : ''}
            <strong>Department:</strong> ${deptName}<br>
            <strong>Period:</strong> ${dateRange}<br>
            <strong>Generated:</strong> ${currentDate}
        </div>
    </div>
    
    <div class="summary-cards">
        <div class="summary-card">
            <h4>Gross Sale</h4>
            <div class="value">${summaryGrossSale}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
            <h4>Total Discount</h4>
            <div class="value">${summaryDiscount}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #CF2A2A 0%, #ff6b6b 100%);">
            <h4>Total Return</h4>
            <div class="value">${summaryReturn}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #136F63 0%, #17a2b8 100%);">
            <h4>Total GST</h4>
            <div class="value">${summaryGST}</div>
        </div>
    </div>
    
    <div class="net-sale-card">
        <h4>Net Sale</h4>
        <div class="value">${summaryNetSale}</div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Department</th>
                <th class="text-right">Gross Sale</th>
                <th class="text-right">Discount Value</th>
                <th class="text-right">Discount %</th>
                <th class="text-right">Return</th>
                <th class="text-right">Sale Value</th>
                <th class="text-right">GST</th>
                <th class="text-right">Net Sale</th>
                <th class="text-right">Daily Sale Average</th>
            </tr>
        </thead>
        <tbody>
            ${tableRows}
        </tbody>
    </table>
    
    <div class="print-footer">
        <p>Generated on ${currentDate} | D.Watson Group Of Pharmacies</p>
    </div>
</body>
</html>`;
            
            try {
                const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
                
                previewWindow.onload = function() {
                    setTimeout(() => {
                        previewWindow.print();
                    }, 250);
                };
            } catch (error) {
                console.error('Print error:', error);
                showNotification('Print failed: ' + error.message, 'error');
            }
        }
        
        // Print Sub-Department-Wise Report
        function printSubDeptWiseReport() {
            const dateFrom = document.getElementById('subDeptWiseReportDateFrom').value;
            const dateTo = document.getElementById('subDeptWiseReportDateTo').value;
            const branchId = document.getElementById('subDeptWiseReportBranch').value;
            const departmentId = document.getElementById('subDeptWiseReportDepartment').value;
            const subDepartmentId = document.getElementById('subDeptWiseReportSubDepartment').value;
            
            const branch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = branch ? branch.name : 'All Branches';
            const branchAddress = branch ? branch.address : '';
            
            // Get branch name from heading if available
            const branchNameHeading = document.getElementById('subDeptWiseReportBranchName');
            const displayedBranchName = branchNameHeading && branchNameHeading.style.display !== 'none' 
                ? branchNameHeading.textContent 
                : (branchName !== 'All Branches' ? branchName : '');
            
            const dept = departmentId ? appData.departments?.find(d => d._id === departmentId) : null;
            const deptName = dept ? dept.name : 'All Departments';
            
            const subDept = subDepartmentId ? appData.subDepartments?.find(sd => sd._id === subDepartmentId) : null;
            const subDeptName = subDept ? subDept.name : 'All Sub-Departments';
            
            // Get summary values
            const summaryGrossSale = document.getElementById('subDeptWiseSummaryGrossSale')?.textContent || '0';
            const summaryDiscount = document.getElementById('subDeptWiseSummaryTotalDiscount')?.textContent || '0';
            const summaryReturn = document.getElementById('subDeptWiseSummaryTotalReturn')?.textContent || '0';
            const summaryGST = document.getElementById('subDeptWiseSummaryTotalGST')?.textContent || '0';
            const summaryNetSale = document.getElementById('subDeptWiseSummaryNetSale')?.textContent || '0';
            
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = dateFrom && dateTo ? 
                `${new Date(dateFrom).toLocaleDateString('en-GB')} - ${new Date(dateTo).toLocaleDateString('en-GB')}` : 
                (dateFrom ? `From ${new Date(dateFrom).toLocaleDateString('en-GB')}` : 
                (dateTo ? `Until ${new Date(dateTo).toLocaleDateString('en-GB')}` : 'All Time'));
            
            const tableBody = document.getElementById('subDeptWiseReportTableBody');
            const tableRows = tableBody ? tableBody.innerHTML : '<tr><td colspan="10" class="text-center">No data available</td></tr>';
            
            const printContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sub-Department-Wise Report</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        @page {
            size: A4;
            margin: 1in;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #2c6e8a;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 28pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #2c6e8a;
        }
        
        .print-header .company-info {
            font-size: 11pt;
            color: #555;
            margin: 5px 0;
        }
        
        .print-header .report-info {
            font-size: 10pt;
            color: #555;
            margin: 10px 0 0 0;
            text-align: left;
            display: inline-block;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #2c6e8a 0%, #4fb3d9 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-card h4 {
            margin: 0 0 10px 0;
            font-size: 12pt;
            font-weight: 600;
        }
        
        .summary-card .value {
            font-size: 20pt;
            font-weight: bold;
        }
        
        .net-sale-card {
            background: linear-gradient(135deg, #4D4D4D 0%, #6c757d 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .net-sale-card h4 {
            margin: 0 0 15px 0;
            font-size: 14pt;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .net-sale-card .value {
            font-size: 32pt;
            font-weight: bold;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        th {
            background-color: #2c6e8a;
            color: white;
            padding: 12px;
            text-align: left;
            border: 1px solid #1a4d63;
            font-weight: bold;
        }
        
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Warehouse Design Styles */
        .branch-name-row td {
            background-color: #00685c !important;
            color: white !important;
            text-align: center;
            padding: 15px;
            font-weight: 700;
            font-size: 1.8rem;
            border-bottom: 5px solid white !important;
        }
        
        .branch-header-row th {
            background-color: #000000 !important;
            color: white !important;
            border-right: 2px solid white !important;
            border-left: 1px solid #333 !important;
            border-top: 1px solid #333 !important;
            border-bottom: 1px solid #333 !important;
            font-weight: 700;
            padding: 12px;
        }
        
        .department-total-row td {
            background-color: #e9ecef !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .branch-total-row td {
            background-color: #f8f9fa !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .grand-total-row td {
            background-color: #2c6e8a !important;
            color: white !important;
            font-weight: 700;
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .print-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 9pt;
            color: #666;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        
        @media print {
            body {
                padding: 0;
            }
            
            .summary-cards {
                page-break-inside: avoid;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Sub-Department-Wise Report</div>
        ${displayedBranchName ? `<h2 style="text-align: center; margin: 15px 0; font-size: 20pt; font-weight: 600;">${displayedBranchName}</h2>` : ''}
        <div class="report-info">
            ${branchAddress ? `<strong>Address:</strong> ${branchAddress}<br>` : ''}
            <strong>Department:</strong> ${deptName}<br>
            <strong>Sub-Department:</strong> ${subDeptName}<br>
            <strong>Period:</strong> ${dateRange}<br>
            <strong>Generated:</strong> ${currentDate}
        </div>
    </div>
    
    <div class="summary-cards">
        <div class="summary-card">
            <h4>Gross Sale</h4>
            <div class="value">${summaryGrossSale}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
            <h4>Total Discount</h4>
            <div class="value">${summaryDiscount}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #CF2A2A 0%, #ff6b6b 100%);">
            <h4>Total Return</h4>
            <div class="value">${summaryReturn}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #136F63 0%, #17a2b8 100%);">
            <h4>Total GST</h4>
            <div class="value">${summaryGST}</div>
        </div>
    </div>
    
    <div class="net-sale-card">
        <h4>Net Sale</h4>
        <div class="value">${summaryNetSale}</div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Sub-Department</th>
                <th>Department</th>
                <th>Branch</th>
                <th class="text-right">Gross Sale</th>
                <th class="text-right">Discount</th>
                <th class="text-right">Return</th>
                <th class="text-right">Sale Value</th>
                <th class="text-right">GST</th>
                <th class="text-right">Net Sale</th>
                <th class="text-right">Daily Sale Average</th>
            </tr>
        </thead>
        <tbody>
            ${tableRows}
        </tbody>
    </table>
    
    <div class="print-footer">
        <p>Generated on ${currentDate} | D.Watson Group Of Pharmacies</p>
    </div>
</body>
</html>`;
            
            try {
                const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
                
                previewWindow.onload = function() {
                    setTimeout(() => {
                        previewWindow.print();
                    }, 250);
                };
            } catch (error) {
                console.error('Print error:', error);
                showNotification('Print failed: ' + error.message, 'error');
            }
        }
        
        // Print Department-Wise Sale Comparison Report
        function printDeptComparisonReport() {
            const dateFrom = document.getElementById('deptComparisonReportDateFrom').value;
            const dateTo = document.getElementById('deptComparisonReportDateTo').value;
            const branchId = document.getElementById('deptComparisonReportBranch').value;
            const departmentId = document.getElementById('deptComparisonReportDepartment').value;
            
            const branch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = branch ? branch.name : 'All Branches';
            const branchAddress = branch ? branch.address : '';
            
            const dept = departmentId ? appData.departments?.find(d => d._id === departmentId) : null;
            const deptName = dept ? dept.name : 'All Departments';
            
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = dateFrom && dateTo ? 
                `${new Date(dateFrom).toLocaleDateString('en-GB')} - ${new Date(dateTo).toLocaleDateString('en-GB')}` : 
                (dateFrom ? `From ${new Date(dateFrom).toLocaleDateString('en-GB')}` : 
                (dateTo ? `Until ${new Date(dateTo).toLocaleDateString('en-GB')}` : 'All Time'));
            
            const tableBody = document.getElementById('deptComparisonReportTableBody');
            const tableRows = tableBody ? tableBody.innerHTML : '<tr><td colspan="10" class="text-center">No data available</td></tr>';
            
            const printContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Department-Wise Sale Comparison</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        @page {
            size: A4;
            margin: 1in;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #2c6e8a;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 28pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #2c6e8a;
        }
        
        .print-header .company-info {
            font-size: 11pt;
            color: #555;
            margin: 5px 0;
        }
        
        .print-header .report-info {
            font-size: 10pt;
            color: #555;
            margin: 10px 0 0 0;
            text-align: left;
            display: inline-block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        th {
            background-color: #2c6e8a;
            color: white;
            padding: 12px;
            text-align: left;
            border: 1px solid #1a4d63;
            font-weight: bold;
        }
        
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Warehouse Design Styles */
        .branch-name-row td {
            background-color: #00685c !important;
            color: white !important;
            text-align: center;
            padding: 15px;
            font-weight: 700;
            font-size: 1.8rem;
            border-bottom: 5px solid white !important;
        }
        
        .branch-header-row th {
            background-color: #000000 !important;
            color: white !important;
            border-right: 2px solid white !important;
            border-left: 1px solid #333 !important;
            border-top: 1px solid #333 !important;
            border-bottom: 1px solid #333 !important;
            font-weight: 700;
            padding: 12px;
        }
        
        .department-total-row td {
            background-color: #e9ecef !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .branch-total-row td {
            background-color: #f8f9fa !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .grand-total-row td {
            background-color: #2c6e8a !important;
            color: white !important;
            font-weight: 700;
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .print-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 9pt;
            color: #666;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        
        @media print {
            body {
                padding: 0;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Department-Wise Sale Comparison</div>
        <div class="report-info">
            ${branchAddress ? `<strong>Address:</strong> ${branchAddress}<br>` : ''}
            <strong>Branch:</strong> ${branchName}<br>
            <strong>Department:</strong> ${deptName}<br>
            <strong>Period:</strong> ${dateRange}<br>
            <strong>Generated:</strong> ${currentDate}
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Rank</th>
                <th>Department</th>
                <th>Branch</th>
                <th class="text-right">Gross Sale</th>
                <th class="text-right">Discount</th>
                <th class="text-right">Return</th>
                <th class="text-right">Sale Value</th>
                <th class="text-right">GST</th>
                <th class="text-right">Net Sale</th>
                <th class="text-right">Profit Margin %</th>
            </tr>
        </thead>
        <tbody>
            ${tableRows}
        </tbody>
    </table>
    
    <div class="print-footer">
        <p>Generated on ${currentDate} | D.Watson Group Of Pharmacies</p>
    </div>
</body>
</html>`;
            
            try {
                const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
                
                previewWindow.onload = function() {
                    setTimeout(() => {
                        previewWindow.print();
                    }, 250);
                };
            } catch (error) {
                console.error('Print error:', error);
                showNotification('Print failed: ' + error.message, 'error');
            }
        }
        
        // Print Branch-Wise Sale Comparison Report
        function printBranchComparisonReport() {
            const dateFrom = document.getElementById('branchComparisonReportDateFrom').value;
            const dateTo = document.getElementById('branchComparisonReportDateTo').value;
            const categoryId = document.getElementById('branchComparisonReportCategory').value;
            const departmentId = document.getElementById('branchComparisonReportDepartment').value;
            
            const category = categoryId ? appData.categories?.find(c => c._id === categoryId) : null;
            const categoryName = category ? category.name : 'All Categories';
            
            const dept = departmentId ? appData.departments?.find(d => d._id === departmentId) : null;
            const deptName = dept ? dept.name : 'All Departments';
            
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = dateFrom && dateTo ? 
                `${new Date(dateFrom).toLocaleDateString('en-GB')} - ${new Date(dateTo).toLocaleDateString('en-GB')}` : 
                (dateFrom ? `From ${new Date(dateFrom).toLocaleDateString('en-GB')}` : 
                (dateTo ? `Until ${new Date(dateTo).toLocaleDateString('en-GB')}` : 'All Time'));
            
            const tableBody = document.getElementById('branchComparisonReportTableBody');
            const tableRows = tableBody ? tableBody.innerHTML : '<tr><td colspan="9" class="text-center">No data available</td></tr>';
            
            const printContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Branch-Wise Sale Comparison</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        @page {
            size: A4;
            margin: 1in;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #2c6e8a;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 28pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #2c6e8a;
        }
        
        .print-header .company-info {
            font-size: 11pt;
            color: #555;
            margin: 5px 0;
        }
        
        .print-header .report-info {
            font-size: 10pt;
            color: #555;
            margin: 10px 0 0 0;
            text-align: left;
            display: inline-block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        th {
            background-color: #2c6e8a;
            color: white;
            padding: 12px;
            text-align: left;
            border: 1px solid #1a4d63;
            font-weight: bold;
        }
        
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Warehouse Design Styles */
        .branch-name-row td {
            background-color: #00685c !important;
            color: white !important;
            text-align: center;
            padding: 15px;
            font-weight: 700;
            font-size: 1.8rem;
            border-bottom: 5px solid white !important;
        }
        
        .branch-header-row th {
            background-color: #000000 !important;
            color: white !important;
            border-right: 2px solid white !important;
            border-left: 1px solid #333 !important;
            border-top: 1px solid #333 !important;
            border-bottom: 1px solid #333 !important;
            font-weight: 700;
            padding: 12px;
        }
        
        .department-total-row td {
            background-color: #e9ecef !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .branch-total-row td {
            background-color: #f8f9fa !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .grand-total-row td {
            background-color: #2c6e8a !important;
            color: white !important;
            font-weight: 700;
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .print-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 9pt;
            color: #666;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        
        @media print {
            body {
                padding: 0;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Branch-Wise Sale Comparison</div>
        <div class="report-info">
            <strong>Category:</strong> ${categoryName}<br>
            <strong>Department:</strong> ${deptName}<br>
            <strong>Period:</strong> ${dateRange}<br>
            <strong>Generated:</strong> ${currentDate}
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Rank</th>
                <th>Branch</th>
                <th class="text-right">Gross Sale</th>
                <th class="text-right">Discount</th>
                <th class="text-right">Return</th>
                <th class="text-right">Sale Value</th>
                <th class="text-right">GST</th>
                <th class="text-right">Net Sale</th>
                <th class="text-right">Profit Margin %</th>
            </tr>
        </thead>
        <tbody>
            ${tableRows}
        </tbody>
    </table>
    
    <div class="print-footer">
        <p>Generated on ${currentDate} | D.Watson Group Of Pharmacies</p>
    </div>
</body>
</html>`;
            
            try {
                const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
                
                previewWindow.onload = function() {
                    setTimeout(() => {
                        previewWindow.print();
                    }, 250);
                };
            } catch (error) {
                console.error('Print error:', error);
                showNotification('Print failed: ' + error.message, 'error');
            }
        }
        
        // Print Shop Dashboard Department-Wise Report
        function printShopDashboardDeptWiseReport() {
            const dateFrom = document.getElementById('shopDashboardTopDateFrom')?.value || '';
            const dateTo = document.getElementById('shopDashboardTopDateTo')?.value || '';
            
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = dateFrom && dateTo ? 
                `${new Date(dateFrom).toLocaleDateString('en-GB')} - ${new Date(dateTo).toLocaleDateString('en-GB')}` : 
                (dateFrom ? `From ${new Date(dateFrom).toLocaleDateString('en-GB')}` : 
                (dateTo ? `Until ${new Date(dateTo).toLocaleDateString('en-GB')}` : 'All Time'));
            
            const tableBody = document.getElementById('shopDashboardDeptWiseReportTableBody');
            const tableRows = tableBody ? tableBody.innerHTML : '<tr><td colspan="9" class="text-center">No data available</td></tr>';
            
            const printContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Department-Wise Report</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        @page {
            size: A4;
            margin: 1in;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #2c6e8a;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 28pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #2c6e8a;
        }
        
        .print-header .company-info {
            font-size: 11pt;
            color: #555;
            margin: 5px 0;
        }
        
        .print-header .report-info {
            font-size: 10pt;
            color: #555;
            margin: 10px 0 0 0;
            text-align: left;
            display: inline-block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        th {
            background-color: #2c6e8a;
            color: white;
            padding: 12px;
            text-align: left;
            border: 1px solid #1a4d63;
            font-weight: bold;
        }
        
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Warehouse Design Styles */
        .branch-name-row td {
            background-color: #00685c !important;
            color: white !important;
            text-align: center;
            padding: 15px;
            font-weight: 700;
            font-size: 1.8rem;
            border-bottom: 5px solid white !important;
        }
        
        .branch-header-row th {
            background-color: #000000 !important;
            color: white !important;
            border-right: 2px solid white !important;
            border-left: 1px solid #333 !important;
            border-top: 1px solid #333 !important;
            border-bottom: 1px solid #333 !important;
            font-weight: 700;
            padding: 12px;
        }
        
        .department-total-row td {
            background-color: #e9ecef !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .branch-total-row td {
            background-color: #f8f9fa !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .grand-total-row td {
            background-color: #2c6e8a !important;
            color: white !important;
            font-weight: 700;
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .print-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 9pt;
            color: #666;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        
        @media print {
            body {
                padding: 0;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Department-Wise Report</div>
        <div class="report-info">
            <strong>Period:</strong> ${dateRange}<br>
            <strong>Generated:</strong> ${currentDate}
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Department</th>
                <th class="text-right">Gross Sale</th>
                <th class="text-right">Discount Value</th>
                <th class="text-right">Discount %</th>
                <th class="text-right">Return</th>
                <th class="text-right">Sale Value</th>
                <th class="text-right">GST</th>
                <th class="text-right">Net Sale</th>
                <th class="text-right">Daily Sale Average</th>
            </tr>
        </thead>
        <tbody>
            ${tableRows}
        </tbody>
    </table>
    
    <div class="print-footer">
        <p>Generated on ${currentDate} | D.Watson Group Of Pharmacies</p>
    </div>
</body>
</html>`;
            
            try {
                const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
                
                previewWindow.onload = function() {
                    setTimeout(() => {
                        previewWindow.print();
                    }, 250);
                };
            } catch (error) {
                console.error('Print error:', error);
                showNotification('Print failed: ' + error.message, 'error');
            }
        }
        
        // Print Dashboard Branch-Wise Sale Report (old function - kept for compatibility)
        function printDashboardBranchWiseReport() {
            const dateFrom = document.getElementById('dashboardBranchWiseReportDateFrom').value;
            const dateTo = document.getElementById('dashboardBranchWiseReportDateTo').value;
            const categoryId = document.getElementById('dashboardBranchWiseReportCategory').value;
            const departmentId = document.getElementById('dashboardBranchWiseReportDepartment').value;
            
            const category = categoryId ? appData.categories?.find(c => c._id === categoryId) : null;
            const categoryName = category ? category.name : 'All Categories';
            
            const dept = departmentId ? appData.departments?.find(d => d._id === departmentId) : null;
            const deptName = dept ? dept.name : 'All Departments';
            
            // Get summary values
            const summaryGrossSale = document.getElementById('dashboardBranchWiseSummaryGrossSale')?.textContent || '0';
            const summaryDiscount = document.getElementById('dashboardBranchWiseSummaryTotalDiscount')?.textContent || '0';
            const summaryReturn = document.getElementById('dashboardBranchWiseSummaryTotalReturn')?.textContent || '0';
            const summaryGST = document.getElementById('dashboardBranchWiseSummaryTotalGST')?.textContent || '0';
            const summaryNetSale = document.getElementById('dashboardBranchWiseSummaryNetSale')?.textContent || '0';
            
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = dateFrom && dateTo ? 
                `${new Date(dateFrom).toLocaleDateString('en-GB')} - ${new Date(dateTo).toLocaleDateString('en-GB')}` : 
                (dateFrom ? `From ${new Date(dateFrom).toLocaleDateString('en-GB')}` : 
                (dateTo ? `Until ${new Date(dateTo).toLocaleDateString('en-GB')}` : 'All Time'));
            
            const tableBody = document.getElementById('dashboardBranchWiseReportTableBody');
            const tableRows = tableBody ? tableBody.innerHTML : '<tr><td colspan="9" class="text-center">No data available</td></tr>';
            
            const printContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Branch-Wise Sale Report</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        @page {
            size: A4;
            margin: 1in;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #2c6e8a;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 28pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #2c6e8a;
        }
        
        .print-header .company-info {
            font-size: 11pt;
            color: #555;
            margin: 5px 0;
        }
        
        .print-header .report-info {
            font-size: 10pt;
            color: #555;
            margin: 10px 0 0 0;
            text-align: left;
            display: inline-block;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #2c6e8a 0%, #4fb3d9 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-card h4 {
            margin: 0 0 10px 0;
            font-size: 12pt;
            font-weight: 600;
        }
        
        .summary-card .value {
            font-size: 20pt;
            font-weight: bold;
        }
        
        .net-sale-card {
            background: linear-gradient(135deg, #4D4D4D 0%, #6c757d 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .net-sale-card h4 {
            margin: 0 0 15px 0;
            font-size: 14pt;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .net-sale-card .value {
            font-size: 32pt;
            font-weight: bold;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        th {
            background-color: #2c6e8a;
            color: white;
            padding: 12px;
            text-align: left;
            border: 1px solid #1a4d63;
            font-weight: bold;
        }
        
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Warehouse Design Styles */
        .branch-name-row td {
            background-color: #00685c !important;
            color: white !important;
            text-align: center;
            padding: 15px;
            font-weight: 700;
            font-size: 1.8rem;
            border-bottom: 5px solid white !important;
        }
        
        .branch-header-row th {
            background-color: #000000 !important;
            color: white !important;
            border-right: 2px solid white !important;
            border-left: 1px solid #333 !important;
            border-top: 1px solid #333 !important;
            border-bottom: 1px solid #333 !important;
            font-weight: 700;
            padding: 12px;
        }
        
        .department-total-row td {
            background-color: #e9ecef !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .branch-total-row td {
            background-color: #f8f9fa !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .grand-total-row td {
            background-color: #2c6e8a !important;
            color: white !important;
            font-weight: 700;
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .print-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 9pt;
            color: #666;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        
        @media print {
            body {
                padding: 0;
            }
            
            .summary-cards {
                page-break-inside: avoid;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Branch-Wise Sale Report</div>
        <div class="report-info">
            <strong>Category:</strong> ${categoryName}<br>
            <strong>Department:</strong> ${deptName}<br>
            <strong>Period:</strong> ${dateRange}<br>
            <strong>Generated:</strong> ${currentDate}
        </div>
    </div>
    
    <div class="summary-cards">
        <div class="summary-card">
            <h4>Gross Sale</h4>
            <div class="value">${summaryGrossSale}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
            <h4>Total Discount</h4>
            <div class="value">${summaryDiscount}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #CF2A2A 0%, #ff6b6b 100%);">
            <h4>Total Return</h4>
            <div class="value">${summaryReturn}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #136F63 0%, #17a2b8 100%);">
            <h4>Total GST</h4>
            <div class="value">${summaryGST}</div>
        </div>
    </div>
    
    <div class="net-sale-card">
        <h4>Net Sale</h4>
        <div class="value">${summaryNetSale}</div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Branch</th>
                <th class="text-right">Gross Sale</th>
                <th class="text-right">Discount Value</th>
                <th class="text-right">Discount %</th>
                <th class="text-right">Return</th>
                <th class="text-right">Sale Value</th>
                <th class="text-right">GST</th>
                <th class="text-right">Net Sale</th>
                <th class="text-right">Daily Sale Average</th>
            </tr>
        </thead>
        <tbody>
            ${tableRows}
        </tbody>
    </table>
    
    <div class="print-footer">
        <p>Generated on ${currentDate} | D.Watson Group Of Pharmacies</p>
    </div>
</body>
</html>`;
            
            try {
                const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
                
                previewWindow.onload = function() {
                    setTimeout(() => {
                        previewWindow.print();
                    }, 250);
                };
            } catch (error) {
                console.error('Print error:', error);
                showNotification('Print failed: ' + error.message, 'error');
            }
        }
        
        // Print Shop Sub-Department Report
        function printShopSubDeptReport() {
            const dateFrom = document.getElementById('shopReportDateFrom').value;
            const dateTo = document.getElementById('shopReportDateTo').value;
            const branchId = document.getElementById('shopReportBranch').value;
            const departmentId = document.getElementById('shopReportDepartment').value;
            const subDepartmentId = document.getElementById('shopReportSubDepartment').value;
            
            const branch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = branch ? branch.name : 'All Branches';
            const branchAddress = branch ? branch.address : '';
            
            const dept = departmentId ? appData.departments?.find(d => d._id === departmentId) : null;
            const deptName = dept ? dept.name : 'All Departments';
            
            const subDept = subDepartmentId ? appData.subDepartments?.find(sd => sd._id === subDepartmentId) : null;
            const subDeptName = subDept ? subDept.name : 'All Sub-Departments';
            
            // Get summary values
            const summaryGrossSale = document.getElementById('summaryGrossSale')?.textContent || '0';
            const summaryDiscount = document.getElementById('summaryTotalDiscount')?.textContent || '0';
            const summaryReturn = document.getElementById('summaryTotalReturn')?.textContent || '0';
            const summaryGST = document.getElementById('summaryTotalGST')?.textContent || '0';
            const summaryNetSale = document.getElementById('summaryNetSale')?.textContent || '0';
            
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = dateFrom && dateTo ? 
                `${new Date(dateFrom).toLocaleDateString('en-GB')} - ${new Date(dateTo).toLocaleDateString('en-GB')}` : 
                (dateFrom ? `From ${new Date(dateFrom).toLocaleDateString('en-GB')}` : 
                (dateTo ? `Until ${new Date(dateTo).toLocaleDateString('en-GB')}` : 'All Time'));
            
            const tableBody = document.getElementById('shopSubDeptReportTableBody');
            const tableRows = tableBody ? tableBody.innerHTML : '<tr><td colspan="8" class="text-center">No data available</td></tr>';
            
            const printContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Shop Report - Sub-Department Wise</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        @page {
            size: A4;
            margin: 1in;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #2c6e8a;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 28pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #2c6e8a;
        }
        
        .print-header .company-info {
            font-size: 11pt;
            color: #555;
            margin: 5px 0;
        }
        
        .print-header .report-info {
            font-size: 10pt;
            color: #555;
            margin: 10px 0 0 0;
            text-align: left;
            display: inline-block;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #2c6e8a 0%, #4fb3d9 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-card h4 {
            margin: 0 0 10px 0;
            font-size: 11pt;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .summary-card .value {
            font-size: 22pt;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .net-sale-card {
            background: linear-gradient(135deg, #4D4D4D 0%, #6c757d 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .net-sale-card h4 {
            margin: 0 0 15px 0;
            font-size: 14pt;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .net-sale-card .value {
            font-size: 32pt;
            font-weight: bold;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        th {
            background-color: #2c6e8a;
            color: white;
            padding: 12px;
            text-align: left;
            border: 1px solid #1a4d63;
            font-weight: bold;
        }
        
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Warehouse Design Styles */
        .branch-name-row td {
            background-color: #00685c !important;
            color: white !important;
            text-align: center;
            padding: 15px;
            font-weight: 700;
            font-size: 1.8rem;
            border-bottom: 5px solid white !important;
        }
        
        .branch-header-row th {
            background-color: #000000 !important;
            color: white !important;
            border-right: 2px solid white !important;
            border-left: 1px solid #333 !important;
            border-top: 1px solid #333 !important;
            border-bottom: 1px solid #333 !important;
            font-weight: 700;
            padding: 12px;
        }
        
        .department-total-row td {
            background-color: #e9ecef !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .branch-total-row td {
            background-color: #f8f9fa !important;
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .grand-total-row td {
            background-color: #2c6e8a !important;
            color: white !important;
            font-weight: 700;
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .print-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 9pt;
            color: #666;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        
        @media print {
            body {
                padding: 0;
            }
            
            .summary-cards {
                page-break-inside: avoid;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Shop Report - Sub-Department Wise</div>
        ${branchName && branchName !== 'All Branches' ? `<h2 style="text-align: center; margin: 15px 0; font-size: 20pt; font-weight: 600;">${branchName}</h2>` : ''}
        <div class="report-info">
            ${branchAddress ? `<strong>Address:</strong> ${branchAddress}<br>` : ''}
            <strong>Department:</strong> ${deptName}<br>
            <strong>Sub-Department:</strong> ${subDeptName}<br>
            <strong>Period:</strong> ${dateRange}<br>
            <strong>Generated:</strong> ${currentDate}
        </div>
    </div>
    
    <div class="summary-cards">
        <div class="summary-card">
            <h4>Gross Sale</h4>
            <div class="value">${summaryGrossSale}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
            <h4>Total Discount</h4>
            <div class="value">${summaryDiscount}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #CF2A2A 0%, #ff6b6b 100%);">
            <h4>Total Return</h4>
            <div class="value">${summaryReturn}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #136F63 0%, #17a2b8 100%);">
            <h4>Total GST</h4>
            <div class="value">${summaryGST}</div>
        </div>
    </div>
    
    <div class="net-sale-card">
        <h4>Net Sale</h4>
        <div class="value">${summaryNetSale}</div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Sub-Department</th>
                <th>Department</th>
                <th>Branch</th>
                <th class="text-right">Gross Sale</th>
                <th class="text-right">Discount</th>
                <th class="text-right">Return</th>
                <th class="text-right">GST</th>
                <th class="text-right">Net Sale</th>
            </tr>
        </thead>
        <tbody>
            ${tableRows}
        </tbody>
    </table>
    
    <div class="print-footer">
        <p>This report was generated on ${currentDate} by D.Watson Pharmacy Management System</p>
        <p>For any queries, please contact the management</p>
    </div>
</body>
</html>
            `;
            
            try {
                const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
                
                previewWindow.onload = function() {
                    setTimeout(() => {
                        previewWindow.print();
                    }, 250);
                };
            } catch (error) {
                console.error('Print error:', error);
                showNotification('Print failed: ' + error.message, 'error');
            }
        }
        
        // Generate sales comparison table
        function generateSalesComparisonTable(filteredData) {
            const comparisonTableBody = document.getElementById('salesComparisonTableBody');
            comparisonTableBody.innerHTML = '';
            
            // Calculate totals by branch
            const branchData = {};
            
            appData.branches.forEach(branch => {
                const branchSales = filteredData.filter(sale => sale.branchId._id === branch._id);
                const totalSales = branchSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                const totalCost = branchSales.reduce((sum, sale) => sum + (sale.costTotal || 0), 0);
                const totalProfit = totalSales - totalCost;
                const profitMargin = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;
                
                branchData[branch._id] = {
                    name: branch.name,
                    totalSales,
                    totalCost,
                    totalProfit,
                    profitMargin
                };
            });
            
            // Sort branches by sales (highest first)
            const sortedBranches = Object.values(branchData).sort((a, b) => b.totalSales - a.totalSales);
            
            // Populate table
            sortedBranches.forEach((data, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${data.name}</td>
                    <td>${data.totalSales.toLocaleString()}</td>
                    <td>${data.totalCost.toLocaleString()}</td>
                    <td class="${data.totalProfit >= 0 ? 'text-success' : 'text-danger'}">
                        ${data.totalProfit.toLocaleString()}
                    </td>
                    <td>
                        <span class="badge ${data.profitMargin >= 0 ? 'bg-success' : 'bg-danger'}">
                            ${data.profitMargin.toFixed(1)}%
                        </span>
                    </td>
                `;
                comparisonTableBody.appendChild(row);
            });
        }
        
        // Generate date wise data table
        function generateDateWiseTable(filteredData) {
            const dateWiseTableBody = document.getElementById('dateWiseTableBody');
            dateWiseTableBody.innerHTML = '';
            
            // Sort data by date (newest first)
            const sortedData = [...filteredData].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Populate table
            sortedData.forEach(sale => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(sale.date)}</td>
                    <td>${sale.branchId?.name || 'Unknown'}</td>
                    <td>${sale.categoryId?.name || 'Unknown'}</td>
                    <td>${(sale.total || 0).toLocaleString()}</td>
                    <td>${(sale.costTotal || 0).toLocaleString()}</td>
                    <td class="${sale.profit >= 0 ? 'text-success' : 'text-danger'}">
                        ${(sale.profit || 0).toLocaleString()}
                    </td>
                `;
                dateWiseTableBody.appendChild(row);
            });
        }
        
        // ========================================
        // PRINT PREVIEW FUNCTIONS FOR SALES REPORTS
        // ========================================
        
        // Print Sales Report Preview
        function printSalesReportPreview() {
            const dateFrom = document.getElementById('salesReportDateFrom').value;
            const dateTo = document.getElementById('salesReportDateTo').value;
            const branchId = document.getElementById('salesReportBranch').value;
            const categoryId = document.getElementById('salesReportCategory').value;
            
            // Get branch info
            const branch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = branch ? branch.name : 'All Branches';
            
            // Get category info
            const category = categoryId ? appData.categories.find(c => c._id === categoryId) : null;
            const categoryName = category ? category.name : 'All Categories';
            
            const filters = {};
            if (dateFrom) filters.from = dateFrom;
            if (dateTo) filters.to = dateTo;
            if (branchId) filters.branchId = branchId;
            
            api.getSales(filters).then(filteredData => {
                let data = filteredData;
                if (categoryId) {
                    data = filteredData.filter(sale => sale.categoryId._id === categoryId);
                }
                
                // Calculate totals by branch and category
                const reportData = {};
                data.forEach(sale => {
                    const key = `${sale.branchId._id}-${sale.categoryId._id}`;
                    if (!reportData[key]) {
                        reportData[key] = {
                            branch: sale.branchId.name,
                            category: sale.categoryId.name,
                            totalSales: 0,
                            totalCost: 0
                        };
                    }
                    reportData[key].totalSales += sale.total || 0;
                    reportData[key].totalCost += sale.costTotal || 0;
                });
                
                // Calculate summary totals
                let summaryTotalSales = 0, summaryTotalCost = 0, summaryTotalProfit = 0;
                Object.values(reportData).forEach(item => {
                    summaryTotalSales += item.totalSales;
                    summaryTotalCost += item.totalCost;
                    summaryTotalProfit += (item.totalSales - item.totalCost);
                });
                const summaryProfitMargin = summaryTotalSales > 0 ? (summaryTotalProfit / summaryTotalSales * 100) : 0;
                
                // Create print content
                const printContent = createSalesReportPrintContent(
                    Object.values(reportData),
                    summaryTotalSales,
                    summaryTotalCost,
                    summaryTotalProfit,
                    summaryProfitMargin,
                    branchName,
                    categoryName,
                    dateFrom,
                    dateTo
                );
                
                // Open preview window and trigger print dialog
                try {
                    const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                    if (!previewWindow) {
                        throw new Error('Popup blocked. Please allow popups for this site.');
                    }
                    previewWindow.document.write(printContent);
                    previewWindow.document.close();
                    
                    // Wait for content to load, then trigger print dialog
                    previewWindow.onload = function() {
                        setTimeout(() => {
                            previewWindow.print();
                        }, 250);
                    };
                } catch (error) {
                    console.error('Preview error:', error);
                    showNotification('Preview failed: ' + error.message, 'error');
                }
            }).catch(error => {
                console.error('Error generating sales report:', error);
                showNotification('Failed to generate report', 'error');
            });
        }
        
        // Print Payment Report Preview
        function printPaymentReportPreview() {
            const dateFrom = document.getElementById('paymentReportFromDateFilter').value;
            const dateTo = document.getElementById('paymentReportToDateFilter').value;
            const branchId = document.getElementById('paymentReportBranchFilter').value;
            const categoryId = document.getElementById('paymentReportCategoryFilter').value;
            
            // Get branch info
            const branch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = branch ? branch.name : 'All Branches';
            
            // Get category info
            const category = categoryId ? appData.categories.find(c => c._id === categoryId) : null;
            const categoryName = category ? category.name : 'All Categories';
            
            const salesFilters = {};
            if (dateFrom) salesFilters.from = dateFrom;
            if (dateTo) salesFilters.to = dateTo;
            if (branchId) salesFilters.branchId = branchId;
            
            const paymentFilters = {};
            if (dateFrom) paymentFilters.from = dateFrom;
            if (dateTo) paymentFilters.to = dateTo;
            if (branchId) paymentFilters.branchId = branchId;
            if (categoryId) paymentFilters.categoryId = categoryId;
            
            // Fetch sales and category payments from database in parallel
            console.log(' [Print] Fetching payment report data from database...');
            console.log(' [Print] Sales filters:', salesFilters);
            console.log(' [Print] Payment filters:', paymentFilters);
            
            Promise.all([
                api.getSales(salesFilters),
                api.getCategoryPayments(paymentFilters)
            ]).then(([salesData, paymentsData]) => {
                console.log(' [Print] Sales data loaded from database:', Array.isArray(salesData) ? salesData.length : 0, 'records');
                console.log(' [Print] Category payments data loaded from database:', Array.isArray(paymentsData) ? paymentsData.length : 0, 'records');
                
                // Ensure we have arrays
                const salesArray = Array.isArray(salesData) ? salesData : [];
                const paymentsArray = Array.isArray(paymentsData) ? paymentsData : [];
                
                // Filter sales by category if specified
                let filteredSales = salesArray;
                if (categoryId) {
                    filteredSales = salesArray.filter(sale => {
                        const saleCategoryId = sale.categoryId?._id || sale.categoryId;
                        return saleCategoryId === categoryId;
                    });
                }
                
                // Calculate totals by branch and category
                const reportData = {};
                
                // Process sales data from database
                filteredSales.forEach(sale => {
                    // Handle populated or unpopulated branch/category references
                    const saleBranchId = sale.branchId?._id || sale.branchId;
                    const saleCategoryId = sale.categoryId?._id || sale.categoryId;
                    const saleBranchName = sale.branchId?.name || appData.branches.find(b => {
                        const bId = b._id?.toString() || b._id;
                        const sId = saleBranchId?.toString() || saleBranchId;
                        return bId === sId;
                    })?.name || 'Unknown';
                    const saleCategoryName = sale.categoryId?.name || appData.categories.find(c => {
                        const cId = c._id?.toString() || c._id;
                        const sId = saleCategoryId?.toString() || saleCategoryId;
                        return cId === sId;
                    })?.name || 'Unknown';
                    
                    const key = `${saleBranchId}-${saleCategoryId}`;
                    if (!reportData[key]) {
                        reportData[key] = {
                            branch: saleBranchName,
                            category: saleCategoryName,
                            totalSales: 0,
                            totalCost: 0,
                            categoryPayments: 0,
                            balancePayment: 0
                        };
                    }
                    // Sum sales (total) and cost (costTotal) from database
                    reportData[key].totalSales += parseFloat(sale.total || 0);
                    reportData[key].totalCost += parseFloat(sale.costTotal || 0);
                });
                
                // Process category payments data from database
                paymentsArray.forEach(payment => {
                    const branchId = payment.branchId?._id || payment.branchId;
                    const categoryId = payment.categoryId?._id || payment.categoryId;
                    const branchName = payment.branchId?.name || appData.branches.find(b => {
                        const bId = b._id?.toString() || b._id;
                        const pId = branchId?.toString() || branchId;
                        return bId === pId;
                    })?.name || 'Unknown';
                    const categoryName = payment.categoryId?.name || appData.categories.find(c => {
                        const cId = c._id?.toString() || c._id;
                        const pId = categoryId?.toString() || categoryId;
                        return cId === pId;
                    })?.name || 'Unknown';
                    
                    const key = `${branchId}-${categoryId}`;
                    if (!reportData[key]) {
                        reportData[key] = {
                            branch: branchName,
                            category: categoryName,
                            totalSales: 0,
                            totalCost: 0,
                            categoryPayments: 0,
                            balancePayment: 0
                        };
                    }
                    // Sum category payments (amount) from database
                    reportData[key].categoryPayments += parseFloat(payment.amount || 0);
                });
                
                // Calculate balance payment (Cost - Payment)
                Object.values(reportData).forEach(item => {
                    item.balancePayment = item.totalCost - item.categoryPayments;
                });
                
                // Calculate summary totals
                let summaryTotalSales = 0, summaryTotalCost = 0, summaryCategoryPayments = 0, summaryBalancePayment = 0;
                Object.values(reportData).forEach(item => {
                    summaryTotalSales += item.totalSales;
                    summaryTotalCost += item.totalCost;
                    summaryCategoryPayments += item.categoryPayments;
                    summaryBalancePayment += item.balancePayment;
                });
                
                // Create print content - pass categoryId to determine grouping
                const printContent = createPaymentReportPrintContent(
                    Object.values(reportData),
                    summaryTotalSales,
                    summaryTotalCost,
                    summaryCategoryPayments,
                    summaryBalancePayment,
                    branchName,
                    categoryName,
                    dateFrom,
                    dateTo,
                    categoryId
                );
                
                // Open preview window and trigger print dialog
                try {
                    const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                    if (!previewWindow) {
                        throw new Error('Popup blocked. Please allow popups for this site.');
                    }
                    previewWindow.document.write(printContent);
                    previewWindow.document.close();
                    
                    // Wait for content to load, then trigger print dialog
                    previewWindow.onload = function() {
                        setTimeout(() => {
                            previewWindow.print();
                        }, 250);
                    };
                } catch (error) {
                    console.error('Preview error:', error);
                    showNotification('Preview failed: ' + error.message, 'error');
                }
            }).catch(error => {
                console.error('Error generating payment report:', error);
                showNotification('Failed to generate report', 'error');
            });
        }
        
        // Print Comparison Report Preview
        function printComparisonReportPreview() {
            const dateFrom = document.getElementById('comparisonReportDateFrom').value;
            const dateTo = document.getElementById('comparisonReportDateTo').value;
            const branchId = document.getElementById('comparisonReportBranch').value;
            const categoryId = document.getElementById('comparisonReportCategory').value;
            
            // Get branch info
            const branch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = branch ? branch.name : 'All Branches';
            
            // Get category info
            const category = categoryId ? appData.categories.find(c => c._id === categoryId) : null;
            const categoryName = category ? category.name : 'All Categories';
            
            const filters = {};
            if (dateFrom) filters.from = dateFrom;
            if (dateTo) filters.to = dateTo;
            if (branchId) filters.branchId = branchId;
            
            api.getSales(filters).then(filteredData => {
                let data = filteredData;
                if (categoryId) {
                    data = filteredData.filter(sale => sale.categoryId._id === categoryId);
                }
                
                // Calculate by branch and category
                const reportData = {};
                data.forEach(sale => {
                    const key = `${sale.branchId._id}-${sale.categoryId._id}`;
                    if (!reportData[key]) {
                        reportData[key] = {
                            branch: sale.branchId.name,
                            category: sale.categoryId.name,
                            totalSales: 0,
                            totalCost: 0
                        };
                    }
                    reportData[key].totalSales += sale.total || 0;
                    reportData[key].totalCost += sale.costTotal || 0;
                });
                
                // Calculate profits and sort
                const rankedData = Object.values(reportData).map(item => ({
                    ...item,
                    totalProfit: item.totalSales - item.totalCost,
                    profitMargin: item.totalSales > 0 ? ((item.totalSales - item.totalCost) / item.totalSales * 100) : 0
                })).sort((a, b) => b.totalSales - a.totalSales);
                
                // Create print content
                const printContent = createComparisonReportPrintContent(
                    rankedData,
                    branchName,
                    categoryName,
                    dateFrom,
                    dateTo
                );
                
                // Open preview window and trigger print dialog
                try {
                    const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                    if (!previewWindow) {
                        throw new Error('Popup blocked. Please allow popups for this site.');
                    }
                    previewWindow.document.write(printContent);
                    previewWindow.document.close();
                    
                    // Wait for content to load, then trigger print dialog
                    previewWindow.onload = function() {
                        setTimeout(() => {
                            previewWindow.print();
                        }, 250);
                    };
                } catch (error) {
                    console.error('Preview error:', error);
                    showNotification('Preview failed: ' + error.message, 'error');
                }
            }).catch(error => {
                console.error('Error generating comparison report:', error);
                showNotification('Failed to generate report', 'error');
            });
        }
        
        // Create Sales Report Print Content
        function createSalesReportPrintContent(reportData, totalSales, totalCost, totalProfit, profitMargin, branchName, categoryName, dateFrom, dateTo) {
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = dateFrom && dateTo ? 
                `${new Date(dateFrom).toLocaleDateString('en-GB')} - ${new Date(dateTo).toLocaleDateString('en-GB')}` : 
                'All Time';
            
            // Group by branch for display
            const branchGroups = {};
            reportData.forEach(item => {
                if (!branchGroups[item.branch]) {
                    branchGroups[item.branch] = [];
                }
                branchGroups[item.branch].push(item);
            });
            
            // Build single table with all branches
            const isMultipleBranches = Object.keys(branchGroups).length > 1;
            
            // Create single table structure
            let allRows = '';
            Object.keys(branchGroups).forEach(branchName => {
                const branchItems = branchGroups[branchName];
                
                // ALWAYS show branch name and headers (for BOTH single and multiple branches) - Dark teal
                allRows += `
                    <tr style="background-color: #00685c;">
                        <td colspan="5" style="text-align: center; padding: 10px; color: white; border-bottom: 5px solid white;">
                            <h5 style="font-size: 1.8rem; color: white; font-weight: 700; margin: 0;"> ${branchName}</h5>
                        </td>
                    </tr>
                    <tr style="background-color: #000000; font-weight: bold;">
                        <th style="background-color: #000000; color: white; text-align: left; padding: 10px; border-right: 2px solid white; border-left: 1px solid #333; border-top: 1px solid #333; border-bottom: 1px solid #333;">Category</th>
                        <th style="background-color: #000000; color: white; text-align: right; padding: 10px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Total Sales</th>
                        <th style="background-color: #000000; color: white; text-align: right; padding: 10px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Total Cost</th>
                        <th style="background-color: #000000; color: white; text-align: right; padding: 10px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Total Profit</th>
                        <th style="background-color: #000000; color: white; text-align: center; padding: 10px; border-top: 1px solid #333; border-bottom: 1px solid #333;">Profit Margin</th>
                    </tr>
                `;
                
                let branchTotalSales = 0, branchTotalCost = 0;
                branchItems.forEach(item => {
                    const profit = item.totalSales - item.totalCost;
                    const margin = item.totalSales > 0 ? (profit / item.totalSales * 100) : 0;
                    allRows += `
                        <tr>
                            <td style="padding: 10px;">${item.category}</td>
                            <td style="text-align: right; padding: 10px;">${item.totalSales.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${item.totalCost.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${profit.toLocaleString()}</td>
                            <td style="text-align: center; padding: 10px;">${margin.toFixed(1)}%</td>
                        </tr>
                    `;
                    branchTotalSales += item.totalSales;
                    branchTotalCost += item.totalCost;
                });
                const branchTotalProfit = branchTotalSales - branchTotalCost;
                const branchMargin = branchTotalSales > 0 ? (branchTotalProfit / branchTotalSales * 100) : 0;
                
                allRows += `
                    <tr style="background-color: #f0f0f0; font-weight: bold;">
                        <td style="padding: 12px 15px;"> ${branchName} TOTAL</td>
                        <td style="text-align: right; padding: 12px 15px;">${branchTotalSales.toLocaleString()}</td>
                        <td style="text-align: right; padding: 12px 15px;">${branchTotalCost.toLocaleString()}</td>
                        <td style="text-align: right; padding: 12px 15px;">${branchTotalProfit.toLocaleString()}</td>
                        <td style="text-align: center; padding: 12px 15px;">${branchMargin.toFixed(1)}%</td>
                    </tr>
                    <tr><td colspan="5" style="height: 15px; border: none;"></td></tr>
                `;
            });
            
            // No thead since we're adding headers inside for each branch
            const tableRows = `
                <table>
                    <tbody>
                        ${allRows}
                    </tbody>
                </table>
            `;
            
            return `
<!DOCTYPE html>
<html>
<head>
    <title>Sales Report - ${currentDate}</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #2c6e8a;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 28pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #2c6e8a;
        }
        
        .print-header .company-info {
            font-size: 11pt;
            color: #555;
            margin: 5px 0;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #2c6e8a 0%, #4fb3d9 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-card h4 {
            margin: 0 0 10px 0;
            font-size: 11pt;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .summary-card .value {
            font-size: 22pt;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .summary-card .label {
            font-size: 9pt;
            opacity: 0.9;
        }
        
        .report-section {
            margin-bottom: 25px;
        }
        
        .report-section h3 {
            font-size: 14pt;
            color: #2c6e8a;
            margin-bottom: 15px;
            border-bottom: 2px solid #2c6e8a;
            padding-bottom: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        th {
            background-color: #2c6e8a;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #1a4d63;
        }
        
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .print-footer {
            margin-top: 40px;
            text-align: center;
            font-size: 9pt;
            color: #666;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        
        @media print {
            body {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Sales Report</div>
        <div class="company-info">Branch: ${branchName} | Category: ${categoryName}</div>
        <div class="company-info">Period: ${dateRange}</div>
        <div class="company-info">Generated: ${currentDate}</div>
    </div>
    
    <div class="summary-cards">
        <div class="summary-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
            <h4>Total Sales</h4>
            <div class="value">${totalSales.toLocaleString()}</div>
            <div class="label">Revenue Generated</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #136F63 0%, #17a2b8 100%);">
            <h4>Total Cost</h4>
            <div class="value">${totalCost.toLocaleString()}</div>
            <div class="label">Cost of Goods Sold</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #CF2A2A 0%, #ff6b6b 100%);">
            <h4>Total Profit</h4>
            <div class="value">${totalProfit.toLocaleString()}</div>
            <div class="label">Net Profit Earned</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #4D4D4D 0%, #6c757d 100%);">
            <h4>Profit Margin</h4>
            <div class="value">${profitMargin.toFixed(1)}%</div>
            <div class="label">Profit Percentage</div>
        </div>
    </div>
    
    <div class="report-section">
        <h3> Detailed Sales Breakdown</h3>
        ${tableRows}
    </div>
    
    <div class="print-footer">
        <p>This report was generated by D.Watson Pharmacy Management System</p>
        <p> ${new Date().getFullYear()} D.Watson Group Of Pharmacies - All Rights Reserved</p>
    </div>
</body>
</html>
            `;
        }
        
        // Create Payment Report Print Content
        function createPaymentReportPrintContent(reportData, totalSales, totalCost, categoryPayments, balancePayment, branchName, categoryName, dateFrom, dateTo, categoryId = '') {
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = dateFrom && dateTo ? 
                `${new Date(dateFrom).toLocaleDateString('en-GB')} - ${new Date(dateTo).toLocaleDateString('en-GB')}` : 
                'All Time';
            
            // Determine grouping: if categoryId is empty (all categories), group by category; otherwise group by branch
            const shouldGroupByCategory = (categoryId === '');
            
            // Build single table with appropriate grouping
            let allRows = '';
            
            if (shouldGroupByCategory) {
                // Group by Category when all categories are selected
                const categoryGroups = {};
                reportData.forEach(item => {
                    if (!categoryGroups[item.category]) {
                        categoryGroups[item.category] = [];
                    }
                    categoryGroups[item.category].push(item);
                });
                
                Object.keys(categoryGroups).forEach(categoryName => {
                    const categoryItems = categoryGroups[categoryName];
                    
                    // Calculate category totals
                    let categoryTotalSales = 0, categoryTotalCost = 0, categoryTotalPayments = 0, categoryTotalBalance = 0;
                    categoryItems.forEach(item => {
                        categoryTotalSales += item.totalSales;
                        categoryTotalCost += item.totalCost;
                        categoryTotalPayments += item.categoryPayments;
                        categoryTotalBalance += item.balancePayment;
                    });
                    
                    // Show category name header - Dark teal
                    allRows += `
                        <tr style="background-color: #00685c;">
                            <td colspan="6" style="text-align: center; padding: 10px; color: white; border-bottom: 5px solid white;">
                                <h5 style="font-size: 1.8rem; color: white; font-weight: 700; margin: 0;"> ${categoryName}</h5>
                            </td>
                        </tr>
                        <tr style="background-color: #000000; font-weight: bold;">
                            <th style="background-color: #000000; color: white; text-align: left; padding: 10px; border-right: 2px solid white; border-left: 1px solid #333; border-top: 1px solid #333; border-bottom: 1px solid #333;">Category Name</th>
                            <th style="background-color: #000000; color: white; text-align: left; padding: 10px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Branch</th>
                            <th style="background-color: #000000; color: white; text-align: right; padding: 10px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Sale</th>
                            <th style="background-color: #000000; color: white; text-align: right; padding: 10px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Cost</th>
                            <th style="background-color: #000000; color: white; text-align: right; padding: 10px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Category Payments</th>
                            <th style="background-color: #000000; color: white; text-align: right; padding: 10px; border-top: 1px solid #333; border-bottom: 1px solid #333;">Balance Payment</th>
                        </tr>
                    `;
                    
                    categoryItems.forEach(item => {
                        allRows += `
                            <tr>
                                <td style="padding: 10px;">${item.category}</td>
                                <td style="padding: 10px;">${item.branch}</td>
                                <td style="text-align: right; padding: 10px;">${item.totalSales.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${item.totalCost.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${item.categoryPayments.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px; ${item.balancePayment >= 0 ? 'color: #28a745;' : 'color: #dc3545;'}">${item.balancePayment.toLocaleString()}</td>
                            </tr>
                        `;
                    });
                    
                    allRows += `
                        <tr style="background-color: #f0f0f0; font-weight: bold;">
                            <td colspan="2" style="padding: 12px 15px;"> ${categoryName} TOTAL</td>
                            <td style="text-align: right; padding: 12px 15px;">${categoryTotalSales.toLocaleString()}</td>
                            <td style="text-align: right; padding: 12px 15px;">${categoryTotalCost.toLocaleString()}</td>
                            <td style="text-align: right; padding: 12px 15px;">${categoryTotalPayments.toLocaleString()}</td>
                            <td style="text-align: right; padding: 12px 15px; ${categoryTotalBalance >= 0 ? 'color: #28a745;' : 'color: #dc3545;'}">${categoryTotalBalance.toLocaleString()}</td>
                        </tr>
                        <tr><td colspan="6" style="height: 15px; border: none;"></td></tr>
                    `;
                });
            } else {
                // Group by Branch when a specific category is selected
                const branchGroups = {};
                reportData.forEach(item => {
                    if (!branchGroups[item.branch]) {
                        branchGroups[item.branch] = [];
                    }
                    branchGroups[item.branch].push(item);
                });
                
                Object.keys(branchGroups).forEach(branchName => {
                    const branchItems = branchGroups[branchName];
                    
                    // ALWAYS show branch name and headers - Dark teal
                    allRows += `
                        <tr style="background-color: #00685c;">
                            <td colspan="6" style="text-align: center; padding: 10px; color: white; border-bottom: 5px solid white;">
                                <h5 style="font-size: 1.8rem; color: white; font-weight: 700; margin: 0;"> ${branchName}</h5>
                            </td>
                        </tr>
                        <tr style="background-color: #000000; font-weight: bold;">
                            <th style="background-color: #000000; color: white; text-align: left; padding: 10px; border-right: 2px solid white; border-left: 1px solid #333; border-top: 1px solid #333; border-bottom: 1px solid #333;">Category Name</th>
                            <th style="background-color: #000000; color: white; text-align: left; padding: 10px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Branch</th>
                            <th style="background-color: #000000; color: white; text-align: right; padding: 10px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Sale</th>
                            <th style="background-color: #000000; color: white; text-align: right; padding: 10px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Cost</th>
                            <th style="background-color: #000000; color: white; text-align: right; padding: 10px; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Category Payments</th>
                            <th style="background-color: #000000; color: white; text-align: right; padding: 10px; border-top: 1px solid #333; border-bottom: 1px solid #333;">Balance Payment</th>
                        </tr>
                    `;
                    
                    let branchTotalSales = 0, branchTotalCost = 0, branchCategoryPayments = 0, branchBalancePayment = 0;
                    branchItems.forEach(item => {
                        allRows += `
                            <tr>
                                <td style="padding: 10px;">${item.category}</td>
                                <td style="padding: 10px;">${item.branch}</td>
                                <td style="text-align: right; padding: 10px;">${item.totalSales.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${item.totalCost.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px;">${item.categoryPayments.toLocaleString()}</td>
                                <td style="text-align: right; padding: 10px; ${item.balancePayment >= 0 ? 'color: #28a745;' : 'color: #dc3545;'}">${item.balancePayment.toLocaleString()}</td>
                            </tr>
                        `;
                        branchTotalSales += item.totalSales;
                        branchTotalCost += item.totalCost;
                        branchCategoryPayments += item.categoryPayments;
                        branchBalancePayment += item.balancePayment;
                    });
                    
                    allRows += `
                        <tr style="background-color: #f0f0f0; font-weight: bold;">
                            <td colspan="2" style="padding: 12px 15px;"> ${branchName} TOTAL</td>
                            <td style="text-align: right; padding: 12px 15px;">${branchTotalSales.toLocaleString()}</td>
                            <td style="text-align: right; padding: 12px 15px;">${branchTotalCost.toLocaleString()}</td>
                            <td style="text-align: right; padding: 12px 15px;">${branchCategoryPayments.toLocaleString()}</td>
                            <td style="text-align: right; padding: 12px 15px; ${branchBalancePayment >= 0 ? 'color: #28a745;' : 'color: #dc3545;'}">${branchBalancePayment.toLocaleString()}</td>
                        </tr>
                        <tr><td colspan="6" style="height: 15px; border: none;"></td></tr>
                    `;
                });
            }
            
            const tableRows = `
                <table>
                    <tbody>
                        ${allRows}
                    </tbody>
                </table>
            `;
            
            return `
<!DOCTYPE html>
<html>
<head>
    <title>Payment Report - ${currentDate}</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #2c6e8a;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 28pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #2c6e8a;
        }
        
        .print-header .company-info {
            font-size: 11pt;
            color: #555;
            margin: 5px 0;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #2c6e8a 0%, #4fb3d9 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-card h4 {
            margin: 0 0 10px 0;
            font-size: 11pt;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .summary-card .value {
            font-size: 22pt;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .summary-card .label {
            font-size: 9pt;
            opacity: 0.9;
        }
        
        .report-section {
            margin-bottom: 25px;
        }
        
        .report-section h3 {
            font-size: 14pt;
            color: #2c6e8a;
            margin-bottom: 15px;
            border-bottom: 2px solid #2c6e8a;
            padding-bottom: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        th {
            background-color: #000000;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #333;
        }
        
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .print-footer {
            margin-top: 40px;
            text-align: center;
            font-size: 9pt;
            color: #666;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        
        @media print {
            body {
                padding: 0;
            }
            
            .summary-card {
                padding: 10px 12px !important;
            }
            
            .summary-card h4 {
                margin: 0 0 5px 0 !important;
                font-size: 10pt !important;
            }
            
            .summary-card .value {
                font-size: 18pt !important;
                margin: 5px 0 !important;
            }
            
            .summary-card .label {
                font-size: 8pt !important;
            }
            
            .summary-cards {
                gap: 10px !important;
                margin-bottom: 20px !important;
            }
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Payment Report</div>
        <div class="company-info">Branch: ${branchName} | Category: ${categoryName}</div>
        <div class="company-info">Period: ${dateRange}</div>
        <div class="company-info">Generated: ${currentDate}</div>
    </div>
    
    <div class="summary-cards">
        <div class="summary-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
            <h4>Total Sales</h4>
            <div class="value">${totalSales.toLocaleString()}</div>
            <div class="label">Revenue Generated</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #136F63 0%, #17a2b8 100%);">
            <h4>Total Cost</h4>
            <div class="value">${totalCost.toLocaleString()}</div>
            <div class="label">Cost of Goods Sold</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);">
            <h4>Category Payments</h4>
            <div class="value">${categoryPayments.toLocaleString()}</div>
            <div class="label">Total Payments Made</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #CF2A2A 0%, #ff6b6b 100%);">
            <h4>Balance Payment</h4>
            <div class="value">${balancePayment.toLocaleString()}</div>
            <div class="label">Cost - Payments</div>
        </div>
    </div>
    
    <div class="report-section">
        <h3> Detailed Payment Breakdown</h3>
        ${tableRows}
    </div>
    
    <div class="print-footer">
        <p>This report was generated by D.Watson Pharmacy Management System</p>
        <p> ${new Date().getFullYear()} D.Watson Group Of Pharmacies - All Rights Reserved</p>
    </div>
</body>
</html>
            `;
        }
        
        // Create Comparison Report Print Content
        function createComparisonReportPrintContent(reportData, branchName, categoryName, dateFrom, dateTo) {
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = dateFrom && dateTo ? 
                `${new Date(dateFrom).toLocaleDateString('en-GB')} - ${new Date(dateTo).toLocaleDateString('en-GB')}` : 
                'All Time';
            
            // Group by category for display
            const categoryGroups = {};
            reportData.forEach(item => {
                if (!categoryGroups[item.category]) {
                    categoryGroups[item.category] = [];
                }
                categoryGroups[item.category].push(item);
            });
            
            let tableRows = '';
            Object.keys(categoryGroups).forEach(categoryName => {
                const categoryItems = categoryGroups[categoryName];
                categoryItems.sort((a, b) => b.totalSales - a.totalSales);
                
                // Add category header with prominent styling - Dark teal
                tableRows += `
                    <tr style="background-color: #00685c;">
                        <td colspan="7" style="padding: 10px; font-weight: bold; font-size: 14pt; color: white; text-align: center; border-bottom: 5px solid white;">
                             ${categoryName}
                        </td>
                    </tr>
                `;
                
                // Add column headers row - Full black with white vertical borders
                tableRows += `
                    <tr style="background-color: #000000;">
                        <th style="padding: 10px; font-weight: bold; color: white; text-align: left; border-right: 2px solid white; border-left: 1px solid #333; border-top: 1px solid #333; border-bottom: 1px solid #333;">Rank</th>
                        <th style="padding: 10px; font-weight: bold; color: white; text-align: left; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Category</th>
                        <th style="padding: 10px; font-weight: bold; color: white; text-align: left; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Branch</th>
                        <th style="padding: 10px; font-weight: bold; color: white; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Total Sales</th>
                        <th style="padding: 10px; font-weight: bold; color: white; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Total Cost</th>
                        <th style="padding: 10px; font-weight: bold; color: white; text-align: right; border-right: 2px solid white; border-top: 1px solid #333; border-bottom: 1px solid #333;">Total Profit</th>
                        <th style="padding: 10px; font-weight: bold; color: white; text-align: center; border-top: 1px solid #333; border-bottom: 1px solid #333;">Profit Margin</th>
                    </tr>
                `;
                
                let catTotalSales = 0, catTotalCost = 0;
                let rowIndex = 1;
                categoryItems.forEach(item => {
                    catTotalSales += item.totalSales;
                    catTotalCost += item.totalCost;
                    const profit = item.totalSales - item.totalCost;
                    const margin = item.totalSales > 0 ? (profit / item.totalSales * 100) : 0;
                    tableRows += `
                        <tr>
                            <td style="padding: 10px;">${rowIndex++}</td>
                            <td style="padding: 10px;">${item.category}</td>
                            <td style="padding: 10px;">${item.branch}</td>
                            <td style="text-align: right; padding: 10px;">${item.totalSales.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;">${item.totalCost.toLocaleString()}</td>
                            <td style="text-align: right; padding: 10px;" class="${profit >= 0 ? 'text-success' : 'text-danger'}">${profit.toLocaleString()}</td>
                            <td style="text-align: center; padding: 10px;">${margin.toFixed(1)}%</td>
                        </tr>
                    `;
                });
                const catTotalProfit = catTotalSales - catTotalCost;
                const catMargin = catTotalSales > 0 ? (catTotalProfit / catTotalSales * 100) : 0;
                
                tableRows += `
                    <tr style="background-color: #f8f9fa; font-weight: bold;">
                        <td colspan="2" style="padding: 10px; text-align: right;">
                             Category Total:
                        </td>
                        <td style="padding: 10px;"></td>
                        <td style="text-align: right; padding: 10px;">${catTotalSales.toLocaleString()}</td>
                        <td style="text-align: right; padding: 10px;">${catTotalCost.toLocaleString()}</td>
                        <td style="text-align: right; padding: 10px;" class="${catTotalProfit >= 0 ? 'text-success' : 'text-danger'}">${catTotalProfit.toLocaleString()}</td>
                        <td style="text-align: center; padding: 10px;">${catMargin.toFixed(1)}%</td>
                    </tr>
                    <tr><td colspan="7" style="height: 20px; border: none; background: white;"></td></tr>
                `;
            });
            
            return `
<!DOCTYPE html>
<html>
<head>
    <title>Sales Comparison Report - ${currentDate}</title>
    <style>
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #00685c;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 28pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #00685c;
        }
        
        .print-header .company-info {
            font-size: 11pt;
            color: #555;
            margin: 5px 0;
        }
        
        .report-section {
            margin-bottom: 25px;
        }
        
        .report-section h3 {
            font-size: 14pt;
            color: #00685c;
            margin-bottom: 15px;
            border-bottom: 2px solid #00685c;
            padding-bottom: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        th {
            background-color: #000000;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #333;
        }
        
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .print-footer {
            margin-top: 40px;
            text-align: center;
            font-size: 9pt;
            color: #666;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        
        @media print {
            body {
                padding: 0;
            }
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Sales Comparison Report</div>
        <div class="company-info">Branch: ${branchName} | Category: ${categoryName}</div>
        <div class="company-info">Period: ${dateRange}</div>
        <div class="company-info">Generated: ${currentDate}</div>
    </div>
    
    <div class="report-section">
        <h3> Branch Performance Comparison</h3>
        <table>
            ${tableRows}
        </table>
    </div>
    
    <div class="print-footer">
        <p>This report was generated by D.Watson Pharmacy Management System</p>
        <p> ${new Date().getFullYear()} D.Watson Group Of Pharmacies - All Rights Reserved</p>
    </div>
</body>
</html>
            `;
        }
        
        // ========================================
        // BRANCH FUNCTIONS
        // ========================================
        
        // Load branches
        function loadBranches() {
            api.getBranches().then(branchesData => {
                appData.branches = branchesData;
                renderBranches(branchesData);
            }).catch(error => {
                console.error('Error loading branches:', error);
                showNotification('Failed to load branches', 'error');
            });
        }
        
        // Render branches in both card and table views
        function renderBranches(branchesData) {
            // Sort branches by creation date to maintain consistent order
            const sortedBranches = [...branchesData].sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            
            // Render card view
            const cardContainer = document.getElementById('branchesContainer');
            cardContainer.innerHTML = '';
            
            sortedBranches.forEach((branch, index) => {
                const card = document.createElement('div');
                card.className = 'col-md-4 mb-3';
                const branchNumber = index + 1;
                const fullId = branch._id; // Show full MongoDB ObjectId
                card.innerHTML = `
                    <div class="card branch-card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${branch.name}</h5>
                                <span class="badge bg-primary">#${branchNumber}</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">ID: ${fullId}</small>
                            </div>
                            <p class="card-text">
                                <i class="fas fa-map-marker-alt me-2"></i>${branch.address || 'N/A'}<br>
                                <i class="fas fa-phone me-2"></i>${branch.phone || 'N/A'}<br>
                                <i class="fas fa-envelope me-2"></i>${branch.email || 'N/A'}
                            </p>
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-primary" onclick="editBranch('${branch._id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteBranch('${branch._id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                cardContainer.appendChild(card);
            });
            
            // Render table view
            const tableBody = document.getElementById('branchesTableBody');
            tableBody.innerHTML = '';
            
            sortedBranches.forEach((branch, index) => {
                const row = document.createElement('tr');
                const createdDate = new Date(branch.createdAt).toLocaleDateString();
                const branchNumber = index + 1;
                const fullId = branch._id; // Show full MongoDB ObjectId
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-primary me-2">#${branchNumber}</span>
                            <strong>${branch.name}</strong>
                        </div>
                        <small class="text-muted">ID: ${fullId}</small>
                    </td>
                    <td>${branch.address || 'N/A'}</td>
                    <td>${branch.phone || 'N/A'}</td>
                    <td>${branch.email || 'N/A'}</td>
                    <td>${createdDate}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editBranch('${branch._id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBranch('${branch._id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Save branch
        function saveBranch() {
            const branchData = {
                name: document.getElementById('branchName').value.trim(),
                address: document.getElementById('branchAddress').value,
                phone: document.getElementById('branchPhone').value,
                email: document.getElementById('branchEmail').value
            };
            
            api.createBranch(branchData).then(branch => {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addBranchModal')).hide();
                
                // Reset form
                document.getElementById('branchForm').reset();
                
                // Show notification
                showNotification('Branch saved successfully!', 'success');
                
                // Update dropdowns
                populateBranchSelectors();
                
                // Reload branches
                loadBranches();
                loadDashboard();
            }).catch(error => {
                console.error('Error saving branch:', error);
                showNotification('Failed to save branch', 'error');
            });
        }
        
        // ========================================
        // SUPPLIER FUNCTIONS
        // ========================================
        
        // Save supplier
        function saveSupplier() {
            const supplierData = {
                name: document.getElementById('supplierName').value.trim(),
                description: document.getElementById('supplierDescription').value,
                contact: document.getElementById('supplierContact').value,
                phone: document.getElementById('supplierPhone').value,
                email: document.getElementById('supplierEmail').value,
                address: document.getElementById('supplierAddress').value
            };
            
            api.createSupplier(supplierData).then(supplier => {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addSupplierModal')).hide();
                
                // Reset form
                document.getElementById('supplierForm').reset();
                
                // Show notification
                showNotification('Supplier saved successfully!', 'success');
                
                // Update dropdowns
                populatePaymentVoucherDropdowns();
                populatePaymentModuleFilters();
                
                // Reload suppliers
                loadSuppliers();
            }).catch(error => {
                console.error('Error saving supplier:', error);
                // Check if it's a duplicate name error
                if (error.message && (error.message.includes('duplicate key') || error.message.includes('already exists'))) {
                    showNotification('Supplier name already exists. Please use a different name.', 'error');
                } else {
                    showNotification('Failed to save supplier: ' + (error.message || 'Unknown error'), 'error');
                }
            });
        }
        
        // Load suppliers
        function loadSuppliers() {
            api.getSuppliers().then(suppliersData => {
                appData.suppliers = suppliersData;
                renderSuppliers(suppliersData);
            }).catch(error => {
                console.error('Error loading suppliers:', error);
                showNotification('Failed to load suppliers', 'error');
            });
        }
        
        // Render suppliers in both card and table views
        function renderSuppliers(suppliersData) {
            // Sort suppliers by creation date
            const sortedSuppliers = [...suppliersData].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Render card view
            const cardContainer = document.getElementById('suppliersContainer');
            if (!cardContainer) return;
            cardContainer.innerHTML = '';
            
            if (sortedSuppliers.length === 0) {
                cardContainer.innerHTML = '<div class="col-12"><div class="alert alert-info">No suppliers found. Click "Add Supplier" to create one.</div></div>';
                // Also update table view
                const tableBody = document.getElementById('suppliersTableBody');
                if (tableBody) tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No suppliers found</td></tr>';
                return;
            }
            
            sortedSuppliers.forEach((supplier, index) => {
                const card = document.createElement('div');
                card.className = 'col-md-4 mb-3';
                
                card.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${supplier.name}</h5>
                                <span class="badge bg-primary">#${index + 1}</span>
                            </div>
                            <p class="card-text text-muted small mb-2">${supplier.description || 'No description'}</p>
                            <div class="mb-2">
                                ${supplier.contact ? `<small class="text-muted"><i class="fas fa-user"></i> ${supplier.contact}</small><br>` : ''}
                                ${supplier.phone ? `<small class="text-muted"><i class="fas fa-phone"></i> ${supplier.phone}</small><br>` : ''}
                                ${supplier.email ? `<small class="text-muted"><i class="fas fa-envelope"></i> ${supplier.email}</small><br>` : ''}
                                ${supplier.address ? `<small class="text-muted"><i class="fas fa-map-marker-alt"></i> ${supplier.address}</small>` : ''}
                            </div>
                            <div class="d-flex justify-content-between mt-3">
                                <button class="btn btn-sm btn-outline-primary" onclick="editSupplier('${supplier._id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteSupplier('${supplier._id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                cardContainer.appendChild(card);
            });
            
            // Render table view
            const tableBody = document.getElementById('suppliersTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            sortedSuppliers.forEach((supplier, index) => {
                const row = document.createElement('tr');
                const createdDate = new Date(supplier.createdAt).toLocaleDateString();
                
                row.innerHTML = `
                    <td><strong>${supplier.name}</strong></td>
                    <td>${supplier.description || 'No description'}</td>
                    <td>${supplier.contact || '-'}</td>
                    <td>${supplier.phone || '-'}</td>
                    <td>${supplier.email || '-'}</td>
                    <td>${createdDate}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editSupplier('${supplier._id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSupplier('${supplier._id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Edit supplier
        function editSupplier(id) {
            api.getSuppliers().then(suppliersData => {
                const supplier = suppliersData.find(s => s._id === id);
                if (supplier) {
                    document.getElementById('supplierName').value = supplier.name || '';
                    document.getElementById('supplierDescription').value = supplier.description || '';
                    document.getElementById('supplierContact').value = supplier.contact || '';
                    document.getElementById('supplierPhone').value = supplier.phone || '';
                    document.getElementById('supplierEmail').value = supplier.email || '';
                    document.getElementById('supplierAddress').value = supplier.address || '';
                    
                    // Update modal title for EDIT mode
                    document.getElementById('addSupplierModalLabel').textContent = 'Edit Supplier';
                    
                    // FORCE SET save button to update mode
                    const saveBtn = document.getElementById('saveSupplierBtn');
                    if (saveBtn) {
                        saveBtn.textContent = 'Update Supplier';
                        
                        // Remove ALL existing event handlers
                        saveBtn.onclick = null;
                        saveBtn.removeAttribute('onclick');
                        
                        // Create a new function that calls updateSupplier with validation
                        const updateSupplierHandler = function() {
                            if (document.getElementById('supplierForm').checkValidity()) {
                                updateSupplier(id);
                            } else {
                                document.getElementById('supplierForm').reportValidity();
                            }
                        };
                        
                        // Set the new handler
                        saveBtn.onclick = updateSupplierHandler;
                    }
                    
                    const modal = new bootstrap.Modal(document.getElementById('addSupplierModal'));
                    modal.show();
                }
            }).catch(error => {
                console.error('Error loading supplier for editing:', error);
                showNotification('Failed to load supplier details', 'error');
            });
        }
        
        // Update supplier
        function updateSupplier(id) {
            const supplierData = {
                name: document.getElementById('supplierName').value.trim(),
                description: document.getElementById('supplierDescription').value,
                contact: document.getElementById('supplierContact').value,
                phone: document.getElementById('supplierPhone').value,
                email: document.getElementById('supplierEmail').value,
                address: document.getElementById('supplierAddress').value
            };
            
            api.updateSupplier(id, supplierData).then(() => {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addSupplierModal')).hide();
                
                // Reset form and modal title
                document.getElementById('supplierForm').reset();
                document.getElementById('addSupplierModalLabel').textContent = 'Add New Supplier';
                
                // Show notification
                showNotification('Supplier updated successfully!', 'success');
                
                // Update dropdowns
                populatePaymentVoucherDropdowns();
                populatePaymentModuleFilters();
                
                // Reload suppliers
                loadSuppliers();
            }).catch(error => {
                console.error('Error updating supplier:', error);
                // Check if it's a duplicate name error
                if (error.message && (error.message.includes('duplicate key') || error.message.includes('already exists'))) {
                    showNotification('Supplier name already exists. Please use a different name.', 'error');
                } else {
                    showNotification('Failed to update supplier: ' + (error.message || 'Unknown error'), 'error');
                }
            });
        }
        
        // Delete supplier
        function deleteSupplier(id) {
            if (confirm('Are you sure you want to delete this supplier? This action cannot be undone.')) {
                api.deleteSupplier(id).then(() => {
                    showNotification('Supplier deleted successfully!', 'success');
                    
                    // Update dropdowns
                    populatePaymentVoucherDropdowns();
                    populatePaymentModuleFilters();
                    
                    // Reload suppliers
                    loadSuppliers();
                }).catch(error => {
                    console.error('Error deleting supplier:', error);
                    showNotification('Failed to delete supplier: ' + (error.message || 'Unknown error'), 'error');
                });
            }
        }
        
        // Edit branch
        function editBranch(id) {
            api.getBranches().then(branchesData => {
                const branch = branchesData.find(b => b._id === id);
                if (branch) {
                    document.getElementById('branchName').value = branch.name;
                    document.getElementById('branchAddress').value = branch.address || '';
                    document.getElementById('branchPhone').value = branch.phone || '';
                    document.getElementById('branchEmail').value = branch.email || '';
                    
                    // Change save button to update
                    const saveBtn = document.getElementById('saveBranchBtn');
                    saveBtn.textContent = 'Update Branch';
                    saveBtn.onclick = function() {
                        if (document.getElementById('branchForm').checkValidity()) {
                        updateBranch(id);
                        } else {
                            document.getElementById('branchForm').reportValidity();
                        }
                    };
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('addBranchModal'));
                    modal.show();
                }
            }).catch(error => {
                console.error('Error fetching branch data:', error);
                showNotification('Failed to load branch data', 'error');
            });
        }
        
        // Update branch
        function updateBranch(id) {
            const branchData = {
                name: document.getElementById('branchName').value,
                address: document.getElementById('branchAddress').value,
                phone: document.getElementById('branchPhone').value,
                email: document.getElementById('branchEmail').value
            };
            
            api.updateBranch(id, branchData).then(() => {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addBranchModal')).hide();
                
                // Reset form
                document.getElementById('branchForm').reset();
                
                // Reset save button
                const saveBtn = document.getElementById('saveBranchBtn');
                saveBtn.textContent = 'Save Branch';
                saveBtn.onclick = saveBranch;
                
                // Show notification
                showNotification('Branch updated successfully!', 'success');
                
                // Update dropdowns
                populateBranchSelectors();
                
                // Reload branches
                loadBranches();
                loadDashboard();
            }).catch(error => {
                console.error('Error updating branch:', error);
                showNotification('Failed to update branch', 'error');
            });
        }
        
        // Delete branch
        function deleteBranch(id) {
            if (confirm('Are you sure you want to delete this branch? This will also delete all sales data for this branch.')) {
                api.deleteBranch(id).then(() => {
                    showNotification('Branch deleted successfully!', 'success');
                    
                    // Update dropdowns
                    populateBranchSelectors();
                    
                    // Reload branches
                    loadBranches();
                    loadDashboard();
                }).catch(error => {
                    console.error('Error deleting branch:', error);
                    showNotification('Failed to delete branch', 'error');
                });
            }
        }
        
        // ========================================
        // GROUP FUNCTIONS
        // ========================================
        
        // Load groups
        // Setup permission category collapse/expand functionality
        function setupPermissionCategories() {
            document.querySelectorAll('.permission-category-header[data-bs-toggle="collapse"]').forEach(header => {
                // Remove Bootstrap's default behavior
                header.removeAttribute('data-bs-toggle');
                
                // Function to toggle collapse
                const toggleCollapse = function(element) {
                    const targetId = element.getAttribute('data-bs-target');
                    const target = document.querySelector(targetId);
                    
                    if (target) {
                        const hasShowClass = target.classList.contains('show');
                        const ariaExpanded = element.getAttribute('aria-expanded') === 'true';
                        const isExpanded = hasShowClass || ariaExpanded;
                        
                        if (isExpanded) {
                            target.classList.remove('show');
                            element.setAttribute('aria-expanded', 'false');
                        } else {
                            target.classList.add('show');
                            element.setAttribute('aria-expanded', 'true');
                        }
                    }
                };
                
                // Handle clicks on the header
                header.addEventListener('click', function(e) {
                    if (e.target.closest('.permission-chevron')) {
                        return;
                    }
                    e.preventDefault();
                    e.stopPropagation();
                    toggleCollapse(this);
                });
                
                // Handle clicks on the chevron
                const chevron = header.querySelector('.permission-chevron');
                if (chevron) {
                    chevron.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        toggleCollapse(header);
                    });
                }
            });
        }
        
        function loadGroups() {
            // Check if user is admin
            if (!isAdmin()) {
                document.getElementById('permission-denied-banner').classList.remove('d-none');
                return;
            }
            
            // Hide permission denied banner
            document.getElementById('permission-denied-banner').classList.add('d-none');
            
            api.getGroups().then(groupsData => {
                appData.groups = groupsData;
                renderGroups(groupsData);
            }).catch(error => {
                console.error('Error loading groups:', error);
                showNotification('Failed to load groups: ' + error.message, 'error');
            });
        }
        
        // Render groups in table view (matching reference image)
        function renderGroups(groupsData) {
            // Render table view
            const tableBody = document.getElementById('groupsTableBody');
            if (!tableBody) {
                console.error('groupsTableBody not found');
                return;
            }
            
            tableBody.innerHTML = '';
            
            if (!groupsData || groupsData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No groups found</td></tr>';
                return;
            }
            
            groupsData.forEach(group => {
                const row = document.createElement('tr');
                const isActive = group.isActive !== false; // Default to true if not specified
                
                row.innerHTML = `
                    <td><strong>${group.name || 'Unnamed'}</strong></td>
                    <td>${isActive ? 'true' : 'false'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editGroup('${group._id}')" title="Edit">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteGroup('${group._id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Save group (using new form structure)
        function saveGroup() {
            // Check if user is admin
            if (!isAdmin()) {
                showNotification('You need admin privileges to create groups', 'error');
                return;
            }
            
            const groupNameInput = document.getElementById('groupNameInput');
            const groupActiveCheckbox = document.getElementById('groupActiveCheckbox');
            
            if (!groupNameInput) {
                console.error('groupNameInput not found');
                return;
            }
            
            const groupName = groupNameInput.value.trim();
            if (!groupName) {
                showNotification('Group name is required', 'error');
                return;
            }
            
            // Get selected permissions from the permissions checklist
            const permissions = [];
            document.querySelectorAll('#permissionsChecklist .permission-checkbox:checked').forEach(checkbox => {
                const permission = checkbox.getAttribute('data-permission');
                if (permission) {
                    permissions.push(permission);
                }
            });
            
            const groupData = {
                name: groupName,
                isActive: groupActiveCheckbox ? groupActiveCheckbox.checked : true,
                permissions: permissions
            };
            
            // Check if we're editing (has currentGroupId)
            const currentGroupId = window.currentGroupId;
            
            if (currentGroupId) {
                // Update existing group
                api.updateGroup(currentGroupId, groupData).then(group => {
                    showNotification('Group updated successfully!', 'success');
                    resetGroupForm();
                    loadGroups();
                }).catch(error => {
                    console.error('Error updating group:', error);
                    showNotification('Failed to update group: ' + error.message, 'error');
                });
            } else {
                // Create new group
                api.createGroup(groupData).then(group => {
                    showNotification('Group saved successfully!', 'success');
                    resetGroupForm();
                    
                    // Scroll to top of form
                    const formContainer = document.querySelector('.group-form-container');
                    if (formContainer) {
                        formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    
                    // Refresh current user data to get latest permissions
                    api.getCurrentUser().then(updatedUser => {
                        appData.currentUser = {
                            ...updatedUser,
                            permissions: updatedUser.groupId?.permissions || []
                        };
                        updateCurrentUserUI();
                        updateSidebarPermissions();
                        populateBranchSelectors();
                        
                        // Reload groups
                        loadGroups();
                    }).catch(error => {
                        console.error('Error refreshing user data:', error);
                        loadGroups();
                    });
                }).catch(error => {
                    console.error('Error saving group:', error);
                    showNotification('Failed to save group: ' + error.message, 'error');
                });
            }
        }
        
        // Reset group form
        function resetGroupForm() {
            const groupNameInput = document.getElementById('groupNameInput');
            const groupActiveCheckbox = document.getElementById('groupActiveCheckbox');
            const saveBtn = document.getElementById('saveGroupBtn');
            const saveBtnText = document.getElementById('saveGroupBtnText');
            const cancelBtn = document.getElementById('cancelGroupBtn');
            
            if (groupNameInput) groupNameInput.value = '';
            if (groupActiveCheckbox) groupActiveCheckbox.checked = true;
            
            // Uncheck all permissions
            document.querySelectorAll('#permissionsChecklist .permission-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.disabled = false;
                checkbox.title = '';
            });
            
            // Reset save button text
            if (saveBtnText) saveBtnText.textContent = 'Save';
            if (cancelBtn) cancelBtn.style.display = 'none';
            
            // Clear current group ID
            window.currentGroupId = null;
        }
        
        // Edit group
        function editGroup(id) {
            // Check if user is admin - with additional verification
            if (!isAdmin()) {
                // Double-check by refreshing user data
                api.getCurrentUser().then(updatedUser => {
                    appData.currentUser = {
                        ...updatedUser,
                        permissions: updatedUser.permissions || updatedUser.groupId?.permissions || []
                    };
                    
                    if (!appData.currentUser.permissions.includes('admin')) {
                        showNotification('You need admin privileges to edit groups', 'error');
                        return;
                    }
                    
                    // If admin, proceed with editing
                    proceedWithEditGroup(id);
                }).catch(error => {
                    console.error('Error refreshing user data:', error);
                    showNotification('You need admin privileges to edit groups', 'error');
                });
            } else {
                // User is admin, proceed with editing
                proceedWithEditGroup(id);
            }
        }
        
        // Helper function to proceed with group editing
        function proceedWithEditGroup(id) {
            api.getGroups().then(groupsData => {
                const group = groupsData.find(g => g._id === id);
                if (group) {
                    // Set current group ID for update
                    window.currentGroupId = id;
                    
                    // Populate form fields
                    const groupNameInput = document.getElementById('groupNameInput');
                    const groupActiveCheckbox = document.getElementById('groupActiveCheckbox');
                    
                    if (groupNameInput) groupNameInput.value = group.name || '';
                    if (groupActiveCheckbox) groupActiveCheckbox.checked = group.isActive !== false;
                    
                    // Set permissions checkboxes in the permissions checklist
                    document.querySelectorAll('#permissionsChecklist .permission-checkbox').forEach(checkbox => {
                        const permission = checkbox.getAttribute('data-permission');
                        checkbox.checked = group.permissions && group.permissions.includes(permission);
                        
                        // If editing Admin group, prevent unchecking the 'admin' permission
                        if (group.name && group.name.toLowerCase() === 'admin' && permission === 'admin') {
                            checkbox.checked = true;
                            checkbox.disabled = true;
                            checkbox.title = 'Admin permission cannot be removed from Admin group';
                        } else {
                            checkbox.disabled = false;
                            checkbox.title = '';
                        }
                    });
                    
                    // Change save button text to indicate update mode
                    const saveBtn = document.getElementById('saveGroupBtn');
                    const saveBtnText = document.getElementById('saveGroupBtnText');
                    const cancelBtn = document.getElementById('cancelGroupBtn');
                    
                    if (saveBtnText) {
                        saveBtnText.textContent = 'Update';
                    }
                    if (cancelBtn) {
                        cancelBtn.style.display = 'inline-block';
                    }
                    
                    // Scroll to form
                    const formContainer = document.querySelector('.group-form-container');
                    if (formContainer) {
                        formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            }).catch(error => {
                console.error('Error fetching group data:', error);
                showNotification('Failed to load group data: ' + error.message, 'error');
            });
        }
        
        // Note: updateGroup function removed - now using saveGroup() which handles both create and update
        
        // Delete group
        function deleteGroup(id) {
            // Check if user is admin
            if (!isAdmin()) {
                showNotification('You need admin privileges to delete groups', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this group? This will affect all users assigned to this group.')) {
                api.deleteGroup(id).then(() => {
                    showNotification('Group deleted successfully!', 'success');
                    
                    // First refresh current user data to get latest permissions
                    api.getCurrentUser().then(updatedUser => {
                        appData.currentUser = {
                            ...updatedUser,
                            permissions: updatedUser.groupId?.permissions || []
                        };
                        updateCurrentUserUI();
                        updateSidebarPermissions();
                        populateBranchSelectors();
                        
                        // Then reload groups with updated permissions
                        loadGroups();
                    }).catch(error => {
                        console.error('Error refreshing user data:', error);
                        // If refresh fails, still try to reload groups
                        loadGroups();
                    });
                }).catch(error => {
                    console.error('Error deleting group:', error);
                    showNotification('Failed to delete group: ' + error.message, 'error');
                });
            }
        }
        
        // Delete user
        function deleteUser(id) {
            // Check if user is admin
            if (!isAdmin()) {
                showNotification('You need admin privileges to delete users', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                api.deleteUser(id).then(() => {
                    showNotification('User deleted successfully!', 'success');
                    
                    // Reload users
                    loadUsers();
                }).catch(error => {
                    console.error('Error deleting user:', error);
                    showNotification('Failed to delete user: ' + error.message, 'error');
                });
            }
        }
        
        // ========================================
        // USER FUNCTIONS
        // ========================================
        
        // Load users
        function loadUsers() {
            // Check if user is admin
            if (!isAdmin()) {
                document.getElementById('permission-denied-banner-users').classList.remove('d-none');
                return;
            }
            
            // Hide permission denied banner
            document.getElementById('permission-denied-banner-users').classList.add('d-none');
            
            // Ensure groups and branches are loaded first
            const loadUsersData = async () => {
                // Double-check admin permission inside the async function
                if (!isAdmin()) {
                    return;
                }
                
                try {
                    // Load groups if not already loaded
                    if (!appData.groups || appData.groups.length === 0) {
                        const groupsData = await api.getGroups();
                        appData.groups = groupsData;
                    }
                    
                    // Load branches if not already loaded
                    if (!appData.branches || appData.branches.length === 0) {
                        const branchesData = await api.getBranches();
                        appData.branches = branchesData;
                    }
                    
                    // Now load users
                    const usersData = await api.getUsers();
                    appData.users = usersData;
                    renderUsers(usersData);
                } catch (error) {
                    console.error('Error loading users:', error);
                    showNotification('Failed to load users: ' + error.message, 'error');
                }
            };
            
            loadUsersData();
        }
        
        // Render users in both card and table views
        function renderUsers(usersData) {
            // Render card view
            const cardContainer = document.getElementById('usersContainer');
            cardContainer.innerHTML = '';
            
            usersData.forEach(user => {
                const card = document.createElement('div');
                card.className = 'col-12 col-md-6 col-lg-4 mb-3';
                
                // Get user group
                let groupName = 'None';
                if (user.groupId) {
                    // Check if groupId is populated (object) or just an ID (string)
                    if (typeof user.groupId === 'object' && user.groupId.name) {
                        // Group is already populated from backend
                        groupName = user.groupId.name;
                    } else {
                        // Group is just an ID, find it in appData.groups
                        const userGroup = appData.groups.find(g => g._id === user.groupId);
                        groupName = userGroup ? userGroup.name : 'None';
                    }
                }
                
                // Get user branches
                let branchNames = 'None';
                if (user.branches && user.branches.length > 0) {
                    branchNames = user.branches.map(branchId => {
                        const branch = appData.branches.find(b => b._id === branchId);
                        return branch ? branch.name : 'Unknown';
                    }).join(', ');
                }
                
                card.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <div class="user-info">
                                <div class="user-avatar">${user.fullName ? user.fullName.charAt(0).toUpperCase() : user.username.charAt(0).toUpperCase()}</div>
                                <div class="user-details">
                                    <h5>${user.fullName || user.username}</h5>
                                    <p>${user.email}</p>
                                </div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Group:</small>
                                <div>${groupName}</div>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Assigned Branches:</small>
                                <div>${branchNames}</div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-primary" onclick="editUser('${user._id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                ${user._id === appData.currentUser._id ? 
                                    '<button class="btn btn-sm btn-outline-secondary" disabled title="You cannot delete your own account">' +
                                        '<i class="fas fa-trash"></i> Delete' +
                                    '</button>' :
                                    '<button class="btn btn-sm btn-outline-danger" onclick="deleteUser(\'' + user._id + '\')">' +
                                        '<i class="fas fa-trash"></i> Delete' +
                                    '</button>'
                                }
                            </div>
                        </div>
                    </div>
                `;
                cardContainer.appendChild(card);
            });
            
            // Render table view
            const tableBody = document.getElementById('usersTableBody');
            tableBody.innerHTML = '';
            
            usersData.forEach(user => {
                const row = document.createElement('tr');
                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never';
                const status = user.isActive ? 'Active' : 'Inactive';
                const statusClass = user.isActive ? 'success' : 'secondary';
                
                // Get user group
                let groupName = 'None';
                if (user.groupId) {
                    if (typeof user.groupId === 'object' && user.groupId.name) {
                        groupName = user.groupId.name;
                    } else {
                        const userGroup = appData.groups.find(g => g._id === user.groupId);
                        groupName = userGroup ? userGroup.name : 'None';
                    }
                }
                
                row.innerHTML = `
                    <td><strong>${user.username}</strong></td>
                    <td>${user.fullName || 'N/A'}</td>
                    <td>${user.email}</td>
                    <td><span class="badge bg-primary">${groupName}</span></td>
                    <td><span class="badge bg-${statusClass}">${status}</span></td>
                    <td>${lastLogin}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editUser('${user._id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        ${user._id === appData.currentUser._id ? 
                            '<button class="btn btn-sm btn-outline-secondary" disabled title="You cannot delete your own account">' +
                                '<i class="fas fa-trash"></i> Delete' +
                            '</button>' :
                            '<button class="btn btn-sm btn-outline-danger" onclick="deleteUser(\'' + user._id + '\')">' +
                                '<i class="fas fa-trash"></i> Delete' +
                            '</button>'
                        }
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Save user
        function saveUser() {
            // Check if user is admin
            if (!isAdmin()) {
                showNotification('You need admin privileges to create users', 'error');
                return;
            }
            
            // Get selected branches
            const branches = [];
            document.querySelectorAll('#userBranchesSelector input[type="checkbox"]:checked').forEach(checkbox => {
                branches.push(checkbox.value);
            });
            
            // Get selected group
            const groupId = document.getElementById('userGroup').value;
            
            // Validate required fields
            const username = document.getElementById('userName').value.trim();
            const fullName = document.getElementById('userFullName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            
            if (!username || !fullName || !email || !password || !groupId) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            const userData = {
                username: username,
                fullName: fullName,
                email: email,
                password: password,
                groupId: groupId,
                branches: branches
            };
            
            
            api.createUser(userData).then(user => {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                
                // Reset form
                document.getElementById('userForm').reset();
                
                // Uncheck all branches
                document.querySelectorAll('#userBranchesSelector input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Show notification
                showNotification('User saved successfully!', 'success');
                
                // Reload groups and branches to ensure we have the latest data
                Promise.all([
                    api.getGroups(),
                    api.getBranches()
                ]).then(([groupsData, branchesData]) => {
                    appData.groups = groupsData;
                    appData.branches = branchesData;
                    // Now reload users
                    loadUsers();
                }).catch(error => {
                    console.error('Error reloading groups and branches:', error);
                    // Even if there's an error, try to reload users
                    loadUsers();
                });
            }).catch(error => {
                console.error('Error saving user:', error);
                showNotification('Failed to save user: ' + error.message, 'error');
            });
        }
        
        // Edit user
        function editUser(id) {
            // Check if user is admin
            if (!isAdmin()) {
                showNotification('You need admin privileges to edit users', 'error');
                return;
            }
            
            api.getUsers().then(usersData => {
                const user = usersData.find(u => u._id === id);
                if (user) {
                    document.getElementById('userName').value = user.username;
                    document.getElementById('userFullName').value = user.fullName || '';
                    document.getElementById('userEmail').value = user.email || '';
                    document.getElementById('userPassword').value = ''; // Don't show password for security
                    
                    // Handle groupId - it might be populated (object) or just an ID (string)
                    let groupIdValue = '';
                    if (user.groupId) {
                        if (typeof user.groupId === 'object' && user.groupId._id) {
                            // Group is populated, use the _id
                            groupIdValue = user.groupId._id;
                        } else {
                            // Group is just an ID
                            groupIdValue = user.groupId;
                        }
                    }
                    document.getElementById('userGroup').value = groupIdValue;
                    
                    // First populate the branch selector (this creates the checkboxes)
                    populateBranchSelectorInUserModal();
                    
                    // Then set the checkboxes for the user's assigned branches
                    setTimeout(() => {
                        document.querySelectorAll('#userBranchesSelector input[type="checkbox"]').forEach(checkbox => {
                            checkbox.checked = user.branches && user.branches.includes(checkbox.value);
                        });
                    }, 100); // Small delay to ensure DOM is updated
                    
                    // Change save button to update
                    const saveBtn = document.getElementById('saveUserBtn');
                    saveBtn.textContent = 'Update User';
                    saveBtn.onclick = function() {
                        if (document.getElementById('userForm').checkValidity()) {
                        updateUser(id);
                        } else {
                            document.getElementById('userForm').reportValidity();
                        }
                    };
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
                    modal.show();
                }
            }).catch(error => {
                console.error('Error fetching user data:', error);
                showNotification('Failed to load user data: ' + error.message, 'error');
            });
        }
        
        // Update user
        function updateUser(id) {
            // Check if user is admin
            if (!isAdmin()) {
                showNotification('You need admin privileges to update users', 'error');
                return;
            }
            
            // Get selected branches
            const branches = [];
            document.querySelectorAll('#userBranchesSelector input[type="checkbox"]:checked').forEach(checkbox => {
                branches.push(checkbox.value);
            });
            
            // Get selected group
            const groupId = document.getElementById('userGroup').value;
            
            // Validate required fields
            const username = document.getElementById('userName').value.trim();
            const fullName = document.getElementById('userFullName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            
            if (!username || !fullName || !email || !groupId) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            const userData = {
                username: username,
                fullName: fullName,
                email: email,
                groupId: groupId,
                branches: branches
            };
            
            // Only include password if it's provided
            const password = document.getElementById('userPassword').value;
            if (password) {
                userData.password = password;
            }
            
            
            api.updateUser(id, userData).then(() => {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                
                // Reset form
                document.getElementById('userForm').reset();
                
                // Uncheck all branches
                document.querySelectorAll('#userBranchesSelector input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Reset save button
                const saveBtn = document.getElementById('saveUserBtn');
                saveBtn.textContent = 'Save User';
                saveBtn.onclick = saveUser;
                
                // Show notification
                showNotification('User updated successfully!', 'success');
                
                // Reload groups and branches to ensure we have the latest data
                Promise.all([
                    api.getGroups(),
                    api.getBranches()
                ]).then(([groupsData, branchesData]) => {
                    appData.groups = groupsData;
                    appData.branches = branchesData;
                    // Now reload users
                    loadUsers();
                    
                    // Update current user data if the current user was updated
                    if (appData.currentUser && appData.currentUser._id === id) {
                        appData.currentUser = { 
                            ...appData.currentUser, 
                            ...userData,
                            permissions: userData.groupId?.permissions || appData.currentUser.permissions
                        };
                        updateCurrentUserUI();
                        updateSidebarPermissions();
                        populateBranchSelectors();
                    }
                }).catch(error => {
                    console.error('Error reloading groups and branches:', error);
                    // Even if there's an error, try to reload users
                    loadUsers();
                    
                    // Update current user data if the current user was updated
                    if (appData.currentUser && appData.currentUser._id === id) {
                        appData.currentUser = { 
                            ...appData.currentUser, 
                            ...userData,
                            permissions: userData.groupId?.permissions || appData.currentUser.permissions
                        };
                        updateCurrentUserUI();
                        updateSidebarPermissions();
                        populateBranchSelectors();
                    }
                });
            }).catch(error => {
                console.error('Error updating user:', error);
                showNotification('Failed to update user: ' + error.message, 'error');
            });
        }
        
        // Promote user to admin
        async function promoteUserToAdmin() {
            const username = document.getElementById('promoteUsername').value.trim();
            const adminPassword = document.getElementById('confirmAdminPassword').value;
            const errorElement = document.getElementById('promoteUserError');
            
            try {
                // Show loading state
                const submitBtn = document.getElementById('confirmPromoteBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Promoting...';
                submitBtn.disabled = true;
                
                // First, check if user exists
                const userInfo = await api.getUserByUsername(username);
                
                // Attempt promotion
                const response = await api.promoteUser(username, adminPassword);
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('promoteUserModal')).hide();
                
                // Reset form
                document.getElementById('promoteUserForm').reset();
                errorElement.classList.add('d-none');
                
                // Show success notification
                showNotification(`User "${username}" has been successfully promoted to admin!`, 'success');
                
                // Reload users to show updated permissions
                loadUsers();
                
            } catch (error) {
                console.error('Error promoting user:', error);
                
                // Show error message
                errorElement.textContent = error.message || 'Failed to promote user. Please check the username and admin password.';
                errorElement.classList.remove('d-none');
                
                // Reset button
                const submitBtn = document.getElementById('confirmPromoteBtn');
                submitBtn.innerHTML = '<i class="fas fa-crown me-2"></i>Promote to Admin';
                submitBtn.disabled = false;
            }
        }
        
        // Load settings
        function loadSettings() {
            // Check if user is admin
            if (!isAdmin()) {
                document.getElementById('permission-denied-banner-settings').classList.remove('d-none');
                return;
            }
            
            // Hide permission denied banner
            document.getElementById('permission-denied-banner-settings').classList.add('d-none');
            
            api.getSettings().then(settingsData => {
                appData.settings = settingsData;
                const companyNameEl = document.getElementById('companyName');
                if (companyNameEl) companyNameEl.value = settingsData.companyName || 'D.Watson Group of Pharmacy';
                const currencyEl = document.getElementById('currency');
                if (currencyEl) currencyEl.value = settingsData.currency || '';
                const dateFormatEl = document.getElementById('dateFormat');
                if (dateFormatEl) dateFormatEl.value = settingsData.dateFormat || 'DD/MM/YYYY';
                const itemsPerPageEl = document.getElementById('itemsPerPage');
                if (itemsPerPageEl) itemsPerPageEl.value = settingsData.itemsPerPage || 10;
                const itemsPerPageInputEl = document.getElementById('itemsPerPageInput');
                if (itemsPerPageInputEl) itemsPerPageInputEl.value = settingsData.itemsPerPage || 20;
                const appThemeSelectEl = document.getElementById('appThemeSelect');
                if (appThemeSelectEl) {
                    appThemeSelectEl.value = settingsData.theme || 'light';
                    // Apply theme immediately when loaded
                    applyTheme(settingsData.theme || 'light');
                }
            }).catch(error => {
                console.error('Error loading settings:', error);
                showNotification('Failed to load settings: ' + error.message, 'error');
            });
            
            // Load API keys if admin
            loadApiKeys();
        }
        
        // Load API Keys
        function loadApiKeys() {
            if (!isAdmin()) return;
            
            api.getApiKeys().then(apiKeys => {
                const tbody = document.getElementById('apiKeysTableBody');
                if (!tbody) return;
                
                if (!apiKeys || apiKeys.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <i class="fas fa-key me-2"></i>No API keys found. Click "Create API Key" to generate one.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = apiKeys.map(key => {
                    const statusBadge = key.isActive 
                        ? '<span class="badge bg-success">Active</span>'
                        : '<span class="badge bg-secondary">Inactive</span>';
                    const lastUsed = key.lastUsed 
                        ? new Date(key.lastUsed).toLocaleDateString() + ' ' + new Date(key.lastUsed).toLocaleTimeString()
                        : 'Never';
                    const created = new Date(key.createdAt).toLocaleDateString();
                    const expires = key.expiresAt 
                        ? new Date(key.expiresAt).toLocaleDateString()
                        : 'Never';
                    
                    return `
                        <tr>
                            <td>
                                <strong>${key.name || 'Unnamed'}</strong>
                                ${key.description ? `<br><small class="text-muted">${key.description}</small>` : ''}
                            </td>
                            <td><code class="text-primary">${key.apiKey}</code></td>
                            <td>${statusBadge}</td>
                            <td>
                                <span class="badge bg-info">${key.usageCount || 0}</span>
                            </td>
                            <td><small>${lastUsed}</small></td>
                            <td><small>${created}</small></td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="toggleApiKeyStatus('${key._id}', ${key.isActive})" title="Toggle Status">
                                        <i class="fas fa-${key.isActive ? 'pause' : 'play'}"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteApiKey('${key._id}', '${key.name}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }).catch(error => {
                console.error('Error loading API keys:', error);
                const tbody = document.getElementById('apiKeysTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>Error loading API keys: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            });
        }
        
        // Create API Key
        async function createApiKey() {
            const name = document.getElementById('apiKeyName').value.trim();
            const description = document.getElementById('apiKeyDescription').value.trim();
            const expiresAt = document.getElementById('apiKeyExpiresAt').value;
            
            if (!name) {
                showNotification('API key name is required', 'error');
                return;
            }
            
            const btn = document.getElementById('saveApiKeyBtn');
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';
                
                const apiKeyData = {
                    name,
                    description: description || '',
                    expiresAt: expiresAt || null
                };
                
                const result = await api.createApiKey(apiKeyData);
                
                // Hide form and show result
                document.getElementById('apiKeyForm').style.display = 'none';
                document.getElementById('apiKeyResult').classList.remove('d-none');
                document.getElementById('generatedApiKey').value = result.apiKey;
                document.getElementById('generatedApiSecret').value = result.apiSecret;
                
                // Update button
                btn.innerHTML = '<i class="fas fa-check me-2"></i>Created!';
                
                // Reload API keys list
                loadApiKeys();
                
                // Show success notification
                showNotification('API key created successfully! Save the credentials now.', 'success');
                
            } catch (error) {
                console.error('Error creating API key:', error);
                showNotification('Failed to create API key: ' + error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus me-2"></i>Create API Key';
            }
        }
        
        // Toggle API Key Status
        async function toggleApiKeyStatus(id, currentStatus) {
            if (!confirm(`Are you sure you want to ${currentStatus ? 'deactivate' : 'activate'} this API key?`)) {
                return;
            }
            
            try {
                await api.updateApiKey(id, { isActive: !currentStatus });
                showNotification(`API key ${currentStatus ? 'deactivated' : 'activated'} successfully`, 'success');
                loadApiKeys();
            } catch (error) {
                console.error('Error updating API key:', error);
                showNotification('Failed to update API key: ' + error.message, 'error');
            }
        }
        
        // Delete API Key
        async function deleteApiKey(id, name) {
            if (!confirm(`Are you sure you want to delete the API key "${name}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                await api.deleteApiKey(id);
                showNotification('API key deleted successfully', 'success');
                loadApiKeys();
            } catch (error) {
                console.error('Error deleting API key:', error);
                showNotification('Failed to delete API key: ' + error.message, 'error');
            }
        }
        
        // Copy to Clipboard helper
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            element.setSelectionRange(0, 99999); // For mobile devices
            document.execCommand('copy');
            showNotification('Copied to clipboard!', 'success');
        }
        
        // Reset API Key Modal
        function resetApiKeyModal() {
            document.getElementById('apiKeyForm').reset();
            document.getElementById('apiKeyForm').style.display = 'block';
            document.getElementById('apiKeyResult').classList.add('d-none');
            const btn = document.getElementById('saveApiKeyBtn');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-plus me-2"></i>Create API Key';
        }
        
        // Apply theme to the application
        function applyTheme(theme) {
            if (!theme) theme = 'light';
            
            // Remove all theme classes
            document.body.classList.remove('theme-light', 'theme-dark', 'theme-blue', 'theme-red', 'theme-green', 'theme-purple', 'theme-teal', 'theme-redblue');
            document.documentElement.classList.remove('theme-light', 'theme-dark', 'theme-blue', 'theme-red', 'theme-green', 'theme-purple', 'theme-teal', 'theme-redblue');
            
            // Add the selected theme class
            document.body.classList.add('theme-' + theme);
            document.documentElement.classList.add('theme-' + theme);
            
            // Store theme in localStorage for persistence
            localStorage.setItem('appTheme', theme);
            
            console.log(' Theme applied:', theme);
        }
        
        // Initialize theme on page load
        function initTheme() {
            // First try to get theme from localStorage (for immediate application)
            const savedTheme = localStorage.getItem('appTheme');
            if (savedTheme) {
                applyTheme(savedTheme);
            }
            
            // Then load from server settings and apply if different
            if (window.api && typeof window.api.getSettings === 'function') {
                const hasToken = !!localStorage.getItem('authToken');
                if (hasToken) {
                    window.api.getSettings().then(settingsData => {
                        if (settingsData && settingsData.theme) {
                            applyTheme(settingsData.theme);
                            const appThemeSelectEl = document.getElementById('appThemeSelect');
                            if (appThemeSelectEl) {
                                appThemeSelectEl.value = settingsData.theme;
                            }
                        } else if (!savedTheme) {
                            applyTheme('light');
                        }
                        // Apply logo if available
                        if (settingsData && settingsData.logoUrl) {
                            document.querySelectorAll('.navbar-logo, .login-logo').forEach(img => {
                                try { img.src = settingsData.logoUrl; } catch(e) {}
                            });
                        }
                    }).catch(err => {
                        if (!savedTheme) {
                            applyTheme('light');
                        }
                    });
                } else if (!savedTheme) {
                    applyTheme('light');
                }
            } else if (!savedTheme) {
                // Default to light if API not available
                applyTheme('light');
            }
        }
        
        // Expose applyTheme globally
        window.applyTheme = applyTheme;
        
        // Save settings
        function saveSettings() {
            // Check if user is admin
            if (!isAdmin()) {
                showNotification('You need admin privileges to update settings', 'error');
                return;
            }
            
            const companyNameEl = document.getElementById('companyName');
            const currencyEl = document.getElementById('currency');
            const dateFormatEl = document.getElementById('dateFormat');
            const itemsPerPageEl = document.getElementById('itemsPerPage');
            const itemsPerPageInputEl = document.getElementById('itemsPerPageInput');
            const appThemeSelectEl = document.getElementById('appThemeSelect');
            
            const settingsData = {
                companyName: companyNameEl ? companyNameEl.value : '',
                currency: currencyEl ? currencyEl.value : '',
                dateFormat: dateFormatEl ? dateFormatEl.value : 'DD/MM/YYYY',
                itemsPerPage: itemsPerPageEl ? parseInt(itemsPerPageEl.value) : (itemsPerPageInputEl ? parseInt(itemsPerPageInputEl.value) : 20),
                theme: appThemeSelectEl ? appThemeSelectEl.value : 'light'
            };
            
            api.updateSettings(settingsData).then(() => {
                // Apply theme immediately after saving
                if (settingsData.theme) {
                    applyTheme(settingsData.theme);
                }
                showNotification('Settings saved successfully!', 'success');
            }).catch(error => {
                console.error('Error saving settings:', error);
                showNotification('Failed to save settings: ' + error.message, 'error');
            });
        }
        
        // Backup data
        function backupData() {
            Promise.all([
                api.getSales(),
                api.getBranches(),
                api.getCategories(),
                api.getGroups(),
                api.getUsers(),
                api.getSettings()
            ]).then(([salesData, branchesData, categoriesData, groupsData, usersData, settingsData]) => {
                const backup = {
                    salesData: salesData,
                    branchesData: branchesData,
                    categoriesData: categoriesData,
                    groupsData: groupsData,
                    usersData: usersData,
                    settingsData: settingsData,
                    timestamp: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showNotification('Data backed up successfully!', 'success');
            }).catch(error => {
                console.error('Error backing up data:', error);
                showNotification('Failed to backup data: ' + error.message, 'error');
            });
        }
        
        // Restore data
        function restoreData(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const backup = JSON.parse(event.target.result);
                    
                    if (confirm('Are you sure you want to restore this backup? This will replace all current data.')) {
                        // Note: This is a simplified restore function
                        // In a real application, you would need to implement proper restore endpoints in your API
                        showNotification('Data restore functionality requires server-side implementation', 'info');
                    }
                } catch (error) {
                    showNotification('Error restoring data. Please check the file format.', 'error');
                }
            };
            
            reader.readAsText(file);
            
            // Reset file input
            e.target.value = '';
        }
        
        // Utility functions
        function formatDate(date) {
            return new Date(date).toLocaleDateString('en-GB');
        }
        
        function formatDateForInput(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Get current date in YYYY-MM-DD format
        function getCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Set default dates to current date for all date inputs
        function setDefaultDates() {
            const currentDate = getCurrentDate();
            
            // List of all date input IDs that should default to current date
            const dateInputIds = [
                // Sales section
                'salesListDateFrom',
                'salesListDateTo',
                'saleDate',
                // Payment vouchers
                'paymentVoucherDate',
                'categoryVoucherDate',
                // Payment voucher list
                'paymentVoucherListFromDate',
                'paymentVoucherListToDate',
                // Category voucher lists
                'categoryVoucherListFromDate',
                'categoryVoucherListToDate',
                'categoryVoucherSimpleListFromDate',
                'categoryVoucherSimpleListToDate',
                // Reports
                'paymentReportFromDate',
                'paymentReportToDate',
                'paymentReportFromDateFilter',
                'paymentReportToDateFilter',
                'salesReportDateFrom',
                'salesReportDateTo',
                'comparisonReportDateFrom',
                'comparisonReportDateTo',
                'datewiseReportDateFrom',
                'datewiseReportDateTo'
            ];
            
            // Set default date for each input if it's empty
            dateInputIds.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input && !input.value) {
                    input.value = currentDate;
                }
            });
        }
        
        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            
            notification.className = 'notification ' + type;
            notificationMessage.textContent = message;
            
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Professional Print Report Function
        function printProfessionalReport() {
            const fromDate = document.getElementById('reportDateFrom').value;
            const toDate = document.getElementById('reportDateTo').value;
            const branchId = document.getElementById('reportBranch').value;
            
            // Get selected branch info
            const selectedBranch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = selectedBranch ? selectedBranch.name : 'All Branches';
            const branchAddress = selectedBranch ? selectedBranch.address : '';
            
            // Get report data
            const reportData = getReportData();
            
            // Create print content (full report with both summary and detailed sections)
            const printContent = createPrintContent(reportData, fromDate, toDate, branchName, branchAddress, 'full');
            
            // Open print window with error handling
            try {
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                if (!printWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                printWindow.document.write(printContent);
                printWindow.document.close();
                
                // Wait for content to load then print
                printWindow.onload = function() {
                    printWindow.focus();
                    printWindow.print();
                    printWindow.close();
                };
            } catch (error) {
                console.error('Print window error:', error);
                showNotification('Print failed: ' + error.message, 'error');
            }
        }
        
        // Preview report function
        function previewReport() {
            const fromDate = document.getElementById('reportDateFrom').value;
            const toDate = document.getElementById('reportDateTo').value;
            const branchId = document.getElementById('reportBranch').value;
            
            // Get selected branch info
            const selectedBranch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = selectedBranch ? selectedBranch.name : 'All Branches';
            const branchAddress = selectedBranch ? selectedBranch.address : '';
            
            // Get report data
            const reportData = getReportData();
            
            // Create print content
            const printContent = createPrintContent(reportData, fromDate, toDate, branchName, branchAddress);
            
            // Open preview window with error handling
            try {
                const previewWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
            
                // Add print button to preview window
                previewWindow.onload = function() {
                    const printBtn = previewWindow.document.createElement('button');
                    printBtn.innerHTML = '<i class="fas fa-print"></i> Print';
                    printBtn.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;';
                    printBtn.onclick = function() {
                        previewWindow.print();
                    };
                    previewWindow.document.body.appendChild(printBtn);
                };
            } catch (error) {
                console.error('Preview window error:', error);
                showNotification('Preview failed: ' + error.message, 'error');
            }
        }
        
        // Download PDF function
        function downloadPdfReport() {
            const fromDate = document.getElementById('reportDateFrom').value;
            const toDate = document.getElementById('reportDateTo').value;
            const branchId = document.getElementById('reportBranch').value;
            
            // Get selected branch info
            const selectedBranch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = selectedBranch ? selectedBranch.name : 'All Branches';
            const branchAddress = selectedBranch ? selectedBranch.address : '';
            
            // Get report data
            const reportData = getReportData();
            
            // Create print content
            const printContent = createPrintContent(reportData, fromDate, toDate, branchName, branchAddress);
            
            // Create a temporary window for PDF generation with error handling
            try {
                const tempWindow = window.open('', '_blank', 'width=800,height=600');
                if (!tempWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                tempWindow.document.write(printContent);
                tempWindow.document.close();
                
                // Wait for content to load then trigger print to PDF
                tempWindow.onload = function() {
                    // Trigger print dialog (user can choose "Save as PDF")
                    tempWindow.print();
                    
                    // Close the temporary window after a delay
                    setTimeout(() => {
                        tempWindow.close();
                    }, 1000);
                };
            } catch (error) {
                console.error('PDF generation error:', error);
                showNotification('PDF generation failed: ' + error.message, 'error');
            }
        }
        
        function getReportData() {
            const fromDate = document.getElementById('reportDateFrom').value;
            const toDate = document.getElementById('reportDateTo').value;
            const branchId = document.getElementById('reportBranch').value;
            
            // Build filters
            const filters = {};
            if (fromDate) filters.from = fromDate;
            if (toDate) filters.to = toDate;
            if (branchId) filters.branchId = branchId;
            
            // Filter sales data
            let filteredSales = appData.sales;
            if (filters.from || filters.to) {
                filteredSales = filteredSales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    if (filters.from && saleDate < new Date(filters.from)) return false;
                    if (filters.to && saleDate > new Date(filters.to)) return false;
                    return true;
                });
            }
            
            if (filters.branchId) {
                filteredSales = filteredSales.filter(sale => {
                    const saleBranchId = (sale && sale.branchId && sale.branchId._id) ? sale.branchId._id : sale.branchId;
                    return saleBranchId === filters.branchId;
                });
            }
            
            // Calculate category-wise totals
            const categoryTotals = {};
            appData.categories.forEach(category => {
                const categorySales = filteredSales.filter(sale => {
                    const saleCategoryId = (sale && sale.categoryId && sale.categoryId._id) ? sale.categoryId._id : sale.categoryId;
                    return saleCategoryId === category._id;
                });
                
                const totalSales = categorySales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                const totalCost = categorySales.reduce((sum, sale) => sum + (sale.costTotal || 0), 0);
                const totalProfit = totalSales - totalCost;
                const profitMargin = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;
                
                categoryTotals[category._id] = {
                    name: category.name,
                    totalSales,
                    totalCost,
                    totalProfit,
                    profitMargin
                };
            });
            
            // Calculate grand totals
            const grandTotalSales = Object.values(categoryTotals).reduce((sum, data) => sum + data.totalSales, 0);
            const grandTotalCost = Object.values(categoryTotals).reduce((sum, data) => sum + data.totalCost, 0);
            const grandTotalProfit = grandTotalSales - grandTotalCost;
            const grandProfitMargin = grandTotalSales > 0 ? (grandTotalProfit / grandTotalSales * 100) : 0;
            
            return {
                categoryTotals,
                grandTotalSales,
                grandTotalCost,
                grandTotalProfit,
                grandProfitMargin,
                filteredSales
            };
        }
        
        function createPrintContent(reportData, fromDate, toDate, branchName, branchAddress, reportType = 'full') {
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = fromDate && toDate ? 
                `${new Date(fromDate).toLocaleDateString('en-GB')} - ${new Date(toDate).toLocaleDateString('en-GB')}` : 
                'All Time';
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sales Report - D.Watson Pharmacy</title>
    <style>
        @page {
            size: A4;
            margin: 1in;
        }
        
        body {
            font-family: Arial, sans-serif;
            font-size: 12pt;
            line-height: 1.4;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 0;
        }
        
        * {
            color: #000 !important;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #000;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 24pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #000;
        }
        
        .print-header .company-info {
            font-size: 10pt;
            color: #000;
            margin: 5px 0;
            font-weight: 500;
        }
        
        .print-header .report-info {
            font-size: 11pt;
            color: #000;
            margin: 10px 0 0 0;
            font-weight: 500;
        }
        
        .print-section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        
        .print-section h3 {
            font-size: 14pt;
            font-weight: bold;
            color: #000;
            margin: 0 0 15px 0;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
        }
        
        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        .print-table th,
        .print-table td {
            border: 1px solid #333;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        
        .print-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            color: #000;
        }
        
        .print-table .text-right {
            text-align: right;
        }
        
        .print-table .text-center {
            text-align: center;
        }
        
        .print-summary-boxes {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 15px;
        }
        
        .summary-box {
            flex: 1;
            border: 2px solid #333;
            border-left: 5px solid #2c6e8a;
            padding: 15px;
            text-align: center;
            background-color: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .summary-label {
            font-size: 12pt;
            color: #000;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .summary-value {
            font-size: 14pt;
            font-weight: bold;
            color: #000;
        }
        
        .print-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 9pt;
            color: #666;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }
    </style>
</head>
<body>
    <div class="print-container">
        <div class="print-header">
            <h1>D.Watson Group of Pharmacy</h1>
            <div class="company-info">Sales Report</div>
            <div class="report-info">
                <strong>Branch:</strong> ${branchName}<br>
                ${branchAddress ? `<strong>Address:</strong> ${branchAddress}<br>` : ''}
                <strong>Period:</strong> ${dateRange}<br>
                <strong>Generated:</strong> ${currentDate}
            </div>
        </div>
        
        ${reportType === 'detailed' ? '' : `
        <div class="print-section">
            <h3>Summary</h3>
            <div class="print-summary-boxes">
                <div class="summary-box">
                    <div class="summary-label">Total Sales</div>
                    <div class="summary-value">${reportData.grandTotalSales.toLocaleString()}</div>
                </div>
                <div class="summary-box">
                    <div class="summary-label">Total Cost</div>
                    <div class="summary-value">${reportData.grandTotalCost.toLocaleString()}</div>
                </div>
                <div class="summary-box">
                    <div class="summary-label">Total Profit</div>
                    <div class="summary-value">${reportData.grandTotalProfit.toLocaleString()}</div>
                </div>
                <div class="summary-box">
                    <div class="summary-label">Profit Margin</div>
                    <div class="summary-value">${reportData.grandProfitMargin.toFixed(1)}%</div>
                </div>
            </div>
        </div>
        
        <div class="print-section">
            <h3>Category-wise Sales Breakdown</h3>
            <table class="print-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th class="text-right">Total Sales</th>
                        <th class="text-right">Total Cost</th>
                        <th class="text-right">Total Profit</th>
                        <th class="text-center">Profit Margin</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.values(reportData.categoryTotals).map(cat => `
                        <tr>
                            <td>${cat.name}</td>
                            <td class="text-right">${cat.totalSales.toLocaleString()}</td>
                            <td class="text-right">${cat.totalCost.toLocaleString()}</td>
                            <td class="text-right">${cat.totalProfit.toLocaleString()}</td>
                            <td class="text-center">${cat.profitMargin.toFixed(1)}%</td>
                        </tr>
                    `).join('')}
                    <tr style="font-weight: bold; background-color: #f9f9f9;">
                        <td><strong>GRAND TOTAL</strong></td>
                        <td class="text-right"><strong>${reportData.grandTotalSales.toLocaleString()}</strong></td>
                        <td class="text-right"><strong>${reportData.grandTotalCost.toLocaleString()}</strong></td>
                        <td class="text-right"><strong>${reportData.grandTotalProfit.toLocaleString()}</strong></td>
                        <td class="text-center"><strong>${reportData.grandProfitMargin.toFixed(1)}%</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        `}
        
        ${(reportType === 'summary') ? '' : `
        <div class="print-section">
            <h3>Detailed Transaction List</h3>
            <table class="print-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Branch</th>
                        <th>Category</th>
                        <th class="text-right">Sales</th>
                        <th class="text-right">Cost</th>
                        <th class="text-right">Profit</th>
                    </tr>
                </thead>
                <tbody>
                    ${reportData.filteredSales.map(sale => `
                        <tr>
                            <td>${new Date(sale.date).toLocaleDateString('en-GB')}</td>
                            <td>${sale.branchId?.name || 'Unknown'}</td>
                            <td>${sale.categoryId?.name || 'Unknown'}</td>
                            <td class="text-right">${(sale.total || 0).toLocaleString()}</td>
                            <td class="text-right">${(sale.costTotal || 0).toLocaleString()}</td>
                            <td class="text-right">${(sale.profit || 0).toLocaleString()}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        `}
        
        <div class="print-footer">
            <p>This report was generated on ${currentDate} by D.Watson Pharmacy Management System</p>
            <p>For any queries, please contact the management</p>
        </div>
    </div>
</body>
</html>
            `;
        }
        
        // ========================================
        // NEW: Enhanced Print Functions
        // ========================================
        
        // NEW: Print Summary Report Function (Only Summary + Comparison, NO Detailed List)
        function printSummaryReport() {
            const fromDate = document.getElementById('reportDateFrom').value;
            const toDate = document.getElementById('reportDateTo').value;
            const branchId = document.getElementById('reportBranch').value;
            
            // Get selected branch info
            const selectedBranch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = selectedBranch ? selectedBranch.name : 'All Branches';
            const branchAddress = selectedBranch ? selectedBranch.address : '';
            
            // Get report data
            const reportData = getReportData();
            
            // Create summary print content (NO detailed transaction list)
            const printContent = createPrintContent(reportData, fromDate, toDate, branchName, branchAddress, 'summary');
            
            // Open preview window (new tab)
            try {
                const previewWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
            } catch (error) {
                console.error('Preview error:', error);
                showNotification('Preview failed: ' + error.message, 'error');
            }
        }
        
        // NEW: Print Detailed Report Function (Only Detailed Transaction List, NO Summary)
        function printDetailedReport() {
            const fromDate = document.getElementById('reportDateFrom').value;
            const toDate = document.getElementById('reportDateTo').value;
            const branchId = document.getElementById('reportBranch').value;
            
            // Get selected branch info
            const selectedBranch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = selectedBranch ? selectedBranch.name : 'All Branches';
            const branchAddress = selectedBranch ? selectedBranch.address : '';
            
            // Get report data
            const reportData = getReportData();
            
            // Create detailed print content (ONLY detailed transaction list)
            const printContent = createPrintContent(reportData, fromDate, toDate, branchName, branchAddress, 'detailed');
            
            // Open preview window (new tab)
            try {
                const previewWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
            } catch (error) {
                console.error('Preview error:', error);
                showNotification('Preview failed: ' + error.message, 'error');
            }
        }
        
        // NEW: Print Sales Comparison Function (Opens in preview tab)
        function printSalesComparison() {
            const fromDate = document.getElementById('reportDateFrom').value;
            const toDate = document.getElementById('reportDateTo').value;
            const branchId = document.getElementById('reportBranch').value;
            
            // Get selected branch info
            const selectedBranch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = selectedBranch ? selectedBranch.name : 'All Branches';
            const branchAddress = selectedBranch ? selectedBranch.address : '';
            
            // Get report data
            const reportData = getReportData();
            
            // Create sales comparison print content
            const printContent = createSalesComparisonPrintContent(reportData, fromDate, toDate, branchName, branchAddress);
            
            // Open preview window (new tab)
            try {
                const previewWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
            } catch (error) {
                console.error('Preview error:', error);
                showNotification('Preview failed: ' + error.message, 'error');
            }
        }
        
        // NEW: Print All Branches Summary Function
        function printAllBranchesSummary() {
            const fromDate = document.getElementById('reportDateFrom').value;
            const toDate = document.getElementById('reportDateTo').value;
            
            // Get all branches data
            const allBranchesData = getAllBranchesSummaryData(fromDate, toDate);
            
            // Create all branches summary print content
            const printContent = createAllBranchesSummaryPrintContent(allBranchesData, fromDate, toDate);
            
            // Open preview window (new tab)
            try {
                const previewWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
            } catch (error) {
                console.error('Preview error:', error);
                showNotification('Preview failed: ' + error.message, 'error');
            }
        }
        
        // NEW: Print Date Wise Data Function
        function printDateWiseData() {
            const fromDate = document.getElementById('datewiseReportDateFrom').value;
            const toDate = document.getElementById('datewiseReportDateTo').value;
            const branchId = document.getElementById('datewiseReportBranch').value;
            
            // Get selected branch info
            const selectedBranch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = selectedBranch ? selectedBranch.name : 'All Branches';
            const branchAddress = selectedBranch ? selectedBranch.address : '';
            
            // Get date wise data
            const dateWiseData = getDateWiseData(fromDate, toDate, branchId);
            
            // Create date wise print content
            const printContent = createDateWisePrintContent(dateWiseData, fromDate, toDate, branchName, branchAddress);
            
            // Open preview window (new tab)
            try {
                const previewWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
            } catch (error) {
                console.error('Preview error:', error);
                showNotification('Preview failed: ' + error.message, 'error');
            }
        }
        
        // NEW: Preview Summary Report Function (Opens in new tab - Report Summary + Detailed Report + Sales Comparison)
        function previewSummaryReport() {
            const fromDate = document.getElementById('reportDateFrom').value;
            const toDate = document.getElementById('reportDateTo').value;
            const branchId = document.getElementById('reportBranch').value;
            
            // Get selected branch info
            const selectedBranch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = selectedBranch ? selectedBranch.name : 'All Branches';
            const branchAddress = selectedBranch ? selectedBranch.address : '';
            
            // Get report data
            const reportData = getReportData();
            
            // Create print content for preview (Report Summary + Category Breakdown + Branch-wise Sales Comparison)
            const printContent = createPrintContentWithBranchComparison(reportData, fromDate, toDate, branchName, branchAddress);
            
            // Open preview window (new tab)
            try {
                const previewWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
            } catch (error) {
                console.error('Preview error:', error);
                showNotification('Preview failed: ' + error.message, 'error');
            }
        }
        
        // NEW: Print Summary + Comparison Function
        function printSummaryAndComparison() {
            const fromDate = document.getElementById('reportDateFrom').value;
            const toDate = document.getElementById('reportDateTo').value;
            const branchId = document.getElementById('reportBranch').value;
            
            // Get selected branch info
            const selectedBranch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = selectedBranch ? selectedBranch.name : 'All Branches';
            const branchAddress = selectedBranch ? selectedBranch.address : '';
            
            // Get report data
            const reportData = getReportData();
            
            // Create summary + comparison print content (NO detailed transaction list)
            const printContent = createPrintContent(reportData, fromDate, toDate, branchName, branchAddress, 'summary');
            
            // Open preview window (new tab)
            try {
                const previewWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
            } catch (error) {
                console.error('Preview error:', error);
                showNotification('Preview failed: ' + error.message, 'error');
            }
        }
        
        // ========================================
        // NEW: Print Report Dropdown Functions
        // ========================================
        
        // NEW: Print Summary Report (Report Summary + Detailed Report + Sales Comparison - NO Date Wise Data)
        function printSummaryReportNew() {
            const fromDate = document.getElementById('reportDateFrom').value;
            const toDate = document.getElementById('reportDateTo').value;
            const branchId = document.getElementById('reportBranch').value;
            
            // Get selected branch info
            const selectedBranch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = selectedBranch ? selectedBranch.name : 'All Branches';
            const branchAddress = selectedBranch ? selectedBranch.address : '';
            
            // Get report data
            const reportData = getReportData();
            
            // Create print content for summary report (Report Summary + Detailed + Sales Comparison, NO Date Wise Data)
            const printContent = createPrintContent(reportData, fromDate, toDate, branchName, branchAddress, 'summary_with_detailed');
            
            // Open in Chrome tab (preview mode)
            try {
                const previewWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
            } catch (error) {
                console.error('Preview error:', error);
                showNotification('Preview failed: ' + error.message, 'error');
            }
        }
        
        // NEW: Print Detailed Report (Entire screen including Date Wise Data)
        function printDetailedReportNew() {
            const fromDate = document.getElementById('reportDateFrom').value;
            const toDate = document.getElementById('reportDateTo').value;
            const branchId = document.getElementById('reportBranch').value;
            
            // Get selected branch info
            const selectedBranch = branchId ? appData.branches.find(b => b._id === branchId) : null;
            const branchName = selectedBranch ? selectedBranch.name : 'All Branches';
            const branchAddress = selectedBranch ? selectedBranch.address : '';
            
            // Get report data
            const reportData = getReportData();
            
            // Create print content for detailed report (Full report with all sections)
            const printContent = createPrintContent(reportData, fromDate, toDate, branchName, branchAddress, 'full');
            
            // Open in Chrome tab (preview mode)
            try {
                const previewWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
            } catch (error) {
                console.error('Preview error:', error);
                showNotification('Preview failed: ' + error.message, 'error');
            }
        }
        
        // NEW: Create Dashboard Branch Summary Print Content
        function createDashboardBranchSummaryPrintContent(reportData, fromDate, toDate, branchName, branchAddress) {
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = fromDate && toDate ? 
                `${new Date(fromDate).toLocaleDateString('en-GB')} - ${new Date(toDate).toLocaleDateString('en-GB')}` : 
                'All Time';
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dashboard Branch Summary - D.Watson Pharmacy</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .print-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
        .print-header h1 { font-size: 24pt; font-weight: bold; margin: 0 0 10px 0; color: #333; }
        .print-header .company-info { font-size: 10pt; color: #666; margin: 5px 0; }
        .print-header .report-info { font-size: 11pt; color: #333; margin: 10px 0 0 0; }
        .dashboard-section { margin-bottom: 25px; }
        .dashboard-section h3 { font-size: 16pt; color: #2c6e8a; margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .summary-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #2c6e8a; text-align: center; }
        .summary-card h4 { margin: 0 0 10px 0; color: #2c6e8a; font-size: 14pt; }
        .summary-card .value { font-size: 24pt; font-weight: bold; color: #333; margin: 10px 0; }
        .summary-card .label { font-size: 10pt; color: #666; }
        .category-breakdown { margin-bottom: 25px; }
        .category-breakdown h4 { font-size: 14pt; color: #2c6e8a; margin-bottom: 15px; }
        .category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .category-item { background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 3px solid #17a2b8; }
        .category-item h5 { margin: 0 0 8px 0; color: #17a2b8; font-size: 12pt; }
        .category-item .value { font-size: 18pt; font-weight: bold; color: #333; }
        .category-item .label { font-size: 9pt; color: #666; }
        .print-footer { margin-top: 30px; text-align: center; font-size: 9pt; color: #666; border-top: 1px solid #ddd; padding-top: 15px; }
        @media print { body { margin: 0; } }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Dashboard Branch Summary</div>
        <div class="company-info">${branchName}${branchAddress ? ' - ' + branchAddress : ''}</div>
        <div class="report-info">Period: ${dateRange}</div>
        <div class="report-info">Generated on: ${currentDate}</div>
    </div>
    
    <div class="dashboard-section">
        <h3> Key Performance Indicators</h3>
        <div class="summary-cards">
            <div class="summary-card">
                <h4>Total Sales</h4>
                <div class="value">${reportData.grandTotalSales.toLocaleString()}</div>
                <div class="label">Revenue Generated</div>
            </div>
            <div class="summary-card">
                <h4>Total Cost</h4>
                <div class="value">${reportData.grandTotalCost.toLocaleString()}</div>
                <div class="label">Cost of Goods Sold</div>
            </div>
            <div class="summary-card">
                <h4>Total Profit</h4>
                <div class="value">${reportData.grandTotalProfit.toLocaleString()}</div>
                <div class="label">Net Profit Earned</div>
            </div>
            <div class="summary-card">
                <h4>Profit Margin</h4>
                <div class="value">${reportData.grandProfitMargin.toFixed(1)}%</div>
                <div class="label">Profit Percentage</div>
            </div>
        </div>
    </div>
    
    <div class="dashboard-section">
        <h3> Category Performance Breakdown</h3>
        <div class="category-breakdown">
            <div class="category-grid">
                ${Object.values(reportData.categoryTotals).map(cat => `
                <div class="category-item">
                    <h5>${cat.name}</h5>
                    <div class="value">${cat.totalSales.toLocaleString()}</div>
                    <div class="label">Sales: ${cat.totalSales.toLocaleString()}</div>
                    <div class="label">Profit: ${cat.totalProfit.toLocaleString()}</div>
                    <div class="label">Margin: ${cat.profitMargin.toFixed(1)}%</div>
                </div>
                `).join('')}
            </div>
        </div>
    </div>
    
    <div class="print-footer">
        <p>This dashboard summary was generated on ${currentDate} by D.Watson Pharmacy Management System</p>
        <p>For any queries, please contact the management</p>
    </div>
</body>
</html>
            `;
        }
        
        // NEW: Create Print Content with Branch Comparison
        function createPrintContentWithBranchComparison(reportData, fromDate, toDate, branchName, branchAddress) {
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = fromDate && toDate ? 
                `${new Date(fromDate).toLocaleDateString('en-GB')} - ${new Date(toDate).toLocaleDateString('en-GB')}` : 
                'All Time';
            
            // Debug: Log data availability
            
            // Get all branches data for comparison
            const allBranchesData = getAllBranchesSummaryData(fromDate, toDate);
            
            // If no data found, try alternative approach
            let sortedBranchesData = allBranchesData.sort((a, b) => b.totalSales - a.totalSales);
            
            // Fallback: If no branch data found, create a summary from reportData
            if (sortedBranchesData.length === 0 || sortedBranchesData.every(branch => branch.totalSales === 0)) {
                
                // Create a single entry with the current report data
                const selectedBranch = branchName !== 'All Branches' ? 
                    appData.branches.find(b => b.name === branchName) : null;
                
                if (selectedBranch) {
                    sortedBranchesData = [{
                        branchName: selectedBranch.name,
                        branchAddress: selectedBranch.address,
                        totalSales: reportData.grandTotalSales,
                        totalCost: reportData.grandTotalCost,
                        totalProfit: reportData.grandTotalProfit,
                        profitMargin: reportData.grandProfitMargin.toFixed(2),
                        salesCount: reportData.filteredSales ? reportData.filteredSales.length : 0
                    }];
                } else {
                    // For "All Branches", show aggregated data
                    sortedBranchesData = [{
                        branchName: 'All Branches Combined',
                        branchAddress: '',
                        totalSales: reportData.grandTotalSales,
                        totalCost: reportData.grandTotalCost,
                        totalProfit: reportData.grandTotalProfit,
                        profitMargin: reportData.grandProfitMargin.toFixed(2),
                        salesCount: reportData.filteredSales ? reportData.filteredSales.length : 0
                    }];
                }
            }
            
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sales Report - D.Watson Pharmacy</title>
    <style>
        @page {
            size: A4;
            margin: 1in;
        }
        
        body {
            font-family: Arial, sans-serif;
            font-size: 12pt;
            line-height: 1.4;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 0;
        }
        
        * {
            color: #000 !important;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #000;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 24pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #000;
        }
        
        .print-header .company-info {
            font-size: 10pt;
            color: #000;
            margin: 5px 0;
            font-weight: 500;
        }
        
        .print-header .report-info {
            font-size: 11pt;
            color: #000;
            margin: 10px 0 0 0;
            font-weight: 500;
        }
        
        .print-section {
            margin-bottom: 25px;
        }
        
        .print-section h3 {
            font-size: 16pt;
            color: #000;
            margin-bottom: 15px;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
            font-weight: bold;
        }
        
        .print-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .print-summary-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 2px solid #000;
            border-left: 5px solid #2c6e8a;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .print-summary-item .label {
            font-size: 12pt;
            color: #000;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .print-summary-item .value {
            font-size: 18pt;
            font-weight: bold;
            color: #000;
        }
        
        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .print-table th, .print-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .print-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #2c6e8a;
        }
        
        .print-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .grand-total {
            background-color: #e9ecef;
            font-weight: bold;
        }
        
        .print-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 9pt;
            color: #666;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        
        @media print {
            body {
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <div class="print-container">
        <div class="print-header">
            <h1>D.Watson Group Of Pharmacies</h1>
            <div class="company-info">Sales Report</div>
            <div class="company-info">${branchName}${branchAddress ? ' - ' + branchAddress : ''}</div>
            <div class="company-info">
                <strong>Period:</strong> ${dateRange}<br>
                <strong>Generated:</strong> ${currentDate}
            </div>
        </div>
        
        <div class="print-section">
            <h3>Summary</h3>
            <div class="print-summary">
                <div class="print-summary-item">
                    <span class="label">Total Sales</span>
                    <span class="value">${reportData.grandTotalSales.toLocaleString()}</span>
                </div>
                <div class="print-summary-item">
                    <span class="label">Total Cost</span>
                    <span class="value">${reportData.grandTotalCost.toLocaleString()}</span>
                </div>
                <div class="print-summary-item">
                    <span class="label">Total Profit</span>
                    <span class="value">${reportData.grandTotalProfit.toLocaleString()}</span>
                </div>
                <div class="print-summary-item">
                    <span class="label">Profit Margin</span>
                    <span class="value">${reportData.grandProfitMargin.toFixed(1)}%</span>
                </div>
            </div>
        </div>
        
        <div class="print-section">
            <h3>Category-wise Sales Breakdown</h3>
            <table class="print-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th class="text-right">Total Sales</th>
                        <th class="text-right">Total Cost</th>
                        <th class="text-right">Total Profit</th>
                        <th class="text-center">Profit Margin</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.values(reportData.categoryTotals).map(cat => `
                        <tr>
                            <td>${cat.name}</td>
                            <td class="text-right">${cat.totalSales.toLocaleString()}</td>
                            <td class="text-right">${cat.totalCost.toLocaleString()}</td>
                            <td class="text-right">${cat.totalProfit.toLocaleString()}</td>
                            <td class="text-center">${cat.profitMargin.toFixed(1)}%</td>
                        </tr>
                    `).join('')}
                    <tr style="font-weight: bold; background-color: #f9f9f9;">
                        <td><strong>GRAND TOTAL</strong></td>
                        <td class="text-right"><strong>${reportData.grandTotalSales.toLocaleString()}</strong></td>
                        <td class="text-right"><strong>${reportData.grandTotalCost.toLocaleString()}</strong></td>
                        <td class="text-right"><strong>${reportData.grandTotalProfit.toLocaleString()}</strong></td>
                        <td class="text-center"><strong>${reportData.grandProfitMargin.toFixed(1)}%</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="print-section">
            <h3>Sales Comparison - Branch Performance</h3>
            <table class="print-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Branch Name</th>
                        <th class="text-right">Total Sales</th>
                        <th class="text-right">Total Cost</th>
                        <th class="text-right">Total Profit</th>
                        <th class="text-center">Profit Margin (%)</th>
                        <th class="text-center">Sales Count</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedBranchesData.map((branch, index) => `
                    <tr>
                        <td><strong>#${index + 1}</strong></td>
                        <td>${branch.branchName}</td>
                        <td class="text-right">${branch.totalSales.toLocaleString()}</td>
                        <td class="text-right">${branch.totalCost.toLocaleString()}</td>
                        <td class="text-right">${branch.totalProfit.toLocaleString()}</td>
                        <td class="text-center">${branch.profitMargin}%</td>
                        <td class="text-center">${branch.salesCount}</td>
                    </tr>
                    `).join('')}
                    <tr class="grand-total">
                        <td><strong>-</strong></td>
                        <td><strong>GRAND TOTAL</strong></td>
                        <td class="text-right"><strong>${sortedBranchesData.reduce((sum, branch) => sum + branch.totalSales, 0).toLocaleString()}</strong></td>
                        <td class="text-right"><strong>${sortedBranchesData.reduce((sum, branch) => sum + branch.totalCost, 0).toLocaleString()}</strong></td>
                        <td class="text-right"><strong>${sortedBranchesData.reduce((sum, branch) => sum + branch.totalProfit, 0).toLocaleString()}</strong></td>
                        <td class="text-center"><strong>${sortedBranchesData.reduce((sum, branch) => sum + branch.totalSales, 0) > 0 ? ((sortedBranchesData.reduce((sum, branch) => sum + branch.totalProfit, 0) / sortedBranchesData.reduce((sum, branch) => sum + branch.totalSales, 0)) * 100).toFixed(1) : 0}%</strong></td>
                        <td class="text-center"><strong>${sortedBranchesData.reduce((sum, branch) => sum + branch.salesCount, 0)}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="print-footer">
            <p>This report was generated on ${currentDate} by D.Watson Pharmacy Management System</p>
            <p>For any queries, please contact the management</p>
        </div>
    </div>
</body>
</html>
            `;
        }
        
        // ========================================
        // NEW: Helper Functions for New Print Options
        // ========================================
        
        // NEW: Get All Branches Summary Data
        function getAllBranchesSummaryData(fromDate, toDate) {
            const branches = appData.branches || [];
            const allBranchesData = [];
            
            
            branches.forEach(branch => {
                // Filter sales for this branch and date range
                let branchSales = appData.sales || [];
                
                
                if (fromDate && toDate) {
                    branchSales = branchSales.filter(sale => {
                        const saleDate = new Date(sale.date);
                        return saleDate >= new Date(fromDate) && saleDate <= new Date(toDate);
                    });
                }
                
                // Enhanced branch ID matching - handle multiple possible formats
                branchSales = branchSales.filter(sale => {
                    let saleBranchId = sale.branchId;
                    
                    // Handle different possible structures
                    if (typeof saleBranchId === 'object' && saleBranchId !== null) {
                        saleBranchId = saleBranchId._id || saleBranchId.id || saleBranchId;
                    }
                    
                    // Convert to string for comparison
                    const branchIdStr = String(branch._id);
                    const saleBranchIdStr = String(saleBranchId);
                    
                    const matches = branchIdStr === saleBranchIdStr;
                    if (matches) {
                    }
                    
                    return matches;
                });
                
                
                // Calculate totals
                const totalSales = branchSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                const totalCost = branchSales.reduce((sum, sale) => sum + (sale.costTotal || 0), 0);
                const totalProfit = totalSales - totalCost;
                const profitMargin = totalSales > 0 ? ((totalProfit / totalSales) * 100).toFixed(2) : 0;
                
                
                allBranchesData.push({
                    branchName: branch.name,
                    branchAddress: branch.address,
                    totalSales,
                    totalCost,
                    totalProfit,
                    profitMargin,
                    salesCount: branchSales.length
                });
            });
            
            return allBranchesData;
        }
        
        // NEW: Get Date Wise Data
        function getDateWiseData(fromDate, toDate, branchId) {
            let sales = appData.sales || [];
            
            // Filter by branch if specified
            if (branchId) {
                sales = sales.filter(sale => {
                    const saleBranchId = sale.branchId?._id || sale.branchId;
                    return saleBranchId === branchId;
                });
            }
            
            // Filter by date range
            if (fromDate && toDate) {
                sales = sales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= new Date(fromDate) && saleDate <= new Date(toDate);
                });
            }
            
            // Group by date
            const dateGroups = {};
            sales.forEach(sale => {
                const saleDate = new Date(sale.date).toLocaleDateString('en-GB');
                if (!dateGroups[saleDate]) {
                    dateGroups[saleDate] = {
                        date: saleDate,
                        sales: [],
                        totalSales: 0,
                        totalCost: 0,
                        totalProfit: 0
                    };
                }
                dateGroups[saleDate].sales.push(sale);
                dateGroups[saleDate].totalSales += sale.total || 0;
                dateGroups[saleDate].totalCost += sale.costTotal || 0;
                dateGroups[saleDate].totalProfit += (sale.total || 0) - (sale.costTotal || 0);
            });
            
            return Object.values(dateGroups).sort((a, b) => new Date(a.date.split('/').reverse().join('-')) - new Date(b.date.split('/').reverse().join('-')));
        }
        
        // NEW: Create Summary Print Content
        function createSummaryPrintContent(reportData, fromDate, toDate, branchName, branchAddress) {
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = fromDate && toDate ? 
                `${new Date(fromDate).toLocaleDateString('en-GB')} - ${new Date(toDate).toLocaleDateString('en-GB')}` : 
                'All Time';
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Summary Report - D.Watson Pharmacy</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .print-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
        .print-header h1 { font-size: 24pt; font-weight: bold; margin: 0 0 10px 0; color: #333; }
        .print-header .company-info { font-size: 10pt; color: #666; margin: 5px 0; }
        .print-header .report-info { font-size: 11pt; color: #333; margin: 10px 0 0 0; }
        .summary-section { margin-bottom: 25px; }
        .summary-section h3 { font-size: 16pt; color: #2c6e8a; margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        .summary-card { background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #2c6e8a; }
        .summary-card h4 { margin: 0 0 10px 0; color: #2c6e8a; font-size: 14pt; }
        .summary-card .value { font-size: 18pt; font-weight: bold; color: #333; }
        .summary-card .label { font-size: 10pt; color: #666; margin-top: 5px; }
        .print-footer { margin-top: 30px; text-align: center; font-size: 9pt; color: #666; border-top: 1px solid #ddd; padding-top: 15px; }
        @media print { body { margin: 0; } }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Sales Summary Report</div>
        <div class="company-info">${branchName}${branchAddress ? ' - ' + branchAddress : ''}</div>
        <div class="report-info">Period: ${dateRange}</div>
        <div class="report-info">Generated on: ${currentDate}</div>
    </div>
    
    <div class="summary-section">
        <h3>Sales Summary</h3>
        <div class="summary-grid">
            <div class="summary-card">
                <h4>Total Sales</h4>
                <div class="value">${reportData.totalSales.toLocaleString()}</div>
                <div class="label">Revenue generated</div>
            </div>
            <div class="summary-card">
                <h4>Total Cost</h4>
                <div class="value">${reportData.totalCost.toLocaleString()}</div>
                <div class="label">Cost of goods sold</div>
            </div>
            <div class="summary-card">
                <h4>Total Profit</h4>
                <div class="value">${reportData.totalProfit.toLocaleString()}</div>
                <div class="label">Net profit earned</div>
            </div>
            <div class="summary-card">
                <h4>Profit Margin</h4>
                <div class="value">${reportData.profitMargin.toFixed(2)}%</div>
                <div class="label">Profit percentage</div>
            </div>
        </div>
    </div>
    
    <div class="print-footer">
        <p>This summary report was generated on ${currentDate} by D.Watson Pharmacy Management System</p>
        <p>For any queries, please contact the management</p>
    </div>
</body>
</html>
            `;
        }
        
        // NEW: Create Sales Comparison Print Content
        function createSalesComparisonPrintContent(reportData, fromDate, toDate, branchName, branchAddress) {
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = fromDate && toDate ? 
                `${new Date(fromDate).toLocaleDateString('en-GB')} - ${new Date(toDate).toLocaleDateString('en-GB')}` : 
                'All Time';
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sales Comparison Report - D.Watson Pharmacy</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: white; }
        .print-header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #00685c; padding-bottom: 20px; }
        .print-header h1 { font-size: 28pt; font-weight: bold; margin: 0 0 10px 0; color: #00685c; }
        .print-header .company-info { font-size: 11pt; color: #333; margin: 5px 0; font-weight: 600; }
        .print-header .report-info { font-size: 12pt; color: #666; margin: 8px 0 0 0; }
        .comparison-section { margin-bottom: 30px; }
        .comparison-section h3 { font-size: 18pt; color: #00685c; margin-bottom: 20px; border-bottom: 2px solid #00685c; padding-bottom: 10px; }
        .comparison-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; font-size: 10pt; }
        .comparison-table th, .comparison-table td { border: 1px solid #333; padding: 10px; }
        .comparison-table th { background-color: #000000; color: white; font-weight: bold; }
        .comparison-table tr:nth-child(even) { background-color: #f8f9fa; }
        .print-footer { margin-top: 40px; text-align: center; font-size: 9pt; color: #666; border-top: 2px solid #00685c; padding-top: 20px; }
        @media print { 
            body { margin: 0; }
            .print-header { page-break-after: avoid; }
            .comparison-section { page-break-inside: avoid; }
        }
        @media screen and (max-width: 768px) {
            body { margin: 10px; }
            .print-header h1 { font-size: 20pt; }
            .comparison-table { font-size: 8pt; }
            .comparison-table th, .comparison-table td { padding: 6px; }
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Sales Comparison Report</div>
        <div class="company-info">${branchName}${branchAddress ? ' - ' + branchAddress : ''}</div>
        <div class="report-info">Period: ${dateRange}</div>
        <div class="report-info">Generated on: ${currentDate}</div>
    </div>
    
    <div class="comparison-section">
        <h3>Performance Comparison</h3>
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Amount</th>
                    <th>Percentage</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Total Sales</td>
                    <td>${reportData.totalSales.toLocaleString()}</td>
                    <td>100.00%</td>
                </tr>
                <tr>
                    <td>Total Cost</td>
                    <td>${reportData.totalCost.toLocaleString()}</td>
                    <td>${((reportData.totalCost / reportData.totalSales) * 100).toFixed(2)}%</td>
                </tr>
                <tr>
                    <td>Total Profit</td>
                    <td>${reportData.totalProfit.toLocaleString()}</td>
                    <td>${reportData.profitMargin.toFixed(2)}%</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="print-footer">
        <p>This comparison report was generated on ${currentDate} by D.Watson Pharmacy Management System</p>
        <p>For any queries, please contact the management</p>
    </div>
</body>
</html>
            `;
        }
        
        // NEW: Create All Branches Summary Print Content
        function createAllBranchesSummaryPrintContent(allBranchesData, fromDate, toDate) {
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = fromDate && toDate ? 
                `${new Date(fromDate).toLocaleDateString('en-GB')} - ${new Date(toDate).toLocaleDateString('en-GB')}` : 
                'All Time';
            
            // NEW: Sort branches by sales in descending order (highest selling first)
            const sortedBranchesData = allBranchesData.sort((a, b) => b.totalSales - a.totalSales);
            
            // Calculate totals
            const grandTotalSales = sortedBranchesData.reduce((sum, branch) => sum + branch.totalSales, 0);
            const grandTotalCost = sortedBranchesData.reduce((sum, branch) => sum + branch.totalCost, 0);
            const grandTotalProfit = sortedBranchesData.reduce((sum, branch) => sum + branch.totalProfit, 0);
            const grandProfitMargin = grandTotalSales > 0 ? ((grandTotalProfit / grandTotalSales) * 100) : 0;
            
            // NEW: Find top performing branch
            const topBranch = sortedBranchesData[0];
            const topBranchSales = topBranch ? topBranch.totalSales : 0;
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>All Branches Summary Report - D.Watson Pharmacy</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .print-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
        .print-header h1 { font-size: 24pt; font-weight: bold; margin: 0 0 10px 0; color: #333; }
        .print-header .company-info { font-size: 10pt; color: #666; margin: 5px 0; }
        .print-header .report-info { font-size: 11pt; color: #333; margin: 10px 0 0 0; }
        .branches-section { margin-bottom: 25px; }
        .branches-section h3 { font-size: 16pt; color: #2c6e8a; margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .branches-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .branches-table th, .branches-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .branches-table th { background-color: #f8f9fa; font-weight: bold; color: #2c6e8a; }
        .branches-table tr:nth-child(even) { background-color: #f8f9fa; }
        .grand-total { background-color: #e9ecef; font-weight: bold; }
        .comparison-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; }
        .top-performer { background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745; }
        .top-performer h4 { margin: 0 0 15px 0; color: #28a745; font-size: 16pt; }
        .top-performer p { margin: 8px 0; font-size: 12pt; }
        .performance-stats { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #2c6e8a; }
        .performance-stats h4 { margin: 0 0 15px 0; color: #2c6e8a; font-size: 16pt; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #dee2e6; }
        .stat-label { font-weight: 500; color: #666; }
        .stat-value { font-weight: bold; color: #333; }
        .print-footer { margin-top: 30px; text-align: center; font-size: 9pt; color: #666; border-top: 1px solid #ddd; padding-top: 15px; }
        @media print { body { margin: 0; } }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">All Branches Summary Report</div>
        <div class="report-info">Period: ${dateRange}</div>
        <div class="report-info">Generated on: ${currentDate}</div>
    </div>
    
    <div class="branches-section">
        <h3>Branches Performance Summary (Sorted by Sales - Highest First)</h3>
        <table class="branches-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Branch Name</th>
                    <th>Total Sales</th>
                    <th>Total Cost</th>
                    <th>Total Profit</th>
                    <th>Profit Margin (%)</th>
                    <th>Sales Count</th>
                </tr>
            </thead>
            <tbody>
                ${sortedBranchesData.map((branch, index) => `
                <tr>
                    <td><strong>#${index + 1}</strong></td>
                    <td>${branch.branchName}</td>
                    <td>${branch.totalSales.toLocaleString()}</td>
                    <td>${branch.totalCost.toLocaleString()}</td>
                    <td>${branch.totalProfit.toLocaleString()}</td>
                    <td>${branch.profitMargin}%</td>
                    <td>${branch.salesCount}</td>
                </tr>
                `).join('')}
                <tr class="grand-total">
                    <td><strong>-</strong></td>
                    <td><strong>GRAND TOTAL</strong></td>
                    <td><strong>${grandTotalSales.toLocaleString()}</strong></td>
                    <td><strong>${grandTotalCost.toLocaleString()}</strong></td>
                    <td><strong>${grandTotalProfit.toLocaleString()}</strong></td>
                    <td><strong>${grandProfitMargin.toFixed(2)}%</strong></td>
                    <td><strong>${sortedBranchesData.reduce((sum, branch) => sum + branch.salesCount, 0)}</strong></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- NEW: Sales Comparison Section -->
    <div class="branches-section">
        <h3>Sales Performance Comparison</h3>
        <div class="comparison-summary">
            <div class="top-performer">
                <h4> Top Performing Branch</h4>
                <p><strong>${topBranch ? topBranch.branchName : 'N/A'}</strong></p>
                <p>Sales: <strong>${topBranchSales.toLocaleString()}</strong></p>
                <p>Market Share: <strong>${grandTotalSales > 0 ? ((topBranchSales / grandTotalSales) * 100).toFixed(1) : 0}%</strong></p>
            </div>
            
            <div class="performance-stats">
                <h4> Performance Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Total Branches:</span>
                        <span class="stat-value">${sortedBranchesData.length}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Average Sales per Branch:</span>
                        <span class="stat-value">${(grandTotalSales / sortedBranchesData.length).toLocaleString()}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Highest Sales:</span>
                        <span class="stat-value">${topBranchSales.toLocaleString()}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Lowest Sales:</span>
                        <span class="stat-value">${sortedBranchesData[sortedBranchesData.length - 1]?.totalSales.toLocaleString() || '0'}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="print-footer">
        <p>This all branches summary report was generated on ${currentDate} by D.Watson Pharmacy Management System</p>
        <p>For any queries, please contact the management</p>
    </div>
</body>
</html>
            `;
        }
        
        // NEW: Create Date Wise Print Content
        function createDateWisePrintContent(dateWiseData, fromDate, toDate, branchName, branchAddress) {
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = fromDate && toDate ? 
                `${new Date(fromDate).toLocaleDateString('en-GB')} - ${new Date(toDate).toLocaleDateString('en-GB')}` : 
                'All Time';
            
            // Group data by branch for the detailed table
            let sales = appData.sales || [];
            
            // Apply filters
            let filteredData = sales;
            if (fromDate && toDate) {
                filteredData = sales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= new Date(fromDate) && saleDate <= new Date(toDate);
                });
            }
            if (branchName !== 'All Branches') {
                filteredData = filteredData.filter(sale => sale.branchId?.name === branchName);
            }
            
            // Group by branch
            const branchGroups = {};
            filteredData.forEach(sale => {
                const branchNameForGroup = sale.branchId?.name || 'Unknown';
                if (!branchGroups[branchNameForGroup]) {
                    branchGroups[branchNameForGroup] = [];
                }
                branchGroups[branchNameForGroup].push({
                    date: sale.date ? new Date(sale.date).toLocaleDateString('en-GB') : 'N/A',
                    branch: branchNameForGroup,
                    category: sale.categoryId?.name || 'Unknown',
                    sales: sale.total || 0,
                    cost: sale.costTotal || 0,
                    profit: (sale.total || 0) - (sale.costTotal || 0)
                });
            });
            
            // Generate table rows
            let tableRows = '';
            Object.keys(branchGroups).sort().forEach(branchNameForTable => {
                const branchItems = branchGroups[branchNameForTable];
                
                // Calculate branch totals
                let branchTotalSales = 0, branchTotalCost = 0, branchTotalProfit = 0;
                branchItems.forEach(item => {
                    branchTotalSales += item.sales;
                    branchTotalCost += item.cost;
                    branchTotalProfit += item.profit;
                });
                
                // Add branch header
                tableRows += `
                    <tr>
                        <td colspan="6" style="background-color: #00685c; color: white; font-weight: 700; padding: 12px; text-align: center; border: 1px solid #333;"> ${branchNameForTable}</td>
                    </tr>
                `;
                
                // Add column headers
                tableRows += `
                    <tr>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 10px; border: 1px solid #333;">Date</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 10px; border: 1px solid #333;">Branch</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 10px; border: 1px solid #333;">Category</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 10px; border: 1px solid #333;">Sales Amount</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 10px; border: 1px solid #333;">Cost</th>
                        <th style="background-color: #000000; color: white; font-weight: 700; padding: 10px; border: 1px solid #333;">Profit</th>
                    </tr>
                `;
                
                // Add data rows
                branchItems.forEach(item => {
                    const profitClass = item.profit >= 0 ? 'color: green;' : 'color: red;';
                    tableRows += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #333;">${item.date}</td>
                            <td style="padding: 8px; border: 1px solid #333;">${item.branch}</td>
                            <td style="padding: 8px; border: 1px solid #333;">${item.category}</td>
                            <td style="text-align: right; padding: 8px; border: 1px solid #333;">${item.sales.toLocaleString()}</td>
                            <td style="text-align: right; padding: 8px; border: 1px solid #333;">${item.cost.toLocaleString()}</td>
                            <td style="text-align: right; padding: 8px; border: 1px solid #333; ${profitClass}">${item.profit.toLocaleString()}</td>
                        </tr>
                    `;
                });
                
                // Add branch total row
                const totalProfitClass = branchTotalProfit >= 0 ? 'color: green;' : 'color: red;';
                tableRows += `
                    <tr>
                        <td colspan="3" style="background-color: #f8f9fa; font-weight: 700; padding: 10px; text-align: right; border: 1px solid #333;"> Branch Total:</td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 10px; border: 1px solid #333;">${branchTotalSales.toLocaleString()}</td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 10px; border: 1px solid #333;">${branchTotalCost.toLocaleString()}</td>
                        <td style="background-color: #f8f9fa; font-weight: 700; text-align: right; padding: 10px; border: 1px solid #333; ${totalProfitClass}">${branchTotalProfit.toLocaleString()}</td>
                    </tr>
                    <tr><td colspan="6" style="height: 15px; border: none;"></td></tr>
                `;
            });
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Date Wise Sales Report - D.Watson Pharmacy</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: white; }
        .print-header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #00685c; padding-bottom: 20px; }
        .print-header h1 { font-size: 28pt; font-weight: bold; margin: 0 0 10px 0; color: #00685c; }
        .print-header .company-info { font-size: 11pt; color: #333; margin: 5px 0; font-weight: 600; }
        .print-header .report-info { font-size: 12pt; color: #666; margin: 8px 0 0 0; }
        .datewise-section { margin-bottom: 30px; }
        .datewise-section h3 { font-size: 18pt; color: #00685c; margin-bottom: 20px; border-bottom: 2px solid #00685c; padding-bottom: 10px; }
        .datewise-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; font-size: 10pt; }
        .datewise-table th, .datewise-table td { border: 1px solid #333; padding: 10px; }
        .datewise-table th { background-color: #000000; color: white; font-weight: bold; }
        .datewise-table tr:nth-child(even) { background-color: #f8f9fa; }
        .print-footer { margin-top: 40px; text-align: center; font-size: 9pt; color: #666; border-top: 2px solid #00685c; padding-top: 20px; }
        @media print { 
            body { margin: 0; }
            .print-header { page-break-after: avoid; }
            .datewise-section { page-break-inside: avoid; }
        }
        @media screen and (max-width: 768px) {
            body { margin: 10px; }
            .print-header h1 { font-size: 20pt; }
            .datewise-table { font-size: 8pt; }
            .datewise-table th, .datewise-table td { padding: 6px; }
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Date Wise Sales Report</div>
        <div class="company-info">${branchName}${branchAddress ? ' - ' + branchAddress : ''}</div>
        <div class="report-info">Period: ${dateRange}</div>
        <div class="report-info">Generated on: ${currentDate}</div>
    </div>
    
    <div class="datewise-section">
        <h3>Date-Wise Sales Data</h3>
        <table class="datewise-table">
            ${tableRows}
        </table>
    </div>
    
    <div class="print-footer">
        <p>This date wise report was generated on ${currentDate} by D.Watson Pharmacy Management System</p>
        <p>For any queries, please contact the management</p>
    </div>
</body>
</html>
            `;
        }
        
        // Helper function to update selected categories button text
        function updateSelectedCategoriesText() {
            const categoryCheckboxes = document.querySelectorAll('.category-checkbox:checked');
            const selectedCategoriesText = document.getElementById('selectedCategoriesText');
            
            if (categoryCheckboxes.length === 0) {
                selectedCategoriesText.textContent = 'No categories selected';
            } else if (categoryCheckboxes.length === document.querySelectorAll('.category-checkbox').length) {
                selectedCategoriesText.textContent = 'All Categories';
            } else if (categoryCheckboxes.length === 1) {
                const checkbox = categoryCheckboxes[0];
                const label = document.querySelector(`label[for="${checkbox.id}"]`);
                selectedCategoriesText.textContent = label ? label.textContent.trim() : '1 category selected';
            } else {
                selectedCategoriesText.textContent = `${categoryCheckboxes.length} categories selected`;
            }
        }
        
        // NEW: Generate Category-wise Branch Comparison for Screen Display
        function generateCategoryComparison() {
            const fromDate = document.getElementById('categoryReportDateFrom').value;
            const toDate = document.getElementById('categoryReportDateTo').value;
            
            // Validate date inputs
            if (!fromDate || !toDate) {
                showNotification('Please select both From Date and To Date', 'error');
                return;
            }
            
            // Get selected category from the dropdown
            const categoryFilterBtn = document.getElementById('categoryReportFilterBtn');
            const selectedCategoryIds = [];
            
            // Get the active dropdown item
            const activeItem = document.querySelector('#categoryReportDropdownMenu .dropdown-item.active');
            if (activeItem && activeItem.getAttribute('data-value')) {
                selectedCategoryIds.push(activeItem.getAttribute('data-value'));
            }
            
            const hasCategoryFilter = selectedCategoryIds.length > 0;
            
            // Get filtered sales data
            let filteredSales = [];
            if (appData.sales && appData.sales.length > 0) {
                filteredSales = appData.sales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    const from = new Date(fromDate);
                    const to = new Date(toDate);
                    const dateMatches = saleDate >= from && saleDate <= to;
                    
                    // Filter by category if categories are selected
                    if (hasCategoryFilter) {
                        const categoryId = sale.categoryId?._id || sale.categoryId;
                        return dateMatches && selectedCategoryIds.includes(categoryId);
                    }
                    
                    return dateMatches;
                });
            }
            
            // Group sales by category and branch
            const categoryBranchData = {};
            
            // Get categories to process - if filter is applied, only process selected categories
            const categoriesToProcess = hasCategoryFilter 
                ? appData.categories.filter(cat => selectedCategoryIds.includes(cat._id))
                : appData.categories;
            
            // Initialize categories (only selected ones if filter is applied)
            categoriesToProcess.forEach(category => {
                categoryBranchData[category._id] = {
                    name: category.name,
                    branches: {}
                };
                
                // Initialize branches for this category
                appData.branches.forEach(branch => {
                    categoryBranchData[category._id].branches[branch._id] = {
                        name: branch.name,
                        totalSales: 0,
                        totalCost: 0,
                        totalProfit: 0,
                        salesCount: 0
                    };
                });
            });
            
            // Process each sale
            filteredSales.forEach(sale => {
                const categoryId = sale.categoryId?._id || sale.categoryId;
                const branchId = sale.branchId?._id || sale.branchId;
                
                if (categoryBranchData[categoryId] && categoryBranchData[categoryId].branches[branchId]) {
                    const branchData = categoryBranchData[categoryId].branches[branchId];
                    branchData.totalSales += sale.total || 0;
                    branchData.totalCost += sale.costTotal || 0;
                    branchData.totalProfit += (sale.total || 0) - (sale.costTotal || 0);
                    branchData.salesCount += 1;
                }
            });
            
            // Calculate totals for each category
            Object.keys(categoryBranchData).forEach(categoryId => {
                const category = categoryBranchData[categoryId];
                category.totalSales = 0;
                category.totalCost = 0;
                category.totalProfit = 0;
                category.totalSalesCount = 0;
                
                Object.values(category.branches).forEach(branch => {
                    category.totalSales += branch.totalSales;
                    category.totalCost += branch.totalCost;
                    category.totalProfit += branch.totalProfit;
                    category.totalSalesCount += branch.salesCount;
                });
            });
            
            // Display the comparison on screen
            displayCategoryComparison(categoryBranchData, fromDate, toDate, selectedCategoryIds);
        }
        
        // NEW: Display Category-wise Branch Comparison on Screen
        function displayCategoryComparison(categoryBranchData, fromDate, toDate, selectedCategoryIds = []) {
            const content = document.getElementById('categoryComparisonContent');
            const section = document.getElementById('categoryComparisonSection');
            
            const dateRange = `${new Date(fromDate).toLocaleDateString('en-GB')} - ${new Date(toDate).toLocaleDateString('en-GB')}`;
            
            let html = `
                <div class="mb-3">
                    <h6 class="text-muted">Period: ${dateRange}</h6>
                </div>
            `;
            
            const categoryColors = [
                { color1: '#136F63', color2: '#0F5A4F', shadow: 'rgba(19, 111, 99, 0.2)' }, // MEDICINE NUTRA - uses cost color
                { color1: '#3498DB', color2: '#2980B9', shadow: 'rgba(52, 152, 219, 0.2)' }, // MEDICINE AIMS - Blue
                { color1: '#FFBA08', color2: '#FF9D00', shadow: 'rgba(255, 186, 8, 0.2)' }, // COSMETICS - Gold/Yellow
                { color1: '#9B59B6', color2: '#8E44AD', shadow: 'rgba(155, 89, 182, 0.2)' }, // COSTMAIES - Purple
                { color1: '#3F88C5', color2: '#2E6FA0', shadow: 'rgba(63, 136, 197, 0.2)' }, // Sky Blue
                { color1: '#032B43', color2: '#021E2F', shadow: 'rgba(3, 43, 67, 0.2)' }, // Dark Blue/Navy
                { color1: '#D00000', color2: '#FFBA08', shadow: 'rgba(208, 0, 0, 0.2)' }, // Red-Orange
                { color1: '#3F88C5', color2: '#136F63', shadow: 'rgba(63, 136, 197, 0.2)' }  // Blue-Teal
            ];
            
            // Define the display order for categories
            const categoryOrder = [
                'MEDICINE NUTRA',
                'MEDICINE AIMS',
                'COSMETICS',
                'COSTMAIES'
            ];
            
            let categoryIndex = 0;
            
            // Sort categories according to the specified order
            const sortedCategories = Object.values(categoryBranchData).sort((a, b) => {
                const indexA = categoryOrder.indexOf(a.name);
                const indexB = categoryOrder.indexOf(b.name);
                
                // If both are in the order list, sort by their index
                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB;
                }
                // If only one is in the order list, prioritize it
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                // If neither is in the list, maintain their original order
                return 0;
            });
            
            sortedCategories.forEach(category => {
                // Sort branches by total sales (descending)
                const sortedBranches = Object.values(category.branches)
                    .filter(branch => branch.totalSales > 0)
                    .sort((a, b) => b.totalSales - a.totalSales);
                
                if (sortedBranches.length === 0) return;
                
                const colors = categoryColors[categoryIndex % categoryColors.length];
                categoryIndex++;
                
                html += `
                    <div class="category-comparison-section mb-5">
                        <!-- Category Header Card -->
                        <div class="card category-header-card mb-4" style="background: linear-gradient(135deg, ${colors.color1} 0%, ${colors.color2} 100%); border: none; box-shadow: 0 8px 25px ${colors.shadow};">
                            <div class="card-body text-white p-4">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h2 class="mb-2 fw-bold">
                                            <i class="fas fa-layer-group me-3"></i>${category.name}
                                        </h2>
                                        <p class="mb-0 opacity-75">Category Performance Analysis</p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="branch-count-badge">
                                            <span class="badge bg-white text-dark fs-5 px-3 py-2">
                                                <i class="fas fa-store me-2"></i>${sortedBranches.length} Branches
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Summary Cards -->
                        <div class="row g-3 mb-4">
                            <div class="col-lg-3 col-md-6">
                                <div class="card summary-card text-center" style="background-color: #28a745; border: none; border-radius: 8px;">
                                    <div class="card-body p-3">
                                        <div class="summary-label text-white fw-semibold mb-2" style="font-size: 0.9rem;">Total Sales</div>
                                        <div class="summary-value text-white fw-bold" style="font-size: 1.75rem;">${category.totalSales.toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="card summary-card text-center" style="background-color: #136F63; border: none; border-radius: 8px;">
                                    <div class="card-body p-3">
                                        <div class="summary-label text-white fw-semibold mb-2" style="font-size: 0.9rem;">Total Cost</div>
                                        <div class="summary-value text-white fw-bold" style="font-size: 1.75rem;">${category.totalCost.toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="card summary-card text-center" style="background-color: #CF2A2A; border: none; border-radius: 8px;">
                                    <div class="card-body p-3">
                                        <div class="summary-label text-white fw-semibold mb-2" style="font-size: 0.9rem;">Total Profit</div>
                                        <div class="summary-value text-white fw-bold" style="font-size: 1.75rem;">${category.totalProfit.toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="card summary-card text-center" style="background-color: #4D4D4D; border: none; border-radius: 8px;">
                                    <div class="card-body p-3">
                                        <div class="summary-label text-white fw-semibold mb-2" style="font-size: 0.9rem;">Sales Count</div>
                                        <div class="summary-value text-white fw-bold" style="font-size: 1.75rem;">${category.totalSalesCount}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Branch Performance Table -->
                        <div class="card">
                            <div class="card-header" style="background-color: #136F63;">
                                <h5 class="mb-0 text-white fw-bold">
                                    <i class="fas fa-table me-2"></i>Branch Performance Details
                                </h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-primary">
                                            <tr>
                                                <th class="fw-bold">Rank</th>
                                                <th class="fw-bold">Branch Name</th>
                                                <th class="text-end fw-bold">Total Sales</th>
                                                <th class="text-end fw-bold">Total Cost</th>
                                                <th class="text-end fw-bold">Total Profit</th>
                                                <th class="text-end fw-bold">Profit Margin (%)</th>
                                                <th class="text-center fw-bold">Sales Count</th>
                                            </tr>
                                        </thead>
                                <tbody>
                `;
                
                sortedBranches.forEach((branch, index) => {
                    const profitMargin = branch.totalSales > 0 ? ((branch.totalProfit / branch.totalSales) * 100) : 0;
                    const rankBadgeClass = index === 0 ? 'bg-success' : index === 1 ? 'bg-warning' : index === 2 ? 'bg-danger' : 'bg-secondary';
                    const rowClass = index < 3 ? 'table-light' : '';
                    
                    html += `
                        <tr class="${rowClass}">
                            <td class="text-center align-middle">
                                <span class="badge ${rankBadgeClass} fs-6 px-3 py-2">
                                    <i class="fas fa-medal me-1"></i>${index + 1}
                                </span>
                            </td>
                            <td class="align-middle">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-store text-primary me-2"></i>
                                    <strong class="text-dark">${branch.name}</strong>
                                </div>
                            </td>
                            <td class="text-end align-middle">
                                <span class="fw-bold text-success">${branch.totalSales.toLocaleString()}</span>
                            </td>
                            <td class="text-end align-middle">
                                <span class="fw-bold text-primary">${branch.totalCost.toLocaleString()}</span>
                            </td>
                            <td class="text-end align-middle">
                                <span class="fw-bold text-danger">${branch.totalProfit.toLocaleString()}</span>
                            </td>
                            <td class="text-end align-middle">
                                <span class="badge ${profitMargin >= 20 ? 'bg-success' : profitMargin >= 10 ? 'bg-warning' : 'bg-danger'} fs-6">
                                    ${profitMargin.toFixed(2)}%
                                </span>
                            </td>
                            <td class="text-center align-middle">
                                <span class="badge bg-info fs-6">${branch.salesCount}</span>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
            section.style.display = 'block';
            
            // Scroll to the comparison section
            section.scrollIntoView({ behavior: 'smooth' });
        }
        
        // NEW: Category-wise Branch Comparison Print Function
        function printCategoryWiseComparison() {
            const fromDate = document.getElementById('categoryReportDateFrom').value;
            const toDate = document.getElementById('categoryReportDateTo').value;
            
            // Get selected category from the dropdown
            const selectedCategoryIds = [];
            
            // Get the active dropdown item
            const activeItem = document.querySelector('#categoryReportDropdownMenu .dropdown-item.active');
            if (activeItem && activeItem.getAttribute('data-value')) {
                selectedCategoryIds.push(activeItem.getAttribute('data-value'));
            }
            
            // Get report data
            const reportData = getReportData();
            
            // Create category-wise comparison print content
            const printContent = createCategoryWiseComparisonPrintContent(reportData, fromDate, toDate, selectedCategoryIds);
            
            // Open preview window (new tab)
            try {
                const previewWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                previewWindow.document.write(printContent);
                previewWindow.document.close();
            } catch (error) {
                console.error('Preview error:', error);
                showNotification('Preview failed: ' + error.message, 'error');
            }
        }
        
        // NEW: Create Category-wise Branch Comparison Print Content
        function createCategoryWiseComparisonPrintContent(reportData, fromDate, toDate, selectedCategoryIds = []) {
            const currentDate = new Date().toLocaleDateString('en-GB');
            const dateRange = fromDate && toDate ? 
                `${new Date(fromDate).toLocaleDateString('en-GB')} - ${new Date(toDate).toLocaleDateString('en-GB')}` : 
                'All Time';
            
            // Get filtered sales data
            const hasCategoryFilter = selectedCategoryIds.length > 0 && !selectedCategoryIds.includes('');
            let filteredSales = [];
            if (appData.sales && appData.sales.length > 0) {
                filteredSales = appData.sales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    const from = fromDate ? new Date(fromDate) : new Date('1900-01-01');
                    const to = toDate ? new Date(toDate) : new Date('2100-12-31');
                    const dateMatches = saleDate >= from && saleDate <= to;
                    
                    // Filter by category if categories are selected
                    if (hasCategoryFilter) {
                        const categoryId = sale.categoryId?._id || sale.categoryId;
                        return dateMatches && selectedCategoryIds.includes(categoryId);
                    }
                    
                    return dateMatches;
                });
            }
            
            // Group sales by category and branch
            const categoryBranchData = {};
            
            // Get categories to process - if filter is applied, only process selected categories
            const categoriesToProcess = hasCategoryFilter 
                ? appData.categories.filter(cat => selectedCategoryIds.includes(cat._id))
                : appData.categories;
            
            // Initialize categories (only selected ones if filter is applied)
            categoriesToProcess.forEach(category => {
                categoryBranchData[category._id] = {
                    name: category.name,
                    branches: {}
                };
                
                // Initialize branches for this category
                appData.branches.forEach(branch => {
                    categoryBranchData[category._id].branches[branch._id] = {
                        name: branch.name,
                        totalSales: 0,
                        totalCost: 0,
                        totalProfit: 0,
                        salesCount: 0
                    };
                });
            });
            
            // Process each sale
            filteredSales.forEach(sale => {
                const categoryId = sale.categoryId?._id || sale.categoryId;
                const branchId = sale.branchId?._id || sale.branchId;
                
                if (categoryBranchData[categoryId] && categoryBranchData[categoryId].branches[branchId]) {
                    const branchData = categoryBranchData[categoryId].branches[branchId];
                    branchData.totalSales += sale.total || 0;
                    branchData.totalCost += sale.costTotal || 0;
                    branchData.totalProfit += (sale.total || 0) - (sale.costTotal || 0);
                    branchData.salesCount += 1;
                }
            });
            
            // Calculate totals for each category
            Object.keys(categoryBranchData).forEach(categoryId => {
                const category = categoryBranchData[categoryId];
                category.totalSales = 0;
                category.totalCost = 0;
                category.totalProfit = 0;
                category.totalSalesCount = 0;
                
                Object.values(category.branches).forEach(branch => {
                    category.totalSales += branch.totalSales;
                    category.totalCost += branch.totalCost;
                    category.totalProfit += branch.totalProfit;
                    category.totalSalesCount += branch.salesCount;
                });
            });
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Category-wise Branch Comparison - D.Watson Pharmacy</title>
    <style>
        @page {
            size: A4;
            margin: 1in;
        }
        
        body {
            font-family: Arial, sans-serif;
            font-size: 12pt;
            line-height: 1.4;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 0;
        }
        
        * {
            color: #000 !important;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #000;
            padding-bottom: 15px;
        }
        
        .print-header h1 {
            font-size: 24pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #000;
        }
        
        .print-header .company-info {
            font-size: 10pt;
            color: #000;
            margin: 5px 0;
            font-weight: 500;
        }
        
        .print-header .report-info {
            font-size: 11pt;
            color: #000;
            margin: 10px 0 0 0;
            font-weight: 500;
        }
        
        .category-section {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }
        
        .category-section h2 {
            font-size: 18pt;
            font-weight: bold;
            color: #2c6e8a;
            margin: 0 0 20px 0;
            border-bottom: 2px solid #2c6e8a;
            padding-bottom: 10px;
        }
        
        .category-summary {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #2c6e8a;
        }
        
        .category-summary h3 {
            font-size: 14pt;
            margin: 0 0 10px 0;
            color: #2c6e8a;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-item .label {
            font-size: 9pt;
            color: #666;
            display: block;
            margin-bottom: 5px;
        }
        
        .summary-item .value {
            font-size: 14pt;
            font-weight: bold;
            color: #000;
        }
        
        .branch-comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        .branch-comparison-table th,
        .branch-comparison-table td {
            border: 1px solid #333;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        
        .branch-comparison-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            color: #000;
        }
        
        .branch-comparison-table .text-right {
            text-align: right;
        }
        
        .branch-comparison-table .text-center {
            text-align: center;
        }
        
        .rank-1 { background-color: #d4edda; }
        .rank-2 { background-color: #fff3cd; }
        .rank-3 { background-color: #f8d7da; }
        
        .print-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 9pt;
            color: #666;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>D.Watson Group Of Pharmacies</h1>
        <div class="company-info">Category-wise Branch Comparison Report</div>
        <div class="company-info">Period: ${dateRange}</div>
        <div class="report-info">Generated on: ${currentDate}</div>
    </div>
    
    ${Object.values(categoryBranchData).map(category => {
        // Sort branches by total sales (descending)
        const sortedBranches = Object.values(category.branches)
            .filter(branch => branch.totalSales > 0)
            .sort((a, b) => b.totalSales - a.totalSales);
        
        return `
        <div class="category-section">
            <h2> ${category.name} - Branch Performance</h2>
            
            <div class="category-summary">
                <h3>Category Summary</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <span class="label">Total Sales</span>
                        <span class="value">${category.totalSales.toLocaleString()}</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Total Cost</span>
                        <span class="value">${category.totalCost.toLocaleString()}</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Total Profit</span>
                        <span class="value">${category.totalProfit.toLocaleString()}</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Sales Count</span>
                        <span class="value">${category.totalSalesCount}</span>
                    </div>
                </div>
            </div>
            
            <table class="branch-comparison-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Branch Name</th>
                        <th class="text-right">Total Sales</th>
                        <th class="text-right">Total Cost</th>
                        <th class="text-right">Total Profit</th>
                        <th class="text-right">Profit Margin (%)</th>
                        <th class="text-center">Sales Count</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedBranches.map((branch, index) => {
                        const profitMargin = branch.totalSales > 0 ? ((branch.totalProfit / branch.totalSales) * 100) : 0;
                        const rankClass = index < 3 ? `rank-${index + 1}` : '';
                        return `
                        <tr class="${rankClass}">
                            <td class="text-center">${index + 1}</td>
                            <td>${branch.name}</td>
                            <td class="text-right">${branch.totalSales.toLocaleString()}</td>
                            <td class="text-right">${branch.totalCost.toLocaleString()}</td>
                            <td class="text-right">${branch.totalProfit.toLocaleString()}</td>
                            <td class="text-right">${profitMargin.toFixed(2)}%</td>
                            <td class="text-center">${branch.salesCount}</td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
        `;
    }).join('')}
    
    <div class="print-footer">
        <p>This category-wise branch comparison report was generated on ${currentDate} by D.Watson Pharmacy Management System</p>
        <p>For any queries, please contact the management</p>
    </div>
        </body>
        </html>
`;
        }
    </script>
    <script src="sections/sales.js"></script>
    <script src="sections/departments.js"></script>
</body>
</html>



        function applyKpiLayoutForAll() {
            const items = document.querySelectorAll('.branch-main-kpis .branch-kpi-item');
            items.forEach(item => {
                const label = item.querySelector('.branch-kpi-label');
                const value = item.querySelector('.branch-kpi-value');
                if (!label || !value) return;
                const containerWidth = item.clientWidth;
                const contentWidth = label.scrollWidth + value.scrollWidth + 16;
                if (contentWidth > containerWidth) {
                    item.classList.add('stacked');
                } else {
                    item.classList.remove('stacked');
                }
            });
        }

        if (!window.__kpiLayoutBound) {
            window.__kpiLayoutBound = true;
            window.applyKpiLayoutForAll = applyKpiLayoutForAll;
            window.addEventListener('resize', function() {
                clearTimeout(window.__kpiLayoutTimer);
                window.__kpiLayoutTimer = setTimeout(applyKpiLayoutForAll, 100);
            });
            const init = () => {
                applyKpiLayoutForAll();
                const containers = ['warehouseBranchCardsContainer','shopBranchCardsContainer']
                    .map(id => document.getElementById(id))
                    .filter(Boolean);
                containers.forEach(c => {
                    const obs = new MutationObserver(() => {
                        clearTimeout(window.__kpiLayoutTimer);
                        window.__kpiLayoutTimer = setTimeout(applyKpiLayoutForAll, 50);
                    });
                    obs.observe(c, { childList: true, subtree: true });
                });
            };
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => setTimeout(init, 0));
            } else {
                setTimeout(init, 0);
            }
        }
